<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>fangtasia.wtf</title>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/7.css">
    <style>
        :root { --vamp-red: #8b0000; --glass: rgba(15, 0, 0, 0.9); --neon-pink: #ff00ff; }
        .bat-cursor { position: fixed; width: 32px; height: 32px; pointer-events: none; z-index: 99999; transform: translate(-50%, -50%); }
        .bat-cursor svg { width: 100%; height: 100%; filter: drop-shadow(0 0 3px rgba(139, 0, 0, 0.8)); }
        .bat-cursor .wing-left, .bat-cursor .wing-right { transform-origin: center; animation: flapWings 0.15s ease-in-out infinite alternate; }
        .bat-cursor .wing-right { animation-delay: 0.075s; }
        @keyframes flapWings { 0% { transform: scaleX(1) rotate(0deg); } 100% { transform: scaleX(0.85) rotate(-8deg); } }
        * { cursor: none !important; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: black; overflow: hidden; }
        body { background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://cdn.discordapp.com/attachments/1459009893540434114/1463462838659186875/IMG_9667.jpg?ex=6971eb7a&is=697099fa&hm=be1f64186d5b932c2dc640bd86f5d9bea844d381648c55f880790a02a561f6f9&'); background-size: cover; background-position: center; font-family: "Segoe UI", Tahoma, sans-serif; }
        #boot-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #d40000; }
        .boot-title { font-size: 60px; animation: bloodPulse 2s ease-in-out infinite; text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); }
        @keyframes bloodPulse { 0%, 100% { text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); } 50% { text-shadow: 0 0 30px rgba(212, 0, 0, 0.8), 0 0 60px rgba(212, 0, 0, 0.5); } }
        .boot-subtitle { animation: flicker 3s infinite; margin-top: 20px; }
        @keyframes flicker { 0%, 100% { opacity: 1; } 93% { opacity: 0.3; } 94% { opacity: 1; } 96% { opacity: 0.5; } }
        @keyframes batFloat { 0%, 100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-15px) rotate(5deg); } }
        #desktop { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; padding: 25px; height: calc(100vh - 40px); gap: 20px; }
        .icon { width: 110px; text-align: center; color: white; text-shadow: 1px 1px 3px black; font-size: 11px; z-index: 5; margin-bottom: 15px; transition: transform 0.2s, filter 0.2s; }
        .icon:hover { transform: scale(1.1); filter: brightness(1.2); }
        .icon img.folder-icon { width: 44px; display: block; margin: 0 auto 6px; filter: grayscale(0.3) sepia(1) saturate(35) hue-rotate(320deg) brightness(0.55) contrast(1.5); }
        .window { position: fixed; background: #0d0d0d !important; border: 1px solid #700000 !important; box-shadow: 0 15px 40px rgba(0,0,0,1), 0 0 30px rgba(139, 0, 0, 0.2); display: none; z-index: 10; overflow: hidden; resize: both; min-width: 200px; min-height: 150px; }
        .title-bar { background: linear-gradient(to bottom, #8b0000, #2a0000) !important; user-select: none; }
        .window-body { height: calc(100% - 32px); padding: 0; background: black; overflow: auto; }
        .chat-container { display: flex; height: 420px; background: #050000; border-bottom: 1px solid #400; }
        #chat_logs { flex: 1; overflow-y: scroll; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        .chat-entry { display: flex; flex-direction: column; gap: 2px; }
        .chat-header { display: flex; align-items: center; gap: 8px; }
        .rank-tag { font-size: 9px; font-weight: bold; padding: 1px 4px; border-radius: 2px; border: 1px solid; text-transform: uppercase; min-width: 25px; text-align: center; }
        #member_list { width: 200px; border-left: 1px solid #400; padding: 12px; background: #0a0000; overflow-y: auto; }
        .member-category { color: #d40000; font-size: 12px; font-weight: bold; margin-top: 12px; border-bottom: 1px solid #400; text-transform: uppercase; padding-bottom: 4px; }
        .member-category:first-child { margin-top: 0; }
        .member-item { font-size: 12px; font-weight: bold; margin-top: 4px; cursor: pointer; padding: 3px 5px; border-radius: 3px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .member-item:hover { background: rgba(139, 0, 0, 0.3); }
        .member-tag { font-size: 8px; padding: 1px 3px; border-radius: 2px; border: 1px solid; }
        .st-style { color: #ff00ff; border-color: #ff00ff; }
        .a-style { color: #ffffff; border-color: #ffffff; }
        .mod-style { color: #00ff00; border-color: #00ff00; }
        .contrib-style { color: #ff8c00; border-color: #ff8c00; }
        .guest-style { color: #888; border-color: #555; }
        .vip-style { color: #ffd700; border-color: #ffd700; }
        .member-style { color: #ff4444; border-color: #ff4444; }
        .bot-style { color: #d40000; border-color: #d40000; }
        #memories_grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; justify-items: center; }
        .pagination-bar { padding: 10px; background: #111; border-top: 1px solid #400; text-align: center; }
        .ie-content { padding: 15px; color: #d40000; }
        .ie-input { width: 100%; background: #111; color: #ff0000; border: 1px solid #700000; padding: 6px; margin-bottom: 12px; font-size: 11px; box-sizing: border-box; }
        .ie-input:focus { outline: none; border-color: #ff0000; }
        .ie-btn { background: #500; color: white; border: 1px solid #f00; padding: 8px; width: 100%; font-weight: bold; margin-bottom: 5px; transition: all 0.2s; }
        .ie-btn:hover { background: #700; }
        .lounge-entry-btn { background: linear-gradient(#222, #000); border: 1px solid #ff00ff; color: #ff00ff; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 20px; font-size: 11px; text-transform: uppercase; }
        .guest-section { border-top: 1px solid #400; margin-top: 20px; padding-top: 15px; }
        .guest-btn { background: linear-gradient(#1a1a1a, #0a0a0a); border: 1px solid #444; color: #888; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 8px; font-size: 11px; text-transform: uppercase; }
        .visitor-counter { background: #000; border: 1px solid #400; padding: 8px 15px; display: inline-block; font-family: 'Courier New', monospace; color: #0f0; font-size: 14px; }
        .taskbar { position: fixed; bottom: 0; width: 100%; height: 40px; background: var(--glass); border-top: 1px solid rgba(255,0,0,0.3); display: flex; align-items: center; z-index: 100; }
        .music-ctrl { width: 22px; filter: invert(1) sepia(1) saturate(10) hue-rotate(330deg); opacity: 0.8; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #0a0000; }
        ::-webkit-scrollbar-thumb { background: #400; border: 1px solid #600; }
        #screensaver { position: fixed; inset: 0; background: black; z-index: 99998; display: none; overflow: hidden; }
        .screensaver-bat { position: absolute; font-size: 30px; }
        @keyframes flyAround { 0% { transform: translate(0, 0); } 25% { transform: translate(80vw, 20vh); } 50% { transform: translate(40vw, 80vh); } 75% { transform: translate(10vw, 50vh); } 100% { transform: translate(0, 0); } }
        .profile-card { position: fixed; width: 340px; max-height: 650px; background: linear-gradient(135deg, #1a0000, #0a0000); border: 2px solid #700; box-shadow: 0 10px 40px rgba(0,0,0,0.9); z-index: 9000; display: none; overflow-y: auto; }
        .profile-card-header { display: flex; align-items: center; gap: 12px; padding: 15px; background: linear-gradient(180deg, #200000, #100000); border-bottom: 1px solid #500; }
        .profile-card-avatar { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; font-size: 35px; border: 3px solid #700; flex-shrink: 0; }
        .profile-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-card-name { font-weight: bold; font-size: 16px; }
        .profile-card-title { font-size: 10px; color: #888; margin-top: 2px; }
        .profile-card-bio { font-size: 11px; color: #aaa; padding: 12px 15px; border-bottom: 1px solid #300; line-height: 1.5; }
        .profile-card-btn { background: #500; color: #fff; border: 1px solid #800; padding: 6px 12px; font-size: 10px; cursor: pointer; }
        .chat-action { color: #888; font-style: italic; }
        .chat-bot { background: rgba(139, 0, 0, 0.1); border-left: 2px solid #8b0000; padding: 6px; margin: 4px 0; }
        .pinned-msg { background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; padding: 6px; margin-bottom: 8px; font-size: 10px; }
        .chat-image { max-width: 150px; max-height: 100px; border: 1px solid #400; margin-top: 4px; }
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #400; }
        .tab { padding: 6px 12px; color: #666; font-size: 10px; border-right: 1px solid #333; cursor: pointer; }
        .tab.active { background: #0a0000; color: #d40000; }
        .admin-section { margin-bottom: 15px; background: #0a0000; border: 1px solid #400; padding: 12px; }
        .admin-section h4 { color: #d40000; margin: 0 0 10px 0; font-size: 12px; border-bottom: 1px solid #400; padding-bottom: 5px; }
        .typing-indicator { display: flex; gap: 4px; padding: 8px 12px; color: #666; font-size: 11px; font-style: italic; }
        .typing-dot { width: 6px; height: 6px; background: #d40000; border-radius: 50%; animation: typingBounce 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }
        .chat-username { cursor: pointer; transition: all 0.2s; }
        .chat-username:hover { text-decoration: underline; text-shadow: 0 0 8px currentColor; }
        .app-status { padding: 8px; margin-top: 8px; border: 1px solid; font-size: 10px; }
        .app-pending { border-color: #ffd700; color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .stakes-grid { display: grid; grid-template-columns: repeat(9, 26px); gap: 1px; justify-content: center; }
        .stakes-cell { width: 26px; height: 26px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .stakes-cell.revealed { background: #111; }
        .stakes-cell.stake { background: #500; }
        .game-status { text-align: center; margin: 8px 0; color: #d40000; font-size: 11px; }
        .mgmt-sidebar { width: 160px; background: #0a0000; border-right: 1px solid #400; }
        .mgmt-sidebar-item { padding: 10px 12px; color: #888; font-size: 11px; cursor: pointer; border-bottom: 1px solid #300; transition: all 0.2s; }
        .mgmt-sidebar-item:hover { background: #150000; color: #d40000; }
        .mgmt-sidebar-item.active { background: #200000; color: #d40000; border-left: 3px solid #d40000; }
        .mgmt-content { flex: 1; padding: 15px; overflow-y: auto; }
        .user-id-display { font-family: monospace; color: #555; font-size: 9px; background: #050000; padding: 8px; border-top: 1px solid #300; margin-top: 10px; }
        /* MOBILE */
        @media screen and (max-width: 900px) {
            * { cursor: auto !important; }
            .bat-cursor { display: none !important; }
            #desktop { padding: 10px; gap: 10px; flex-direction: row; flex-wrap: wrap; justify-content: center; }
            .icon { width: 70px; margin-bottom: 5px; }
            .icon img.folder-icon { width: 36px; }
            .window { left: 5px !important; top: 50px !important; width: calc(100vw - 10px) !important; height: calc(100vh - 100px) !important; resize: none !important; }
            .chat-container { flex-direction: column; height: auto !important; max-height: 50vh; }
            #chat_logs { height: 200px; min-height: 200px; }
            #member_list { width: 100% !important; border-left: none !important; border-top: 1px solid #400; max-height: 150px; }
            .profile-card { left: 10px !important; top: 60px !important; width: calc(100vw - 20px) !important; max-height: 70vh !important; }
            .boot-title { font-size: 36px; }
            #chat_avatar { padding: 10px !important; }
            #chat_avatar > div:first-child { flex-direction: column; align-items: center; }
            .taskbar { height: 35px; }
            #memories_grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; padding: 10px !important; }
            .stakes-grid { grid-template-columns: repeat(9, 22px) !important; }
            .stakes-cell { width: 22px !important; height: 22px !important; font-size: 10px !important; }
            .ie-input { padding: 8px; font-size: 14px; }
            .ie-btn { padding: 10px; font-size: 12px; }
            .mgmt-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #400; display: flex; flex-wrap: wrap; }
            .mgmt-sidebar-item { flex: 1; min-width: 80px; text-align: center; border-bottom: none; }
        }
        @media screen and (max-width: 500px) {
            .boot-title { font-size: 28px; }
            #memories_grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
<div class="bat-cursor" id="batCursor">
    <svg viewBox="0 0 32 32" fill="#8b0000">
        <g class="wing-left"><path d="M16 14 L8 8 L6 12 L10 14 L6 16 L4 14 L2 18 L8 18 L12 16 L16 16 Z"/></g>
        <g class="wing-right"><path d="M16 14 L24 8 L26 12 L22 14 L26 16 L28 14 L30 18 L24 18 L20 16 L16 16 Z"/></g>
        <ellipse cx="16" cy="16" rx="4" ry="5"/><circle cx="16" cy="11" r="3"/>
        <circle cx="15" cy="10" r="0.8" fill="#ff0000"/><circle cx="17" cy="10" r="0.8" fill="#ff0000"/>
    </svg>
</div>
<div id="screensaver"></div>
<div class="window" id="profile_window" style="left:250px; top:80px; width:450px; height:580px; display:none; z-index:9000;">
    <div class="title-bar"><div class="title-bar-text" id="pw_title">ğŸ‘¤ Profile</div><div class="title-bar-controls"><button aria-label="Close" onclick="closeProfileWindow()"></button></div></div>
    <div class="window-body" style="overflow-y:auto; padding:0;">
        <!-- Profile Header -->
        <div style="background:linear-gradient(180deg, #200000, #100000); padding:20px; text-align:center; border-bottom:2px solid #500;">
            <div id="pw_avatar" style="width:100px; height:100px; border-radius:50%; background:#111; border:4px solid #700; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:50px; overflow:hidden;">ğŸ¦‡</div>
            <div id="pw_name" style="font-size:22px; font-weight:bold; color:#d40000;"></div>
            <div id="pw_rank" style="font-size:12px; color:#888; margin-top:5px;"></div>
            <div id="pw_status" style="font-size:11px; color:#aaa; margin-top:8px; font-style:italic;"></div>
            <div id="pw_mood" style="font-size:10px; color:#666; margin-top:4px;"></div>
        </div>
        
        <!-- Stats Row -->
        <div style="display:flex; background:#0a0000; border-bottom:1px solid #300;">
            <div style="flex:1; text-align:center; padding:15px; border-right:1px solid #300;">
                <div id="pw_rep" style="color:#ff4444; font-size:24px; font-weight:bold;">0</div>
                <div style="color:#666; font-size:9px; text-transform:uppercase;">Reputation</div>
            </div>
            <div style="flex:1; text-align:center; padding:15px;">
                <div id="pw_comments_count" style="color:#ff4444; font-size:24px; font-weight:bold;">0</div>
                <div style="color:#666; font-size:9px; text-transform:uppercase;">Comments</div>
            </div>
        </div>
        
        <!-- Bio Section -->
        <div style="padding:15px; border-bottom:1px solid #300;">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:8px;">ğŸ“œ ABOUT</div>
            <div id="pw_bio" style="color:#aaa; font-size:12px; line-height:1.6;">No bio set.</div>
        </div>
        
        <!-- Music Section -->
        <div id="pw_music_section" style="padding:15px; border-bottom:1px solid #300; display:none;">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:8px;">ğŸµ PROFILE MUSIC</div>
            <div id="pw_music_player"></div>
        </div>
        
        <!-- Action Buttons -->
        <div style="padding:15px; display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid #300;">
            <button class="ie-btn" style="flex:1; min-width:100px; margin:0;" onclick="openDM(currentProfileUser)">ğŸ’¬ Message</button>
            <button class="ie-btn" id="pw_btn_rep_pos" style="flex:1; min-width:80px; margin:0; background:#050; border-color:#0a0; display:none;" onclick="giveRep(1)">ğŸ‘ +Rep</button>
            <button class="ie-btn" id="pw_btn_rep_neg" style="flex:1; min-width:80px; margin:0; background:#500; border-color:#a00; display:none;" onclick="giveRep(-1)">ğŸ‘ -Rep</button>
        </div>
        
        <!-- Comments Section -->
        <div style="padding:15px;">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:10px;">ğŸ’¬ PROFILE COMMENTS</div>
            <div id="pw_comments_list" style="max-height:150px; overflow-y:auto; margin-bottom:15px;">
                <div style="color:#555; font-size:10px;">No comments yet.</div>
            </div>
            <div id="pw_comment_form" style="display:none;">
                <input type="text" id="pw_comment_input" class="ie-input" placeholder="Leave a comment..." style="margin-bottom:8px;">
                <button class="ie-btn" style="padding:8px;" onclick="leaveProfileComment()">Post Comment</button>
            </div>
        </div>
        
        <!-- User ID Footer -->
        <div style="padding:12px 15px; background:#050000; border-top:1px solid #300;">
            <div style="color:#444; font-size:9px; font-family:monospace;" id="pw_user_id">User ID: ...</div>
        </div>
    </div>
</div>
<div id="boot-screen" onclick="beginSession()">
    <div style="font-size: 80px; margin-bottom: 20px; animation: batFloat 3s ease-in-out infinite;">ğŸ¦‡</div>
    <h1 class="boot-title">fangtasia.wtf</h1>
    <p class="boot-subtitle">Click anywhere to enter the crypt...</p>
    <div style="margin-top: 30px;"><div class="visitor-counter">SOULS COLLECTED: <span id="visitor_count">000000</span></div></div>
    <div style="margin-top: 40px; color: #500; font-size: 10px; animation: flicker 3s infinite;">â–¼ CLICK TO INITIALIZE â–¼</div>
</div>
<div id="desktop">
    <div class="icon" onclick="toggleWin('memories_folder')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png"><div>Memories</div></div>
    <div class="icon" onclick="toggleWin('ie_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/msie1-2.png"><div>Portal</div></div>
    <div class="icon" onclick="toggleWin('games_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/joystick-2.png"><div>Games</div></div>
    <div class="icon" onclick="toggleWin('apply_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/keys-0.png"><div>Apply</div></div>
    <div class="icon" onclick="toggleWin('about_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/help_book_cool-4.png"><div>About</div></div>
    <div class="icon" id="admin_icon" style="display:none;" onclick="toggleWin('admin_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/lock-0.png"><div>Admin Panel</div></div>
</div>
<div class="window" id="about_window" style="left:200px; top:120px; width:350px; height:320px;">
    <div class="title-bar"><div class="title-bar-text">About fangtasia.wtf</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('about_window')"></button></div></div>
    <div class="window-body"><div class="ie-content" style="text-align: center;"><h2 style="font-size: 28px; margin-bottom: 5px;">fangtasia.wtf</h2><p style="color: #666; font-size: 10px;">Version 6.66</p><div style="border: 1px solid #400; padding: 15px; margin: 15px 0; text-align: left; background: #050000;"><p style="color: #999; font-size: 11px; line-height: 1.6;">Welcome to the digital crypt.<br><br>ğŸ¦‡ <span style="color:#d40000;">Memories</span> - Video archive<br>ğŸ¦‡ <span style="color:#d40000;">Portal</span> - Member access<br>ğŸ¦‡ <span style="color:#d40000;">Games</span> - Silver Stakes<br>ğŸ¦‡ <span style="color:#d40000;">The Lounge</span> - Members only</p></div></div></div>
</div>
<div class="window" id="games_window" style="left:180px; top:70px; width:320px; height:400px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ® Silver Stakes</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('games_window')"></button></div></div>
    <div class="window-body"><div style="padding: 10px;"><h3 style="color: #d40000; text-align: center; margin: 5px 0;">Silver Stakes</h3><p style="color: #666; font-size: 9px; text-align: center;">Avoid the stakes!</p><div class="game-status" id="game_status">ğŸ¦‡ Stakes: 10</div><div class="stakes-grid" id="stakes_grid"></div><div style="text-align: center; margin-top: 8px;"><button class="ie-btn" style="width: auto; padding: 4px 15px;" onclick="initStakesGame()">New Game</button></div></div></div>
</div>
<div class="window" id="apply_window" style="left:160px; top:90px; width:340px; height:440px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ”‘ Apply for Access</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('apply_window')"></button></div></div>
    <div class="window-body"><div class="ie-content"><h2 style="margin-top: 0; font-size: 18px;">Join the Coven</h2><div id="app_form"><input type="text" id="app_username" class="ie-input" placeholder="Desired Username" maxlength="20"><input type="text" id="app_referral" class="ie-input" placeholder="Who referred you?"><textarea id="app_reason" class="ie-input" placeholder="Why do you seek entry?" style="height: 60px; resize: none;"></textarea><button class="ie-btn" onclick="submitApplication()">ğŸ©¸ Submit Blood Pact</button><button class="ie-btn" style="background: #333; margin-top: 5px;" onclick="checkAppStatus()">Check Status</button></div><div id="app_result" style="display: none;"></div></div></div>
</div>
<div class="window" id="chat_win" style="left:400px; top:30px; width:820px; height:620px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ©¸ The Lounge</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('chat_win')"></button></div></div>
    <div class="window-body">
        <div class="tab-bar"><div class="tab active" onclick="switchChatTab('main', this)">ğŸ’¬ Lounge</div><div class="tab" onclick="switchChatTab('avatar', this)">ğŸ¦‡ My Profile</div></div>
        <div id="chat_main">
            <div id="pinned_container"></div>
            <div class="chat-container" id="chat_container">
                <div id="chat_logs"></div>
                <div id="member_list">
                    <div id="online_member_list"></div>
                </div>
            </div>
            <div id="typing_area" style="padding: 5px 12px; background: #080000; display: none;"><div class="typing-indicator"><span id="typing_user"></span>&nbsp;is typing<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
            <div style="padding:10px; background:#111;">
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input type="text" id="chat_input" class="ie-input" style="margin:0; flex:1;" placeholder="/help for commands..." onkeypress="handleChatKey(event)" onkeyup="handleTyping()">
                    <label class="ie-btn" style="width: 35px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">ğŸ“<input type="file" id="chat_file" accept="image/*,video/*,audio/*,.gif" style="display:none;" onchange="uploadChatFile()"></label>
                </div>
                <button class="ie-btn" onclick="sendChat()">Send</button>
            </div>
        </div>
        <div id="chat_avatar" style="display: none; padding: 20px; overflow-y: auto; height: calc(100% - 40px);">
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="text-align:center;">
                    <div id="my_avatar_display" style="width:120px; height:120px; border-radius:50%; background:#111; border:3px solid #700; display:flex; align-items:center; justify-content:center; font-size:60px; overflow:hidden; margin:0 auto;">ğŸ¦‡</div>
                    <div id="my_username_display" style="color:#d40000; font-size:18px; font-weight:bold; margin-top:10px;"></div>
                    <div id="my_rank_display" style="color:#888; font-size:12px;"></div>
                </div>
                <div style="flex:1;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Edit Profile</h3>
                    <label style="color:#888; font-size:10px;">Profile Picture URL</label>
                    <input type="text" id="avatar_url" class="ie-input" placeholder="Paste image URL">
                    <label style="color:#888; font-size:10px;">Or Upload Image</label>
                    <input type="file" id="avatar_upload" class="ie-input" accept="image/*" style="border:none; padding:5px 0;">
                    <button class="ie-btn" style="padding:8px; margin-bottom:15px;" onclick="updateAvatar()">Update Avatar</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr; gap:15px;">
                <div>
                    <label style="color:#888; font-size:10px;">Profile Music (SoundCloud/Spotify URL)</label>
                    <input type="text" id="profile_music" class="ie-input" placeholder="https://soundcloud.com/...">
                    <button class="ie-btn" style="padding:8px;" onclick="updateProfileMusic()">Set Music</button>
                </div>
                <div>
                    <label style="color:#888; font-size:10px;">Mood Status</label>
                    <select id="user_mood" class="ie-input" onchange="saveProfile()">
                        <option value="">None</option><option value="ğŸ©¸ Thirsty">ğŸ©¸ Thirsty</option><option value="ğŸ˜´ Dormant">ğŸ˜´ Dormant</option><option value="ğŸŒ™ Hunting">ğŸŒ™ Hunting</option><option value="âš°ï¸ Resting">âš°ï¸ Resting</option><option value="ğŸ¦‡ Lurking">ğŸ¦‡ Lurking</option><option value="ğŸ”¥ Vibing">ğŸ”¥ Vibing</option><option value="ğŸ’€ Dead Inside">ğŸ’€ Dead Inside</option>
                    </select>
                    <label style="color:#888; font-size:10px;">Custom Status</label>
                    <input type="text" id="user_status" class="ie-input" placeholder="What's happening..." maxlength="30">
                    <label style="color:#888; font-size:10px;">Bio</label>
                    <textarea id="user_bio" class="ie-input" placeholder="Tell us about yourself..." maxlength="200" style="height:80px; resize:none;"></textarea>
                </div>
            </div>
            <button class="ie-btn" style="margin-top:20px; padding:12px; background:#700;" onclick="saveProfile()">ğŸ’¾ Save All Changes</button>
        </div>
    </div>
</div>
<!-- ADMIN PANEL - Management UI Style -->
<div class="window" id="admin_window" style="left:100px; top:40px; width:750px; height:550px; display:none;">
    <div class="title-bar"><div class="title-bar-text">ğŸ‘‘ Admin Control Panel</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('admin_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:100%;">
        <div class="mgmt-sidebar">
            <div class="mgmt-sidebar-item active" onclick="switchAdminTab('apps', this)">ğŸ“ Applications</div>
            <div class="mgmt-sidebar-item" onclick="switchAdminTab('members', this)">ğŸ‘¥ Members</div>
            <div class="mgmt-sidebar-item" onclick="switchAdminTab('images', this)">ğŸ–¼ï¸ Pending Images</div>
            <div class="mgmt-sidebar-item" onclick="switchAdminTab('moderation', this)">âš ï¸ Moderation</div>
            <div class="mgmt-sidebar-item" onclick="switchAdminTab('announcements', this)">ğŸ“Œ Announcements</div>
            <div class="mgmt-sidebar-item" onclick="switchAdminTab('bot', this)">ğŸ§› Eric Bot</div>
            <div class="mgmt-sidebar-item" onclick="switchAdminTab('videos', this)">ğŸ“¹ Videos</div>
            <div class="mgmt-sidebar-item" onclick="switchAdminTab('vip', this)">ğŸŒŸ VIP Codes</div>
            <div class="mgmt-sidebar-item" id="st_tab" style="display:none;" onclick="switchAdminTab('st', this)">ğŸ”® ST Tools</div>
        </div>
        <div class="mgmt-content">
            <!-- Applications Tab -->
            <div id="admin_tab_apps">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Membership Applications</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="app_filter" class="ie-input" style="width:150px; margin:0;" onchange="loadAllApplications()">
                        <option value="all">All</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="denied">Denied</option>
                    </select>
                    <input type="text" id="app_search" class="ie-input" placeholder="Search username..." style="flex:1; margin:0;" oninput="loadAllApplications()">
                </div>
                <div id="all_applications" style="max-height:380px; overflow-y:auto;"></div>
            </div>
            <!-- Members Tab -->
            <div id="admin_tab_members" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">All Members</h3>
                <div id="all_members" style="max-height:420px; overflow-y:auto;"></div>
            </div>
            <!-- Pending Images Tab -->
            <div id="admin_tab_images" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Pending Image Approvals</h3>
                <div id="pending_images" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; max-height:420px; overflow-y:auto;"></div>
            </div>
            <!-- Moderation Tab -->
            <div id="admin_tab_moderation" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">User Moderation</h3>
                <div class="admin-section">
                    <h4>Take Action</h4>
                    <input type="text" id="mod_username" class="ie-input" placeholder="Username to moderate...">
                    <select id="mod_action" class="ie-input"><option value="">Select Action...</option><option value="kick">Kick</option><option value="timeout">Timeout</option><option value="softban">Soft Ban</option><option value="hardban">Hard Ban</option></select>
                    <select id="mod_duration" class="ie-input"><option value="5">5 minutes</option><option value="30">30 minutes</option><option value="60">1 hour</option><option value="1440">24 hours</option><option value="10080">7 days</option><option value="0">Permanent</option></select>
                    <input type="text" id="mod_reason" class="ie-input" placeholder="Reason (optional)">
                    <button class="ie-btn" style="background: #800;" onclick="executeModAction()">Execute Action</button>
                    <div id="mod_result" style="margin-top: 5px; font-size: 10px;"></div>
                </div>
                <div class="admin-section">
                    <h4>Banned/Suspended Users</h4>
                    <div id="banned_users" style="max-height:150px; overflow-y:auto; font-size:10px;">None</div>
                </div>
            </div>
            <!-- Announcements Tab -->
            <div id="admin_tab_announcements" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Lounge Announcements</h3>
                <div class="admin-section">
                    <h4>Pin Message</h4>
                    <input type="text" id="pin_message" class="ie-input" placeholder="Message to pin in the lounge...">
                    <div style="display:flex; gap:10px;">
                        <button class="ie-btn" style="flex:1;" onclick="pinMessage()">ğŸ“Œ Pin Message</button>
                        <button class="ie-btn" style="flex:1; background:#333;" onclick="clearPin()">Clear Pin</button>
                    </div>
                </div>
                <div class="admin-section">
                    <h4>Chat Management</h4>
                    <button class="ie-btn" style="background: #500;" onclick="clearChat()">ğŸ—‘ï¸ Clear All Messages</button>
                    <button class="ie-btn" style="background: #333; margin-top:5px;" onclick="exportChat()">ğŸ“¥ Export Chat Log</button>
                </div>
            </div>
            <!-- Bot Tab -->
            <div id="admin_tab_bot" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Eric Northman Bot</h3>
                <div class="admin-section">
                    <h4>Send as Eric</h4>
                    <textarea id="bot_message" class="ie-input" placeholder="Eric says..." style="height:80px; resize:none;"></textarea>
                    <button class="ie-btn" onclick="sendBotMessage()">ğŸ§› Send Message</button>
                </div>
            </div>
            <!-- Videos Tab -->
            <div id="admin_tab_videos" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Video Archive Management</h3>
                <div id="all_videos" style="max-height:420px; overflow-y:auto;"></div>
            </div>
            <!-- VIP Codes Tab -->
            <div id="admin_tab_vip" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">VIP Invite Codes</h3>
                <button class="ie-btn" style="width:auto; padding:10px 20px; margin-bottom:15px;" onclick="generateVIPCode()">ğŸŒŸ Generate New Code</button>
                <div id="vip_code_display" style="margin-bottom:15px; color:#ffd700; font-family:monospace; font-size:16px;"></div>
                <div id="all_vip_codes" style="max-height:350px; overflow-y:auto;"></div>
            </div>
            <!-- ST Tools Tab -->
            <div id="admin_tab_st" style="display:none;">
                <h3 style="color:#ff00ff; margin:0 0 15px 0;">ğŸ”® Site Technician Tools</h3>
                <div class="admin-section" style="border-color:#ff00ff;">
                    <h4 style="color:#ff00ff;">Elevate User Permissions</h4>
                    <input type="text" id="elevate_user" class="ie-input" placeholder="Username">
                    <select id="elevate_rank" class="ie-input">
                        <option value="member">Member</option>
                        <option value="vip">VIP</option>
                        <option value="contrib">Contributor</option>
                        <option value="mod">Moderator</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="elevateUser()">Elevate User</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="window" id="memories_folder" style="left:50px; top:50px; width:550px; height:580px;">
    <div class="title-bar"><div class="title-bar-text">C:\Memories</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('memories_folder')"></button></div></div>
    <div class="window-body" style="display:flex; flex-direction:column; height:100%;">
        <div id="memories_grid" style="flex:1; overflow-y:auto; padding:15px;"></div>
        <div class="pagination-bar" style="display:flex; justify-content:center; align-items:center; gap:15px; padding:12px; flex-shrink:0;">
            <button class="ie-btn" style="width:80px; padding: 6px 12px; margin:0;" onclick="prevPage()">â—€ Prev</button>
            <span id="page_indicator" style="color:#888; font-size:11px; min-width:80px; text-align:center;">Page 1</span>
            <button class="ie-btn" style="width:80px; padding: 6px 12px; margin:0;" onclick="nextPage()">Next â–¶</button>
        </div>
    </div>
</div>
<div class="window" id="ie_window" style="left:120px; top:80px; width:450px; height:680px;">
    <div class="title-bar"><div class="title-bar-text">fangtasia.wtf Portal</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('ie_window')"></button></div></div>
    <div class="window-body" style="overflow-y:auto;">
        <div class="ie-content" id="ie_login">
            <h2>Member Login</h2>
            <input type="text" id="ie_user" class="ie-input" placeholder="Username">
            <input type="password" id="ie_pass" class="ie-input" placeholder="Password">
            <button class="ie-btn" onclick="validateIE()">Authorize</button>
            <div class="guest-section">
                <p style="color: #666; font-size: 10px; text-align: center; margin-bottom: 10px;">â€” OR â€”</p>
                <button class="guest-btn" onclick="toggleWin('about_window')">â“ About This Place</button>
                <button class="guest-btn" onclick="enterGuestChat()">ğŸ‘ï¸ Lurk the Lounge (Read-Only)</button>
            </div>
        </div>
        <div class="ie-content" id="ie_upload" style="display:none;">
            <button class="lounge-entry-btn" onclick="openChat()">ğŸ©¸ Enter The Lounge</button>
            <p id="logged_in_as" style="font-size: 11px; color: #fff;"></p>
            <h3 style="color:#d40000; margin: 15px 0 5px 0; font-size: 13px;">ğŸ“¹ Upload Memory</h3>
            <input type="text" id="ie_filename" class="ie-input" placeholder="Memory Name">
            <input type="file" id="ie_file_picker" class="ie-input" style="border:none;" accept="video/*">
            <button class="ie-btn" id="upload_status" onclick="processIEUpload()">Push to Cloud</button>
            <div id="vip_image_section" style="display:none; margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                <h3 style="color:#ffd700; margin: 0 0 5px 0; font-size: 13px;">ğŸŒŸ VIP Image Hosting</h3>
                <input type="file" id="vip_image_picker" class="ie-input" style="border:none;" accept="image/*">
                <button class="ie-btn" style="background:#5a4a00;" onclick="uploadVIPImage()">Upload Image</button>
                <div id="vip_image_result" style="margin-top:8px;"></div>
            </div>
            <button class="ie-btn" style="background: #222; margin-top: 15px;" onclick="logout()">Logout</button>
        </div>
    </div>
</div>
<div class="taskbar">
    <div style="margin-left: 10px; display: flex; gap: 8px;">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="music-ctrl" onclick="playMusic()" title="Play" style="width:18px; height:18px; cursor:pointer; filter: invert(1) brightness(0.7);">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727240.png" class="music-ctrl" onclick="pauseMusic()" title="Pause" style="width:18px; height:18px; cursor:pointer; filter: invert(1) brightness(0.7);">
    </div>
    <div style="margin-left: auto; margin-right: 15px; color: #888; font-size: 11px;" id="taskbar_clock"></div>
</div>
<div id="player" style="position:absolute; top:-999px;"></div>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyB7GeyT9SY7zFBeT-lfCM6iHZ_ipFXvemU",
    authDomain: "fangtasia-14197.firebaseapp.com",
    databaseURL: "https://fangtasia-14197-default-rtdb.firebaseio.com",
    projectId: "fangtasia-14197",
    storageBucket: "fangtasia-14197.firebasestorage.app",
    messagingSenderId: "735588641679",
    appId: "1:735588641679:web:5e0b9c5c5c84166b2f79fa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const CLOUD_NAME = "fangtasia-14197";
const UPLOAD_PRESET = "fangtasia";

// USER DATABASE - Added "north" and Contributor role
const coreAdmins = {
    "losersyndicate": { pass: "doubledutchie01", rank: "ST", fullRank: "Site Technician", style: "st-style", target: "list_technician", isAdmin: true, isST: true },
    "noseeyedear": { pass: "wtfomfgfangtasiafordabros21", rank: "A", fullRank: "Admin", style: "a-style", target: "list_admin", isAdmin: true },
    "oleg": { pass: "methybethy89!", rank: "A", fullRank: "Admin", style: "a-style", target: "list_admin", isAdmin: true },
    "north": { pass: "lmaolegacy12!$$", rank: "M", fullRank: "Member", style: "member-style", target: "list_member", isAdmin: false }
};
let userDatabase = { ...coreAdmins };
db.ref('members').on('value', (s) => { userDatabase = { ...coreAdmins, ...(s.val() || {}) }; updateOnlineMemberList(); });

let CURRENT_USER = "", IS_GUEST = false, currentPage = 1, itemsPerPage = 9;
let userProfile = { status: "", bio: "", mood: "", avatar: "", music: "" };
let currentProfileUser = "", idleTime = 0, screensaverActive = false;

// REAL-TIME PROFILE CACHE
let profileCache = {};
db.ref('profiles').on('value', (s) => { profileCache = s.val() || {}; });
function getProfile(username) { return profileCache[username] || {}; }

// Generate unique user ID from username
function generateUserId(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        const char = username.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'FNG-' + Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
}

// BAT CURSOR
document.addEventListener('mousemove', (e) => {
    const bat = document.getElementById('batCursor');
    if(bat) { bat.style.left = e.clientX + 'px'; bat.style.top = e.clientY + 'px'; }
    resetIdle();
});
document.addEventListener('keypress', resetIdle);
document.addEventListener('click', resetIdle);

function resetIdle() {
    idleTime = 0;
    if (screensaverActive) { document.getElementById('screensaver').style.display = 'none'; screensaverActive = false; }
}
function activateScreensaver() {
    screensaverActive = true;
    const ss = document.getElementById('screensaver');
    ss.innerHTML = '';
    ss.style.display = 'block';
    for (let i = 0; i < 12; i++) {
        const bat = document.createElement('div');
        bat.className = 'screensaver-bat';
        bat.textContent = 'ğŸ¦‡';
        bat.style.left = Math.random() * 90 + 'vw';
        bat.style.top = Math.random() * 90 + 'vh';
        bat.style.animation = `flyAround ${6 + Math.random() * 6}s linear infinite`;
        ss.appendChild(bat);
    }
}
setInterval(() => { idleTime++; if (idleTime > 90 && !screensaverActive && document.getElementById('boot-screen').style.display === 'none') activateScreensaver(); }, 1000);

function updateVisitorCount() {
    let count = parseInt(localStorage.getItem('f_visitors') || '0');
    if (!sessionStorage.getItem('counted')) { count++; localStorage.setItem('f_visitors', count); sessionStorage.setItem('counted', 'true'); }
    document.getElementById('visitor_count').textContent = count.toString().padStart(6, '0');
}
function updateClock() { const now = new Date(); document.getElementById('taskbar_clock').textContent = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0'); }
setInterval(updateClock, 1000);
function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

// SILVER STAKES GAME
let stakesBoard = [], stakesRevealed = [], stakesFlagged = [], gameOver = false;
function initStakesGame() {
    stakesBoard = Array(81).fill(0); stakesRevealed = Array(81).fill(false); stakesFlagged = Array(81).fill(false); gameOver = false;
    let placed = 0;
    while (placed < 10) { const pos = Math.floor(Math.random() * 81); if (stakesBoard[pos] !== -1) { stakesBoard[pos] = -1; placed++; } }
    for (let i = 0; i < 81; i++) {
        if (stakesBoard[i] === -1) continue;
        let count = 0; const row = Math.floor(i / 9), col = i % 9;
        for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && stakesBoard[nr * 9 + nc] === -1) count++; }
        stakesBoard[i] = count;
    }
    renderStakes();
    document.getElementById('game_status').textContent = 'ğŸ¦‡ Stakes: 10';
}
function renderStakes() {
    const grid = document.getElementById('stakes_grid'); grid.innerHTML = '';
    for (let i = 0; i < 81; i++) {
        const cell = document.createElement('div'); cell.className = 'stakes-cell';
        if (stakesRevealed[i]) { cell.classList.add('revealed'); if (stakesBoard[i] === -1) { cell.classList.add('stake'); cell.textContent = 'ğŸ—¡ï¸'; } else if (stakesBoard[i] > 0) { cell.textContent = stakesBoard[i]; cell.style.color = ['','#00f','#0a0','#f00','#008','#800','#088','#000','#888'][stakesBoard[i]]; } }
        else if (stakesFlagged[i]) { cell.textContent = 'ğŸš©'; }
        cell.onclick = () => revealCell(i);
        cell.oncontextmenu = (e) => { e.preventDefault(); if (!gameOver && !stakesRevealed[i]) { stakesFlagged[i] = !stakesFlagged[i]; renderStakes(); } };
        grid.appendChild(cell);
    }
}
function revealCell(i) {
    if (gameOver || stakesRevealed[i] || stakesFlagged[i]) return;
    stakesRevealed[i] = true;
    if (stakesBoard[i] === -1) { gameOver = true; stakesRevealed = stakesRevealed.map(() => true); document.getElementById('game_status').textContent = 'ğŸ’€ Staked! Game Over.'; }
    else if (stakesBoard[i] === 0) { const row = Math.floor(i / 9), col = i % 9; for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) revealCell(nr * 9 + nc); } }
    const unrevealed = stakesRevealed.filter((r, idx) => !r && stakesBoard[idx] !== -1).length;
    if (unrevealed === 0 && !gameOver) { gameOver = true; document.getElementById('game_status').textContent = 'ğŸ¦‡ You survived!'; }
    renderStakes();
}

// APPLICATION SYSTEM
function submitApplication() {
    const username = document.getElementById('app_username').value.trim();
    const reason = document.getElementById('app_reason').value.trim();
    if (!username || !reason) { alert('Fill required fields.'); return; }
    db.ref('applications/' + Date.now()).set({ username, referral: document.getElementById('app_referral').value, reason, date: new Date().toLocaleDateString(), status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP });
    document.getElementById('app_form').style.display = 'none';
    document.getElementById('app_result').innerHTML = '<div class="app-status app-pending"><strong>ğŸ©¸ Blood Pact Received</strong></div>';
    document.getElementById('app_result').style.display = 'block';
}
function checkAppStatus() {
    const username = document.getElementById('app_username').value.trim();
    if (!username) { alert('Enter username.'); return; }
    db.ref('applications').orderByChild('username').equalTo(username).once('value', (s) => {
        let app = null; s.forEach((c) => { app = c.val(); });
        const rd = document.getElementById('app_result');
        document.getElementById('app_form').style.display = 'none'; rd.style.display = 'block';
        if (!app) rd.innerHTML = '<div class="app-status" style="border-color:#888; color:#888;">No application found.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'pending') rd.innerHTML = '<div class="app-status app-pending">ğŸ• Pending review.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'approved') rd.innerHTML = '<div class="app-status" style="border-color:#0f0; color:#0f0;">âœ“ Approved!</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else rd.innerHTML = '<div class="app-status" style="border-color:#f00; color:#f00;">âœ— Denied.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
    });
}
function resetAppForm() { document.getElementById('app_form').style.display = 'block'; document.getElementById('app_result').style.display = 'none'; }
function enterGuestChat() { IS_GUEST = true; CURRENT_USER = "Guest_" + Math.floor(Math.random() * 9999); toggleWin('chat_win'); loadMessages(); document.getElementById('chat_input').placeholder = "Lurking (read-only)..."; document.getElementById('chat_input').disabled = true; }

// LOGIN SYSTEM
function validateIE() {
    const u = document.getElementById('ie_user').value.trim();
    const p = document.getElementById('ie_pass').value;
    if (!u || !p) { alert("Enter username and password."); return; }
    db.ref('bans/' + u).once('value', (s) => {
        const ban = s.val();
        if (ban && (ban.expiry === 0 || ban.expiry > Date.now())) { alert('Account banned/suspended.'); return; }
        if(userDatabase[u] && userDatabase[u].pass === p) {
            CURRENT_USER = u; IS_GUEST = false;
            document.getElementById('ie_login').style.display = 'none';
            document.getElementById('ie_upload').style.display = 'block';
            document.getElementById('logged_in_as').innerText = `IDENTIFIED: ${u} [${userDatabase[u].fullRank}]`;
            loadProfile();
            if (userDatabase[u].isAdmin) { document.getElementById('admin_icon').style.display = 'block'; }
            if (userDatabase[u].isST) { document.getElementById('st_tab').style.display = 'block'; }
            // VIP, Contributor, Admin, ST can use image hosting
            const rank = userDatabase[u].rank;
            if (rank === 'VIP' || rank === 'CONTRIB' || userDatabase[u].isAdmin || userDatabase[u].isST) { 
                document.getElementById('vip_image_section').style.display = 'block'; 
            }
        } else { alert("DENIED."); }
    });
}
function logout() {
    if (CURRENT_USER) db.ref('online/' + CURRENT_USER).remove();
    CURRENT_USER = ""; IS_GUEST = false;
    document.getElementById('ie_login').style.display = 'block';
    document.getElementById('ie_upload').style.display = 'none';
    document.getElementById('ie_user').value = '';
    document.getElementById('ie_pass').value = '';
    document.getElementById('admin_icon').style.display = 'none';
    document.getElementById('st_tab').style.display = 'none';
    document.getElementById('vip_image_section').style.display = 'none';
    toggleWin('chat_win');
}
function openChat() { 
    if(CURRENT_USER && !IS_GUEST) { 
        toggleWin('chat_win'); 
        loadMessages(); 
        setUserOnline(); 
        document.getElementById('chat_input').disabled = false; 
        document.getElementById('chat_input').placeholder = "/help for commands..."; 
    } 
}
function setUserOnline() {
    if (!CURRENT_USER || IS_GUEST) return;
    const user = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style', fullRank: 'Member' };
    db.ref('online/' + CURRENT_USER).set({ 
        username: CURRENT_USER, 
        rank: user.rank || 'M', 
        style: user.style || 'member-style', 
        fullRank: user.fullRank || 'Member', 
        lastSeen: firebase.database.ServerValue.TIMESTAMP 
    });
    db.ref('online/' + CURRENT_USER).onDisconnect().remove();
}

// Update online member list - grouped by rank with tags
function updateOnlineMemberList() {
    db.ref('online').on('value', (s) => {
        const container = document.getElementById('online_member_list'); 
        if (!container) return;
        
        const users = [];
        s.forEach(c => users.push(c.val()));
        
        // Group by rank
        const ranks = {
            'ST': { name: 'Site Technician', style: 'st-style', users: [] },
            'A': { name: 'Admins', style: 'a-style', users: [] },
            'MOD': { name: 'Moderators', style: 'mod-style', users: [] },
            'CONTRIB': { name: 'Contributors', style: 'contrib-style', users: [] },
            'VIP': { name: 'VIP', style: 'vip-style', users: [] },
            'M': { name: 'Members', style: 'member-style', users: [] }
        };
        
        users.forEach(u => {
            const rank = u.rank || 'M';
            if (ranks[rank]) ranks[rank].users.push(u);
            else ranks['M'].users.push(u);
        });
        
        let html = '<div style="color:#0f0; font-size:10px; text-align:center; padding:5px; background:#001100; margin-bottom:10px;">â— ONLINE: ' + users.length + '</div>';
        
        Object.keys(ranks).forEach(key => {
            if (ranks[key].users.length > 0) {
                html += `<div class="member-category">${ranks[key].name}</div>`;
                ranks[key].users.forEach(u => {
                    html += `<div class="member-item ${u.style}" onclick="showProfileCard('${escapeHtml(u.username)}', event)">
                        <span class="member-tag ${u.style}">${u.rank}</span>
                        <span style="color:#0f0; font-size:8px;">â—</span> 
                        ${escapeHtml(u.username)}
                    </div>`;
                });
            }
        });
        
        container.innerHTML = html;
    });
}

// PROFILE SYSTEM - Avatar saves properly
function loadProfile() {
    if (!CURRENT_USER) return;
    db.ref('profiles/' + CURRENT_USER).once('value', (s) => {
        const p = s.val() || {};
        userProfile = { 
            status: p.status || "", 
            bio: p.bio || "", 
            mood: p.mood || "", 
            avatar: p.avatar || "", 
            music: p.music || "" 
        };
        const statusEl = document.getElementById('user_status');
        const bioEl = document.getElementById('user_bio');
        const moodEl = document.getElementById('user_mood');
        const avatarUrlEl = document.getElementById('avatar_url');
        const musicEl = document.getElementById('profile_music');
        if (statusEl) statusEl.value = userProfile.status;
        if (bioEl) bioEl.value = userProfile.bio;
        if (moodEl) moodEl.value = userProfile.mood;
        if (avatarUrlEl) avatarUrlEl.value = userProfile.avatar;
        if (musicEl) musicEl.value = userProfile.music;
        
        // Display avatar
        const avatarDisplay = document.getElementById('my_avatar_display');
        if (avatarDisplay && userProfile.avatar) {
            avatarDisplay.innerHTML = '<img src="' + userProfile.avatar + '" style="width:100%; height:100%; object-fit:cover;">';
        }
    });
}

function saveProfile() {
    if (!CURRENT_USER) { alert('Please log in first.'); return; }
    
    const statusEl = document.getElementById('user_status');
    const bioEl = document.getElementById('user_bio');
    const moodEl = document.getElementById('user_mood');
    const musicEl = document.getElementById('profile_music');
    
    // Get current values
    const newStatus = statusEl ? statusEl.value.trim() : '';
    const newBio = bioEl ? bioEl.value.trim() : '';
    const newMood = moodEl ? moodEl.value : '';
    const newMusic = musicEl ? musicEl.value.trim() : '';
    
    // Update local profile object
    userProfile.status = newStatus;
    userProfile.bio = newBio;
    userProfile.mood = newMood;
    userProfile.music = newMusic;
    
    // Save to Firebase - include all profile fields
    const profileData = {
        status: newStatus,
        bio: newBio,
        mood: newMood,
        music: newMusic,
        lastUpdated: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Only include avatar if it exists
    if (userProfile.avatar) {
        profileData.avatar = userProfile.avatar;
    }
    
    db.ref('profiles/' + CURRENT_USER).update(profileData)
        .then(() => {
            alert('Profile saved successfully!');
        })
        .catch((err) => {
            console.error('Error saving profile:', err);
            alert('Failed to save profile. Please try again.');
        });
}

function updateAvatar() {
    const url = document.getElementById('avatar_url').value.trim();
    const fileInput = document.getElementById('avatar_upload');
    
    if (url) {
        userProfile.avatar = url;
        db.ref('profiles/' + CURRENT_USER).update({ avatar: url });
        document.getElementById('my_avatar_display').innerHTML = '<img src="' + url + '" style="width:100%; height:100%; object-fit:cover;">';
        alert('Avatar updated!');
    } else if (fileInput && fileInput.files[0]) {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('upload_preset', UPLOAD_PRESET);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData })
            .then(res => res.json()).then(data => {
                if (data.secure_url) {
                    userProfile.avatar = data.secure_url;
                    db.ref('profiles/' + CURRENT_USER).update({ avatar: data.secure_url });
                    document.getElementById('my_avatar_display').innerHTML = '<img src="' + data.secure_url + '" style="width:100%; height:100%; object-fit:cover;">';
                    document.getElementById('avatar_url').value = data.secure_url;
                    alert('Avatar uploaded and saved!');
                }
            });
    } else { 
        alert('Enter URL or select file.'); 
    }
}

function updateProfileMusic() {
    const url = document.getElementById('profile_music').value.trim();
    userProfile.music = url;
    db.ref('profiles/' + CURRENT_USER).update({ music: url });
    alert('Profile music set!');
}

// PROFILE CARD - With User ID display
// PROFILE WINDOW - Full profile viewing
function showProfileCard(username, event) {
    if (event) { event.preventDefault(); event.stopPropagation(); }
    if (!username) return;
    openProfileWindow(username);
}

function openProfileWindow(username) {
    if (!username) return;
    currentProfileUser = username;
    
    const win = document.getElementById('profile_window');
    const userData = userDatabase[username] || { rank: 'M', fullRank: 'Member', style: 'member-style' };
    
    // Set window title
    document.getElementById('pw_title').textContent = 'ğŸ‘¤ ' + username + "'s Profile";
    
    // Set basic info
    document.getElementById('pw_name').textContent = username;
    document.getElementById('pw_name').className = userData.style || 'member-style';
    document.getElementById('pw_rank').textContent = userData.fullRank || 'Member';
    document.getElementById('pw_user_id').textContent = 'User ID: ' + generateUserId(username);
    
    // Get profile from real-time cache
    const profile = getProfile(username);
    
    // Set profile data
    document.getElementById('pw_status').textContent = profile.status || '';
    document.getElementById('pw_mood').textContent = profile.mood || '';
    document.getElementById('pw_bio').textContent = profile.bio || 'No bio set.';
    
    // Set avatar
    const avatarEl = document.getElementById('pw_avatar');
    if (profile.avatar) {
        avatarEl.innerHTML = '<img src="' + escapeHtml(profile.avatar) + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ğŸ¦‡\'">';
    } else {
        avatarEl.innerHTML = 'ğŸ¦‡';
    }
    
    // Load reputation
    db.ref('reputation/' + username).once('value', (s) => { 
        const rep = s.val() || { score: 0 }; 
        document.getElementById('pw_rep').textContent = rep.score || 0; 
    });
    
    // Load comments
    db.ref('profile_comments/' + username).orderByChild('timestamp').limitToLast(20).once('value', (s) => {
        const comments = []; 
        s.forEach(c => comments.push(c.val()));
        document.getElementById('pw_comments_count').textContent = comments.length;
        
        const cl = document.getElementById('pw_comments_list');
        if (comments.length === 0) {
            cl.innerHTML = '<div style="color:#555; font-size:11px; text-align:center; padding:10px;">No comments yet. Be the first!</div>';
        } else {
            cl.innerHTML = comments.reverse().map(c => `
                <div style="background:#0a0000; padding:10px; margin-bottom:8px; border-left:3px solid #500; border-radius:0 4px 4px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span style="color:#d40000; font-weight:bold; font-size:11px;">${escapeHtml(c.from)}</span>
                        <span style="color:#444; font-size:9px;">${c.date || ''}</span>
                    </div>
                    <div style="color:#aaa; font-size:11px; line-height:1.4;">${escapeHtml(c.text)}</div>
                </div>
            `).join('');
        }
    });
    
    // Music player
    const musicSection = document.getElementById('pw_music_section');
    const musicPlayer = document.getElementById('pw_music_player');
    if (profile.music) {
        musicSection.style.display = 'block';
        if (profile.music.includes('soundcloud.com')) {
            musicPlayer.innerHTML = '<iframe width="100%" height="100" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=' + encodeURIComponent(profile.music) + '&color=%23ff0000&auto_play=false&hide_related=true&show_comments=false&show_user=true"></iframe>';
        } else if (profile.music.includes('spotify.com')) { 
            const m = profile.music.match(/track\/([a-zA-Z0-9]+)/); 
            if (m) {
                musicPlayer.innerHTML = '<iframe src="https://open.spotify.com/embed/track/' + m[1] + '" width="100%" height="80" frameborder="0" allow="encrypted-media"></iframe>';
            } else {
                musicPlayer.innerHTML = '<div style="color:#666; font-size:10px;">Invalid Spotify URL</div>';
            }
        } else {
            musicPlayer.innerHTML = '<div style="color:#666; font-size:10px;">ğŸ”— <a href="' + escapeHtml(profile.music) + '" target="_blank" style="color:#d40000;">' + escapeHtml(profile.music) + '</a></div>';
        }
    } else { 
        musicSection.style.display = 'none'; 
        musicPlayer.innerHTML = ''; 
    }
    
    // Rep buttons - only for logged in users viewing other profiles
    const canRep = CURRENT_USER && !IS_GUEST && username !== CURRENT_USER;
    document.getElementById('pw_btn_rep_pos').style.display = canRep ? 'block' : 'none';
    document.getElementById('pw_btn_rep_neg').style.display = canRep ? 'block' : 'none';
    
    // Comment form - only for logged in users
    document.getElementById('pw_comment_form').style.display = (CURRENT_USER && !IS_GUEST) ? 'block' : 'none';
    
    // Show window
    win.style.display = 'block';
    document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10");
    win.style.zIndex = "500";
    
    // Make draggable
    makeDraggable('profile_window');
}

function closeProfileWindow() { 
    document.getElementById('profile_window').style.display = 'none'; 
    document.getElementById('pw_music_player').innerHTML = ''; 
}

document.addEventListener('click', (e) => {
    const win = document.getElementById('profile_window');
    if (win.style.display === 'block' && !e.target.closest('#profile_window') && !e.target.closest('.chat-username') && !e.target.closest('.member-item')) {
        // Don't auto-close profile window on click outside - users should use X button
    }
});

function giveRep(amount) {
    if (!CURRENT_USER || IS_GUEST || currentProfileUser === CURRENT_USER) return;
    db.ref('reputation/' + currentProfileUser).once('value', (s) => {
        const current = s.val() || { score: 0, givers: {} };
        if (current.givers && current.givers[CURRENT_USER]) { alert('You already gave rep to this user!'); return; }
        current.score = (current.score || 0) + amount;
        current.givers = current.givers || {};
        current.givers[CURRENT_USER] = amount;
        db.ref('reputation/' + currentProfileUser).set(current);
        document.getElementById('pw_rep').textContent = current.score;
        alert(amount > 0 ? '+1 Rep given!' : '-1 Rep given!');
    });
}

function leaveProfileComment() {
    if (!CURRENT_USER || IS_GUEST) { alert('Must be logged in!'); return; }
    const text = document.getElementById('pw_comment_input').value.trim();
    if (!text) { alert('Please enter a comment.'); return; }
    if (text.length > 200) { alert('Comment too long (max 200 characters).'); return; }
    
    db.ref('profile_comments/' + currentProfileUser).push({ 
        from: CURRENT_USER, 
        text: text, 
        date: new Date().toLocaleDateString(), 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    }).then(() => {
        document.getElementById('pw_comment_input').value = '';
        // Refresh profile to show new comment
        openProfileWindow(currentProfileUser);
    });
}

function openDM(username) {
    if (!username || username === CURRENT_USER || IS_GUEST) return;
    closeProfileWindow();
    alert('DM feature coming soon! For now, mention @' + username + ' in chat.');
}

// CHAT SYSTEM
function switchChatTab(tab, el) {
    document.querySelectorAll('#chat_win .tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('chat_main').style.display = tab === 'main' ? 'block' : 'none';
    document.getElementById('chat_avatar').style.display = tab === 'avatar' ? 'block' : 'none';
    if (tab === 'avatar') loadAvatarTab();
}

function loadAvatarTab() {
    if (!CURRENT_USER) return;
    const user = userDatabase[CURRENT_USER];
    document.getElementById('my_username_display').textContent = CURRENT_USER;
    document.getElementById('my_rank_display').textContent = user ? user.fullRank : 'Member';
    const profile = getProfile(CURRENT_USER);
    const avatarDisplay = document.getElementById('my_avatar_display');
    if (profile.avatar) avatarDisplay.innerHTML = '<img src="' + profile.avatar + '" style="width:100%; height:100%; object-fit:cover;">';
    else avatarDisplay.innerHTML = 'ğŸ¦‡';
    document.getElementById('avatar_url').value = profile.avatar || '';
    document.getElementById('profile_music').value = profile.music || '';
    document.getElementById('user_status').value = profile.status || '';
    document.getElementById('user_bio').value = profile.bio || '';
    if (profile.mood) document.getElementById('user_mood').value = profile.mood;
}

function handleTyping() { if (IS_GUEST || !CURRENT_USER) return; db.ref('typing').set({ user: CURRENT_USER, time: Date.now() }); }
function checkTyping() {
    db.ref('typing').once('value', (s) => {
        const typing = s.val();
        const area = document.getElementById('typing_area');
        if (typing && typing.user && typing.user !== CURRENT_USER && (Date.now() - typing.time) < 2000) { document.getElementById('typing_user').textContent = typing.user; area.style.display = 'block'; }
        else area.style.display = 'none';
    });
}
setInterval(checkTyping, 500);
function handleChatKey(event) { if (event.key === 'Enter') sendChat(); }

const chatCommands = {
    '/help': () => ({ type: 'system', text: 'Commands: /me, /shrug, /tableflip, /blood, /bat, /bite' }),
    '/me': (args) => ({ type: 'action', text: CURRENT_USER + ' ' + args }),
    '/shrug': () => ({ type: 'action', text: CURRENT_USER + ' Â¯\\_(ãƒ„)_/Â¯' }),
    '/tableflip': () => ({ type: 'action', text: CURRENT_USER + ' (â•¯Â°â–¡Â°)â•¯ï¸µ â”»â”â”»' }),
    '/blood': () => ({ type: 'action', text: CURRENT_USER + ' ğŸ©¸ğŸ©¸ğŸ©¸' }),
    '/bat': () => ({ type: 'action', text: CURRENT_USER + ' ğŸ¦‡ *flaps away*' }),
    '/bite': (args) => ({ type: 'action', text: CURRENT_USER + ' ğŸ§› *bites ' + (args || 'the air') + '*' }),
};
const botResponses = [
    { trigger: /hello|hi|hey/i, response: "Greetings, mortal. ğŸ¦‡" },
    { trigger: /vampire|vamp/i, response: "Did someone say vampire? *fangs glisten*" },
    { trigger: /blood/i, response: "The crimson elixir... ğŸ©¸" },
    { trigger: /sun|daylight/i, response: "We don't speak of the burning orb. â˜€ï¸ğŸš«" },
    { trigger: /garlic/i, response: "*hisses* Forbidden! ğŸ§„âŒ" },
];

function sendChat() {
    if (IS_GUEST || !CURRENT_USER) return;
    const input = document.getElementById('chat_input');
    const text = input.value.trim();
    if(!text) return;
    
    // Get user data with fallbacks
    const u = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style', fullRank: 'Member' };
    const userRank = u.rank || 'M';
    const userStyle = u.style || 'member-style';
    const timeNow = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const cmdMatch = text.match(/^(\/\w+)\s*(.*)?$/);
    if (cmdMatch && chatCommands[cmdMatch[1]]) {
        const result = chatCommands[cmdMatch[1]](cmdMatch[2] || '');
        if (result.type === 'system') { 
            input.value = ''; 
            const logs = document.getElementById('chat_logs'); 
            logs.innerHTML += '<div style="color:#666; font-size:9px; font-style:italic; padding:4px;">' + result.text + '</div>'; 
            logs.scrollTop = logs.scrollHeight; 
            return; 
        } else { 
            db.ref('chat').push({ 
                user: CURRENT_USER, 
                text: result.text, 
                isAction: true, 
                tag: userRank, 
                style: userStyle, 
                time: timeNow, 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            }); 
        }
    } else {
        db.ref('chat').push({ 
            user: CURRENT_USER, 
            text: text, 
            tag: userRank, 
            style: userStyle, 
            time: timeNow, 
            timestamp: firebase.database.ServerValue.TIMESTAMP 
        });
        for (const br of botResponses) {
            if (br.trigger.test(text)) {
                setTimeout(() => { 
                    db.ref('chat').push({ 
                        user: 'Eric Northman', 
                        text: br.response, 
                        tag: 'BOT', 
                        style: 'bot-style', 
                        isBot: true, 
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), 
                        timestamp: firebase.database.ServerValue.TIMESTAMP 
                    }); 
                }, 1000 + Math.random() * 1000);
                break;
            }
        }
    }
    input.value = "";
}

let chatListenerSet = false;
function setupChatListener() {
    if (chatListenerSet) return;
    chatListenerSet = true;
    db.ref('chat').orderByChild('timestamp').limitToLast(100).on('value', (s) => {
        const logs = document.getElementById('chat_logs'); if (!logs) return;
        const msgs = []; s.forEach((c) => msgs.push(c.val()));
        db.ref('pinned').once('value', (ps) => {
            const pinned = ps.val();
            const pc = document.getElementById('pinned_container');
            if (pc) pc.innerHTML = pinned ? '<div class="pinned-msg"><span style="color:#ffd700; font-size:8px;">ğŸ“Œ PINNED</span><br>' + escapeHtml(pinned) + '</div>' : '';
        });
        logs.innerHTML = msgs.map(m => {
            if (m.isAction) return '<div class="chat-action" style="padding:4px 0; font-size:11px;">* ' + escapeHtml(m.text) + '</div>';
            const botClass = m.isBot ? ' chat-bot' : '';
            
            // Handle different media types
            let mediaHtml = '';
            if (m.imageData) {
                mediaHtml = '<img class="chat-image" src="' + m.imageData + '">';
            } else if (m.mediaUrl) {
                if (m.mediaType === 'image') {
                    mediaHtml = '<img class="chat-image" src="' + m.mediaUrl + '" style="max-width:250px; max-height:200px; border:1px solid #400; margin-top:4px; border-radius:4px; cursor:pointer;" onclick="window.open(\'' + m.mediaUrl + '\')">';
                } else if (m.mediaType === 'video') {
                    mediaHtml = '<video src="' + m.mediaUrl + '" controls style="max-width:280px; max-height:200px; border:1px solid #400; margin-top:4px; border-radius:4px;"></video>';
                } else if (m.mediaType === 'audio') {
                    mediaHtml = '<audio src="' + m.mediaUrl + '" controls style="width:250px; margin-top:4px;"></audio>';
                }
            }
            
            return `<div class="chat-entry${botClass}"><div class="chat-header"><span class="rank-tag ${m.style}">${m.tag}</span><span class="chat-username ${m.style}" onclick="showProfileCard('${escapeHtml(m.user)}', event)">${escapeHtml(m.user)}</span><span style="color:#444; font-size:8px; margin-left:auto;">${m.time || ''}</span></div><div style="color:#ccc; font-size:11px; padding-left:30px;">${escapeHtml(m.text)}${mediaHtml}</div></div>`;
        }).join('');
        logs.scrollTop = logs.scrollHeight;
    });
}
function loadMessages() { setupChatListener(); }
function uploadChatFile() {
    if (IS_GUEST || !CURRENT_USER) { alert('Must be logged in!'); return; }
    const fileInput = document.getElementById('chat_file');
    const file = fileInput.files[0]; 
    if (!file) return;
    
    const fileType = file.type;
    const isImage = fileType.startsWith('image/');
    const isVideo = fileType.startsWith('video/');
    const isAudio = fileType.startsWith('audio/');
    
    // Upload to Cloudinary for direct embedding
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);
    
    // Show uploading status
    alert('Uploading file...');
    
    const resourceType = isVideo ? 'video' : isAudio ? 'video' : 'image';
    
    fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`, { 
        method: 'POST', 
        body: formData 
    })
    .then(res => res.json())
    .then(data => {
        if (data.secure_url) {
            const u = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style' };
            const timeNow = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let mediaType = 'image';
            if (isVideo) mediaType = 'video';
            if (isAudio) mediaType = 'audio';
            
            db.ref('chat').push({ 
                user: CURRENT_USER, 
                text: '[' + mediaType.charAt(0).toUpperCase() + mediaType.slice(1) + ']',
                mediaUrl: data.secure_url,
                mediaType: mediaType,
                tag: u.rank || 'M', 
                style: u.style || 'member-style', 
                time: timeNow, 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            });
        } else {
            alert('Upload failed. Try again.');
        }
    })
    .catch(err => {
        console.error(err);
        alert('Upload failed.');
    });
    
    fileInput.value = '';
}

// ADMIN PANEL - Tab Switching
function switchAdminTab(tab, el) {
    document.querySelectorAll('.mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    ['apps', 'members', 'images', 'moderation', 'announcements', 'bot', 'videos', 'vip', 'st'].forEach(t => {
        const panel = document.getElementById('admin_tab_' + t);
        if (panel) panel.style.display = t === tab ? 'block' : 'none';
    });
    // Load data for tab
    if (tab === 'apps') loadAllApplications();
    if (tab === 'members') loadAllMembers();
    if (tab === 'images') loadPendingImages();
    if (tab === 'moderation') loadBannedUsers();
    if (tab === 'videos') loadAllVideos();
    if (tab === 'vip') loadAllVIPCodes();
}

// ADMIN FUNCTIONS
function sendBotMessage() { 
    const text = document.getElementById('bot_message').value.trim(); 
    if (!text) return; 
    db.ref('chat').push({ user: 'Eric Northman', text: text, tag: 'BOT', style: 'bot-style', isBot: true, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP }); 
    document.getElementById('bot_message').value = ''; 
}
function pinMessage() { const text = document.getElementById('pin_message').value.trim(); if (!text) return; db.ref('pinned').set(text); document.getElementById('pin_message').value = ''; alert('Message pinned!'); }
function clearPin() { db.ref('pinned').remove(); alert('Pin cleared!'); }
function clearChat() { if (confirm('Clear ALL chat?')) db.ref('chat').remove(); }
function exportChat() {
    db.ref('chat').orderByChild('timestamp').once('value', (s) => {
        const msgs = []; s.forEach(c => msgs.push(c.val()));
        const text = msgs.map(m => '[' + (m.time || '') + '] ' + m.user + ': ' + m.text).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'fangtasia-chat-' + new Date().toISOString().split('T')[0] + '.txt';
        a.click();
    });
}

function loadAllApplications() {
    const container = document.getElementById('all_applications'); if (!container) return;
    const filter = document.getElementById('app_filter')?.value || 'all';
    const search = document.getElementById('app_search')?.value.toLowerCase() || '';
    
    db.ref('applications').orderByChild('timestamp').once('value', (s) => {
        const apps = []; s.forEach(c => apps.push({ ...c.val(), key: c.key }));
        let filtered = apps.reverse();
        if (filter !== 'all') filtered = filtered.filter(a => a.status === filter);
        if (search) filtered = filtered.filter(a => a.username.toLowerCase().includes(search));
        
        if (filtered.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No applications found.</div>'; return; }
        
        container.innerHTML = filtered.map(a => {
            const statusColor = { pending: '#ffd700', approved: '#00ff00', denied: '#ff4444' }[a.status] || '#888';
            return `<div style="background:#0a0000; border:1px solid #400; padding:12px; margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><strong style="color:#d40000;">${escapeHtml(a.username)}</strong><span style="color:${statusColor}; font-size:10px;">${a.status?.toUpperCase()}</span></div>
                <div style="color:#888; font-size:10px;"><div>Date: ${a.date}</div><div>Referral: ${escapeHtml(a.referral || 'None')}</div><div>Reason: ${escapeHtml(a.reason)}</div></div>
                ${a.status === 'pending' ? `<div style="display:flex; gap:8px; margin-top:8px;"><button class="ie-btn" style="padding:6px; font-size:10px; background:#050; flex:1;" onclick="approveApp('${a.key}')">âœ“ Approve</button><button class="ie-btn" style="padding:6px; font-size:10px; background:#500; flex:1;" onclick="denyApp('${a.key}')">âœ— Deny</button></div>` : ''}
            </div>`;
        }).join('');
    });
}

function approveApp(key) { db.ref('applications/' + key).update({ status: 'approved' }); loadAllApplications(); }
function denyApp(key) { db.ref('applications/' + key).update({ status: 'denied' }); loadAllApplications(); }

function loadAllMembers() {
    const container = document.getElementById('all_members'); if (!container) return;
    
    const members = [];
    Object.keys(userDatabase).forEach(name => {
        if (!coreAdmins[name]) members.push({ username: name, ...userDatabase[name] });
    });
    Object.keys(coreAdmins).forEach(name => members.push({ username: name, ...coreAdmins[name], isCore: true }));
    
    container.innerHTML = members.map(m => `
        <div style="background:#0a0000; border:1px solid #400; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
            <div><span class="${m.style}" style="font-weight:bold;">${escapeHtml(m.username)}</span><span style="color:#666; font-size:10px;"> [${m.fullRank}]</span></div>
            <span style="color:#555; font-size:9px;">ID: ${generateUserId(m.username)}</span>
        </div>
    `).join('');
}

function loadPendingImages() {
    const container = document.getElementById('pending_images'); if (!container) return;
    db.ref('pending_images').once('value', (s) => {
        const pending = []; s.forEach((c) => pending.push({ ...c.val(), key: c.key }));
        if (pending.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center; grid-column:1/-1;">No pending images</div>'; return; }
        container.innerHTML = pending.map(p => `<div style="background:#0a0000; border:1px solid #400; padding:8px; text-align:center;">
            <img src="${p.data}" style="max-width:100%; max-height:80px; margin-bottom:5px;">
            <div style="color:#d40000; font-size:10px;">${escapeHtml(p.user)}</div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="ie-btn" style="padding:4px; font-size:9px; flex:1;" onclick="approveImage('${p.key}')">âœ“</button>
                <button class="ie-btn" style="padding:4px; font-size:9px; flex:1; background:#333;" onclick="denyImage('${p.key}')">âœ—</button>
            </div>
        </div>`).join('');
    });
}
function approveImage(key) {
    db.ref('pending_images/' + key).once('value', (s) => {
        const img = s.val(); if (!img) return;
        const u = userDatabase[img.user] || { rank: 'M', style: 'member-style' };
        db.ref('chat').push({ user: img.user, text: '[Image]', imageData: img.data, tag: u.rank, style: u.style, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP });
        db.ref('pending_images/' + key).remove();
        loadPendingImages();
    });
}
function denyImage(key) { db.ref('pending_images/' + key).remove(); loadPendingImages(); }

function loadBannedUsers() {
    const container = document.getElementById('banned_users'); if (!container) return;
    db.ref('bans').once('value', (s) => {
        const bans = s.val() || {};
        const now = Date.now();
        const activeBans = Object.entries(bans).filter(([u, b]) => b.expiry === 0 || b.expiry > now);
        if (activeBans.length === 0) { container.innerHTML = 'None'; return; }
        container.innerHTML = activeBans.map(([user, ban]) => {
            const exp = ban.expiry === 0 ? 'Permanent' : new Date(ban.expiry).toLocaleString();
            return `<div style="border-bottom:1px solid #333; padding:5px 0;"><strong style="color:#ff4444;">${escapeHtml(user)}</strong> [${ban.type}] - ${exp} <button class="ie-btn" style="padding:2px 6px; font-size:8px; width:auto;" onclick="unbanUser('${user}')">Unban</button></div>`;
        }).join('');
    });
}
function unbanUser(username) { db.ref('bans/' + username).remove(); loadBannedUsers(); alert(username + ' unbanned.'); }

function executeModAction() {
    const username = document.getElementById('mod_username').value.trim();
    const action = document.getElementById('mod_action').value;
    const duration = parseInt(document.getElementById('mod_duration').value);
    const reason = document.getElementById('mod_reason').value;
    if (!username || !action) { document.getElementById('mod_result').innerHTML = '<span style="color:#f00;">Select user and action.</span>'; return; }
    const protectedAdmins = ['losersyndicate', 'noseeyedear', 'oleg'];
    if (protectedAdmins.includes(username.toLowerCase())) { document.getElementById('mod_result').innerHTML = '<span style="color:#f00;">Cannot moderate core admins.</span>'; return; }
    const expiry = duration === 0 ? 0 : Date.now() + (duration * 60 * 1000);
    if (action === 'kick') { db.ref('online/' + username).remove(); document.getElementById('mod_result').innerHTML = '<span style="color:#0f0;">' + username + ' kicked.</span>'; }
    else { db.ref('bans/' + username).set({ type: action, expiry: expiry, reason: reason, by: CURRENT_USER }); if (action === 'hardban') { db.ref('members/' + username).remove(); } document.getElementById('mod_result').innerHTML = '<span style="color:#0f0;">' + username + ' ' + action + '.</span>'; loadBannedUsers(); }
}

function loadAllVideos() {
    const container = document.getElementById('all_videos'); if (!container) return;
    db.ref('archive').once('value', (s) => {
        const videos = []; s.forEach(c => videos.push({ ...c.val(), key: c.key }));
        if (videos.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center;">No videos.</div>'; return; }
        container.innerHTML = videos.reverse().map(v => `
            <div style="background:#0a0000; border:1px solid #400; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                <div><strong style="color:#d40000;">${escapeHtml(v.name)}</strong><span style="color:#666; font-size:10px;"> by ${escapeHtml(v.uploader)}</span></div>
                <div><button class="ie-btn" style="padding:4px 10px; font-size:10px; width:auto; margin-right:5px;" onclick="window.open('${v.url}')">View</button><button class="ie-btn" style="padding:4px 10px; font-size:10px; width:auto; background:#500;" onclick="deleteVideo('${v.key}')">Delete</button></div>
            </div>
        `).join('');
    });
}
function deleteVideo(key) { if (confirm('Delete this video?')) { db.ref('archive/' + key).remove(); loadAllVideos(); } }

function generateVIPCode() {
    const code = 'VIP-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    db.ref('vip_codes').push({ code: code, created: Date.now(), createdBy: CURRENT_USER, used: false });
    document.getElementById('vip_code_display').textContent = 'âœ¨ ' + code;
    loadAllVIPCodes();
}
function loadAllVIPCodes() {
    const container = document.getElementById('all_vip_codes'); if (!container) return;
    db.ref('vip_codes').once('value', (s) => {
        const codes = []; s.forEach(c => codes.push({ ...c.val(), key: c.key }));
        if (codes.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center;">No codes generated yet.</div>'; return; }
        container.innerHTML = codes.reverse().map(c => `
            <div style="background:#0a0000; border:1px solid ${c.used ? '#333' : '#ffd700'}; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                <span style="color:${c.used ? '#666' : '#ffd700'}; font-family:monospace; font-size:14px;">${c.code}</span>
                <span style="color:#555; font-size:9px;">${c.used ? 'Used by ' + c.usedBy : 'Available'}</span>
            </div>
        `).join('');
    });
}

function elevateUser() {
    if (!userDatabase[CURRENT_USER]?.isST) { alert('Access denied.'); return; }
    const username = document.getElementById('elevate_user').value.trim();
    const newRank = document.getElementById('elevate_rank').value;
    if (!username || !userDatabase[username]) { alert('User not found.'); return; }
    
    const rankConfig = { 
        'member': { rank: 'M', fullRank: 'Member', style: 'member-style', target: 'list_member', isAdmin: false }, 
        'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style', target: 'list_vip', isAdmin: false }, 
        'contrib': { rank: 'CONTRIB', fullRank: 'Contributor', style: 'contrib-style', target: 'list_contrib', isAdmin: false },
        'mod': { rank: 'MOD', fullRank: 'Moderator', style: 'mod-style', target: 'list_mod', isAdmin: true }, 
        'admin': { rank: 'A', fullRank: 'Admin', style: 'a-style', target: 'list_admin', isAdmin: true } 
    };
    
    db.ref('members/' + username).update(rankConfig[newRank]);
    userDatabase[username] = { ...userDatabase[username], ...rankConfig[newRank] };
    alert(username + ' elevated to ' + rankConfig[newRank].fullRank);
}

function uploadVIPImage() {
    const user = userDatabase[CURRENT_USER]; 
    if (!user || !(user.rank === 'VIP' || user.rank === 'CONTRIB' || user.isAdmin || user.isST)) { alert('VIP+ only.'); return; }
    const file = document.getElementById('vip_image_picker').files[0]; if (!file) { alert('Select image.'); return; }
    document.getElementById('vip_image_result').innerHTML = '<div style="color:#888; font-size:10px;">Uploading...</div>';
    const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', UPLOAD_PRESET);
    fetch('https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/image/upload', { method: 'POST', body: formData })
        .then(res => res.json()).then(data => {
            if (data.secure_url) { document.getElementById('vip_image_result').innerHTML = `<div style="background:#0a0a00; border:1px solid #ffd700; padding:10px;"><div style="color:#0f0; font-size:10px;">âœ“ Uploaded!</div><input type="text" value="${data.secure_url}" style="width:100%; font-size:10px; background:#000; border:1px solid #ffd700; color:#ffd700; padding:6px;" onclick="this.select();" readonly></div>`; }
            else document.getElementById('vip_image_result').innerHTML = '<div style="color:#f00; font-size:10px;">Failed.</div>';
        });
}

// MEMORIES / VIDEO ARCHIVE
function prevPage() { if (currentPage > 1) { currentPage--; renderMemories(); } }
function nextPage() { db.ref('archive').once('value', (s) => { let count = 0; s.forEach(() => count++); const totalPages = Math.ceil(count / itemsPerPage) || 1; if (currentPage < totalPages) { currentPage++; renderMemories(); } }); }
function renderMemories() {
    const grid = document.getElementById('memories_grid'); 
    if (!grid) return;
    grid.innerHTML = "";
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
    grid.style.gap = '20px';
    grid.style.justifyItems = 'center';
    
    db.ref('archive').orderByChild('timestamp').once('value', (s) => {
        const archive = []; s.forEach((c) => archive.push(c.val()));
        const totalPages = Math.ceil(archive.length / itemsPerPage) || 1;
        document.getElementById('page_indicator').textContent = 'Page ' + currentPage + ' of ' + totalPages;
        
        if (archive.length === 0) { 
            grid.innerHTML = '<p style="color: #555; text-align: center; grid-column: 1/-1; padding: 40px;">No memories yet...</p>'; 
            return; 
        }
        
        const start = (currentPage - 1) * itemsPerPage;
        const pageItems = archive.slice(start, start + itemsPerPage);
        
        pageItems.forEach(mem => {
            const div = document.createElement('div');
            div.style.cssText = 'width:120px; text-align:center; cursor:pointer; padding:10px; border-radius:5px; transition:all 0.2s;';
            div.onmouseover = function() { this.style.background = 'rgba(139,0,0,0.2)'; };
            div.onmouseout = function() { this.style.background = 'transparent'; };
            div.onclick = function() { spawnVideoWindow(mem.name, mem.url); };
            div.innerHTML = `
                <div style="width:60px; height:60px; margin:0 auto 8px; background:#1a0000; border:2px solid #500; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:28px;">ğŸ¬</div>
                <div style="font-size:11px; color:#d40000; font-weight:bold; word-break:break-word;">${escapeHtml(mem.name)}</div>
                <div style="font-size:9px; color:#666; margin-top:2px;">${escapeHtml(mem.uploader || 'Unknown')}</div>
            `;
            grid.appendChild(div);
        });
    });
}
function spawnVideoWindow(name, url) {
    const id = 'v_' + Date.now();
    const win = document.createElement('div');
    win.className = 'window'; win.id = id; win.style.display = 'block';
    win.style.left = (150 + Math.random() * 100) + 'px'; win.style.top = (100 + Math.random() * 50) + 'px'; win.style.width = '520px'; win.style.height = '420px'; win.style.zIndex = '500';
    
    // Determine if video or audio based on URL
    const isAudio = url.match(/\.(mp3|wav|ogg|m4a)(\?|$)/i);
    
    let mediaHtml;
    if (isAudio) {
        mediaHtml = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; background:#0a0000;"><div style="font-size:60px; margin-bottom:20px;">ğŸµ</div><audio src="${url}" controls autoplay style="width:90%;"></audio></div>`;
    } else {
        mediaHtml = `<video src="${url}" controls autoplay style="width:100%; height:100%; background:#000;"></video>`;
    }
    
    win.innerHTML = `<div class="title-bar"><div class="title-bar-text">â–¶ ${escapeHtml(name)}</div><div class="title-bar-controls"><button aria-label="Close" onclick="document.getElementById('${id}').remove()"></button></div></div><div class="window-body" style="height:calc(100% - 32px); overflow:hidden;">${mediaHtml}</div>`;
    document.body.appendChild(win);
    makeDraggable(id);
}
async function processIEUpload() {
    const fileInput = document.getElementById('ie_file_picker');
    const name = document.getElementById('ie_filename').value.trim() || "Video_" + Date.now();
    if(!fileInput.files[0]) { alert('Please select a file.'); return; }
    if(!CURRENT_USER) { alert('Please log in first.'); return; }
    
    document.getElementById('upload_status').innerText = "Uploading...";
    document.getElementById('upload_status').disabled = true;
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('upload_preset', UPLOAD_PRESET);
    
    try {
        const res = await fetch('https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/auto/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (res.ok && data.secure_url) { 
            await db.ref('archive').push({ 
                name: name, 
                url: data.secure_url, 
                uploader: CURRENT_USER, 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            }); 
            renderMemories(); 
            document.getElementById('upload_status').innerText = "Push to Cloud"; 
            document.getElementById('ie_filename').value = ""; 
            fileInput.value = "";
            alert('Memory uploaded successfully!');
        } else {
            alert('Upload failed: ' + (data.error?.message || 'Unknown error'));
            document.getElementById('upload_status').innerText = "Push to Cloud";
        }
    } catch (e) { 
        console.error(e);
        alert("Upload error. Please try again."); 
        document.getElementById('upload_status').innerText = "Push to Cloud";
    }
    document.getElementById('upload_status').disabled = false;
}

// WINDOW MANAGEMENT - Draggable ANYWHERE on screen
function toggleWin(id) {
    let el = document.getElementById(id); if (!el) return;
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
    if(el.style.display === 'block') { document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); el.style.zIndex = "200"; }
    if (id === 'admin_window') { loadAllApplications(); }
}

function makeDraggable(winId) {
    const win = document.getElementById(winId); if (!win) return;
    const header = win.querySelector('.title-bar'); if (!header) return;
    
    // Mouse drag - works ANYWHERE on screen
    header.onmousedown = (e) => {
        e.preventDefault();
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); 
        win.style.zIndex = "400";
        let startX = e.clientX, startY = e.clientY;
        let startLeft = win.offsetLeft, startTop = win.offsetTop;
        
        document.onmousemove = (e) => { 
            const newLeft = startLeft + (e.clientX - startX);
            const newTop = startTop + (e.clientY - startY);
            win.style.left = newLeft + 'px'; 
            win.style.top = newTop + 'px'; 
        };
        document.onmouseup = () => { document.onmousemove = null; document.onmouseup = null; };
    };
    
    // Touch drag for mobile - works ANYWHERE
    header.ontouchstart = (e) => {
        const touch = e.touches[0];
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); 
        win.style.zIndex = "400";
        let startX = touch.clientX, startY = touch.clientY;
        let startLeft = win.offsetLeft, startTop = win.offsetTop;
        
        document.ontouchmove = (e) => { 
            const t = e.touches[0]; 
            const newLeft = startLeft + (t.clientX - startX);
            const newTop = startTop + (t.clientY - startY);
            win.style.left = newLeft + 'px'; 
            win.style.top = newTop + 'px'; 
        };
        document.ontouchend = () => { document.ontouchmove = null; document.ontouchend = null; };
    };
}

// Make all windows draggable
['ie_window', 'memories_folder', 'chat_win', 'about_window', 'games_window', 'apply_window', 'admin_window', 'profile_window'].forEach(id => makeDraggable(id));

// *** CRITICAL FIX: beginSession must be globally accessible ***
window.beginSession = function() {
    document.getElementById('boot-screen').style.display = 'none';
    if(player) { player.unMute(); player.playVideo(); }
};

// YouTube Background Music
var player;
window.onYouTubeIframeAPIReady = function() {
    player = new YT.Player('player', {
        videoId: 'Bi5kyehmeaY',
        playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'Bi5kyehmeaY', 'controls': 0 },
        events: { 'onReady': (e) => e.target.mute() }
    });
};
function pauseMusic() { if(player) player.pauseVideo(); }
function playMusic() { if(player) player.playVideo(); }

// Initialize
window.addEventListener('load', () => {
    renderMemories();
    updateVisitorCount();
    updateClock();
    initStakesGame();
    updateOnlineMemberList();
});
</script>
</body>
</html>
