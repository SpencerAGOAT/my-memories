<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>fangtasia.wtf</title>
    <!-- Anti-DevTools Protection -->
    <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest" onerror="console.log('disable-devtool failed to load')"></script>
    <script>
        try {
            if (typeof DisableDevtool !== 'undefined') {
                DisableDevtool({
                    ondevtoolopen: function(type) {
                        document.body.innerHTML = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;color:#f00;display:flex;justify-content:center;align-items:center;font-family:monospace;font-size:24px;text-align:center;z-index:999999;"><div>‚õî ACCESS DENIED ‚õî<br><br><span style="font-size:14px;color:#666;">Developer tools are not allowed.</span></div></div>';
                    },
                    clearIntervalWhenDevOpenTrigger: true,
                    url: null,
                    disableMenu: false,
                    clearLog: true,
                    disableSelect: false,
                    disableCopy: false,
                    disableCut: false
                });
            }
        } catch(e) { console.log('DisableDevtool error:', e); }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/bahram" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/7.css">
    <style>
        :root { --vamp-red: #8b0000; --glass: rgba(15, 0, 0, 0.9); --neon-pink: #ff00ff; }
        .bat-cursor { position: fixed; width: 32px; height: 32px; pointer-events: none; z-index: 99999; transform: translate(-50%, -50%); }
        .bat-cursor svg { width: 100%; height: 100%; filter: drop-shadow(0 0 3px rgba(139, 0, 0, 0.8)); }
        .bat-cursor .wing-left, .bat-cursor .wing-right { transform-origin: center; animation: flapWings 0.15s ease-in-out infinite alternate; }
        .bat-cursor .wing-right { animation-delay: 0.075s; }
        @keyframes flapWings { 0% { transform: scaleX(1) rotate(0deg); } 100% { transform: scaleX(0.85) rotate(-8deg); } }
        * { cursor: none !important; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: black; overflow: hidden; }
        body { background: radial-gradient(ellipse at center, #1a0a0a 0%, #0d0000 40%, #000000 100%); background-size: cover; background-position: center; font-family: "Segoe UI", Tahoma, sans-serif; }
        body::before { content: ''; position: fixed; inset: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="80" fill="rgba(139,0,0,0.03)">ü¶á</text></svg>') repeat; background-size: 80px; pointer-events: none; z-index: 0; }
        #boot-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #d40000; }
        .boot-title { font-size: 60px; animation: bloodPulse 2s ease-in-out infinite; text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); }
        @keyframes bloodPulse { 0%, 100% { text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); } 50% { text-shadow: 0 0 30px rgba(212, 0, 0, 0.8), 0 0 60px rgba(212, 0, 0, 0.5); } }
        .boot-subtitle { animation: flicker 3s infinite; margin-top: 20px; }
        @keyframes flicker { 0%, 100% { opacity: 1; } 93% { opacity: 0.3; } 94% { opacity: 1; } 96% { opacity: 0.5; } }
        @keyframes batFloat { 0%, 100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-15px) rotate(5deg); } }
        /* SoundCloud Dark Mode */
        iframe[src*="soundcloud"] { filter: invert(0.85) hue-rotate(180deg) contrast(1.1); border-radius: 8px; }
        #desktop { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; padding: 25px; height: calc(100vh - 40px); gap: 20px; position: relative; z-index: 1; }
        .icon { width: 110px; text-align: center; color: white; text-shadow: 1px 1px 3px black; font-size: 11px; z-index: 5; margin-bottom: 15px; transition: transform 0.2s, filter 0.2s; }
        .icon:hover { transform: scale(1.1); filter: brightness(1.2); }
        .icon img.folder-icon { width: 44px; display: block; margin: 0 auto 6px; filter: grayscale(0.3) sepia(1) saturate(35) hue-rotate(320deg) brightness(0.55) contrast(1.5); }
        .window { position: fixed; background: #0d0d0d !important; border: 1px solid #700000 !important; box-shadow: 0 15px 40px rgba(0,0,0,1), 0 0 30px rgba(139, 0, 0, 0.2); display: none; z-index: 10; overflow: hidden; resize: both; min-width: 200px; min-height: 150px; }
        .title-bar { background: linear-gradient(to bottom, #8b0000, #2a0000) !important; user-select: none; }
        .window-body { height: calc(100% - 32px); padding: 0; background: black; overflow: auto; }
        .chat-container { display: flex; height: 420px; background: #050000; border-bottom: 1px solid #400; }
        #chat_logs { flex: 1; overflow-y: scroll; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        .chat-entry { display: flex; flex-direction: column; gap: 2px; }
        .chat-header { display: flex; align-items: center; gap: 8px; }
        .rank-tag { font-size: 9px; font-weight: bold; padding: 2px 6px; border-radius: 3px; border: 1px solid; text-transform: uppercase; min-width: 25px; text-align: center; display: inline-block; }
        #member_list { width: 200px; border-left: 1px solid #400; padding: 0; background: #0a0000; overflow-y: auto; }
        .member-category { color: #d40000; font-size: 11px; font-weight: bold; margin-top: 12px; border-bottom: 1px solid #400; text-transform: uppercase; padding-bottom: 4px; padding-left: 8px; }
        .member-category:first-child { margin-top: 0; }
        .member-item { font-size: 12px; font-weight: bold; margin-top: 4px; cursor: pointer; padding: 5px 8px; border-radius: 3px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .member-item:hover { background: rgba(139, 0, 0, 0.3); }
        .member-tag { font-size: 8px; padding: 2px 4px; border-radius: 2px; border: 1px solid; display: inline-block; }
        .st-style { color: #ff00ff; border-color: #ff00ff; background: rgba(255, 0, 255, 0.15); }
        .a-style { color: #ffffff; border-color: #ffffff; background: rgba(255, 255, 255, 0.1); }
        .mod-style { color: #00ff00; border-color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        .contrib-style { color: #1781ff; border-color: #1781ff; background: #001128; font-family: 'Bahram', sans-serif; box-shadow: 0 0 0 1px #000; }
        .oleg-style { color: #ff6b35; border-color: #ff6b35; background: rgba(255, 107, 53, 0.15); }
        .noseeyedear-style { color: #00ffcc; border-color: #00ffcc; background: rgba(0, 255, 204, 0.15); }
        .guest-style { color: #888; border-color: #555; background: rgba(85, 85, 85, 0.1); }
        .vip-style { color: #ffd700; border-color: #ffd700; background: rgba(255, 215, 0, 0.15); }
        .sb-style { color: #6a03b4; border-color: #6a03b4; background: rgba(106, 3, 180, 0.15); }
        .member-style { color: #ff4444; border-color: #ff4444; background: rgba(255, 68, 68, 0.1); }
        .bot-style { color: #d40000; border-color: #d40000; background: rgba(212, 0, 0, 0.2); }
        #memories_grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; justify-items: center; }
        .pagination-bar { padding: 15px; background: #111; border-top: 2px solid #500; text-align: center; }
        .ie-content { padding: 15px; color: #d40000; }
        .ie-input { width: 100%; background: #111; color: #ff0000; border: 1px solid #700000; padding: 6px; margin-bottom: 12px; font-size: 11px; box-sizing: border-box; }
        .ie-input:focus { outline: none; border-color: #ff0000; }
        .ie-btn { background: #500; color: white; border: 1px solid #f00; padding: 8px; width: 100%; font-weight: bold; margin-bottom: 5px; transition: all 0.2s; }
        .ie-btn:hover { background: #700; }
        .lounge-entry-btn { background: linear-gradient(#222, #000); border: 1px solid #ff00ff; color: #ff00ff; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 20px; font-size: 11px; text-transform: uppercase; }
        .guest-section { border-top: 1px solid #400; margin-top: 20px; padding-top: 15px; }
        .guest-btn { background: linear-gradient(#1a1a1a, #0a0a0a); border: 1px solid #444; color: #888; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 8px; font-size: 11px; text-transform: uppercase; }
        .visitor-counter { background: #000; border: 1px solid #400; padding: 8px 15px; display: inline-block; font-family: 'Courier New', monospace; color: #0f0; font-size: 14px; }
        .taskbar { position: fixed; bottom: 0; width: 100%; height: 40px; background: var(--glass); border-top: 1px solid rgba(255,0,0,0.3); display: flex; align-items: center; z-index: 100; }
        .music-ctrl { width: 22px; filter: invert(1) sepia(1) saturate(10) hue-rotate(330deg); opacity: 0.8; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #0a0000; }
        ::-webkit-scrollbar-thumb { background: #400; border: 1px solid #600; }
        #screensaver { position: fixed; inset: 0; background: black; z-index: 99998; display: none; overflow: hidden; }
        .screensaver-bat { position: absolute; font-size: 30px; }
        @keyframes flyAround { 0% { transform: translate(0, 0); } 25% { transform: translate(80vw, 20vh); } 50% { transform: translate(40vw, 80vh); } 75% { transform: translate(10vw, 50vh); } 100% { transform: translate(0, 0); } }
        .profile-card { position: fixed; width: 340px; max-height: 650px; background: linear-gradient(135deg, #1a0000, #0a0000); border: 2px solid #700; box-shadow: 0 10px 40px rgba(0,0,0,0.9); z-index: 9000; display: none; overflow-y: auto; }
        .profile-card-header { display: flex; align-items: center; gap: 12px; padding: 15px; background: linear-gradient(180deg, #200000, #100000); border-bottom: 1px solid #500; }
        .profile-card-avatar { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; font-size: 35px; border: 3px solid #700; flex-shrink: 0; }
        .profile-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-card-name { font-weight: bold; font-size: 16px; }
        .profile-card-title { font-size: 10px; color: #888; margin-top: 2px; }
        .profile-card-bio { font-size: 11px; color: #aaa; padding: 12px 15px; border-bottom: 1px solid #300; line-height: 1.5; }
        .profile-card-btn { background: #500; color: #fff; border: 1px solid #800; padding: 6px 12px; font-size: 10px; cursor: pointer; }
        .chat-action { color: #888; font-style: italic; }
        .chat-bot { background: rgba(139, 0, 0, 0.1); border-left: 2px solid #8b0000; padding: 6px; margin: 4px 0; }
        .pinned-msg { background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; padding: 6px; margin-bottom: 8px; font-size: 10px; }
        .chat-image { max-width: 150px; max-height: 100px; border: 1px solid #400; margin-top: 4px; }
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #400; }
        .tab { padding: 6px 12px; color: #666; font-size: 10px; border-right: 1px solid #333; cursor: pointer; }
        .tab.active { background: #0a0000; color: #d40000; }
        .admin-section { margin-bottom: 15px; background: #0a0000; border: 1px solid #400; padding: 12px; }
        .admin-section h4 { color: #d40000; margin: 0 0 10px 0; font-size: 12px; border-bottom: 1px solid #400; padding-bottom: 5px; }
        .typing-indicator { display: flex; gap: 4px; padding: 8px 12px; color: #666; font-size: 11px; font-style: italic; }
        .typing-dot { width: 6px; height: 6px; background: #d40000; border-radius: 50%; animation: typingBounce 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }
        .chat-username { cursor: pointer; transition: all 0.2s; }
        .chat-username:hover { text-decoration: underline; text-shadow: 0 0 8px currentColor; }
        .app-status { padding: 8px; margin-top: 8px; border: 1px solid; font-size: 10px; }
        .app-pending { border-color: #ffd700; color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        /* Clubs & Messages Styles */
        .club-card { background: #0a0000; border: 1px solid #400; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        .club-card:hover { border-color: #700; }
        .club-name { color: #d40000; font-weight: bold; font-size: 14px; }
        .club-members { color: #888; font-size: 10px; margin-top: 5px; }
        .club-badge { display: inline-block; padding: 2px 6px; background: #200; border: 1px solid #500; color: #f88; font-size: 9px; border-radius: 3px; margin: 2px; }
        .dm-list { max-height: 400px; overflow-y: auto; }
        .dm-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #0a0000; border: 1px solid #300; margin-bottom: 5px; cursor: pointer; transition: all 0.2s; }
        .dm-item:hover { background: #150000; border-color: #500; }
        .dm-item.unread { border-left: 3px solid #d40000; }
        .dm-avatar { width: 40px; height: 40px; border-radius: 50%; background: #111; display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
        .dm-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dm-preview { flex: 1; overflow: hidden; }
        .dm-name { color: #d40000; font-weight: bold; font-size: 12px; }
        .dm-last { color: #666; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dm-time { color: #555; font-size: 9px; }
        .msg-bubble { max-width: 70%; padding: 8px 12px; margin: 5px; border-radius: 12px; font-size: 12px; }
        .msg-bubble.sent { background: #300; color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .msg-bubble.received { background: #111; color: #ddd; border-bottom-left-radius: 4px; }
        .friend-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: #0a0000; border: 1px solid #300; margin-bottom: 5px; }
        .friend-actions { margin-left: auto; display: flex; gap: 5px; }
        .stakes-grid { display: grid; grid-template-columns: repeat(9, 26px); gap: 1px; justify-content: center; }
        .stakes-cell { width: 26px; height: 26px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .stakes-cell.revealed { background: #111; }
        .stakes-cell.stake { background: #500; }
        .game-status { text-align: center; margin: 8px 0; color: #d40000; font-size: 11px; }
        .mgmt-sidebar { width: 160px; background: #0a0000; border-right: 1px solid #400; }
        .mgmt-sidebar-item { padding: 10px 12px; color: #888; font-size: 11px; cursor: pointer; border-bottom: 1px solid #300; transition: all 0.2s; }
        .mgmt-sidebar-item:hover { background: #150000; color: #d40000; }
        .mgmt-sidebar-item.active { background: #200000; color: #d40000; border-left: 3px solid #d40000; }
        .user-id-display { font-family: monospace; color: #555; font-size: 9px; background: #050000; padding: 8px; border-top: 1px solid #300; margin-top: 10px; }
        /* ANNOUNCEMENT STYLES */
        @keyframes announceIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .announce-type-info { border-color: #4488ff !important; }
        .announce-type-info #announce_icon { color: #4488ff; }
        .announce-type-info #announce_title { color: #4488ff; }
        .announce-type-update { border-color: #00cc66 !important; }
        .announce-type-update #announce_icon { color: #00cc66; }
        .announce-type-update #announce_title { color: #00cc66; }
        .announce-type-warning { border-color: #ffaa00 !important; }
        .announce-type-warning #announce_icon { color: #ffaa00; }
        .announce-type-warning #announce_title { color: #ffaa00; }
        .announce-type-event { border-color: #ff66ff !important; }
        .announce-type-event #announce_icon { color: #ff66ff; }
        .announce-type-event #announce_title { color: #ff66ff; }
        /* MOBILE */
        @media screen and (max-width: 900px) {
            * { cursor: auto !important; }
            .bat-cursor { display: none !important; }
            #desktop { padding: 10px; gap: 10px; flex-direction: row; flex-wrap: wrap; justify-content: center; }
            .icon { width: 70px; margin-bottom: 5px; }
            .icon img.folder-icon { width: 36px; }
            .window { left: 5px !important; top: 50px !important; width: calc(100vw - 10px) !important; height: calc(100vh - 100px) !important; resize: none !important; }
            .chat-container { flex-direction: column; height: auto !important; max-height: 50vh; }
            #chat_logs { height: 200px; min-height: 200px; }
            #member_list { width: 100% !important; border-left: none !important; border-top: 1px solid #400; max-height: 150px; }
            .profile-card { left: 10px !important; top: 60px !important; width: calc(100vw - 20px) !important; max-height: 70vh !important; }
            .boot-title { font-size: 36px; }
            #chat_avatar { padding: 10px !important; }
            #chat_avatar > div:first-child { flex-direction: column; align-items: center; }
            .taskbar { height: 35px; }
            #memories_grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; padding: 10px !important; }
            .stakes-grid { grid-template-columns: repeat(9, 22px) !important; }
            .stakes-cell { width: 22px !important; height: 22px !important; font-size: 10px !important; }
            .ie-input { padding: 8px; font-size: 14px; }
            .ie-btn { padding: 10px; font-size: 12px; }
            .mgmt-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #400; display: flex; flex-wrap: wrap; }
            .mgmt-sidebar-item { flex: 1; min-width: 80px; text-align: center; border-bottom: none; }
        }
        @media screen and (max-width: 500px) {
            .boot-title { font-size: 28px; }
            #memories_grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
<div class="bat-cursor" id="batCursor">
    <svg viewBox="0 0 32 32" fill="#8b0000">
        <g class="wing-left"><path d="M16 14 L8 8 L6 12 L10 14 L6 16 L4 14 L2 18 L8 18 L12 16 L16 16 Z"/></g>
        <g class="wing-right"><path d="M16 14 L24 8 L26 12 L22 14 L26 16 L28 14 L30 18 L24 18 L20 16 L16 16 Z"/></g>
        <ellipse cx="16" cy="16" rx="4" ry="5"/><circle cx="16" cy="11" r="3"/>
        <circle cx="15" cy="10" r="0.8" fill="#ff0000"/><circle cx="17" cy="10" r="0.8" fill="#ff0000"/>
    </svg>
</div>
<div id="screensaver"></div>
<!-- Profile Window -->
<div class="window" id="profile_window" style="left:250px; top:40px; width:480px; height:700px; display:none; z-index:9000;">
    <div class="title-bar"><div class="title-bar-text" id="pw_title">üë§ Profile</div><div class="title-bar-controls"><button aria-label="Close" onclick="closeProfileWindow()"></button></div></div>
    <div class="window-body" style="overflow-y:auto; padding:0; position:relative;">
        <div id="pw_bg_overlay" style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); pointer-events:none; z-index:0; display:none;"></div>
        <div style="position:relative; z-index:1;">
        <div style="background:linear-gradient(180deg, rgba(32,0,0,0.9), rgba(16,0,0,0.9)); padding:20px; text-align:center; border-bottom:2px solid #500;">
            <div id="pw_avatar_wrapper" style="position:relative; width:160px; height:160px; margin:-15px auto 0;">
                <div id="pw_avatar_effect" style="position:absolute; top:-5px; left:-5px; width:170px; height:170px; z-index:0; pointer-events:none; border-radius:50%;"></div>
                <div id="pw_avatar" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1; width:130px; height:130px; border-radius:50%; background:#111; border:4px solid #700; display:flex; align-items:center; justify-content:center; font-size:50px; overflow:hidden; box-sizing:content-box;">ü¶á</div>
                <div id="pw_avatar_frame" style="display:none;"></div>
                <div id="pw_avatar_hat" style="display:none;"></div>
                <div id="pw_avatar_accessory" style="display:none;"></div>
            </div>
            <div id="pw_name" style="font-size:22px; font-weight:bold; color:#d40000;"></div>
            <div id="pw_rank" style="font-size:12px; color:#888; margin-top:5px;"></div>
            <div id="pw_status" style="font-size:11px; color:#aaa; margin-top:8px; font-style:italic;"></div>
            <div id="pw_mood" style="font-size:10px; color:#666; margin-top:4px;"></div>
        </div>
        <div style="display:flex; background:rgba(10,0,0,0.9); border-bottom:1px solid #400;">
            <div style="flex:1; text-align:center; padding:15px; border-right:1px solid #400;">
                <div id="pw_rep" style="color:#ff4444; font-size:24px; font-weight:bold;">0</div>
                <div style="color:#666; font-size:9px; text-transform:uppercase;">Reputation</div>
            </div>
            <div style="flex:1; text-align:center; padding:15px;">
                <div id="pw_comments_count" style="color:#ff4444; font-size:24px; font-weight:bold;">0</div>
                <div style="color:#666; font-size:9px; text-transform:uppercase;">Comments</div>
            </div>
        </div>
        <div style="padding:15px; border-bottom:1px solid #400; background:rgba(5,0,0,0.85);">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:8px;">üìú ABOUT</div>
            <div id="pw_bio" style="color:#aaa; font-size:12px; line-height:1.6;">No bio set.</div>
        </div>
        <div id="pw_clubs_section" style="padding:15px; border-bottom:1px solid #400; display:none; background:rgba(5,0,0,0.85);">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:10px;">üè∞ CLUBS</div>
            <div id="pw_clubs_list" style="display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow-y:auto;"></div>
        </div>
        <div id="pw_music_section" style="padding:15px; border-bottom:1px solid #400; display:none; background:rgba(5,0,0,0.85);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div style="color:#d40000; font-size:11px; font-weight:bold;">PROFILE MUSIC</div>
                <button class="ie-btn" id="pw_mute_btn" style="width:auto; padding:4px 10px; font-size:10px; margin:0;" onclick="toggleProfileMusic()">üîá Mute</button>
            </div>
            <div id="pw_music_player"></div>
        </div>
        <div id="pw_badges_section" style="padding:15px; border-bottom:2px solid #500; display:none; background:linear-gradient(180deg, rgba(20,5,5,0.95), rgba(5,0,0,0.85));">
            <div style="color:#ffd700; font-size:14px; font-weight:bold; margin-bottom:12px; text-transform:uppercase; letter-spacing:2px; text-shadow:0 0 10px rgba(255,215,0,0.3); border-bottom:1px solid #500; padding-bottom:8px;">‚òÖ BADGES ‚òÖ</div>
            <div id="pw_badges_list" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center;"></div>
        </div>
        <div style="padding:15px; display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid #400; background:rgba(5,0,0,0.85);">
            <button class="ie-btn" style="flex:1; min-width:100px; margin:0;" onclick="startDMFromProfile()">üí¨ Message</button>
            <button class="ie-btn" id="pw_btn_rep_pos" style="flex:1; min-width:80px; margin:0; background:#030; border-color:#0a0; display:none;" onclick="giveRep(1)">üëç +Rep</button>
            <button class="ie-btn" id="pw_btn_rep_neg" style="flex:1; min-width:80px; margin:0; background:#500; border-color:#a00; display:none;" onclick="giveRep(-1)">üëé -Rep</button>
        </div>
        <div style="padding:15px; background:rgba(5,0,0,0.85);">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:10px;">PROFILE COMMENTS</div>
            <div id="pw_comments_list" style="max-height:200px; overflow-y:auto; margin-bottom:15px; padding:5px; background:rgba(5,0,0,0.9); border:1px solid #300; border-radius:4px;">
                <div style="color:#555; font-size:10px; padding:10px; text-align:center;">No comments yet.</div>
            </div>
            <div id="pw_comment_form" style="display:none;">
                <input type="text" id="pw_comment_input" class="ie-input" placeholder="Leave a comment..." style="margin-bottom:8px;">
                <button class="ie-btn" style="padding:8px;" onclick="leaveProfileComment()">Post Comment</button>
            </div>
        </div>
        <div style="padding:12px 15px; background:rgba(5,0,0,0.95); border-top:1px solid #400;">
            <div style="color:#444; font-size:9px; font-family:monospace;" id="pw_user_id">User ID: ...</div>
        </div>
        </div>
    </div>
</div>
<!-- BADGE TOOLTIP -->
<div id="badge_tooltip" style="display:none; position:fixed; background:linear-gradient(180deg, #1a0808, #0a0000); border:2px solid #d40000; border-radius:6px; padding:10px 15px; z-index:99999; pointer-events:none; max-width:200px; box-shadow:0 4px 15px rgba(0,0,0,0.8);">
    <div id="badge_tooltip_name" style="color:#d40000; font-weight:bold; font-size:12px; margin-bottom:5px;"></div>
    <div id="badge_tooltip_desc" style="color:#aaa; font-size:10px; line-height:1.4;"></div>
</div>
<!-- SITE ANNOUNCEMENT OVERLAY -->
<div id="announcement_overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99999; display:none; justify-content:center; align-items:center;">
    <div id="announcement_box" style="background:linear-gradient(180deg, #1a0808, #0a0000); border:2px solid #d40000; border-radius:8px; padding:30px 40px; max-width:600px; width:90%; text-align:center; box-shadow:0 0 50px rgba(139,0,0,0.5); animation:announceIn 0.5s ease;">
        <div id="announce_icon" style="font-size:40px; margin-bottom:15px;">üì¢</div>
        <div id="announce_image" style="display:none; margin-bottom:15px;"></div>
        <div id="announce_title" style="color:#d40000; font-size:18px; font-weight:bold; margin-bottom:15px;"></div>
        <div id="announce_text" style="color:#ddd; font-size:14px; line-height:1.6; min-height:50px;"></div>
        <div id="announce_cursor" style="display:inline-block; width:2px; height:16px; background:#d40000; margin-left:2px; animation:blink 0.7s infinite;"></div>
        <div id="announce_music_indicator" style="display:none; margin-top:15px; color:#ffd700; font-size:11px;">üéµ Now Playing...</div>
        <div id="announce_from" style="margin-top:15px; font-size:11px; color:#888;"></div>
        <div style="margin-top:10px; color:#666; font-size:10px;">Click anywhere to dismiss</div>
    </div>
</div>
<!-- MAINTENANCE MODE OVERLAY - FULL LOCK SCREEN -->
<div id="maintenance_overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0a0000; z-index:9999999; justify-content:center; align-items:center; flex-direction:column;">
    <div style="text-align:center; padding:40px;">
        <div style="font-size:80px; margin-bottom:30px; animation:pulse 2s infinite;">üîß</div>
        <div style="color:#d40000; font-size:36px; font-weight:bold; margin-bottom:20px; text-shadow:0 0 30px rgba(212,0,0,0.5);">MAINTENANCE MODE</div>
        <div id="maintenance_overlay_message" style="color:#ccc; font-size:16px; line-height:1.8; margin-bottom:30px; max-width:500px;">We're performing scheduled maintenance. Please check back soon!</div>
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:30px;">
            <div style="width:15px; height:15px; background:#d40000; border-radius:50%; animation:pulse 1.5s infinite;"></div>
            <div style="width:15px; height:15px; background:#d40000; border-radius:50%; animation:pulse 1.5s infinite 0.3s;"></div>
            <div style="width:15px; height:15px; background:#d40000; border-radius:50%; animation:pulse 1.5s infinite 0.6s;"></div>
        </div>
        <div style="color:#666; font-size:12px;">The site will be available when maintenance is complete.</div>
        <div style="color:#444; font-size:10px; margin-top:20px;">This page will automatically refresh when ready.</div>
        <div id="maintenance_music_player" style="margin-top:20px; width:300px; max-width:90%;"></div>
    </div>
</div>
<style>
@keyframes pulse {
    0%, 100% { opacity: 0.3; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
}
</style>
<!-- ADMIN MESSAGE NOTIFICATION -->
<div id="admin_msg_notification" style="display:none; position:fixed; bottom:20px; right:20px; z-index:99998; max-width:350px; animation:slideInRight 0.3s ease;">
    <div style="background:linear-gradient(180deg, #1a1500, #0a0500); border:2px solid #ffd700; border-radius:8px; box-shadow:0 4px 20px rgba(255,215,0,0.3), inset 0 1px 0 rgba(255,215,0,0.2); overflow:hidden;">
        <div style="background:linear-gradient(90deg, #3a3000, #2a2000); padding:10px 15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #5a4a00;">
            <span style="color:#ffd700; font-weight:bold; font-size:12px; text-shadow:0 0 10px rgba(255,215,0,0.5);">üì® Message from ST</span>
            <span id="admin_msg_priority_badge" style="font-size:9px; padding:2px 6px; border-radius:3px; background:#2a2000; color:#888;">NORMAL</span>
        </div>
        <div style="padding:15px;">
            <div id="admin_msg_content" style="color:#eee; font-size:12px; line-height:1.5; margin-bottom:12px; max-height:150px; overflow-y:auto;"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; padding-top:10px; border-top:1px solid #3a3000;">
                <span id="admin_msg_time" style="color:#666; font-size:9px;"></span>
                <button onclick="dismissAdminMessage()" style="background:linear-gradient(180deg, #3a3000, #2a2000); border:1px solid #5a4a00; color:#ffd700; padding:6px 15px; border-radius:4px; cursor:pointer; font-size:10px; font-weight:bold;">‚úì Mark as Read</button>
            </div>
        </div>
    </div>
</div>
<style>
@keyframes slideInRight {
    from { transform:translateX(100%); opacity:0; }
    to { transform:translateX(0); opacity:1; }
}
</style>
<style>
/* ===== PROFILE EFFECTS ===== */
@keyframes fx-blood-pulse {
    0%, 100% { box-shadow: 0 0 15px 5px rgba(180,0,0,0.4), 0 0 30px 10px rgba(120,0,0,0.2); }
    50% { box-shadow: 0 0 25px 10px rgba(220,0,0,0.7), 0 0 50px 20px rgba(180,0,0,0.4); }
}
@keyframes fx-hellfire {
    0% { box-shadow: 0 0 15px 5px rgba(255,80,0,0.5), 0 0 30px 10px rgba(255,0,0,0.3); }
    33% { box-shadow: 0 0 20px 8px rgba(255,50,0,0.6), 0 0 40px 15px rgba(200,0,0,0.4); }
    66% { box-shadow: 0 0 25px 10px rgba(255,100,0,0.7), 0 0 35px 12px rgba(255,30,0,0.3); }
    100% { box-shadow: 0 0 15px 5px rgba(255,80,0,0.5), 0 0 30px 10px rgba(255,0,0,0.3); }
}
@keyframes fx-phantom {
    0%, 100% { box-shadow: 0 0 15px 5px rgba(100,150,255,0.3), 0 0 30px 10px rgba(50,80,200,0.15); }
    50% { box-shadow: 0 0 25px 12px rgba(150,200,255,0.6), 0 0 50px 20px rgba(100,150,255,0.3); }
}
@keyframes fx-toxic {
    0%, 100% { box-shadow: 0 0 15px 5px rgba(0,200,50,0.4), 0 0 30px 10px rgba(0,150,30,0.2); }
    50% { box-shadow: 0 0 25px 10px rgba(0,255,80,0.7), 0 0 50px 20px rgba(0,200,50,0.3); }
}
@keyframes fx-void {
    0%, 100% { box-shadow: 0 0 20px 8px rgba(80,0,150,0.5), 0 0 40px 15px rgba(40,0,80,0.3); }
    50% { box-shadow: 0 0 30px 15px rgba(120,0,200,0.7), 0 0 60px 25px rgba(80,0,150,0.4); }
}
@keyframes fx-rainbow {
    0% { box-shadow: 0 0 20px 8px rgba(255,0,0,0.6); }
    16% { box-shadow: 0 0 20px 8px rgba(255,165,0,0.6); }
    33% { box-shadow: 0 0 20px 8px rgba(255,255,0,0.6); }
    50% { box-shadow: 0 0 20px 8px rgba(0,255,0,0.6); }
    66% { box-shadow: 0 0 20px 8px rgba(0,100,255,0.6); }
    83% { box-shadow: 0 0 20px 8px rgba(150,0,255,0.6); }
    100% { box-shadow: 0 0 20px 8px rgba(255,0,0,0.6); }
}
@keyframes fx-glitch {
    0%, 100% { box-shadow: -3px 0 8px rgba(255,0,0,0.5), 3px 0 8px rgba(0,255,255,0.5); }
    25% { box-shadow: 3px 0 8px rgba(255,0,255,0.5), -3px 0 8px rgba(0,255,0,0.5); }
    50% { box-shadow: -2px 2px 12px rgba(0,0,255,0.6), 2px -2px 12px rgba(255,255,0,0.6); }
    75% { box-shadow: 2px -1px 8px rgba(255,0,0,0.5), -2px 1px 8px rgba(0,255,255,0.5); }
}
@keyframes fx-golden {
    0%, 100% { box-shadow: 0 0 15px 5px rgba(255,215,0,0.4), 0 0 30px 10px rgba(200,170,0,0.2); }
    50% { box-shadow: 0 0 25px 12px rgba(255,215,0,0.7), 0 0 50px 20px rgba(255,200,0,0.4); }
}
.fx-blood-glow { border-radius:50%; animation: fx-blood-pulse 2s ease-in-out infinite; }
.fx-hellfire { border-radius:50%; animation: fx-hellfire 1.5s ease-in-out infinite; }
.fx-phantom { border-radius:50%; animation: fx-phantom 2.5s ease-in-out infinite; }
.fx-toxic { border-radius:50%; animation: fx-toxic 2s ease-in-out infinite; }
.fx-void { border-radius:50%; animation: fx-void 2s ease-in-out infinite; }
.fx-rainbow { border-radius:50%; animation: fx-rainbow 3s linear infinite; }
.fx-glitch { border-radius:50%; animation: fx-glitch 0.5s steps(4) infinite; }
.fx-golden { border-radius:50%; animation: fx-golden 2s ease-in-out infinite; }
@keyframes fx-beautiful-mind {
    0%, 100% { box-shadow: 0 0 20px 8px rgba(255,255,255,0.3), 0 0 40px 15px rgba(200,220,255,0.15), 0 0 60px 25px rgba(150,180,255,0.08); }
    25% { box-shadow: 0 0 25px 10px rgba(220,240,255,0.4), 0 0 50px 20px rgba(180,200,255,0.2), 0 0 70px 30px rgba(150,170,255,0.1); }
    50% { box-shadow: 0 0 30px 12px rgba(255,255,255,0.5), 0 0 55px 22px rgba(200,230,255,0.25), 0 0 80px 35px rgba(170,200,255,0.12); }
    75% { box-shadow: 0 0 22px 9px rgba(230,245,255,0.35), 0 0 45px 18px rgba(190,210,255,0.18), 0 0 65px 28px rgba(160,190,255,0.09); }
}
.fx-beautiful-mind { border-radius:50%; animation: fx-beautiful-mind 3s ease-in-out infinite; }
</style>
<div id="boot-screen" onclick="beginSession()">
    <div style="font-size: 80px; margin-bottom: 20px; animation: batFloat 3s ease-in-out infinite;">ü¶á</div>
    <h1 class="boot-title">fangtasia.wtf</h1>
    <p class="boot-subtitle">Click anywhere to enter the crypt...</p>
    <div style="margin-top: 30px;"><div class="visitor-counter">SOULS COLLECTED: <span id="visitor_count">000000</span></div></div>
    <div style="margin-top: 40px; color: #500; font-size: 10px; animation: flicker 3s infinite;">‚ñº CLICK TO INITIALIZE ‚ñº</div>
</div>
<div id="desktop">
    <div class="icon" onclick="toggleWin('memories_folder')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png"><div>Memories</div></div>
    <div class="icon" onclick="toggleWin('ie_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/msie1-2.png"><div>Portal</div></div>
    <div class="icon" onclick="toggleWin('games_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/joystick-2.png"><div>Games</div></div>
    <div class="icon" onclick="toggleWin('apply_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/keys-0.png"><div>Apply</div></div>
    <div class="icon" onclick="toggleWin('about_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/help_book_cool-4.png"><div>About</div></div>
    <div class="icon" id="clubs_icon" style="display:none;" onclick="toggleWin('clubs_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/network_neighborhood-0.png"><div>Clubs</div></div>
    <div class="icon" id="messages_icon" style="display:none;" onclick="toggleWin('messages_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/mail_-5.png"><div>Messages</div></div>
    <div class="icon" id="watchparty_icon" style="display:none;" onclick="toggleWin('watchparty_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/mplayer-1.png"><div>Watch Party</div></div>
    <div class="icon" id="leaderboard_icon" style="display:none;" onclick="toggleWin('leaderboard_window'); loadLeaderboards();"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/trophy-0.png"><div>Leaderboards</div></div>
    <div class="icon" id="admin_icon" style="display:none;" onclick="openAdminPanelSecure()"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/lock-0.png"><div>Admin Panel</div></div>
</div>
<div class="window" id="about_window" style="left:200px; top:120px; width:350px; height:320px;">
    <div class="title-bar"><div class="title-bar-text">About fangtasia.wtf</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('about_window')"></button></div></div>
    <div class="window-body"><div class="ie-content" style="text-align: center;"><h2 style="font-size: 28px; margin-bottom: 5px;">fangtasia.wtf</h2><p style="color: #666; font-size: 10px;">Version 6.66</p><div style="border: 1px solid #400; padding: 15px; margin: 15px 0; text-align: left; background: #050000;"><p style="color: #999; font-size: 11px; line-height: 1.6;">Welcome to the digital crypt.<br><br>ü¶á <span style="color:#d40000;">Memories</span> - Video archive<br>ü¶á <span style="color:#d40000;">Portal</span> - Member access<br>ü¶á <span style="color:#d40000;">Games</span> - Silver Stakes<br>ü¶á <span style="color:#d40000;">The Lounge</span> - Members only</p></div></div></div>
</div>
<div class="window" id="games_window" style="left:100px; top:50px; width:500px; height:600px;">
    <div class="title-bar"><div class="title-bar-text">Fangtasia Games & Shop</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('games_window')"></button></div></div>
    <div class="window-body" style="padding:0; display:flex; flex-direction:column; height:calc(100% - 25px);">
        <!-- Token Display Bar -->
        <div class="token-bar">
            <div class="token-display">
                <span class="token-icon">ü©∏</span>
                <span id="main_token_display" class="token-amount">0</span>
            </div>
            <div class="token-bar-btns">
                <button class="g-btn small" onclick="showGiftTokens()">üéÅ Gift</button>
                <button class="g-btn small" onclick="showTokenLeaderboard()">üèÜ Ranks</button>
            </div>
        </div>
        
        <div class="tab-bar" style="flex-wrap:wrap;">
            <div class="tab active" onclick="switchGameTab('stakes', this)">Stakes</div>
            <div class="tab" onclick="switchGameTab('blackjack', this)">Blackjack</div>
            <div class="tab" onclick="switchGameTab('slots', this)">Slots</div>
            <div class="tab" onclick="switchGameTab('roulette', this)">Roulette</div>
            <div class="tab" onclick="switchGameTab('crash', this)">Crash</div>
            <div class="tab" onclick="switchGameTab('coinflip', this)">Coin Flip</div>
            <div class="tab" onclick="switchGameTab('snake', this)">Snake</div>
            <div class="tab" onclick="switchGameTab('daily', this)">Daily</div>
            <div class="tab" onclick="switchGameTab('shop', this)">Shop</div>
        </div>
        
        <div style="flex:1; overflow-y:auto;">
            <!-- SILVER STAKES -->
            <div id="game_tab_stakes" class="g-panel">
                <div class="g-title">Silver Stakes</div>
                <div class="g-sub">Avoid the stakes! Clear the board to win 50 tokens</div>
                <div class="g-result" id="game_status">Stakes: 10</div>
                <div class="g-arena" style="padding:12px;">
                    <div class="stakes-grid" id="stakes_grid"></div>
                </div>
                <div class="g-actions">
                    <button class="g-btn primary" onclick="initStakesGame()">New Game</button>
                </div>
                <div class="g-stat-bar">
                    <span><span class="stat-label">Your Wins: </span><span id="my_wins_count" class="stat-value" style="color:#ff6600;">0</span></span>
                </div>
            </div>
            
            <!-- BLACKJACK -->
            <div id="game_tab_blackjack" class="g-panel" style="display:none;">
                <div class="g-title">Blood Blackjack</div>
                <div class="g-sub">Beat the dealer ¬∑ Blackjack pays 2.5x ¬∑ Double down on first hand</div>
                
                <div class="g-bet-bar">
                    <span class="bet-label">Bet</span>
                    <button class="g-btn small" onclick="bjChangeBet(-10)">‚àí</button>
                    <span id="bj_bet_display" class="bet-value">10</span>
                    <button class="g-btn small" onclick="bjChangeBet(10)">+</button>
                    <button class="g-btn small" style="font-size:8px;" onclick="bjChangeBet('max')">MAX</button>
                </div>
                
                <div class="g-arena" id="bj_arena">
                    <div style="text-align:center; margin-bottom:12px;">
                        <div style="color:#555; font-size:9px; text-transform:uppercase; letter-spacing:2px;">Dealer</div>
                        <div id="bj_dealer_hand" style="display:flex; justify-content:center; gap:6px; margin-top:6px; min-height:64px;"></div>
                        <div id="bj_dealer_score" style="color:#ffd700; font-size:12px; margin-top:6px;"></div>
                    </div>
                    <div style="border-top:1px solid #2a0a0a; margin:8px 0;"></div>
                    <div style="text-align:center;">
                        <div style="color:#555; font-size:9px; text-transform:uppercase; letter-spacing:2px;">Your Hand</div>
                        <div id="bj_player_hand" style="display:flex; justify-content:center; gap:6px; margin-top:6px; min-height:64px;"></div>
                        <div id="bj_player_score" style="color:#0f0; font-size:12px; margin-top:6px;"></div>
                    </div>
                </div>
                
                <div class="g-result" id="bj_result"></div>
                
                <div class="g-actions">
                    <button class="g-btn primary" id="bj_hit_btn" onclick="bjHit()">Hit</button>
                    <button class="g-btn" id="bj_stand_btn" onclick="bjStand()">Stand</button>
                    <button class="g-btn warning" id="bj_double_btn" onclick="bjDouble()">2x</button>
                    <button class="g-btn success" id="bj_new_btn" onclick="bjNewGame()">Deal</button>
                </div>
                
                <div class="g-stat-bar">
                    <span><span class="stat-label">Wins: </span><span id="bj_wins" class="stat-value" style="color:#0f0;">0</span></span>
                    <span style="color:#2a0a0a;">‚îÇ</span>
                    <span><span class="stat-label">Profit: </span><span id="bj_profit" class="stat-value">0</span></span>
                </div>
            </div>
            
            <!-- SLOTS -->
            <div id="game_tab_slots" class="g-panel" style="display:none;">
                <div class="g-title">Blood Slots</div>
                <div class="g-sub">Match symbols to win ¬∑ VVV Jackpot: 500 tokens</div>
                
                <div class="g-bet-bar">
                    <span class="bet-label">Cost</span>
                    <span class="bet-value">10</span>
                </div>
                
                <div class="g-arena" id="slots_arena" style="text-align:center;">
                    <div style="background:linear-gradient(90deg, transparent, rgba(100,0,0,0.1), transparent); padding:15px; border-radius:8px;">
                        <div id="slots_reels" style="display:flex; justify-content:center; gap:12px;">
                            <div class="slot-reel" id="slot1">üßõ</div>
                            <div class="slot-reel" id="slot2">ü©∏</div>
                            <div class="slot-reel" id="slot3">‚ö∞Ô∏è</div>
                        </div>
                    </div>
                    <div id="slots_result" class="g-result" style="margin-top:12px;"></div>
                </div>
                
                <div class="g-actions">
                    <button class="g-btn primary large" id="spin_btn" onclick="spinSlots()">üé∞ SPIN</button>
                </div>
                
                <div class="g-history" style="text-align:center;">
                    <div style="color:#555; font-size:9px;">üßõüßõüßõ = 500 ¬∑ ü©∏ü©∏ü©∏ = 250 ¬∑ ‚ö∞Ô∏è‚ö∞Ô∏è‚ö∞Ô∏è = 100 ¬∑ Match 2 = 15</div>
                </div>
            </div>
            
            <!-- ROULETTE -->
            <div id="game_tab_roulette" class="g-panel" style="display:none;">
                <div class="g-title">Blood Roulette</div>
                <div class="g-sub">Red/Black 2x ¬∑ Green 14x ¬∑ Exact Number 36x</div>
                
                <div class="g-bet-bar">
                    <span class="bet-label">Bet</span>
                    <button class="g-btn small" onclick="rlChangeBet(-10)">‚àí</button>
                    <span id="rl_bet_display" class="bet-value">10</span>
                    <button class="g-btn small" onclick="rlChangeBet(10)">+</button>
                    <button class="g-btn small" style="font-size:8px;" onclick="rlChangeBet('max')">MAX</button>
                </div>
                
                <div class="g-arena" style="text-align:center;">
                    <div class="rl-wheel" id="rl_wheel">?</div>
                    <div class="g-result" id="rl_result"></div>
                    
                    <div style="margin-bottom:12px;">
                        <div style="color:#555; font-size:8px; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Color Bet</div>
                        <div class="rl-color-btns">
                            <button class="g-btn rl-btn-red" onclick="rlSpin('red')">üî¥ Red</button>
                            <button class="g-btn rl-btn-black" onclick="rlSpin('black')">‚ö´ Black</button>
                            <button class="g-btn rl-btn-green" onclick="rlSpin('green')">üü¢</button>
                        </div>
                    </div>
                    
                    <div>
                        <div style="color:#555; font-size:8px; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Number Bet (0-36)</div>
                        <div style="display:flex; justify-content:center; gap:6px; align-items:center;">
                            <input type="number" id="rl_number_input" class="ie-input" min="0" max="36" placeholder="#" style="width:55px; margin:0; text-align:center;">
                            <button class="g-btn warning" onclick="rlSpin('number')">Bet #</button>
                        </div>
                    </div>
                </div>
                
                <div class="g-history">
                    <div class="g-history-label">Recent Spins</div>
                    <div class="g-history-items" id="rl_history_dots"></div>
                </div>
            </div>
            
            <!-- CRASH -->
            <div id="game_tab_crash" class="g-panel" style="display:none;">
                <div class="g-title">Blood Crash</div>
                <div class="g-sub">Cash out before it crashes ¬∑ The longer you wait, the bigger the win</div>
                
                <div class="g-bet-bar">
                    <span class="bet-label">Bet</span>
                    <button class="g-btn small" onclick="crChangeBet(-10)">‚àí</button>
                    <span id="cr_bet_display" class="bet-value">10</span>
                    <button class="g-btn small" onclick="crChangeBet(10)">+</button>
                    <button class="g-btn small" style="font-size:8px;" onclick="crChangeBet('max')">MAX</button>
                </div>
                
                <div class="g-arena" style="text-align:center;">
                    <canvas id="crash_canvas" width="440" height="160" style="width:100%; background:linear-gradient(180deg, #060000, #030000); border-radius:6px; border:1px solid #2a0a0a;"></canvas>
                    <div class="cr-multiplier" id="cr_multiplier">1.00x</div>
                    <div class="g-result" id="cr_result"></div>
                </div>
                
                <div class="g-actions">
                    <button class="g-btn success large" id="cr_start_btn" onclick="crStart()">üöÄ BET</button>
                    <button class="g-btn warning large" id="cr_cashout_btn" style="display:none;" onclick="crCashout()">üí∞ CASH OUT</button>
                </div>
                
                <div class="g-history">
                    <div class="g-history-label">Recent Crashes</div>
                    <div class="g-history-items" id="cr_history"></div>
                </div>
            </div>
            
            <!-- COIN FLIP -->
            <div id="game_tab_coinflip" class="g-panel" style="display:none;">
                <div class="g-title">Blood Coin Flip</div>
                <div class="g-sub">Heads or Tails ¬∑ Double or nothing ¬∑ 50/50 odds</div>
                
                <div class="g-bet-bar">
                    <span class="bet-label">Bet</span>
                    <button class="g-btn small" onclick="cfChangeBet(-10)">‚àí</button>
                    <span id="cf_bet_display" class="bet-value">10</span>
                    <button class="g-btn small" onclick="cfChangeBet(10)">+</button>
                    <button class="g-btn small" style="font-size:8px;" onclick="cfChangeBet('max')">MAX</button>
                </div>
                
                <div class="g-arena" id="cf_arena" style="text-align:center;">
                    <div class="cf-coin" id="cf_coin">ü™ô</div>
                    <div class="g-result" id="cf_result" style="margin-top:15px;"></div>
                </div>
                
                <div class="g-actions">
                    <button class="g-btn primary large" id="cf_heads_btn" onclick="cfFlip('heads')">ü©∏ Heads</button>
                    <button class="g-btn large" id="cf_tails_btn" onclick="cfFlip('tails')">üíÄ Tails</button>
                </div>
                
                <div class="g-stat-bar" style="justify-content:space-between;">
                    <span><span class="stat-label">Streak: </span><span id="cf_streak" class="stat-value" style="color:#ffd700;">0</span></span>
                    <span><span class="stat-label">Best: </span><span id="cf_best_streak" class="stat-value" style="color:#ff6600;">0</span></span>
                    <span><span class="stat-label">W/L: </span><span id="cf_record" class="stat-value" style="color:#aaa;">0/0</span></span>
                </div>
                <div class="g-history">
                    <div class="g-history-items" id="cf_history" style="justify-content:center;"></div>
                </div>
            </div>
            
            <!-- SNAKE -->
            <div id="game_tab_snake" class="g-panel" style="display:none;">
                <div class="g-title">Blood Snake</div>
                <div class="g-sub">Collect blood drops ¬∑ 1 token per drop ¬∑ Max 200 per game</div>
                
                <div class="g-arena" style="text-align:center; padding:12px;">
                    <canvas id="snake_canvas" width="280" height="280" style="background:linear-gradient(180deg, #060000, #030000); border:2px solid #3a0a0a; border-radius:6px;"></canvas>
                </div>
                
                <div id="snake_score" class="g-result" style="color:#d40000; font-size:16px;">Score: 0</div>
                
                <div class="g-actions">
                    <button class="g-btn primary" onclick="startSnakeGame()">Start Game</button>
                </div>
                
                <div style="color:#555; font-size:9px; text-align:center; margin-top:8px;">Arrow keys or WASD to move</div>
            </div>
            
            <!-- DAILY SPIN -->
            <div id="game_tab_daily" class="g-panel" style="display:none;">
                <div class="g-title">Daily Rewards</div>
                
                <!-- Login Streak -->
                <div style="background:#0a0505; border:1px solid #400; border-radius:8px; padding:15px; margin:10px 0;">
                    <div style="color:#ffd700; font-size:12px; font-weight:bold; margin-bottom:10px;">Login Streak</div>
                    <div style="display:flex; justify-content:center; gap:5px; margin-bottom:10px;">
                        <div id="streak_day_1" class="streak-day">1</div>
                        <div id="streak_day_2" class="streak-day">2</div>
                        <div id="streak_day_3" class="streak-day">3</div>
                        <div id="streak_day_4" class="streak-day">4</div>
                        <div id="streak_day_5" class="streak-day">5</div>
                        <div id="streak_day_6" class="streak-day">6</div>
                        <div id="streak_day_7" class="streak-day bonus">7</div>
                    </div>
                    <div id="login_bonus_status" style="color:#888; font-size:10px; text-align:center;"></div>
                    <div style="text-align:center; margin-top:10px;">
                        <button class="ie-btn" id="claim_login_btn" style="width:auto; padding:8px 20px;" onclick="claimLoginBonus()">Claim Daily Bonus</button>
                    </div>
                </div>
                
                <!-- Daily Spin -->
                <div style="background:#0a0505; border:1px solid #400; border-radius:8px; padding:15px; margin:10px 0;">
                    <div style="color:#ffd700; font-size:12px; font-weight:bold; margin-bottom:10px;">Daily Spin (Free once per day)</div>
                    <div id="daily_wheel" style="position:relative; width:200px; height:200px; margin:0 auto;">
                        <div id="wheel_spinner" style="width:100%; height:100%; border-radius:50%; background:conic-gradient(#500 0deg 45deg, #300 45deg 90deg, #700 90deg 135deg, #400 135deg 180deg, #600 180deg 225deg, #200 225deg 270deg, #800 270deg 315deg, #350 315deg 360deg); border:3px solid #900; display:flex; align-items:center; justify-content:center; transition:transform 3s ease-out;">
                            <div style="width:30px; height:30px; background:#d40000; border-radius:50%; border:2px solid #fff;"></div>
                        </div>
                        <div style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); color:#fff; font-size:20px;">V</div>
                    </div>
                    <div id="spin_reward" style="text-align:center; color:#ffd700; font-size:14px; font-weight:bold; margin:15px 0; min-height:20px;"></div>
                    <div style="text-align:center;">
                        <button class="ie-btn" id="daily_spin_btn" style="width:auto; padding:8px 30px;" onclick="spinDailyWheel()">SPIN</button>
                    </div>
                </div>
            </div>
            
            <!-- SHOP -->
            <div id="game_tab_shop" class="g-panel" style="display:none;">
                <h3 style="color: #d40000; text-align: center; margin: 5px 0;">Token Shop</h3>
                <p style="color: #666; font-size: 9px; text-align: center;">Buy items to customize your profile</p>
                
                <div id="shop_items" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:15px; max-height:350px; overflow-y:auto;">
                    <div style="color:#666; text-align:center; padding:20px; grid-column:span 3;">Loading shop...</div>
                </div>
                
                <div style="margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                    <div style="color:#888; font-size:10px; margin-bottom:5px;">Your Equipped Items:</div>
                    <div id="equipped_items" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <span style="color:#666; font-size:10px;">None</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gift Tokens Modal -->
<div id="gift_modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#1a0808; border:2px solid #700; border-radius:8px; padding:20px; width:300px;">
        <h3 style="color:#ffd700; margin:0 0 15px 0;">Gift Tokens</h3>
        <input type="text" id="gift_username" class="ie-input" placeholder="Username">
        <input type="number" id="gift_amount" class="ie-input" placeholder="Amount" min="1">
        <div id="gift_result" style="margin:10px 0; font-size:11px; min-height:20px;"></div>
        <div style="display:flex; gap:10px;">
            <button class="ie-btn" style="flex:1;" onclick="sendGift()">Send</button>
            <button class="ie-btn" style="flex:1; background:#333;" onclick="hideGiftModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Token Leaderboard Modal -->
<div id="token_leaderboard_modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#1a0808; border:2px solid #700; border-radius:8px; padding:20px; width:350px; max-height:500px;">
        <h3 style="color:#ffd700; margin:0 0 15px 0;">Richest Vampires</h3>
        <div id="token_leaderboard_list" style="max-height:350px; overflow-y:auto;"></div>
        <div style="text-align:center; margin-top:15px;">
            <button class="ie-btn" style="width:auto; padding:8px 30px;" onclick="hideTokenLeaderboard()">Close</button>
        </div>
    </div>
</div>

<style>
.slot-reel {
    width: 70px;
    height: 80px;
    background: linear-gradient(180deg, #1a0808, #0a0000);
    border: 2px solid #600;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: bold;
    color: #d40000;
    box-shadow: inset 0 0 25px rgba(0,0,0,0.9), 0 0 8px rgba(200,0,0,0.15);
    text-shadow: 0 0 10px rgba(200,0,0,0.5);
    transition: border-color 0.3s, box-shadow 0.3s;
}
.slot-reel.spinning {
    animation: slotSpin 0.08s infinite;
    border-color: #d40000;
    box-shadow: inset 0 0 25px rgba(0,0,0,0.9), 0 0 15px rgba(200,0,0,0.4);
}
.slot-reel.win-highlight {
    border-color: #ffd700 !important;
    box-shadow: 0 0 20px rgba(255,215,0,0.4), inset 0 0 25px rgba(0,0,0,0.7) !important;
    animation: reelGlow 0.5s ease 3;
}
@keyframes slotSpin {
    0% { transform: translateY(-4px); }
    50% { transform: translateY(4px); }
    100% { transform: translateY(-4px); }
}
@keyframes reelGlow {
    0%,100% { box-shadow: 0 0 10px rgba(255,215,0,0.2), inset 0 0 25px rgba(0,0,0,0.7); }
    50% { box-shadow: 0 0 25px rgba(255,215,0,0.6), inset 0 0 25px rgba(0,0,0,0.5); }
}
.bj-card {
    width: 44px;
    height: 60px;
    background: linear-gradient(180deg, #fff, #e8e0d8);
    border: 1.5px solid #555;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: bold;
    box-shadow: 2px 3px 8px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.4);
    transition: transform 0.2s;
    animation: cardDeal 0.3s ease;
}
@keyframes cardDeal {
    from { transform: translateY(-20px) rotateY(90deg); opacity: 0; }
    to { transform: translateY(0) rotateY(0); opacity: 1; }
}
.bj-card.red { color: #c00; }
.bj-card.black { color: #111; }
.bj-card.hidden { background: linear-gradient(135deg, #300 25%, #500 25%, #500 50%, #300 50%, #300 75%, #500 75%); background-size: 8px 8px; color: transparent; border-color: #700; }
.streak-day {
    width: 32px; height: 32px;
    background: linear-gradient(180deg, #1a0808, #0a0000);
    border: 1.5px solid #400;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    color: #555; font-size: 11px; font-weight: bold;
    transition: all 0.3s;
}
.streak-day.claimed {
    background: linear-gradient(180deg, #0a2a0a, #051505);
    border-color: #0a0; color: #0f0;
    box-shadow: 0 0 6px rgba(0,255,0,0.2);
}
.streak-day.bonus { background: linear-gradient(180deg, #2a2200, #1a1100); border-color: #ffd700; color: #ffd700; }
.streak-day.bonus.claimed { box-shadow: 0 0 8px rgba(255,215,0,0.3); }

/* ========== UNIFIED GAME UI CLASSES ========== */
.g-panel { padding: 12px; }
.g-title { color: #d40000; text-align: center; margin: 0 0 2px; font-size: 16px; font-weight: bold; text-shadow: 0 0 15px rgba(200,0,0,0.3); letter-spacing: 1px; }
.g-sub { color: #666; font-size: 9px; text-align: center; margin-bottom: 8px; }
.g-arena {
    background: linear-gradient(180deg, #110505, #080000);
    border: 1.5px solid #3a0a0a;
    border-radius: 10px;
    padding: 18px;
    margin: 8px 0;
    box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 0 2px 10px rgba(0,0,0,0.3);
}
.g-bet-bar {
    display: flex; justify-content: center; align-items: center; gap: 6px; margin: 8px 0;
    padding: 6px 12px;
    background: linear-gradient(90deg, transparent, rgba(100,0,0,0.1), transparent);
    border-radius: 6px;
}
.g-bet-bar .bet-label { color: #777; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
.g-bet-bar .bet-value { color: #ffd700; font-weight: bold; font-size: 16px; min-width: 50px; text-align: center; text-shadow: 0 0 8px rgba(255,215,0,0.3); }
.g-btn {
    background: linear-gradient(180deg, #2a0808, #180000);
    border: 1.5px solid #600;
    color: #e88;
    padding: 8px 18px;
    border-radius: 6px;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.g-btn:hover { background: linear-gradient(180deg, #3a0a0a, #200000); border-color: #900; color: #faa; box-shadow: 0 0 10px rgba(200,0,0,0.2); }
.g-btn:active { transform: scale(0.96); }
.g-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.g-btn.primary { background: linear-gradient(180deg, #500, #300); border-color: #a00; color: #fcc; }
.g-btn.primary:hover { background: linear-gradient(180deg, #700, #400); box-shadow: 0 0 15px rgba(200,0,0,0.3); }
.g-btn.success { background: linear-gradient(180deg, #0a3a0a, #051a05); border-color: #0a0; color: #8f8; }
.g-btn.success:hover { background: linear-gradient(180deg, #0d4d0d, #082208); box-shadow: 0 0 12px rgba(0,200,0,0.2); }
.g-btn.warning { background: linear-gradient(180deg, #3a3a0a, #1a1a05); border-color: #aa0; color: #ff8; }
.g-btn.warning:hover { background: linear-gradient(180deg, #4d4d0d, #222208); box-shadow: 0 0 12px rgba(200,200,0,0.2); }
.g-btn.small { padding: 4px 10px; font-size: 10px; }
.g-btn.large { padding: 12px 35px; font-size: 14px; letter-spacing: 1px; }
.g-stat-bar {
    margin-top: 10px; padding: 8px 12px;
    background: linear-gradient(180deg, #0d0505, #060000);
    border: 1px solid #2a0a0a;
    border-radius: 6px;
    font-size: 10px;
    display: flex; justify-content: center; align-items: center; gap: 12px;
}
.g-stat-bar .stat-label { color: #666; }
.g-stat-bar .stat-value { color: #ffd700; font-weight: bold; }
.g-result { text-align: center; font-size: 14px; font-weight: bold; min-height: 20px; margin: 8px 0; }
.g-history {
    padding: 8px 10px;
    background: linear-gradient(180deg, #0d0505, #060000);
    border: 1px solid #2a0a0a;
    border-radius: 6px;
    margin-top: 8px;
}
.g-history-label { color: #555; font-size: 8px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
.g-history-items { display: flex; gap: 3px; flex-wrap: wrap; }
.g-actions { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }

/* Token bar */
.token-bar {
    background: linear-gradient(90deg, #150505, #0d0000, #150505);
    padding: 10px 15px;
    border-bottom: 1px solid #3a0a0a;
    display: flex; justify-content: space-between; align-items: center;
}
.token-display {
    display: flex; align-items: center; gap: 8px;
}
.token-icon { font-size: 18px; filter: drop-shadow(0 0 4px rgba(200,0,0,0.5)); }
.token-amount {
    color: #d40000; font-weight: bold; font-size: 18px;
    text-shadow: 0 0 10px rgba(200,0,0,0.3);
    font-family: 'Courier New', monospace;
    transition: all 0.3s;
}
.token-amount.flash { animation: tokenFlash 0.5s ease; }
@keyframes tokenFlash {
    0% { transform: scale(1); } 30% { transform: scale(1.3); color: #ffd700; } 100% { transform: scale(1); }
}
.token-bar-btns { display: flex; gap: 6px; }

/* Roulette wheel */
.rl-wheel {
    width: 110px; height: 110px; margin: 0 auto 12px;
    border-radius: 50%;
    border: 4px solid #ffd700;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px; font-weight: bold;
    background: radial-gradient(circle, #1a1a1a, #0a0a0a);
    box-shadow: 0 0 20px rgba(255,215,0,0.15), inset 0 0 30px rgba(0,0,0,0.8);
    transition: all 0.3s;
    color: #fff;
    text-shadow: 0 0 10px rgba(255,255,255,0.3);
}
.rl-wheel.spinning { animation: wheelPulse 0.15s infinite alternate; border-color: #ff6600; }
@keyframes wheelPulse { from { transform: scale(0.97); } to { transform: scale(1.03); } }
.rl-color-btns { display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; }
.rl-btn-red { background: linear-gradient(180deg, #8a0000, #550000) !important; border-color: #c00 !important; }
.rl-btn-red:hover { box-shadow: 0 0 12px rgba(200,0,0,0.4) !important; }
.rl-btn-black { background: linear-gradient(180deg, #333, #1a1a1a) !important; border-color: #666 !important; }
.rl-btn-black:hover { box-shadow: 0 0 12px rgba(100,100,100,0.3) !important; }
.rl-btn-green { background: linear-gradient(180deg, #006600, #003300) !important; border-color: #0a0 !important; }
.rl-btn-green:hover { box-shadow: 0 0 12px rgba(0,200,0,0.3) !important; }

/* Crash multiplier */
.cr-multiplier {
    font-size: 52px; font-weight: bold; color: #0f0; margin: 8px 0;
    font-family: 'Courier New', monospace;
    text-shadow: 0 0 20px rgba(0,255,0,0.3);
    transition: color 0.3s, text-shadow 0.3s;
}
.cr-multiplier.hot { color: #ffa500; text-shadow: 0 0 20px rgba(255,165,0,0.4); }
.cr-multiplier.fire { color: #ffd700; text-shadow: 0 0 25px rgba(255,215,0,0.5); animation: firePulse 0.3s infinite alternate; }
.cr-multiplier.crashed { color: #f00; text-shadow: 0 0 30px rgba(255,0,0,0.5); animation: crashShake 0.1s 5; }
@keyframes firePulse { from { transform: scale(1); } to { transform: scale(1.03); } }
@keyframes crashShake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

/* Coin flip */
.cf-coin {
    width: 110px; height: 110px; margin: 0 auto;
    border-radius: 50%;
    border: 4px solid #ffd700;
    background: radial-gradient(circle at 40% 35%, #4a3800, #1a1100, #0d0800);
    display: flex; align-items: center; justify-content: center;
    font-size: 44px;
    box-shadow: 0 0 20px rgba(255,215,0,0.15), inset 0 0 20px rgba(0,0,0,0.5);
    transition: transform 0.5s;
}
.cf-coin.flipping { animation: coinFlip 0.12s infinite; }
@keyframes coinFlip { 0% { transform: rotateX(0); } 50% { transform: rotateX(90deg) scale(0.8); } 100% { transform: rotateX(180deg); } }
.cf-coin.win { box-shadow: 0 0 30px rgba(0,255,0,0.3), inset 0 0 20px rgba(0,0,0,0.5); border-color: #0f0; }
.cf-coin.lose { box-shadow: 0 0 30px rgba(255,0,0,0.3), inset 0 0 20px rgba(0,0,0,0.5); border-color: #f00; }

/* Win/loss flash */
@keyframes winFlash { 0% { background: rgba(0,100,0,0.3); } 100% { background: transparent; } }
@keyframes loseFlash { 0% { background: rgba(100,0,0,0.3); } 100% { background: transparent; } }
.g-arena.win-flash { animation: winFlash 0.8s ease; }
.g-arena.lose-flash { animation: loseFlash 0.8s ease; }
.shop-item {
    background: #0a0505;
    border: 1px solid #400;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
}
.shop-item:hover {
    border-color: #d40000;
}
.shop-item.owned {
    border-color: #0a0;
    background: #050505;
}
.shop-item img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-bottom: 5px;
}
</style>
<div class="window" id="leaderboard_window" style="left:220px; top:60px; width:400px; height:480px; display:none;">
    <div class="title-bar"><div class="title-bar-text">Leaderboards</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('leaderboard_window')"></button></div></div>
    <div class="window-body" style="padding: 0;">
        <div class="tab-bar">
            <div class="tab active" onclick="switchLeaderboardTab('minesweeper', this)">üí£ Minesweeper</div>
            <div class="tab" onclick="switchLeaderboardTab('activity', this)">üìä Activity</div>
            <div class="tab" onclick="switchLeaderboardTab('clubs', this)">üè∞ Clubs</div>
        </div>
        <div id="leaderboard_minesweeper" style="padding: 10px;">
            <h3 style="color: #d40000; text-align: center; margin: 5px 0 10px 0;">Silver Stakes Champions</h3>
            <div id="minesweeper_leaderboard" style="max-height: 350px; overflow-y: auto;">
                <div style="color: #666; text-align: center; padding: 20px;">Loading...</div>
            </div>
        </div>
        <div id="leaderboard_activity" style="padding: 10px; display: none;">
            <h3 style="color: #d40000; text-align: center; margin: 5px 0 10px 0;">üìä Most Active Members</h3>
            <div id="activity_leaderboard" style="max-height: 350px; overflow-y: auto;">
                <div style="color: #666; text-align: center; padding: 20px;">Loading...</div>
            </div>
        </div>
        <div id="leaderboard_clubs" style="padding: 10px; display: none;">
            <h3 style="color: #d40000; text-align: center; margin: 5px 0 10px 0;">üè∞ Top Clubs</h3>
            <div id="clubs_leaderboard" style="max-height: 350px; overflow-y: auto;">
                <div style="color: #666; text-align: center; padding: 20px;">Loading...</div>
            </div>
        </div>
    </div>
</div>
<div class="window" id="apply_window" style="left:160px; top:90px; width:340px; height:440px;">
    <div class="title-bar"><div class="title-bar-text">üîë Apply for Access</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('apply_window')"></button></div></div>
    <div class="window-body"><div class="ie-content"><h2 style="margin-top: 0; font-size: 18px;">Join the Coven</h2><div id="app_form"><input type="text" id="app_username" class="ie-input" placeholder="Desired Username" maxlength="20"><input type="text" id="app_referral" class="ie-input" placeholder="Who referred you?"><textarea id="app_reason" class="ie-input" placeholder="Why do you seek entry?" style="height: 60px; resize: none;"></textarea><button class="ie-btn" onclick="submitApplication()">ü©∏ Submit Blood Pact</button><button class="ie-btn" style="background: #333; margin-top: 5px;" onclick="checkAppStatus()">Check Status</button></div><div id="app_result" style="display: none;"></div></div></div>
</div>
<div class="window" id="chat_win" style="left:400px; top:30px; width:820px; height:620px;">
    <div class="title-bar"><div class="title-bar-text">ü©∏ The Lounge</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('chat_win')"></button></div></div>
    <div class="window-body">
        <div class="tab-bar"><div class="tab active" onclick="switchChatTab('main', this)">üí¨ Lounge</div><div class="tab" onclick="switchChatTab('avatar', this)">ü¶á My Profile</div></div>
        <div id="chat_main">
            <div id="pinned_container"></div>
            <div class="chat-container" id="chat_container">
                <div id="chat_logs"></div>
                <div id="member_list">
                    <div id="online_member_list" style="padding:8px;"></div>
                </div>
            </div>
            <div id="typing_area" style="padding: 5px 12px; background: #080000; display: none;"><div class="typing-indicator"><span id="typing_user"></span>&nbsp;is typing<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
            <div id="reply_indicator" style="display:none; padding:8px 12px; background:#1a0a0a; border-left:3px solid #d40000;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="color:#888; font-size:10px;">Replying to <span id="reply_to_user" style="color:#d40000;"></span>: <span id="reply_to_text" style="color:#666;"></span></div>
                    <button onclick="cancelReply()" style="background:none; border:none; color:#f00; cursor:pointer; font-size:14px;">‚úï</button>
                </div>
            </div>
            <div style="padding:10px; background:#111;">
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input type="text" id="chat_input" class="ie-input" style="margin:0; flex:1;" placeholder="/help for commands... @username to mention" onkeypress="handleChatKey(event)" onkeyup="handleTyping()">
                    <label class="ie-btn" style="width: 35px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">üìé<input type="file" id="chat_file" accept="image/*,video/*,audio/*,.gif" style="display:none;" onchange="uploadChatFile()"></label>
                </div>
                <button class="ie-btn" onclick="sendChat()">Send</button>
            </div>
        </div>
        <div id="chat_avatar" style="display: none; padding: 20px; overflow-y: auto; height: calc(100% - 40px);">
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="text-align:center;">
                    <div id="my_avatar_wrapper" style="position:relative; width:160px; height:160px; margin:-15px auto 0;">
                        <div id="my_avatar_effect" style="position:absolute; top:-5px; left:-5px; width:170px; height:170px; z-index:0; pointer-events:none; border-radius:50%;"></div>
                        <div id="my_avatar_display" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1; width:130px; height:130px; border-radius:50%; background:#111; border:4px solid #700; display:flex; align-items:center; justify-content:center; font-size:60px; overflow:hidden; box-sizing:content-box;">ü¶á</div>
                        <div id="my_avatar_frame" style="display:none;"></div>
                        <div id="my_avatar_hat" style="display:none;"></div>
                        <div id="my_avatar_accessory" style="display:none;"></div>
                    </div>
                    <div id="my_username_display" style="color:#d40000; font-size:18px; font-weight:bold; margin-top:10px;"></div>
                    <div id="my_rank_display" style="color:#888; font-size:12px;"></div>
                </div>
                <div style="flex:1;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Edit Profile</h3>
                    <label style="color:#888; font-size:10px;">Profile Picture URL</label>
                    <input type="text" id="avatar_url" class="ie-input" placeholder="Paste image URL">
                    <label style="color:#888; font-size:10px;">Or Upload Image</label>
                    <input type="file" id="avatar_upload" class="ie-input" accept="image/*" style="border:none; padding:5px 0;">
                    <button class="ie-btn" style="padding:8px; margin-bottom:15px;" onclick="updateAvatar()">Update Avatar</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr; gap:15px;">
                <div>
                    <label style="color:#888; font-size:10px;">Profile Music (SoundCloud/Spotify URL)</label>
                    <input type="text" id="profile_music" class="ie-input" placeholder="https://soundcloud.com/...">
                    <button class="ie-btn" style="padding:8px;" onclick="updateProfileMusic()">Set Music</button>
                </div>
                <div>
                    <label style="color:#888; font-size:10px;">Mood Status</label>
                    <select id="user_mood" class="ie-input" onchange="saveProfile()">
                        <option value="">None</option><option value="ü©∏ Thirsty">ü©∏ Thirsty</option><option value="üò¥ Dormant">üò¥ Dormant</option><option value="üåô Hunting">üåô Hunting</option><option value="‚ö∞Ô∏è Resting">‚ö∞Ô∏è Resting</option><option value="ü¶á Lurking">ü¶á Lurking</option><option value="üî• Vibing">üî• Vibing</option><option value="üíÄ Dead Inside">üíÄ Dead Inside</option>
                    </select>
                    <label style="color:#888; font-size:10px;">Custom Status</label>
                    <input type="text" id="user_status" class="ie-input" placeholder="What's happening..." maxlength="30">
                    <label style="color:#888; font-size:10px;">Bio</label>
                    <textarea id="user_bio" class="ie-input" placeholder="Tell us about yourself..." maxlength="200" style="height:80px; resize:none;"></textarea>
                    <div id="vip_bg_section" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid #400;">
                        <label style="color:#ffd700; font-size:10px;">‚ú® VIP: Animated Profile Background</label>
                        <input type="text" id="profile_bg" class="ie-input" placeholder="GIF/Image URL or Tenor link">
                        <p style="color:#666; font-size:9px; margin:5px 0;">Supports: Direct image/GIF URLs, Tenor GIF links</p>
                    </div>
                </div>
            </div>
            <button class="ie-btn" style="margin-top:20px; padding:12px; background:#700;" onclick="saveProfile()">üíæ Save All Changes</button>
        </div>
    </div>
</div>
<!-- CLUBS WINDOW -->
<div class="window" id="clubs_window" style="left:150px; top:80px; width:650px; height:500px; display:none;">
    <div class="title-bar"><div class="title-bar-text">üè∞ Clubs</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('clubs_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:100%;">
        <div class="mgmt-sidebar">
            <div class="mgmt-sidebar-item active" onclick="switchClubTab('browse', this)">üîç Browse</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('my', this)">üìã My Clubs</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('create', this)">‚ú® Create</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('invites', this)">üì© Invites</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('manage', this)" id="club_manage_tab" style="display:none;">‚öôÔ∏è Manage</div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:15px; overflow-y:auto;">
            <div id="club_tab_browse">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#d40000; margin:0;">Browse Clubs</h3>
                    <button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0;" onclick="loadAllClubs(); this.textContent='Loading...'; setTimeout(() => this.textContent='üîÑ Refresh', 500);">üîÑ Refresh</button>
                </div>
                <input type="text" id="club_search" class="ie-input" placeholder="Search clubs..." oninput="searchClubs()" style="margin-bottom:10px;">
                <div id="clubs_list" style="min-height:200px; max-height:350px; overflow-y:auto; border:1px solid #300; border-radius:4px; background:#050000; padding:10px;"></div>
            </div>
            <div id="club_tab_my" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#d40000; margin:0;">My Clubs <span style="color:#666; font-size:11px;">(Max 5)</span></h3>
                    <button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0;" onclick="loadMyClubs(); this.textContent='Loading...'; setTimeout(() => this.textContent='üîÑ Refresh', 500);">üîÑ Refresh</button>
                </div>
                <div id="my_clubs_list"></div>
            </div>
            <div id="club_tab_create" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Create a Club</h3>
                <div id="create_club_form">
                    <input type="text" id="new_club_name" class="ie-input" placeholder="Club Name" maxlength="30">
                    <textarea id="new_club_desc" class="ie-input" placeholder="Club Description" maxlength="200" style="height:80px; resize:none;"></textarea>
                    <input type="text" id="new_club_color" class="ie-input" placeholder="Club Color (hex)" value="#d40000">
                    <button class="ie-btn" onclick="createClub()">üè∞ Create Club</button>
                    <div id="create_club_result" style="margin-top:10px; font-size:11px;"></div>
                </div>
                <div id="already_owns_club" style="display:none; color:#888; text-align:center; padding:20px;">
                    <p>You already own a club!</p>
                    <p style="font-size:10px;">Each user can only create one club.</p>
                </div>
            </div>
            <div id="club_tab_invites" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#d40000; margin:0;">Club Invites</h3>
                    <button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0;" onclick="loadClubInvites(); this.textContent='Loading...'; setTimeout(() => this.textContent='üîÑ Refresh', 500);">üîÑ Refresh</button>
                </div>
                <div id="club_invites_list"></div>
            </div>
            <div id="club_tab_manage" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Manage Your Club</h3>
                <div id="manage_club_content"></div>
            </div>
        </div>
    </div>
</div>
<!-- MESSAGES WINDOW -->
<div class="window" id="messages_window" style="left:180px; top:60px; width:700px; height:520px; display:none;">
    <div class="title-bar"><div class="title-bar-text">üí¨ Messages</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('messages_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:100%;">
        <div class="mgmt-sidebar">
            <div class="mgmt-sidebar-item active" onclick="switchMsgTab('dms', this)">üì® DMs</div>
            <div class="mgmt-sidebar-item" onclick="switchMsgTab('groups', this)">üë• Groups</div>
            <div class="mgmt-sidebar-item" onclick="switchMsgTab('friends', this)">ü§ù Friends</div>
            <div class="mgmt-sidebar-item" onclick="switchMsgTab('requests', this)">üì© Requests <span id="friend_req_count" style="color:#f00;"></span></div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:0; overflow:hidden; display:flex; flex-direction:column;">
            <div id="msg_tab_dms" style="flex:1; display:flex; flex-direction:column;">
                <div id="dm_list_view" style="flex:1; overflow-y:auto; padding:15px;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Direct Messages</h3>
                    <div id="dm_conversations" class="dm-list"></div>
                </div>
                <div id="dm_chat_view" style="display:none; flex:1; flex-direction:column;">
                    <div style="padding:10px; background:#0a0000; border-bottom:1px solid #400; display:flex; align-items:center; gap:10px;">
                        <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="closeDMChat()">‚Üê Back</button>
                        <div id="dm_chat_avatar" style="width:30px; height:30px; border-radius:50%; background:#111; border:2px solid #500; display:flex; align-items:center; justify-content:center; font-size:14px; overflow:hidden;">ü¶á</div>
                        <span id="dm_chat_name" style="color:#d40000; font-weight:bold;"></span>
                    </div>
                    <div id="dm_messages" style="flex:1; overflow-y:auto; padding:10px;"></div>
                    <div style="padding:10px; background:#111; border-top:1px solid #400;">
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="text" id="dm_input" class="ie-input" style="margin:0; flex:1;" placeholder="Type a message or paste image/gif URL..." onkeypress="if(event.key==='Enter')sendDM()">
                            <button class="ie-btn" style="width:auto; padding:8px 12px; font-size:11px;" onclick="showDMMediaInput()" title="Send Image/GIF/Video">üìé</button>
                            <button class="ie-btn" style="width:auto; padding:8px 15px;" onclick="sendDM()">Send</button>
                        </div>
                        <div id="dm_media_preview" style="display:none; margin-top:8px; padding:8px; background:#0a0000; border:1px solid #400; border-radius:4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="color:#888; font-size:10px;">Media URL:</span>
                                <button onclick="document.getElementById('dm_media_preview').style.display='none'; document.getElementById('dm_media_url').value='';" style="background:none; border:none; color:#f00; cursor:pointer; font-size:12px;">‚úï</button>
                            </div>
                            <input type="text" id="dm_media_url" class="ie-input" style="margin:0; font-size:10px;" placeholder="Paste image/gif/mp4 URL here...">
                        </div>
                    </div>
                </div>
            </div>
            <div id="msg_tab_groups" style="display:none; flex:1; flex-direction:column;">
                <div id="group_list_view" style="flex:1; overflow-y:auto; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#d40000; margin:0;">Group Chats</h3>
                        <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="showCreateGroup()">+ New Group</button>
                    </div>
                    <div id="group_conversations" class="dm-list"></div>
                </div>
                <div id="group_chat_view" style="display:none; flex:1; flex-direction:column;">
                    <div style="padding:10px; background:#0a0000; border-bottom:1px solid #400; display:flex; align-items:center; gap:10px;">
                        <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="closeGroupChat()">‚Üê Back</button>
                        <span id="group_chat_name" style="color:#d40000; font-weight:bold;"></span>
                        <button class="ie-btn" style="width:auto; padding:5px 10px; margin-left:auto;" onclick="showGroupMembers()">üë•</button>
                    </div>
                    <div id="group_messages" style="flex:1; overflow-y:auto; padding:10px;"></div>
                    <div style="padding:10px; background:#111; border-top:1px solid #400;">
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="text" id="group_input" class="ie-input" style="margin:0; flex:1;" placeholder="Type a message or paste image/gif URL..." onkeypress="if(event.key==='Enter')sendGroupMsg()">
                            <button class="ie-btn" style="width:auto; padding:8px 12px; font-size:11px;" onclick="showGroupMediaInput()" title="Send Image/GIF/Video">üìé</button>
                            <button class="ie-btn" style="width:auto; padding:8px 15px;" onclick="sendGroupMsg()">Send</button>
                        </div>
                        <div id="group_media_preview" style="display:none; margin-top:8px; padding:8px; background:#0a0000; border:1px solid #400; border-radius:4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="color:#888; font-size:10px;">Media URL:</span>
                                <button onclick="document.getElementById('group_media_preview').style.display='none'; document.getElementById('group_media_url').value='';" style="background:none; border:none; color:#f00; cursor:pointer; font-size:12px;">‚úï</button>
                            </div>
                            <input type="text" id="group_media_url" class="ie-input" style="margin:0; font-size:10px;" placeholder="Paste image/gif/mp4 URL here...">
                        </div>
                    </div>
                </div>
                <div id="create_group_view" style="display:none; padding:15px;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Create Group Chat</h3>
                    <input type="text" id="new_group_name" class="ie-input" placeholder="Group Name" maxlength="30">
                    <p style="color:#888; font-size:10px; margin:10px 0 5px 0;">Select friends to add:</p>
                    <div id="group_friend_select" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
                    <button class="ie-btn" onclick="createGroupChat()">Create Group</button>
                    <button class="ie-btn" style="background:#333;" onclick="cancelCreateGroup()">Cancel</button>
                </div>
            </div>
            <div id="msg_tab_friends" style="display:none; flex-direction:column; padding:20px; overflow-y:auto; flex:1;">
                <h3 style="color:#d40000; margin:0 0 15px 0; font-size:16px; flex-shrink:0;">üë• Your Friends</h3>
                <div id="friends_list" style="flex:1; min-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid #400; border-radius:4px; background:#050000;"></div>
                <div style="background:#0a0000; padding:15px; border:1px solid #400; border-radius:6px; flex-shrink:0;">
                    <label style="color:#d40000; font-size:12px; display:block; margin-bottom:8px; font-weight:bold;">‚ûï Add a Friend</label>
                    <input type="text" id="add_friend_input" class="ie-input" placeholder="Enter username..." style="margin-bottom:10px;">
                    <button class="ie-btn" style="width:100%;" onclick="sendFriendRequest()">Send Friend Request</button>
                </div>
            </div>
            <div id="msg_tab_requests" style="display:none; padding:20px; overflow-y:auto; flex:1;">
                <h3 style="color:#d40000; margin:0 0 15px 0; font-size:16px;">üì© Friend Requests</h3>
                <div id="friend_requests_list" style="min-height:100px;"></div>
            </div>
        </div>
    </div>
</div>
<!-- WATCH PARTY -->
<div class="window" id="watchparty_window" style="left:150px; top:30px; width:900px; height:650px; display:none;">
    <div class="title-bar"><div class="title-bar-text">ü©∏ Watch Party</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('watchparty_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:calc(100% - 25px); background:#0a0000; overflow:hidden;">
        <div class="mgmt-sidebar" style="width:180px; background:#050000; border-right:1px solid #500; flex-shrink:0;">
            <div class="mgmt-sidebar-item active" onclick="switchWatchPartyTab('rooms', this)">üé¨ Party Rooms</div>
            <div class="mgmt-sidebar-item" onclick="switchWatchPartyTab('create', this)">‚ûï Create Room</div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:0; overflow:hidden; display:flex; flex-direction:column; background:#0a0000; min-height:0;">
            <div id="wp_tab_rooms" style="flex:1; overflow-y:auto; padding:15px;">
                <h3 style="color:#d40000; margin:0 0 15px 0; text-shadow:0 0 10px rgba(139,0,0,0.5);">üé¨ Active Watch Parties</h3>
                <button class="ie-btn" style="width:auto; padding:5px 15px; margin-bottom:10px;" onclick="loadWatchPartyRooms()">üîÑ Refresh</button>
                <div id="wp_room_list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
            <div id="wp_tab_create" style="display:none; padding:15px; overflow-y:auto;">
                <h3 style="color:#d40000; margin:0 0 15px 0; text-shadow:0 0 10px rgba(139,0,0,0.5);">‚ûï Create Watch Party</h3>
                <input type="text" id="wp_room_name" class="ie-input" placeholder="Room name (e.g., Movie Night)">
                <input type="text" id="wp_video_url" class="ie-input" placeholder="YouTube URL (e.g., https://youtube.com/watch?v=...)">
                <select id="wp_room_type" class="ie-input">
                    <option value="public">üåê Public</option>
                    <option value="private">üîí Private</option>
                </select>
                <button class="ie-btn" onclick="createWatchPartyRoom()">Create Room</button>
                <div id="wp_create_result" style="margin-top:10px; font-size:11px;"></div>
            </div>
            <div id="wp_tab_room" style="display:none; flex:1; flex-direction:column; min-height:0; overflow:hidden;">
                <div style="padding:8px 10px; background:linear-gradient(180deg, #1a0808, #0a0000); border-bottom:2px solid #500; display:flex; align-items:center; gap:10px; flex-shrink:0;">
                    <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="leaveWatchPartyRoom()">‚Üê Leave</button>
                    <span id="wp_room_title" style="color:#d40000; font-weight:bold; text-shadow:0 0 5px rgba(139,0,0,0.5);"></span>
                    <span id="wp_host_badge" style="color:#ffd700; font-size:9px; background:#1a1a00; padding:2px 6px; border-radius:3px; display:none;">üëë HOST</span>
                    <span id="wp_viewer_count" style="color:#888; font-size:10px; margin-left:auto;">üë• 0 watching</span>
                </div>
                <div style="display:flex; flex:1; min-height:0; overflow:hidden;">
                    <div style="flex:1; display:flex; flex-direction:column; background:#000; min-height:0;">
                        <div id="wp_player_container" style="flex:1; display:flex; align-items:center; justify-content:center; background:#000; border:1px solid #300; position:relative; min-height:200px;">
                            <div id="wp_player" style="width:100%; height:100%;"></div>
                            <button id="wp_fullscreen_btn" onclick="wpToggleFullscreen()" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.7); border:1px solid #500; color:#888; padding:5px 10px; font-size:10px; cursor:pointer; border-radius:3px; z-index:10;">‚õ∂ Fullscreen</button>
                        </div>
                        <div id="wp_controls" style="padding:8px; background:linear-gradient(180deg, #0a0000, #050000); border-top:1px solid #500; display:flex; gap:8px; align-items:center; flex-shrink:0;">
                            <button class="ie-btn wp-host-only" style="width:auto; padding:4px 12px; font-size:11px;" onclick="wpTogglePlay()" id="wp_play_btn">‚ñ∂Ô∏è</button>
                            <input type="range" id="wp_seek" min="0" max="100" value="0" style="flex:1; accent-color:#d40000;" class="wp-host-only">
                            <span id="wp_time" style="color:#666; font-size:9px; min-width:70px;">0:00 / 0:00</span>
                            <button class="ie-btn" style="width:auto; padding:4px 8px; font-size:10px;" onclick="wpSyncToHost()" title="Sync to host">üîÑ Sync</button>
                        </div>
                    </div>
                    <div style="width:220px; display:flex; flex-direction:column; border-left:2px solid #500; background:#050000; min-height:0; flex-shrink:0;">
                        <div style="padding:6px 8px; background:#0a0000; border-bottom:1px solid #400; flex-shrink:0;">
                            <div style="color:#888; font-size:9px; margin-bottom:4px;">üë• WATCHING</div>
                            <div id="wp_viewer_list" style="display:flex; flex-wrap:wrap; gap:4px; max-height:40px; overflow-y:auto; font-size:9px;"></div>
                        </div>
                        <div style="padding:8px; background:linear-gradient(180deg, #1a0808, #0a0000); border-bottom:1px solid #500; color:#d40000; font-size:10px; font-weight:bold; flex-shrink:0;">üí¨ Party Chat</div>
                        <div id="wp_chat_messages" style="flex:1; overflow-y:auto; padding:8px; font-size:10px; background:#030000; min-height:0;"></div>
                        <div style="padding:8px; background:#0a0000; border-top:1px solid #500; flex-shrink:0;">
                            <div style="display:flex; gap:4px;">
                                <input type="text" id="wp_chat_input" class="ie-input" style="margin:0; flex:1; font-size:9px; padding:5px;" placeholder="Chat..." onkeypress="if(event.key==='Enter')sendWPChat()">
                                <button class="ie-btn" style="width:auto; padding:4px 8px; font-size:9px;" onclick="sendWPChat()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ADMIN PANEL -->
<div class="window" id="admin_window" style="left:100px; top:40px; width:750px; height:550px; display:none;">
    <div class="title-bar"><div class="title-bar-text">üëë Admin Control Panel</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('admin_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:calc(100% - 32px);">
        <div class="mgmt-sidebar">
            <div class="mgmt-sidebar-item active" id="admin_tab_apps_btn" onclick="switchAdminTab('apps', this)">üìù Applications</div>
            <div class="mgmt-sidebar-item" id="admin_tab_members_btn" onclick="switchAdminTab('members', this)">üë• Members</div>
            <div class="mgmt-sidebar-item" id="admin_tab_moderation_btn" onclick="switchAdminTab('moderation', this)">‚ö†Ô∏è Moderation</div>
            <div class="mgmt-sidebar-item" id="admin_tab_announcements_btn" onclick="switchAdminTab('announcements', this)">üìå Announcements</div>
            <div class="mgmt-sidebar-item" id="admin_tab_bot_btn" onclick="switchAdminTab('bot', this)">üßõ Eric Bot</div>
            <div class="mgmt-sidebar-item" id="admin_tab_videos_btn" onclick="switchAdminTab('videos', this)">üìπ Videos</div>
            <div class="mgmt-sidebar-item" id="admin_tab_vip_btn" onclick="switchAdminTab('vip', this)">üåü VIP Codes</div>
            <div class="mgmt-sidebar-item" id="admin_tab_sitetools_btn" style="display:none;" onclick="switchAdminTab('sitetools', this)">üéõÔ∏è Site Tools</div>
            <div class="mgmt-sidebar-item" id="st_tab" style="display:none;" onclick="switchAdminTab('st', this)">ST Tools</div>
            <div class="mgmt-sidebar-item" id="st_tab2" style="display:none;" onclick="switchAdminTab('st2', this)">ST Shop</div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:15px; overflow-y:auto; max-height:100%;">
            <div id="admin_tab_apps"><h3 style="color:#d40000; margin:0 0 15px 0;">Membership Applications</h3><div style="display:flex; gap:10px; margin-bottom:15px;"><select id="app_filter" class="ie-input" style="width:150px; margin:0;" onchange="loadAllApplications()"><option value="all">All</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="denied">Denied</option></select><input type="text" id="app_search" class="ie-input" placeholder="Search username..." style="flex:1; margin:0;" oninput="loadAllApplications()"></div><div id="all_applications" style="max-height:380px; overflow-y:auto;"></div></div>
            <div id="admin_tab_members" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">All Members</h3><div id="all_members" style="max-height:420px; overflow-y:auto;"></div></div>
            <div id="admin_tab_moderation" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">User Moderation</h3><div class="admin-section"><h4>Take Action</h4><input type="text" id="mod_username" class="ie-input" placeholder="Username to moderate..."><select id="mod_action" class="ie-input"><option value="">Select Action...</option><option value="warn">‚ö†Ô∏è Warn</option><option value="mute">üîá Mute (can't chat)</option><option value="timeout">‚è±Ô∏è Timeout (can't chat)</option><option value="kick">üë¢ Kick (offline)</option><option value="softban">üö´ Soft Ban</option><option value="hardban">‚õî Hard Ban</option><option value="unmute">üîä Unmute</option></select><select id="mod_duration" class="ie-input"><option value="5">5 minutes</option><option value="15">15 minutes</option><option value="30">30 minutes</option><option value="60">1 hour</option><option value="360">6 hours</option><option value="1440">24 hours</option><option value="10080">7 days</option><option value="43200">30 days</option><option value="0">Permanent</option></select><input type="text" id="mod_reason" class="ie-input" placeholder="Reason (optional)"><button class="ie-btn" style="background: #700;" onclick="executeModAction()">Execute Action</button><div id="mod_result" style="margin-top: 5px; font-size: 10px;"></div></div><div class="admin-section"><h4>üóëÔ∏è Delete Message</h4><input type="text" id="delete_msg_id" class="ie-input" placeholder="Message ID (from chat 3-dot menu)"><button class="ie-btn" style="background:#700;" onclick="deleteMessageById()">Delete Message</button><div id="delete_msg_result" style="margin-top:5px; font-size:10px;"></div></div><div class="admin-section"><h4>üîá Muted Users</h4><button class="ie-btn" style="width:auto; padding:5px 10px; margin-bottom:5px;" onclick="loadMutedUsers()">üîÑ Refresh</button><div id="muted_users" style="max-height:100px; overflow-y:auto; font-size:10px;">Click refresh to load...</div></div><div class="admin-section"><h4>üö´ Banned/Suspended Users</h4><div id="banned_users" style="max-height:150px; overflow-y:auto; font-size:10px;">None</div></div></div>
            <div id="admin_tab_announcements" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">Lounge Announcements</h3><div class="admin-section"><h4>Pin Message</h4><input type="text" id="pin_message" class="ie-input" placeholder="Message to pin in the lounge..."><div style="display:flex; gap:10px;"><button class="ie-btn" style="flex:1;" onclick="pinMessage()">üìå Pin Message</button><button class="ie-btn" style="flex:1; background:#333;" onclick="clearPin()">Clear Pin</button></div></div><div class="admin-section"><h4>Chat Management</h4><button class="ie-btn" style="background: #500;" onclick="clearChat()">üóëÔ∏è Clear All Messages</button><button class="ie-btn" style="background: #333; margin-top:5px;" onclick="exportChat()">üì• Export Chat Log</button></div></div>
            <div id="admin_tab_bot" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">Eric Northman Bot</h3><div class="admin-section"><h4>Send as Eric</h4><textarea id="bot_message" class="ie-input" placeholder="Eric says..." style="height:80px; resize:none;"></textarea><button class="ie-btn" onclick="sendBotMessage()">üßõ Send Message</button></div></div>
            <div id="admin_tab_videos" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Video Archive Management</h3>
                <button class="ie-btn" style="margin-bottom:15px; width:auto; padding:8px 15px;" onclick="loadAllVideos()">üîÑ Refresh Videos</button>
                <div id="all_videos" style="max-height:380px; overflow-y:auto;"></div>
            </div>
            <div id="admin_tab_vip" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">VIP Invite Codes</h3><div class="admin-section"><h4>Generate New Code</h4><div style="display:flex; gap:5px; margin-bottom:10px;"><input type="number" id="vip_code_uses" class="ie-input" placeholder="Max uses" value="5" min="1" max="100" style="width:100px;"><button class="ie-btn" style="flex:1;" onclick="generateVIPCode()">üåü Generate New Code</button></div><div id="vip_code_display" style="color:#ffd700; font-family:monospace; font-size:16px;"></div></div><div class="admin-section"><h4>Active VIP Codes</h4><button class="ie-btn" style="width:auto; padding:5px 15px; margin-bottom:10px;" onclick="loadVIPCodeHistory()">üîÑ Refresh</button><div id="vip_code_history" style="max-height:300px; overflow-y:auto; font-size:11px;"><div style="color:#666;">Click refresh to load codes...</div></div></div></div>
            
            <!-- SITE TOOLS (Admin+) -->
            <div id="admin_tab_sitetools" style="display:none;">
                <h3 style="color:#ffd700; margin:0 0 15px 0;">üéõÔ∏è Site Tools (Admin+)</h3>
                
                <div class="admin-section" style="border-color:#ffd700;">
                    <h4 style="color:#ffd700;">üéµ Site-Wide Music Player</h4>
                    <p style="font-size:10px; color:#888; margin-bottom:10px;">Play music for ALL users on the site (YouTube or SoundCloud)</p>
                    <input type="text" id="sitemusic_url" class="ie-input" placeholder="YouTube or SoundCloud URL...">
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="ie-btn" style="flex:1; background:#050;" onclick="playSiteMusic()">‚ñ∂Ô∏è Play for Everyone</button>
                        <button class="ie-btn" style="flex:1; background:#500;" onclick="stopSiteMusic()">‚èπÔ∏è Stop Music</button>
                    </div>
                    <div id="sitemusic_result" style="margin-top:5px; font-size:10px;"></div>
                    <div id="sitemusic_current" style="margin-top:10px; padding:8px; background:#050000; border:1px solid #300; border-radius:4px; font-size:10px; color:#888;">No music playing</div>
                </div>
                
                <div class="admin-section" style="border-color:#ffd700;">
                    <h4 style="color:#ffd700;">‚≠ê Manage Reputation</h4>
                    <input type="text" id="admin_rep_username" class="ie-input" placeholder="Username">
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="number" id="admin_rep_amount" class="ie-input" placeholder="Amount" value="1" min="1" max="100" style="width:80px;">
                        <button class="ie-btn" style="flex:1; background:#050;" onclick="adminModifyRep(1)">‚ûï Add Rep</button>
                        <button class="ie-btn" style="flex:1; background:#500;" onclick="adminModifyRep(-1)">‚ûñ Remove Rep</button>
                    </div>
                    <div id="admin_rep_result" style="margin-top:5px; font-size:10px;"></div>
                </div>
                
                <div class="admin-section" style="border-color:#ffd700;">
                    <h4 style="color:#ffd700;">üèÖ Award Badge</h4>
                    <input type="text" id="admin_badge_username" class="ie-input" placeholder="Username">
                    <select id="admin_badge_select" class="ie-input">
                        <option value="">-- Select Badge --</option>
                    </select>
                    <button class="ie-btn" style="width:auto; padding:5px 10px; margin:5px 0;" onclick="loadAdminBadgeOptions()">üîÑ Refresh Badges</button>
                    <input type="text" id="admin_badge_submission" class="ie-input" placeholder="Submission URL (optional - image that earned badge)">
                    <div style="display:flex; gap:5px;">
                        <button class="ie-btn" style="flex:1; background:#050;" onclick="adminAssignBadge()">üèÖ Award Badge</button>
                        <button class="ie-btn" style="flex:1; background:#500;" onclick="adminRemoveBadge()">‚ùå Remove Badge</button>
                    </div>
                    <div id="admin_badge_result" style="margin-top:5px; font-size:10px;"></div>
                </div>
                
                <!-- USER MANAGEMENT (Admin+) -->
                <div style="margin-top:15px; border:2px solid #ffd700; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #3a3000, #252000); padding:10px 15px; color:#ffd700; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üë§ USER MANAGEMENT <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a0a00; display:none;">
                        <div class="admin-section" style="border-color:#ffd700; margin-bottom:10px;">
                            <h4 style="color:#ffd700;">Change Username</h4>
                            <input type="text" id="admin_old_username" class="ie-input" placeholder="Current username">
                            <input type="text" id="admin_new_username" class="ie-input" placeholder="New username">
                            <button class="ie-btn" style="background:#4a4a00; border-color:#ffd700;" onclick="adminChangeUsername()">Change Username</button>
                            <div id="admin_username_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ffd700; margin-bottom:10px;">
                            <h4 style="color:#ffd700;">Create New User</h4>
                            <input type="text" id="admin_create_username" class="ie-input" placeholder="Username">
                            <input type="text" id="admin_create_password" class="ie-input" placeholder="Password">
                            <select id="admin_create_rank" class="ie-input">
                                <option value="member">Member</option>
                                <option value="vip">VIP</option>
                                <option value="contrib">Contributor</option>
                            </select>
                            <button class="ie-btn" style="background:#4a4a00; border-color:#ffd700;" onclick="adminCreateUser()">Create User</button>
                            <div id="admin_create_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ffd700; margin-bottom:10px;">
                            <h4 style="color:#ffd700;">User Lookup</h4>
                            <input type="text" id="admin_lookup_username" class="ie-input" placeholder="Username">
                            <button class="ie-btn" style="background:#4a4a00; border-color:#ffd700;" onclick="adminLookupUser()">Lookup</button>
                            <div id="admin_lookup_result" style="margin-top:5px; font-size:10px; max-height:150px; overflow-y:auto;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ffd700;">
                            <h4 style="color:#ffd700;">Reset Password</h4>
                            <input type="text" id="admin_reset_username" class="ie-input" placeholder="Username">
                            <input type="text" id="admin_new_password" class="ie-input" placeholder="New password">
                            <button class="ie-btn" style="background:#4a4a00; border-color:#ffd700;" onclick="adminResetPassword()">Reset Password</button>
                            <div id="admin_password_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="admin_tab_st" style="display:none;">
                <h3 style="color:#ff00ff; margin:0 0 15px 0;">Site Technician Tools</h3>
                
                <!-- SECTION: SYSTEM CONTROLS -->
                <div style="margin-bottom:20px; border:2px solid #ff0000; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #500000, #300000); padding:10px 15px; color:#ff0000; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ‚ö†Ô∏è SYSTEM CONTROLS <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#1a0000;">
                        <div class="admin-section" style="border-color:#ff0000; margin-bottom:10px;">
                            <h4 style="color:#ff0000;">Maintenance Mode</h4>
                            <p style="color:#888; font-size:10px; margin-bottom:10px;">When enabled, non-ST users see a maintenance screen. They stay connected but can't use the site.</p>
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                                <span id="maintenance_status" style="color:#0f0; font-size:12px;">Status: OFF</span>
                            </div>
                            <input type="text" id="maintenance_message" class="ie-input" placeholder="Maintenance message (optional)" value="We're performing scheduled maintenance. Please check back soon!">
                            <input type="text" id="maintenance_music" class="ie-input" placeholder="Music URL (YouTube or SoundCloud link)" style="margin-top:5px;">
                            <p style="color:#666; font-size:9px; margin:3px 0;">Plays on the maintenance screen for non-ST users</p>
                            <div style="display:flex; gap:5px;">
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#f00;" onclick="toggleMaintenanceMode(true)">Enable Maintenance</button>
                                <button class="ie-btn" style="flex:1; background:#050; border-color:#0f0;" onclick="toggleMaintenanceMode(false)">Disable Maintenance</button>
                            </div>
                            <div id="maintenance_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: USER MANAGEMENT -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üë§ USER MANAGEMENT <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Change Username</h4>
                            <input type="text" id="st_old_username" class="ie-input" placeholder="Current username">
                            <input type="text" id="st_new_username" class="ie-input" placeholder="New username">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stChangeUsername()">Change Username</button>
                            <div id="st_username_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Create New User</h4>
                            <input type="text" id="st_create_username" class="ie-input" placeholder="Username">
                            <input type="text" id="st_create_password" class="ie-input" placeholder="Password">
                            <select id="st_create_rank" class="ie-input">
                                <option value="member">Member</option>
                                <option value="vip">VIP</option>
                                <option value="contrib">Contributor</option>
                                <option value="mod">Moderator</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stCreateUser()">Create User</button>
                            <div id="st_create_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">User Lookup</h4>
                            <input type="text" id="st_lookup_username" class="ie-input" placeholder="Username">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stLookupUser()">Lookup</button>
                            <div id="st_lookup_result" style="margin-top:5px; font-size:10px; max-height:150px; overflow-y:auto;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">User Data Management</h4>
                            <input type="text" id="st_data_username" class="ie-input" placeholder="Username">
                            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stWipeProfile()">Wipe Profile</button>
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stWipeMessages()">Wipe Messages</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stDeleteUser()">Delete User</button>
                            </div>
                            <div id="st_data_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: ROLES & PERMISSIONS -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üîê ROLES & PERMISSIONS <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Change User Rank</h4>
                            <input type="text" id="elevate_user" class="ie-input" placeholder="Username">
                            <select id="elevate_rank" class="ie-input">
                                <option value="member">Member (M)</option>
                                <option value="vip">VIP</option>
                                <option value="contrib">Contributor (K)</option>
                                <option value="mod">Moderator (MOD)</option>
                                <option value="admin">Admin (A)</option>
                            </select>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="elevateUser()">Set Rank</button>
                            <div id="st_elevate_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Set User Permissions</h4>
                            <input type="text" id="perm_user" class="ie-input" placeholder="Username">
                            <select id="perm_preset" class="ie-input" onchange="applyPermissionPreset()">
                                <option value="">-- Select Preset --</option>
                                <option value="none">No Special Permissions</option>
                                <option value="vip_perks">VIP Perks Only</option>
                                <option value="moderator">Moderator Powers</option>
                                <option value="admin">Full Admin</option>
                                <option value="custom">Custom</option>
                            </select>
                            <div style="background:#050000; padding:10px; border:1px solid #400; border-radius:4px; margin:5px 0;">
                                <label style="color:#888; font-size:11px; display:flex; align-items:center; gap:8px; padding:5px 0;"><input type="checkbox" id="perm_mod"> Moderator Powers</label>
                                <label style="color:#888; font-size:11px; display:flex; align-items:center; gap:8px; padding:5px 0;"><input type="checkbox" id="perm_admin"> Admin Access</label>
                                <label style="color:#888; font-size:11px; display:flex; align-items:center; gap:8px; padding:5px 0;"><input type="checkbox" id="perm_vip_perks"> VIP Perks</label>
                            </div>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="setUserPermissions()">Set Permissions</button>
                            <div id="st_perm_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Reset Password</h4>
                            <input type="text" id="st_reset_username" class="ie-input" placeholder="Username">
                            <input type="text" id="st_new_password" class="ie-input" placeholder="New password">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stResetPassword()">Reset Password</button>
                            <div id="st_password_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: SECURITY (Simplified) -->
                <div style="margin-bottom:20px; border:2px solid #ff0000; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #400000, #200000); padding:10px 15px; color:#ff0000; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üîí SECURITY <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a0000; display:none;">
                        <div class="admin-section" style="border-color:#ff0000; margin-bottom:10px;">
                            <h4 style="color:#ff0000;">Force Logout User</h4>
                            <p style="color:#666; font-size:9px; margin-bottom:10px;">Force a user to logout from all sessions</p>
                            <input type="text" id="st_force_logout_user" class="ie-input" placeholder="Username">
                            <button class="ie-btn" style="background:#700000; border-color:#ff0000;" onclick="stForceLogoutUser()">Force Logout</button>
                            <div id="st_force_logout_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff0000; margin-bottom:10px;">
                            <h4 style="color:#ff0000;">Security Logs</h4>
                            <button class="ie-btn" style="background:#500000; border-color:#ff0000; margin-bottom:10px;" onclick="loadSecurityLogs()">üîÑ Load Security Logs</button>
                            <div id="st_security_logs" style="max-height:200px; overflow-y:auto; font-size:9px; background:#050000; padding:8px; border:1px solid #400; border-radius:4px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff0000;">
                            <h4 style="color:#ff0000;">Active Sessions</h4>
                            <button class="ie-btn" style="background:#500000; border-color:#ff0000; margin-bottom:10px;" onclick="loadActiveSessions()">üîÑ Load Sessions</button>
                            <div id="st_active_sessions" style="max-height:200px; overflow-y:auto; font-size:9px; background:#050000; padding:8px; border:1px solid #400; border-radius:4px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ffd700; margin-top:10px;">
                            <h4 style="color:#ffd700;">üîß Data Recovery</h4>
                            <p style="color:#666; font-size:9px; margin-bottom:10px;">Recover user data from duplicate/case-mismatch accounts</p>
                            <input type="text" id="st_recover_from" class="ie-input" placeholder="Source username (e.g. k)">
                            <input type="text" id="st_recover_to" class="ie-input" placeholder="Target username (e.g. K)">
                            <button class="ie-btn" style="background:#555000; border-color:#ffd700;" onclick="stRecoverUserData()">üîÑ Recover Data</button>
                            <div id="st_recover_result" style="margin-top:5px; font-size:10px;"></div>
                            <div style="margin-top:10px; padding:8px; background:#1a1a00; border:1px solid #554400; border-radius:4px;">
                                <div style="color:#ffd700; font-size:10px; margin-bottom:5px;">Quick Fix: Recover K's Data</div>
                                <button class="ie-btn" style="background:#554400; border-color:#ffd700; font-size:9px;" onclick="recoverKData()">üîÑ Recover K from k</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: SYSTEM CONTROLS -->
                <div style="margin-bottom:20px; border:2px solid #00ffff; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #003030, #002020); padding:10px 15px; color:#00ffff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ‚öôÔ∏è SYSTEM CONTROLS <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#000a0a; display:none;">
                        <div class="admin-section" style="border-color:#00ffff; margin-bottom:10px;">
                            <h4 style="color:#00ffff;">üîÑ Push Site Update</h4>
                            <p style="color:#666; font-size:9px; margin-bottom:10px;">Force all users to refresh and show update notification</p>
                            <input type="text" id="st_update_message" class="ie-input" placeholder="Update message (e.g. 'New features added!')">
                            <button class="ie-btn" style="background:#005050; border-color:#00ffff;" onclick="triggerSiteRefresh()">üîÑ Push Update to All Users</button>
                            <div id="st_refresh_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#00ffff;">
                            <h4 style="color:#00ffff;">üìä Site Status</h4>
                            <button class="ie-btn" style="background:#005050; border-color:#00ffff; margin-bottom:10px;" onclick="loadSiteStatus()">üîÑ Load Status</button>
                            <div id="st_site_status" style="font-size:10px; background:#001515; padding:8px; border:1px solid #004040; border-radius:4px;">Click to load...</div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: TAGS -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üè∑Ô∏è TAGS <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Custom User Tags (Chat)</h4>
                            <input type="text" id="st_tag_username" class="ie-input" placeholder="Username">
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="st_tag_letter" class="ie-input" placeholder="Tag text" style="width:100px;">
                                <input type="text" id="st_tag_color" class="ie-input" placeholder="Color (hex)" style="flex:1;" value="#ff00ff">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stSetCustomTag()">Set Tag</button>
                                <button class="ie-btn" style="flex:1; background:#333; border-color:#ff00ff;" onclick="stRemoveCustomTag()">Remove Tag</button>
                            </div>
                            <div id="st_tag_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Club Chat Tags</h4>
                            <p style="color:#666; font-size:9px; margin-bottom:10px;">Tags shown in chat for club members</p>
                            <input type="text" id="st_clubtag_club" class="ie-input" placeholder="Club name">
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="st_clubtag_tag" class="ie-input" placeholder="Tag text" style="flex:1;">
                                <input type="text" id="st_clubtag_color" class="ie-input" placeholder="Color" value="#d40000" style="width:100px;">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stSetClubTag()">Set Tag</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stRemoveClubTag()">Remove</button>
                            </div>
                            <input type="text" id="st_clubtag_remove" class="ie-input" placeholder="Club name to remove" style="margin-top:5px;">
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin-top:5px;" onclick="loadClubTagsList()">üîÑ Refresh List</button>
                            <div id="st_clubtags_list" style="max-height:100px; overflow-y:auto; font-size:10px; background:#050000; padding:8px; border:1px solid #400; border-radius:4px; margin-top:5px;"></div>
                            <div id="st_clubtag_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Memberlist Tags</h4>
                            <p style="color:#666; font-size:9px; margin-bottom:10px;">Tags shown in the chatroom memberlist (club-based)</p>
                            <input type="text" id="st_mltag_club" class="ie-input" placeholder="Club name">
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="st_mltag_tag" class="ie-input" placeholder="Tag text" style="flex:1;">
                                <input type="text" id="st_mltag_color" class="ie-input" placeholder="Color" value="#6a03b4" style="width:100px;">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stSetMemberlistTag()">Set Tag</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stRemoveMemberlistTag()">Remove</button>
                            </div>
                            <input type="text" id="st_mltag_remove" class="ie-input" placeholder="Club name to remove" style="margin-top:5px;">
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin-top:5px;" onclick="loadMemberlistTagsList()">üîÑ Refresh List</button>
                            <div id="st_mltags_list" style="max-height:100px; overflow-y:auto; font-size:10px; background:#050000; padding:8px; border:1px solid #400; border-radius:4px; margin-top:5px;"></div>
                            <div id="st_mltag_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: BADGES -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üéñÔ∏è BADGES <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Create New Badge</h4>
                            <input type="text" id="st_new_badge_id" class="ie-input" placeholder="Badge ID (no spaces, e.g. cool_guy)">
                            <input type="text" id="st_new_badge_name" class="ie-input" placeholder="Display Name (e.g. Cool Guy)">
                            <input type="text" id="st_new_badge_desc" class="ie-input" placeholder="Description (shown on hover)">
                            <div style="margin:8px 0;">
                                <label style="color:#888; font-size:10px; display:block; margin-bottom:5px;">Badge Image</label>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <input type="file" id="st_badge_upload" accept="image/*" style="flex:1; color:#888; font-size:10px;">
                                    <span style="color:#666; font-size:9px;">OR</span>
                                    <input type="text" id="st_badge_url" class="ie-input" placeholder="Image URL" style="flex:2; margin:0;">
                                </div>
                            </div>
                            <div id="st_badge_preview" style="display:none; text-align:center; padding:10px; background:#050000; border:1px solid #400; border-radius:4px; margin:8px 0;">
                                <img id="st_badge_preview_img" style="width:50px; height:50px; border-radius:4px; border:2px solid #500;">
                                <div style="color:#888; font-size:9px; margin-top:5px;">Preview</div>
                            </div>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stCreateBadge()">Create Badge</button>
                            <div id="st_create_badge_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Assign Badge to User</h4>
                            <input type="text" id="st_badge_username" class="ie-input" placeholder="Username">
                            <select id="st_badge_select" class="ie-input">
                                <option value="">-- Select Badge --</option>
                                <option value="happy_merchant">Happy Merchant</option>
                                <option value="mossad_agent">Mossad Agent</option>
                                <option value="israeli_citizen">Israeli Citizen</option>
                                <option value="nazi_party">Nazi Party</option>
                            </select>
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin:5px 0;" onclick="loadBadgeSelectOptions()">üîÑ Refresh Badges</button>
                            <input type="text" id="st_badge_submission" class="ie-input" placeholder="Submission URL (optional - image that earned badge)">
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stAssignBadge()">Assign Badge</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stRemoveBadge()">Remove Badge</button>
                            </div>
                            <div id="st_badge_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Delete Badge</h4>
                            <select id="st_delete_badge_select" class="ie-input">
                                <option value="">-- Select Badge to Delete --</option>
                                <option value="happy_merchant">Happy Merchant</option>
                                <option value="mossad_agent">Mossad Agent</option>
                                <option value="israeli_citizen">Israeli Citizen</option>
                                <option value="nazi_party">Nazi Party</option>
                            </select>
                            <button class="ie-btn" style="background:#700; border-color:#ff00ff; margin-top:5px;" onclick="stDeleteBadge()">Delete Badge</button>
                            <div id="st_delete_badge_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Badge Library</h4>
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin-bottom:10px;" onclick="loadBadgeLibrary()">üîÑ Refresh Library</button>
                            <div id="st_badge_library" style="display:flex; flex-wrap:wrap; gap:10px; background:#050000; padding:10px; border:1px solid #400; border-radius:4px; min-height:60px;">
                                <div style="color:#666; font-size:10px; width:100%; text-align:center;">Click refresh to load badges...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: CLUBS -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üè∞ CLUB MANAGEMENT <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a000a; display:none;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Create New Club</h4>
                            <input type="text" id="st_club_name" class="ie-input" placeholder="Club name">
                            <input type="text" id="st_club_owner" class="ie-input" placeholder="Owner username">
                            <input type="text" id="st_club_color" class="ie-input" placeholder="Color (hex)" value="#d40000">
                            <textarea id="st_club_desc" class="ie-input" placeholder="Description..." style="height:50px; resize:none;"></textarea>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stCreateClub()">Create Club</button>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Transfer Ownership</h4>
                            <input type="text" id="st_transfer_club" class="ie-input" placeholder="Club name">
                            <input type="text" id="st_transfer_to" class="ie-input" placeholder="New owner username">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stTransferClub()">Transfer</button>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Rename Club</h4>
                            <input type="text" id="st_rename_club_old" class="ie-input" placeholder="Current club name">
                            <input type="text" id="st_rename_club_new" class="ie-input" placeholder="New club name">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stRenameClub()">Rename</button>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Delete Club</h4>
                            <input type="text" id="st_delete_club" class="ie-input" placeholder="Club name to delete">
                            <button class="ie-btn" style="background:#700; border-color:#ff00ff;" onclick="stDeleteClub()">Delete Club</button>
                        </div>
                        <div id="st_club_result" style="margin-top:5px; font-size:10px;"></div>
                    </div>
                </div>
                
                <!-- SECTION: ANNOUNCEMENTS & REPUTATION -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        üì¢ ANNOUNCEMENTS & REP <span style="float:right; font-size:10px;">‚ñº</span>
                    </div>
                    <div style="padding:15px; background:#0a000a; display:none;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Site-Wide Announcement</h4>
                            <input type="text" id="st_announce_title" class="ie-input" placeholder="Title (optional)">
                            <textarea id="st_announce_text" class="ie-input" placeholder="Message..." style="height:60px; resize:none;"></textarea>
                            <input type="text" id="st_announce_image" class="ie-input" placeholder="Image URL (optional)">
                            <input type="text" id="st_announce_music" class="ie-input" placeholder="YouTube/SoundCloud URL (optional)">
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <select id="st_announce_type" class="ie-input" style="flex:1;">
                                    <option value="info">‚ÑπÔ∏è Info</option>
                                    <option value="update">üÜï Update</option>
                                    <option value="warning">‚ö†Ô∏è Warning</option>
                                    <option value="event">üéâ Event</option>
                                </select>
                                <input type="number" id="st_announce_duration" class="ie-input" style="width:60px;" value="10" min="5" max="120">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="sendSiteAnnouncement()">Send</button>
                                <button class="ie-btn" style="width:auto; background:#333; border-color:#ff00ff;" onclick="previewAnnouncement()">Preview</button>
                            </div>
                            <div id="st_announce_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Reputation Management</h4>
                            <input type="text" id="st_rep_username" class="ie-input" placeholder="Username">
                            <div style="display:flex; gap:5px;">
                                <input type="number" id="st_rep_amount" class="ie-input" placeholder="Amount" style="flex:1;">
                                <button class="ie-btn" style="width:auto; background:#030; border-color:#0f0;" onclick="stModifyRep(1)">+ Add</button>
                                <button class="ie-btn" style="width:auto; background:#300; border-color:#f00;" onclick="stModifyRep(-1)">- Sub</button>
                            </div>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff; margin-top:5px;" onclick="stSetRep()">Set Exact Rep</button>
                            <div id="st_rep_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Admin Comment</h4>
                            <input type="text" id="st_comment_username" class="ie-input" placeholder="Target username">
                            <textarea id="st_comment_text" class="ie-input" placeholder="Comment..." style="height:50px; resize:none;"></textarea>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stLeaveComment()">Post Comment</button>
                            <div id="st_comment_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ffd700; background:linear-gradient(180deg, #1a1500, #0a0800);">
                            <h4 style="color:#ffd700;">üì® Message to Admins</h4>
                            <p style="font-size:9px; color:#888; margin:0 0 8px 0;">Send a private message to all Admins. They'll see it when online.</p>
                            <textarea id="st_admin_msg_text" class="ie-input" placeholder="Message to admins..." style="height:60px; resize:none;"></textarea>
                            <select id="st_admin_msg_priority" class="ie-input">
                                <option value="normal">üìã Normal</option>
                                <option value="important">‚ö†Ô∏è Important</option>
                                <option value="urgent">üö® Urgent</option>
                            </select>
                            <button class="ie-btn" style="background:#4a4a00; border-color:#ffd700; margin-top:5px;" onclick="sendAdminMessage()">üì® Send to Admins</button>
                            <div id="st_admin_msg_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- ST TOOLS PAGE 2 - TOKEN/SHOP MANAGEMENT -->
            <div id="admin_tab_st2" style="display:none;">
                <h3 style="color:#ff00ff; margin:0 0 15px 0;">ST Shop & Token Management</h3>
                
                <div class="admin-section" style="border-color:#ff00ff; margin-bottom:15px;">
                    <h4 style="color:#ff00ff;">Add Shop Item</h4>
                    <input type="text" id="shop_item_name" class="ie-input" placeholder="Item Name">
                    <input type="number" id="shop_item_price" class="ie-input" placeholder="Price (tokens)" min="1">
                    <select id="shop_item_type" class="ie-input">
                        <option value="effect">Effect (CSS glow)</option>
                        <option value="badge">Badge</option>
                    </select>
                    <div id="shop_add_effect_opts" style="display:none; margin-top:5px;">
                        <select id="shop_item_effectclass" class="ie-input">
                            <option value="">-- Select Effect --</option>
                            <option value="blood-glow">Blood Glow</option>
                            <option value="hellfire">Hellfire</option>
                            <option value="phantom">Phantom</option>
                            <option value="toxic">Toxic</option>
                            <option value="void">Void</option>
                            <option value="rainbow">Rainbow</option>
                            <option value="glitch">Glitch</option>
                            <option value="golden">Golden</option>
                            <option value="beautiful-mind">Beautiful Mind</option>
                        </select>
                        <p style="color:#666; font-size:9px; margin:3px 0;">Effects use CSS animations ‚Äî no image needed.</p>
                    </div>
                    <div id="shop_add_image_section" style="margin-top:5px;">
                        <label style="display:block; color:#888; font-size:9px; margin-bottom:3px;">Upload Image (or paste URL):</label>
                        <input type="file" id="shop_item_file" accept="image/*" style="color:#888; font-size:10px; margin-bottom:5px; display:block;">
                        <input type="text" id="shop_item_image" class="ie-input" placeholder="...or paste image URL / base64">
                    </div>
                    <div id="shop_add_preview" style="display:none; margin-top:8px; padding:8px; background:#050005; border:1px solid #500050; border-radius:4px; text-align:center;">
                        <p style="color:#888; font-size:9px; margin-bottom:5px;">PREVIEW</p>
                        <div id="shop_add_preview_container" style="display:inline-block; position:relative; width:160px; height:160px;">
                            <div id="shop_add_preview_avatar" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:130px; height:130px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:40px; overflow:hidden; z-index:1;">ü¶á</div>
                        </div>
                    </div>
                    <button class="ie-btn" style="background:#500050; border-color:#ff00ff; margin-top:8px;" onclick="stAddShopItem()">Add Item to Shop</button>
                    <div id="shop_add_result" style="margin-top:5px; font-size:10px;"></div>
                </div>
                
                <div class="admin-section" style="border-color:#ff00ff; margin-bottom:15px;">
                    <h4 style="color:#ff00ff;">Bulk Upload Items</h4>
                    <p style="color:#888; font-size:9px; margin:0 0 8px 0;">Upload multiple images. File names become item names. Preview before upload.</p>
                    <input type="file" id="bulk_item_files" multiple accept="image/*" style="color:#888; font-size:10px; margin-bottom:8px; display:block;" onchange="previewBulkUpload()">
                    <select id="bulk_item_type" class="ie-input">
                        <option value="effect">Effect (animated overlay)</option>
                        <option value="badge">Badge</option>
                    </select>
                    <input type="number" id="bulk_item_price" class="ie-input" placeholder="Default Price" value="500" min="1">
                    <div id="bulk_preview_grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-top:8px; max-height:200px; overflow-y:auto;"></div>
                    <button class="ie-btn" style="background:#500050; border-color:#ff00ff; margin-top:5px;" onclick="bulkUploadItems()">Upload All</button>
                    <div id="bulk_upload_result" style="margin-top:5px; font-size:10px; max-height:150px; overflow-y:auto;"></div>
                </div>

                <div class="admin-section" style="border-color:#ff00ff; margin-bottom:15px;">
                    <h4 style="color:#ff00ff;">Current Shop Items</h4>
                    <div id="st_shop_list" style="max-height:250px; overflow-y:auto; font-size:10px;"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="loadSTShopList()">Refresh List</button>
                        <button class="ie-btn" style="flex:1; background:#700; border-color:#f00;" onclick="deleteAllShopItems()">üóëÔ∏è Delete ALL Items</button>
                    </div>
                    <div id="delete_all_shop_result" style="margin-top:5px; font-size:10px;"></div>
                </div>
                
                <div class="admin-section" style="border-color:#ff00ff; margin-bottom:15px;">
                    <h4 style="color:#ff00ff;">Edit Item Price</h4>
                    <input type="text" id="shop_edit_id" class="ie-input" placeholder="Item ID">
                    <input type="number" id="shop_edit_price" class="ie-input" placeholder="New Price" min="1">
                    <div style="display:flex; gap:5px;">
                        <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stEditShopPrice()">Update Price</button>
                        <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stDeleteShopItem()">Delete Item</button>
                    </div>
                    <div id="shop_edit_result" style="margin-top:5px; font-size:10px;"></div>
                </div>

                <div class="admin-section" style="border-color:#ff00ff;">
                    <h4 style="color:#ff00ff;">Give Tokens</h4>
                    <input type="text" id="st_token_username" class="ie-input" placeholder="Username">
                    <input type="number" id="st_token_amount" class="ie-input" placeholder="Amount" min="1">
                    <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stGiveTokens()">Give Tokens</button>
                    <div id="st_token_result" style="margin-top:5px; font-size:10px;"></div>
                </div>
                
                <div class="admin-section" style="border-color:#ff00ff;">
                    <h4 style="color:#ff00ff;">Give Shop Item</h4>
                    <input type="text" id="st_give_item_username" class="ie-input" placeholder="Username">
                    <select id="st_give_item_id" class="ie-input">
                        <option value="">-- Select Item --</option>
                    </select>
                    <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stGiveItem()">Give Item</button>
                    <button class="ie-btn" style="background:#333; border-color:#ff00ff; margin-top:5px;" onclick="loadGiveItemDropdown()">Refresh Items</button>
                    <div id="st_give_item_result" style="margin-top:5px; font-size:10px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="window" id="memories_folder" style="left:50px; top:50px; width:550px; height:580px;">
    <div class="title-bar"><div class="title-bar-text">C:\Memories</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('memories_folder')"></button></div></div>
    <div class="window-body" style="display:flex; flex-direction:column; height:calc(100% - 32px); overflow:hidden;">
        <div id="memories_grid" style="flex:1; overflow-y:auto; padding:15px; min-height:0;"></div>
        <div style="background:#111; border-top:2px solid #500; padding:15px; display:flex; justify-content:center; align-items:center; gap:20px; flex-shrink:0;">
            <button class="ie-btn" style="width:100px; padding:10px 15px; margin:0; font-size:12px;" onclick="prevPage()">‚óÄ Prev</button>
            <span id="page_indicator" style="color:#d40000; font-size:12px; font-weight:bold; min-width:100px; text-align:center;">Page 1</span>
            <button class="ie-btn" style="width:100px; padding:10px 15px; margin:0; font-size:12px;" onclick="nextPage()">Next ‚ñ∂</button>
        </div>
    </div>
</div>
<div class="window" id="ie_window" style="left:120px; top:80px; width:450px; height:680px;">
    <div class="title-bar"><div class="title-bar-text">fangtasia.wtf Portal</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('ie_window')"></button></div></div>
    <div class="window-body" style="overflow-y:auto;">
        <div class="ie-content" id="ie_login">
            <h2>Member Login</h2>
            <input type="text" id="ie_user" class="ie-input" placeholder="Username">
            <input type="password" id="ie_pass" class="ie-input" placeholder="Password">
            <button class="ie-btn" onclick="validateIE()">Authorize</button>
            <div class="guest-section">
                <p style="color: #666; font-size: 10px; text-align: center; margin-bottom: 10px;">‚Äî OR ‚Äî</p>
                <button class="guest-btn" onclick="toggleWin('about_window')">‚ùì About This Place</button>
                <button class="guest-btn" onclick="enterGuestChat()">üëÅÔ∏è Lurk the Lounge (Read-Only)</button>
            </div>
        </div>
        <div class="ie-content" id="ie_upload" style="display:none;">
            <button class="lounge-entry-btn" onclick="openChat()">ü©∏ Enter The Lounge</button>
            <p id="logged_in_as" style="font-size: 11px; color: #fff;"></p>
            <h3 style="color:#d40000; margin: 15px 0 5px 0; font-size: 13px;">üìπ Upload Memory</h3>
            <input type="text" id="ie_filename" class="ie-input" placeholder="Memory Name">
            <input type="file" id="ie_file_picker" class="ie-input" style="border:none;" accept="video/*">
            <button class="ie-btn" id="upload_status" onclick="processIEUpload()">Push to Cloud</button>
            <div id="vip_image_section" style="display:none; margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                <h3 style="color:#ffd700; margin: 0 0 5px 0; font-size: 13px;">üåü VIP Features</h3>
                
                <div style="margin-bottom:12px; padding:10px; background:#1a1500; border:1px solid #5a4a00; border-radius:4px;">
                    <label style="color:#ffd700; font-size:10px; display:block; margin-bottom:5px;">‚ú® Display Name (shows in chat)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="vip_display_name" class="ie-input" placeholder="Your display name..." maxlength="25" style="flex:1; margin:0;">
                        <button class="ie-btn" style="width:auto; padding:8px 12px; margin:0; background:#5a4a00;" onclick="saveDisplayName()">Save</button>
                    </div>
                    <div id="display_name_result" style="margin-top:5px; font-size:9px;"></div>
                </div>
                
                <label style="color:#888; font-size:10px; display:block; margin-bottom:5px;">üì∑ VIP Image Hosting</label>
                <input type="file" id="vip_image_picker" class="ie-input" style="border:none;" accept="image/*">
                <button class="ie-btn" style="background:#5a4a00;" onclick="uploadVIPImage()">Upload Image</button>
                <div id="vip_image_result" style="margin-top:8px;"></div>
            </div>
            <div id="vip_upgrade_section" style="margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                <h3 style="color:#ffd700; margin: 0 0 10px 0; font-size: 13px;">üåü Upgrade to VIP</h3>
                <p style="color:#888; font-size:10px; margin-bottom:10px;">Have a VIP code? Redeem it to upgrade your account!</p>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="vip_code_input" class="ie-input" placeholder="Enter VIP code..." style="flex:1; margin:0;">
                    <button class="ie-btn" style="width:auto; padding:10px 15px; margin:0; background:#5a4a00;" onclick="redeemVIPCode()">Redeem</button>
                </div>
                <div id="vip_code_result" style="margin-top:8px; font-size:10px; text-align:center;"></div>
            </div>
            <button class="ie-btn" style="background: #333; margin-top: 15px;" onclick="logout()">Logout</button>
        </div>
    </div>
</div>
<div class="taskbar">
    <div style="margin-left: 10px; display: flex; gap: 8px;">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="music-ctrl" onclick="playMusic()" title="Play" style="width:18px; height:18px; cursor:pointer;">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727240.png" class="music-ctrl" onclick="pauseMusic()" title="Pause" style="width:18px; height:18px; cursor:pointer;">
    </div>
    <div style="margin-left: auto; margin-right: 15px; color: #888; font-size: 11px;" id="taskbar_clock"></div>
</div>
<div id="player" style="position:absolute; top:-999px;"></div>
<script src="https://www.youtube.com/iframe_api" onerror="console.log('YouTube API failed to load')"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
// Check if Firebase loaded
if (typeof firebase === 'undefined') {
    console.error('Firebase failed to load!');
    alert('Error: Firebase failed to load. Please refresh the page.');
}

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyB7GeyT9SY7zFBeT-lfCM6iHZ_ipFXvemU",
    authDomain: "fangtasia-14197.firebaseapp.com",
    databaseURL: "https://fangtasia-14197-default-rtdb.firebaseio.com",
    projectId: "fangtasia-14197",
    storageBucket: "fangtasia-14197.firebasestorage.app",
    messagingSenderId: "735588641679",
    appId: "1:735588641679:web:5e0b9c5c5c84166b2f79fa"
};

let db, auth;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    auth = firebase.auth();
} catch(e) {
    console.error('Firebase init error:', e);
}

let FIREBASE_USER = null; // Stores Firebase Auth user object
let CURRENT_USER = "", IS_GUEST = false; // Define early for auth listener
let maintenanceEnabled = false; // Track maintenance mode globally
let currentUserDisplayName = null; // VIP display name

// Image upload: convert to base64 data URI (no external hosting needed)
function fileToBase64(file, maxWidth = 800, preserveAnimation = false) {
    return new Promise((resolve, reject) => {
        // For non-image files (audio/video), just base64 encode directly
        if (!file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
            return;
        }
        // For animated formats (webp/gif) when preserveAnimation is true, 
        // read raw bytes to keep animation intact (canvas kills animation)
        if (preserveAnimation && (file.type === 'image/webp' || file.type === 'image/gif')) {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
            return;
        }
        // For images, resize if needed then convert
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                // Use PNG for formats that support transparency (PNG, WebP, GIF) to avoid black backgrounds
                const usesPNG = file.type === 'image/png' || file.type === 'image/webp' || file.type === 'image/gif';
                resolve(canvas.toDataURL(usesPNG ? 'image/png' : 'image/jpeg', 0.85));
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Firebase Auth State Listener - auto-login if already authenticated
if (auth) {
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log('Auth state: User signed in', user.uid);
            FIREBASE_USER = user;
            
            try {
                // Get username from UID
                const usernameSnap = await db.ref('uid_users/' + user.uid).once('value');
                let username = usernameSnap.val();
                
                if (username && !CURRENT_USER) {
                    // Check if this username exists in coreAdmins with different casing
                    for (const coreUser of Object.keys(coreAdmins)) {
                        if (coreUser.toLowerCase() === username.toLowerCase()) {
                            username = coreUser; // Use coreAdmins casing
                            break;
                        }
                    }
                    
                    console.log('Auto-login as:', username);
                    // Load user data from Firebase
                    const memberSnap = await db.ref('members/' + username).once('value');
                    const firebaseData = memberSnap.val() || {};
                    
                    // IMPORTANT: Merge with coreAdmins - coreAdmins takes precedence
                    const coreData = coreAdmins[username] || {};
                    const memberData = { 
                        rank: 'M', 
                        fullRank: 'Member', 
                        style: 'member-style',
                        ...firebaseData,
                        ...coreData  // coreAdmins overwrites Firebase
                    };
                    
                    // Wait for userDatabase to be defined
                    if (typeof userDatabase !== 'undefined') {
                        userDatabase[username] = memberData;
                    }
                    
                    // Check if not banned
                    const banSnap = await db.ref('bans/' + username.toLowerCase()).once('value');
                    const ban = banSnap.val();
                    if (ban && (ban.expiry === 0 || ban.expiry > Date.now())) {
                        console.log('User is banned, signing out');
                        auth.signOut();
                        return;
                    }
                    
                    // Check maintenance mode - only ST can auto-login during maintenance
                    const maintSnap = await db.ref('site_settings/maintenance').once('value');
                    const maintData = maintSnap.val() || {};
                    if (maintData.enabled && !memberData.isST) {
                        console.log('Maintenance mode active, blocking non-ST auto-login');
                        // Don't sign out, just don't complete login - show maintenance screen
                        return;
                    }
                    
                    // Complete login
                    CURRENT_USER = username;
                    IS_GUEST = false;
                    
                    // Wait for DOM to be ready
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', () => {
                            if (typeof completeLogin === 'function') completeLogin(username);
                        });
                    } else {
                        // Small delay to ensure all elements are ready
                        setTimeout(() => {
                            if (document.getElementById('ie_login') && typeof completeLogin === 'function') {
                                completeLogin(username);
                            }
                        }, 500);
                }
            }
        } catch (err) {
            console.error('Auth state change error:', err);
        }
    } else {
        console.log('Auth state: No user signed in');
        FIREBASE_USER = null;
    }
});
} // End of auth check

// Force logout listener - checks if user was kicked
function startForceLogoutListener() {
    if (!CURRENT_USER) return;
    db.ref('force_logout/' + CURRENT_USER).on('value', (snapshot) => {
        if (snapshot.exists()) {
            // Clear the force logout flag
            db.ref('force_logout/' + CURRENT_USER).remove();
            // Force logout
            alert('You have been logged out by an administrator.');
            logout();
            location.reload();
        }
    });
}

// ============================================================
// HYBRID AUTHENTICATION SYSTEM
// - Immediate access via encoded passwords (backwards compatible)
// - Also checks Firebase hashed passwords for new users
// ============================================================

// SHA-256 hash function for Firebase password verification
async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password + 'fangtasia_salt_2024');
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// USER DATABASE - Encoded credentials for immediate access
const _d = atob;
const _e = {
    a: [_d("bG9zZXJzeW5kaWNhdGU="), _d("ZG91YmxlZHV0Y2hpZTAx")],
    b: [_d("bm9zZWV5ZWRlYXI="), _d("d3Rmb21mZ2Zhbmd0YXNpYWZvcmRhYnJvczIx")],
    c: [_d("b2xlZw=="), _d("a2V0YW1pbmVjb2RlbmFtZSEhIQ==")],
    d: [_d("bm9ydGg="), _d("bG1hb2xlZ2FjeTEyISQk")],
    e: [_d("anlyYW0="), _d("aWxvdmVDb29raWVzMTIzNC4=")],
    f: [_d("WXVza3k="), _d("U2tpbGxldDEyIQ==")],
    g: [_d("bm9hYm9ydGlvbnM="), _d("RGlvbjA3MTM=")],
    h: [_d("ZXBoZW1lcmFs"), _d("U2V4eVNvbGl0YWlyZTEyMw==")],
    i: [_d("Z3VhcmRlZHBhbg=="), _d("ZnJlZWhvb2tlcnMxMjM=")],
    j: [_d("Sw=="), _d("S0FOQUJPUzE5RkFOR1RBU0lBV1RGUEFTU1dPUkRMT0xPTA==")],
    k: [_d("ZWxl"), _d("Q09NR09ETE9SREJPU1NFWFRPUVRFUTI4MjcxISEhMQ==")],
    l: [_d("Y3lybw=="), _d("cGFzc2ZvcmN5cm8xOTI=")],
    m: [_d("Ym9sb2s="), _d("amlsbGFpc2FmYWc=")],
    n: [_d("cmtlbGx5ZmFuMTc="), _d("ZW5ueWVubnllbm55")],
    o: [_d("bGVhbg=="), _d("U3VubnlGZWV0VXdVNTYk")],
    p: [_d("aGVudGFp"), _d("cm9ibG94bWFueDVANjdAMTEyMUA2NzY3")],
    q: [_d("cmVk"), _d("ZGlja2dyYXlzb25idWRkeTIz")],
    r: [_d("c2x1dA=="), _d("b3NoYmFnb3NoMTc4Ng==")],
    s: [_d("cG9uY2hvc2hvb3Rlcg=="), _d("djhlZVA4b0xPeHBJaE8=")],
    t: [_d("MA=="), _d("Z2ppMjMxOWpoaGo5ZXM=")],
    u: [_d("cGFyYXNpdGU="), _d("czZwZXJzYWl5YW50YWNvMw==")],
    v: [_d("aGVhcnRhY2hl"), _d("QWJieUFiYnkxMg==")],
    w: [_d("Z29k"), _d("VHVuM3h4WipmbCk=")],
    x: [_d("RlJFRVpFUkJVUk4="), _d("ZnJlZXphbWFuZTU2NA==")],
    y: [_d("bWFwbGUuc3lydXBw"), _d("d2lnZ2FwYXNzd29yZDEyMw==")],
    z: [_d("ZGlvbg=="), _d("JDEwMDM1NTg3")],
    aa: [_d("TGVtb25hZGU="), _d("QnV0dEJvb3R5TmFrZWQxMjM=")],
    ab: [_d("c3VwZXJuaWdnYXBlbmlzNjc="), _d("bmlnZ2FuaWdnYW5pZ2dh")],
    ac: [_d("aWNl"), _d("cHJveGlzY29vbDAwMDA2NjY2")],
    ad: [_d("Yml0ZQ=="), _d("aG9ybnlidWxsczExcw==")],
    ae: [_d("Z293"), _d("TW9ybw==")],
    af: [_d("bWFwbGU="), _d("bWFwbGVzeXJ1cHdpZ2dhMA==")],
    ag: [_d("cmVnYW4="), _d("cmVnYW5tb2QxMjM=")]
};
const coreAdmins = {
    [_e.a[0]]: { pass: _e.a[1], rank: "ST", fullRank: "Site Technician", style: "st-style", isAdmin: true, isST: true },
    [_e.b[0]]: { pass: _e.b[1], rank: "A", fullRank: "Admin", style: "noseeyedear-style", isAdmin: true, customTag: "N" },
    [_e.c[0]]: { pass: _e.c[1], rank: "A", fullRank: "Admin", style: "oleg-style", isAdmin: true, customTag: "O" },
    [_e.j[0]]: { pass: _e.j[1], rank: "A", fullRank: "Admin", style: "admin-style", isAdmin: true, customTag: "K" },
    [_e.ag[0]]: { pass: _e.ag[1], rank: "MOD", fullRank: "Moderator", style: "mod-style", isAdmin: false, isMod: true },
    [_e.af[0]]: { pass: _e.af[1], rank: "MOD", fullRank: "Moderator", style: "mod-style", isAdmin: false, isMod: true },
    [_e.d[0]]: { pass: _e.d[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.e[0]]: { pass: _e.e[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.f[0]]: { pass: _e.f[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.g[0]]: { pass: _e.g[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.h[0]]: { pass: _e.h[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.i[0]]: { pass: _e.i[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.k[0]]: { pass: _e.k[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.l[0]]: { pass: _e.l[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.m[0]]: { pass: _e.m[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.n[0]]: { pass: _e.n[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.o[0]]: { pass: _e.o[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.p[0]]: { pass: _e.p[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.q[0]]: { pass: _e.q[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.r[0]]: { pass: _e.r[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.s[0]]: { pass: _e.s[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.t[0]]: { pass: _e.t[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.u[0]]: { pass: _e.u[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.v[0]]: { pass: _e.v[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.w[0]]: { pass: _e.w[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.x[0]]: { pass: _e.x[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.y[0]]: { pass: _e.y[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.z[0]]: { pass: _e.z[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.aa[0]]: { pass: _e.aa[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ab[0]]: { pass: _e.ab[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ac[0]]: { pass: _e.ac[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ad[0]]: { pass: _e.ad[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ae[0]]: { pass: _e.ae[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false }
};
let userDatabase = { ...coreAdmins };

// Start online listener IMMEDIATELY so it's ready when members load
let onlineListenerStarted = false;
let onlineUsers = [];

function startOnlineListener() {
    if (onlineListenerStarted) return;
    onlineListenerStarted = true;
    
    db.ref('online').on('value', (snapshot) => {
        onlineUsers = [];
        snapshot.forEach(child => {
            const u = child.val();
            if (u && u.username) onlineUsers.push(u);
        });
        updateMemberList();
    });
}

// Start listening immediately
startOnlineListener();

// List of deleted/renamed accounts to filter out
const deletedAccounts = ['pink', 'nigger'];

// Clean up deleted accounts from Firebase
deletedAccounts.forEach(acc => {
    db.ref('members/' + acc).remove();
    db.ref('online/' + acc).remove();
    db.ref('profiles/' + acc).remove();
    db.ref('reputation/' + acc).remove();
});

// Listen for member updates - merge with coreAdmins
db.ref('members').on('value', (s) => { 
    const firebaseMembers = s.val() || {};
    // Merge: start with Firebase data, then overlay coreAdmins to preserve customTags etc.
    userDatabase = { ...firebaseMembers };
    // Ensure coreAdmins properties always take precedence
    Object.keys(coreAdmins).forEach(user => {
        userDatabase[user] = { ...userDatabase[user], ...coreAdmins[user] };
    });
    // Remove deleted accounts
    deletedAccounts.forEach(acc => { delete userDatabase[acc]; });
    updateMemberList();
});

let currentPage = 1, itemsPerPage = 9;
let userProfile = { status: "", bio: "", mood: "", avatar: "", music: "" };
let currentProfileUser = "", idleTime = 0, screensaverActive = false;

// REAL-TIME PROFILE CACHE
let profileCache = {};
db.ref('profiles').on('value', (s) => { profileCache = s.val() || {}; });
function getProfile(username) { return profileCache[username] || {}; }

// REAL-TIME CLUBS CACHE
let clubsCache = {};
db.ref('clubs').on('value', (s) => { 
    clubsCache = s.val() || {}; 
    // Auto-refresh clubs list if window is open
    const clubsList = document.getElementById('clubs_list');
    if (clubsList && document.getElementById('clubs_window').style.display === 'block') {
        loadAllClubs();
    }
});

// Generate unique user ID from username
function generateUserId(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        const char = username.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'FNG-' + Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
}

// Get rank tag HTML - Custom tags for specific users
// Club tags - clubs that give special chat tags to members
const clubTags = {
    'evil jits': { tag: 'jitz', color: '#8B0000' },
    'intelcord': { tag: 'KEVIN', color: '#f2eded' },
    '##sb': { tag: '##SB', color: '#6a03b4' },
    'sb': { tag: '##SB', color: '#6a03b4' },
    '#sb': { tag: '##SB', color: '#6a03b4' },
    '##SB': { tag: '##SB', color: '#6a03b4' }
};

function getRankTag(rank, style, username, useCustomTag = true) {
    // Custom tags ALWAYS override in chat - check first (if useCustomTag is true)
    if (useCustomTag && username && userDatabase[username]?.customTag) {
        const user = userDatabase[username];
        // If custom color is set, use inline styles
        if (user.customTagColor) {
            return `<span class="rank-tag" style="color:${user.customTagColor}; border-color:${user.customTagColor}; background:${user.customTagColor}22;">${user.customTag}</span>`;
        }
        return `<span class="rank-tag ${user.style || style || 'member-style'}">${user.customTag}</span>`;
    }
    
    // Check for club tags - only if user doesn't have a custom tag
    if (useCustomTag && username && !userDatabase[username]?.customTag) {
        const clubTag = getUserClubTag(username);
        if (clubTag) {
            return `<span class="rank-tag" style="color:${clubTag.color}; border-color:${clubTag.color}; background:${clubTag.color}22;">${clubTag.tag}</span>`;
        }
    }
    
    // K badge for contributors (only if no custom tag or useCustomTag is false)
    if (rank === 'CONTRIB') {
        return '<span class="rank-tag contrib-style" style="font-family:\'Bahram\',sans-serif;">K</span>';
    }
    // Default rank tag
    return `<span class="rank-tag ${style || 'member-style'}">${rank || 'M'}</span>`;
}

// Check if user is in a club that has a special tag
function getUserClubTag(username) {
    // Check clubsCache for user membership
    for (const clubId in clubsCache) {
        const club = clubsCache[clubId];
        const clubName = (club.name || '').toLowerCase();
        
        // Check if this club has a special tag
        if (clubTags[clubName]) {
            // Check if user is owner or member
            if (club.owner === username || (club.members && club.members.includes(username))) {
                return clubTags[clubName];
            }
        }
    }
    return null;
}

// BAT CURSOR
document.addEventListener('mousemove', (e) => {
    const bat = document.getElementById('batCursor');
    if(bat) { bat.style.left = e.clientX + 'px'; bat.style.top = e.clientY + 'px'; }
    resetIdle();
});
document.addEventListener('keypress', resetIdle);
document.addEventListener('click', resetIdle);

function resetIdle() {
    idleTime = 0;
    if (screensaverActive) { document.getElementById('screensaver').style.display = 'none'; screensaverActive = false; }
}
function activateScreensaver() {
    screensaverActive = true;
    const ss = document.getElementById('screensaver');
    ss.innerHTML = '';
    ss.style.display = 'block';
    for (let i = 0; i < 12; i++) {
        const bat = document.createElement('div');
        bat.className = 'screensaver-bat';
        bat.textContent = 'ü¶á';
        bat.style.left = Math.random() * 90 + 'vw';
        bat.style.top = Math.random() * 90 + 'vh';
        bat.style.animation = `flyAround ${6 + Math.random() * 6}s linear infinite`;
        ss.appendChild(bat);
    }
}
setInterval(() => { idleTime++; if (idleTime > 90 && !screensaverActive && document.getElementById('boot-screen').style.display === 'none') activateScreensaver(); }, 1000);

function updateVisitorCount() {
    let count = parseInt(localStorage.getItem('f_visitors') || '0');
    if (!sessionStorage.getItem('counted')) { count++; localStorage.setItem('f_visitors', count); sessionStorage.setItem('counted', 'true'); }
    document.getElementById('visitor_count').textContent = count.toString().padStart(6, '0');
}
function updateClock() { const now = new Date(); document.getElementById('taskbar_clock').textContent = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0'); }
setInterval(updateClock, 1000);

// XSS SANITIZATION FUNCTIONS
function escapeHtml(text) { 
    if (!text) return ''; 
    const div = document.createElement('div'); 
    div.textContent = text; 
    return div.innerHTML; 
}

// Get color from style class name
function getStyleColor(style) {
    const styleColors = {
        'st-style': '#ff00ff',
        'a-style': '#ffffff',
        'admin-style': '#ffffff',
        'mod-style': '#00ff00',
        'contrib-style': '#1781ff',
        'oleg-style': '#ff6b35',
        'noseeyedear-style': '#00ffcc',
        'guest-style': '#888888',
        'vip-style': '#ffd700',
        'sb-style': '#6a03b4',
        'member-style': '#ff4444',
        'bot-style': '#d40000'
    };
    return styleColors[style] || '#ff4444';
}

function sanitizeInput(text) {
    if (!text) return '';
    // Remove any HTML tags completely
    let clean = text.replace(/<[^>]*>/g, '');
    // Remove javascript: and data: URLs
    clean = clean.replace(/javascript:/gi, '');
    clean = clean.replace(/data:/gi, '');
    clean = clean.replace(/vbscript:/gi, '');
    // Remove on* event handlers
    clean = clean.replace(/on\w+\s*=/gi, '');
    // Escape HTML entities
    clean = escapeHtml(clean);
    return clean;
}

function sanitizeUrl(url) {
    if (!url) return '';
    const trimmed = url.trim();
    // Only allow http, https protocols
    if (!/^https?:\/\//i.test(trimmed)) {
        // Check if it starts with dangerous protocols
        if (/^(javascript|data|vbscript|file):/i.test(trimmed)) {
            return '';
        }
        // If no protocol, assume it's not a URL or add https
        if (trimmed.includes('.') && !trimmed.includes(' ')) {
            return 'https://' + trimmed;
        }
        return '';
    }
    return trimmed;
}

function sanitizeProfileField(text, maxLength = 500) {
    if (!text) return '';
    let clean = String(text).substring(0, maxLength);
    clean = sanitizeInput(clean);
    return clean;
}

// SILVER STAKES GAME
let stakesBoard = [], stakesRevealed = [], stakesFlagged = [], gameOver = false;
function initStakesGame() {
    stakesBoard = Array(81).fill(0); stakesRevealed = Array(81).fill(false); stakesFlagged = Array(81).fill(false); gameOver = false;
    let placed = 0;
    while (placed < 10) { const pos = Math.floor(Math.random() * 81); if (stakesBoard[pos] !== -1) { stakesBoard[pos] = -1; placed++; } }
    for (let i = 0; i < 81; i++) {
        if (stakesBoard[i] === -1) continue;
        let count = 0; const row = Math.floor(i / 9), col = i % 9;
        for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && stakesBoard[nr * 9 + nc] === -1) count++; }
        stakesBoard[i] = count;
    }
    renderStakes();
    document.getElementById('game_status').textContent = 'Stakes: 10';
    
    // Log game play for leaderboard
    if (CURRENT_USER && !IS_GUEST) {
        db.ref('game_stats/minesweeper/' + CURRENT_USER + '/gamesPlayed').transaction((current) => {
            return (current || 0) + 1;
        }).catch(err => console.log('Game play log error:', err));
    }
}
function renderStakes() {
    const grid = document.getElementById('stakes_grid'); grid.innerHTML = '';
    for (let i = 0; i < 81; i++) {
        const cell = document.createElement('div'); cell.className = 'stakes-cell';
        if (stakesRevealed[i]) { cell.classList.add('revealed'); if (stakesBoard[i] === -1) { cell.classList.add('stake'); cell.textContent = 'üó°Ô∏è'; } else if (stakesBoard[i] > 0) { cell.textContent = stakesBoard[i]; cell.style.color = ['','#00f','#0a0','#f00','#008','#800','#088','#000','#888'][stakesBoard[i]]; } }
        else if (stakesFlagged[i]) { cell.textContent = 'üö©'; }
        cell.onclick = () => revealCell(i);
        cell.oncontextmenu = (e) => { e.preventDefault(); if (!gameOver && !stakesRevealed[i]) { stakesFlagged[i] = !stakesFlagged[i]; renderStakes(); } };
        grid.appendChild(cell);
    }
}
function revealCell(i) {
    if (gameOver || stakesRevealed[i] || stakesFlagged[i]) return;
    stakesRevealed[i] = true;
    if (stakesBoard[i] === -1) { gameOver = true; stakesRevealed = stakesRevealed.map(() => true); document.getElementById('game_status').textContent = 'Staked! Game Over.'; }
    else if (stakesBoard[i] === 0) { const row = Math.floor(i / 9), col = i % 9; for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) revealCell(nr * 9 + nc); } }
    const unrevealed = stakesRevealed.filter((r, idx) => !r && stakesBoard[idx] !== -1).length;
    if (unrevealed === 0 && !gameOver) { 
        gameOver = true; 
        document.getElementById('game_status').textContent = 'You survived! +50 tokens'; 
        // Track win in Firebase and award tokens
        if (CURRENT_USER && !IS_GUEST) {
            // Award 50 tokens for winning
            playerTokens += 50;
            updateTokenDisplays();
            savePlayerTokens();
            
            db.ref('game_stats/minesweeper/' + CURRENT_USER).once('value', (snap) => {
                const current = snap.val() || { wins: 0, lastWin: 0 };
                const newWins = (current.wins || 0) + 1;
                db.ref('game_stats/minesweeper/' + CURRENT_USER).set({
                    wins: newWins,
                    lastWin: Date.now()
                }).then(() => {
                    // Update displays
                    const myWinsEl = document.getElementById('my_wins_count');
                    if (myWinsEl) myWinsEl.textContent = newWins;
                    loadGameMiniLeaderboard();
                });
            });
        }
    }
    renderStakes();
}

function loadGameMiniLeaderboard() {
    const container = document.getElementById('game_mini_leaderboard');
    if (!container) return;
    
    db.ref('game_stats/minesweeper').orderByChild('wins').limitToLast(5).once('value', (snap) => {
        const stats = [];
        snap.forEach(c => {
            stats.push({ user: c.key, wins: c.val().wins || 0 });
        });
        stats.sort((a, b) => b.wins - a.wins);
        
        if (stats.length === 0) {
            container.innerHTML = '<div style="color: #666;">No winners yet!</div>';
            return;
        }
        
        container.innerHTML = stats.map((s, i) => {
            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#' + (i+1);
            const isCurrent = s.user === CURRENT_USER;
            return `<div style="display:flex; justify-content:space-between; padding:2px 0; ${isCurrent ? 'color:#ff6600;' : 'color:#aaa;'}">
                <span>${medal} ${s.user}</span>
                <span>${s.wins}</span>
            </div>`;
        }).join('');
    });
}

function loadMyGameStats() {
    if (!CURRENT_USER || IS_GUEST) return;
    db.ref('game_stats/minesweeper/' + CURRENT_USER).once('value', (snap) => {
        const data = snap.val() || { wins: 0 };
        const myWinsEl = document.getElementById('my_wins_count');
        if (myWinsEl) myWinsEl.textContent = data.wins || 0;
    });
    // Load tokens for other games
    loadPlayerTokens();
}

// ========== GAME TAB SWITCHING ==========
function switchGameTab(tab, el) {
    document.querySelectorAll('#games_window .tab').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    const tabs = ['stakes','blackjack','slots','roulette','crash','coinflip','snake','daily','shop'];
    tabs.forEach(t => {
        const panel = document.getElementById('game_tab_' + t);
        if (panel) panel.style.display = t === tab ? 'block' : 'none';
    });
    if (tab === 'daily') loadDailyStatus();
    if (tab === 'shop') loadShopItems();
}

// ========== BLOOD TOKENS SYSTEM ==========
let playerTokens = 100;

let playerTokensListener = null;

function loadPlayerTokens() {
    if (!CURRENT_USER || IS_GUEST) return;
    // Remove old listener if exists
    if (playerTokensListener) {
        db.ref('game_stats/tokens/' + CURRENT_USER).off('value', playerTokensListener);
    }
    // Real-time listener so gifts arrive instantly
    playerTokensListener = db.ref('game_stats/tokens/' + CURRENT_USER).on('value', (snap) => {
        const newVal = snap.val() || 100;
        const changed = newVal !== playerTokens;
        playerTokens = newVal;
        updateTokenDisplays();
        // Flash animation when tokens change from external source (gift)
        if (changed) {
            const el = document.getElementById('main_token_display');
            if (el) { el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash'); }
        }
    });
}

function savePlayerTokens() {
    if (!CURRENT_USER || IS_GUEST) return;
    db.ref('game_stats/tokens/' + CURRENT_USER).set(playerTokens);
}

function updateTokenDisplays() {
    const mainTokens = document.getElementById('main_token_display');
    const bjTokens = document.getElementById('bj_tokens');
    const slotsTokens = document.getElementById('slots_tokens');
    if (mainTokens) mainTokens.textContent = playerTokens;
    if (bjTokens) bjTokens.textContent = playerTokens;
    if (slotsTokens) slotsTokens.textContent = playerTokens;
}

// ========== BLACKJACK ==========
let bjDeck = [], bjPlayerHand = [], bjDealerHand = [], bjGameOver = true, bjPlayerWins = 0, bjProfit = 0;
let bjBet = 10, bjCurrentBet = 0;

function bjChangeBet(amt) {
    if (amt === 'max') { bjBet = Math.max(10, playerTokens); }
    else { bjBet = Math.max(10, bjBet + amt); }
    bjBet = Math.min(bjBet, playerTokens);
    document.getElementById('bj_bet_display').textContent = bjBet;
}

function createDeck() {
    const suits = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'];
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    const deck = [];
    for (const suit of suits) {
        for (const value of values) {
            deck.push({ suit, value, color: (suit === '‚ô•' || suit === '‚ô¶') ? 'red' : 'black' });
        }
    }
    // Use 6 decks like real casino
    const shoe = [...deck, ...deck, ...deck, ...deck, ...deck, ...deck];
    return shoe.sort(() => Math.random() - 0.5);
}

function getCardValue(card) {
    if (['J', 'Q', 'K'].includes(card.value)) return 10;
    if (card.value === 'A') return 11;
    return parseInt(card.value);
}

function getHandValue(hand) {
    let value = 0, aces = 0;
    for (const card of hand) {
        value += getCardValue(card);
        if (card.value === 'A') aces++;
    }
    while (value > 21 && aces > 0) { value -= 10; aces--; }
    return value;
}

function renderCard(card, hidden = false) {
    if (hidden) return '<div class="bj-card hidden">?</div>';
    return `<div class="bj-card ${card.color}">${card.value}${card.suit}</div>`;
}

function renderHands(showDealer = false) {
    const dealerEl = document.getElementById('bj_dealer_hand');
    const playerEl = document.getElementById('bj_player_hand');
    const dealerScoreEl = document.getElementById('bj_dealer_score');
    const playerScoreEl = document.getElementById('bj_player_score');
    
    if (showDealer) {
        dealerEl.innerHTML = bjDealerHand.map(c => renderCard(c)).join('');
        dealerScoreEl.textContent = 'Score: ' + getHandValue(bjDealerHand);
    } else {
        dealerEl.innerHTML = renderCard(bjDealerHand[0]) + renderCard(null, true);
        dealerScoreEl.textContent = 'Score: ?';
    }
    
    playerEl.innerHTML = bjPlayerHand.map(c => renderCard(c)).join('');
    playerScoreEl.textContent = 'Score: ' + getHandValue(bjPlayerHand);
}

function bjNewGame() {
    if (playerTokens < bjBet) {
        document.getElementById('bj_result').innerHTML = '<span style="color:#f00;">Not enough tokens!</span>';
        return;
    }
    
    bjCurrentBet = bjBet;
    playerTokens -= bjCurrentBet;
    updateTokenDisplays();
    
    bjDeck = createDeck();
    bjPlayerHand = [bjDeck.pop(), bjDeck.pop()];
    bjDealerHand = [bjDeck.pop(), bjDeck.pop()];
    bjGameOver = false;
    
    document.getElementById('bj_result').innerHTML = `<span style="color:#ffd700;">Bet: ${bjCurrentBet} tokens</span>`;
    document.getElementById('bj_hit_btn').disabled = false;
    document.getElementById('bj_stand_btn').disabled = false;
    document.getElementById('bj_double_btn').disabled = false;
    document.getElementById('bj_double_btn').style.display = 'inline-block';
    
    renderHands(false);
    
    if (getHandValue(bjPlayerHand) === 21) {
        bjEndGame('blackjack');
    }
}

function bjHit() {
    if (bjGameOver) return;
    document.getElementById('bj_double_btn').style.display = 'none';
    bjPlayerHand.push(bjDeck.pop());
    renderHands(false);
    
    if (getHandValue(bjPlayerHand) > 21) {
        bjEndGame('bust');
    }
}

function bjDouble() {
    if (bjGameOver || bjPlayerHand.length !== 2) return;
    if (playerTokens < bjCurrentBet) {
        document.getElementById('bj_result').innerHTML = '<span style="color:#f00;">Not enough to double!</span>';
        return;
    }
    playerTokens -= bjCurrentBet;
    bjCurrentBet *= 2;
    updateTokenDisplays();
    document.getElementById('bj_result').innerHTML = `<span style="color:#ffd700;">Doubled! Bet: ${bjCurrentBet}</span>`;
    
    bjPlayerHand.push(bjDeck.pop());
    renderHands(false);
    
    if (getHandValue(bjPlayerHand) > 21) {
        bjEndGame('bust');
    } else {
        bjStand();
    }
}

function bjStand() {
    if (bjGameOver) return;
    
    // Dealer AI: hits on soft 17 (casino standard)
    while (true) {
        const val = getHandValue(bjDealerHand);
        const hasSoftAce = bjDealerHand.some(c => c.value === 'A') && 
            bjDealerHand.reduce((s, c) => s + getCardValue(c), 0) !== val;
        if (val < 17 || (val === 17 && hasSoftAce)) {
            bjDealerHand.push(bjDeck.pop());
        } else break;
    }
    
    renderHands(true);
    
    const playerVal = getHandValue(bjPlayerHand);
    const dealerVal = getHandValue(bjDealerHand);
    
    if (dealerVal > 21) bjEndGame('dealer_bust');
    else if (playerVal > dealerVal) bjEndGame('win');
    else if (playerVal < dealerVal) bjEndGame('lose');
    else bjEndGame('push');
}

function bjEndGame(result) {
    bjGameOver = true;
    document.getElementById('bj_hit_btn').disabled = true;
    document.getElementById('bj_stand_btn').disabled = true;
    document.getElementById('bj_double_btn').disabled = true;
    renderHands(true);
    
    const resultEl = document.getElementById('bj_result');
    let payout = 0;
    
    switch(result) {
        case 'blackjack':
            payout = Math.floor(bjCurrentBet * 2.5);
            resultEl.innerHTML = `<span style="color:#ffd700;">üÉè BLACKJACK! +${payout} tokens!</span>`;
            bjPlayerWins++;
            break;
        case 'bust':
            resultEl.innerHTML = `<span style="color:#f00;">üíÄ BUST! -${bjCurrentBet} tokens</span>`;
            break;
        case 'dealer_bust':
            payout = bjCurrentBet * 2;
            resultEl.innerHTML = `<span style="color:#0f0;">Dealer busts! +${payout} tokens!</span>`;
            bjPlayerWins++;
            break;
        case 'win':
            payout = bjCurrentBet * 2;
            resultEl.innerHTML = `<span style="color:#0f0;">You win! +${payout} tokens!</span>`;
            bjPlayerWins++;
            break;
        case 'lose':
            resultEl.innerHTML = `<span style="color:#f00;">Dealer wins. -${bjCurrentBet} tokens</span>`;
            break;
        case 'push':
            payout = bjCurrentBet;
            resultEl.innerHTML = '<span style="color:#ffd700;">Push - Bet returned</span>';
            break;
    }
    
    bjProfit += (payout - bjCurrentBet);
    playerTokens += payout;
    updateTokenDisplays();
    savePlayerTokens();
    document.getElementById('bj_wins').textContent = bjPlayerWins;
    document.getElementById('bj_profit').textContent = (bjProfit >= 0 ? '+' : '') + bjProfit;
    document.getElementById('bj_profit').style.color = bjProfit >= 0 ? '#0f0' : '#f00';
    
    // Arena flash
    const bjAr = document.getElementById('bj_arena');
    if (bjAr) {
        bjAr.classList.remove('win-flash','lose-flash');
        void bjAr.offsetWidth;
        bjAr.classList.add(payout > 0 ? 'win-flash' : (result === 'push' ? '' : 'lose-flash'));
        setTimeout(() => bjAr.classList.remove('win-flash','lose-flash'), 800);
    }
    
    if (bjPlayerWins > 0 && CURRENT_USER && !IS_GUEST) {
        db.ref('game_stats/blackjack/' + CURRENT_USER).update({ wins: bjPlayerWins, lastWin: Date.now() });
    }
}

// ========== ROULETTE ==========
const rlRedNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
let rlBet = 10, rlSpinning = false, rlHistory = [];

function rlChangeBet(amt) {
    if (amt === 'max') { rlBet = Math.max(10, playerTokens); }
    else { rlBet = Math.max(10, rlBet + amt); }
    rlBet = Math.min(rlBet, playerTokens);
    document.getElementById('rl_bet_display').textContent = rlBet;
}

function rlSpin(betType) {
    if (rlSpinning || playerTokens < rlBet) {
        if (playerTokens < rlBet) document.getElementById('rl_result').innerHTML = '<span style="color:#f00;">Not enough tokens!</span>';
        return;
    }
    
    let betNumber = -1;
    if (betType === 'number') {
        betNumber = parseInt(document.getElementById('rl_number_input').value);
        if (isNaN(betNumber) || betNumber < 0 || betNumber > 36) {
            document.getElementById('rl_result').innerHTML = '<span style="color:#f00;">Pick a number 0-36</span>';
            return;
        }
    }
    
    rlSpinning = true;
    playerTokens -= rlBet;
    updateTokenDisplays();
    
    const wheel = document.getElementById('rl_wheel');
    const resultEl = document.getElementById('rl_result');
    resultEl.innerHTML = '';
    wheel.classList.add('spinning');
    
    // Spin animation
    let spins = 0;
    const spinInterval = setInterval(() => {
        const rn = Math.floor(Math.random() * 37);
        const isRed = rlRedNumbers.includes(rn);
        wheel.textContent = rn;
        wheel.style.background = rn === 0 ? 'radial-gradient(circle, #0a3a0a, #030)' : isRed ? 'radial-gradient(circle, #500, #200)' : 'radial-gradient(circle, #2a2a2a, #111)';
        spins++;
        if (spins > 28) {
            clearInterval(spinInterval);
            wheel.classList.remove('spinning');
            
            const num = Math.floor(Math.random() * 37);
            const isRedFinal = rlRedNumbers.includes(num);
            const color = num === 0 ? 'green' : isRedFinal ? 'red' : 'black';
            
            wheel.textContent = num;
            wheel.style.background = num === 0 ? 'radial-gradient(circle, #0a0, #040)' : isRedFinal ? 'radial-gradient(circle, #c00, #500)' : 'radial-gradient(circle, #444, #1a1a1a)';
            wheel.style.borderColor = '#ffd700';
            wheel.style.transform = 'scale(1.15)';
            wheel.style.boxShadow = '0 0 30px ' + (num === 0 ? 'rgba(0,255,0,0.4)' : isRedFinal ? 'rgba(255,0,0,0.4)' : 'rgba(150,150,150,0.3)');
            setTimeout(() => { wheel.style.transform = 'scale(1)'; wheel.style.boxShadow = ''; }, 400);
            
            let payout = 0;
            if (betType === 'number' && num === betNumber) {
                payout = rlBet * 36;
                resultEl.innerHTML = `<span style="color:#ffd700;">üéØ NUMBER HIT! +${payout} tokens!</span>`;
            } else if (betType === 'green' && num === 0) {
                payout = rlBet * 14;
                resultEl.innerHTML = `<span style="color:#0f0;">üü¢ GREEN! +${payout} tokens!</span>`;
            } else if (betType === 'red' && color === 'red') {
                payout = rlBet * 2;
                resultEl.innerHTML = `<span style="color:#f88;">üî¥ Red wins! +${payout}</span>`;
            } else if (betType === 'black' && color === 'black') {
                payout = rlBet * 2;
                resultEl.innerHTML = `<span style="color:#ccc;">‚ö´ Black wins! +${payout}</span>`;
            } else {
                resultEl.innerHTML = `<span style="color:#555;">${num} ${color} ‚Äî No win</span>`;
            }
            
            playerTokens += payout;
            updateTokenDisplays();
            savePlayerTokens();
            
            rlHistory.unshift({ num, color });
            if (rlHistory.length > 20) rlHistory.pop();
            const dotsEl = document.getElementById('rl_history_dots');
            dotsEl.innerHTML = rlHistory.map(h => {
                const bg = h.color === 'green' ? '#0a0' : h.color === 'red' ? '#900' : '#333';
                const bc = h.color === 'green' ? '#0f0' : h.color === 'red' ? '#f00' : '#666';
                return `<div style="width:24px; height:24px; border-radius:50%; background:${bg}; display:flex; align-items:center; justify-content:center; font-size:8px; color:#fff; font-weight:bold; border:1.5px solid ${bc}33;">${h.num}</div>`;
            }).join('');
            
            rlSpinning = false;
        }
    }, 65);
}

// ========== CRASH ==========
let crBet = 10, crRunning = false, crCashedOut = false, crMultiplier = 1, crCrashPoint = 0;
let crInterval = null, crHistory = [];

function crChangeBet(amt) {
    if (amt === 'max') { crBet = Math.max(10, playerTokens); }
    else { crBet = Math.max(10, crBet + amt); }
    crBet = Math.min(crBet, playerTokens);
    document.getElementById('cr_bet_display').textContent = crBet;
}

function crStart() {
    if (crRunning || playerTokens < crBet) {
        if (playerTokens < crBet) document.getElementById('cr_result').innerHTML = '<span style="color:#f00;">Not enough tokens!</span>';
        return;
    }
    
    playerTokens -= crBet;
    updateTokenDisplays();
    
    crRunning = true;
    crCashedOut = false;
    crMultiplier = 1.00;
    
    // Generate crash point (house edge ~4%)
    const r = Math.random();
    crCrashPoint = r < 0.04 ? 1.00 : Math.max(1.01, parseFloat((0.96 / (1 - r)).toFixed(2)));
    if (crCrashPoint > 100) crCrashPoint = 100;
    
    document.getElementById('cr_start_btn').style.display = 'none';
    document.getElementById('cr_cashout_btn').style.display = 'inline-block';
    document.getElementById('cr_result').innerHTML = '';
    
    const canvas = document.getElementById('crash_canvas');
    const ctx = canvas ? canvas.getContext('2d') : null;
    const multEl = document.getElementById('cr_multiplier');
    let dataPoints = [];
    let tick = 0;
    
    crInterval = setInterval(() => {
        tick++;
        crMultiplier = parseFloat((1 + (tick * 0.01) * (1 + tick * 0.002)).toFixed(2));
        
        if (crMultiplier >= crCrashPoint) {
            crMultiplier = crCrashPoint;
            clearInterval(crInterval);
            crRunning = false;
            
            multEl.textContent = crMultiplier.toFixed(2) + 'x';
            multEl.className = 'cr-multiplier crashed';
            
            if (!crCashedOut) {
                document.getElementById('cr_result').innerHTML = `<span style="color:#f00;">üí• CRASHED at ${crCrashPoint.toFixed(2)}x! -${crBet} tokens</span>`;
            }
            
            crHistory.unshift(crCrashPoint);
            if (crHistory.length > 12) crHistory.pop();
            document.getElementById('cr_history').innerHTML = crHistory.map(h => {
                const c = h < 1.5 ? '#f00' : h < 3 ? '#ffa500' : h < 10 ? '#0f0' : '#ffd700';
                return `<span style="color:${c}; font-size:10px; font-weight:bold; padding:2px 5px; background:#111; border-radius:3px; border:1px solid ${c}33;">${h.toFixed(2)}x</span>`;
            }).join('');
            
            document.getElementById('cr_start_btn').style.display = 'inline-block';
            document.getElementById('cr_cashout_btn').style.display = 'none';
            savePlayerTokens();
            return;
        }
        
        multEl.textContent = crMultiplier.toFixed(2) + 'x';
        multEl.className = 'cr-multiplier' + (crMultiplier < 2 ? '' : crMultiplier < 5 ? ' hot' : ' fire');
        
        // Draw graph
        if (ctx) {
            dataPoints.push(crMultiplier);
            ctx.fillStyle = '#050000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 0.5;
            for (let y = 0; y < canvas.height; y += 30) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
            }
            
            if (dataPoints.length > 1) {
                const maxM = Math.max(...dataPoints, 2);
                ctx.beginPath();
                ctx.strokeStyle = crMultiplier < 2 ? '#0f0' : crMultiplier < 5 ? '#ffa500' : '#ffd700';
                ctx.lineWidth = 2;
                for (let i = 0; i < dataPoints.length; i++) {
                    const x = (i / Math.max(dataPoints.length - 1, 1)) * canvas.width;
                    const y = canvas.height - ((dataPoints[i] - 1) / (maxM - 1)) * (canvas.height - 20) - 10;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }
    }, 50);
}

function crCashout() {
    if (!crRunning || crCashedOut) return;
    crCashedOut = true;
    
    const payout = Math.floor(crBet * crMultiplier);
    playerTokens += payout;
    updateTokenDisplays();
    
    document.getElementById('cr_result').innerHTML = `<span style="color:#0f0;">üí∞ Cashed out at ${crMultiplier.toFixed(2)}x! +${payout} tokens</span>`;
    document.getElementById('cr_cashout_btn').style.display = 'none';
    document.getElementById('cr_start_btn').style.display = 'inline-block';
}

// ========== COIN FLIP ==========
let cfBet = 10, cfFlipping = false, cfStreak = 0, cfBestStreak = 0, cfWins = 0, cfLosses = 0, cfHistory = [];

function cfChangeBet(amt) {
    if (amt === 'max') { cfBet = Math.max(10, playerTokens); }
    else { cfBet = Math.max(10, cfBet + amt); }
    cfBet = Math.min(cfBet, playerTokens);
    document.getElementById('cf_bet_display').textContent = cfBet;
}

function cfFlip(choice) {
    if (cfFlipping || playerTokens < cfBet) {
        if (playerTokens < cfBet) document.getElementById('cf_result').innerHTML = '<span style="color:#f00;">Not enough tokens!</span>';
        return;
    }
    
    cfFlipping = true;
    playerTokens -= cfBet;
    updateTokenDisplays();
    
    document.getElementById('cf_heads_btn').disabled = true;
    document.getElementById('cf_tails_btn').disabled = true;
    
    const coin = document.getElementById('cf_coin');
    const resultEl = document.getElementById('cf_result');
    resultEl.innerHTML = '';
    coin.classList.remove('win','lose');
    coin.classList.add('flipping');
    
    // Flip animation
    let flips = 0;
    const flipInterval = setInterval(() => {
        coin.textContent = flips % 2 === 0 ? 'ü©∏' : 'üíÄ';
        flips++;
        
        if (flips > 12) {
            clearInterval(flipInterval);
            coin.classList.remove('flipping');
            
            const result = Math.random() < 0.5 ? 'heads' : 'tails';
            coin.textContent = result === 'heads' ? 'ü©∏' : 'üíÄ';
            
            const won = choice === result;
            const cfAr = document.getElementById('cf_arena');
            
            if (won) {
                const payout = cfBet * 2;
                playerTokens += payout;
                cfStreak++;
                cfWins++;
                if (cfStreak > cfBestStreak) cfBestStreak = cfStreak;
                resultEl.innerHTML = `<span style="color:#0f0;">${result === 'heads' ? 'ü©∏' : 'üíÄ'} ${result.toUpperCase()}! +${payout} tokens</span>`;
                coin.classList.add('win');
                if (cfAr) { cfAr.classList.add('win-flash'); setTimeout(() => cfAr.classList.remove('win-flash'), 800); }
            } else {
                cfStreak = 0;
                cfLosses++;
                resultEl.innerHTML = `<span style="color:#f00;">${result === 'heads' ? 'ü©∏' : 'üíÄ'} ${result.toUpperCase()} ‚Äî You lose</span>`;
                coin.classList.add('lose');
                if (cfAr) { cfAr.classList.add('lose-flash'); setTimeout(() => cfAr.classList.remove('lose-flash'), 800); }
            }
            
            cfHistory.unshift({ result, won });
            if (cfHistory.length > 20) cfHistory.pop();
            
            updateTokenDisplays();
            savePlayerTokens();
            
            document.getElementById('cf_streak').textContent = cfStreak;
            document.getElementById('cf_best_streak').textContent = cfBestStreak;
            document.getElementById('cf_record').textContent = cfWins + '/' + cfLosses;
            document.getElementById('cf_history').innerHTML = cfHistory.map(h => {
                const bg = h.won ? '#0a0' : '#a00';
                return `<div style="width:20px; height:20px; border-radius:50%; background:${bg}; display:flex; align-items:center; justify-content:center; font-size:9px; border:1px solid ${h.won ? '#0f0' : '#f00'}33;">${h.result === 'heads' ? 'ü©∏' : 'üíÄ'}</div>`;
            }).join('');
            
            document.getElementById('cf_heads_btn').disabled = false;
            document.getElementById('cf_tails_btn').disabled = false;
            cfFlipping = false;
        }
    }, 90);
}

// ========== SLOTS ==========
const slotSymbols = ['üßõ', 'ü©∏', '‚ö∞Ô∏è', 'üíÄ', 'üåô', 'üó°Ô∏è'];
let slotsSpinning = false;

function spinSlots() {
    if (slotsSpinning) return;
    if (playerTokens < 10) {
        document.getElementById('slots_result').innerHTML = '<span style="color:#f00;">Not enough tokens!</span>';
        return;
    }
    
    playerTokens -= 10;
    updateTokenDisplays();
    slotsSpinning = true;
    
    const slot1 = document.getElementById('slot1');
    const slot2 = document.getElementById('slot2');
    const slot3 = document.getElementById('slot3');
    const resultEl = document.getElementById('slots_result');
    const spinBtn = document.getElementById('spin_btn');
    
    spinBtn.disabled = true;
    resultEl.innerHTML = '';
    slot1.classList.add('spinning');
    slot2.classList.add('spinning');
    slot3.classList.add('spinning');
    
    // Random spin animation
    let spinCount = 0;
    const spinInterval = setInterval(() => {
        slot1.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        slot2.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        slot3.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        spinCount++;
        
        if (spinCount > 20) {
            clearInterval(spinInterval);
            
            // Final results (slightly weighted)
            const results = [
                slotSymbols[Math.floor(Math.random() * slotSymbols.length)],
                slotSymbols[Math.floor(Math.random() * slotSymbols.length)],
                slotSymbols[Math.floor(Math.random() * slotSymbols.length)]
            ];
            
            slot1.textContent = results[0];
            slot2.textContent = results[1];
            slot3.textContent = results[2];
            
            slot1.classList.remove('spinning');
            slot2.classList.remove('spinning');
            slot3.classList.remove('spinning');
            
            // Calculate winnings (max 500)
            let winnings = 0;
            const arena = document.getElementById('slots_arena');
            [slot1,slot2,slot3].forEach(s => s.classList.remove('win-highlight'));
            
            if (results[0] === results[1] && results[1] === results[2]) {
                // Three of a kind
                switch(results[0]) {
                    case 'üßõ': winnings = 500; break;
                    case 'ü©∏': winnings = 250; break;
                    case '‚ö∞Ô∏è': winnings = 100; break;
                    case 'üíÄ': winnings = 50; break;
                    default: winnings = 25; break;
                }
                resultEl.innerHTML = `<span style="color:#ffd700;">üé∞ JACKPOT! +${winnings} tokens!</span>`;
                [slot1,slot2,slot3].forEach(s => s.classList.add('win-highlight'));
                if (arena) arena.classList.add('win-flash');
                setTimeout(() => { if (arena) arena.classList.remove('win-flash'); }, 800);
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                // Two of a kind
                winnings = 15;
                resultEl.innerHTML = `<span style="color:#0f0;">Match! +${winnings} tokens</span>`;
                if (results[0] === results[1]) { slot1.classList.add('win-highlight'); slot2.classList.add('win-highlight'); }
                if (results[1] === results[2]) { slot2.classList.add('win-highlight'); slot3.classList.add('win-highlight'); }
                if (results[0] === results[2]) { slot1.classList.add('win-highlight'); slot3.classList.add('win-highlight'); }
            } else {
                resultEl.innerHTML = '<span style="color:#555;">No match</span>';
                if (arena) arena.classList.add('lose-flash');
                setTimeout(() => { if (arena) arena.classList.remove('lose-flash'); }, 800);
            }
            
            playerTokens += winnings;
            updateTokenDisplays();
            savePlayerTokens();
            
            // Track slot wins
            if (winnings > 0 && CURRENT_USER && !IS_GUEST) {
                db.ref('game_stats/slots/' + CURRENT_USER + '/totalWinnings').transaction((current) => {
                    return (current || 0) + winnings;
                });
            }
            
            spinBtn.disabled = false;
            slotsSpinning = false;
        }
    }, 80);
}

// ========== SNAKE GAME ==========
let snakeGame = null;
let snakeInterval = null;
let snakeScore = 0;

function startSnakeGame() {
    const canvas = document.getElementById('snake_canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    // Stop existing game
    if (snakeInterval) clearInterval(snakeInterval);
    
    const gridSize = 20;
    const tileCount = 14;
    
    let snake = [{ x: 7, y: 7 }];
    let food = { x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount) };
    let dx = 0, dy = 0;
    let score = 0;
    let gameRunning = true;
    let gameStarted = false; // Wait for first keypress
    
    // Handle input
    const handleKey = (e) => {
        if (!gameRunning) return;
        switch(e.key.toLowerCase()) {
            case 'arrowup': case 'w': if (dy !== 1) { dx = 0; dy = -1; gameStarted = true; } break;
            case 'arrowdown': case 's': if (dy !== -1) { dx = 0; dy = 1; gameStarted = true; } break;
            case 'arrowleft': case 'a': if (dx !== 1) { dx = -1; dy = 0; gameStarted = true; } break;
            case 'arrowright': case 'd': if (dx !== -1) { dx = 1; dy = 0; gameStarted = true; } break;
        }
        e.preventDefault(); // Prevent page scroll
    };
    
    document.addEventListener('keydown', handleKey);
    
    function gameLoop() {
        if (!gameRunning) return;
        
        // Draw first (even before movement starts)
        ctx.fillStyle = '#0a0000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw food (blood drop)
        ctx.fillStyle = '#d40000';
        ctx.beginPath();
        ctx.arc(food.x * gridSize + gridSize/2, food.y * gridSize + gridSize/2, gridSize/2 - 2, 0, Math.PI * 2);
        ctx.fill();
        
        // Draw snake
        snake.forEach((segment, i) => {
            ctx.fillStyle = i === 0 ? '#ff0000' : '#880000';
            ctx.fillRect(segment.x * gridSize + 1, segment.y * gridSize + 1, gridSize - 2, gridSize - 2);
        });
        
        // Don't move until player presses a key
        if (!gameStarted) return;
        
        // Move snake
        const head = { x: snake[0].x + dx, y: snake[0].y + dy };
        
        // Check wall collision
        if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
            gameRunning = false;
            endSnakeGame(score);
            document.removeEventListener('keydown', handleKey);
            return;
        }
        
        // Check self collision
        for (let segment of snake) {
            if (head.x === segment.x && head.y === segment.y) {
                gameRunning = false;
                endSnakeGame(score);
                document.removeEventListener('keydown', handleKey);
                return;
            }
        }
        
        snake.unshift(head);
        
        // Check food
        if (head.x === food.x && head.y === food.y) {
            score++;
            document.getElementById('snake_score').textContent = 'Score: ' + score;
            // Make sure food doesn't spawn on snake
            do {
                food = { x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount) };
            } while (snake.some(s => s.x === food.x && s.y === food.y));
        } else {
            snake.pop();
        }
    }
    
    snakeInterval = setInterval(gameLoop, 120);
    document.getElementById('snake_score').textContent = 'Press arrow keys or WASD to start!';
}

function endSnakeGame(score) {
    if (snakeInterval) clearInterval(snakeInterval);
    snakeInterval = null;
    
    // Award tokens (1 per drop, max 200)
    const tokens = Math.min(score, 200);
    if (tokens > 0 && CURRENT_USER && !IS_GUEST) {
        playerTokens += tokens;
        updateTokenDisplays();
        savePlayerTokens();
        
        // Save high score
        db.ref('game_stats/snake/' + CURRENT_USER).once('value', (snap) => {
            const current = snap.val() || { highScore: 0 };
            if (score > (current.highScore || 0)) {
                db.ref('game_stats/snake/' + CURRENT_USER).set({ highScore: score, lastPlayed: Date.now() });
            }
        });
    }
    
    document.getElementById('snake_score').textContent = `Game Over! Score: ${score} (+${tokens} tokens)`;
}

// ========== DAILY LOGIN BONUS ==========
function loadDailyStatus() {
    if (!CURRENT_USER || IS_GUEST) {
        document.getElementById('login_bonus_status').textContent = 'Login to claim daily rewards';
        document.getElementById('claim_login_btn').disabled = true;
        document.getElementById('daily_spin_btn').disabled = true;
        return;
    }
    
    db.ref('game_stats/daily/' + CURRENT_USER).once('value', (snap) => {
        const data = snap.val() || {};
        const today = new Date().toDateString();
        const lastClaim = data.lastClaim || '';
        const streak = data.streak || 0;
        const lastSpin = data.lastSpin || '';
        
        // Update streak display
        for (let i = 1; i <= 7; i++) {
            const dayEl = document.getElementById('streak_day_' + i);
            if (dayEl) {
                dayEl.classList.remove('claimed');
                if (i <= streak) dayEl.classList.add('claimed');
            }
        }
        
        // Check if already claimed today
        if (lastClaim === today) {
            document.getElementById('login_bonus_status').innerHTML = `<span style="color:#0f0;">Already claimed today! Streak: ${streak}</span>`;
            document.getElementById('claim_login_btn').disabled = true;
        } else {
            document.getElementById('login_bonus_status').innerHTML = `<span style="color:#ffd700;">Streak: ${streak} - Claim your bonus!</span>`;
            document.getElementById('claim_login_btn').disabled = false;
        }
        
        // Check daily spin
        if (lastSpin === today) {
            document.getElementById('daily_spin_btn').disabled = true;
            document.getElementById('daily_spin_btn').textContent = 'Spun Today';
        } else {
            document.getElementById('daily_spin_btn').disabled = false;
            document.getElementById('daily_spin_btn').textContent = 'SPIN';
        }
    });
}

function claimLoginBonus() {
    if (!CURRENT_USER || IS_GUEST) return;
    
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    
    db.ref('game_stats/daily/' + CURRENT_USER).once('value', (snap) => {
        const data = snap.val() || {};
        const lastClaim = data.lastClaim || '';
        let streak = data.streak || 0;
        
        if (lastClaim === today) return;
        
        // Check if streak continues or resets
        if (lastClaim === yesterday) {
            streak = Math.min(streak + 1, 7);
        } else {
            streak = 1;
        }
        
        // Calculate bonus based on streak
        const bonuses = [10, 15, 20, 30, 40, 50, 100]; // Day 1-7 bonuses
        const bonus = bonuses[streak - 1] || 10;
        
        playerTokens += bonus;
        updateTokenDisplays();
        savePlayerTokens();
        
        db.ref('game_stats/daily/' + CURRENT_USER).update({
            lastClaim: today,
            streak: streak
        });
        
        document.getElementById('login_bonus_status').innerHTML = `<span style="color:#0f0;">+${bonus} tokens! Streak: ${streak}</span>`;
        document.getElementById('claim_login_btn').disabled = true;
        
        // Update streak display
        for (let i = 1; i <= 7; i++) {
            const dayEl = document.getElementById('streak_day_' + i);
            if (dayEl) {
                dayEl.classList.remove('claimed');
                if (i <= streak) dayEl.classList.add('claimed');
            }
        }
    });
}

function spinDailyWheel() {
    if (!CURRENT_USER || IS_GUEST) return;
    
    const today = new Date().toDateString();
    const wheel = document.getElementById('wheel_spinner');
    const resultEl = document.getElementById('spin_reward');
    const btn = document.getElementById('daily_spin_btn');
    
    btn.disabled = true;
    
    // Spin animation
    const spins = 5 + Math.random() * 3;
    const degrees = spins * 360 + Math.random() * 360;
    wheel.style.transform = `rotate(${degrees}deg)`;
    
    // Calculate reward based on where it lands
    const rewards = [5, 10, 15, 20, 25, 50, 75, 100];
    const rewardIndex = Math.floor(((degrees % 360) / 360) * rewards.length);
    const reward = rewards[rewardIndex];
    
    setTimeout(() => {
        playerTokens += reward;
        updateTokenDisplays();
        savePlayerTokens();
        
        db.ref('game_stats/daily/' + CURRENT_USER + '/lastSpin').set(today);
        
        resultEl.innerHTML = `<span style="color:#ffd700;">+${reward} tokens!</span>`;
        btn.textContent = 'Spun Today';
    }, 3000);
}

// ========== GIFT TOKENS ==========
function showGiftTokens() {
    if (!CURRENT_USER || IS_GUEST) {
        alert('Login to gift tokens');
        return;
    }
    document.getElementById('gift_modal').style.display = 'flex';
    document.getElementById('gift_result').innerHTML = '';
    document.getElementById('gift_username').value = '';
    document.getElementById('gift_amount').value = '';
}

function hideGiftModal() {
    document.getElementById('gift_modal').style.display = 'none';
}

function sendGift() {
    const username = document.getElementById('gift_username').value.trim();
    const amount = parseInt(document.getElementById('gift_amount').value);
    const resultEl = document.getElementById('gift_result');
    
    if (!username) {
        resultEl.innerHTML = '<span style="color:#f00;">Enter a username</span>';
        return;
    }
    if (!amount || amount < 1) {
        resultEl.innerHTML = '<span style="color:#f00;">Enter a valid amount</span>';
        return;
    }
    if (amount > playerTokens) {
        resultEl.innerHTML = '<span style="color:#f00;">Not enough tokens</span>';
        return;
    }
    if (username === CURRENT_USER) {
        resultEl.innerHTML = '<span style="color:#f00;">Cannot gift yourself</span>';
        return;
    }
    if (!userDatabase[username]) {
        resultEl.innerHTML = '<span style="color:#f00;">User not found</span>';
        return;
    }
    
    // Transfer tokens
    playerTokens -= amount;
    updateTokenDisplays();
    savePlayerTokens();
    
    db.ref('game_stats/tokens/' + username).transaction((current) => {
        return (current || 0) + amount;
    }).then(() => {
        resultEl.innerHTML = `<span style="color:#0f0;">Sent ${amount} tokens to ${username}!</span>`;
        
        // Log gift
        db.ref('game_stats/gifts').push({
            from: CURRENT_USER,
            to: username,
            amount: amount,
            timestamp: Date.now()
        });
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        // Refund on error
        playerTokens += amount;
        updateTokenDisplays();
        savePlayerTokens();
    });
}

// ========== TOKEN LEADERBOARD ==========
function showTokenLeaderboard() {
    document.getElementById('token_leaderboard_modal').style.display = 'flex';
    loadTokenLeaderboard();
}

function hideTokenLeaderboard() {
    document.getElementById('token_leaderboard_modal').style.display = 'none';
}

function loadTokenLeaderboard() {
    const container = document.getElementById('token_leaderboard_list');
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading...</div>';
    
    db.ref('game_stats/tokens').once('value', (snap) => {
        const data = snap.val() || {};
        const sorted = Object.entries(data)
            .map(([user, tokens]) => ({ user, tokens }))
            .sort((a, b) => b.tokens - a.tokens)
            .slice(0, 20);
        
        if (sorted.length === 0) {
            container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">No data yet</div>';
            return;
        }
        
        container.innerHTML = sorted.map((entry, i) => {
            const medal = i === 0 ? '1st' : i === 1 ? '2nd' : i === 2 ? '3rd' : `#${i+1}`;
            const style = userDatabase[entry.user]?.style || 'member-style';
            const isMe = entry.user === CURRENT_USER;
            return `<div style="display:flex; align-items:center; padding:8px; background:${isMe ? '#1a0808' : '#0a0505'}; border:1px solid ${isMe ? '#d40000' : '#300'}; border-radius:4px; margin-bottom:5px;">
                <span style="width:40px; color:${i < 3 ? '#ffd700' : '#888'}; font-weight:bold;">${medal}</span>
                <span class="${style}" style="flex:1; cursor:pointer;" onclick="viewUserProfile('${entry.user}')">${entry.user}</span>
                <span style="color:#d40000; font-weight:bold;">${entry.tokens}</span>
            </div>`;
        }).join('');
    });
}

// ========== TOKEN SHOP ==========
let shopItems = {};

function loadShopItems() {
    const container = document.getElementById('shop_items');
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px; grid-column:span 3;">Loading shop...</div>';
    
    db.ref('shop_items').once('value', (snap) => {
        shopItems = snap.val() || {};
        
        if (Object.keys(shopItems).length === 0) {
            container.innerHTML = '<div style="color:#888; text-align:center; padding:20px; grid-column:span 3;">Shop is empty. ST can add items.</div>';
            return;
        }
        
        // Get user's owned items
        db.ref('profiles/' + CURRENT_USER + '/shopItems').once('value', (ownedSnap) => {
            const ownedItems = ownedSnap.val() || {};
            
            container.innerHTML = Object.entries(shopItems).map(([id, item]) => {
                const owned = ownedItems[id];
                const imgHtml = item.imageUrl ? 
                    `<img src="${item.imageUrl}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/50?text=?'">` :
                    `<div style="width:50px; height:50px; display:flex; align-items:center; justify-content:center; font-size:24px; border-radius:50%; ${item.type === 'effect' ? 'background:radial-gradient(circle,#111,#000); box-shadow:0 0 10px rgba(255,0,0,0.5);' : ''}">${item.type === 'effect' ? '‚ú®' : '?'}</div>`;
                const typeLabel = item.type === 'effect' ? ' <span style="color:#ff00ff; font-size:8px;">[FX]</span>' : (item.type === 'badge' ? ' <span style="color:#ffd700; font-size:8px;">[BADGE]</span>' : '');
                return `<div class="shop-item ${owned ? 'owned' : ''}" onclick="${owned ? `equipItem('${id}')` : `buyShopItem('${id}')`}">
                    ${imgHtml}
                    <div style="color:#fff; font-size:10px; font-weight:bold;">${escapeHtml(item.name)}${typeLabel}</div>
                    <div style="color:${owned ? '#0f0' : '#ffd700'}; font-size:9px;">${owned ? 'OWNED' : item.price + ' tokens'}</div>
                </div>`;
            }).join('');
        });
    });
    
    loadEquippedItems();
}

function buyShopItem(itemId) {
    if (!CURRENT_USER || IS_GUEST) {
        alert('Login to buy items');
        return;
    }
    
    const item = shopItems[itemId];
    if (!item) return;
    
    if (playerTokens < item.price) {
        alert('Not enough tokens! Need ' + item.price);
        return;
    }
    
    if (!confirm(`Buy "${item.name}" for ${item.price} tokens?`)) return;
    
    playerTokens -= item.price;
    updateTokenDisplays();
    savePlayerTokens();
    
    db.ref('profiles/' + CURRENT_USER + '/shopItems/' + itemId).set({
        purchasedAt: Date.now(),
        equipped: false
    }).then(() => {
        loadShopItems();
    });
}

function equipItem(itemId) {
    if (!CURRENT_USER || IS_GUEST) return;
    
    const item = shopItems[itemId];
    if (!item) return;
    
    // Check if we're equipping or unequipping
    db.ref('profiles/' + CURRENT_USER + '/shopItems/' + itemId + '/equipped').once('value', (snap) => {
        const isCurrentlyEquipped = snap.val();
        
        if (isCurrentlyEquipped) {
            // Just unequip this item
            db.ref('profiles/' + CURRENT_USER + '/shopItems/' + itemId + '/equipped').set(false).then(() => {
                loadEquippedItems();
                loadShopItems();
            });
        } else {
            // Equipping - first unequip any other items of the same type
            db.ref('profiles/' + CURRENT_USER + '/shopItems').once('value', (allSnap) => {
                const allItems = allSnap.val() || {};
                const updates = {};
                
                // Find and unequip items of the same type
                for (const [id, data] of Object.entries(allItems)) {
                    if (data.equipped && shopItems[id] && shopItems[id].type === item.type) {
                        updates['profiles/' + CURRENT_USER + '/shopItems/' + id + '/equipped'] = false;
                    }
                }
                
                // Equip the new item
                updates['profiles/' + CURRENT_USER + '/shopItems/' + itemId + '/equipped'] = true;
                
                db.ref().update(updates).then(() => {
                    loadEquippedItems();
                    loadShopItems();
                });
            });
        }
    });
}

// Effect name to CSS class mapping
const EFFECT_MAP = {
    'blood-glow': 'fx-blood-glow',
    'hellfire': 'fx-hellfire',
    'phantom': 'fx-phantom',
    'toxic': 'fx-toxic',
    'void': 'fx-void',
    'rainbow': 'fx-rainbow',
    'glitch': 'fx-glitch',
    'golden': 'fx-golden',
    'beautiful-mind': 'fx-beautiful-mind'
};

function applyAvatarEffect(wrapperEl, effectEl, effectName) {
    // Remove any existing effect classes
    Object.values(EFFECT_MAP).forEach(cls => wrapperEl.classList.remove(cls));
    // Apply the effect class to the wrapper
    const cls = EFFECT_MAP[effectName];
    if (cls) {
        wrapperEl.classList.add(cls);
    }
}

function loadEquippedItems() {
    const container = document.getElementById('equipped_items');
    if (!container || !CURRENT_USER || IS_GUEST) return;
    
    db.ref('profiles/' + CURRENT_USER + '/shopItems').once('value', (snap) => {
        const items = snap.val() || {};
        const equipped = Object.entries(items).filter(([id, data]) => data.equipped);
        
        const effectEl = document.getElementById('my_avatar_effect');
        const avatarEl = document.getElementById('my_avatar_display');
        const wrapperEl = document.getElementById('my_avatar_wrapper');
        
        if (effectEl) effectEl.innerHTML = '';
        if (wrapperEl) wrapperEl.className = '';
        
        if (equipped.length === 0) {
            container.innerHTML = '<span style="color:#666; font-size:10px;">None equipped</span>';
            return;
        }
        
        let listHtml = '';
        let effectName = '';
        
        for (const [id, data] of equipped) {
            const item = shopItems[id];
            if (!item) continue;
            
            if (item.type === 'effect') {
                effectName = item.effectClass || item.name.toLowerCase().replace(/\s+/g, '-');
            }
            
            listHtml += `<div style="background:#0a0505; border:1px solid #0a0; border-radius:4px; padding:5px; display:flex; align-items:center; gap:5px;">
                <img src="${item.imageUrl || ''}" style="width:20px; height:20px; object-fit:contain;" onerror="this.style.display='none'">
                <span style="color:#0f0; font-size:9px;">${escapeHtml(item.name)}</span>
            </div>`;
        }
        
        // Effect: apply CSS class to wrapper
        if (effectName && wrapperEl) {
            applyAvatarEffect(wrapperEl, effectEl, effectName);
        }
        
        container.innerHTML = listHtml || '<span style="color:#666; font-size:10px;">None equipped</span>';
    });
}

// ========== VIP DISPLAY NAME ==========
function saveDisplayName() {
    const displayName = document.getElementById('vip_display_name').value.trim();
    const resultEl = document.getElementById('display_name_result');
    
    if (!CURRENT_USER || IS_GUEST) {
        resultEl.innerHTML = '<span style="color:#f00;">Must be logged in.</span>';
        return;
    }
    
    // Validate display name
    if (displayName.length > 25) {
        resultEl.innerHTML = '<span style="color:#f00;">Max 25 characters.</span>';
        return;
    }
    
    // Save to profile and update global variable
    db.ref('profiles/' + CURRENT_USER + '/displayName').set(displayName || null).then(() => {
        currentUserDisplayName = displayName || null;
        resultEl.innerHTML = displayName ? 
            '<span style="color:#0f0;">‚úì Display name saved!</span>' : 
            '<span style="color:#888;">Display name cleared.</span>';
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadDisplayName() {
    if (!CURRENT_USER || IS_GUEST) return;
    db.ref('profiles/' + CURRENT_USER + '/displayName').once('value', (snap) => {
        const displayName = snap.val();
        currentUserDisplayName = displayName || null;
        const input = document.getElementById('vip_display_name');
        if (input && displayName) input.value = displayName;
    });
}

// APPLICATION SYSTEM
function submitApplication() {
    const username = sanitizeInput(document.getElementById('app_username').value.trim());
    const reason = sanitizeProfileField(document.getElementById('app_reason').value.trim(), 500);
    const referral = sanitizeInput(document.getElementById('app_referral').value.trim());
    if (!username || !reason) { alert('Fill required fields.'); return; }
    if (username.length < 2 || username.length > 20) { alert('Username must be 2-20 characters.'); return; }
    db.ref('applications/' + Date.now()).set({ 
        username: username, 
        referral: referral, 
        reason: reason, 
        date: new Date().toLocaleDateString(), 
        status: 'pending', 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    });
    document.getElementById('app_form').style.display = 'none';
    document.getElementById('app_result').innerHTML = '<div class="app-status app-pending"><strong>ü©∏ Blood Pact Received</strong></div>';
    document.getElementById('app_result').style.display = 'block';
}
function checkAppStatus() {
    const username = document.getElementById('app_username').value.trim();
    if (!username) { alert('Enter username.'); return; }
    db.ref('applications').orderByChild('username').equalTo(username).once('value', (s) => {
        let app = null; s.forEach((c) => { app = c.val(); });
        const rd = document.getElementById('app_result');
        document.getElementById('app_form').style.display = 'none'; rd.style.display = 'block';
        if (!app) rd.innerHTML = '<div class="app-status" style="border-color:#888; color:#888;">No application found.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'pending') rd.innerHTML = '<div class="app-status app-pending">üïê Pending review.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'approved') rd.innerHTML = '<div class="app-status" style="border-color:#0f0; color:#0f0;">‚úì Approved!</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else rd.innerHTML = '<div class="app-status" style="border-color:#f00; color:#f00;">‚úó Denied.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
    });
}
function resetAppForm() { document.getElementById('app_form').style.display = 'block'; document.getElementById('app_result').style.display = 'none'; }
function enterGuestChat() { IS_GUEST = true; CURRENT_USER = "Guest_" + Math.floor(Math.random() * 9999); toggleWin('chat_win'); loadMessages(); startOnlineListener(); document.getElementById('chat_input').placeholder = "Lurking (read-only)..."; document.getElementById('chat_input').disabled = true; }

// LEADERBOARD SYSTEM
function switchLeaderboardTab(tab, el) {
    document.querySelectorAll('#leaderboard_window .tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('leaderboard_minesweeper').style.display = tab === 'minesweeper' ? 'block' : 'none';
    document.getElementById('leaderboard_activity').style.display = tab === 'activity' ? 'block' : 'none';
    document.getElementById('leaderboard_clubs').style.display = tab === 'clubs' ? 'block' : 'none';
}

function loadLeaderboards() {
    loadMinesweeperLeaderboard();
    loadActivityLeaderboard();
    loadClubsLeaderboard();
}

function loadMinesweeperLeaderboard() {
    const container = document.getElementById('minesweeper_leaderboard');
    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Loading...</div>';
    
    db.ref('game_stats/minesweeper').orderByChild('wins').once('value', (snap) => {
        const stats = snap.val() || {};
        const sorted = Object.entries(stats)
            .map(([user, data]) => ({ user, wins: data.wins || 0, played: data.gamesPlayed || 0, lastWin: data.lastWin || 0 }))
            .sort((a, b) => b.wins - a.wins)
            .slice(0, 20);
        
        if (sorted.length === 0) {
            container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No winners yet! Be the first to survive Silver Stakes.</div>';
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column; gap: 5px;">';
        sorted.forEach((entry, idx) => {
            const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`;
            const style = userDatabase[entry.user]?.style || 'member-style';
            const isCurrentUser = entry.user === CURRENT_USER;
            const winRate = entry.played > 0 ? Math.round((entry.wins / entry.played) * 100) : 0;
            html += `<div style="display: flex; align-items: center; padding: 8px; background: ${isCurrentUser ? '#1a0808' : '#0a0505'}; border: 1px solid ${isCurrentUser ? '#d40000' : '#300'}; border-radius: 4px;">
                <span style="width: 35px; font-size: 14px;">${medal}</span>
                <span class="${style}" style="flex: 1; cursor: pointer;" onclick="viewUserProfile('${entry.user}')">${entry.user}</span>
                <div style="text-align:right;">
                    <span style="color: #ff6600; font-weight: bold;">${entry.wins} wins</span>
                    <span style="color: #666; font-size:9px; display:block;">${entry.played} played (${winRate}%)</span>
                </div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    });
}

function loadActivityLeaderboard() {
    const container = document.getElementById('activity_leaderboard');
    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Loading...</div>';
    
    // Get today's date key
    const today = new Date().toISOString().split('T')[0];
    
    // Load activity stats
    db.ref('activity_stats').once('value', (snap) => {
        const allStats = snap.val() || {};
        const activityData = [];
        
        Object.keys(allStats).forEach(username => {
            const userData = allStats[username];
            const todayCount = userData[today] || 0;
            const totalCount = userData.total || 0;
            
            if (totalCount > 0) {
                activityData.push({
                    user: username,
                    today: todayCount,
                    total: totalCount
                });
            }
        });
        
        // Sort by total messages
        activityData.sort((a, b) => b.total - a.total);
        const sorted = activityData.slice(0, 20);
        
        if (sorted.length === 0) {
            container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No activity recorded yet.<br><span style="font-size:9px;">Send messages to appear on the leaderboard!</span></div>';
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column; gap: 5px;">';
        html += '<div style="color: #666; font-size: 9px; text-align: center; margin-bottom: 5px;">Anti-spam: 5 second cooldown between counted messages</div>';
        sorted.forEach((entry, idx) => {
            const medal = idx === 0 ? 'üî•' : idx === 1 ? '‚ö°' : idx === 2 ? 'üí´' : `#${idx + 1}`;
            const style = userDatabase[entry.user]?.style || 'member-style';
            const isCurrentUser = entry.user === CURRENT_USER;
            html += `<div style="display: flex; align-items: center; padding: 8px; background: ${isCurrentUser ? '#1a0808' : '#0a0505'}; border: 1px solid ${isCurrentUser ? '#d40000' : '#300'}; border-radius: 4px;">
                <span style="width: 35px; font-size: 14px;">${medal}</span>
                <span class="${style}" style="flex: 1; cursor: pointer;" onclick="viewUserProfile('${entry.user}')">${entry.user}</span>
                <div style="text-align:right;">
                    <span style="color: #0af;">${entry.total} total</span>
                    <span style="color: #666; font-size:9px; display:block;">Today: ${entry.today}</span>
                </div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }).catch(err => {
        container.innerHTML = '<div style="color: #f00; text-align: center; padding: 20px;">Error loading activity: ' + err.message + '</div>';
    });
}

function loadClubsLeaderboard() {
    const container = document.getElementById('clubs_leaderboard');
    container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Loading...</div>';
    
    db.ref('clubs').once('value', (snap) => {
        const clubs = snap.val() || {};
        const sorted = Object.entries(clubs)
            .map(([id, data]) => ({ 
                id: id,
                displayName: data.name || id, // Use the actual club name, not the ID
                members: data.members ? (Array.isArray(data.members) ? data.members.length : Object.keys(data.members).length) : 0,
                owner: data.owner || 'Unknown',
                tag: data.tag || '',
                color: data.color || '#d40000'
            }))
            .sort((a, b) => b.members - a.members)
            .slice(0, 15);
        
        if (sorted.length === 0) {
            container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No clubs created yet.</div>';
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column; gap: 5px;">';
        sorted.forEach((club, idx) => {
            const medal = idx === 0 ? '1st' : idx === 1 ? '2nd' : idx === 2 ? '3rd' : `#${idx + 1}`;
            html += `<div style="padding: 10px; background: #0a0505; border: 1px solid #300; border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">${medal}</span>
                    <div style="flex: 1;">
                        <div style="color: ${escapeHtml(club.color)}; font-weight: bold;">${club.tag ? '[' + escapeHtml(club.tag) + '] ' : ''}${escapeHtml(club.displayName)}</div>
                        <div style="color: #666; font-size: 9px;">Owner: ${escapeHtml(club.owner)}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #ff6600; font-weight: bold;">${club.members}</div>
                        <div style="color: #666; font-size: 9px;">members</div>
                    </div>
                </div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    });
}

// LOGIN SYSTEM
// ==================== SIMPLIFIED SECURITY ====================

// Basic anti-tampering (non-breaking)
document.addEventListener('contextmenu', (e) => e.preventDefault());
document.addEventListener('keydown', (e) => {
    if (e.key === 'F12') { e.preventDefault(); return false; }
    if (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) { e.preventDefault(); return false; }
    if (e.ctrlKey && e.key.toUpperCase() === 'U') { e.preventDefault(); return false; }
});

// Store current session info
let currentSessionToken = null;

// Main login function
async function validateIE() {
    const userInput = document.getElementById('ie_user');
    const passInput = document.getElementById('ie_pass');
    
    if (!userInput || !passInput) {
        alert("Error: Login form not found. Please refresh the page.");
        return;
    }
    
    let u = userInput.value.trim();
    const p = passInput.value;
    
    if (!u || !p) { 
        alert("Enter username and password."); 
        return; 
    }
    
    // Find correct username casing from coreAdmins first
    let foundUser = null;
    for (const coreUser of Object.keys(coreAdmins)) {
        if (coreUser.toLowerCase() === u.toLowerCase()) {
            foundUser = coreUser;
            break;
        }
    }
    if (foundUser) {
        u = foundUser;
    } else {
        u = u.toLowerCase(); // Regular users are lowercase
    }
    
    if (!db || !auth) {
        alert("Error: Firebase not initialized. Please refresh the page.");
        return;
    }
    
    // Check if banned
    try {
        const banSnap = await db.ref('bans/' + u.toLowerCase()).once('value');
        const ban = banSnap.val();
        if (ban && (ban.expiry === 0 || ban.expiry > Date.now())) { 
            alert('Account banned/suspended.'); 
            return; 
        }
    } catch (e) {}
    
    const email = u.toLowerCase() + '@fangtasia.wtf';
    
    // PRIORITY 1: Check coreAdmins (hardcoded staff)
    if (coreAdmins[u] && coreAdmins[u].pass === p) {
        console.log('Core admin password verified:', u);
        userDatabase[u] = { ...userDatabase[u], ...coreAdmins[u] };
        
        // Still authenticate with Firebase so they can use chat/features
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, p);
            FIREBASE_USER = userCredential.user;
            console.log('Core admin Firebase auth success');
        } catch (authErr) {
            console.log('Core admin Firebase auth failed:', authErr.code);
            // Try to create Firebase account for this admin
            if (authErr.code === 'auth/user-not-found') {
                try {
                    const newUser = await auth.createUserWithEmailAndPassword(email, p);
                    FIREBASE_USER = newUser.user;
                    await db.ref('user_uids/' + u).set(FIREBASE_USER.uid);
                    await db.ref('uid_users/' + FIREBASE_USER.uid).set(u);
                    console.log('Created Firebase account for core admin');
                } catch (createErr) {
                    console.log('Could not create Firebase account:', createErr.code);
                    // Proceed anyway - some features may not work
                }
            } else if (authErr.code === 'auth/wrong-password') {
                // Firebase has different password - update it
                // For now, just proceed without Firebase auth
                console.log('Firebase has different password, proceeding without auth');
            }
        }
        
        proceedWithLogin(u);
        return;
    }
    
    // PRIORITY 2: Check auth_users (ST-created accounts with hashed passwords)
    try {
        const authSnap = await db.ref('auth_users/' + u.toLowerCase()).once('value');
        const authData = authSnap.val();
        if (authData && authData.hashedPass) {
            const enteredHash = await hashPassword(p);
            if (authData.hashedPass === enteredHash) {
                console.log('ST-created user authenticated:', u);
                
                // Try Firebase auth
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, p);
                    FIREBASE_USER = userCredential.user;
                } catch (authErr) {
                    if (authErr.code === 'auth/user-not-found') {
                        try {
                            const newUser = await auth.createUserWithEmailAndPassword(email, p);
                            FIREBASE_USER = newUser.user;
                            await db.ref('user_uids/' + u).set(FIREBASE_USER.uid);
                            await db.ref('uid_users/' + FIREBASE_USER.uid).set(u);
                        } catch (e) {}
                    }
                }
                
                const memberSnap = await db.ref('members/' + u).once('value');
                userDatabase[u] = memberSnap.val() || { rank: 'M', fullRank: 'Member', style: 'member-style' };
                proceedWithLogin(u);
                return;
            } else {
                alert("DENIED - Wrong password.");
                return;
            }
        }
    } catch (e) {
        console.log('Auth users check error:', e);
    }
    
    // PRIORITY 3: Try Firebase Auth (email already defined above)
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, p);
        FIREBASE_USER = userCredential.user;
        console.log('Firebase Auth successful:', u);
        
        const memberSnap = await db.ref('members/' + u).once('value');
        userDatabase[u] = memberSnap.val() || { rank: 'M', fullRank: 'Member', style: 'member-style' };
        
        proceedWithLogin(u);
        return;
        
    } catch (authError) {
        console.log('Firebase Auth error:', authError.code);
        
        // Handle specific Firebase errors
        if (authError.code === 'auth/wrong-password' || authError.code === 'auth/invalid-credential') {
            alert("DENIED - Wrong password.");
            return;
        }
        
        if (authError.code === 'auth/too-many-requests') {
            alert("Too many failed attempts. Please wait a few minutes.");
            return;
        }
        
        if (authError.code === 'auth/user-not-found' || authError.code === 'auth/invalid-email') {
            // User doesn't exist in Firebase Auth - check if they exist in members
            try {
                const memberSnap = await db.ref('members/' + u).once('value');
                if (memberSnap.exists()) {
                    // User exists in database but not in Firebase Auth
                    // This is a legacy user - create their Firebase Auth account
                    try {
                        const newUser = await auth.createUserWithEmailAndPassword(email, p);
                        FIREBASE_USER = newUser.user;
                        console.log('Created Firebase Auth for existing member:', u);
                        
                        userDatabase[u] = memberSnap.val();
                        proceedWithLogin(u);
                        return;
                    } catch (createErr) {
                        if (createErr.code === 'auth/email-already-in-use') {
                            // Email exists but password is wrong
                            alert("DENIED - Wrong password. If you forgot your password, contact an admin.");
                            return;
                        }
                        if (createErr.code === 'auth/weak-password') {
                            alert("Password too weak. Use at least 6 characters.");
                            return;
                        }
                        console.log('Create user error:', createErr.code);
                    }
                }
            } catch (e) {}
            
            alert("DENIED - Invalid username or password.");
            return;
        }
        
        // Unknown error
        alert("Login error. Please try again.");
    }
}

function proceedWithLogin(u) {
    // Check if maintenance mode is active - only ST can login
    if (maintenanceEnabled) {
        const userData = coreAdmins[u] || userDatabase[u] || {};
        if (!userData.isST) {
            alert('Site is currently under maintenance. Please try again later.');
            return;
        }
    }
    
    // Generate session token
    currentSessionToken = 'SES-' + Date.now() + '-' + Math.random().toString(36).substr(2, 12);
    
    // Save session to Firebase (non-blocking)
    db.ref('sessions/' + u).set({
        token: currentSessionToken,
        created: Date.now(),
        lastActivity: Date.now()
    }).catch(() => {});
    
    // Make sure coreAdmins data is in userDatabase
    if (coreAdmins[u]) {
        userDatabase[u] = { ...userDatabase[u], ...coreAdmins[u] };
    }
    
    CURRENT_USER = u;
    IS_GUEST = false;
    completeLogin(u);
}

function completeLogin(u) {
    // Ensure we have the correct user data with coreAdmins taking precedence
    const coreData = coreAdmins[u] || {};
    const dbData = userDatabase[u] || {};
    const userData = { ...{ rank: 'M', fullRank: 'Member', style: 'member-style' }, ...dbData, ...coreData };
    userDatabase[u] = userData;
    
    document.getElementById('ie_login').style.display = 'none';
    document.getElementById('ie_upload').style.display = 'block';
    document.getElementById('logged_in_as').innerText = `IDENTIFIED: ${u} [${userData.fullRank || 'Member'}]`;
    
    loadProfile();
    loadDisplayName(); // Load VIP display name
    startForceLogoutListener(); // Listen for admin kicks
    
    // Auto-setup chat and online status
    setUserOnline();
    loadMessages();
    startOnlineListener();
    document.getElementById('chat_input').disabled = false;
    document.getElementById('chat_input').placeholder = "/help for commands... @username to mention";
    
    // Scroll chat to bottom after messages load
    setTimeout(scrollChatToBottom, 1500);
    setTimeout(scrollChatToBottom, 3000);
    
    // Load game stats
    loadMyGameStats();
    loadGameMiniLeaderboard();
    
    // Show leaderboard icon for all members
    document.getElementById('leaderboard_icon').style.display = 'block';
    
    if (userData.isAdmin || userData.isMod) { 
        document.getElementById('admin_icon').style.display = 'block'; 
    }
    if (userData.isAdmin || userData.isST) {
        document.getElementById('admin_tab_sitetools_btn').style.display = 'block';
    }
    if (userData.isST) { 
        document.getElementById('st_tab').style.display = 'block'; 
    }
    if (userData.isST || userData.isAdmin) {
        document.getElementById('st_tab2').style.display = 'block'; 
    }
    setupAdminTabs(userData);
    document.getElementById('clubs_icon').style.display = 'block';
    document.getElementById('messages_icon').style.display = 'block';
    document.getElementById('watchparty_icon').style.display = 'block';
    
    // Start admin message listener for admins/mods
    if (userData.isAdmin || userData.isMod) {
        setTimeout(startAdminMessageListener, 2500);
    }
    
    // Auto-refresh clubs every 30 minutes
    startClubAutoRefresh();
    
    const rank = userData.rank || 'M';
    if (rank === 'VIP' || rank === 'CONTRIB' || userData.isAdmin || userData.isST) { 
        document.getElementById('vip_image_section').style.display = 'block';
        document.getElementById('vip_bg_section').style.display = 'block';
        document.getElementById('vip_upgrade_section').style.display = 'none';
    } else {
        document.getElementById('vip_upgrade_section').style.display = 'block';
    }
    
    // ST users bypass maintenance mode - hide overlay immediately
    if (userData.isST) {
        const overlay = document.getElementById('maintenance_overlay');
        if (overlay) overlay.style.display = 'none';
        document.body.style.overflow = '';
    }
    
    // Setup maintenance mode listener (will keep checking for changes)
    setupMaintenanceListener();
}

// Admin panel access - just check permissions
function openAdminPanelSecure() {
    if (!CURRENT_USER || IS_GUEST) {
        alert('You must be logged in to access the admin panel.');
        return;
    }
    
    // Check local userDatabase for admin rights
    const user = userDatabase[CURRENT_USER];
    if (!user) {
        alert('User not found.');
        return;
    }
    
    const isAdmin = user.isAdmin === true;
    const isMod = user.isMod === true;
    const isST = user.isST === true;
    
    if (!isAdmin && !isMod && !isST) {
        alert('Access denied. No admin privileges.');
        return;
    }
    
    // Open admin panel
    toggleWin('admin_window');
}

function logout() {
    if (CURRENT_USER) {
        db.ref('online/' + CURRENT_USER).remove().catch(() => {});
        db.ref('sessions/' + CURRENT_USER).remove().catch(() => {});
    }
    
    // Sign out of Firebase Auth
    auth.signOut().catch(err => console.warn('Auth signout error:', err));
    FIREBASE_USER = null;
    
    currentSessionToken = null;
    CURRENT_USER = "";
    IS_GUEST = true;
    
    userProfile = { status: "", bio: "", mood: "", avatar: "", music: "" };
    document.getElementById('ie_login').style.display = 'block';
    document.getElementById('ie_upload').style.display = 'none';
    document.getElementById('ie_user').value = '';
    document.getElementById('ie_pass').value = '';
    document.getElementById('admin_icon').style.display = 'none';
    document.getElementById('clubs_icon').style.display = 'none';
    document.getElementById('messages_icon').style.display = 'none';
    document.getElementById('watchparty_icon').style.display = 'none';
    document.getElementById('leaderboard_icon').style.display = 'none';
    document.getElementById('st_tab').style.display = 'none';
    document.getElementById('vip_image_section').style.display = 'none';
    document.getElementById('admin_window').style.display = 'none';
    toggleWin('chat_win');
}

// VIP Code Redemption System - for upgrading existing member accounts
function redeemVIPCode() {
    const codeInput = document.getElementById('vip_code_input');
    const resultDiv = document.getElementById('vip_code_result');
    const code = codeInput.value.trim().toUpperCase();
    
    if (!CURRENT_USER || IS_GUEST) {
        resultDiv.innerHTML = '<span style="color:#f00;">You must be logged in to redeem a code.</span>';
        return;
    }
    
    if (!code) {
        resultDiv.innerHTML = '<span style="color:#f00;">Please enter a code.</span>';
        return;
    }
    
    // Check if user is already VIP
    const currentUser = userDatabase[CURRENT_USER];
    if (currentUser && (currentUser.rank === 'VIP' || currentUser.isAdmin || currentUser.isST)) {
        resultDiv.innerHTML = '<span style="color:#ffd700;">You already have VIP or higher rank!</span>';
        return;
    }
    
    // Check if code exists in Firebase
    db.ref('vip_codes').orderByChild('code').equalTo(code).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultDiv.innerHTML = '<span style="color:#f00;">Invalid code.</span>';
            return;
        }
        
        let codeKey = null;
        let codeData = null;
        snapshot.forEach((child) => {
            codeKey = child.key;
            codeData = child.val();
        });
        
        if (!codeData) {
            resultDiv.innerHTML = '<span style="color:#f00;">Invalid code.</span>';
            return;
        }
        
        // Check if code has uses left
        const usedCount = codeData.usedBy ? Object.keys(codeData.usedBy).length : 0;
        const maxUses = codeData.maxUses || 1;
        
        if (usedCount >= maxUses) {
            resultDiv.innerHTML = '<span style="color:#f00;">This code has been fully redeemed.</span>';
            return;
        }
        
        // Check if user already used this code
        if (codeData.usedBy) {
            const usedByList = Object.values(codeData.usedBy);
            if (usedByList.includes(CURRENT_USER)) {
                resultDiv.innerHTML = '<span style="color:#f00;">You have already used this code.</span>';
                return;
            }
        }
        
        // Upgrade user to VIP
        upgradeToVIP(code, codeKey, resultDiv);
    });
}

function upgradeToVIP(code, codeKey, resultDiv) {
    // Update user in Firebase - VIP without ##SB tag (that's club-exclusive)
    const vipData = {
        rank: 'VIP',
        fullRank: 'VIP',
        style: 'vip-style',
        upgradedAt: Date.now(),
        upgradedBy: 'VIP_CODE:' + code
    };
    
    db.ref('members/' + CURRENT_USER).update(vipData).then(() => {
        // Mark code as used by this user
        db.ref('vip_codes/' + codeKey + '/usedBy').push(CURRENT_USER);
        
        // Update local database
        if (userDatabase[CURRENT_USER]) {
            userDatabase[CURRENT_USER].rank = 'VIP';
            userDatabase[CURRENT_USER].fullRank = 'VIP';
            userDatabase[CURRENT_USER].style = 'vip-style';
            // Remove any custom tag - VIP tag will show as gold "VIP"
            delete userDatabase[CURRENT_USER].customTag;
            delete userDatabase[CURRENT_USER].customTagColor;
        }
        
        // Show VIP image section
        document.getElementById('vip_image_section').style.display = 'block';
        
        // Hide upgrade section since they're now VIP
        document.getElementById('vip_upgrade_section').style.display = 'none';
        
        resultDiv.innerHTML = `
            <div style="color:#0f0; padding:10px; background:#0a1a0a; border:1px solid #0a0; border-radius:4px;">
                ‚úÖ Account Upgraded to VIP!<br>
                <span style="color:#ffd700;">You now have VIP status!</span><br>
                <span style="color:#888; font-size:9px;">Refresh the page to see all VIP features.</span>
            </div>
        `;
        
        document.getElementById('vip_code_input').value = '';
    }).catch(err => {
        resultDiv.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function openChat() { 
    if(CURRENT_USER && !IS_GUEST) { 
        toggleWin('chat_win'); 
        loadMessages(); 
        setUserOnline();
        startOnlineListener();
        document.getElementById('chat_input').disabled = false; 
        document.getElementById('chat_input').placeholder = "/help for commands... @username to mention"; 
    } else {
        alert('Please log in first!');
    }
}
function setUserOnline() {
    if (!CURRENT_USER || IS_GUEST) return;
    const user = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style', fullRank: 'Member' };
    db.ref('online/' + CURRENT_USER).set({ 
        username: CURRENT_USER, 
        rank: user.rank || 'M', 
        style: user.style || 'member-style', 
        fullRank: user.fullRank || 'Member', 
        lastSeen: firebase.database.ServerValue.TIMESTAMP 
    });
    db.ref('online/' + CURRENT_USER).onDisconnect().remove();
}

function updateMemberList() {
    const container = document.getElementById('online_member_list');
    if (!container) return;
    
    let html = '';
    
    // ONLINE SECTION
    html += `<div style="color:#0f0; font-size:11px; text-align:center; padding:8px; background:#001100; border:1px solid #030; margin-bottom:10px;">‚óè ${onlineUsers.length} ONLINE</div>`;
    
    if (onlineUsers.length > 0) {
        onlineUsers.filter(u => !deletedAccounts.includes(u.username)).forEach(u => {
            const mlTag = getUserMemberlistTag(u.username);
            let rankTag;
            if (mlTag) {
                rankTag = `<span class="rank-tag" style="color:${mlTag.color}; border-color:${mlTag.color}; background:${mlTag.color}22;">${mlTag.tag}</span>`;
            } else {
                rankTag = getRankTag(u.rank, u.style, u.username, false);
            }
            html += `<div class="member-item" onclick="showProfileCard('${escapeHtml(u.username)}', event)">
                ${rankTag}
                <span style="color:#0f0; font-size:8px;">‚óè</span>
                <span class="${u.style || 'member-style'}">${escapeHtml(u.username)}</span>
            </div>`;
        });
    } else {
        html += '<div style="color:#555; font-size:10px; text-align:center; padding:10px;">No one online</div>';
    }
    
    // ALL MEMBERS SECTION
    html += '<div style="border-top:1px solid #400; margin-top:15px; padding-top:10px;">';
    html += '<div style="color:#d40000; font-size:10px; font-weight:bold; text-align:center; margin-bottom:10px;">ALL MEMBERS</div>';
    
    const allMembers = { 'ST': [], 'A': [], 'MOD': [], 'CONTRIB': [], 'VIP': [], 'M': [] };
    const rankNames = { 'ST': 'Site Technician', 'A': 'Admins', 'MOD': 'Moderators', 'CONTRIB': 'Contributors', 'VIP': 'VIP', 'M': 'Members' };
    
    Object.keys(userDatabase).filter(username => !deletedAccounts.includes(username)).forEach(username => {
        const user = userDatabase[username];
        const rank = user.rank || 'M';
        if (allMembers[rank]) {
            allMembers[rank].push({ username, ...user });
        } else {
            allMembers['M'].push({ username, ...user });
        }
    });
    
    Object.keys(allMembers).forEach(rank => {
        if (allMembers[rank].length > 0) {
            html += `<div class="member-category">${rankNames[rank]}</div>`;
            allMembers[rank].forEach(u => {
                const isOnline = onlineUsers.some(ou => ou.username === u.username);
                const mlTag = getUserMemberlistTag(u.username);
                let rankTag;
                if (mlTag) {
                    rankTag = `<span class="rank-tag" style="color:${mlTag.color}; border-color:${mlTag.color}; background:${mlTag.color}22;">${mlTag.tag}</span>`;
                } else {
                    rankTag = getRankTag(u.rank, u.style, u.username, false);
                }
                html += `<div class="member-item" onclick="showProfileCard('${escapeHtml(u.username)}', event)">
                    ${rankTag}
                    ${isOnline ? '<span style="color:#0f0; font-size:8px;">‚óè</span>' : '<span style="color:#555; font-size:8px;">‚óã</span>'}
                    <span class="${u.style || 'member-style'}">${escapeHtml(u.username)}</span>
                </div>`;
            });
        }
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// PROFILE SYSTEM - Robust save/load for all users
function loadProfile() {
    if (!CURRENT_USER) return;
    console.log('Loading profile for:', CURRENT_USER);
    
    db.ref('profiles/' + CURRENT_USER).once('value', (snapshot) => {
        const p = snapshot.val() || {};
        console.log('Loaded profile data:', p);
        
        // Update local profile object
        userProfile = { 
            status: p.status || "", 
            bio: p.bio || "", 
            mood: p.mood || "", 
            avatar: p.avatar || "", 
            music: p.music || "",
            background: p.background || ""
        };
        
        // Update form fields if they exist
        const statusEl = document.getElementById('user_status');
        const bioEl = document.getElementById('user_bio');
        const moodEl = document.getElementById('user_mood');
        const avatarUrlEl = document.getElementById('avatar_url');
        const musicEl = document.getElementById('profile_music');
        const bgEl = document.getElementById('profile_bg');
        const avatarDisplay = document.getElementById('my_avatar_display');
        
        if (statusEl) statusEl.value = userProfile.status;
        if (bioEl) bioEl.value = userProfile.bio;
        if (moodEl) moodEl.value = userProfile.mood;
        if (avatarUrlEl) avatarUrlEl.value = userProfile.avatar;
        if (musicEl) musicEl.value = userProfile.music;
        if (bgEl) bgEl.value = userProfile.background;
        if (musicEl) musicEl.value = userProfile.music;
        
        if (avatarDisplay) {
            if (userProfile.avatar) {
                avatarDisplay.innerHTML = '<img src="' + userProfile.avatar + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ü¶á\'">';
            } else {
                avatarDisplay.innerHTML = 'ü¶á';
            }
        }
        
        // Also update the profile cache
        profileCache[CURRENT_USER] = userProfile;
        
    }).catch(err => { console.error('Failed to load profile:', err); });
}

function saveProfile() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    
    // Get all values from form fields
    const statusEl = document.getElementById('user_status');
    const bioEl = document.getElementById('user_bio');
    const moodEl = document.getElementById('user_mood');
    const musicEl = document.getElementById('profile_music');
    const avatarUrlEl = document.getElementById('avatar_url');
    const bgEl = document.getElementById('profile_bg');
    
    // Sanitize all inputs
    const newStatus = sanitizeProfileField(statusEl ? statusEl.value.trim() : userProfile.status || '', 100);
    const newBio = sanitizeProfileField(bioEl ? bioEl.value.trim() : userProfile.bio || '', 500);
    const newMood = sanitizeInput(moodEl ? moodEl.value : userProfile.mood || '');
    const newMusic = sanitizeUrl(musicEl ? musicEl.value.trim() : userProfile.music || '');
    const newAvatar = sanitizeUrl(avatarUrlEl ? avatarUrlEl.value.trim() : userProfile.avatar || '');
    const newBg = sanitizeUrl(bgEl ? bgEl.value.trim() : userProfile.background || '');
    
    // Update local profile object
    userProfile.status = newStatus;
    userProfile.bio = newBio;
    userProfile.mood = newMood;
    userProfile.music = newMusic;
    userProfile.avatar = newAvatar;
    userProfile.background = newBg;
    
    // Create profile data object (only fields we want to update - preserves badges)
    const profileData = { 
        status: newStatus, 
        bio: newBio, 
        mood: newMood, 
        music: newMusic, 
        avatar: newAvatar,
        background: newBg,
        lastUpdated: Date.now()
    };
    
    console.log('Saving profile for', CURRENT_USER, ':', profileData);
    
    // Use update() instead of set() to preserve badges and other data
    db.ref('profiles/' + CURRENT_USER).update(profileData, (error) => {
        if (error) {
            console.error('Save failed:', error);
            alert('Failed to save profile: ' + error.message);
        } else {
            console.log('Profile saved successfully');
            profileCache[CURRENT_USER] = { ...profileCache[CURRENT_USER], ...userProfile };
            alert('Profile saved!');
        }
    });
}

function updateAvatar() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    
    const urlEl = document.getElementById('avatar_url');
    const fileInput = document.getElementById('avatar_upload');
    const avatarDisplay = document.getElementById('my_avatar_display');
    const url = urlEl ? urlEl.value.trim() : '';
    
    if (url) {
        // URL provided - save directly
        saveAvatarToFirebase(url, avatarDisplay, urlEl);
    } else if (fileInput && fileInput.files[0]) {
        // Convert to base64 data URI
        alert('Uploading avatar...');
        fileToBase64(fileInput.files[0], 400).then(dataUri => {
            saveAvatarToFirebase(dataUri, avatarDisplay, urlEl);
        }).catch(err => {
            console.error('Upload error:', err);
            alert('Failed to process image.');
        });
    } else {
        alert('Enter a URL or select a file to upload.');
    }
}

function saveAvatarToFirebase(avatarUrl, avatarDisplay, urlEl) {
    userProfile.avatar = avatarUrl;
    
    // Use update() to only change avatar, preserving badges
    db.ref('profiles/' + CURRENT_USER).update({
        avatar: avatarUrl,
        lastUpdated: Date.now()
    }, (error) => {
        if (error) {
            console.error('Avatar save failed:', error);
            alert('Failed to save avatar: ' + error.message);
        } else {
            console.log('Avatar saved:', avatarUrl);
            userProfile.avatar = avatarUrl;
            if (profileCache[CURRENT_USER]) profileCache[CURRENT_USER].avatar = avatarUrl;
            if (avatarDisplay) avatarDisplay.innerHTML = '<img src="' + avatarUrl + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ü¶á\'">';
            if (urlEl) urlEl.value = avatarUrl;
            alert('Avatar saved!');
        }
    });
}

function updateProfileMusic() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    
    const musicEl = document.getElementById('profile_music');
    const url = musicEl ? musicEl.value.trim() : '';
    
    userProfile.music = url;
    
    // Use update() to only change music, preserving badges
    db.ref('profiles/' + CURRENT_USER).update({
        music: url,
        lastUpdated: Date.now()
    }, (error) => {
        if (error) {
            console.error('Music save failed:', error);
            alert('Failed to save music: ' + error.message);
        } else {
            console.log('Profile music saved:', url);
            if (profileCache[CURRENT_USER]) profileCache[CURRENT_USER].music = url;
            alert('Profile music saved!');
        }
    });
}

// PROFILE WINDOW
function showProfileCard(username, event) {
    if (event) { event.preventDefault(); event.stopPropagation(); }
    if (!username) return;
    openProfileWindow(username);
}
function openProfileWindow(username) {
    if (!username) return;
    currentProfileUser = username;
    const win = document.getElementById('profile_window');
    if (!win) { console.error('Profile window not found'); return; }
    
    const userData = userDatabase[username] || { rank: 'M', fullRank: 'Member', style: 'member-style' };
    
    const pwTitle = document.getElementById('pw_title');
    const pwName = document.getElementById('pw_name');
    const pwRank = document.getElementById('pw_rank');
    const pwUserId = document.getElementById('pw_user_id');
    const pwStatus = document.getElementById('pw_status');
    const pwMood = document.getElementById('pw_mood');
    const pwBio = document.getElementById('pw_bio');
    const pwAvatar = document.getElementById('pw_avatar');
    const pwRep = document.getElementById('pw_rep');
    const pwCommentsCount = document.getElementById('pw_comments_count');
    const pwCommentsList = document.getElementById('pw_comments_list');
    const pwMusicSection = document.getElementById('pw_music_section');
    const pwMusicPlayer = document.getElementById('pw_music_player');
    const pwBtnRepPos = document.getElementById('pw_btn_rep_pos');
    const pwBtnRepNeg = document.getElementById('pw_btn_rep_neg');
    const pwCommentForm = document.getElementById('pw_comment_form');
    
    if (pwTitle) pwTitle.textContent = 'üë§ ' + username + "'s Profile";
    if (pwName) { 
        pwName.textContent = username; 
        pwName.className = userData.style || 'member-style'; 
        pwName.style.background = 'transparent'; 
        pwName.style.backgroundColor = 'transparent';
        pwName.style.border = 'none';
        pwName.style.padding = '0';
    }
    if (pwRank) pwRank.textContent = userData.fullRank || 'Member';
    if (pwUserId) pwUserId.textContent = 'User ID: ' + generateUserId(username);
    
    // Load FRESH profile data from Firebase
    db.ref('profiles/' + username).once('value', (snapshot) => {
        const profile = snapshot.val() || {};
        console.log('openProfileWindow - Loaded profile for', username, ':', profile);
        
        if (pwStatus) pwStatus.textContent = profile.status || '';
        if (pwMood) pwMood.textContent = profile.mood || '';
        if (pwBio) pwBio.textContent = profile.bio || 'No bio set.';
        if (pwAvatar) {
            // Reset border to default
            pwAvatar.style.border = '4px solid #700';
            if (profile.avatar) pwAvatar.innerHTML = '<img src="' + escapeHtml(profile.avatar) + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ü¶á\'">';
            else pwAvatar.innerHTML = 'ü¶á';
        }
        
        // Load equipped shop items (effects only)
        const pwEffect = document.getElementById('pw_avatar_effect');
        const pwWrapper = document.getElementById('pw_avatar_wrapper');
        if (pwEffect) pwEffect.innerHTML = '';
        if (pwWrapper) pwWrapper.className = '';
        
        if (profile.shopItems) {
            const equippedItems = Object.entries(profile.shopItems).filter(([id, data]) => data.equipped);
            for (const [itemId, data] of equippedItems) {
                db.ref('shop_items/' + itemId).once('value', (itemSnap) => {
                    const item = itemSnap.val();
                    if (!item) return;
                    
                    if (item.type === 'effect' && pwWrapper && pwEffect) {
                        const eName = item.effectClass || item.name.toLowerCase().replace(/\s+/g, '-');
                        applyAvatarEffect(pwWrapper, pwEffect, eName);
                    }
                });
            }
        }
        
        // Animated background for VIP users - lighter overlay for visibility
        const winBody = win.querySelector('.window-body');
        const bgOverlay = document.getElementById('pw_bg_overlay');
        if (winBody && profile.background) {
            let bgUrl = profile.background;
            // Handle Tenor links - extract direct GIF URL
            if (bgUrl.includes('tenor.com')) {
                // For tenor, add .gif if not present, or use media URL
                if (bgUrl.includes('/view/')) {
                    bgUrl = bgUrl.replace('/view/', '/').replace(/\?.*$/, '') + '.gif';
                }
            }
            winBody.style.backgroundImage = 'url(' + escapeHtml(bgUrl) + ')';
            winBody.style.backgroundSize = 'cover';
            winBody.style.backgroundPosition = 'center';
            winBody.style.backgroundRepeat = 'no-repeat';
            // Show lighter overlay so background is more visible
            if (bgOverlay) {
                bgOverlay.style.display = 'block';
                bgOverlay.style.background = 'rgba(0,0,0,0.5)'; // Lighter than before
            }
        } else if (winBody) {
            winBody.style.backgroundImage = 'none';
            if (bgOverlay) bgOverlay.style.display = 'none';
        }
        
        // Load badges
        const pwBadgesSection = document.getElementById('pw_badges_section');
        const pwBadgesList = document.getElementById('pw_badges_list');
        if (profile.badges && pwBadgesSection && pwBadgesList) {
            const badgeKeys = Object.keys(profile.badges);
            if (badgeKeys.length > 0) {
                pwBadgesSection.style.display = 'block';
                pwBadgesList.innerHTML = badgeKeys.map(badgeId => {
                    const badge = badgeDefinitions[badgeId];
                    const userBadgeData = profile.badges[badgeId];
                    if (!badge) return '';
                    const hasSubmission = userBadgeData && userBadgeData.submission;
                    const submissionUrl = hasSubmission ? escapeHtml(userBadgeData.submission) : '';
                    const clickHandler = hasSubmission ? `onclick="openBadgeSubmission('${submissionUrl}')"` : '';
                    const submissionIndicator = hasSubmission ? '<div style="position:absolute; bottom:-2px; right:-2px; background:#0f0; width:8px; height:8px; border-radius:50%; border:1px solid #050;"></div>' : '';
                    return `<div class="profile-badge" style="text-align:center; cursor:pointer; position:relative;" ${clickHandler} onmouseenter="showBadgeTooltip(this, '${escapeHtml(badge.name)}', '${escapeHtml(badge.description)}${hasSubmission ? ' (click to view submission)' : ''}')" onmouseleave="hideBadgeTooltip()">
                        <img src="${escapeHtml(badge.image)}" style="width:45px; height:45px; border-radius:4px; border:2px solid ${hasSubmission ? '#0f0' : '#500'}; background:#111;" onerror="this.style.display='none'">
                        ${submissionIndicator}
                    </div>`;
                }).join('');
            } else {
                pwBadgesSection.style.display = 'none';
            }
        } else if (pwBadgesSection) {
            pwBadgesSection.style.display = 'none';
        }
        
        // Music player - AUTOPLAY when profile opens
        if (pwMusicSection && pwMusicPlayer) {
            if (profile.music) {
                pwMusicSection.style.display = 'block';
                if (profile.music.includes('soundcloud.com')) pwMusicPlayer.innerHTML = '<iframe width="100%" height="100" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=' + encodeURIComponent(profile.music) + '&color=%23ff0000&auto_play=true&hide_related=true"></iframe>';
                else if (profile.music.includes('spotify.com')) { const m = profile.music.match(/track\/([a-zA-Z0-9]+)/); if (m) pwMusicPlayer.innerHTML = '<iframe src="https://open.spotify.com/embed/track/' + m[1] + '?autoplay=1" width="100%" height="80" frameborder="0" allow="autoplay; encrypted-media"></iframe>'; else pwMusicPlayer.innerHTML = ''; }
                else pwMusicPlayer.innerHTML = '';
            } else { pwMusicSection.style.display = 'none'; pwMusicPlayer.innerHTML = ''; }
        }
    }).catch(err => console.error('Profile load error:', err));
    
    // Load reputation
    db.ref('reputation/' + username).once('value', (s) => { 
        if (pwRep) pwRep.textContent = (s.val()?.score || 0); 
    }).catch(err => console.error('Rep load error:', err));
    
    // Load comments
    db.ref('profile_comments/' + username).orderByChild('timestamp').limitToLast(20).once('value', (s) => {
        const comments = []; s.forEach(c => { if (c.val()) comments.push(c.val()); });
        if (pwCommentsCount) pwCommentsCount.textContent = comments.length;
        if (pwCommentsList) {
            if (comments.length === 0) pwCommentsList.innerHTML = '<div style="color:#555; font-size:11px; text-align:center; padding:10px;">No comments yet.</div>';
            else pwCommentsList.innerHTML = comments.reverse().map(c => `<div style="background:#0a0000; padding:10px; margin-bottom:8px; border-left:3px solid #500; border-radius:0 4px 4px 0;"><div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:#d40000; font-weight:bold; font-size:11px;">${escapeHtml(c.from || 'Unknown')}</span><span style="color:#444; font-size:9px;">${c.date || ''}</span></div><div style="color:#aaa; font-size:11px; line-height:1.4;">${escapeHtml(c.text || '')}</div></div>`).join('');
        }
    }).catch(err => console.error('Comments load error:', err));
    
    // Rep buttons visibility
    const canRep = CURRENT_USER && !IS_GUEST && username !== CURRENT_USER;
    if (pwBtnRepPos) pwBtnRepPos.style.display = canRep ? 'block' : 'none';
    if (pwBtnRepNeg) pwBtnRepNeg.style.display = canRep ? 'block' : 'none';
    if (pwCommentForm) pwCommentForm.style.display = (CURRENT_USER && !IS_GUEST) ? 'block' : 'none';
    
    // Load clubs for this user
    const pwClubsSection = document.getElementById('pw_clubs_section');
    const pwClubsList = document.getElementById('pw_clubs_list');
    if (pwClubsSection && pwClubsList) {
        getUserClubs(username).then(clubs => {
            if (clubs.length > 0) {
                pwClubsSection.style.display = 'block';
                pwClubsList.innerHTML = clubs.map(c => 
                    `<span class="club-badge" style="border-color:${c.color || '#500'}; color:${c.color || '#f88'};">${escapeHtml(c.name)}${c.owner === username ? ' üëë' : ''}</span>`
                ).join('');
            } else {
                pwClubsSection.style.display = 'none';
            }
        });
    }
    
    win.style.display = 'block';
    document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10");
    win.style.zIndex = "500";
    makeDraggable('profile_window');
}

// Badge tooltip functions
function showBadgeTooltip(element, name, description) {
    const tooltip = document.getElementById('badge_tooltip');
    const nameEl = document.getElementById('badge_tooltip_name');
    const descEl = document.getElementById('badge_tooltip_desc');
    
    if (!tooltip || !nameEl || !descEl) return;
    
    nameEl.textContent = name;
    descEl.textContent = description;
    
    // Position tooltip near the badge
    const rect = element.getBoundingClientRect();
    tooltip.style.left = (rect.left + rect.width / 2 - 100) + 'px';
    tooltip.style.top = (rect.bottom + 10) + 'px';
    tooltip.style.display = 'block';
}

function hideBadgeTooltip() {
    const tooltip = document.getElementById('badge_tooltip');
    if (tooltip) tooltip.style.display = 'none';
}

function openBadgeSubmission(url) {
    if (!url) return;
    
    // Create overlay to display the submission
    const overlay = document.createElement('div');
    overlay.id = 'badge_submission_overlay';
    overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; display:flex; justify-content:center; align-items:center; cursor:pointer;';
    overlay.onclick = () => overlay.remove();
    
    const container = document.createElement('div');
    container.style.cssText = 'max-width:90%; max-height:90%; position:relative;';
    container.onclick = (e) => e.stopPropagation();
    
    const img = document.createElement('img');
    img.src = url;
    img.style.cssText = 'max-width:100%; max-height:85vh; border:3px solid #d40000; border-radius:8px; box-shadow:0 0 30px rgba(212,0,0,0.5);';
    img.onerror = () => {
        container.innerHTML = '<div style="color:#f00; text-align:center; padding:20px;">Failed to load submission image</div>';
    };
    
    const caption = document.createElement('div');
    caption.style.cssText = 'text-align:center; margin-top:15px; color:#888; font-size:12px;';
    caption.innerHTML = 'üèÖ Badge Submission <span style="color:#666; font-size:10px;">(click anywhere to close)</span>';
    
    const openBtn = document.createElement('button');
    openBtn.textContent = 'üîó Open in New Tab';
    openBtn.style.cssText = 'display:block; margin:10px auto 0; background:#1a0a0a; border:1px solid #500; color:#d40000; padding:8px 15px; border-radius:4px; cursor:pointer; font-size:11px;';
    openBtn.onclick = (e) => { e.stopPropagation(); window.open(url, '_blank'); };
    
    container.appendChild(img);
    container.appendChild(caption);
    container.appendChild(openBtn);
    overlay.appendChild(container);
    document.body.appendChild(overlay);
}

function closeProfileWindow() { 
    const win = document.getElementById('profile_window');
    const musicPlayer = document.getElementById('pw_music_player');
    if (win) win.style.display = 'none'; 
    if (musicPlayer) musicPlayer.innerHTML = ''; 
    profileMusicMuted = false;
    hideBadgeTooltip();
}

let profileMusicMuted = false;
function toggleProfileMusic() {
    const player = document.getElementById('pw_music_player');
    const btn = document.getElementById('pw_mute_btn');
    if (!player) return;
    
    profileMusicMuted = !profileMusicMuted;
    
    if (profileMusicMuted) {
        // Store current content and clear
        player.dataset.content = player.innerHTML;
        player.innerHTML = '<div style="color:#666; font-size:11px; text-align:center; padding:10px;">üîá Music muted</div>';
        if (btn) btn.textContent = 'üîä Unmute';
    } else {
        // Restore content
        if (player.dataset.content) {
            player.innerHTML = player.dataset.content;
        }
        if (btn) btn.textContent = 'üîá Mute';
    }
}

function giveRep(amount) {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    if (!currentProfileUser || currentProfileUser === CURRENT_USER) return;
    db.ref('reputation/' + currentProfileUser).once('value', (s) => {
        const current = s.val() || { score: 0, givers: {} };
        if (current.givers && current.givers[CURRENT_USER]) { alert('Already gave rep to this user!'); return; }
        current.score = (current.score || 0) + amount;
        current.givers = current.givers || {};
        current.givers[CURRENT_USER] = amount;
        db.ref('reputation/' + currentProfileUser).set(current)
            .then(() => {
                const pwRep = document.getElementById('pw_rep');
                if (pwRep) pwRep.textContent = current.score;
                alert(amount > 0 ? '+1 Rep given!' : '-1 Rep given!');
            })
            .catch(err => { console.error('Rep error:', err); alert('Failed to give rep.'); });
    }).catch(err => { console.error('Rep load error:', err); alert('Failed to load rep.'); });
}
function leaveProfileComment() {
    if (!CURRENT_USER || IS_GUEST) { alert('Must be logged in!'); return; }
    if (!currentProfileUser) return;
    const inputEl = document.getElementById('pw_comment_input');
    const text = sanitizeProfileField(inputEl ? inputEl.value.trim() : '', 300);
    if (!text) { alert('Please enter a comment.'); return; }
    db.ref('profile_comments/' + currentProfileUser).push({ 
        from: CURRENT_USER, 
        text: text, 
        date: new Date().toLocaleDateString(), 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    }).then(() => {
        if (inputEl) inputEl.value = '';
        openProfileWindow(currentProfileUser);
    }).catch(err => { console.error('Comment error:', err); alert('Failed to post comment.'); });
}
function openDM(username) {
    if (!username || username === CURRENT_USER || IS_GUEST) return;
    closeProfileWindow();
    alert('DM feature coming soon! Mention @' + username + ' in chat.');
}

// CHAT SYSTEM
function switchChatTab(tab, el) {
    document.querySelectorAll('#chat_win .tab').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    const chatMain = document.getElementById('chat_main');
    const chatAvatar = document.getElementById('chat_avatar');
    if (chatMain) chatMain.style.display = tab === 'main' ? 'block' : 'none';
    if (chatAvatar) chatAvatar.style.display = tab === 'avatar' ? 'block' : 'none';
    if (tab === 'avatar') loadAvatarTab();
}
function loadAvatarTab() {
    if (!CURRENT_USER) return;
    const user = userDatabase[CURRENT_USER] || { fullRank: 'Member' };
    const usernameDisplay = document.getElementById('my_username_display');
    const rankDisplay = document.getElementById('my_rank_display');
    const avatarDisplay = document.getElementById('my_avatar_display');
    const avatarUrlEl = document.getElementById('avatar_url');
    const musicEl = document.getElementById('profile_music');
    const statusEl = document.getElementById('user_status');
    const bioEl = document.getElementById('user_bio');
    const moodEl = document.getElementById('user_mood');
    
    if (usernameDisplay) usernameDisplay.textContent = CURRENT_USER;
    if (rankDisplay) rankDisplay.textContent = user.fullRank || 'Member';
    
    // Load FRESH profile data from Firebase (not cache)
    db.ref('profiles/' + CURRENT_USER).once('value', (snapshot) => {
        const profile = snapshot.val() || {};
        console.log('loadAvatarTab - Loaded profile:', profile);
        
        // Update local userProfile
        userProfile = {
            status: profile.status || '',
            bio: profile.bio || '',
            mood: profile.mood || '',
            avatar: profile.avatar || '',
            music: profile.music || ''
        };
        
        // Update form fields
        if (avatarDisplay) {
            if (profile.avatar) avatarDisplay.innerHTML = '<img src="' + profile.avatar + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ü¶á\'">';
            else avatarDisplay.innerHTML = 'ü¶á';
        }
        if (avatarUrlEl) avatarUrlEl.value = profile.avatar || '';
        if (musicEl) musicEl.value = profile.music || '';
        if (statusEl) statusEl.value = profile.status || '';
        if (bioEl) bioEl.value = profile.bio || '';
        if (moodEl) moodEl.value = profile.mood || '';
        
    }).catch(err => console.error('Failed to load profile in avatar tab:', err));
}
function handleTyping() { if (IS_GUEST || !CURRENT_USER) return; db.ref('typing').set({ user: CURRENT_USER, time: Date.now() }); }
function checkTyping() {
    db.ref('typing').once('value', (s) => {
        const typing = s.val();
        const area = document.getElementById('typing_area');
        if (typing && typing.user && typing.user !== CURRENT_USER && (Date.now() - typing.time) < 2000) { document.getElementById('typing_user').textContent = typing.user; area.style.display = 'block'; }
        else area.style.display = 'none';
    });
}
setInterval(checkTyping, 500);
function handleChatKey(event) { if (event.key === 'Enter') sendChat(); }

const chatCommands = {
    '/help': () => ({ type: 'system', text: 'Commands: /me, /shrug, /tableflip, /blood, /bat, /bite' }),
    '/me': (args) => ({ type: 'action', text: CURRENT_USER + ' ' + args }),
    '/shrug': () => ({ type: 'action', text: CURRENT_USER + ' ¬Ø\\_(„ÉÑ)_/¬Ø' }),
    '/tableflip': () => ({ type: 'action', text: CURRENT_USER + ' (‚ïØ¬∞‚ñ°¬∞)‚ïØÔ∏µ ‚îª‚îÅ‚îª' }),
    '/blood': () => ({ type: 'action', text: CURRENT_USER + ' ü©∏ü©∏ü©∏' }),
    '/bat': () => ({ type: 'action', text: CURRENT_USER + ' ü¶á *flaps away*' }),
    '/bite': (args) => ({ type: 'action', text: CURRENT_USER + ' üßõ *bites ' + (args || 'the air') + '*' }),
};
const botResponses = [
    { trigger: /vampire|vamp/i, response: "Did someone say vampire? *fangs glisten*" },
    { trigger: /blood/i, response: "The crimson elixir... ü©∏" },
    { trigger: /sun|daylight/i, response: "We don't speak of the burning orb. ‚òÄÔ∏èüö´" },
    { trigger: /garlic/i, response: "*hisses* Forbidden! üßÑ‚ùå" },
];

// Reply tracking
let currentReplyTo = null;

function setReply(username, text, msgId) {
    currentReplyTo = { username, text: text.substring(0, 50), msgId };
    document.getElementById('reply_indicator').style.display = 'block';
    document.getElementById('reply_to_user').textContent = username;
    document.getElementById('reply_to_text').textContent = text.length > 50 ? text.substring(0, 50) + '...' : text;
    document.getElementById('chat_input').focus();
}

function cancelReply() {
    currentReplyTo = null;
    document.getElementById('reply_indicator').style.display = 'none';
}

function mentionUser(username) {
    const input = document.getElementById('chat_input');
    input.value = '@' + username + ' ' + input.value;
    input.focus();
}

function sendChat() {
    console.log('=== SEND CHAT CALLED ===');
    console.log('CURRENT_USER:', CURRENT_USER);
    console.log('IS_GUEST:', IS_GUEST);
    console.log('db exists:', !!db);
    
    if (IS_GUEST) { 
        alert('Guests cannot send messages.'); 
        return; 
    }
    if (!CURRENT_USER) { 
        alert('Please log in!'); 
        return; 
    }
    
    const input = document.getElementById('chat_input');
    if (!input) { 
        console.error('ERROR: Chat input element not found!'); 
        alert('Chat input not found!');
        return; 
    }
    
    const rawText = input.value.trim();
    console.log('Message text:', rawText);
    
    if (!rawText) {
        console.log('Empty message, returning');
        return;
    }
    
    // Simple HTML escape
    const text = rawText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    const u = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style' };
    const userRank = u.rank || 'M';
    const userStyle = u.style || 'member-style';
    const timeNow = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Check for commands
    const cmdMatch = rawText.match(/^(\/\w+)\s*(.*)?$/);
    if (cmdMatch && chatCommands && chatCommands[cmdMatch[1]]) {
        console.log('Command detected:', cmdMatch[1]);
        const result = chatCommands[cmdMatch[1]](cmdMatch[2] || '');
        if (result.type === 'system') { 
            input.value = ''; 
            const logs = document.getElementById('chat_logs'); 
            if (logs) {
                logs.innerHTML += '<div style="color:#666; font-size:9px; font-style:italic; padding:4px;">' + result.text + '</div>'; 
                logs.scrollTop = logs.scrollHeight; 
            }
            return; 
        }
    }
    
    // Build message object
    const msgData = { 
        user: CURRENT_USER, 
        text: text, 
        tag: userRank, 
        style: userStyle, 
        time: timeNow, 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    };
    
    // Add display name if user has one (VIP feature)
    if (currentUserDisplayName) {
        msgData.displayName = currentUserDisplayName;
    }
    
    // Add reply data if replying
    if (currentReplyTo) {
        msgData.replyTo = currentReplyTo.username;
        msgData.replyText = currentReplyTo.text;
    }
    
    // Check for mentions
    const mentions = rawText.match(/@(\w+)/g);
    if (mentions) {
        msgData.mentions = mentions.map(m => m.substring(1));
    }
    
    console.log('Attempting to push message:', msgData);
    
    // Try to send
    db.ref('chat').push(msgData)
        .then(() => {
            console.log('SUCCESS: Message sent to Firebase!');
            input.value = '';
            cancelReply();
            
            // Track activity for leaderboard (anti-spam: only count if 5+ seconds since last tracked message)
            trackUserActivity();
        })
        .catch(err => {
            console.error('FIREBASE ERROR:', err);
            console.error('Error code:', err.code);
            console.error('Error message:', err.message);
            alert('Failed to send message!\n\nError: ' + err.message + '\n\nCheck browser console (F12) and Firebase Rules.');
        });
}

// Activity tracking for leaderboard (anti-spam protection)
let lastActivityTrack = 0;
function trackUserActivity() {
    if (!CURRENT_USER || IS_GUEST) return;
    
    const now = Date.now();
    // Only count toward activity if 5+ seconds since last tracked message (anti-spam)
    if (now - lastActivityTrack < 5000) return;
    lastActivityTrack = now;
    
    // Get today's date key
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    // Update user's daily activity
    db.ref('activity_stats/' + CURRENT_USER + '/' + today).transaction((current) => {
        return (current || 0) + 1;
    }).catch(err => console.log('Activity track error:', err));
    
    // Also update total message count
    db.ref('activity_stats/' + CURRENT_USER + '/total').transaction((current) => {
        return (current || 0) + 1;
    }).catch(err => console.log('Total activity track error:', err));
}

let chatListenerSet = false;
function setupChatListener() {
    if (chatListenerSet) return;
    chatListenerSet = true;
    
    const logs = document.getElementById('chat_logs');
    if (logs) logs.innerHTML = '<div style="color:#555; text-align:center; padding:40px;">Loading messages...</div>';
    
    db.ref('chat').orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
        const logs = document.getElementById('chat_logs');
        if (!logs) return;
        const msgs = []; snapshot.forEach(c => { if (c.val()) msgs.push({...c.val(), msgId: c.key}); });
        db.ref('pinned').once('value', (ps) => {
            const pinned = ps.val();
            const pc = document.getElementById('pinned_container');
            if (pc) pc.innerHTML = pinned ? '<div class="pinned-msg"><span style="color:#ffd700; font-size:8px;">üìå PINNED</span><br>' + escapeHtml(pinned) + '</div>' : '';
        });
        if (msgs.length === 0) { logs.innerHTML = '<div style="color:#555; text-align:center; padding:40px;">No messages yet.</div>'; return; }
        logs.innerHTML = msgs.map(m => {
            if (!m) return '';
            if (m.isAction) return '<div style="padding:6px 0; font-size:11px; color:#888; font-style:italic; border-bottom:1px solid #300;">* ' + escapeHtml(m.text || '') + '</div>';
            const msgUser = m.user || 'Unknown', msgText = m.text || '', msgTag = m.tag || 'M', msgStyle = m.style || 'member-style', msgTime = m.time || '';
            const botClass = m.isBot ? ' chat-bot' : '';
            let mediaHtml = '';
            if (m.imageData) mediaHtml = '<img src="' + m.imageData + '" style="max-width:200px; max-height:150px; border:1px solid #400; margin-top:6px; border-radius:4px;">';
            else if (m.mediaUrl) {
                if (m.mediaType === 'image') mediaHtml = '<img src="' + m.mediaUrl + '" style="max-width:250px; max-height:200px; border:1px solid #400; margin-top:6px; border-radius:4px; cursor:pointer;" onclick="window.open(\'' + m.mediaUrl + '\')">';
                else if (m.mediaType === 'video') mediaHtml = '<video src="' + m.mediaUrl + '" controls style="max-width:280px; max-height:200px; border:1px solid #400; margin-top:6px; border-radius:4px;"></video>';
                else if (m.mediaType === 'audio') mediaHtml = '<audio src="' + m.mediaUrl + '" controls style="width:250px; margin-top:6px;"></audio>';
            }
            
            // Check for club tag to match username color
            const clubTag = getUserClubTag(msgUser);
            const rankTag = getRankTag(msgTag, msgStyle, msgUser);
            const usernameStyle = clubTag ? `style="font-weight:bold; cursor:pointer; color:${clubTag.color};"` : `class="${msgStyle}" style="font-weight:bold; cursor:pointer;"`;
            
            // Display name for VIP users (from message data)
            let displayNameHtml = '';
            if (m.displayName) {
                displayNameHtml = `<span style="color:#ffd700; font-size:10px; font-style:italic; margin-left:5px;">"${escapeHtml(m.displayName)}"</span>`;
            }
            
            // Reply indicator
            let replyHtml = '';
            if (m.replyTo) {
                replyHtml = `<div style="background:#1a0808; border-left:2px solid #500; padding:4px 8px; margin-bottom:6px; font-size:10px; color:#888;">‚Ü©Ô∏è Replying to <span style="color:#d40000;">${escapeHtml(m.replyTo)}</span>: ${escapeHtml(m.replyText || '')}</div>`;
            }
            
            // Format text with mentions highlighted - ONLY for valid users
            let formattedText = escapeHtml(msgText);
            formattedText = formattedText.replace(/@(\w+)/g, (match, username) => {
                // Only make clickable if user exists in database
                if (userDatabase[username]) {
                    return '<span style="background:#2a1a2a; color:#ff6666; padding:1px 4px; border-radius:3px; cursor:pointer;" onclick="showProfileCard(\'' + username + '\', event)">@' + username + '</span>';
                }
                return match; // Return unchanged if user doesn't exist
            });
            
            // Check if current user is mentioned
            const isMentioned = m.mentions && m.mentions.includes(CURRENT_USER);
            const mentionClass = isMentioned ? ' background:#1a1a0a; border-left:3px solid #ffd700;' : '';
            
            // Action buttons (reply & mention) + 3-dot menu
            const msgIdSafe = m.msgId || '';
            const actionBtns = m.isBot ? '' : `<div class="chat-actions" style="display:none; position:absolute; right:8px; top:8px; gap:4px; align-items:center;">
                <button onclick="setReply('${escapeHtml(msgUser)}', '${escapeHtml(msgText.replace(/'/g, "\\'").replace(/\n/g, ' '))}', '${msgIdSafe}')" style="background:#222; border:1px solid #400; color:#888; padding:2px 6px; font-size:9px; cursor:pointer; border-radius:3px;">‚Ü©Ô∏è Reply</button>
                <button onclick="mentionUser('${escapeHtml(msgUser)}')" style="background:#222; border:1px solid #400; color:#888; padding:2px 6px; font-size:9px; cursor:pointer; border-radius:3px;">@ Mention</button>
                <div class="msg-dropdown" style="position:relative;">
                    <button onclick="toggleMsgMenu(this)" style="background:#222; border:1px solid #400; color:#666; padding:2px 8px; font-size:11px; cursor:pointer; border-radius:3px;">‚ãÆ</button>
                    <div class="msg-menu" style="display:none; position:absolute; right:0; top:100%; background:#1a0a0a; border:1px solid #400; border-radius:4px; min-width:120px; z-index:100; box-shadow:0 2px 8px rgba(0,0,0,0.5);">
                        <div onclick="copyMsgId('${msgIdSafe}')" style="padding:8px 12px; color:#888; font-size:10px; cursor:pointer; border-bottom:1px solid #300;" onmouseenter="this.style.background='#2a1a1a'" onmouseleave="this.style.background='transparent'">üìã Copy Message ID</div>
                        <div onclick="copyMsgText('${escapeHtml(msgText.replace(/'/g, "\\'").replace(/\n/g, ' '))}')" style="padding:8px 12px; color:#888; font-size:10px; cursor:pointer;" onmouseenter="this.style.background='#2a1a1a'" onmouseleave="this.style.background='transparent'">üìù Copy Text</div>
                    </div>
                </div>
            </div>`;
            
            return `<div class="chat-entry${botClass}" style="padding:10px 8px; border-bottom:1px solid #300; position:relative;${mentionClass}" onmouseenter="this.querySelector('.chat-actions')&&(this.querySelector('.chat-actions').style.display='flex')" onmouseleave="this.querySelector('.chat-actions')&&(this.querySelector('.chat-actions').style.display='none'); closeMsgMenus()">${actionBtns}<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">${rankTag}<span ${usernameStyle} onclick="showProfileCard('${escapeHtml(msgUser)}', event)">${escapeHtml(msgUser)}</span>${displayNameHtml}<span style="color:#444; font-size:9px; margin-left:auto;">${msgTime}</span></div>${replyHtml}<div style="color:#ddd; font-size:12px; padding-left:35px; line-height:1.5;">${formattedText}${mediaHtml}</div></div>`;
        }).join('');
        // Ensure scroll to bottom after render - multiple attempts for images
        setTimeout(() => { logs.scrollTop = logs.scrollHeight; }, 50);
        setTimeout(() => { logs.scrollTop = logs.scrollHeight; }, 200);
        setTimeout(() => { logs.scrollTop = logs.scrollHeight; }, 500);
    }, (error) => {
        // Error handler for chat listener
        console.error('Chat listener error:', error);
        const logs = document.getElementById('chat_logs');
        if (logs) logs.innerHTML = '<div style="color:#f00; text-align:center; padding:40px;">Error loading chat: ' + error.message + '<br><br><button onclick="chatListenerSet=false; setupChatListener();" style="padding:5px 15px; background:#500; border:1px solid #a00; color:#fff; cursor:pointer;">Retry</button></div>';
    });
}

function toggleMsgMenu(btn) {
    const menu = btn.nextElementSibling;
    const wasOpen = menu.style.display === 'block';
    closeMsgMenus();
    if (!wasOpen) menu.style.display = 'block';
}

function closeMsgMenus() {
    document.querySelectorAll('.msg-menu').forEach(m => m.style.display = 'none');
}

function copyMsgId(msgId) {
    navigator.clipboard.writeText(msgId).then(() => {
        alert('Message ID copied: ' + msgId);
    }).catch(() => {
        prompt('Copy this Message ID:', msgId);
    });
    closeMsgMenus();
}

function copyMsgText(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Message copied!');
    }).catch(() => {
        prompt('Copy this message:', text);
    });
    closeMsgMenus();
}

function loadMessages() { 
    setupChatListener(); 
    // Scroll to bottom after messages load
    scrollChatToBottom();
}

function scrollChatToBottom() {
    const logs = document.getElementById('chat_logs');
    if (logs) {
        setTimeout(() => { logs.scrollTop = logs.scrollHeight; }, 100);
        setTimeout(() => { logs.scrollTop = logs.scrollHeight; }, 300);
        setTimeout(() => { logs.scrollTop = logs.scrollHeight; }, 600);
        setTimeout(() => { logs.scrollTop = logs.scrollHeight; }, 1000);
    }
}

function uploadChatFile() {
    if (IS_GUEST || !CURRENT_USER) { alert('Must be logged in!'); return; }
    const file = document.getElementById('chat_file').files[0]; if (!file) return;
    const isImage = file.type.startsWith('image/'), isVideo = file.type.startsWith('video/'), isAudio = file.type.startsWith('audio/');
    alert('Uploading file...');
    fileToBase64(file, isImage ? 600 : 0).then(dataUri => {
        const u = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style' };
        const timeNow = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        let mediaType = isVideo ? 'video' : isAudio ? 'audio' : 'image';
        db.ref('chat').push({ user: CURRENT_USER, text: '[' + mediaType.charAt(0).toUpperCase() + mediaType.slice(1) + ']', mediaUrl: dataUri, mediaType: mediaType, tag: u.rank || 'M', style: u.style || 'member-style', time: timeNow, timestamp: firebase.database.ServerValue.TIMESTAMP });
    }).catch(() => { alert('Upload failed.'); });
    document.getElementById('chat_file').value = '';
}

// ADMIN PANEL
function switchAdminTab(tab, el) {
    document.querySelectorAll('.mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
    ['apps', 'members', 'moderation', 'announcements', 'bot', 'videos', 'vip', 'sitetools', 'st', 'st2'].forEach(t => {
        const panel = document.getElementById('admin_tab_' + t);
        if (panel) panel.style.display = t === tab ? 'block' : 'none';
    });
    if (tab === 'apps') loadAllApplications();
    if (tab === 'members') loadAllMembers();
    if (tab === 'moderation') loadBannedUsers();
    if (tab === 'videos') loadAllVideos();
    if (tab === 'vip') loadAllVIPCodes();
    if (tab === 'sitetools') { loadAdminBadgeOptions(); loadSiteMusicStatus(); }
    if (tab === 'st2') { loadSTShopList(); loadGiveItemDropdown(); }
}
function sendBotMessage() { const text = document.getElementById('bot_message').value.trim(); if (!text) return; db.ref('chat').push({ user: 'Eric Northman', text: text, tag: 'BOT', style: 'bot-style', isBot: true, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP }); document.getElementById('bot_message').value = ''; }
function pinMessage() { const text = document.getElementById('pin_message').value.trim(); if (!text) return; db.ref('pinned').set(text); document.getElementById('pin_message').value = ''; alert('Pinned!'); }
function clearPin() { db.ref('pinned').remove(); alert('Cleared!'); }
function clearChat() { if (confirm('Clear ALL chat?')) db.ref('chat').remove(); }

function deleteMessageById() {
    const msgId = document.getElementById('delete_msg_id').value.trim();
    const resultDiv = document.getElementById('delete_msg_result');
    
    if (!msgId) {
        resultDiv.innerHTML = '<span style="color:#f00;">Please enter a message ID.</span>';
        return;
    }
    
    // Check if message exists
    db.ref('chat/' + msgId).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultDiv.innerHTML = '<span style="color:#f00;">Message not found.</span>';
            return;
        }
        
        const msg = snapshot.val();
        if (confirm(`Delete message from ${msg.user}?\n\n"${msg.text?.substring(0, 50)}..."`)) {
            db.ref('chat/' + msgId).remove().then(() => {
                resultDiv.innerHTML = '<span style="color:#0f0;">‚úì Message deleted successfully.</span>';
                document.getElementById('delete_msg_id').value = '';
            }).catch(err => {
                resultDiv.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
            });
        }
    });
}

function exportChat() {
    db.ref('chat').orderByChild('timestamp').once('value', (s) => {
        const msgs = []; s.forEach(c => msgs.push(c.val()));
        const text = msgs.map(m => '[' + (m.time || '') + '] ' + m.user + ': ' + m.text).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fangtasia-chat.txt'; a.click();
    });
}
function loadAllApplications() {
    const container = document.getElementById('all_applications'); if (!container) return;
    const filter = document.getElementById('app_filter')?.value || 'all';
    const search = document.getElementById('app_search')?.value.toLowerCase() || '';
    db.ref('applications').orderByChild('timestamp').once('value', (s) => {
        const apps = []; s.forEach(c => apps.push({ ...c.val(), key: c.key }));
        let filtered = apps.reverse();
        if (filter !== 'all') filtered = filtered.filter(a => a.status === filter);
        if (search) filtered = filtered.filter(a => a.username.toLowerCase().includes(search));
        if (filtered.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No applications found.</div>'; return; }
        container.innerHTML = filtered.map(a => {
            const statusColor = { pending: '#ffd700', approved: '#00ff00', denied: '#ff4444' }[a.status] || '#888';
            const pendingActions = a.status === 'pending' ? `
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid #300;">
                    <input type="text" id="pass_${a.key}" class="ie-input" placeholder="Set password for user..." style="margin-bottom:8px; font-size:11px;">
                    <div style="display:flex; gap:8px;">
                        <button class="ie-btn" style="padding:6px; font-size:10px; background:#030; flex:1;" onclick="approveAndCreateAccount('${a.key}', '${escapeHtml(a.username)}')">‚úì Approve & Create Account</button>
                        <button class="ie-btn" style="padding:6px; font-size:10px; background:#300; flex:1;" onclick="denyApp('${a.key}')">‚úó Deny</button>
                    </div>
                </div>` : '';
            const createdInfo = a.status === 'approved' && a.accountCreated ? '<div style="color:#0f0; font-size:9px; margin-top:5px;">‚úì Account created</div>' : '';
            return `<div style="background:#050000; border:1px solid #400; padding:12px; margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <strong style="color:#d40000;">${escapeHtml(a.username)}</strong>
                    <span style="color:${statusColor}; font-size:10px;">${a.status?.toUpperCase()}</span>
                </div>
                <div style="color:#888; font-size:10px;">
                    <div>Date: ${a.date}</div>
                    <div>Referral: ${escapeHtml(a.referral || 'None')}</div>
                    <div>Reason: ${escapeHtml(a.reason)}</div>
                </div>
                ${createdInfo}
                ${pendingActions}
            </div>`;
        }).join('');
    });
}

function approveAndCreateAccount(appKey, username) {
    const passInput = document.getElementById('pass_' + appKey);
    const password = passInput ? passInput.value.trim() : '';
    
    if (!password) {
        alert('Please set a password for the user!');
        return;
    }
    
    if (password.length < 6) {
        alert('Password must be at least 6 characters!');
        return;
    }
    
    // Check if username already exists
    if (userDatabase[username]) {
        alert('Username already exists!');
        return;
    }
    
    // Create the user account in Firebase
    const newUser = {
        pass: password,
        rank: 'M',
        fullRank: 'Member',
        style: 'member-style',
        isAdmin: false
    };
    
    db.ref('members/' + username).set(newUser).then(() => {
        // Add to local database
        userDatabase[username] = newUser;
        
        // Update application status
        db.ref('applications/' + appKey).update({ 
            status: 'approved',
            accountCreated: true,
            approvedBy: CURRENT_USER,
            approvedAt: Date.now()
        });
        
        alert('Account created for ' + username + '!\n\nPassword: ' + password + '\n\nMake sure to give this to the user!');
        loadAllApplications();
        loadAllMembers();
    }).catch(err => {
        alert('Error creating account: ' + err.message);
    });
}

function approveApp(key) { db.ref('applications/' + key).update({ status: 'approved' }); loadAllApplications(); }
function denyApp(key) { db.ref('applications/' + key).update({ status: 'denied' }); loadAllApplications(); }
function loadAllMembers() {
    const container = document.getElementById('all_members'); if (!container) return;
    const members = [];
    Object.keys(userDatabase).forEach(name => { if (!coreAdmins[name]) members.push({ username: name, ...userDatabase[name] }); });
    Object.keys(coreAdmins).forEach(name => members.push({ username: name, ...coreAdmins[name], isCore: true }));
    container.innerHTML = members.map(m => `<div style="background:#050000; border:1px solid #400; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div><span class="${m.style}" style="font-weight:bold;">${escapeHtml(m.username)}</span><span style="color:#666; font-size:10px;"> [${m.fullRank}]</span></div><span style="color:#555; font-size:9px;">ID: ${generateUserId(m.username)}</span></div>`).join('');
}
function loadBannedUsers() {
    const container = document.getElementById('banned_users'); if (!container) return;
    db.ref('bans').once('value', (s) => {
        const bans = s.val() || {}; const now = Date.now();
        const activeBans = Object.entries(bans).filter(([u, b]) => b.expiry === 0 || b.expiry > now);
        if (activeBans.length === 0) { container.innerHTML = 'None'; return; }
        container.innerHTML = activeBans.map(([user, ban]) => {
            const exp = ban.expiry === 0 ? 'Permanent' : new Date(ban.expiry).toLocaleString();
            return `<div style="border-bottom:1px solid #300; padding:5px 0;"><strong style="color:#ff4444;">${escapeHtml(user)}</strong> [${ban.type}] - ${exp} <button class="ie-btn" style="padding:2px 6px; font-size:8px; width:auto;" onclick="unbanUser('${user}')">Unban</button></div>`;
        }).join('');
    });
}
function unbanUser(username) { db.ref('bans/' + username).remove(); loadBannedUsers(); alert(username + ' unbanned.'); }
function executeModAction() {
    const username = document.getElementById('mod_username').value.trim();
    const action = document.getElementById('mod_action').value;
    const duration = parseInt(document.getElementById('mod_duration').value);
    const reason = document.getElementById('mod_reason').value;
    const resultEl = document.getElementById('mod_result');
    
    if (!username || !action) { 
        resultEl.innerHTML = '<span style="color:#f00;">Select user and action.</span>'; 
        return; 
    }
    
    // Check if trying to moderate core admins or ST
    const targetUser = userDatabase[username];
    if (targetUser && (targetUser.isST || ['losersyndicate', 'noseeyedear', 'oleg'].includes(username.toLowerCase()))) { 
        resultEl.innerHTML = '<span style="color:#f00;">Cannot moderate this user.</span>'; 
        return; 
    }
    
    // Mods can only use warn, mute, timeout, kick, unmute
    const currentUser = userDatabase[CURRENT_USER];
    const modActions = ['warn', 'mute', 'timeout', 'kick', 'unmute'];
    if (currentUser && currentUser.isMod && !currentUser.isAdmin && !modActions.includes(action)) {
        resultEl.innerHTML = '<span style="color:#f00;">Mods can only use: warn, mute, timeout, kick, unmute.</span>'; 
        return;
    }
    
    const expiry = duration === 0 ? 0 : Date.now() + (duration * 60 * 1000);
    
    if (action === 'warn') {
        // Send warning to chat visible only to user (or as system message)
        db.ref('chat').push({
            username: '‚ö†Ô∏è WARNING',
            text: `${username}: ${reason || 'You have been warned by a moderator. Please follow the rules.'}`,
            timestamp: Date.now(),
            style: 'system-style',
            isSystem: true
        });
        resultEl.innerHTML = '<span style="color:#0f0;">‚ö†Ô∏è ' + username + ' has been warned.</span>';
    }
    else if (action === 'mute') {
        db.ref('muted/' + username).set({ 
            expiry: expiry, 
            reason: reason, 
            by: CURRENT_USER,
            timestamp: Date.now()
        });
        resultEl.innerHTML = '<span style="color:#0f0;">üîá ' + username + ' has been muted' + (duration === 0 ? ' permanently' : ' for ' + duration + ' minutes') + '.</span>';
        loadMutedUsers();
    }
    else if (action === 'timeout') {
        db.ref('muted/' + username).set({ 
            expiry: expiry, 
            reason: reason, 
            by: CURRENT_USER,
            timestamp: Date.now(),
            isTimeout: true
        });
        db.ref('online/' + username).remove(); // Also kick them
        resultEl.innerHTML = '<span style="color:#0f0;">‚è±Ô∏è ' + username + ' has been timed out' + (duration === 0 ? ' permanently' : ' for ' + duration + ' minutes') + '.</span>';
        loadMutedUsers();
    }
    else if (action === 'kick') { 
        db.ref('online/' + username).remove(); 
        resultEl.innerHTML = '<span style="color:#0f0;">üë¢ ' + username + ' has been kicked.</span>'; 
    }
    else if (action === 'unmute') {
        db.ref('muted/' + username).remove();
        resultEl.innerHTML = '<span style="color:#0f0;">üîä ' + username + ' has been unmuted.</span>';
        loadMutedUsers();
    }
    else if (action === 'softban' || action === 'hardban') {
        db.ref('bans/' + username).set({ 
            type: action, 
            expiry: expiry, 
            reason: reason, 
            by: CURRENT_USER 
        }); 
        if (action === 'hardban') { 
            db.ref('members/' + username).remove(); 
        } 
        db.ref('online/' + username).remove();
        resultEl.innerHTML = '<span style="color:#0f0;">üö´ ' + username + ' has been ' + action + 'ned.</span>'; 
        loadBannedUsers();
    }
    
    document.getElementById('mod_username').value = '';
    document.getElementById('mod_reason').value = '';
}

function loadMutedUsers() {
    const container = document.getElementById('muted_users');
    if (!container) return;
    
    db.ref('muted').once('value', (snapshot) => {
        if (!snapshot.exists()) {
            container.innerHTML = '<span style="color:#555;">No muted users.</span>';
            return;
        }
        
        let html = '';
        const now = Date.now();
        snapshot.forEach((child) => {
            const data = child.val();
            const username = child.key;
            const isExpired = data.expiry !== 0 && data.expiry < now;
            
            if (isExpired) {
                // Auto-remove expired mutes
                db.ref('muted/' + username).remove();
                return;
            }
            
            const expiryText = data.expiry === 0 ? 'Permanent' : new Date(data.expiry).toLocaleString();
            html += `<div style="background:#1a0000; padding:5px; margin-bottom:3px; border:1px solid #400; display:flex; justify-content:space-between; align-items:center;">
                <span><span style="color:#d40000;">${escapeHtml(username)}</span> <span style="color:#666;">by ${data.by || 'Unknown'}</span></span>
                <button onclick="db.ref('muted/${username}').remove(); loadMutedUsers();" style="background:#333; border:1px solid #500; color:#888; padding:2px 6px; cursor:pointer; font-size:9px;">Unmute</button>
            </div>`;
        });
        
        container.innerHTML = html || '<span style="color:#555;">No muted users.</span>';
    });
}

// Check if user is muted before sending chat
function isUserMuted(username) {
    return new Promise((resolve) => {
        db.ref('muted/' + username).once('value', (snapshot) => {
            if (!snapshot.exists()) {
                resolve(false);
                return;
            }
            const data = snapshot.val();
            const now = Date.now();
            if (data.expiry !== 0 && data.expiry < now) {
                // Expired, remove and allow
                db.ref('muted/' + username).remove();
                resolve(false);
            } else {
                resolve(true);
            }
        });
    });
}

// Setup admin tabs based on user role
function setupAdminTabs(user) {
    const allTabs = ['apps', 'members', 'moderation', 'announcements', 'bot', 'videos', 'vip'];
    const modOnlyTabs = ['members', 'moderation', 'announcements']; // What mods can see
    
    if (user.isAdmin || user.isST) {
        // Admins and ST see everything
        allTabs.forEach(tab => {
            const btn = document.getElementById('admin_tab_' + tab + '_btn');
            if (btn) btn.style.display = 'block';
        });
    } else if (user.isMod) {
        // Mods only see limited tabs
        allTabs.forEach(tab => {
            const btn = document.getElementById('admin_tab_' + tab + '_btn');
            if (btn) {
                btn.style.display = modOnlyTabs.includes(tab) ? 'block' : 'none';
            }
        });
        // Set moderation as default tab for mods
        switchAdminTab('moderation', document.getElementById('admin_tab_moderation_btn'));
    }
}
function loadAllVideos() {
    const container = document.getElementById('all_videos'); if (!container) return;
    db.ref('archive').once('value', (s) => {
        const videos = []; s.forEach(c => videos.push({ ...c.val(), key: c.key }));
        if (videos.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center;">No videos.</div>'; return; }
        container.innerHTML = videos.reverse().map(v => `<div style="background:#050000; border:1px solid #400; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div><strong style="color:#d40000;">${escapeHtml(v.name)}</strong><span style="color:#666; font-size:10px;"> by ${escapeHtml(v.uploader || 'Unknown')}</span></div><div><button class="ie-btn" style="padding:4px 10px; font-size:10px; width:auto; margin-right:5px;" onclick="window.open('${v.url}')">View</button><button class="ie-btn" style="padding:4px 10px; font-size:10px; width:auto; background:#300;" onclick="deleteVideo('${v.key}')">Delete</button></div></div>`).join('');
    });
    // Also refresh memories view
    renderMemories();
}
function deleteVideo(key) { if (confirm('Delete?')) { db.ref('archive/' + key).remove(); loadAllVideos(); renderMemories(); } }
function generateVIPCode() { 
    const maxUses = parseInt(document.getElementById('vip_code_uses')?.value) || 5;
    const code = 'VIP-' + Math.random().toString(36).substring(2, 8).toUpperCase(); 
    db.ref('vip_codes').push({ 
        code: code, 
        maxUses: maxUses,
        created: Date.now(), 
        createdBy: CURRENT_USER, 
        usedBy: {}
    }).then(() => {
        document.getElementById('vip_code_display').innerHTML = `<div style="background:#1a1a00; border:1px solid #5a4a00; padding:10px; border-radius:4px;">‚ú® Code: <strong>${code}</strong><br><span style="color:#888; font-size:10px;">Max uses: ${maxUses}</span></div>`; 
        loadVIPCodeHistory();
    });
}

function loadVIPCodeHistory() {
    const container = document.getElementById('vip_code_history');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888;">Loading...</div>';

// ========== SITE TOOLS (Admin+) ==========

// Site-Wide Music Player
function playSiteMusic() {
    const resultEl = document.getElementById('sitemusic_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const url = document.getElementById('sitemusic_url').value.trim();
    if (!url) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a URL.</span>'; 
        return; 
    }
    
    // Validate URL (YouTube or SoundCloud)
    const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');
    const isSoundCloud = url.includes('soundcloud.com');
    
    if (!isYouTube && !isSoundCloud) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Only YouTube and SoundCloud URLs are supported.</span>';
        return;
    }
    
    const musicData = {
        url: url,
        type: isYouTube ? 'youtube' : 'soundcloud',
        startedBy: CURRENT_USER,
        startedAt: Date.now()
    };
    
    db.ref('site_music').set(musicData).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Music playing for all users!</span>';
        document.getElementById('sitemusic_url').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stopSiteMusic() {
    const resultEl = document.getElementById('sitemusic_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    db.ref('site_music').remove().then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Music stopped.</span>';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadSiteMusicStatus() {
    const statusEl = document.getElementById('sitemusic_current');
    if (!statusEl) return;
    
    db.ref('site_music').once('value', (snapshot) => {
        const music = snapshot.val();
        if (music && music.url) {
            statusEl.innerHTML = `<span style="color:#0f0;">‚ñ∂Ô∏è Now Playing:</span> <span style="color:#ffd700;">${music.type.toUpperCase()}</span><br><span style="color:#888; font-size:9px;">Started by ${music.startedBy}</span>`;
        } else {
            statusEl.innerHTML = 'No music playing';
        }
    });
}

// Site music listener for all users
function startSiteMusicListener() {
    if (!db) return;
    
    db.ref('site_music').on('value', (snapshot) => {
        const music = snapshot.val();
        if (music && music.url) {
            playSiteMusicAudio(music);
        } else {
            stopSiteMusicAudio();
        }
    });
}

let siteMusicPlayer = null;
let siteMusicIframe = null;

function playSiteMusicAudio(music) {
    // Stop any existing
    stopSiteMusicAudio();
    
    // Create hidden player
    const container = document.createElement('div');
    container.id = 'site_music_player';
    container.style.cssText = 'position:fixed; bottom:10px; right:10px; z-index:9999; background:#0a0000; border:2px solid #500; border-radius:8px; padding:10px; width:280px;';
    
    if (music.type === 'youtube') {
        // Extract video ID
        let videoId = '';
        if (music.url.includes('youtu.be/')) {
            videoId = music.url.split('youtu.be/')[1].split('?')[0];
        } else if (music.url.includes('v=')) {
            videoId = music.url.split('v=')[1].split('&')[0];
        }
        
        container.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="color:#d40000; font-size:10px; font-weight:bold;">üéµ Site Music (YouTube)</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:#888; cursor:pointer; font-size:14px;">‚úï</button>
            </div>
            <iframe width="260" height="60" src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" style="border-radius:4px;"></iframe>
        `;
    } else if (music.type === 'soundcloud') {
        container.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="color:#d40000; font-size:10px; font-weight:bold;">üéµ Site Music (SoundCloud)</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:#888; cursor:pointer; font-size:14px;">‚úï</button>
            </div>
            <iframe width="260" height="80" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=${encodeURIComponent(music.url)}&color=%23d40000&auto_play=true&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false" style="border-radius:4px;"></iframe>
        `;
    }
    
    document.body.appendChild(container);
    siteMusicPlayer = container;
}

function stopSiteMusicAudio() {
    const player = document.getElementById('site_music_player');
    if (player) player.remove();
    siteMusicPlayer = null;
}

// Start site music listener
setTimeout(startSiteMusicListener, 3000);

// Admin Reputation Management
function adminModifyRep(direction) {
    const resultEl = document.getElementById('admin_rep_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('admin_rep_username').value.trim();
    const amount = parseInt(document.getElementById('admin_rep_amount').value) || 1;
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const change = direction * amount;
    
    db.ref('reputation/' + username).once('value', (snapshot) => {
        const current = snapshot.val() || 0;
        const newRep = current + change;
        
        db.ref('reputation/' + username).set(newRep).then(() => {
            if (resultEl) resultEl.innerHTML = `<span style="color:#0f0;">‚úì ${username}'s rep: ${current} ‚Üí ${newRep} (${change >= 0 ? '+' : ''}${change})</span>`;
        }).catch(err => {
            if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

// Admin Badge Management
function loadAdminBadgeOptions() {
    const select = document.getElementById('admin_badge_select');
    const resultEl = document.getElementById('admin_badge_result');
    if (!select) {
        console.error('Badge select element not found');
        return;
    }
    
    // Check permissions
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    select.innerHTML = '<option value="">-- Loading... --</option>';
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚è≥ Loading badges...</span>';
    
    db.ref('badge_definitions').once('value', (snapshot) => {
        select.innerHTML = '<option value="">-- Select Badge --</option>';
        let count = 0;
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const badge = child.val();
                const opt = document.createElement('option');
                opt.value = child.key;
                opt.textContent = (badge.icon || 'üèÖ') + ' ' + (badge.name || child.key);
                select.appendChild(opt);
                count++;
            });
        }
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Loaded ' + count + ' badges</span>';
    }).catch(err => {
        select.innerHTML = '<option value="">-- Error loading --</option>';
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function adminAssignBadge() {
    const resultEl = document.getElementById('admin_badge_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('admin_badge_username').value.trim();
    const badgeId = document.getElementById('admin_badge_select').value;
    const submissionUrl = document.getElementById('admin_badge_submission')?.value.trim() || '';
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!badgeId) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const badgeData = {
        id: badgeId,
        assignedBy: CURRENT_USER,
        assignedAt: Date.now()
    };
    
    // Add submission URL if provided
    if (submissionUrl) {
        badgeData.submission = submissionUrl;
    }
    
    db.ref('profiles/' + username + '/badges/' + badgeId).set(badgeData).then(() => {
        const badgeName = badgeDefinitions[badgeId]?.name || badgeId;
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Badge "' + badgeName + '" awarded to ' + username + '!' + (submissionUrl ? ' (with submission)' : '') + '</span>';
        document.getElementById('admin_badge_submission').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function adminRemoveBadge() {
    const resultEl = document.getElementById('admin_badge_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('admin_badge_username').value.trim();
    const badgeId = document.getElementById('admin_badge_select').value;
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!badgeId) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    
    db.ref('profiles/' + username + '/badges/' + badgeId).remove().then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Badge removed from ' + username + '!</span>';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// ========== ADMIN USER MANAGEMENT ==========

async function adminChangeUsername() {
    const resultEl = document.getElementById('admin_username_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    const oldName = document.getElementById('admin_old_username').value.trim();
    const newName = document.getElementById('admin_new_username').value.trim().toLowerCase();
    
    if (!oldName || !newName) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter both usernames.</span>';
        return;
    }
    
    if (newName.length < 2 || newName.length > 20) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username must be 2-20 characters.</span>';
        return;
    }
    
    // Check if target exists
    const targetSnap = await db.ref('members/' + newName).once('value');
    if (targetSnap.exists()) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username "' + newName + '" already taken.</span>';
        return;
    }
    
    if (!confirm('Rename "' + oldName + '" to "' + newName + '"?')) return;
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚è≥ Renaming...</span>';
    
    try {
        // Copy all data to new username
        const paths = ['members', 'profiles', 'profile_comments', 'reputation', 'sessions', 'online'];
        for (const path of paths) {
            const snap = await db.ref(path + '/' + oldName).once('value');
            if (snap.exists()) {
                await db.ref(path + '/' + newName).set(snap.val());
                await db.ref(path + '/' + oldName).remove();
            }
        }
        
        // Update local database
        if (userDatabase[oldName]) {
            userDatabase[newName] = userDatabase[oldName];
            delete userDatabase[oldName];
        }
        
        updateMemberList();
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Renamed "' + oldName + '" to "' + newName + '"</span>';
        
    } catch (err) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    }
}

async function adminCreateUser() {
    const resultEl = document.getElementById('admin_create_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    const username = document.getElementById('admin_create_username').value.trim().toLowerCase();
    const password = document.getElementById('admin_create_password').value;
    const rank = document.getElementById('admin_create_rank').value;
    
    if (!username || !password) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter username and password.</span>';
        return;
    }
    
    if (username.length < 2 || username.length > 20) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username must be 2-20 characters.</span>';
        return;
    }
    
    if (password.length < 4) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Password must be at least 4 characters.</span>';
        return;
    }
    
    // Check if exists
    const existSnap = await db.ref('members/' + username).once('value');
    if (existSnap.exists()) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username already exists.</span>';
        return;
    }
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚è≥ Creating...</span>';
    
    try {
        const rankData = {
            'member': { rank: 'M', fullRank: 'Member', style: 'member-style' },
            'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style' },
            'contrib': { rank: 'CONTRIB', fullRank: 'Contributor', style: 'contrib-style' }
        };
        
        const memberData = rankData[rank] || rankData['member'];
        const hashedPass = await hashPassword(password);
        
        await db.ref('members/' + username).set(memberData);
        await db.ref('auth_users/' + username).set({
            hashedPass: hashedPass,
            createdBy: CURRENT_USER,
            createdAt: Date.now()
        });
        
        userDatabase[username] = memberData;
        updateMemberList();
        
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Created user "' + username + '" as ' + memberData.fullRank + '</span>';
        document.getElementById('admin_create_username').value = '';
        document.getElementById('admin_create_password').value = '';
        
    } catch (err) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    }
}

async function adminLookupUser() {
    const resultEl = document.getElementById('admin_lookup_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    const username = document.getElementById('admin_lookup_username').value.trim();
    if (!username) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>';
        return;
    }
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚è≥ Looking up...</span>';
    
    try {
        const [memberSnap, profileSnap, repSnap] = await Promise.all([
            db.ref('members/' + username).once('value'),
            db.ref('profiles/' + username).once('value'),
            db.ref('reputation/' + username).once('value')
        ]);
        
        if (!memberSnap.exists()) {
            if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>';
            return;
        }
        
        const member = memberSnap.val();
        const profile = profileSnap.val() || {};
        const rep = repSnap.val() || 0;
        
        let html = `<div style="background:#0a0a00; padding:8px; border:1px solid #444; border-radius:4px;">`;
        html += `<div style="color:#ffd700; font-weight:bold;">${escapeHtml(username)}</div>`;
        html += `<div style="color:#888; font-size:9px;">Rank: ${member.fullRank || member.rank || 'Member'}</div>`;
        html += `<div style="color:#888; font-size:9px;">Rep: ${rep}</div>`;
        if (profile.bio) html += `<div style="color:#666; font-size:9px;">Bio: ${escapeHtml(profile.bio.substring(0, 50))}...</div>`;
        html += `</div>`;
        
        if (resultEl) resultEl.innerHTML = html;
        
    } catch (err) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    }
}

async function adminResetPassword() {
    const resultEl = document.getElementById('admin_password_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isAdmin && !user?.isST) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    const username = document.getElementById('admin_reset_username').value.trim().toLowerCase();
    const newPassword = document.getElementById('admin_new_password').value;
    
    if (!username || !newPassword) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter username and new password.</span>';
        return;
    }
    
    if (newPassword.length < 4) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Password must be at least 4 characters.</span>';
        return;
    }
    
    // Check if user is a coreAdmin - can't reset their password
    for (const coreUser of Object.keys(coreAdmins)) {
        if (coreUser.toLowerCase() === username) {
            if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Cannot reset password for core staff member.</span>';
            return;
        }
    }
    
    if (!confirm('Reset password for "' + username + '"?')) return;
    
    try {
        const hashedPass = await hashPassword(newPassword);
        await db.ref('auth_users/' + username).update({
            hashedPass: hashedPass,
            resetBy: CURRENT_USER,
            resetAt: Date.now()
        });
        
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Password reset for "' + username + '"</span>';
        document.getElementById('admin_reset_username').value = '';
        document.getElementById('admin_new_password').value = '';
        
    } catch (err) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    }
}
    
    db.ref('vip_codes').orderByChild('created').once('value', (snapshot) => {
        if (!snapshot.exists()) {
            container.innerHTML = '<div style="color:#666;">No VIP codes generated yet.</div>';
            return;
        }
        
        const codes = [];
        snapshot.forEach((child) => {
            codes.push({ key: child.key, ...child.val() });
        });
        
        // Reverse to show newest first
        codes.reverse();
        
        container.innerHTML = codes.map(c => {
            const usedCount = c.usedBy ? Object.keys(c.usedBy).length : 0;
            const maxUses = c.maxUses || 1;
            const usedBy = c.usedBy ? Object.values(c.usedBy).join(', ') : 'None';
            const isExpired = usedCount >= maxUses;
            const date = new Date(c.created).toLocaleDateString();
            
            return `<div style="background:#0a0000; border:1px solid ${isExpired ? '#333' : '#5a4a00'}; padding:10px; margin-bottom:8px; border-radius:4px; ${isExpired ? 'opacity:0.6;' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#ffd700; font-family:monospace; font-weight:bold;">${c.code || 'Unknown'}</span>
                    <span style="color:${isExpired ? '#666' : '#0f0'}; font-size:10px;">${usedCount}/${maxUses} used</span>
                </div>
                <div style="color:#666; font-size:9px; margin-top:5px;">Created: ${date} by ${c.createdBy || 'Unknown'}</div>
                ${usedCount > 0 ? `<div style="color:#888; font-size:9px; margin-top:3px;">Used by: ${usedBy}</div>` : ''}
                <button onclick="deleteVIPCode('${c.key}')" style="background:#500; border:1px solid #700; color:#f88; padding:3px 8px; font-size:9px; cursor:pointer; margin-top:5px; border-radius:3px;">üóëÔ∏è Delete</button>
            </div>`;
        }).join('');
    });
}

function deleteVIPCode(codeKey) {
    if (!confirm('Delete this VIP code?')) return;
    db.ref('vip_codes/' + codeKey).remove().then(() => {
        loadVIPCodeHistory();
    });
}
function loadAllVIPCodes() {
    const container = document.getElementById('all_vip_codes'); if (!container) return;
    db.ref('vip_codes').once('value', (s) => {
        const codes = []; s.forEach(c => codes.push({ ...c.val(), key: c.key }));
        if (codes.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center;">No codes.</div>'; return; }
        container.innerHTML = codes.reverse().map(c => `<div style="background:#050000; border:1px solid ${c.used ? '#333' : '#ffd700'}; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><span style="color:${c.used ? '#666' : '#ffd700'}; font-family:monospace; font-size:14px;">${c.code}</span><span style="color:#555; font-size:9px;">${c.used ? 'Used by ' + c.usedBy : 'Available'}</span></div>`).join('');
    });
}
function elevateUser() {
    const resultEl = document.getElementById('st_elevate_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('elevate_user').value.trim(), newRank = document.getElementById('elevate_rank').value;
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const rankConfig = { 
        'member': { rank: 'M', fullRank: 'Member', style: 'member-style', isAdmin: false, isMod: false }, 
        'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style', isAdmin: false, isMod: false }, 
        'contrib': { rank: 'CONTRIB', fullRank: 'Contributor', style: 'contrib-style', isAdmin: false, isMod: false }, 
        'mod': { rank: 'MOD', fullRank: 'Moderator', style: 'mod-style', isAdmin: false, isMod: true }, 
        'admin': { rank: 'A', fullRank: 'Admin', style: 'a-style', isAdmin: true, isMod: true } 
    };
    
    const config = rankConfig[newRank];
    db.ref('members/' + username).update(config); 
    userDatabase[username] = { ...userDatabase[username], ...config }; 
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì ' + username + ' set to ' + config.fullRank + '</span>';
}

function applyPermissionPreset() {
    const preset = document.getElementById('perm_preset').value;
    const modCheck = document.getElementById('perm_mod');
    const adminCheck = document.getElementById('perm_admin');
    const vipCheck = document.getElementById('perm_vip_perks');
    
    switch(preset) {
        case 'none':
            modCheck.checked = false;
            adminCheck.checked = false;
            vipCheck.checked = false;
            break;
        case 'vip_perks':
            modCheck.checked = false;
            adminCheck.checked = false;
            vipCheck.checked = true;
            break;
        case 'moderator':
            modCheck.checked = true;
            adminCheck.checked = false;
            vipCheck.checked = true;
            break;
        case 'admin':
            modCheck.checked = true;
            adminCheck.checked = true;
            vipCheck.checked = true;
            break;
        case 'custom':
            // Don't change anything, let user set manually
            break;
    }
}

function setUserPermissions() {
    const resultEl = document.getElementById('st_perm_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('perm_user').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const isMod = document.getElementById('perm_mod').checked;
    const isAdmin = document.getElementById('perm_admin').checked;
    const hasVipPerks = document.getElementById('perm_vip_perks').checked;
    
    const updates = { isMod: isMod, isAdmin: isAdmin, hasVipPerks: hasVipPerks };
    db.ref('members/' + username).update(updates);
    userDatabase[username] = { ...userDatabase[username], ...updates };
    
    const perms = [];
    if (isMod) perms.push('Moderator');
    if (isAdmin) perms.push('Admin');
    if (hasVipPerks) perms.push('VIP Perks');
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì ' + username + ' permissions: ' + (perms.length > 0 ? perms.join(', ') : 'None') + '</span>';
}

// ST TOOLS - CHANGE USERNAME
async function stChangeUsername() {
    const resultEl = document.getElementById('st_username_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const oldName = document.getElementById('st_old_username').value.trim().toLowerCase();
    const newName = document.getElementById('st_new_username').value.trim().toLowerCase();
    if (!oldName || !newName) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter both usernames.</span>'; return; }
    if (!userDatabase[oldName]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User "' + oldName + '" not found.</span>'; return; }
    if (userDatabase[newName]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username "' + newName + '" already taken.</span>'; return; }
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">Changing username...</span>';
    
    try {
        // Copy user data to new username
        const userData = { ...userDatabase[oldName] };
        userDatabase[newName] = userData;
        delete userDatabase[oldName];
        
        // Add old name to deleted accounts filter
        if (!deletedAccounts.includes(oldName)) {
            deletedAccounts.push(oldName);
        }
        
        // Update Firebase Auth - need to create new account with new email
        const oldEmail = oldName + '@fangtasia.wtf';
        const newEmail = newName + '@fangtasia.wtf';
        const password = userData.pass;
        
        // Get old UID
        const uidSnap = await db.ref('user_uids/' + oldName).once('value');
        const oldUid = uidSnap.val();
        
        if (oldUid && password) {
            try {
                // Create new Firebase Auth account with new email
                const newCred = await auth.createUserWithEmailAndPassword(newEmail, password);
                const newUid = newCred.user.uid;
                
                // Update UID mappings
                await db.ref('user_uids/' + newName).set(newUid);
                await db.ref('uid_users/' + newUid).set(newName);
                
                // Remove old mappings
                await db.ref('user_uids/' + oldName).remove();
                await db.ref('uid_users/' + oldUid).remove();
                
                // Sign out new account
                await auth.signOut();
                
                // Sign back in as ST
                if (userDatabase[CURRENT_USER]?.pass) {
                    await auth.signInWithEmailAndPassword(CURRENT_USER + '@fangtasia.wtf', userDatabase[CURRENT_USER].pass);
                }
            } catch (authErr) {
                console.log('Firebase Auth update failed:', authErr);
                // Just update the UID mappings to point to new name
                if (oldUid) {
                    await db.ref('user_uids/' + newName).set(oldUid);
                    await db.ref('uid_users/' + oldUid).set(newName);
                    await db.ref('user_uids/' + oldName).remove();
                }
            }
        }
        
        // Update Firebase members
        await db.ref('members/' + newName).set(userData);
        await db.ref('members/' + oldName).remove();
        
        // Update profiles
        const profileSnap = await db.ref('profiles/' + oldName).once('value');
        if (profileSnap.val()) {
            await db.ref('profiles/' + newName).set(profileSnap.val());
            await db.ref('profiles/' + oldName).remove();
        }
        
        // Update online status
        const onlineSnap = await db.ref('online/' + oldName).once('value');
        if (onlineSnap.val()) {
            await db.ref('online/' + newName).set(onlineSnap.val());
            await db.ref('online/' + oldName).remove();
        }
        
        // Update reputation
        const repSnap = await db.ref('reputation/' + oldName).once('value');
        if (repSnap.val()) {
            await db.ref('reputation/' + newName).set(repSnap.val());
            await db.ref('reputation/' + oldName).remove();
        }
        
        // Update profile comments
        const commentsSnap = await db.ref('profile_comments/' + oldName).once('value');
        if (commentsSnap.val()) {
            await db.ref('profile_comments/' + newName).set(commentsSnap.val());
            await db.ref('profile_comments/' + oldName).remove();
        }
        
        // Update member list
        updateMemberList();
        
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Renamed "' + oldName + '" to "' + newName + '"</span>';
        
    } catch (err) {
        console.error('Username change error:', err);
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    }
}

// ST TOOLS - CUSTOM TAGS
function stSetCustomTag() {
    const resultEl = document.getElementById('st_tag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_tag_username').value.trim();
    const tagText = document.getElementById('st_tag_letter').value.trim();
    const tagColor = document.getElementById('st_tag_color').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (!tagText) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter tag text.</span>'; return; }
    
    // Create unique style name for this user
    const styleName = username.toLowerCase().replace(/[^a-z0-9]/g, '') + '-custom-style';
    
    // Update user database
    userDatabase[username].customTag = tagText;
    userDatabase[username].customTagColor = tagColor;
    userDatabase[username].style = styleName;
    
    // Save to Firebase
    db.ref('members/' + username).update({ 
        customTag: tagText, 
        customTagColor: tagColor,
        style: styleName 
    });
    
    // Inject CSS for the custom style
    const existingStyle = document.getElementById('custom-style-' + username);
    if (existingStyle) existingStyle.remove();
    const styleEl = document.createElement('style');
    styleEl.id = 'custom-style-' + username;
    styleEl.textContent = '.' + styleName + ' { color: ' + tagColor + '; border-color: ' + tagColor + '; background: ' + tagColor + '22; }';
    document.head.appendChild(styleEl);
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Set tag "' + tagText + '" for ' + username + ' with color ' + tagColor + '</span>';
    loadAllMembers();
}

function stRemoveCustomTag() {
    const resultEl = document.getElementById('st_tag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_tag_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    // Get default style based on rank
    const rank = userDatabase[username].rank || 'M';
    const defaultStyles = { 'ST': 'st-style', 'A': 'a-style', 'MOD': 'mod-style', 'CONTRIB': 'contrib-style', 'VIP': 'vip-style', 'M': 'member-style' };
    const defaultStyle = defaultStyles[rank] || 'member-style';
    
    // Update user database
    delete userDatabase[username].customTag;
    delete userDatabase[username].customTagColor;
    userDatabase[username].style = defaultStyle;
    
    // Save to Firebase
    db.ref('members/' + username).update({ 
        customTag: null, 
        customTagColor: null,
        style: defaultStyle 
    });
    
    // Remove custom CSS
    const existingStyle = document.getElementById('custom-style-' + username);
    if (existingStyle) existingStyle.remove();
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Removed custom tag from ' + username + '</span>';
    loadAllMembers();
}

// ST TOOLS - RESET PASSWORD
async function stResetPassword() {
    const resultEl = document.getElementById('st_password_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_reset_username').value.trim().toLowerCase();
    const newPass = document.getElementById('st_new_password').value;
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (!newPass) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a new password.</span>'; return; }
    if (newPass.length < 6) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Password must be at least 6 characters.</span>'; return; }
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">Updating password...</span>';
    
    try {
        // Get the user's UID from mapping
        const uidSnap = await db.ref('user_uids/' + username).once('value');
        const targetUid = uidSnap.val();
        
        if (targetUid) {
            // User has Firebase Auth - we need to update it
            // Since we can't update another user's password directly from client,
            // we'll delete and recreate their account
            const email = username + '@fangtasia.wtf';
            
            // Store current user state
            const currentAuthUser = auth.currentUser;
            
            // Try to sign in as target user to update their password
            // This requires knowing their old password, which we have in the database
            const oldPass = userDatabase[username]?.pass;
            
            if (oldPass) {
                try {
                    // Sign in as target user
                    const targetCred = await auth.signInWithEmailAndPassword(email, oldPass);
                    
                    // Update their password
                    await targetCred.user.updatePassword(newPass);
                    
                    // Sign out target user
                    await auth.signOut();
                    
                    // Sign back in as ST
                    if (FIREBASE_USER) {
                        await auth.signInWithEmailAndPassword(CURRENT_USER + '@fangtasia.wtf', userDatabase[CURRENT_USER]?.pass);
                    }
                    
                    // Update database
                    userDatabase[username].pass = newPass;
                    await db.ref('members/' + username).update({ pass: newPass });
                    
                    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Password updated for ' + username + ' (Firebase Auth + Database)</span>';
                    return;
                } catch (authErr) {
                    console.log('Could not update via auth, will recreate account:', authErr);
                }
            }
            
            // Fallback: Delete old auth account and create new one
            // This is a workaround since we can't directly update another user's password
            if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">Recreating Firebase Auth account...</span>';
            
            // Delete the old auth mapping
            await db.ref('user_uids/' + username).remove();
            await db.ref('uid_users/' + targetUid).remove();
            
            // Create new Firebase Auth account with new password
            try {
                const newCred = await auth.createUserWithEmailAndPassword(email, newPass);
                const newUid = newCred.user.uid;
                
                // Save new UID mappings
                await db.ref('user_uids/' + username).set(newUid);
                await db.ref('uid_users/' + newUid).set(username);
                
                // Sign out the new account
                await auth.signOut();
                
                // Sign back in as ST
                if (userDatabase[CURRENT_USER]?.pass) {
                    await auth.signInWithEmailAndPassword(CURRENT_USER + '@fangtasia.wtf', userDatabase[CURRENT_USER].pass);
                }
            } catch (createErr) {
                console.log('Could not recreate auth account:', createErr);
            }
        }
        
        // Update local database regardless
        userDatabase[username].pass = newPass;
        await db.ref('members/' + username).update({ pass: newPass });
        
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Password reset for ' + username + '</span>';
        
    } catch (err) {
        console.error('Password reset error:', err);
        // Still update database as fallback
        userDatabase[username].pass = newPass;
        db.ref('members/' + username).update({ pass: newPass });
        if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚ö†Ô∏è Password updated in database. User may need to re-authenticate.</span>';
    }
}

// ST TOOLS - DATA MANAGEMENT
function stWipeProfile() {
    const resultEl = document.getElementById('st_data_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_data_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!confirm('Wipe profile for ' + username + '? This removes avatar, bio, status, mood, and music.')) return;
    
    db.ref('profiles/' + username).remove();
    db.ref('reputation/' + username).remove();
    db.ref('profile_comments/' + username).remove();
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Profile wiped for ' + username + '</span>';
}

function stWipeMessages() {
    const resultEl = document.getElementById('st_data_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_data_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!confirm('Delete ALL messages from ' + username + '? This cannot be undone.')) return;
    
    db.ref('chat').orderByChild('user').equalTo(username).once('value', (s) => {
        const updates = {};
        s.forEach((child) => { updates[child.key] = null; });
        db.ref('chat').update(updates);
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Deleted all messages from ' + username + '</span>';
    });
}

function stDeleteUser() {
    const resultEl = document.getElementById('st_data_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_data_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (['losersyndicate', 'noseeyedear', 'oleg'].includes(username.toLowerCase())) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Cannot delete core admins.</span>'; return; 
    }
    if (!confirm('PERMANENTLY DELETE user ' + username + '? This removes their account, profile, messages, and all data. THIS CANNOT BE UNDONE.')) return;
    
    // Remove from local
    delete userDatabase[username];
    
    // Remove from Firebase
    db.ref('members/' + username).remove();
    db.ref('profiles/' + username).remove();
    db.ref('online/' + username).remove();
    db.ref('reputation/' + username).remove();
    db.ref('profile_comments/' + username).remove();
    db.ref('bans/' + username).remove();
    
    // Remove their messages
    db.ref('chat').orderByChild('user').equalTo(username).once('value', (s) => {
        const updates = {};
        s.forEach((child) => { updates[child.key] = null; });
        db.ref('chat').update(updates);
    });
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì User ' + username + ' permanently deleted</span>';
    loadAllMembers();
}

// ST TOOLS - USER LOOKUP
function stLookupUser() {
    const resultEl = document.getElementById('st_lookup_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_lookup_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    
    const user = userDatabase[username];
    if (!user) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    let html = '<div style="background:#0a0000; padding:8px; border:1px solid #ff00ff;">';
    html += '<div style="color:#ff00ff; font-weight:bold; margin-bottom:5px;">' + escapeHtml(username) + '</div>';
    html += '<div>Rank: <span style="color:#fff;">' + (user.fullRank || user.rank || 'Unknown') + '</span></div>';
    html += '<div>Style: <span style="color:#fff;">' + (user.style || 'None') + '</span></div>';
    html += '<div>Custom Tag: <span style="color:#fff;">' + (user.customTag || 'None') + '</span></div>';
    html += '<div>Is Admin: <span style="color:#fff;">' + (user.isAdmin ? 'Yes' : 'No') + '</span></div>';
    html += '<div>Is ST: <span style="color:#fff;">' + (user.isST ? 'Yes' : 'No') + '</span></div>';
    html += '<div>Is Core: <span style="color:#fff;">' + (coreAdmins[username] ? 'Yes' : 'No') + '</span></div>';
    
    // Check online status
    db.ref('online/' + username).once('value', (onlineSnap) => {
        html += '<div>Online: <span style="color:#fff;">' + (onlineSnap.val() ? 'Yes' : 'No') + '</span></div>';
        
        // Check profile
        db.ref('profiles/' + username).once('value', (profileSnap) => {
            const profile = profileSnap.val() || {};
            html += '<div style="margin-top:5px; border-top:1px solid #400; padding-top:5px;">';
            html += '<div>Status: <span style="color:#fff;">' + escapeHtml(profile.status || 'None') + '</span></div>';
            html += '<div>Mood: <span style="color:#fff;">' + escapeHtml(profile.mood || 'None') + '</span></div>';
            html += '<div>Bio: <span style="color:#fff;">' + escapeHtml((profile.bio || 'None').substring(0, 50)) + '</span></div>';
            html += '<div>Avatar: <span style="color:#fff;">' + (profile.avatar ? 'Set' : 'None') + '</span></div>';
            html += '<div>Music: <span style="color:#fff;">' + (profile.music ? 'Set' : 'None') + '</span></div>';
            html += '</div></div>';
            if (resultEl) resultEl.innerHTML = html;
        });
    });
}

// ST CREATE USER - Creates new account in Firebase
async function stCreateUser() {
    const resultEl = document.getElementById('st_create_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const username = document.getElementById('st_create_username').value.trim().toLowerCase();
    const password = document.getElementById('st_create_password').value;
    const rankSelect = document.getElementById('st_create_rank').value;
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!/^[a-z0-9_]+$/.test(username)) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username can only contain letters, numbers, and underscores.</span>'; return; }
    if (!password || password.length < 6) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Password must be at least 6 characters.</span>'; return; }
    
    // Check if username exists
    const existingUser = await db.ref('members/' + username).once('value');
    if (existingUser.exists()) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username already exists!</span>'; 
        return; 
    }
    
    // Check if already has Firebase Auth
    const existingUid = await db.ref('user_uids/' + username).once('value');
    if (existingUid.exists()) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username already has Firebase Auth!</span>';
        return;
    }
    
    const rankConfig = {
        'member': { rank: 'M', fullRank: 'Member', style: 'member-style', isAdmin: false },
        'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style', isAdmin: false },
        'contrib': { rank: 'CONTRIB', fullRank: 'Contributor', style: 'contrib-style', isAdmin: false },
        'mod': { rank: 'MOD', fullRank: 'Moderator', style: 'mod-style', isAdmin: false, isMod: true },
        'admin': { rank: 'A', fullRank: 'Admin', style: 'admin-style', isAdmin: true }
    };
    
    const email = username + '@fangtasia.wtf';
    const stUsername = CURRENT_USER; // Save ST username before auth changes
    
    try {
        if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">Creating Firebase Auth user...</span>';
        
        // Create Firebase Auth user (this will sign us in as the new user temporarily)
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const newUid = userCredential.user.uid;
        
        // Store UID mapping
        await db.ref('user_uids/' + username).set(newUid);
        await db.ref('uid_users/' + newUid).set(username);
        
        // Store member data
        const memberData = { 
            ...rankConfig[rankSelect],
            uid: newUid,
            createdAt: Date.now(),
            createdBy: stUsername
        };
        await db.ref('members/' + username).set(memberData);
        
        // Update local database
        userDatabase[username] = memberData;
        
        // Sign out the newly created user
        await auth.signOut();
        
        // Clear the current user state (ST needs to re-login)
        CURRENT_USER = '';
        FIREBASE_USER = null;
        
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì User "' + escapeHtml(username) + '" created!</span><br><span style="color:#888; font-size:9px;">Login: ' + escapeHtml(username) + ' / ' + escapeHtml(password) + '</span><br><span style="color:#ff0; font-size:10px;">‚ö†Ô∏è Please re-login to continue as ST</span>';
        document.getElementById('st_create_username').value = '';
        document.getElementById('st_create_password').value = '';
        
        // Show login form
        setTimeout(() => {
            alert('User created! Please log back in as ST to continue.');
            document.getElementById('ie_login').style.display = 'block';
            document.getElementById('ie_chat').style.display = 'none';
        }, 1000);
        
    } catch (err) {
        console.error('Create user error:', err);
        if (err.code === 'auth/email-already-in-use') {
            if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User already has Firebase Auth account!</span>';
        } else if (err.code === 'auth/weak-password') {
            if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Password too weak. Use at least 6 characters.</span>';
        } else {
            if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        }
    }
}

// ST MODIFY REPUTATION
function stModifyRep(direction) {
    const resultEl = document.getElementById('st_rep_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const username = document.getElementById('st_rep_username').value.trim();
    const amount = parseInt(document.getElementById('st_rep_amount').value) || 1;
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    db.ref('reputation/' + username).once('value', (s) => {
        const current = s.val() || { score: 0, givers: {} };
        const change = direction > 0 ? amount : -amount;
        current.score = (current.score || 0) + change;
        
        db.ref('reputation/' + username).set(current).then(() => {
            if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì ' + escapeHtml(username) + ' rep: ' + current.score + ' (' + (change > 0 ? '+' : '') + change + ')</span>';
        });
    });
}

function stSetRep() {
    const resultEl = document.getElementById('st_rep_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const username = document.getElementById('st_rep_username').value.trim();
    const amount = parseInt(document.getElementById('st_rep_amount').value);
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (isNaN(amount)) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a valid number.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    db.ref('reputation/' + username).set({ score: amount, givers: {} }).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì ' + escapeHtml(username) + ' rep set to: ' + amount + '</span>';
    });
}

// ST LEAVE COMMENT
function stLeaveComment() {
    const resultEl = document.getElementById('st_comment_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const targetUser = document.getElementById('st_comment_username').value.trim();
    const commentText = document.getElementById('st_comment_text').value.trim();
    
    if (!targetUser) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a target username.</span>'; return; }
    if (!commentText) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter comment text.</span>'; return; }
    if (!userDatabase[targetUser]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const comment = {
        from: '@Admin',
        text: commentText,
        timestamp: Date.now(),
        isAdmin: true,
        actualFrom: CURRENT_USER
    };
    
    db.ref('profile_comments/' + targetUser).push(comment).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Comment posted on ' + escapeHtml(targetUser) + '\'s profile as @Admin</span>';
        document.getElementById('st_comment_text').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// SECURITY MANAGEMENT
function loadSecurityLogs() {
    const container = document.getElementById('st_security_logs');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888;">Loading...</div>';
    
    // Load security logs
    Promise.all([
        db.ref('security_logs/login_attempts').limitToLast(20).once('value'),
        db.ref('security_logs/admin_actions').limitToLast(20).once('value')
    ]).then(([loginAttempts, adminActions]) => {
        const logs = [];
        
        loginAttempts.forEach(child => {
            const d = child.val();
            logs.push({ type: 'üîë Login', user: d.user || 'Unknown', time: d.timestamp, details: d.success ? 'Success' : 'Failed' });
        });
        
        adminActions.forEach(child => {
            const d = child.val();
            logs.push({ type: '‚ö° Admin Action', user: d.admin || 'Unknown', time: d.timestamp, details: d.action || 'Unknown action' });
        });
        
        // Sort by time
        logs.sort((a, b) => (b.time || 0) - (a.time || 0));
        
        if (logs.length === 0) {
            container.innerHTML = '<div style="color:#666;">No security logs found.</div>';
            return;
        }
        
        container.innerHTML = logs.slice(0, 30).map(log => {
            const time = log.time ? new Date(log.time).toLocaleString() : 'Unknown';
            return `<div style="padding:5px; margin-bottom:3px; background:#050000; border-left:2px solid #500;">
                <span style="color:#ff6600;">${log.type}</span> - <span style="color:#888;">${escapeHtml(log.user)}</span>
                <div style="color:#666; font-size:8px;">${time}</div>
                <div style="color:#555; font-size:8px;">${escapeHtml(log.details)}</div>
            </div>`;
        }).join('');
    }).catch(() => {
        container.innerHTML = '<div style="color:#666;">No security logs found.</div>';
    });
}

function stForceLogoutUser() {
    const resultEl = document.getElementById('st_force_logout_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    const username = document.getElementById('st_force_logout_user')?.value.trim();
    if (!username) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>';
        return;
    }
    
    // Set force logout flag and clear their session
    Promise.all([
        db.ref('force_logout/' + username).set({ timestamp: Date.now(), by: CURRENT_USER }),
        db.ref('sessions/' + username).remove(),
        db.ref('online/' + username).remove()
    ]).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Force logout sent to ' + escapeHtml(username) + '</span>';
        document.getElementById('st_force_logout_user').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// Data recovery - copy user data from one account to another
async function stRecoverUserData() {
    const resultEl = document.getElementById('st_recover_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    const fromUser = document.getElementById('st_recover_from')?.value.trim();
    const toUser = document.getElementById('st_recover_to')?.value.trim();
    
    if (!fromUser || !toUser) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter both usernames.</span>';
        return;
    }
    
    if (fromUser === toUser) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Source and target must be different.</span>';
        return;
    }
    
    if (!confirm('This will copy profile, comments, reputation, and badges from "' + fromUser + '" to "' + toUser + '". Continue?')) {
        return;
    }
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚è≥ Recovering data...</span>';
    
    try {
        const paths = ['profiles', 'profile_comments', 'reputation', 'members'];
        let recovered = [];
        
        for (const path of paths) {
            const snap = await db.ref(path + '/' + fromUser).once('value');
            if (snap.exists()) {
                await db.ref(path + '/' + toUser).set(snap.val());
                recovered.push(path);
            }
        }
        
        if (recovered.length > 0) {
            if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Recovered: ' + recovered.join(', ') + '</span>';
        } else {
            if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">No data found for "' + escapeHtml(fromUser) + '"</span>';
        }
    } catch (err) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    }
}

// Quick fix for K's data - recovers from lowercase k
async function recoverKData() {
    const resultEl = document.getElementById('st_recover_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    if (!confirm('This will copy all data from lowercase "k" to uppercase "K". Continue?')) {
        return;
    }
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚è≥ Recovering K\'s data from k...</span>';
    
    try {
        const paths = ['profiles', 'profile_comments', 'reputation'];
        let recovered = [];
        
        for (const path of paths) {
            const snap = await db.ref(path + '/k').once('value');
            if (snap.exists()) {
                const data = snap.val();
                // Check if target doesn't have data or has less data
                const targetSnap = await db.ref(path + '/K').once('value');
                if (!targetSnap.exists() || (path === 'reputation' && (!targetSnap.val() || targetSnap.val() < data))) {
                    await db.ref(path + '/K').set(data);
                    recovered.push(path);
                } else if (path === 'profile_comments' && targetSnap.exists()) {
                    // Merge comments
                    const existingComments = targetSnap.val() || {};
                    const newComments = { ...existingComments, ...data };
                    await db.ref(path + '/K').set(newComments);
                    recovered.push(path + ' (merged)');
                } else if (path === 'profiles') {
                    // Only copy if K's profile is empty
                    const targetData = targetSnap.val() || {};
                    if (!targetData.avatar && !targetData.bio) {
                        await db.ref(path + '/K').set(data);
                        recovered.push(path);
                    }
                }
            }
        }
        
        // Also update K's member data with admin style
        await db.ref('members/K').update({
            rank: 'A',
            fullRank: 'Admin',
            style: 'admin-style',
            isAdmin: true,
            customTag: 'K'
        });
        recovered.push('members (admin style)');
        
        if (recovered.length > 0) {
            if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Recovered for K: ' + recovered.join(', ') + '</span>';
        } else {
            if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">No recoverable data found in lowercase "k"</span>';
        }
    } catch (err) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    }
}

function loadActiveSessions() {
    const container = document.getElementById('st_active_sessions');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888;">Loading...</div>';
    
    db.ref('sessions').once('value', (snapshot) => {
        const sessions = snapshot.val();
        if (!sessions) {
            container.innerHTML = '<div style="color:#666;">No active sessions.</div>';
            return;
        }
        
        const now = Date.now();
        container.innerHTML = Object.keys(sessions).map(username => {
            const s = sessions[username];
            const lastActive = s.lastActivity ? new Date(s.lastActivity).toLocaleString() : 'Unknown';
            const age = s.lastActivity ? Math.floor((now - s.lastActivity) / 60000) + ' min ago' : '';
            return `<div style="padding:5px; margin-bottom:3px; background:#050000; border-left:2px solid #030;">
                <span style="color:#0f0; font-weight:bold;">${escapeHtml(username)}</span>
                <div style="color:#555; font-size:8px;">Last active: ${lastActive} (${age})</div>
                <div style="display:flex; gap:3px; margin-top:3px;">
                    <button onclick="forceLogoutUser('${escapeHtml(username)}')" style="padding:2px 6px; font-size:8px; background:#500; border:1px solid #a00; color:#fff; cursor:pointer; border-radius:2px;">Kick</button>
                </div>
            </div>`;
        }).join('');
    });
}

function forceLogoutUser(username) {
    if (!confirm('Force logout ' + username + '? They will be kicked immediately.')) return;
    
    // Remove session and mark for force logout
    db.ref('sessions/' + username).remove();
    db.ref('online/' + username).remove();
    db.ref('force_logout/' + username).set({
        by: CURRENT_USER,
        timestamp: Date.now()
    }).then(() => {
        alert(username + ' has been kicked.');
        loadActiveSessions();
    });
}

// SITE-WIDE ANNOUNCEMENT SYSTEM
let announcementTypingTimeout = null;
const announceIcons = {
    'info': '‚ÑπÔ∏è',
    'update': 'üÜï',
    'warning': '‚ö†Ô∏è',
    'event': 'üéâ'
};

function sendSiteAnnouncement() {
    const resultEl = document.getElementById('st_announce_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const title = sanitizeInput(document.getElementById('st_announce_title').value.trim());
    const text = sanitizeProfileField(document.getElementById('st_announce_text').value.trim(), 500);
    const type = document.getElementById('st_announce_type').value;
    const duration = Math.min(Math.max(parseInt(document.getElementById('st_announce_duration').value) || 10, 5), 60);
    const imageUrl = sanitizeUrl(document.getElementById('st_announce_image').value.trim());
    const musicUrl = sanitizeUrl(document.getElementById('st_announce_music').value.trim());
    
    if (!text) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter announcement text.</span>'; 
        return; 
    }
    
    // Save to Firebase so all users see it
    const announcement = {
        title: title,
        text: text,
        type: type,
        duration: duration,
        imageUrl: imageUrl || null,
        musicUrl: musicUrl || null,
        timestamp: Date.now(),
        sentBy: CURRENT_USER
    };
    
    console.log('Sending announcement:', announcement);
    
    db.ref('site_announcement').set(announcement).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Announcement sent to all users!</span>';
        document.getElementById('st_announce_title').value = '';
        document.getElementById('st_announce_text').value = '';
        document.getElementById('st_announce_image').value = '';
        document.getElementById('st_announce_music').value = '';
        // Also show to sender immediately
        showAnnouncement(announcement);
    }).catch(err => {
        console.error('Announcement send error:', err);
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function previewAnnouncement() {
    const title = document.getElementById('st_announce_title').value.trim();
    const text = document.getElementById('st_announce_text').value.trim() || 'Preview announcement text...';
    const type = document.getElementById('st_announce_type').value;
    const duration = parseInt(document.getElementById('st_announce_duration').value) || 10;
    const imageUrl = document.getElementById('st_announce_image').value.trim();
    const musicUrl = document.getElementById('st_announce_music').value.trim();
    
    showAnnouncement({ title, text, type, duration, imageUrl, musicUrl });
}

let announcementMusicPlayer = null;
let announcementVideoPlayer = null;

function showAnnouncement(data) {
    const overlay = document.getElementById('announcement_overlay');
    const box = document.getElementById('announcement_box');
    const titleEl = document.getElementById('announce_title');
    const textEl = document.getElementById('announce_text');
    const iconEl = document.getElementById('announce_icon');
    const cursorEl = document.getElementById('announce_cursor');
    const imageEl = document.getElementById('announce_image');
    const musicIndicator = document.getElementById('announce_music_indicator');
    const fromEl = document.getElementById('announce_from');
    
    // Reset
    titleEl.textContent = '';
    textEl.textContent = '';
    cursorEl.style.display = 'inline-block';
    imageEl.style.display = 'none';
    imageEl.innerHTML = '';
    musicIndicator.style.display = 'none';
    if (fromEl) fromEl.innerHTML = '';
    
    // Show who sent it
    if (data.sentBy && fromEl) {
        const sender = data.sentBy;
        const senderData = userDatabase[sender] || {};
        const rankTag = getRankTag(senderData.rank || 'M', senderData.style || 'member-style', sender, true);
        fromEl.innerHTML = `‚Äî from ${rankTag} <span style="color:${getStyleColor(senderData.style || 'member-style')}">${escapeHtml(sender)}</span>`;
    }
    
    // Set type styling
    box.className = '';
    box.classList.add('announce-type-' + (data.type || 'info'));
    
    // Set icon
    iconEl.textContent = announceIcons[data.type] || 'üì¢';
    
    // Show image if provided
    if (data.imageUrl) {
        imageEl.innerHTML = `<img src="${data.imageUrl}" style="max-width:100%; max-height:200px; border-radius:8px; border:1px solid #400;">`;
        imageEl.style.display = 'block';
    }
    
    // Play music if provided (YouTube URL, SoundCloud URL, or legacy video ID)
    if (data.musicUrl || data.musicId) {
        const musicSource = data.musicUrl || data.musicId;
        playAnnouncementMusic(musicSource);
        musicIndicator.style.display = 'block';
    }
    
    // Show overlay
    overlay.style.display = 'flex';
    
    // Typewriter effect for title
    let titleIndex = 0;
    let textIndex = 0;
    const titleStr = data.title || '';
    const textStr = data.text || '';
    const typeSpeed = 30; // ms per character
    
    function typeTitle() {
        if (titleIndex < titleStr.length) {
            titleEl.textContent += titleStr.charAt(titleIndex);
            titleIndex++;
            announcementTypingTimeout = setTimeout(typeTitle, typeSpeed);
        } else {
            // Start typing text after title
            setTimeout(typeText, 200);
        }
    }
    
    function typeText() {
        if (textIndex < textStr.length) {
            textEl.textContent += textStr.charAt(textIndex);
            textIndex++;
            announcementTypingTimeout = setTimeout(typeText, typeSpeed);
        } else {
            // Typing complete - hide cursor
            cursorEl.style.display = 'none';
            
            // Auto-dismiss after duration (but keep video playing)
            setTimeout(() => {
                dismissAnnouncement(false); // Don't stop video
            }, (data.duration || 10) * 1000);
        }
    }
    
    // Start typing
    if (titleStr) {
        typeTitle();
    } else {
        typeText();
    }
    
    // Click to dismiss
    overlay.onclick = () => dismissAnnouncement(false);
}

function playAnnouncementMusic(source) {
    // Stop any existing announcement music
    stopAnnouncementMusic();
    
    // Check if it's a SoundCloud URL
    if (source.includes('soundcloud.com')) {
        // SoundCloud embed - show in corner with close button
        const container = document.createElement('div');
        container.id = 'announcement_video_container';
        container.style.cssText = 'position:fixed; bottom:20px; right:20px; width:320px; height:120px; z-index:99998; border:2px solid #ff5500; border-radius:8px; overflow:hidden; box-shadow:0 0 20px rgba(255,85,0,0.3); background:#000;';
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '‚úï';
        closeBtn.style.cssText = 'position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.8); border:1px solid #ff5500; color:#fff; width:24px; height:24px; border-radius:50%; cursor:pointer; z-index:10; font-size:12px;';
        closeBtn.onclick = (e) => { e.stopPropagation(); stopAnnouncementMusic(); };
        
        const iframe = document.createElement('iframe');
        iframe.id = 'announcement_music_player';
        iframe.style.cssText = 'width:100%; height:100%; border:none;';
        iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(source)}&auto_play=true&color=%23ff5500&buying=false&sharing=false`;
        iframe.allow = 'autoplay';
        
        container.appendChild(closeBtn);
        container.appendChild(iframe);
        document.body.appendChild(container);
        announcementVideoPlayer = container;
        announcementMusicPlayer = iframe;
        return;
    }
    
    // Extract YouTube video ID from URL or use as-is
    let videoId = source;
    const ytMatch = source.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\s]+)/);
    if (ytMatch) videoId = ytMatch[1];
    
    // Always show YouTube video player in bottom right corner
    const container = document.createElement('div');
    container.id = 'announcement_video_container';
    container.style.cssText = 'position:fixed; bottom:20px; right:20px; width:320px; height:200px; z-index:99998; border:2px solid #d40000; border-radius:8px; overflow:hidden; box-shadow:0 0 20px rgba(139,0,0,0.5); background:#000;';
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '‚úï';
    closeBtn.style.cssText = 'position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.8); border:1px solid #500; color:#fff; width:24px; height:24px; border-radius:50%; cursor:pointer; z-index:10; font-size:12px;';
    closeBtn.onclick = (e) => { e.stopPropagation(); stopAnnouncementMusic(); };
    
    const iframe = document.createElement('iframe');
    iframe.id = 'announcement_music_player';
    iframe.style.cssText = 'width:100%; height:100%; border:none;';
    iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1`;
    iframe.allow = 'autoplay; encrypted-media';
    
    container.appendChild(closeBtn);
    container.appendChild(iframe);
    document.body.appendChild(container);
    announcementVideoPlayer = container;
    announcementMusicPlayer = iframe;
}

function stopAnnouncementMusic() {
    if (announcementMusicPlayer) {
        announcementMusicPlayer.remove();
        announcementMusicPlayer = null;
    }
    if (announcementVideoPlayer) {
        announcementVideoPlayer.remove();
        announcementVideoPlayer = null;
    }
    const existingPlayer = document.getElementById('announcement_music_player');
    if (existingPlayer) existingPlayer.remove();
    const existingContainer = document.getElementById('announcement_video_container');
    if (existingContainer) existingContainer.remove();
}

function dismissAnnouncement(stopMusic = true) {
    const overlay = document.getElementById('announcement_overlay');
    overlay.style.display = 'none';
    if (announcementTypingTimeout) {
        clearTimeout(announcementTypingTimeout);
        announcementTypingTimeout = null;
    }
    // Only stop music if explicitly requested (video can keep playing)
    if (stopMusic) {
        stopAnnouncementMusic();
    }
}

// Listen for site announcements
function startAnnouncementListener() {
    if (!db) {
        console.error('DB not ready for announcement listener');
        setTimeout(startAnnouncementListener, 1000);
        return;
    }
    
    console.log('Starting announcement listener...');
    
    db.ref('site_announcement').on('value', (snapshot) => {
        const data = snapshot.val();
        console.log('Announcement data received:', data);
        
        if (data && data.timestamp) {
            // Only show if announcement is recent (within last 5 minutes)
            const age = Date.now() - data.timestamp;
            if (age < 300000) { // 5 minutes
                // Check if we already showed this announcement
                const lastShown = sessionStorage.getItem('lastAnnouncement');
                if (lastShown !== data.timestamp.toString()) {
                    sessionStorage.setItem('lastAnnouncement', data.timestamp.toString());
                    console.log('Showing announcement...');
                    showAnnouncement(data);
                }
            }
        }
    }, (error) => {
        console.error('Announcement listener error:', error);
    });
}

// Start listener when page loads
setTimeout(startAnnouncementListener, 2000);

// ========== ADMIN MESSAGES (ST to Admins) ==========

function sendAdminMessage() {
    const resultEl = document.getElementById('st_admin_msg_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const text = document.getElementById('st_admin_msg_text').value.trim();
    const priority = document.getElementById('st_admin_msg_priority').value;
    
    if (!text) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a message.</span>'; 
        return; 
    }
    
    const message = {
        text: text,
        priority: priority,
        from: CURRENT_USER,
        timestamp: Date.now(),
        readBy: {}
    };
    
    db.ref('admin_messages').push(message).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Message sent to all admins!</span>';
        document.getElementById('st_admin_msg_text').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// ========== ST SHOP MANAGEMENT ==========

function stAddShopItem() {
    const resultEl = document.getElementById('shop_add_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const name = document.getElementById('shop_item_name').value.trim();
    const price = parseInt(document.getElementById('shop_item_price').value);
    const type = document.getElementById('shop_item_type').value;
    const fileInput = document.getElementById('shop_item_file');
    const urlInput = document.getElementById('shop_item_image').value.trim();
    
    if (!name) { resultEl.innerHTML = '<span style="color:#f00;">Enter item name.</span>'; return; }
    if (!price || price < 1) { resultEl.innerHTML = '<span style="color:#f00;">Enter valid price.</span>'; return; }
    
    // For effects, no image needed
    if (type === 'effect') {
        const effectClass = document.getElementById('shop_item_effectclass').value;
        if (!effectClass) { resultEl.innerHTML = '<span style="color:#f00;">Select an effect type.</span>'; return; }
        
        const itemId = 'item_' + Date.now();
        db.ref('shop_items/' + itemId).set({
            name: name, imageUrl: '', price: price, type: 'effect',
            effectClass: effectClass, addedBy: CURRENT_USER, addedAt: Date.now()
        }).then(() => {
            resultEl.innerHTML = '<span style="color:#0f0;">‚úì Effect added! ID: ' + itemId + '</span>';
            document.getElementById('shop_item_name').value = '';
            loadSTShopList();
        });
        return;
    }
    
    // For image items: prefer file upload, fall back to URL
    if (fileInput.files[0]) {
        const preserveAnim = (type === 'effect');
        fileToBase64(fileInput.files[0], 400, preserveAnim).then(dataUri => {
            saveShopItem(name, dataUri, price, type, resultEl);
        });
    } else if (urlInput) {
        saveShopItem(name, urlInput, price, type, resultEl);
    } else {
        resultEl.innerHTML = '<span style="color:#f00;">Upload an image or paste a URL.</span>';
    }
}

function saveShopItem(name, imageUrl, price, type, resultEl) {
    const itemId = 'item_' + Date.now();
    const data = { name, imageUrl, price, type, addedBy: CURRENT_USER, addedAt: Date.now() };
    db.ref('shop_items/' + itemId).set(data).then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Item added! ID: ' + itemId + '</span>';
        document.getElementById('shop_item_name').value = '';
        document.getElementById('shop_item_image').value = '';
        document.getElementById('shop_item_file').value = '';
        document.getElementById('shop_add_preview').style.display = 'none';
        clearAddPreview();
        loadSTShopList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// Toggle effect options vs image upload based on type selection
document.getElementById('shop_item_type')?.addEventListener('change', function() {
    const isEffect = this.value === 'effect';
    document.getElementById('shop_add_effect_opts').style.display = isEffect ? 'block' : 'none';
    document.getElementById('shop_add_image_section').style.display = isEffect ? 'none' : 'block';
    if (!isEffect) updateAddPreview();
});

// File upload preview
document.getElementById('shop_item_file')?.addEventListener('change', function() {
    if (this.files[0]) {
        const type = document.getElementById('shop_item_type').value;
        const preserveAnim = (type === 'effect');
        fileToBase64(this.files[0], 400, preserveAnim).then(dataUri => {
            document.getElementById('shop_item_image').value = '';
            showAddPreview(dataUri);
        });
    }
});

// URL input preview
document.getElementById('shop_item_image')?.addEventListener('input', function() {
    const url = this.value.trim();
    if (url && (url.startsWith('data:') || url.startsWith('http'))) {
        showAddPreview(url);
    }
});

function showAddPreview(imageUrl) {
    const preview = document.getElementById('shop_add_preview');
    preview.style.display = 'block';
    // Show image next to avatar
    const container = document.getElementById('shop_add_preview_container');
    const existing = container.querySelector('.preview-item-img');
    if (existing) existing.remove();
    const img = document.createElement('img');
    img.className = 'preview-item-img';
    img.src = imageUrl;
    img.style.cssText = 'width:80px; height:80px; object-fit:contain; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:3;';
    container.appendChild(img);
}

function clearAddPreview() {
    const container = document.getElementById('shop_add_preview_container');
    if (container) {
        const existing = container.querySelector('.preview-item-img');
        if (existing) existing.remove();
    }
}

// Bulk upload preview thumbnails
function previewBulkUpload() {
    const grid = document.getElementById('bulk_preview_grid');
    const files = document.getElementById('bulk_item_files').files;
    grid.innerHTML = '';
    if (!files.length) return;
    
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            const name = file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');
            grid.innerHTML += `<div style="background:#111; border:1px solid #500; border-radius:4px; padding:4px; text-align:center;">
                <img src="${e.target.result}" style="width:60px; height:60px; object-fit:contain; display:block; margin:0 auto 3px;">
                <div style="color:#aaa; font-size:7px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</div>
            </div>`;
        };
        reader.readAsDataURL(file);
    });
}

function loadSTShopList() {
    const container = document.getElementById('st_shop_list');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888;">Loading...</div>';
    
    db.ref('shop_items').once('value', (snap) => {
        const items = snap.val() || {};
        if (Object.keys(items).length === 0) {
            container.innerHTML = '<div style="color:#888;">No items in shop</div>';
            return;
        }
        
        container.innerHTML = Object.entries(items).map(([id, item]) => {
            const typeColors = { frame: '#0ff', hat: '#ff0', accessory: '#f0f', effect: '#0f0', badge: '#ffd700' };
            const tc = typeColors[item.type] || '#888';
            const thumb = item.imageUrl 
                ? `<img src="${item.imageUrl}" style="width:40px; height:40px; object-fit:contain; border:1px solid #400; border-radius:4px; background:#111;" onerror="this.style.display='none'">`
                : `<div style="width:40px; height:40px; border:1px solid #400; border-radius:4px; background:#111; display:flex; align-items:center; justify-content:center; font-size:14px;">${item.type === 'effect' ? '‚ú®' : '?'}</div>`;
            return `<div style="display:flex; align-items:center; gap:8px; padding:6px; border-bottom:1px solid #300;">
                ${thumb}
                <div style="flex:1; min-width:0;">
                    <div style="color:#fff; font-size:11px;">${escapeHtml(item.name)}</div>
                    <div style="display:flex; gap:5px; align-items:center; margin-top:2px;">
                        <span style="color:${tc}; font-size:8px; border:1px solid ${tc}; padding:0 3px; border-radius:2px;">${(item.type||'?').toUpperCase()}</span>
                        <span style="color:#ffd700; font-size:9px;">ü™ô ${item.price}</span>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="color:#555; font-size:7px; cursor:pointer; word-break:break-all; max-width:100px;" onclick="document.getElementById('shop_edit_id').value='${id}'" title="Click to fill edit field">${id}</div>
                </div>
            </div>`;
        }).join('');
    });
}

function stEditShopPrice() {
    const resultEl = document.getElementById('shop_edit_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const itemId = document.getElementById('shop_edit_id').value.trim();
    const newPrice = parseInt(document.getElementById('shop_edit_price').value);
    
    if (!itemId) { resultEl.innerHTML = '<span style="color:#f00;">Enter item ID.</span>'; return; }
    if (!newPrice || newPrice < 1) { resultEl.innerHTML = '<span style="color:#f00;">Enter valid price.</span>'; return; }
    
    db.ref('shop_items/' + itemId + '/price').set(newPrice).then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">Price updated!</span>';
        loadSTShopList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stDeleteShopItem() {
    const resultEl = document.getElementById('shop_edit_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isST && !user?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const itemId = document.getElementById('shop_edit_id').value.trim();
    if (!itemId) { resultEl.innerHTML = '<span style="color:#f00;">Enter item ID.</span>'; return; }
    
    if (!confirm('Delete shop item ' + itemId + '?')) return;
    
    db.ref('shop_items/' + itemId).remove().then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">Item deleted!</span>';
        document.getElementById('shop_edit_id').value = '';
        loadSTShopList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function deleteAllShopItems() {
    const resultEl = document.getElementById('delete_all_shop_result');
    const user = userDatabase[CURRENT_USER];
    if (!user?.isST && !user?.isAdmin) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    if (!confirm('‚ö†Ô∏è DELETE ALL SHOP ITEMS?\n\nThis removes every item from the shop. Users keep items they already purchased.\n\nThis cannot be undone!')) return;
    if (!confirm('Are you REALLY sure? Type "yes" mentally and click OK.')) return;
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#ff0;">‚è≥ Deleting all shop items...</span>';
    
    db.ref('shop_items').remove().then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì All shop items deleted! Shop is now empty.</span>';
        loadSTShopList();
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

async function bulkUploadItems() {
    const resultEl = document.getElementById('bulk_upload_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }

    const fileInput = document.getElementById('bulk_item_files');
    const type = document.getElementById('bulk_item_type').value;
    const price = parseInt(document.getElementById('bulk_item_price').value) || 500;

    if (!fileInput.files || fileInput.files.length === 0) {
        resultEl.innerHTML = '<span style="color:#f00;">Select at least one image file.</span>';
        return;
    }

    const files = Array.from(fileInput.files);
    resultEl.innerHTML = '<span style="color:#ffd700;">Uploading ' + files.length + ' items...</span>';

    let success = 0, failed = 0;
    let log = '';

    for (const file of files) {
        // Get name from filename (remove extension)
        const name = file.name.replace(/\.[^/.]+$/, '').replace(/_/g, ' ').replace(/-/g, ' ');

        try {
            // Convert to base64 data URI (preserve animation for frames/effects)
            const preserveAnim = (type === 'effect');
            const dataUri = await fileToBase64(file, 400, preserveAnim);

            // Add to Firebase
            const itemId = 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            await db.ref('shop_items/' + itemId).set({
                name: name,
                imageUrl: dataUri,
                price: price,
                type: type,
                addedBy: CURRENT_USER,
                addedAt: Date.now()
            });
            success++;
            log += '<div style="color:#0f0;">‚úì ' + name + '</div>';
        } catch (err) {
            failed++;
            log += '<div style="color:#f00;">‚úó ' + name + ' - ' + err.message + '</div>';
        }

        // Update progress
        resultEl.innerHTML = '<span style="color:#ffd700;">Progress: ' + (success + failed) + '/' + files.length + '</span><br>' + log;
    }

    resultEl.innerHTML = '<span style="color:#0f0;">Done! ' + success + ' uploaded, ' + failed + ' failed.</span><br>' + log;
    fileInput.value = '';
    loadSTShopList();
}

// ========== MAINTENANCE MODE ==========

function playMaintenanceMusic(url) {
    const container = document.getElementById('maintenance_music_player');
    if (!container || !url) { if (container) container.innerHTML = ''; return; }
    
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
        let videoId = '';
        const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if (match) videoId = match[1];
        if (videoId) {
            container.innerHTML = `<iframe width="300" height="60" src="https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}" frameborder="0" allow="autoplay; encrypted-media" style="border-radius:6px; opacity:0.7;"></iframe>`;
        }
    } else if (url.includes('soundcloud.com')) {
        container.innerHTML = `<iframe width="300" height="80" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23d40000&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false" style="border-radius:6px; opacity:0.7; filter:invert(0.85) hue-rotate(180deg) contrast(1.1);"></iframe>`;
    } else {
        container.innerHTML = '';
    }
}

function stopMaintenanceMusic() {
    const container = document.getElementById('maintenance_music_player');
    if (container) container.innerHTML = '';
}

function toggleMaintenanceMode(enable) {
    const resultEl = document.getElementById('maintenance_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>';
        return;
    }
    
    const message = document.getElementById('maintenance_message')?.value || 'We\'re performing scheduled maintenance. Please check back soon!';
    const music = document.getElementById('maintenance_music')?.value?.trim() || '';
    
    if (enable) {
        db.ref('site_settings/maintenance').set({
            enabled: true,
            message: message,
            music: music,
            enabledBy: CURRENT_USER,
            enabledAt: Date.now()
        }).then(() => {
            resultEl.innerHTML = '<span style="color:#ff0;">Maintenance mode ENABLED!</span>';
            updateMaintenanceStatus();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    } else {
        db.ref('site_settings/maintenance').set({
            enabled: false,
            disabledBy: CURRENT_USER,
            disabledAt: Date.now()
        }).then(() => {
            resultEl.innerHTML = '<span style="color:#0f0;">Maintenance mode DISABLED!</span>';
            updateMaintenanceStatus();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    }
}

function updateMaintenanceStatus() {
    const statusEl = document.getElementById('maintenance_status');
    db.ref('site_settings/maintenance').once('value', (snap) => {
        const data = snap.val() || {};
        if (statusEl) {
            if (data.enabled) {
                statusEl.innerHTML = '<span style="color:#ff0;">Status: ON</span> (enabled by ' + (data.enabledBy || 'unknown') + ')';
            } else {
                statusEl.innerHTML = '<span style="color:#0f0;">Status: OFF</span>';
            }
        }
        // Load saved music URL into input
        const musicInput = document.getElementById('maintenance_music');
        if (musicInput && data.music) musicInput.value = data.music;
    });
}

function setupMaintenanceListener() {
    if (!db) {
        setTimeout(setupMaintenanceListener, 1000);
        return;
    }
    
    db.ref('site_settings/maintenance').on('value', (snap) => {
        const data = snap.val() || {};
        const overlay = document.getElementById('maintenance_overlay');
        const messageEl = document.getElementById('maintenance_overlay_message');
        
        maintenanceEnabled = data.enabled || false;
        
        // ST users always bypass maintenance mode
        if (CURRENT_USER && userDatabase[CURRENT_USER]?.isST) {
            if (overlay) overlay.style.display = 'none';
            updateMaintenanceStatus();
            return;
        }
        
        if (data.enabled) {
            if (messageEl) messageEl.textContent = data.message || 'We\'re performing scheduled maintenance. Please check back soon!';
            if (overlay) overlay.style.display = 'flex';
            // Play maintenance music if set
            playMaintenanceMusic(data.music || '');
            // Disable all interaction
            document.body.style.overflow = 'hidden';
        } else {
            if (overlay) overlay.style.display = 'none';
            stopMaintenanceMusic();
            document.body.style.overflow = '';
        }
    });
}

// Start maintenance check immediately when Firebase is ready
function initMaintenanceCheck() {
    if (!db) {
        setTimeout(initMaintenanceCheck, 500);
        return;
    }
    
    // Check maintenance status immediately on page load
    db.ref('site_settings/maintenance').once('value', (snap) => {
        const data = snap.val() || {};
        const overlay = document.getElementById('maintenance_overlay');
        const messageEl = document.getElementById('maintenance_overlay_message');
        
        maintenanceEnabled = data.enabled || false;
        
        if (data.enabled) {
            if (messageEl) messageEl.textContent = data.message || 'We\'re performing scheduled maintenance. Please check back soon!';
            if (overlay) overlay.style.display = 'flex';
            playMaintenanceMusic(data.music || '');
            document.body.style.overflow = 'hidden';
        }
    });
    
    // Then setup the real-time listener
    setupMaintenanceListener();
}

// Run maintenance check as soon as possible
setTimeout(initMaintenanceCheck, 100);

function stGiveTokens() {
    const resultEl = document.getElementById('st_token_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('st_token_username').value.trim();
    const amount = parseInt(document.getElementById('st_token_amount').value);
    
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!userDatabase[username]) { resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (!amount || amount < 1) { resultEl.innerHTML = '<span style="color:#f00;">Enter valid amount.</span>'; return; }
    
    db.ref('game_stats/tokens/' + username).transaction((current) => {
        return (current || 0) + amount;
    }).then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">Gave ' + amount + ' tokens to ' + username + '!</span>';
        document.getElementById('st_token_username').value = '';
        document.getElementById('st_token_amount').value = '';
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadGiveItemDropdown() {
    const select = document.getElementById('st_give_item_id');
    if (!select) return;
    
    select.innerHTML = '<option value="">Loading...</option>';
    
    db.ref('shop_items').once('value', (snap) => {
        const items = snap.val() || {};
        let options = '<option value="">-- Select Item --</option>';
        
        for (const [id, item] of Object.entries(items)) {
            options += `<option value="${id}">${escapeHtml(item.name)} (${item.type}) - ${item.price} tokens</option>`;
        }
        
        select.innerHTML = options;
    });
}

function stGiveItem() {
    const resultEl = document.getElementById('st_give_item_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('st_give_item_username').value.trim();
    const itemId = document.getElementById('st_give_item_id').value;
    
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!userDatabase[username]) { resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (!itemId) { resultEl.innerHTML = '<span style="color:#f00;">Select an item.</span>'; return; }
    
    // Check if user already owns this item
    db.ref('profiles/' + username + '/shopItems/' + itemId).once('value', (snap) => {
        if (snap.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">User already owns this item!</span>';
            return;
        }
        
        // Give the item to the user
        db.ref('profiles/' + username + '/shopItems/' + itemId).set({
            purchasedAt: Date.now(),
            equipped: false,
            giftedBy: CURRENT_USER
        }).then(() => {
            resultEl.innerHTML = '<span style="color:#0f0;">Item given to ' + username + '!</span>';
            document.getElementById('st_give_item_username').value = '';
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

function startAdminMessageListener() {
    if (!db) {
        setTimeout(startAdminMessageListener, 1000);
        return;
    }
    
    // Only listen if current user is admin
    if (!userDatabase[CURRENT_USER]?.isAdmin && !userDatabase[CURRENT_USER]?.isMod) return;
    
    db.ref('admin_messages').orderByChild('timestamp').limitToLast(10).on('value', (snapshot) => {
        if (!snapshot.exists()) return;
        
        const messages = [];
        snapshot.forEach((child) => {
            messages.push({ key: child.key, ...child.val() });
        });
        
        // Find unread messages for current user
        const unread = messages.filter(m => !m.readBy || !m.readBy[CURRENT_USER]);
        
        if (unread.length > 0) {
            // Show the most recent unread message
            const latest = unread[unread.length - 1];
            showAdminMessageNotification(latest);
        }
    });
}

function showAdminMessageNotification(msg) {
    const notification = document.getElementById('admin_msg_notification');
    const content = document.getElementById('admin_msg_content');
    const timeEl = document.getElementById('admin_msg_time');
    const badge = document.getElementById('admin_msg_priority_badge');
    
    if (!notification || !content) return;
    
    // Store current message key for marking as read
    notification.dataset.msgKey = msg.key;
    
    // Set content
    content.textContent = msg.text;
    
    // Set time
    const date = new Date(msg.timestamp);
    timeEl.textContent = date.toLocaleString();
    
    // Set priority badge
    const priorities = {
        'normal': { text: 'üìã NORMAL', bg: '#2a2000', color: '#888' },
        'important': { text: '‚ö†Ô∏è IMPORTANT', bg: '#4a3000', color: '#ffa500' },
        'urgent': { text: 'üö® URGENT', bg: '#4a0000', color: '#ff4444' }
    };
    const p = priorities[msg.priority] || priorities.normal;
    badge.textContent = p.text;
    badge.style.background = p.bg;
    badge.style.color = p.color;
    
    // Update border color based on priority
    if (msg.priority === 'urgent') {
        notification.querySelector('div').style.borderColor = '#ff4444';
        notification.querySelector('div').style.boxShadow = '0 4px 20px rgba(255,68,68,0.4), inset 0 1px 0 rgba(255,68,68,0.2)';
    } else if (msg.priority === 'important') {
        notification.querySelector('div').style.borderColor = '#ffa500';
        notification.querySelector('div').style.boxShadow = '0 4px 20px rgba(255,165,0,0.3), inset 0 1px 0 rgba(255,165,0,0.2)';
    } else {
        notification.querySelector('div').style.borderColor = '#ffd700';
        notification.querySelector('div').style.boxShadow = '0 4px 20px rgba(255,215,0,0.3), inset 0 1px 0 rgba(255,215,0,0.2)';
    }
    
    // Show notification
    notification.style.display = 'block';
}

function dismissAdminMessage() {
    const notification = document.getElementById('admin_msg_notification');
    if (!notification) return;
    
    const msgKey = notification.dataset.msgKey;
    
    // Mark as read in database
    if (msgKey && CURRENT_USER) {
        db.ref('admin_messages/' + msgKey + '/readBy/' + CURRENT_USER).set(Date.now());
    }
    
    // Hide notification
    notification.style.display = 'none';
}

// Start admin message listener after login (called from finishLogin)
// We'll call it from the login success area

// ========== FORCE SITE REFRESH ==========

function triggerSiteRefresh() {
    const resultEl = document.getElementById('st_refresh_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const updateMessage = document.getElementById('st_update_message')?.value.trim() || 'Site has been updated!';
    
    if (!confirm('Push update to ALL users?\nMessage: "' + updateMessage + '"\n\nThis will refresh everyone\'s page.')) return;
    
    db.ref('force_refresh').set({
        timestamp: Date.now(),
        triggeredBy: CURRENT_USER,
        message: updateMessage
    }).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">‚úì Update pushed! All users will see: "' + escapeHtml(updateMessage) + '"</span>';
        document.getElementById('st_update_message').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function startForceRefreshListener() {
    if (!db) {
        setTimeout(startForceRefreshListener, 1000);
        return;
    }
    
    let initialLoad = true;
    db.ref('force_refresh').on('value', (snapshot) => {
        if (initialLoad) {
            initialLoad = false;
            return;
        }
        
        const data = snapshot.val();
        if (data && data.timestamp) {
            // Check if refresh was triggered in last 10 seconds
            if (Date.now() - data.timestamp < 10000) {
                const updateMsg = data.message || 'Site has been updated!';
                
                // Show prominent update notification
                const notify = document.createElement('div');
                notify.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:999999; display:flex; justify-content:center; align-items:center;';
                notify.innerHTML = `
                    <div style="text-align:center; padding:40px; background:linear-gradient(180deg, #0a1a1a, #000); border:3px solid #00ffff; border-radius:12px; box-shadow:0 0 50px rgba(0,255,255,0.3); max-width:500px;">
                        <div style="font-size:60px; margin-bottom:20px;">üîÑ</div>
                        <div style="color:#00ffff; font-size:24px; font-weight:bold; margin-bottom:15px;">SITE UPDATE</div>
                        <div style="color:#fff; font-size:16px; margin-bottom:20px; line-height:1.5;">${escapeHtml(updateMsg)}</div>
                        <div style="color:#888; font-size:14px;">Refreshing in <span id="update_countdown">5</span> seconds...</div>
                        <div style="margin-top:20px; height:4px; background:#333; border-radius:2px; overflow:hidden;">
                            <div id="update_progress" style="height:100%; background:linear-gradient(90deg, #00ffff, #00ff88); width:0%; transition:width 0.1s linear;"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(notify);
                
                // Countdown animation
                let countdown = 5;
                const countdownEl = document.getElementById('update_countdown');
                const progressEl = document.getElementById('update_progress');
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdownEl) countdownEl.textContent = countdown;
                    if (progressEl) progressEl.style.width = ((5 - countdown) * 20) + '%';
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        location.reload(true);
                    }
                }, 1000);
            }
        }
    });
}

// Start listening for force refresh
setTimeout(startForceRefreshListener, 2000);

function loadSiteStatus() {
    const statusEl = document.getElementById('st_site_status');
    if (!statusEl) return;
    
    statusEl.innerHTML = '<span style="color:#888;">Loading...</span>';
    
    // Get various stats
    Promise.all([
        db.ref('online').once('value'),
        db.ref('members').once('value'),
        db.ref('chat').limitToLast(1).once('value'),
        db.ref('force_refresh').once('value')
    ]).then(([onlineSnap, membersSnap, chatSnap, refreshSnap]) => {
        const onlineCount = onlineSnap.exists() ? Object.keys(onlineSnap.val() || {}).length : 0;
        const memberCount = membersSnap.exists() ? Object.keys(membersSnap.val() || {}).length : 0;
        const lastRefresh = refreshSnap.val()?.timestamp ? new Date(refreshSnap.val().timestamp).toLocaleString() : 'Never';
        const lastRefreshBy = refreshSnap.val()?.triggeredBy || 'N/A';
        
        statusEl.innerHTML = `
            <div style="margin-bottom:5px;">üë• <strong>Online:</strong> <span style="color:#0f0;">${onlineCount}</span></div>
            <div style="margin-bottom:5px;">üìã <strong>Total Members:</strong> <span style="color:#0ff;">${memberCount}</span></div>
            <div style="margin-bottom:5px;">üîÑ <strong>Last Refresh:</strong> <span style="color:#888;">${lastRefresh}</span></div>
            <div>üë§ <strong>Refreshed by:</strong> <span style="color:#888;">${lastRefreshBy}</span></div>
        `;
    }).catch(err => {
        statusEl.innerHTML = '<span style="color:#f00;">Error loading status</span>';
    });
}

// ST CLUB MANAGEMENT FUNCTIONS
function stCreateClub() {
    const resultEl = document.getElementById('st_club_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const name = document.getElementById('st_club_name').value.trim();
    const owner = document.getElementById('st_club_owner').value.trim();
    const color = document.getElementById('st_club_color').value.trim() || '#d40000';
    const description = document.getElementById('st_club_desc').value.trim();
    
    if (!name) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!owner) { resultEl.innerHTML = '<span style="color:#f00;">Enter owner username.</span>'; return; }
    if (!userDatabase[owner]) { resultEl.innerHTML = '<span style="color:#f00;">Owner user not found.</span>'; return; }
    
    // Check if club name already exists
    db.ref('clubs').orderByChild('name').equalTo(name).once('value', (snapshot) => {
        if (snapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">Club name already exists.</span>';
            return;
        }
        
        const clubData = {
            name: name,
            owner: owner,
            color: color,
            description: description || 'A club created by ST.',
            members: { [owner]: true },
            privacy: 'public',
            createdAt: Date.now(),
            createdBy: CURRENT_USER + ' (ST)'
        };
        
        db.ref('clubs').push(clubData).then(() => {
            resultEl.innerHTML = `<span style="color:#0f0;">‚úì Club "${name}" created with owner ${owner}!</span>`;
            document.getElementById('st_club_name').value = '';
            document.getElementById('st_club_owner').value = '';
            document.getElementById('st_club_desc').value = '';
            // Refresh clubs cache
            loadAllClubs();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

function stTransferClub() {
    const resultEl = document.getElementById('st_club_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_transfer_club').value.trim();
    const newOwner = document.getElementById('st_transfer_to').value.trim();
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!newOwner) { resultEl.innerHTML = '<span style="color:#f00;">Enter new owner username.</span>'; return; }
    if (!userDatabase[newOwner]) { resultEl.innerHTML = '<span style="color:#f00;">New owner user not found.</span>'; return; }
    
    // Find the club
    db.ref('clubs').orderByChild('name').equalTo(clubName).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">Club not found.</span>';
            return;
        }
        
        let clubKey = null;
        let clubData = null;
        snapshot.forEach((child) => {
            clubKey = child.key;
            clubData = child.val();
        });
        
        const oldOwner = clubData.owner;
        
        // Update owner and ensure new owner is a member
        const updates = {
            owner: newOwner,
            [`members/${newOwner}`]: true
        };
        
        db.ref('clubs/' + clubKey).update(updates).then(() => {
            resultEl.innerHTML = `<span style="color:#0f0;">‚úì Club "${clubName}" transferred from ${oldOwner} to ${newOwner}!</span>`;
            document.getElementById('st_transfer_club').value = '';
            document.getElementById('st_transfer_to').value = '';
            loadAllClubs();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

function stRenameClub() {
    const resultEl = document.getElementById('st_club_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const oldName = document.getElementById('st_rename_club_old').value.trim();
    const newName = document.getElementById('st_rename_club_new').value.trim();
    
    if (!oldName) { resultEl.innerHTML = '<span style="color:#f00;">Enter current club name.</span>'; return; }
    if (!newName) { resultEl.innerHTML = '<span style="color:#f00;">Enter new club name.</span>'; return; }
    
    // Check if new name already exists
    db.ref('clubs').orderByChild('name').equalTo(newName).once('value', (newSnapshot) => {
        if (newSnapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">New club name already exists.</span>';
            return;
        }
        
        // Find the club to rename
        db.ref('clubs').orderByChild('name').equalTo(oldName).once('value', (snapshot) => {
            if (!snapshot.exists()) {
                resultEl.innerHTML = '<span style="color:#f00;">Club not found.</span>';
                return;
            }
            
            let clubKey = null;
            snapshot.forEach((child) => {
                clubKey = child.key;
            });
            
            db.ref('clubs/' + clubKey).update({ name: newName }).then(() => {
                resultEl.innerHTML = `<span style="color:#0f0;">‚úì Club renamed from "${oldName}" to "${newName}"!</span>`;
                document.getElementById('st_rename_club_old').value = '';
                document.getElementById('st_rename_club_new').value = '';
                loadAllClubs();
            }).catch(err => {
                resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
            });
        });
    });
}

function stDeleteClub() {
    const resultEl = document.getElementById('st_club_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_delete_club').value.trim();
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name to delete.</span>'; return; }
    
    if (!confirm(`Are you sure you want to DELETE the club "${clubName}"?\n\nThis cannot be undone!`)) {
        return;
    }
    
    // Find the club
    db.ref('clubs').orderByChild('name').equalTo(clubName).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">Club not found.</span>';
            return;
        }
        
        let clubKey = null;
        snapshot.forEach((child) => {
            clubKey = child.key;
        });
        
        db.ref('clubs/' + clubKey).remove().then(() => {
            resultEl.innerHTML = `<span style="color:#0f0;">‚úì Club "${clubName}" deleted!</span>`;
            document.getElementById('st_delete_club').value = '';
            loadAllClubs();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

// CLUB TAG MANAGEMENT
function stSetClubTag() {
    const resultEl = document.getElementById('st_clubtag_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_clubtag_club').value.trim().toLowerCase();
    const tagText = document.getElementById('st_clubtag_tag').value.trim();
    const tagColor = document.getElementById('st_clubtag_color').value.trim() || '#d40000';
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!tagText) { resultEl.innerHTML = '<span style="color:#f00;">Enter tag text.</span>'; return; }
    
    // Update local clubTags object
    clubTags[clubName] = { tag: tagText, color: tagColor };
    
    // Save to Firebase for persistence
    db.ref('club_tags/' + clubName.replace(/[.#$/\[\]]/g, '_')).set({
        clubName: clubName,
        tag: tagText,
        color: tagColor,
        setBy: CURRENT_USER,
        setAt: Date.now()
    }).then(() => {
        resultEl.innerHTML = `<span style="color:#0f0;">‚úì Club tag set: "${clubName}" ‚Üí <span style="color:${tagColor};">[${tagText}]</span></span>`;
        document.getElementById('st_clubtag_club').value = '';
        document.getElementById('st_clubtag_tag').value = '';
        loadClubTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stRemoveClubTag() {
    const resultEl = document.getElementById('st_clubtag_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_clubtag_remove').value.trim().toLowerCase();
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    
    // Remove from local clubTags
    delete clubTags[clubName];
    
    // Remove from Firebase
    db.ref('club_tags/' + clubName.replace(/[.#$/\[\]]/g, '_')).remove().then(() => {
        resultEl.innerHTML = `<span style="color:#0f0;">‚úì Club tag removed for "${clubName}"</span>`;
        document.getElementById('st_clubtag_remove').value = '';
        loadClubTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadClubTagsList() {
    const container = document.getElementById('st_clubtags_list');
    if (!container) return;
    
    // Show local clubTags first
    let html = '<div style="color:#888; margin-bottom:5px;">Local (hardcoded):</div>';
    for (const [club, data] of Object.entries(clubTags)) {
        html += `<div style="padding:3px 0;"><span style="color:#888;">${club}</span> ‚Üí <span style="color:${data.color}; border:1px solid ${data.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${data.tag}</span></div>`;
    }
    
    // Load from Firebase
    db.ref('club_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            html += '<div style="color:#888; margin:10px 0 5px 0; border-top:1px solid #300; padding-top:5px;">From Database:</div>';
            snapshot.forEach((child) => {
                const data = child.val();
                html += `<div style="padding:3px 0;"><span style="color:#888;">${data.clubName}</span> ‚Üí <span style="color:${data.color}; border:1px solid ${data.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${data.tag}</span></div>`;
                // Also update local clubTags
                clubTags[data.clubName] = { tag: data.tag, color: data.color };
            });
        }
        container.innerHTML = html || '<div style="color:#666;">No club tags configured.</div>';
    });
}

// Load club tags from Firebase on startup
function loadClubTagsFromDB() {
    db.ref('club_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const data = child.val();
                clubTags[data.clubName] = { tag: data.tag, color: data.color };
            });
        }
    });
}
setTimeout(loadClubTagsFromDB, 1500);

// MEMBERLIST TAGS - Similar to clubTags but for memberlist display
let memberlistTags = {
    '##sb': { tag: '##SB', color: '#6a03b4' },
    'sb': { tag: '##SB', color: '#6a03b4' },
    '#sb': { tag: '##SB', color: '#6a03b4' },
    '##SB': { tag: '##SB', color: '#6a03b4' }
};

function stSetMemberlistTag() {
    const resultEl = document.getElementById('st_mltag_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_mltag_club').value.trim().toLowerCase();
    const tagText = document.getElementById('st_mltag_tag').value.trim();
    const tagColor = document.getElementById('st_mltag_color').value.trim() || '#6a03b4';
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!tagText) { resultEl.innerHTML = '<span style="color:#f00;">Enter tag text.</span>'; return; }
    
    // Save to Firebase
    const tagKey = clubName.replace(/[.#$/\[\]]/g, '_');
    db.ref('memberlist_tags/' + tagKey).set({
        clubName: clubName,
        tag: tagText,
        color: tagColor
    }).then(() => {
        memberlistTags[clubName] = { tag: tagText, color: tagColor };
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Memberlist tag set for "' + clubName + '"!</span>';
        document.getElementById('st_mltag_club').value = '';
        document.getElementById('st_mltag_tag').value = '';
        loadMemberlistTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stRemoveMemberlistTag() {
    const resultEl = document.getElementById('st_mltag_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_mltag_remove').value.trim().toLowerCase();
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    
    const tagKey = clubName.replace(/[.#$/\[\]]/g, '_');
    db.ref('memberlist_tags/' + tagKey).remove().then(() => {
        delete memberlistTags[clubName];
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Memberlist tag removed for "' + clubName + '"!</span>';
        document.getElementById('st_mltag_remove').value = '';
        loadMemberlistTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadMemberlistTagsList() {
    const container = document.getElementById('st_mltags_list');
    if (!container) return;
    
    let html = '<div style="color:#888; margin-bottom:5px;">Local tags:</div>';
    Object.keys(memberlistTags).forEach(club => {
        const t = memberlistTags[club];
        html += `<div style="padding:3px 0;"><span style="color:${t.color}; border:1px solid ${t.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${t.tag}</span> ‚Üí ${club}</div>`;
    });
    
    html += '<div style="color:#888; margin-top:10px; margin-bottom:5px; border-top:1px solid #400; padding-top:5px;">Database tags:</div>';
    
    db.ref('memberlist_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const t = child.val();
                html += `<div style="padding:3px 0;"><span style="color:${t.color}; border:1px solid ${t.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${t.tag}</span> ‚Üí ${t.clubName}</div>`;
            });
        } else {
            html += '<div style="color:#555;">No database tags.</div>';
        }
        container.innerHTML = html;
    });
}

function loadMemberlistTagsFromDB() {
    db.ref('memberlist_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const data = child.val();
                memberlistTags[data.clubName] = { tag: data.tag, color: data.color };
            });
        }
    });
}
setTimeout(loadMemberlistTagsFromDB, 1500);

// Store user club cache for memberlist display
let userClubsCache = {};

function getUserMemberlistTag(username) {
    // Check if user is in any club that has a memberlist tag
    // Returns { tag, color } or null
    if (userClubsCache[username]) {
        for (const club of userClubsCache[username]) {
            const clubNameLower = club.name.toLowerCase();
            if (memberlistTags[clubNameLower]) {
                return memberlistTags[clubNameLower];
            }
        }
    }
    return null;
}

// Cache user clubs for memberlist tags
function cacheAllUserClubs() {
    db.ref('clubs').once('value', (snapshot) => {
        userClubsCache = {};
        snapshot.forEach((clubSnap) => {
            const club = { id: clubSnap.key, ...clubSnap.val() };
            const clubNameLower = (club.name || '').toLowerCase();
            
            // Add owner
            if (club.owner) {
                if (!userClubsCache[club.owner]) userClubsCache[club.owner] = [];
                userClubsCache[club.owner].push({ ...club, name: club.name });
            }
            // Add members
            if (club.members) {
                club.members.forEach(member => {
                    if (!userClubsCache[member]) userClubsCache[member] = [];
                    userClubsCache[member].push({ ...club, name: club.name });
                });
            }
        });
        // Refresh memberlist after clubs are cached
        updateMemberList();
    });
}
setTimeout(cacheAllUserClubs, 2000);

// BADGE SYSTEM - Dynamic from Firebase
// Default badges (will be merged with Firebase badges)
let badgeDefinitions = {
    'happy_merchant': {
        name: 'Happy Merchant',
        image: 'data:image/png;base64,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',
        description: 'Was found very irritatable and annoying by the Staff Team'
    },
    'mossad_agent': {
        name: 'Mossad Agent',
        image: 'data:image/png;base64,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',
        description: 'Proven to be very helpful for the Sites Staff Team'
    },
    'israeli_citizen': {
        name: 'Israeli Citizen',
        image: 'data:image/png;base64,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',
        description: 'Alpha Badge'
    },
    'nazi_party': {
        name: 'Nazi Party',
        image: 'data:image/png;base64,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',
        description: 'Evil and Mean Members of the Site are Granted this Badge'
    }
};

// Load badges from Firebase and merge with defaults
function loadBadgesFromFirebase() {
    db.ref('badge_definitions').once('value', (snapshot) => {
        const fbBadges = snapshot.val() || {};
        badgeDefinitions = { ...badgeDefinitions, ...fbBadges };
    });
}
setTimeout(loadBadgesFromFirebase, 1500);

// Badge upload preview
document.addEventListener('DOMContentLoaded', () => {
    const uploadEl = document.getElementById('st_badge_upload');
    const urlEl = document.getElementById('st_badge_url');
    if (uploadEl) {
        uploadEl.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const preview = document.getElementById('st_badge_preview');
                    const previewImg = document.getElementById('st_badge_preview_img');
                    if (preview && previewImg) {
                        previewImg.src = ev.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    if (urlEl) {
        urlEl.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url) {
                const preview = document.getElementById('st_badge_preview');
                const previewImg = document.getElementById('st_badge_preview_img');
                if (preview && previewImg) {
                    previewImg.src = url;
                    preview.style.display = 'block';
                }
            }
        });
    }
});

function stCreateBadge() {
    const resultEl = document.getElementById('st_create_badge_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const badgeId = document.getElementById('st_new_badge_id').value.trim().toLowerCase().replace(/\s+/g, '_');
    const badgeName = document.getElementById('st_new_badge_name').value.trim();
    const badgeDesc = document.getElementById('st_new_badge_desc').value.trim();
    const uploadEl = document.getElementById('st_badge_upload');
    const urlEl = document.getElementById('st_badge_url');
    
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Enter badge ID.</span>'; return; }
    if (!badgeName) { resultEl.innerHTML = '<span style="color:#f00;">Enter display name.</span>'; return; }
    if (!badgeDesc) { resultEl.innerHTML = '<span style="color:#f00;">Enter description.</span>'; return; }
    
    // Get image - either from upload or URL
    const urlValue = urlEl ? urlEl.value.trim() : '';
    const fileValue = uploadEl && uploadEl.files[0];
    
    if (fileValue) {
        // Upload file as base64
        const reader = new FileReader();
        reader.onload = (e) => {
            saveBadgeToFirebase(badgeId, badgeName, badgeDesc, e.target.result, resultEl);
        };
        reader.readAsDataURL(fileValue);
    } else if (urlValue) {
        // Use URL directly
        saveBadgeToFirebase(badgeId, badgeName, badgeDesc, urlValue, resultEl);
    } else {
        resultEl.innerHTML = '<span style="color:#f00;">Upload an image or provide a URL.</span>';
    }
}

function saveBadgeToFirebase(id, name, description, image, resultEl) {
    const badgeData = {
        name: name,
        description: description,
        image: image,
        createdBy: CURRENT_USER,
        createdAt: Date.now()
    };
    
    db.ref('badge_definitions/' + id).set(badgeData).then(() => {
        // Update local cache
        badgeDefinitions[id] = badgeData;
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Badge "' + name + '" created!</span>';
        // Clear form
        document.getElementById('st_new_badge_id').value = '';
        document.getElementById('st_new_badge_name').value = '';
        document.getElementById('st_new_badge_desc').value = '';
        document.getElementById('st_badge_url').value = '';
        document.getElementById('st_badge_upload').value = '';
        document.getElementById('st_badge_preview').style.display = 'none';
        // Refresh library
        loadBadgeLibrary();
        loadBadgeSelectOptions();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadBadgeSelectOptions() {
    db.ref('badge_definitions').once('value', (snapshot) => {
        const fbBadges = snapshot.val() || {};
        const allBadges = { ...badgeDefinitions, ...fbBadges };
        
        const selectEl = document.getElementById('st_badge_select');
        const deleteSelectEl = document.getElementById('st_delete_badge_select');
        
        if (selectEl) {
            selectEl.innerHTML = '<option value="">-- Select Badge --</option>' +
                Object.keys(allBadges).map(id => 
                    `<option value="${escapeHtml(id)}">${escapeHtml(allBadges[id].name)}</option>`
                ).join('');
        }
        
        if (deleteSelectEl) {
            deleteSelectEl.innerHTML = '<option value="">-- Select Badge to Delete --</option>' +
                Object.keys(allBadges).map(id => 
                    `<option value="${escapeHtml(id)}">${escapeHtml(allBadges[id].name)}</option>`
                ).join('');
        }
        
        // Update local cache
        badgeDefinitions = allBadges;
    });
}

function loadBadgeLibrary() {
    db.ref('badge_definitions').once('value', (snapshot) => {
        const fbBadges = snapshot.val() || {};
        const allBadges = { ...badgeDefinitions, ...fbBadges };
        
        const libraryEl = document.getElementById('st_badge_library');
        if (!libraryEl) return;
        
        if (Object.keys(allBadges).length === 0) {
            libraryEl.innerHTML = '<div style="color:#666; font-size:10px; width:100%; text-align:center;">No badges found.</div>';
            return;
        }
        
        libraryEl.innerHTML = Object.keys(allBadges).map(id => {
            const badge = allBadges[id];
            return `<div style="text-align:center; width:70px;" title="${escapeHtml(badge.name)} - ${escapeHtml(badge.description)}">
                <img src="${escapeHtml(badge.image)}" style="width:40px; height:40px; border-radius:4px; border:1px solid #500;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect fill=%22%23333%22 width=%2240%22 height=%2240%22/><text x=%2250%%22 y=%2255%%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2212%22>?</text></svg>'">
                <div style="color:#888; font-size:8px; margin-top:3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(badge.name)}</div>
                <div style="color:#555; font-size:7px;">${escapeHtml(id)}</div>
            </div>`;
        }).join('');
        
        // Update local cache
        badgeDefinitions = allBadges;
    });
}

function stDeleteBadge() {
    const resultEl = document.getElementById('st_delete_badge_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const badgeId = document.getElementById('st_delete_badge_select').value;
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    
    if (!confirm('Are you sure you want to delete this badge? Users who have it will lose it.')) return;
    
    db.ref('badge_definitions/' + badgeId).remove().then(() => {
        delete badgeDefinitions[badgeId];
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Badge deleted!</span>';
        loadBadgeLibrary();
        loadBadgeSelectOptions();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stAssignBadge() {
    const resultEl = document.getElementById('st_badge_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('st_badge_username').value.trim();
    const badgeId = document.getElementById('st_badge_select').value;
    const submissionUrl = document.getElementById('st_badge_submission')?.value.trim() || '';
    
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    if (!userDatabase[username]) { resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const badgeName = badgeDefinitions[badgeId]?.name || badgeId;
    
    const badgeData = {
        id: badgeId,
        assignedBy: CURRENT_USER,
        assignedAt: Date.now()
    };
    
    // Add submission URL if provided
    if (submissionUrl) {
        badgeData.submission = submissionUrl;
    }
    
    db.ref('profiles/' + username + '/badges/' + badgeId).set(badgeData).then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Badge "' + badgeName + '" assigned to ' + username + '!' + (submissionUrl ? ' (with submission)' : '') + '</span>';
        document.getElementById('st_badge_submission').value = '';
        // Refresh profile card if it's open for this user
        if (currentProfileUser === username) {
            openProfileWindow(username);
        }
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stRemoveBadge() {
    const resultEl = document.getElementById('st_badge_result');
    const _u = userDatabase[CURRENT_USER]; if (!_u?.isST && !_u?.isAdmin) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. Admin+ only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('st_badge_username').value.trim();
    const badgeId = document.getElementById('st_badge_select').value;
    
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    
    db.ref('profiles/' + username + '/badges/' + badgeId).remove().then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Badge removed from ' + username + '!</span>';
        // Refresh profile card if it's open for this user
        if (currentProfileUser === username) {
            openProfileWindow(username);
        }
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// WATCH PARTY SYSTEM
let currentWatchPartyRoom = null;
let wpPlayerReady = false;
let wpPlayer = null;
let wpChatListener = null;
let wpSyncInterval = null;

function switchWatchPartyTab(tab, el) {
    document.querySelectorAll('#watchparty_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('wp_tab_rooms').style.display = tab === 'rooms' ? 'block' : 'none';
    document.getElementById('wp_tab_create').style.display = tab === 'create' ? 'block' : 'none';
    document.getElementById('wp_tab_room').style.display = tab === 'room' ? 'flex' : 'none';
    
    if (tab === 'rooms') loadWatchPartyRooms();
}

function loadWatchPartyRooms() {
    const container = document.getElementById('wp_room_list');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">Loading...</div>';
    
    db.ref('watch_parties').orderByChild('createdAt').once('value', (snapshot) => {
        if (!snapshot.exists()) {
            container.innerHTML = '<div style="color:#555; text-align:center; padding:40px; background:#050000; border:1px dashed #300; border-radius:4px;"><div style="font-size:30px; margin-bottom:10px;">üé¨</div>No active watch parties.<br><span style="color:#666; font-size:10px;">Create one to get started!</span></div>';
            return;
        }
        
        const rooms = [];
        snapshot.forEach((child) => {
            rooms.push({ key: child.key, ...child.val() });
        });
        
        rooms.reverse();
        
        container.innerHTML = rooms.map(room => {
            const viewerCount = room.viewers ? Object.keys(room.viewers).length : 0;
            const isPrivate = room.type === 'private';
            const isHost = room.host === CURRENT_USER;
            
            return `<div style="background:linear-gradient(180deg, #0a0000, #050000); border:1px solid #500; padding:15px; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.3);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="color:#d40000; font-weight:bold; text-shadow:0 0 5px rgba(139,0,0,0.3);">${isPrivate ? 'üîí ' : 'üé¨ '}${escapeHtml(room.name)}</span>
                    <span style="color:#888; font-size:10px; background:#1a0808; padding:3px 8px; border-radius:10px;">üë• ${viewerCount}</span>
                </div>
                <div style="color:#666; font-size:10px; margin-bottom:10px;">Host: <span style="color:#888;">${escapeHtml(room.host)}</span></div>
                <div style="display:flex; gap:8px;">
                    <button class="ie-btn" style="flex:1; padding:8px 15px;" onclick="joinWatchPartyRoom('${room.key}')">Join</button>
                    ${isHost ? `<button class="ie-btn" style="width:auto; padding:8px 12px; background:#500;" onclick="deleteWatchPartyRoom('${room.key}')">üóëÔ∏è</button>` : ''}
                </div>
            </div>`;
        }).join('');
    });
}

function createWatchPartyRoom() {
    const resultEl = document.getElementById('wp_create_result');
    const name = document.getElementById('wp_room_name').value.trim();
    const videoUrl = document.getElementById('wp_video_url').value.trim();
    const type = document.getElementById('wp_room_type').value;
    
    if (!CURRENT_USER || IS_GUEST) {
        resultEl.innerHTML = '<span style="color:#f00;">Must be logged in!</span>';
        return;
    }
    
    if (!name) { resultEl.innerHTML = '<span style="color:#f00;">Enter room name.</span>'; return; }
    if (!videoUrl) { resultEl.innerHTML = '<span style="color:#f00;">Enter YouTube URL.</span>'; return; }
    
    // Extract video ID from URL
    let videoId = videoUrl;
    const ytMatch = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\s]+)/);
    if (ytMatch) videoId = ytMatch[1];
    
    const roomData = {
        name: name,
        videoId: videoId,
        host: CURRENT_USER,
        type: type,
        createdAt: Date.now(),
        currentTime: 0,
        isPlaying: false,
        viewers: { [CURRENT_USER]: true }
    };
    
    db.ref('watch_parties').push(roomData).then((ref) => {
        resultEl.innerHTML = '<span style="color:#0f0;">‚úì Room created!</span>';
        document.getElementById('wp_room_name').value = '';
        document.getElementById('wp_video_url').value = '';
        joinWatchPartyRoom(ref.key);
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

let wpCurrentHost = null;
let wpKeepAwakeInterval = null;

function joinWatchPartyRoom(roomKey) {
    // First check if user is banned from this room
    db.ref('watch_parties/' + roomKey + '/banned/' + CURRENT_USER).once('value', (banSnap) => {
        if (banSnap.exists()) {
            alert('You have been banned from this watch party room.');
            return;
        }
        
        currentWatchPartyRoom = roomKey;
        
        // Add self to viewers
        db.ref('watch_parties/' + roomKey + '/viewers/' + CURRENT_USER).set({
            username: CURRENT_USER,
            joinedAt: Date.now()
        });
        
        // Remove on disconnect
        db.ref('watch_parties/' + roomKey + '/viewers/' + CURRENT_USER).onDisconnect().remove();
        
        // Load room data
        db.ref('watch_parties/' + roomKey).once('value', (snapshot) => {
            const room = snapshot.val();
            if (!room) {
                alert('Room not found!');
                return;
            }
            
            wpCurrentHost = room.host;
            document.getElementById('wp_room_title').textContent = room.name;
            
            // Show host badge if user is host
            const hostBadge = document.getElementById('wp_host_badge');
            if (hostBadge) {
                hostBadge.style.display = (CURRENT_USER === room.host) ? 'inline' : 'none';
            }
            
            // Enable/disable host-only controls
            updateWPHostControls(room.host);
            
            // Switch to room view
            switchWatchPartyTab('room', null);
            
            // Initialize YouTube player
            const videoId = room.videoId || room.mediaSource;
            initWPPlayer(videoId, room.currentTime, room.isPlaying);
            
            // Start chat listener
            startWPChatListener(roomKey);
            
            // Start sync listener
            startWPSyncListener(roomKey, room.host);
            
            // Update viewer count and list
            updateWPViewerCount(roomKey);
            
            // Prevent screen from going idle
            startWPKeepAwake();
        });
    });
}

function updateWPHostControls(host) {
    const isHost = CURRENT_USER === host;
    
    // Disable controls for non-hosts
    document.querySelectorAll('.wp-host-only').forEach(el => {
        el.disabled = !isHost;
        el.style.opacity = isHost ? '1' : '0.5';
        el.style.cursor = isHost ? 'pointer' : 'not-allowed';
    });
}

function startWPKeepAwake() {
    // Clear any existing interval
    if (wpKeepAwakeInterval) clearInterval(wpKeepAwakeInterval);
    
    // Prevent screen idle by simulating activity every 30 seconds
    wpKeepAwakeInterval = setInterval(() => {
        if (currentWatchPartyRoom) {
            // Request wake lock if available
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }
        }
    }, 30000);
}

function stopWPKeepAwake() {
    if (wpKeepAwakeInterval) {
        clearInterval(wpKeepAwakeInterval);
        wpKeepAwakeInterval = null;
    }
}

function initWPPlayer(videoId, startTime, autoplay) {
    const container = document.getElementById('wp_player');
    container.innerHTML = '';
    
    // YouTube player
    const iframe = document.createElement('iframe');
    iframe.id = 'wp_yt_player';
    iframe.width = '100%';
    iframe.height = '100%';
    iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&start=${Math.floor(startTime || 0)}&autoplay=${autoplay ? 1 : 0}`;
    iframe.frameBorder = '0';
    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
    iframe.allowFullscreen = true;
    container.appendChild(iframe);
    
    document.getElementById('wp_play_btn').textContent = autoplay ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
}

function wpTogglePlay() {
    if (!currentWatchPartyRoom) return;
    
    // Only host can control playback
    if (CURRENT_USER !== wpCurrentHost) {
        alert('Only the host can control playback. Click Sync to match the host.');
        return;
    }
    
    db.ref('watch_parties/' + currentWatchPartyRoom).once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;
        
        const newState = !room.isPlaying;
        db.ref('watch_parties/' + currentWatchPartyRoom).update({
            isPlaying: newState,
            lastUpdate: Date.now()
        });
        
        document.getElementById('wp_play_btn').textContent = newState ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
    });
}

function wpSeek(value) {
    if (!currentWatchPartyRoom) return;
    // This would require more complex YouTube API integration
    // For now, just update the time in Firebase
}

function wpSyncToHost() {
    if (!currentWatchPartyRoom) return;
    
    db.ref('watch_parties/' + currentWatchPartyRoom).once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;
        
        const videoId = room.videoId || room.mediaSource;
        initWPPlayer(videoId, room.currentTime, room.isPlaying);
    });
}

function startWPSyncListener(roomKey, host) {
    // Listen for host's playback state changes
    db.ref('watch_parties/' + roomKey).on('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;
        
        // Update viewer count
        const viewerCount = room.viewers ? Object.keys(room.viewers).length : 0;
        document.getElementById('wp_viewer_count').textContent = `üë• ${viewerCount} watching`;
        
        // Update play button
        document.getElementById('wp_play_btn').textContent = room.isPlaying ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
    });
}

function updateWPViewerCount(roomKey) {
    db.ref('watch_parties/' + roomKey + '/viewers').on('value', (snapshot) => {
        const viewers = snapshot.val();
        const viewerNames = viewers ? Object.keys(viewers) : [];
        const count = viewerNames.length;
        
        const countEl = document.getElementById('wp_viewer_count');
        if (countEl) countEl.textContent = `üë• ${count} watching`;
        
        // Update viewer list
        const listEl = document.getElementById('wp_viewer_list');
        if (listEl) {
            const isHost = CURRENT_USER === wpCurrentHost;
            listEl.innerHTML = viewerNames.map(name => {
                const viewerIsHost = name === wpCurrentHost;
                const canBan = isHost && !viewerIsHost && name !== CURRENT_USER;
                return `<span style="background:${viewerIsHost ? '#2a2a00' : '#1a0a0a'}; color:${viewerIsHost ? '#ffd700' : '#888'}; padding:2px 6px; border-radius:3px; border:1px solid ${viewerIsHost ? '#5a5a00' : '#300'}; cursor:${canBan ? 'pointer' : 'default'};" ${canBan ? `onclick="wpBanViewer('${escapeHtml(name)}')" title="Click to ban from room"` : ''}>${viewerIsHost ? 'üëë ' : ''}${escapeHtml(name)}${canBan ? ' ‚úï' : ''}</span>`;
            }).join('');
        }
    });
}

// Ban a user from watch party room
function wpBanViewer(username) {
    if (!currentWatchPartyRoom || CURRENT_USER !== wpCurrentHost) {
        alert('Only the host can ban viewers.');
        return;
    }
    
    if (!confirm(`Ban "${username}" from this watch party? They won't be able to rejoin this room.`)) return;
    
    // Add to room's banned list
    db.ref('watch_parties/' + currentWatchPartyRoom + '/banned/' + username).set({
        bannedBy: CURRENT_USER,
        bannedAt: Date.now()
    });
    
    // Remove from viewers
    db.ref('watch_parties/' + currentWatchPartyRoom + '/viewers/' + username).remove();
    
    // Send system message
    db.ref('watch_party_chat/' + currentWatchPartyRoom).push({
        user: 'ü§ñ System',
        text: `${username} was banned from this room by the host.`,
        timestamp: Date.now()
    });
}

function startWPChatListener(roomKey) {
    if (wpChatListener) db.ref('watch_party_chat/' + wpChatListener).off();
    wpChatListener = roomKey;
    
    const messagesEl = document.getElementById('wp_chat_messages');
    
    db.ref('watch_party_chat/' + roomKey).orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
        const msgs = [];
        snapshot.forEach((child) => {
            msgs.push(child.val());
        });
        
        messagesEl.innerHTML = msgs.map(m => 
            `<div style="padding:4px 0; border-bottom:1px solid #200;">
                <span style="color:#d40000; font-weight:bold;">${escapeHtml(m.user)}</span>
                <span style="color:#ddd;">${escapeHtml(m.text)}</span>
            </div>`
        ).join('');
        
        messagesEl.scrollTop = messagesEl.scrollHeight;
    });
}

function sendWPChat() {
    if (!currentWatchPartyRoom || !CURRENT_USER || IS_GUEST) return;
    
    const input = document.getElementById('wp_chat_input');
    const text = sanitizeInput(input.value.trim());
    if (!text) return;
    
    db.ref('watch_party_chat/' + currentWatchPartyRoom).push({
        user: CURRENT_USER,
        text: text,
        timestamp: Date.now()
    });
    
    input.value = '';
}

function leaveWatchPartyRoom() {
    if (currentWatchPartyRoom) {
        // Remove from viewers
        db.ref('watch_parties/' + currentWatchPartyRoom + '/viewers/' + CURRENT_USER).remove();
        
        // Stop keep-awake
        stopWPKeepAwake();
        
        // Check if room is now empty and auto-delete if so
        db.ref('watch_parties/' + currentWatchPartyRoom + '/viewers').once('value', (snapshot) => {
            const viewers = snapshot.val();
            if (!viewers || Object.keys(viewers).length === 0) {
                // Room is empty, delete it
                db.ref('watch_parties/' + currentWatchPartyRoom).remove();
                db.ref('watch_party_chat/' + currentWatchPartyRoom).remove();
            }
        });
        
        // Stop listeners
        if (wpChatListener) {
            db.ref('watch_party_chat/' + wpChatListener).off();
            wpChatListener = null;
        }
        db.ref('watch_parties/' + currentWatchPartyRoom).off();
        
        currentWatchPartyRoom = null;
    }
    
    switchWatchPartyTab('rooms', document.querySelector('#watchparty_window .mgmt-sidebar-item'));
}

function deleteWatchPartyRoom(roomKey) {
    // Check if user is the host
    db.ref('watch_parties/' + roomKey).once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) {
            alert('Room not found.');
            loadWatchPartyRooms();
            return;
        }
        
        if (room.host !== CURRENT_USER) {
            alert('Only the room creator can delete this room.');
            return;
        }
        
        if (!confirm('Delete this watch party?')) return;
        
        db.ref('watch_parties/' + roomKey).remove();
        db.ref('watch_party_chat/' + roomKey).remove();
        
        if (currentWatchPartyRoom === roomKey) {
            leaveWatchPartyRoom();
        } else {
            loadWatchPartyRooms();
        }
    });
}

function wpToggleFullscreen() {
    const container = document.getElementById('wp_player_container');
    const iframe = container.querySelector('iframe');
    
    if (!document.fullscreenElement) {
        // Enter fullscreen
        if (iframe) {
            if (iframe.requestFullscreen) {
                iframe.requestFullscreen();
            } else if (iframe.webkitRequestFullscreen) {
                iframe.webkitRequestFullscreen();
            } else if (iframe.msRequestFullscreen) {
                iframe.msRequestFullscreen();
            }
        } else if (container.requestFullscreen) {
            container.requestFullscreen();
        }
    } else {
        // Exit fullscreen
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
}

function uploadVIPImage() {
    const user = userDatabase[CURRENT_USER]; if (!user || !(user.rank === 'VIP' || user.rank === 'CONTRIB' || user.isAdmin || user.isST)) { alert('VIP+ only.'); return; }
    const file = document.getElementById('vip_image_picker').files[0]; if (!file) { alert('Select image.'); return; }
    document.getElementById('vip_image_result').innerHTML = '<div style="color:#888; font-size:10px;">Uploading...</div>';
    fileToBase64(file, 600).then(dataUri => {
        document.getElementById('vip_image_result').innerHTML = `<div style="background:#0a0000; border:1px solid #ffd700; padding:10px;"><div style="color:#0f0; font-size:10px;">‚úì Uploaded!</div><input type="text" value="${dataUri.substring(0, 80)}..." style="width:100%; font-size:10px; background:#000; border:1px solid #ffd700; color:#ffd700; padding:6px;" readonly><div style="color:#888; font-size:9px; margin-top:4px;">Image stored as base64. Paste URL fields will also accept this.</div></div>`;
        // Copy to clipboard
        navigator.clipboard.writeText(dataUri).catch(() => {});
    }).catch(() => {
        document.getElementById('vip_image_result').innerHTML = '<div style="color:#f00; font-size:10px;">Failed.</div>';
    });
}

// ==================== CLUBS SYSTEM ====================
let userClubs = [];
let ownedClub = null;

function switchClubTab(tab, el) {
    document.querySelectorAll('#clubs_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    ['browse', 'my', 'create', 'invites', 'manage'].forEach(t => {
        const panel = document.getElementById('club_tab_' + t);
        if (panel) panel.style.display = t === tab ? 'block' : 'none';
    });
    if (tab === 'browse') loadAllClubs();
    if (tab === 'my') loadMyClubs();
    if (tab === 'invites') loadClubInvites();
    if (tab === 'create') checkCanCreateClub();
    if (tab === 'manage') loadManageClub();
}

// Club auto-refresh every 30 minutes
let clubRefreshInterval = null;
function startClubAutoRefresh() {
    if (clubRefreshInterval) clearInterval(clubRefreshInterval);
    
    // Refresh clubs every 5 minutes for accurate stats
    clubRefreshInterval = setInterval(() => {
        console.log('Auto-refreshing all club data...');
        loadAllClubs();
        loadMyClubs();
        loadClubInvites();
        loadClubsLeaderboard();
        // Refresh owned club data
        if (ownedClub) {
            db.ref('clubs/' + ownedClub.id).once('value', (s) => {
                if (s.exists()) {
                    ownedClub = { id: s.key, ...s.val() };
                }
            });
        }
    }, 5 * 60 * 1000); // 5 minutes
}

// Function to refresh all club data on demand
function refreshAllClubData() {
    console.log('Manual club data refresh...');
    loadAllClubs();
    loadMyClubs();
    loadClubInvites();
    loadClubsLeaderboard();
    if (ownedClub) {
        ownedClub = null;
        loadManageClub();
    }
}

function loadAllClubs() {
    const container = document.getElementById('clubs_list');
    if (!container) { console.error('clubs_list container not found'); return; }
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading clubs...</div>';
    
    // Use get() method for more reliable fetching
    db.ref('clubs').get().then((snapshot) => {
        console.log('Clubs snapshot exists:', snapshot.exists());
        
        if (!snapshot.exists()) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No clubs yet. Be the first to create one!</div>';
            return;
        }
        
        const clubs = [];
        snapshot.forEach((childSnapshot) => {
            const clubData = childSnapshot.val();
            clubs.push({ 
                id: childSnapshot.key, 
                ...clubData 
            });
        });
        
        // Update cache
        clubsCache = snapshot.val() || {};
        
        console.log('Loaded clubs count:', clubs.length, clubs);
        
        if (clubs.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No clubs yet. Be the first to create one!</div>';
            return;
        }
        
        // Sort by created date (newest first)
        clubs.sort((a, b) => (b.created || 0) - (a.created || 0));
        
        let html = '';
        clubs.forEach(club => {
            const isMember = club.members && Array.isArray(club.members) && club.members.includes(CURRENT_USER);
            const isOwner = club.owner === CURRENT_USER;
            const memberCount = (Array.isArray(club.members) ? club.members.length : 0) + 1;
            const clubColor = club.color || '#d40000';
            const clubName = club.name || 'Unnamed Club';
            const clubDesc = club.description || '';
            const clubOwner = club.owner || 'Unknown';
            
            html += `<div class="club-card" style="border-color:${clubColor}; margin-bottom:10px; padding:12px; background:#0a0000; border:1px solid ${clubColor}; border-radius:4px;">
                <div class="club-name" style="color:${clubColor}; font-weight:bold; font-size:14px;">${escapeHtml(clubName)}</div>
                <div style="color:#888; font-size:11px; margin:5px 0;">${escapeHtml(clubDesc)}</div>
                <div class="club-members" style="color:#666; font-size:10px;">üë• ${memberCount} members ‚Ä¢ Owner: ${escapeHtml(clubOwner)}</div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0; background:#222;" onclick="viewClubMembers('${club.id}', '${escapeHtml(clubName).replace(/'/g, "\\'")}', '${escapeHtml(clubOwner).replace(/'/g, "\\'")}')">üë• View</button>
                    ${isOwner ? '<span style="color:#ffd700; font-size:10px;">üëë Owner</span>' : 
                      isMember ? '<span style="color:#0f0; font-size:10px;">‚úì Member</span>' : 
                      `<button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0;" onclick="requestJoinClub('${club.id}')">Join</button>`}
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    }).catch(err => {
        console.error('Error loading clubs:', err);
        container.innerHTML = '<div style="color:#f00; text-align:center; padding:20px;">Error loading clubs: ' + err.message + '</div>';
    });
}

function viewClubMembers(clubId, clubName, owner) {
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) { alert('Club not found.'); return; }
        const club = s.val();
        const members = club.members || [];
        let memberList = 'üëë ' + owner + ' (Owner)\n';
        members.forEach(m => { memberList += '‚Ä¢ ' + m + '\n'; });
        alert('Members of ' + clubName + ':\n\n' + memberList);
    });
}

function searchClubs() {
    const query = document.getElementById('club_search').value.toLowerCase();
    const cards = document.querySelectorAll('#clubs_list .club-card');
    cards.forEach(card => {
        const name = card.querySelector('.club-name').textContent.toLowerCase();
        card.style.display = name.includes(query) ? 'block' : 'none';
    });
}

function loadMyClubs() {
    const container = document.getElementById('my_clubs_list');
    if (!container) return;
    db.ref('clubs').once('value', (s) => {
        const myClubs = [];
        s.forEach(c => {
            const club = { id: c.key, ...c.val() };
            if (club.owner === CURRENT_USER || (club.members && club.members.includes(CURRENT_USER))) {
                myClubs.push(club);
            }
        });
        userClubs = myClubs;
        if (myClubs.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">You haven\'t joined any clubs yet.</div>';
            return;
        }
        container.innerHTML = myClubs.map(club => {
            const isOwner = club.owner === CURRENT_USER;
            return `<div class="club-card" style="border-color:${club.color || '#400'};">
                <div class="club-name" style="color:${club.color || '#d40000'};">${escapeHtml(club.name)} ${isOwner ? 'üëë' : ''}</div>
                <div class="club-members">üë• ${(club.members || []).length + 1} members</div>
                ${!isOwner ? `<button class="ie-btn" style="width:auto; padding:5px 10px; margin-top:8px; font-size:10px; background:#333;" onclick="leaveClub('${club.id}')">Leave Club</button>` : ''}
            </div>`;
        }).join('');
    });
}

function checkCanCreateClub() {
    db.ref('clubs').orderByChild('owner').equalTo(CURRENT_USER).once('value', (s) => {
        if (s.exists()) {
            document.getElementById('create_club_form').style.display = 'none';
            document.getElementById('already_owns_club').style.display = 'block';
            document.getElementById('club_manage_tab').style.display = 'block';
            s.forEach(c => { ownedClub = { id: c.key, ...c.val() }; });
        } else {
            document.getElementById('create_club_form').style.display = 'block';
            document.getElementById('already_owns_club').style.display = 'none';
            document.getElementById('club_manage_tab').style.display = 'none';
            ownedClub = null;
        }
    });
}

function createClub() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in!'); return; }
    const name = sanitizeInput(document.getElementById('new_club_name').value.trim());
    const desc = sanitizeProfileField(document.getElementById('new_club_desc').value.trim(), 200);
    const rawColor = document.getElementById('new_club_color').value.trim() || '#d40000';
    // Validate color is a valid hex color
    const color = /^#[0-9A-Fa-f]{6}$/.test(rawColor) ? rawColor : '#d40000';
    const resultEl = document.getElementById('create_club_result');
    if (!name) { resultEl.innerHTML = '<span style="color:#f00;">Enter a club name.</span>'; return; }
    if (name.length < 3 || name.length > 30) { resultEl.innerHTML = '<span style="color:#f00;">Name must be 3-30 characters.</span>'; return; }
    
    db.ref('clubs').orderByChild('owner').equalTo(CURRENT_USER).once('value', (s) => {
        if (s.exists()) { resultEl.innerHTML = '<span style="color:#f00;">You already own a club!</span>'; return; }
        const clubId = 'club_' + Date.now();
        db.ref('clubs/' + clubId).set({
            name: name,
            description: desc,
            color: color,
            owner: CURRENT_USER,
            members: [],
            created: Date.now()
        }, (err) => {
            if (err) { resultEl.innerHTML = '<span style="color:#f00;">Failed to create club.</span>'; }
            else {
                resultEl.innerHTML = '<span style="color:#0f0;">‚úì Club created!</span>';
                document.getElementById('new_club_name').value = '';
                document.getElementById('new_club_desc').value = '';
                checkCanCreateClub();
                loadAllClubs(); // Refresh browse clubs
                loadMyClubs(); // Refresh my clubs
            }
        });
    });
}

function loadClubInvites() {
    const container = document.getElementById('club_invites_list');
    if (!container) return;
    db.ref('club_invites/' + CURRENT_USER).once('value', (s) => {
        const invites = [];
        s.forEach(c => invites.push({ id: c.key, ...c.val() }));
        if (invites.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No pending invites.</div>';
            return;
        }
        container.innerHTML = invites.map(inv => `
            <div class="club-card">
                <div class="club-name">${escapeHtml(inv.clubName)}</div>
                <div style="color:#888; font-size:10px;">Invited by ${escapeHtml(inv.invitedBy)}</div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="ie-btn" style="flex:1; padding:5px; font-size:10px;" onclick="acceptClubInvite('${inv.id}', '${inv.clubId}')">Accept</button>
                    <button class="ie-btn" style="flex:1; padding:5px; font-size:10px; background:#333;" onclick="declineClubInvite('${inv.id}')">Decline</button>
                </div>
            </div>
        `).join('');
    });
}

function acceptClubInvite(inviteId, clubId) {
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) { alert('Club no longer exists.'); return; }
        const club = s.val();
        const members = club.members || [];
        if (userClubs.length >= 5) { alert('You can only join up to 5 clubs!'); return; }
        if (!members.includes(CURRENT_USER)) {
            members.push(CURRENT_USER);
            db.ref('clubs/' + clubId + '/members').set(members);
        }
        db.ref('club_invites/' + CURRENT_USER + '/' + inviteId).remove();
        loadClubInvites();
        alert('You joined the club!');
    });
}

function declineClubInvite(inviteId) {
    db.ref('club_invites/' + CURRENT_USER + '/' + inviteId).remove();
    loadClubInvites();
}

function requestJoinClub(clubId) {
    if (userClubs.length >= 5) { alert('You can only join up to 5 clubs!'); return; }
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) return;
        const club = s.val();
        db.ref('club_requests/' + clubId + '/' + CURRENT_USER).set({
            username: CURRENT_USER,
            timestamp: Date.now()
        });
        alert('Request sent to club owner!');
    });
}

function leaveClub(clubId) {
    if (!confirm('Leave this club?')) return;
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) return;
        const club = s.val();
        const members = (club.members || []).filter(m => m !== CURRENT_USER);
        db.ref('clubs/' + clubId + '/members').set(members);
        loadMyClubs();
    });
}

function loadManageClub() {
    const container = document.getElementById('manage_club_content');
    if (!container) return;
    
    // If ownedClub not loaded yet, fetch it first
    if (!ownedClub) {
        container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading your club...</div>';
        db.ref('clubs').orderByChild('owner').equalTo(CURRENT_USER).once('value', (s) => {
            if (s.exists()) {
                s.forEach(c => { ownedClub = { id: c.key, ...c.val() }; });
                document.getElementById('club_manage_tab').style.display = 'block';
                renderManageClub(container);
            } else {
                container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">You don\'t own a club yet.<br><br><button class="ie-btn" onclick="switchClubTab(\'create\', document.querySelector(\'#clubs_window .mgmt-sidebar-item\'))">Create a Club</button></div>';
                document.getElementById('club_manage_tab').style.display = 'none';
            }
        }).catch(err => {
            container.innerHTML = '<div style="color:#f00; text-align:center; padding:20px;">Error loading club: ' + err.message + '</div>';
        });
        return;
    }
    
    renderManageClub(container);
}

function renderManageClub(container) {
    if (!ownedClub) return;
    
    db.ref('club_requests/' + ownedClub.id).once('value', (reqSnap) => {
        const requests = [];
        reqSnap.forEach(r => requests.push({ id: r.key, ...r.val() }));
        
        let html = `<div class="admin-section">
            <h4 style="color:#d40000;">Club: ${escapeHtml(ownedClub.name)}</h4>
            <p style="color:#888; font-size:10px;">Members: ${(ownedClub.members || []).length + 1}</p>
            <button class="ie-btn" style="width:auto; padding:3px 10px; font-size:9px;" onclick="refreshOwnedClub()">üîÑ Refresh</button>
        </div>`;
        
        html += `<div class="admin-section">
            <h4>Invite Member</h4>
            <input type="text" id="invite_member_name" class="ie-input" placeholder="Username to invite">
            <button class="ie-btn" onclick="inviteToClub()">Send Invite</button>
            <div id="invite_result" style="margin-top:5px; font-size:10px;"></div>
        </div>`;
        
        if (requests.length > 0) {
            html += `<div class="admin-section">
                <h4>Join Requests (${requests.length})</h4>
                ${requests.map(r => `
                    <div class="friend-item">
                        <span style="color:#d40000;">${escapeHtml(r.username)}</span>
                        <div class="friend-actions">
                            <button class="ie-btn" style="width:auto; padding:3px 8px; font-size:9px;" onclick="approveJoinRequest('${r.id}')">‚úì</button>
                            <button class="ie-btn" style="width:auto; padding:3px 8px; font-size:9px; background:#333;" onclick="denyJoinRequest('${r.id}')">‚úó</button>
                        </div>
                    </div>
                `).join('')}
            </div>`;
        }
        
        html += `<div class="admin-section">
            <h4>Members</h4>
            <div style="color:#ffd700; font-size:11px; margin-bottom:5px;">üëë ${escapeHtml(ownedClub.owner)} (Owner)</div>
            ${(ownedClub.members || []).map(m => `
                <div class="friend-item">
                    <span style="color:#888;">${escapeHtml(m)}</span>
                    <button class="ie-btn" style="width:auto; padding:3px 8px; font-size:9px; background:#500;" onclick="kickFromClub('${m}')">Kick</button>
                </div>
            `).join('') || '<div style="color:#666; font-size:10px;">No members yet.</div>'}
        </div>`;
        
        html += `<button class="ie-btn" style="background:#500; margin-top:10px;" onclick="deleteClub()">üóëÔ∏è Delete Club</button>`;
        
        container.innerHTML = html;
    }).catch(err => {
        container.innerHTML = '<div style="color:#f00; text-align:center; padding:20px;">Error: ' + err.message + '</div>';
    });
}

function refreshOwnedClub() {
    ownedClub = null;
    loadManageClub();
}

function inviteToClub() {
    const username = document.getElementById('invite_member_name').value.trim();
    const resultEl = document.getElementById('invite_result');
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (username === CURRENT_USER) { resultEl.innerHTML = '<span style="color:#f00;">You can\'t invite yourself.</span>'; return; }
    
    db.ref('club_invites/' + username).push({
        clubId: ownedClub.id,
        clubName: ownedClub.name,
        invitedBy: CURRENT_USER,
        timestamp: Date.now()
    });
    resultEl.innerHTML = '<span style="color:#0f0;">‚úì Invite sent!</span>';
    document.getElementById('invite_member_name').value = '';
}

function approveJoinRequest(username) {
    if (!ownedClub) return;
    db.ref('clubs/' + ownedClub.id).once('value', (s) => {
        const club = s.val();
        const members = club.members || [];
        if (!members.includes(username)) {
            members.push(username);
            db.ref('clubs/' + ownedClub.id + '/members').set(members);
        }
        db.ref('club_requests/' + ownedClub.id + '/' + username).remove();
        ownedClub.members = members;
        loadManageClub();
    });
}

function denyJoinRequest(username) {
    if (!ownedClub) return;
    db.ref('club_requests/' + ownedClub.id + '/' + username).remove();
    loadManageClub();
}

function kickFromClub(username) {
    if (!ownedClub || !confirm('Kick ' + username + ' from the club?')) return;
    const members = (ownedClub.members || []).filter(m => m !== username);
    db.ref('clubs/' + ownedClub.id + '/members').set(members);
    ownedClub.members = members;
    loadManageClub();
}

function deleteClub() {
    if (!ownedClub || !confirm('DELETE your club? This cannot be undone!')) return;
    db.ref('clubs/' + ownedClub.id).remove();
    db.ref('club_requests/' + ownedClub.id).remove();
    ownedClub = null;
    document.getElementById('club_manage_tab').style.display = 'none';
    switchClubTab('browse', document.querySelector('#clubs_window .mgmt-sidebar-item'));
    alert('Club deleted.');
}

function getUserClubs(username) {
    return new Promise((resolve) => {
        db.ref('clubs').once('value', (s) => {
            const clubs = [];
            s.forEach(c => {
                const club = { id: c.key, ...c.val() };
                if (club.owner === username || (club.members && club.members.includes(username))) {
                    clubs.push(club);
                }
            });
            resolve(clubs);
        });
    });
}

// ==================== FRIENDS & MESSAGING SYSTEM ====================
let currentDMUser = null;
let currentGroupId = null;
let dmListener = null;
let groupListener = null;

function switchMsgTab(tab, el) {
    document.querySelectorAll('#messages_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    ['dms', 'groups', 'friends', 'requests'].forEach(t => {
        const panel = document.getElementById('msg_tab_' + t);
        if (panel) {
            if (t === tab) {
                panel.style.display = 'flex';
            } else {
                panel.style.display = 'none';
            }
        }
    });
    if (tab === 'dms') loadDMList();
    if (tab === 'groups') loadGroupList();
    if (tab === 'friends') loadFriendsList();
    if (tab === 'requests') loadFriendRequests();
}

function loadFriendsList() {
    const container = document.getElementById('friends_list');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading friends...</div>';
    
    db.ref('friends/' + CURRENT_USER).once('value', (s) => {
        const friends = s.val() || {};
        const friendList = Object.keys(friends);
        if (friendList.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:40px;">No friends yet.<br><span style="font-size:11px;">Add someone using the form below!</span></div>';
            return;
        }
        container.innerHTML = friendList.map(f => `
            <div style="display:flex; align-items:center; gap:12px; padding:12px 15px; background:#0a0000; border-bottom:1px solid #300;">
                <div style="width:36px; height:36px; border-radius:50%; background:#111; border:2px solid #500; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0;">ü¶á</div>
                <span style="color:#d40000; font-weight:bold; font-size:13px; flex:1;">${escapeHtml(f)}</span>
                <div style="display:flex; gap:8px;">
                    <button class="ie-btn" style="width:auto; padding:6px 12px; font-size:10px; margin:0;" onclick="startDM('${f}')">üí¨ DM</button>
                    <button class="ie-btn" style="width:auto; padding:6px 12px; font-size:10px; margin:0; background:#500;" onclick="removeFriend('${f}')">‚úó</button>
                </div>
            </div>
        `).join('');
    });
}

function sendFriendRequest() {
    const username = document.getElementById('add_friend_input').value.trim();
    if (!username) { alert('Enter a username.'); return; }
    if (!userDatabase[username]) { alert('User not found.'); return; }
    if (username === CURRENT_USER) { alert('You can\'t add yourself.'); return; }
    
    db.ref('friends/' + CURRENT_USER + '/' + username).once('value', (s) => {
        if (s.exists()) { alert('Already friends!'); return; }
        db.ref('friend_requests/' + username + '/' + CURRENT_USER).set({
            from: CURRENT_USER,
            timestamp: Date.now()
        });
        alert('Friend request sent!');
        document.getElementById('add_friend_input').value = '';
    });
}

function loadFriendRequests() {
    const container = document.getElementById('friend_requests_list');
    if (!container) return;
    db.ref('friend_requests/' + CURRENT_USER).once('value', (s) => {
        const requests = [];
        s.forEach(r => requests.push({ id: r.key, ...r.val() }));
        
        const countEl = document.getElementById('friend_req_count');
        if (countEl) countEl.textContent = requests.length > 0 ? `(${requests.length})` : '';
        
        if (requests.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:25px; background:#050000; border:1px dashed #300; border-radius:6px;">No pending friend requests.</div>';
            return;
        }
        container.innerHTML = requests.map(r => `
            <div style="display:flex; align-items:center; gap:12px; padding:12px 15px; background:#0a0000; border:1px solid #400; margin-bottom:8px; border-radius:6px;">
                <div style="width:40px; height:40px; border-radius:50%; background:#111; border:2px solid #ffd700; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;">ü¶á</div>
                <div style="flex:1;">
                    <span style="color:#d40000; font-weight:bold; font-size:13px;">${escapeHtml(r.from)}</span>
                    <div style="color:#666; font-size:10px;">wants to be friends</div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="ie-btn" style="width:auto; padding:6px 15px; font-size:10px; margin:0; background:#040;" onclick="acceptFriend('${r.from}')">‚úì Accept</button>
                    <button class="ie-btn" style="width:auto; padding:6px 15px; font-size:10px; margin:0; background:#400;" onclick="declineFriend('${r.from}')">‚úó Decline</button>
                </div>
            </div>
        `).join('');
    });
}

function acceptFriend(username) {
    db.ref('friends/' + CURRENT_USER + '/' + username).set(true);
    db.ref('friends/' + username + '/' + CURRENT_USER).set(true);
    db.ref('friend_requests/' + CURRENT_USER + '/' + username).remove();
    loadFriendRequests();
    loadFriendsList();
}

function declineFriend(username) {
    db.ref('friend_requests/' + CURRENT_USER + '/' + username).remove();
    loadFriendRequests();
}

function removeFriend(username) {
    if (!confirm('Remove ' + username + ' from friends?')) return;
    db.ref('friends/' + CURRENT_USER + '/' + username).remove();
    db.ref('friends/' + username + '/' + CURRENT_USER).remove();
    loadFriendsList();
}

function loadDMList() {
    const container = document.getElementById('dm_conversations');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading conversations...</div>';
    
    db.ref('dms').orderByChild('participants/' + CURRENT_USER).equalTo(true).once('value', (s) => {
        const convos = [];
        s.forEach(c => convos.push({ id: c.key, ...c.val() }));
        
        console.log('Loaded DM conversations:', convos.length);
        
        if (convos.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No conversations yet.<br><span style="font-size:11px;">Message a friend to start chatting!</span></div>';
            return;
        }
        
        // Build HTML and then fetch avatars
        let html = '';
        const usernames = [];
        convos.forEach(c => {
            const otherUser = Object.keys(c.participants || {}).find(p => p !== CURRENT_USER) || 'Unknown';
            usernames.push(otherUser);
            html += `<div class="dm-item" onclick="openDM('${c.id}', '${otherUser}')" style="cursor:pointer;">
                <div class="dm-avatar" id="dm_avatar_${otherUser}">ü¶á</div>
                <div class="dm-preview">
                    <div class="dm-name">${escapeHtml(otherUser)}</div>
                    <div class="dm-last">${escapeHtml(c.lastMessage || 'No messages yet')}</div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
        
        // Fetch avatars for each user
        usernames.forEach(username => {
            db.ref('profiles/' + username + '/avatar').once('value', (avatarSnap) => {
                const avatarEl = document.getElementById('dm_avatar_' + username);
                if (avatarEl && avatarSnap.val()) {
                    avatarEl.innerHTML = `<img src="${escapeHtml(avatarSnap.val())}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" onerror="this.parentElement.innerHTML='ü¶á'">`;
                }
            });
        });
    }).catch(err => {
        console.error('Error loading DMs:', err);
        container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No conversations yet.</div>';
    });
}

function startDM(username) {
    db.ref('friends/' + CURRENT_USER + '/' + username).once('value', (s) => {
        if (!s.exists()) { alert('You must be friends to DM!'); return; }
        const convoId = [CURRENT_USER, username].sort().join('_');
        db.ref('dms/' + convoId).once('value', (cs) => {
            if (!cs.exists()) {
                const participants = {};
                participants[CURRENT_USER] = true;
                participants[username] = true;
                db.ref('dms/' + convoId).set({ participants: participants, created: Date.now() });
            }
            // Open messages window if not already open
            const msgWin = document.getElementById('messages_window');
            if (msgWin.style.display !== 'block') {
                msgWin.style.display = 'block';
                document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10");
                msgWin.style.zIndex = "200";
            }
            // Switch to DMs tab
            document.querySelectorAll('#messages_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
            document.querySelector('#messages_window .mgmt-sidebar-item').classList.add('active');
            ['dms', 'groups', 'friends', 'requests'].forEach(t => {
                const panel = document.getElementById('msg_tab_' + t);
                if (panel) panel.style.display = t === 'dms' ? 'flex' : 'none';
            });
            openDM(convoId, username);
        });
    });
}

function openDM(convoId, username) {
    currentDMUser = username;
    document.getElementById('dm_list_view').style.display = 'none';
    document.getElementById('dm_chat_view').style.display = 'flex';
    document.getElementById('dm_chat_name').textContent = username;
    
    // Load profile picture for chat header
    const avatarEl = document.getElementById('dm_chat_avatar');
    if (avatarEl) {
        avatarEl.innerHTML = 'ü¶á';
        db.ref('profiles/' + username + '/avatar').once('value', (s) => {
            if (s.val()) {
                avatarEl.innerHTML = `<img src="${escapeHtml(s.val())}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" onerror="this.innerHTML='ü¶á'">`;
            }
        });
    }
    
    if (dmListener) db.ref('dms/' + dmListener).off();
    dmListener = convoId;
    
    db.ref('dms/' + convoId + '/messages').orderByChild('timestamp').on('value', (s) => {
        const msgs = [];
        s.forEach(m => msgs.push(m.val()));
        const container = document.getElementById('dm_messages');
        container.innerHTML = msgs.map(m => `
            <div class="msg-bubble ${m.sender === CURRENT_USER ? 'sent' : 'received'}">
                ${m.sender !== CURRENT_USER ? `<div style="font-size:9px; color:#888; margin-bottom:3px;">${escapeHtml(m.sender)}</div>` : ''}
                ${renderMessageContent(m.text, m.media)}
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
    });
}

function closeDMChat() {
    if (dmListener) { db.ref('dms/' + dmListener + '/messages').off(); dmListener = null; }
    currentDMUser = null;
    document.getElementById('dm_chat_view').style.display = 'none';
    document.getElementById('dm_list_view').style.display = 'block';
    document.getElementById('dm_media_preview').style.display = 'none';
    loadDMList();
}

// Helper to render message content with media support
function renderMessageContent(text, mediaUrl) {
    let content = '';
    
    // Check if text itself is a media URL
    const combinedUrl = mediaUrl || text;
    if (combinedUrl && isMediaUrl(combinedUrl)) {
        content += renderMedia(combinedUrl);
        if (mediaUrl && text && text !== mediaUrl) {
            content += `<div style="margin-top:5px;">${escapeHtml(text)}</div>`;
        }
    } else if (text) {
        // Check for URLs in text and render them
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const parts = text.split(urlRegex);
        parts.forEach(part => {
            if (urlRegex.test(part)) {
                urlRegex.lastIndex = 0; // Reset regex
                if (isMediaUrl(part)) {
                    content += renderMedia(part);
                } else {
                    content += `<a href="${escapeHtml(part)}" target="_blank" style="color:#ff6666;">${escapeHtml(part)}</a>`;
                }
            } else {
                content += escapeHtml(part);
            }
        });
    }
    
    return content || escapeHtml(text || '');
}

function isMediaUrl(url) {
    if (!url) return false;
    const lower = url.toLowerCase();
    return lower.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|mov)(\?|$)/i) ||
           lower.includes('tenor.com') ||
           lower.includes('giphy.com') ||
           lower.includes('imgur.com');
}

function renderMedia(url) {
    const lower = url.toLowerCase();
    if (lower.match(/\.(mp4|webm|mov)(\?|$)/i)) {
        return `<video src="${escapeHtml(url)}" controls style="max-width:200px; max-height:200px; border-radius:4px; margin:5px 0;" onerror="this.outerHTML='<span style=color:#888>[Video failed to load]</span>'"></video>`;
    } else {
        return `<img src="${escapeHtml(url)}" style="max-width:200px; max-height:200px; border-radius:4px; margin:5px 0; cursor:pointer;" onclick="window.open('${escapeHtml(url)}', '_blank')" onerror="this.outerHTML='<span style=color:#888>[Image failed to load]</span>'">`;
    }
}

function showDMMediaInput() {
    const preview = document.getElementById('dm_media_preview');
    preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
}

function showGroupMediaInput() {
    const preview = document.getElementById('group_media_preview');
    preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
}

function sendDM() {
    const input = document.getElementById('dm_input');
    const mediaInput = document.getElementById('dm_media_url');
    const text = sanitizeProfileField(input.value.trim(), 1000);
    const mediaUrl = sanitizeUrl(mediaInput ? mediaInput.value.trim() : '');
    
    if ((!text && !mediaUrl) || !dmListener) return;
    
    const message = {
        sender: CURRENT_USER,
        text: text || '',
        timestamp: Date.now()
    };
    
    if (mediaUrl) {
        message.media = mediaUrl;
    }
    
    db.ref('dms/' + dmListener + '/messages').push(message);
    db.ref('dms/' + dmListener + '/lastMessage').set(mediaUrl ? (text || 'üì∑ Media') : text);
    input.value = '';
    if (mediaInput) mediaInput.value = '';
    document.getElementById('dm_media_preview').style.display = 'none';
}

function loadGroupList() {
    const container = document.getElementById('group_conversations');
    if (!container) return;
    document.getElementById('group_list_view').style.display = 'block';
    document.getElementById('group_chat_view').style.display = 'none';
    document.getElementById('create_group_view').style.display = 'none';
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading groups...</div>';
    
    db.ref('groupchats').orderByChild('members/' + CURRENT_USER).equalTo(true).once('value', (s) => {
        const groups = [];
        s.forEach(g => groups.push({ id: g.key, ...g.val() }));
        
        console.log('Loaded group chats:', groups.length);
        
        if (groups.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No group chats yet.<br><span style="font-size:11px;">Create one using the button above!</span></div>';
            return;
        }
        container.innerHTML = groups.map(g => `
            <div class="dm-item" onclick="openGroupChat('${g.id}')" style="cursor:pointer;">
                <div class="dm-avatar">üë•</div>
                <div class="dm-preview">
                    <div class="dm-name">${escapeHtml(g.name)}</div>
                    <div class="dm-last">${Object.keys(g.members || {}).length} members</div>
                </div>
            </div>
        `).join('');
    }).catch(err => {
        console.error('Error loading groups:', err);
        container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No group chats yet.</div>';
    });
}

function showCreateGroup() {
    document.getElementById('group_list_view').style.display = 'none';
    document.getElementById('create_group_view').style.display = 'block';
    
    db.ref('friends/' + CURRENT_USER).once('value', (s) => {
        const friends = Object.keys(s.val() || {});
        const container = document.getElementById('group_friend_select');
        if (friends.length === 0) {
            container.innerHTML = '<div style="color:#666;">You need friends to create a group chat!</div>';
            return;
        }
        container.innerHTML = friends.map(f => `
            <div class="group-friend-row" onclick="toggleGroupFriend(this, '${f}')" style="display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer; background:#0a0000; border:1px solid #300; margin-bottom:5px; border-radius:3px; transition:all 0.2s;">
                <input type="checkbox" value="${f}" class="group-friend-check" style="width:18px; height:18px; cursor:pointer; pointer-events:none;">
                <span style="color:#d40000; flex:1; font-size:13px;">${escapeHtml(f)}</span>
                <span class="check-indicator" style="color:#0f0; display:none;">‚úì</span>
            </div>
        `).join('');
    });
}

function toggleGroupFriend(row, username) {
    const checkbox = row.querySelector('input[type="checkbox"]');
    const indicator = row.querySelector('.check-indicator');
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        row.style.background = '#1a0a1a';
        row.style.borderColor = '#6a03b4';
        if (indicator) indicator.style.display = 'block';
    } else {
        row.style.background = '#0a0000';
        row.style.borderColor = '#300';
        if (indicator) indicator.style.display = 'none';
    }
}

function cancelCreateGroup() {
    document.getElementById('create_group_view').style.display = 'none';
    document.getElementById('group_list_view').style.display = 'block';
}

function createGroupChat() {
    const name = document.getElementById('new_group_name').value.trim();
    if (!name) { alert('Enter a group name.'); return; }
    
    const selected = Array.from(document.querySelectorAll('.group-friend-check:checked')).map(c => c.value);
    if (selected.length === 0) { alert('Select at least one friend.'); return; }
    
    const members = {};
    members[CURRENT_USER] = true;
    selected.forEach(u => { members[u] = true; });
    
    const groupId = 'group_' + Date.now();
    db.ref('groupchats/' + groupId).set({
        name: name,
        members: members,
        owner: CURRENT_USER,
        created: Date.now()
    });
    
    document.getElementById('new_group_name').value = '';
    cancelCreateGroup();
    loadGroupList();
}

function openGroupChat(groupId) {
    currentGroupId = groupId;
    document.getElementById('group_list_view').style.display = 'none';
    document.getElementById('group_chat_view').style.display = 'flex';
    
    db.ref('groupchats/' + groupId + '/name').once('value', (s) => {
        document.getElementById('group_chat_name').textContent = s.val() || 'Group';
    });
    
    if (groupListener) db.ref('groupchats/' + groupListener + '/messages').off();
    groupListener = groupId;
    
    db.ref('groupchats/' + groupId + '/messages').orderByChild('timestamp').on('value', (s) => {
        const msgs = [];
        s.forEach(m => msgs.push(m.val()));
        const container = document.getElementById('group_messages');
        container.innerHTML = msgs.map(m => `
            <div class="msg-bubble ${m.sender === CURRENT_USER ? 'sent' : 'received'}">
                ${m.sender !== CURRENT_USER ? `<div style="font-size:9px; color:#888; margin-bottom:3px;">${escapeHtml(m.sender)}</div>` : ''}
                ${renderMessageContent(m.text, m.media)}
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
    });
}

function closeGroupChat() {
    if (groupListener) { db.ref('groupchats/' + groupListener + '/messages').off(); groupListener = null; }
    currentGroupId = null;
    document.getElementById('group_chat_view').style.display = 'none';
    document.getElementById('group_media_preview').style.display = 'none';
    loadGroupList();
}

function sendGroupMsg() {
    const input = document.getElementById('group_input');
    const mediaInput = document.getElementById('group_media_url');
    const text = input.value.trim();
    const mediaUrl = mediaInput ? mediaInput.value.trim() : '';
    
    if ((!text && !mediaUrl) || !currentGroupId) return;
    
    const message = {
        sender: CURRENT_USER,
        text: text || (mediaUrl ? '' : ''),
        timestamp: Date.now()
    };
    
    if (mediaUrl) {
        message.media = mediaUrl;
    }
    
    db.ref('groupchats/' + currentGroupId + '/messages').push(message);
    input.value = '';
    if (mediaInput) mediaInput.value = '';
    document.getElementById('group_media_preview').style.display = 'none';
}

function showGroupMembers() {
    if (!currentGroupId) return;
    db.ref('groupchats/' + currentGroupId).once('value', (s) => {
        const group = s.val();
        const members = Object.keys(group.members || {});
        alert('Group Members:\n' + members.join('\n'));
    });
}

function startDMFromProfile() {
    if (!currentProfileUser || !CURRENT_USER || IS_GUEST) { alert('Please log in!'); return; }
    if (currentProfileUser === CURRENT_USER) { alert('You can\'t message yourself!'); return; }
    startDM(currentProfileUser);
    toggleWin('messages_window');
}

// MEMORIES
function prevPage() { if (currentPage > 1) { currentPage--; renderMemories(); } }
function nextPage() { db.ref('archive').once('value', (s) => { let count = 0; s.forEach(() => count++); const totalPages = Math.ceil(count / itemsPerPage) || 1; if (currentPage < totalPages) { currentPage++; renderMemories(); } }); }
function renderMemories() {
    const grid = document.getElementById('memories_grid'); if (!grid) return;
    grid.innerHTML = ""; grid.style.display = 'grid'; grid.style.gridTemplateColumns = 'repeat(3, 1fr)'; grid.style.gap = '20px'; grid.style.justifyItems = 'center';
    db.ref('archive').orderByChild('timestamp').once('value', (s) => {
        const archive = []; s.forEach((c) => archive.push(c.val()));
        const totalPages = Math.ceil(archive.length / itemsPerPage) || 1;
        document.getElementById('page_indicator').textContent = 'Page ' + currentPage + ' of ' + totalPages;
        if (archive.length === 0) { grid.innerHTML = '<p style="color: #555; text-align: center; grid-column: 1/-1; padding: 40px;">No memories yet...</p>'; return; }
        const start = (currentPage - 1) * itemsPerPage;
        archive.slice(start, start + itemsPerPage).forEach(mem => {
            const div = document.createElement('div');
            div.style.cssText = 'width:120px; text-align:center; cursor:pointer; padding:10px; border-radius:5px; transition:all 0.2s;';
            div.onmouseover = function() { this.style.background = 'rgba(139,0,0,0.2)'; };
            div.onmouseout = function() { this.style.background = 'transparent'; };
            div.onclick = function() { spawnVideoWindow(mem.name, mem.url); };
            div.innerHTML = `<div style="width:60px; height:60px; margin:0 auto 8px; background:#200000; border:2px solid #500; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:28px;">üé¨</div><div style="font-size:11px; color:#d40000; font-weight:bold; word-break:break-word;">${escapeHtml(mem.name)}</div><div style="font-size:9px; color:#666; margin-top:2px;">${escapeHtml(mem.uploader || 'Unknown')}</div>`;
            grid.appendChild(div);
        });
    });
}
function spawnVideoWindow(name, url) {
    const id = 'v_' + Date.now();
    const win = document.createElement('div');
    win.className = 'window'; win.id = id; win.style.display = 'block';
    win.style.left = (150 + Math.random() * 100) + 'px'; win.style.top = (100 + Math.random() * 50) + 'px'; win.style.width = '520px'; win.style.height = '420px'; win.style.zIndex = '500';
    const isAudio = url.match(/\.(mp3|wav|ogg|m4a)(\?|$)/i);
    let mediaHtml = isAudio ? `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; background:#050000;"><div style="font-size:60px; margin-bottom:20px;">üéµ</div><audio src="${url}" controls autoplay style="width:90%;"></audio></div>` : `<video src="${url}" controls autoplay style="width:100%; height:100%; background:#000;"></video>`;
    win.innerHTML = `<div class="title-bar"><div class="title-bar-text">‚ñ∂ ${escapeHtml(name)}</div><div class="title-bar-controls"><button aria-label="Close" onclick="document.getElementById('${id}').remove()"></button></div></div><div class="window-body" style="height:calc(100% - 32px); overflow:hidden;">${mediaHtml}</div>`;
    document.body.appendChild(win); makeDraggable(id);
}
async function processIEUpload() {
    const fileInput = document.getElementById('ie_file_picker');
    const name = document.getElementById('ie_filename').value.trim() || "Video_" + Date.now();
    if(!fileInput.files[0]) { alert('Select a file.'); return; }
    if(!CURRENT_USER) { alert('Log in first.'); return; }
    
    // Check if user is VIP+ (VIP, CONTRIB, Admin, ST, or has VIP perks)
    const user = userDatabase[CURRENT_USER];
    const canUpload = user && (user.rank === 'VIP' || user.rank === 'CONTRIB' || user.isAdmin || user.isST || user.hasVipPerks);
    if (!canUpload) { alert('VIP+ members only can upload to Memories.'); return; }
    
    document.getElementById('upload_status').innerText = "Uploading..."; document.getElementById('upload_status').disabled = true;
    const file = fileInput.files[0];
    if (file.size > 5 * 1024 * 1024) { alert('File too large! Max 5MB for direct upload. Use a URL instead for larger files.'); document.getElementById('upload_status').innerText = "Push to Cloud"; document.getElementById('upload_status').disabled = false; return; }
    try {
        const dataUri = await fileToBase64(file, file.type.startsWith('image/') ? 800 : 0);
        await db.ref('archive').push({ name: name, url: dataUri, uploader: CURRENT_USER, timestamp: firebase.database.ServerValue.TIMESTAMP }); renderMemories(); document.getElementById('upload_status').innerText = "Push to Cloud"; document.getElementById('ie_filename').value = ""; fileInput.value = ""; alert('Uploaded!');
    } catch (e) { alert("Error: " + e.message); document.getElementById('upload_status').innerText = "Push to Cloud"; }
    document.getElementById('upload_status').disabled = false;
}

// WINDOW MANAGEMENT
function toggleWin(id) {
    let el = document.getElementById(id); if (!el) return;
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
    if(el.style.display === 'block') { document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); el.style.zIndex = "200"; }
    if (id === 'admin_window') { loadAllApplications(); }
    if (id === 'clubs_window') { loadAllClubs(); loadMyClubs(); loadClubInvites(); checkCanCreateClub(); }
    if (id === 'messages_window') { loadDMList(); loadFriendRequests(); loadFriendsList(); loadGroupList(); }
    if (id === 'chat_win' && el.style.display === 'block') { scrollChatToBottom(); }
}
function makeDraggable(winId) {
    const win = document.getElementById(winId); if (!win) return;
    const header = win.querySelector('.title-bar'); if (!header) return;
    header.onmousedown = (e) => {
        e.preventDefault();
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); win.style.zIndex = "400";
        let startX = e.clientX, startY = e.clientY, startLeft = win.offsetLeft, startTop = win.offsetTop;
        document.onmousemove = (e) => { win.style.left = (startLeft + e.clientX - startX) + 'px'; win.style.top = (startTop + e.clientY - startY) + 'px'; };
        document.onmouseup = () => { document.onmousemove = null; document.onmouseup = null; };
    };
    header.ontouchstart = (e) => {
        const touch = e.touches[0];
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); win.style.zIndex = "400";
        let startX = touch.clientX, startY = touch.clientY, startLeft = win.offsetLeft, startTop = win.offsetTop;
        document.ontouchmove = (e) => { const t = e.touches[0]; win.style.left = (startLeft + t.clientX - startX) + 'px'; win.style.top = (startTop + t.clientY - startY) + 'px'; };
        document.ontouchend = () => { document.ontouchmove = null; document.ontouchend = null; };
    };
}
['ie_window', 'memories_folder', 'chat_win', 'about_window', 'games_window', 'apply_window', 'admin_window', 'profile_window', 'clubs_window', 'messages_window', 'leaderboard_window', 'watchparty_window'].forEach(id => makeDraggable(id));

window.beginSession = function() {
    document.getElementById('boot-screen').style.display = 'none';
    if(player) { player.unMute(); player.playVideo(); }
};

var player;
window.onYouTubeIframeAPIReady = function() {
    player = new YT.Player('player', {
        videoId: 'Bi5kyehmeaY',
        playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'Bi5kyehmeaY', 'controls': 0 },
        events: { 'onReady': (e) => e.target.mute() }
    });
};
function pauseMusic() { if(player) player.pauseVideo(); }
function playMusic() { if(player) player.playVideo(); }

window.addEventListener('load', () => {
    renderMemories();
    updateVisitorCount();
    updateClock();
    initStakesGame();
    bjNewGame(); // Initialize blackjack
    startOnlineListener();
});
</script>
</body>
</html>
