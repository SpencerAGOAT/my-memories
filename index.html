<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fangtasia.wtf</title>
    
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/7.css">
    
    <style>
        :root { 
            --vamp-red: #8b0000; 
            --glass: rgba(15, 0, 0, 0.9); 
            --neon-pink: #ff00ff;
            --blood-glow: 0 0 10px rgba(139, 0, 0, 0.8);
        }
        
        /* ANIMATED BAT CURSOR */
        .bat-cursor {
            position: fixed;
            width: 32px;
            height: 32px;
            pointer-events: none;
            z-index: 99999;
            transform: translate(-50%, -50%);
        }
        
        .bat-cursor svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 3px rgba(139, 0, 0, 0.8));
        }
        
        .bat-cursor .wing-left,
        .bat-cursor .wing-right {
            transform-origin: center;
            animation: flapWings 0.15s ease-in-out infinite alternate;
        }
        
        .bat-cursor .wing-right {
            animation-delay: 0.075s;
        }
        
        @keyframes flapWings {
            0% { transform: scaleX(1) rotate(0deg); }
            100% { transform: scaleX(0.85) rotate(-8deg); }
        }
        
        /* Hide default cursor */
        * { cursor: none !important; }
        
        /* SYSTEM CORE */
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: black; overflow: hidden; }
        body {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), 
                url('https://cdn.discordapp.com/attachments/1459009893540434114/1463462838659186875/IMG_9667.jpg?ex=6971eb7a&is=697099fa&hm=be1f64186d5b932c2dc640bd86f5d9bea844d381648c55f880790a02a561f6f9&');
            background-size: cover; background-position: center; font-family: "Segoe UI", Tahoma, sans-serif;
        }

        /* BOOT SCREEN WITH GLITCH */
        #boot-screen {
            position: fixed; inset: 0; background: black; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #d40000;  cursor: none !important;
        }
        
        .boot-title {
            font-size: 60px;
            
            animation: bloodPulse 2s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3);
        }
        
        @keyframes bloodPulse {
            0%, 100% { text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); }
            50% { text-shadow: 0 0 30px rgba(212, 0, 0, 0.8), 0 0 60px rgba(212, 0, 0, 0.5), 0 0 80px rgba(212, 0, 0, 0.3); }
        }
        
        .boot-subtitle {
            animation: flicker 3s infinite;
            margin-top: 20px;
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            92% { opacity: 1; }
            93% { opacity: 0.3; }
            94% { opacity: 1; }
            96% { opacity: 0.5; }
            97% { opacity: 1; }
        }
        
        @keyframes batFloat {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        /* DESKTOP UI */
        #desktop { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; padding: 25px; height: calc(100vh - 40px); gap: 20px; }
        .icon { width: 110px; text-align: center; color: white; text-shadow: 1px 1px 3px black; font-size: 11px; z-index: 5; margin-bottom: 15px; transition: transform 0.2s, filter 0.2s; }
        .icon:hover { transform: scale(1.1); filter: brightness(1.2); }
        .icon img.folder-icon { width: 44px; display: block; margin: 0 auto 6px; filter: grayscale(0.3) sepia(1) saturate(35) hue-rotate(320deg) brightness(0.55) contrast(1.5); }
        .icon img.video-icon { width: 40px; display: block; margin: 0 auto 6px; }

        /* WINDOW ENGINE */
        .window { position: absolute; background: #0d0d0d !important; border: 1px solid #700000 !important; box-shadow: 0 15px 40px rgba(0,0,0,1), 0 0 30px rgba(139, 0, 0, 0.2); display: none; z-index: 10; overflow: hidden; resize: both; }
        .title-bar { background: linear-gradient(to bottom, #8b0000, #2a0000) !important; }
        .window-body { height: calc(100% - 32px); padding: 0; background: black; overflow: auto; }

        /* THE LOUNGE CHAT */
        .chat-container { display: flex; height: 350px; background: #050000; border-bottom: 1px solid #400; }
        #chat_logs { flex: 1; overflow-y: scroll; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        
        /* CHAT MESSAGE TAGS */
        .chat-entry { display: flex; flex-direction: column; gap: 2px; }
        .chat-header { display: flex; align-items: center; gap: 8px; }
        .rank-tag { font-size: 9px; font-weight: bold; padding: 1px 4px; border-radius: 2px; border: 1px solid; text-transform: uppercase; min-width: 25px; text-align: center; }
        
        #member_list { width: 180px; border-left: 1px solid #400; padding: 12px; background: #0a0000; }
        .member-category { color: #d40000; font-size: 14px; font-weight: bold; margin-top: 15px; border-bottom: 1px solid #400; text-transform: uppercase; padding-bottom: 4px;  }
        .member-item { font-size: 14px; font-weight: bold; margin-top: 6px; }

        /* RANK STYLING - Clean readable text */
        .st-style { color: #ff00ff; border-color: #ff00ff; }
        .a-style { color: #ff00ea; border-color: #ff00ea; }
        .mod-style { color: #00ff00; border-color: #00ff00; }
        .guest-style { color: #888; border-color: #555; }
        .vip-style { color: #ffd700; border-color: #ffd700; }
        .member-style { color: #ff4444; border-color: #ff4444; }
        .bot-style { color: #d40000; border-color: #d40000; }

        /* MEMORIES 3-COLUMN GRID */
        #memories_grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; justify-items: center; }
        .pagination-bar { padding: 10px; background: #111; border-top: 1px solid #400; text-align: center; }

        /* UI ELEMENTS */
        .ie-content { padding: 15px; color: #d40000; }
        .ie-input { width: 100%; background: #111; color: #ff0000; border: 1px solid #700000; padding: 6px; margin-bottom: 12px; font-size: 11px; box-sizing: border-box; }
        .ie-input:focus { outline: none; border-color: #ff0000; box-shadow: 0 0 5px rgba(255, 0, 0, 0.3); }
        .ie-btn { background: #500; color: white; border: 1px solid #f00; padding: 8px; width: 100%; font-weight: bold; margin-bottom: 5px; transition: all 0.2s; }
        .ie-btn:hover { background: #700; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
        .lounge-entry-btn { background: linear-gradient(#222, #000); border: 1px solid #ff00ff; color: #ff00ff; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 20px; font-size: 11px; text-transform: uppercase; transition: all 0.3s; }
        .lounge-entry-btn:hover { background: linear-gradient(#330033, #110011); box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); }
        
        /* GUEST PORTAL STYLES */
        .guest-section { border-top: 1px solid #400; margin-top: 20px; padding-top: 15px; }
        .guest-btn { background: linear-gradient(#1a1a1a, #0a0a0a); border: 1px solid #444; color: #888; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 8px; font-size: 11px; text-transform: uppercase; transition: all 0.3s; }
        .guest-btn:hover { border-color: #666; color: #aaa; background: linear-gradient(#222, #111); }
        
        /* GUESTBOOK STYLES */
        .guestbook-entry { background: #0a0000; border: 1px solid #300; padding: 10px; margin-bottom: 8px; border-radius: 2px; }
        .guestbook-name { color: #d40000; font-weight: bold; font-size: 12px; }
        .guestbook-date { color: #555; font-size: 9px; float: right; }
        .guestbook-msg { color: #999; font-size: 11px; margin-top: 5px; }
        
        /* VISITOR COUNTER */
        .visitor-counter { 
            background: #000; 
            border: 1px solid #400; 
            padding: 8px 15px; 
            display: inline-block; 
            font-family: 'Courier New', monospace;
            color: #0f0;
            font-size: 14px;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        
        /* PROFILE CUSTOMIZATION */
        .color-picker-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .color-swatch { width: 24px; height: 24px; border: 2px solid #333; transition: all 0.2s; }
        .color-swatch:hover { transform: scale(1.2); border-color: #fff; }
        .color-swatch.selected { border-color: #fff; box-shadow: 0 0 8px currentColor; }
        
        /* AVATAR SELECTION */
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .avatar-option { width: 40px; height: 40px; border: 2px solid #333; background: #111; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s; }
        .avatar-option:hover { border-color: #700; transform: scale(1.1); }
        .avatar-option.selected { border-color: #f00; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
        
        .taskbar { position: fixed; bottom: 0; width: 100%; height: 40px; background: var(--glass); border-top: 1px solid rgba(255,0,0,0.3); display: flex; align-items: center; z-index: 100; }
        .start-btn { background: linear-gradient(to bottom, #8b0000, #2a0000); border: 1px solid #500; color: #fff; padding: 5px 15px; margin-left: 5px; font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .start-btn:hover { background: linear-gradient(to bottom, #a00000, #3a0000); }
        .sound-controls { display: flex; margin-left: 100px; gap: 45px; }
        .music-ctrl { width: 22px; filter: invert(1) sepia(1) saturate(10) hue-rotate(330deg); opacity: 0.8; transition: opacity 0.2s; }
        .music-ctrl:hover { opacity: 1; }
        
        /* SCROLLBAR STYLING */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #0a0000; }
        ::-webkit-scrollbar-thumb { background: #400; border: 1px solid #600; }
        ::-webkit-scrollbar-thumb:hover { background: #500; }
        
        /* SCREENSAVER */
        #screensaver { position: fixed; inset: 0; background: black; z-index: 99998; display: none; overflow: hidden; }
        .screensaver-bat { position: absolute; font-size: 30px; filter: drop-shadow(0 0 10px rgba(139, 0, 0, 0.8)); }
        @keyframes flyAround {
            0% { transform: translate(0, 0); }
            25% { transform: translate(80vw, 20vh); }
            50% { transform: translate(40vw, 80vh); }
            75% { transform: translate(10vw, 50vh); }
            100% { transform: translate(0, 0); }
        }

        /* CHAT THEMES */
        .chat-theme-default { background: #050000; }
        .chat-theme-coffin { background: linear-gradient(135deg, #1a0f0a 0%, #0d0805 100%); }
        .chat-theme-blood { background: linear-gradient(180deg, #1a0000 0%, #0a0000 50%, #150000 100%); }
        .chat-theme-crypt { background: repeating-linear-gradient(0deg, #0a0a0a, #0a0a0a 2px, #0f0f0f 2px, #0f0f0f 4px); }
        .chat-theme-neon { background: linear-gradient(135deg, #0a000a 0%, #000a0a 100%); }

        /* PROFILE CARD */
        .profile-card { position: fixed; width: 260px; background: linear-gradient(135deg, #1a0000, #0a0000); border: 1px solid #700; box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 9000; display: none; padding: 12px; }
        .profile-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .profile-card-avatar { font-size: 36px; }
        .profile-card-name { font-weight: bold; font-size: 14px; }
        .profile-card-title { font-size: 9px; color: #888; }
        .profile-card-bio { font-size: 10px; color: #aaa; border-top: 1px solid #400; padding-top: 8px; margin-top: 8px; }
        .profile-card-btn { background: #500; color: #fff; border: 1px solid #800; padding: 5px 10px; font-size: 9px; margin-top: 10px; width: 100%; }

        /* DM WINDOW */
        .dm-logs { height: 250px; overflow-y: auto; padding: 8px; background: #050000; }
        .dm-pinned { background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; padding: 5px; margin: 5px; font-size: 9px; }

        /* SHRINE */
        .shrine-container { text-align: center; padding: 15px; background: linear-gradient(180deg, #0a0000, #000); }
        .candle-row { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
        .candle { font-size: 36px; filter: grayscale(1) brightness(0.5); transition: all 0.3s; }
        .candle.lit { filter: none; animation: candleGlow 1s ease-in-out infinite alternate; }
        @keyframes candleGlow { 0% { filter: drop-shadow(0 0 5px #ff6600); } 100% { filter: drop-shadow(0 0 15px #ff6600); } }
        .offering-input { background: transparent; border: none; border-bottom: 1px solid #400; color: #d40000; text-align: center; width: 180px; padding: 4px; }
        .offerings-list { margin-top: 15px; max-height: 120px; overflow-y: auto; }
        .offering-item { color: #555; font-size: 9px; margin: 2px 0; }

        /* MINIGAME */
        .stakes-grid { display: grid; grid-template-columns: repeat(9, 26px); gap: 1px; justify-content: center; }
        .stakes-cell { width: 26px; height: 26px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .stakes-cell.revealed { background: #111; }
        .stakes-cell.stake { background: #500; }
        .game-status { text-align: center; margin: 8px 0; color: #d40000; font-size: 11px; }

        /* APPLICATION */
        .app-status { padding: 8px; margin-top: 8px; border: 1px solid; font-size: 10px; }
        .app-pending { border-color: #ffd700; color: #ffd700; background: rgba(255, 215, 0, 0.1); }

        /* TABS */
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #400; }
        .tab { padding: 6px 12px; color: #666; font-size: 10px; border-right: 1px solid #333; }
        .tab:hover { background: #1a1a1a; color: #999; }
        .tab.active { background: #0a0000; color: #d40000; }

        /* ADMIN */
        .admin-section { margin-bottom: 12px; }
        .admin-section h4 { color: #d40000;  margin-bottom: 6px; font-size: 12px; }
        .approval-item { display: flex; gap: 8px; padding: 8px; border: 1px solid #333; margin-bottom: 6px; align-items: center; }
        .approval-item img { max-width: 60px; max-height: 45px; }

        /* CHAT EXTRAS */
        .chat-action { color: #888; font-style: italic; }
        .chat-bot { background: rgba(139, 0, 0, 0.1); border-left: 2px solid #8b0000; padding: 6px; margin: 4px 0; }
        .pinned-msg { background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; padding: 6px; margin-bottom: 8px; font-size: 10px; }
        .chat-image { max-width: 150px; max-height: 100px; border: 1px solid #400; margin-top: 4px; }
        .pending-image { opacity: 0.5; border: 1px dashed #666; }
        .bot-style { color: #d40000; border-color: #d40000; }

        /* THEME SELECTOR */
        .theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
        .theme-option { width: 28px; height: 28px; border: 2px solid #333; }
        .theme-option.selected { border-color: #f00; }

        /* TYPING INDICATOR */
        .typing-indicator { 
            display: flex; 
            gap: 4px; 
            padding: 8px 12px;
            color: #666;
            font-size: 11px;
            font-style: italic;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #d40000;
            border-radius: 50%;
            animation: typingBounce 1s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }
        
        /* BLOOD DRIP EFFECT */
        .blood-drip {
            position: absolute;
            top: 0;
            width: 3px;
            height: 0;
            background: linear-gradient(to bottom, #8b0000, #4a0000);
            border-radius: 0 0 3px 3px;
            animation: drip 4s ease-in infinite;
        }
        
        @keyframes drip {
            0% { height: 0; opacity: 1; }
            70% { height: 30px; opacity: 1; }
            100% { height: 40px; opacity: 0; }
        }
    </style>
</head>
<body>

<!-- ANIMATED BAT CURSOR -->
<div class="bat-cursor" id="batCursor">
    <svg viewBox="0 0 32 32" fill="#8b0000">
        <g class="wing-left">
            <path d="M16 14 L8 8 L6 12 L10 14 L6 16 L4 14 L2 18 L8 18 L12 16 L16 16 Z"/>
        </g>
        <g class="wing-right">
            <path d="M16 14 L24 8 L26 12 L22 14 L26 16 L28 14 L30 18 L24 18 L20 16 L16 16 Z" style="transform-origin: 16px 14px;"/>
        </g>
        <!-- Body -->
        <ellipse cx="16" cy="16" rx="4" ry="5" fill="#8b0000"/>
        <!-- Head -->
        <circle cx="16" cy="11" r="3" fill="#8b0000"/>
        <!-- Ears -->
        <path d="M13 9 L12 6 L14 8 Z" fill="#8b0000"/>
        <path d="M19 9 L20 6 L18 8 Z" fill="#8b0000"/>
        <!-- Eyes -->
        <circle cx="15" cy="10" r="0.8" fill="#ff0000"/>
        <circle cx="17" cy="10" r="0.8" fill="#ff0000"/>
    </svg>
</div>

<!-- SCREENSAVER -->
<div id="screensaver"></div>

<!-- PROFILE CARD POPUP -->
<div class="profile-card" id="profile_card">
    <div class="profile-card-header">
        <span class="profile-card-avatar" id="pc_avatar">ü¶á</span>
        <div>
            <div class="profile-card-name" id="pc_name">Username</div>
            <div class="profile-card-title" id="pc_title">Member</div>
        </div>
    </div>
    <div class="profile-card-bio" id="pc_bio">No bio set.</div>
    <button class="profile-card-btn" onclick="openDM(currentProfileUser)">üí¨ Send Message</button>
</div>

<div id="boot-screen" onclick="beginSession()">
    <div class="boot-bat" style="font-size: 80px; margin-bottom: 20px; animation: batFloat 3s ease-in-out infinite;">ü¶á</div>
    <h1 class="boot-title">fangtasia.wtf</h1>
    <p class="boot-subtitle">Click anywhere to enter the crypt...</p>
    <div style="margin-top: 30px;">
        <div class="visitor-counter">SOULS COLLECTED: <span id="visitor_count">000000</span></div>
    </div>
    <div style="margin-top: 40px; color: #500; font-size: 10px; animation: flicker 3s infinite;">
        ‚ñº CLICK TO INITIALIZE ‚ñº
    </div>
</div>

<div id="desktop">
    <div class="icon" onclick="toggleWin('memories_folder')">
        <img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png">
        <div>Memories</div>
    </div>
    <div class="icon" onclick="toggleWin('ie_window')">
        <img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/msie1-2.png">
        <div>Portal</div>
    </div>
    <div class="icon" onclick="toggleWin('games_window')">
        <img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/joystick-2.png">
        <div>Games</div>
    </div>
    <div class="icon" onclick="toggleWin('apply_window')">
        <img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/keys-0.png">
        <div>Apply</div>
    </div>
    <div class="icon" onclick="toggleWin('about_window')">
        <img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/help_book_cool-4.png">
        <div>About</div>
    </div>
    <div class="icon" id="admin_icon" style="display:none;" onclick="toggleWin('admin_window')">
        <img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/lock-0.png">
        <div>Admin Panel</div>
    </div>
</div>

<!-- ABOUT WINDOW -->
<div class="window" id="about_window" style="left:200px; top:120px; width:350px; height:320px;">
    <div class="title-bar">
        <div class="title-bar-text">About fangtasia.wtf</div>
        <div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('about_window')"></button></div>
    </div>
    <div class="window-body">
        <div class="ie-content" style="text-align: center;">
            <h2 style="font-size: 28px; margin-bottom: 5px;">fangtasia.wtf</h2>
            <p style="color: #666; font-size: 10px;">Version 6.66</p>
            <div style="border: 1px solid #400; padding: 15px; margin: 15px 0; text-align: left; background: #050000;">
                <p style="color: #999; font-size: 11px; line-height: 1.6;">
                    Welcome to the digital crypt. A private archive maintained by the inner circle.
                    <br><br>
                    ü¶á <span style="color:#d40000;">Memories</span> - Video archive<br>
                    ü¶á <span style="color:#d40000;">Portal</span> - Member access<br>
                    ü¶á <span style="color:#d40000;">Games</span> - Silver Stakes<br>
                    ü¶á <span style="color:#d40000;">The Lounge</span> - Members only
                </p>
            </div>
            <p style="color: #555; font-size: 9px;">¬© 2024 - Eternal Night Productions</p>
        </div>
    </div>
</div>

<!-- GAMES WINDOW -->
<div class="window" id="games_window" style="left:180px; top:70px; width:320px; height:400px;">
    <div class="title-bar">
        <div class="title-bar-text">üéÆ Silver Stakes</div>
        <div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('games_window')"></button></div>
    </div>
    <div class="window-body">
        <div style="padding: 10px;">
            <h3 style=" color: #d40000; text-align: center; margin: 5px 0;">Silver Stakes</h3>
            <p style="color: #666; font-size: 9px; text-align: center;">Avoid the stakes! Left-click reveal, right-click flag.</p>
            <div class="game-status" id="game_status">ü¶á Stakes: 10</div>
            <div class="stakes-grid" id="stakes_grid"></div>
            <div style="text-align: center; margin-top: 8px;">
                <button class="ie-btn" style="width: auto; padding: 4px 15px;" onclick="initStakesGame()">New Game</button>
            </div>
        </div>
    </div>
</div>

<!-- APPLY WINDOW -->
<div class="window" id="apply_window" style="left:160px; top:90px; width:340px; height:440px;">
    <div class="title-bar">
        <div class="title-bar-text">üîë Apply for Access</div>
        <div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('apply_window')"></button></div>
    </div>
    <div class="window-body">
        <div class="ie-content">
            <h2 style="margin-top: 0; font-size: 18px;">Join the Coven</h2>
            <p style="color: #888; font-size: 9px; margin-bottom: 10px;">Access is granted only to the worthy.</p>
            <div id="app_form">
                <input type="text" id="app_username" class="ie-input" placeholder="Desired Username" maxlength="20">
                <input type="text" id="app_referral" class="ie-input" placeholder="Who referred you?">
                <textarea id="app_reason" class="ie-input" placeholder="Why do you seek entry?" style="height: 60px; resize: none;"></textarea>
                <textarea id="app_offering" class="ie-input" placeholder="What can you offer?" style="height: 50px; resize: none;"></textarea>
                <button class="ie-btn" onclick="submitApplication()">ü©∏ Submit Blood Pact</button>
                <button class="ie-btn" style="background: #333; margin-top: 5px;" onclick="checkAppStatus()">Check Application Status</button>
            </div>
            <div id="app_result" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- REGISTRATION WINDOW - Shows after approval -->
<div class="window" id="register_window" style="left:180px; top:100px; width:340px; height:400px; display:none;">
    <div class="title-bar">
        <div class="title-bar-text">‚úì Complete Registration</div>
        <div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('register_window')"></button></div>
    </div>
    <div class="window-body">
        <div class="ie-content">
            <h2 style="margin-top: 0; font-size: 16px; color: #00ff00;">ü©∏ Application Approved!</h2>
            <p style="color: #888; font-size: 10px; margin-bottom: 15px;">Complete your registration to join the coven.</p>
            <input type="text" id="reg_username" class="ie-input" placeholder="Username" maxlength="20">
            <input type="password" id="reg_password" class="ie-input" placeholder="Password">
            <input type="password" id="reg_password2" class="ie-input" placeholder="Confirm Password">
            <div style="border: 1px dashed #ffd700; padding: 8px; margin: 10px 0; background: rgba(255,215,0,0.05);">
                <label style="color: #ffd700; font-size: 9px;">üåü VIP Invite Code (optional)</label>
                <input type="text" id="reg_vip_code" class="ie-input" placeholder="Enter VIP code for instant VIP rank" style="margin-bottom:0;">
            </div>
            <button class="ie-btn" onclick="completeRegistration()">ü¶á Complete Registration</button>
            <div id="reg_result" style="margin-top: 10px;"></div>
        </div>
    </div>
</div>

<!-- CHAT WINDOW -->
<div class="window" id="chat_win" style="left:550px; top:50px; width:650px; height:520px;">
    <div class="title-bar">
        <div class="title-bar-text">ü©∏ The Lounge</div>
        <div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('chat_win')"></button></div>
    </div>
    <div class="window-body">
        <div class="tab-bar">
            <div class="tab active" onclick="switchChatTab('main', this)">Lounge</div>
            <div class="tab" onclick="switchChatTab('settings', this)">‚öôÔ∏è Settings</div>
        </div>
        
        <div id="chat_main">
            <div id="pinned_container"></div>
            <div class="chat-container" id="chat_container">
                <div id="chat_logs"></div>
                <div id="member_list">
                    <div class="member-category">Site Technician</div>
                    <div id="list_technician"></div>
                    <div class="member-category">Admins</div>
                    <div id="list_admin"></div>
                    <div class="member-category">Moderators</div>
                    <div id="list_mod"></div>
                    <div class="member-category">VIP</div>
                    <div id="list_vip"></div>
                    <div class="member-category">Members</div>
                    <div id="list_member"></div>
                </div>
            </div>
            <div id="typing_area" style="padding: 5px 12px; background: #080000; display: none;">
                <div class="typing-indicator">
                    <span id="typing_user"></span>&nbsp;is typing
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            <div style="padding:10px; background:#111;">
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input type="text" id="chat_input" class="ie-input" style="margin:0; flex:1;" placeholder="/help for commands..." onkeypress="handleChatKey(event)" onkeyup="handleTyping()">
                    <label class="ie-btn" style="width: 35px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">
                        üì∑<input type="file" id="chat_image" accept="image/*" style="display:none;" onchange="uploadChatImage()">
                    </label>
                </div>
                <button class="ie-btn" onclick="sendChat()">Send</button>
            </div>
        </div>
        
        <div id="chat_settings" style="display: none; padding: 12px; overflow-y: auto; height: calc(100% - 40px);">
            <h3 style="color: #d40000; margin: 0 0 10px 0; font-size: 14px;">Profile Settings</h3>
            
            <label style="color: #888; font-size: 9px;">Name Color</label>
            <div class="color-picker-row">
                <div class="color-swatch" style="background: #ff0000;" data-color="#ff0000" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #ff00ff;" data-color="#ff00ff" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #00ff00;" data-color="#00ff00" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #00ffff;" data-color="#00ffff" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #ffd700;" data-color="#ffd700" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #ff6600;" data-color="#ff6600" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #ff69b4;" data-color="#ff69b4" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #9400d3;" data-color="#9400d3" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #00ff7f;" data-color="#00ff7f" onclick="selectColor(this)"></div>
                <div class="color-swatch" style="background: #ffffff;" data-color="#ffffff" onclick="selectColor(this)"></div>
            </div>
            
            <label style="color: #888; font-size: 9px;">Chat Theme</label>
            <div class="theme-grid">
                <div class="theme-option chat-theme-default" data-theme="default" onclick="selectTheme(this)" title="Default"></div>
                <div class="theme-option chat-theme-coffin" data-theme="coffin" onclick="selectTheme(this)" title="Coffin"></div>
                <div class="theme-option chat-theme-blood" data-theme="blood" onclick="selectTheme(this)" title="Blood"></div>
                <div class="theme-option chat-theme-crypt" data-theme="crypt" onclick="selectTheme(this)" title="Crypt"></div>
                <div class="theme-option chat-theme-neon" data-theme="neon" onclick="selectTheme(this)" title="Neon"></div>
            </div>
            
            <label style="color: #888; font-size: 9px;">Mood Status</label>
            <select id="user_mood" class="ie-input" onchange="saveProfile()">
                <option value="">None</option>
                <option value="ü©∏ Thirsty">ü©∏ Thirsty</option>
                <option value="üò¥ Dormant">üò¥ Dormant</option>
                <option value="üåô Hunting">üåô Hunting</option>
                <option value="‚ö∞Ô∏è Resting">‚ö∞Ô∏è Resting</option>
                <option value="ü¶á Lurking">ü¶á Lurking</option>
                <option value="üî• Vibing">üî• Vibing</option>
                <option value="üíÄ Dead Inside">üíÄ Dead Inside</option>
                <option value="‚ú® Ascending">‚ú® Ascending</option>
            </select>
            
            <label style="color: #888; font-size: 9px;">Custom Status</label>
            <input type="text" id="user_status" class="ie-input" placeholder="What's happening..." maxlength="30">
            
            <label style="color: #888; font-size: 9px;">Bio</label>
            <textarea id="user_bio" class="ie-input" placeholder="Tell us about yourself..." maxlength="150" style="height: 50px; resize: none;"></textarea>
            
            <button class="ie-btn" onclick="saveProfile()">Save Profile</button>
        </div>
    </div>
</div>

<!-- ADMIN PANEL WINDOW -->
<div class="window" id="admin_window" style="left:300px; top:60px; width:480px; height:580px; display:none;">
    <div class="title-bar">
        <div class="title-bar-text">üëë Admin Control Panel</div>
        <div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('admin_window')"></button></div>
    </div>
    <div class="window-body" style="overflow-y: auto;">
        <div class="ie-content">
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">üñºÔ∏è Pending Images</h4>
                <div id="pending_images" style="max-height: 100px; overflow-y: auto;">None</div>
            </div>
            
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">üìù Membership Applications</h4>
                <div id="pending_apps" style="max-height: 120px; overflow-y: auto;">None</div>
            </div>
            
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">‚ö†Ô∏è User Moderation</h4>
                <input type="text" id="mod_username" class="ie-input" placeholder="Username to moderate...">
                <select id="mod_action" class="ie-input">
                    <option value="">Select Action...</option>
                    <option value="kick">Kick (disconnect, can rejoin)</option>
                    <option value="timeout">Timeout (temp mute)</option>
                    <option value="softban">Soft Ban (suspend account)</option>
                    <option value="hardban">Hard Ban (delete account)</option>
                </select>
                <select id="mod_duration" class="ie-input">
                    <option value="5">5 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="1440">24 hours</option>
                    <option value="10080">7 days</option>
                    <option value="0">Permanent</option>
                </select>
                <input type="text" id="mod_reason" class="ie-input" placeholder="Reason (optional)">
                <button class="ie-btn" style="background: #800;" onclick="executeModAction()">Execute Action</button>
                <div id="mod_result" style="margin-top: 5px; font-size: 10px;"></div>
            </div>
            
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">üö´ Banned/Suspended Users</h4>
                <div id="banned_users" style="max-height: 100px; overflow-y: auto; font-size: 10px;">None</div>
            </div>
            
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">üìå Lounge Announcement</h4>
                <input type="text" id="pin_message" class="ie-input" placeholder="Message to pin...">
                <button class="ie-btn" onclick="pinMessage()">Pin</button>
                <button class="ie-btn" style="background: #333;" onclick="clearPin()">Clear</button>
            </div>
            
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">üßõ Eric Northman Bot</h4>
                <input type="text" id="bot_message" class="ie-input" placeholder="Eric says...">
                <button class="ie-btn" onclick="sendBotMessage()">Send as Eric</button>
            </div>
            
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">üóëÔ∏è Chat Management</h4>
                <button class="ie-btn" style="background: #500;" onclick="clearChat()">Clear All Messages</button>
                <button class="ie-btn" style="background: #333;" onclick="exportChat()">Export Chat Log</button>
            </div>
            
            <div class="admin-section">
                <h4 style="color: #d40000; border-bottom: 1px solid #400; padding-bottom: 5px;">üìä Stats</h4>
                <div id="admin_stats" style="color: #888; font-size: 11px;"></div>
            </div>
            
            <!-- ST ONLY SECTION -->
            <div class="admin-section" id="st_section" style="display:none; border: 1px solid #ff00ff; padding: 10px; margin-top: 10px;">
                <h4 style="color: #ff00ff; border-bottom: 1px solid #ff00ff; padding-bottom: 5px;">üîÆ Site Technician Only</h4>
                <div style="margin-bottom: 10px;">
                    <label style="color:#888; font-size:9px;">Elevate User Permissions</label>
                    <input type="text" id="elevate_user" class="ie-input" placeholder="Username">
                    <select id="elevate_rank" class="ie-input">
                        <option value="member">Member</option>
                        <option value="vip">VIP</option>
                        <option value="mod">Moderator</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button class="ie-btn" onclick="elevateUser()">Elevate</button>
                </div>
                <div>
                    <label style="color:#888; font-size:9px;">Generate VIP Invite Code</label>
                    <button class="ie-btn" onclick="generateVIPCode()">Generate Code</button>
                    <div id="vip_code_display" style="margin-top:5px; color:#ffd700; font-family:monospace;"></div>
                </div>
                <div style="margin-top:10px;">
                    <label style="color:#888; font-size:9px;">Active VIP Codes</label>
                    <div id="active_codes" style="font-size:9px; color:#666; max-height:60px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="window" id="memories_folder" style="left:50px; top:50px; width:550px; height:580px;">
    <div class="title-bar"><div class="title-bar-text">C:\Memories</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('memories_folder')"></button></div></div>
    <div class="window-body" style="display:flex; flex-direction:column; height:100%;">
        <div id="memories_grid" style="flex:1; overflow-y:auto;"></div>
        <div class="pagination-bar" style="display:flex; justify-content:center; gap:10px;">
            <button class="ie-btn" style="width:auto; padding: 4px 20px;" onclick="prevPage()">< Prev</button>
            <span id="page_indicator" style="color:#888; font-size:11px; line-height:28px;">Page 1</span>
            <button class="ie-btn" style="width:auto; padding: 4px 20px;" onclick="nextPage()">Next ></button>
        </div>
    </div>
</div>

<div class="window" id="ie_window" style="left:150px; top:100px; width:400px; height:620px;">
    <div class="title-bar"><div class="title-bar-text">fangtasia.wtf Portal</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('ie_window')"></button></div></div>
    <div class="window-body" style="overflow-y:auto;">
        <div class="ie-content" id="ie_login">
            <h2 style="">Member Login</h2>
            <input type="text" id="ie_user" class="ie-input" placeholder="Username">
            <input type="password" id="ie_pass" class="ie-input" placeholder="Password">
            <button class="ie-btn" onclick="validateIE()">Authorize</button>
            
            <div class="guest-section">
                <p style="color: #666; font-size: 10px; text-align: center; margin-bottom: 10px;">‚Äî OR ‚Äî</p>
                <button class="guest-btn" onclick="toggleWin('about_window')">‚ùì About This Place</button>
                <button class="guest-btn" onclick="enterGuestChat()">üëÅÔ∏è Lurk the Lounge (Read-Only)</button>
                <p style="color: #555; font-size: 9px; text-align: center; margin-top: 15px;">
                    Want access? <span style="color: #d40000;">Prove your worth.</span>
                </p>
            </div>
        </div>
        <div class="ie-content" id="ie_upload" style="display:none;">
            <button class="lounge-entry-btn" onclick="openChat()">ü©∏ Enter The Lounge</button>
            <p id="logged_in_as" style="font-size: 11px; color: #fff;"></p>
            
            <h3 style="color:#d40000; margin: 15px 0 5px 0; font-size: 13px;">üìπ Upload Memory</h3>
            <input type="text" id="ie_filename" class="ie-input" placeholder="Memory Name">
            <input type="file" id="ie_file_picker" class="ie-input" style="border:none;" accept="video/*">
            <button class="ie-btn" id="upload_status" onclick="processIEUpload()">Push to Cloud</button>
            
            <!-- VIP IMAGE HOSTING -->
            <div id="vip_image_section" style="display:none; margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                <h3 style="color:#ffd700; margin: 0 0 5px 0; font-size: 13px;">üåü VIP Image Hosting</h3>
                <p style="color:#888; font-size:9px;">Upload images and get shareable embed links.</p>
                <input type="file" id="vip_image_picker" class="ie-input" style="border:none;" accept="image/*">
                <button class="ie-btn" style="background:#5a4a00;" onclick="uploadVIPImage()">Upload Image</button>
                <div id="vip_image_result" style="margin-top:8px;"></div>
                <div id="vip_image_gallery" style="margin-top:10px; max-height:120px; overflow-y:auto;"></div>
            </div>
            
            <button class="ie-btn" style="background: #222; margin-top: 15px;" onclick="logout()">Logout</button>
        </div>
    </div>
</div>

<div class="taskbar">
    <div class="sound-controls" style="margin-left: 10px; display: flex; gap: 8px;">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="music-ctrl" onclick="playMusic()" title="Play" style="width:18px; height:18px; cursor:pointer; filter: invert(1) brightness(0.7);">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727240.png" class="music-ctrl" onclick="pauseMusic()" title="Pause" style="width:18px; height:18px; cursor:pointer; filter: invert(1) brightness(0.7);">
    </div>
    <div style="margin-left: auto; margin-right: 15px; color: #888; font-size: 11px;" id="taskbar_clock"></div>
</div>

<div id="player" style="position:absolute; top:-999px;"></div>
<script src="https://www.youtube.com/iframe_api"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB7GeyT9SY7zFBeT-lfCM6iHZ_ipFXvemU",
        authDomain: "fangtasia-14197.firebaseapp.com",
        databaseURL: "https://fangtasia-14197-default-rtdb.firebaseio.com",
        projectId: "fangtasia-14197",
        storageBucket: "fangtasia-14197.firebasestorage.app",
        messagingSenderId: "735588641679",
        appId: "1:735588641679:web:5e0b9c5c5c84166b2f79fa"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const CLOUD_NAME = "fangtasia-14197"; 
    const UPLOAD_PRESET = "fangtasia"; 
    
    // Core admin accounts (hardcoded for security)
    const coreAdmins = {
        "losersyndicate": { pass: "doubledutchie01", rank: "ST", fullRank: "Site Technician", style: "st-style", target: "list_technician", isAdmin: true, isST: true },
        "buttheadandbeav126": { pass: "wtfomfgfangtasiafordabros21", rank: "·óù·ì¨‚ä¢", fullRank: "Admin", style: "a-style", target: "list_admin", isAdmin: true },
        "bloomhouse8483": { pass: "methybethy89!", rank: "MOD", fullRank: "Moderator", style: "mod-style", target: "list_mod", isAdmin: true }
    };
    
    // User database starts with core admins
    let userDatabase = { ...coreAdmins };
    
    // Load members from Firebase on startup
    db.ref('members').on('value', (snapshot) => {
        const members = snapshot.val() || {};
        userDatabase = { ...coreAdmins, ...members };
    });

    let CURRENT_USER = "";
    let IS_GUEST = false;
    let currentPage = 1;
    const itemsPerPage = 9;
    let userProfile = { color: "#ff0000", status: "", bio: "", theme: "default", mood: "" };
    let currentProfileUser = "";
    let idleTime = 0;
    let screensaverActive = false;

    // BAT CURSOR MOVEMENT
    document.addEventListener('mousemove', (e) => {
        const bat = document.getElementById('batCursor');
        bat.style.left = e.clientX + 'px';
        bat.style.top = e.clientY + 'px';
        resetIdle();
    });
    document.addEventListener('keypress', resetIdle);
    document.addEventListener('click', resetIdle);

    // SCREENSAVER
    function resetIdle() {
        idleTime = 0;
        if (screensaverActive) {
            document.getElementById('screensaver').style.display = 'none';
            screensaverActive = false;
        }
    }
    function activateScreensaver() {
        screensaverActive = true;
        const ss = document.getElementById('screensaver');
        ss.innerHTML = '';
        ss.style.display = 'block';
        for (let i = 0; i < 12; i++) {
            const bat = document.createElement('div');
            bat.className = 'screensaver-bat';
            bat.textContent = 'ü¶á';
            bat.style.left = Math.random() * 90 + 'vw';
            bat.style.top = Math.random() * 90 + 'vh';
            bat.style.animation = `flyAround ${6 + Math.random() * 6}s linear infinite`;
            bat.style.animationDelay = Math.random() * 3 + 's';
            ss.appendChild(bat);
        }
    }
    setInterval(() => {
        idleTime++;
        if (idleTime > 90 && !screensaverActive && document.getElementById('boot-screen').style.display === 'none') {
            activateScreensaver();
        }
    }, 1000);

    // VISITOR COUNTER
    function updateVisitorCount() {
        let count = parseInt(localStorage.getItem('f_visitors') || '0');
        if (!sessionStorage.getItem('counted')) {
            count++;
            localStorage.setItem('f_visitors', count);
            sessionStorage.setItem('counted', 'true');
        }
        const formatted = count.toString().padStart(6, '0');
        document.getElementById('visitor_count').textContent = formatted;
        const aboutCounter = document.getElementById('visitor_count_about');
        if (aboutCounter) aboutCounter.textContent = formatted;
    }

    // CLOCK
    function updateClock() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const mins = now.getMinutes().toString().padStart(2, '0');
        document.getElementById('taskbar_clock').textContent = `${hours}:${mins}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // GUESTBOOK
    function loadGuestbook() {
        const entries = JSON.parse(localStorage.getItem('f_guestbook')) || [];
        const container = document.getElementById('guestbook_entries');
        if (entries.length === 0) {
            container.innerHTML = '<p style="color: #555; text-align: center; font-style: italic;">No signatures yet. Be the first...</p>';
            return;
        }
        container.innerHTML = entries.slice(-20).reverse().map(e => `
            <div class="guestbook-entry">
                <span class="guestbook-name">${escapeHtml(e.name)}</span>
                <span class="guestbook-date">${e.date}</span>
                <div class="guestbook-msg">${escapeHtml(e.message)}</div>
            </div>
        `).join('');
    }

    function signGuestbook() {
        const name = document.getElementById('gb_name').value.trim();
        const message = document.getElementById('gb_message').value.trim();
        if (!name || !message) { alert('Fill in both fields.'); return; }
        
        const entries = JSON.parse(localStorage.getItem('f_guestbook')) || [];
        const date = new Date().toLocaleDateString();
        entries.push({ name, message, date });
        localStorage.setItem('f_guestbook', JSON.stringify(entries.slice(-100)));
        
        document.getElementById('gb_name').value = '';
        document.getElementById('gb_message').value = '';
        loadGuestbook();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // SHRINE
    let litCandles = JSON.parse(localStorage.getItem('f_candles') || '[false,false,false,false,false]');
    function renderCandles() {
        const candles = document.querySelectorAll('.candle');
        candles.forEach((c, i) => c.classList.toggle('lit', litCandles[i]));
        const msgs = ['"In darkness, we find our light."', '"One flame pierces the void."', '"The shadows retreat."', '"The altar awakens."', '"Power gathers here."', '"The ritual is complete."'];
        document.getElementById('shrine_message').textContent = msgs[litCandles.filter(c => c).length];
    }
    function toggleCandle(i) {
        litCandles[i] = !litCandles[i];
        localStorage.setItem('f_candles', JSON.stringify(litCandles));
        renderCandles();
    }
    function leaveOffering() {
        const text = document.getElementById('offering_input').value.trim();
        if (!text) return;
        const offerings = JSON.parse(localStorage.getItem('f_offerings') || '[]');
        offerings.push({ text, date: new Date().toLocaleDateString() });
        localStorage.setItem('f_offerings', JSON.stringify(offerings.slice(-50)));
        document.getElementById('offering_input').value = '';
        renderOfferings();
    }
    function renderOfferings() {
        const offerings = JSON.parse(localStorage.getItem('f_offerings') || '[]');
        document.getElementById('offerings_list').innerHTML = offerings.slice(-8).reverse().map(o => `<div class="offering-item">ü©∏ "${escapeHtml(o.text)}"</div>`).join('');
    }

    // SILVER STAKES GAME
    let stakesBoard = [], stakesRevealed = [], stakesFlagged = [], gameOver = false;
    const BOARD_SIZE = 9, NUM_STAKES = 10;
    function initStakesGame() {
        stakesBoard = Array(81).fill(0);
        stakesRevealed = Array(81).fill(false);
        stakesFlagged = Array(81).fill(false);
        gameOver = false;
        let placed = 0;
        while (placed < NUM_STAKES) {
            const pos = Math.floor(Math.random() * 81);
            if (stakesBoard[pos] !== -1) { stakesBoard[pos] = -1; placed++; }
        }
        for (let i = 0; i < 81; i++) {
            if (stakesBoard[i] === -1) continue;
            let count = 0;
            const row = Math.floor(i / 9), col = i % 9;
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = row + dr, nc = col + dc;
                    if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && stakesBoard[nr * 9 + nc] === -1) count++;
                }
            }
            stakesBoard[i] = count;
        }
        renderStakes();
        document.getElementById('game_status').textContent = 'ü¶á Stakes: 10';
    }
    function renderStakes() {
        const grid = document.getElementById('stakes_grid');
        grid.innerHTML = '';
        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.className = 'stakes-cell';
            if (stakesRevealed[i]) {
                cell.classList.add('revealed');
                if (stakesBoard[i] === -1) { cell.classList.add('stake'); cell.textContent = 'üó°Ô∏è'; }
                else if (stakesBoard[i] > 0) { cell.textContent = stakesBoard[i]; cell.style.color = ['','#00f','#0a0','#f00','#008','#800','#088','#000','#888'][stakesBoard[i]]; }
            } else if (stakesFlagged[i]) { cell.textContent = 'üö©'; }
            cell.onclick = () => revealCell(i);
            cell.oncontextmenu = (e) => { e.preventDefault(); if (!gameOver && !stakesRevealed[i]) { stakesFlagged[i] = !stakesFlagged[i]; renderStakes(); } };
            grid.appendChild(cell);
        }
    }
    function revealCell(i) {
        if (gameOver || stakesRevealed[i] || stakesFlagged[i]) return;
        stakesRevealed[i] = true;
        if (stakesBoard[i] === -1) {
            gameOver = true;
            stakesRevealed = stakesRevealed.map(() => true);
            document.getElementById('game_status').textContent = 'üíÄ Staked! Game Over.';
        } else if (stakesBoard[i] === 0) {
            const row = Math.floor(i / 9), col = i % 9;
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = row + dr, nc = col + dc;
                    if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) revealCell(nr * 9 + nc);
                }
            }
        }
        const unrevealed = stakesRevealed.filter((r, idx) => !r && stakesBoard[idx] !== -1).length;
        if (unrevealed === 0 && !gameOver) { gameOver = true; document.getElementById('game_status').textContent = 'ü¶á You survived!'; }
        renderStakes();
    }

    // APPLICATION
    function submitApplication() {
        const username = document.getElementById('app_username').value.trim();
        const reason = document.getElementById('app_reason').value.trim();
        if (!username || !reason) { alert('Fill required fields.'); return; }
        
        const appData = { 
            username, 
            referral: document.getElementById('app_referral').value, 
            reason, 
            offering: document.getElementById('app_offering').value, 
            date: new Date().toLocaleDateString(), 
            status: 'pending', 
            id: Date.now(),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        // Save to Firebase
        db.ref('applications/' + appData.id).set(appData);
        
        document.getElementById('app_form').style.display = 'none';
        document.getElementById('app_result').innerHTML = '<div class="app-status app-pending"><strong>ü©∏ Blood Pact Received</strong><br>The coven will review your request.</div>';
        document.getElementById('app_result').style.display = 'block';
    }

    // GUEST LURK MODE
    function enterGuestChat() {
        IS_GUEST = true;
        CURRENT_USER = "Guest_" + Math.floor(Math.random() * 9999);
        toggleWin('chat_win');
        loadMessages();
        document.getElementById('chat_input').placeholder = "You are lurking (read-only)...";
        document.getElementById('chat_input').disabled = true;
    }

    function validateIE() {
        const u = document.getElementById('ie_user').value;
        const p = document.getElementById('ie_pass').value;
        
        if (!u || !p) { alert("Enter username and password."); return; }
        
        // Check if user is banned (from Firebase)
        db.ref('bans/' + u).once('value', (snapshot) => {
            const ban = snapshot.val();
            if (ban) {
                const now = Date.now();
                if (ban.expiry === 0 || ban.expiry > now) {
                    if (ban.type === 'hardban') {
                        alert('This account has been permanently banned.');
                        return;
                    } else if (ban.type === 'softban') {
                        const expStr = ban.expiry === 0 ? 'permanently' : 'until ' + new Date(ban.expiry).toLocaleString();
                        alert('This account is suspended ' + expStr + '.\nReason: ' + (ban.reason || 'No reason given'));
                        return;
                    }
                } else {
                    // Ban expired, remove it
                    db.ref('bans/' + u).remove();
                }
            }
            
            // Proceed with login
            if(userDatabase[u] && userDatabase[u].pass === p) {
                CURRENT_USER = u;
                IS_GUEST = false;
                document.getElementById('ie_login').style.display = 'none';
                document.getElementById('ie_upload').style.display = 'block';
                document.getElementById('logged_in_as').innerText = `IDENTIFIED: ${u} [${userDatabase[u].fullRank}]`;
                loadProfile();
                updateMemberList();
                
                // Show admin icon for admins
                if (userDatabase[u].isAdmin) {
                    document.getElementById('admin_icon').style.display = 'block';
                }
                
                // Show ST section for Site Technician
                if (userDatabase[u].isST) {
                    const stSection = document.getElementById('st_section');
                    if (stSection) stSection.style.display = 'block';
                }
                
                // Show VIP image hosting for VIP+
                if (userDatabase[u].rank === 'VIP' || userDatabase[u].isAdmin || userDatabase[u].isST) {
                    const vipSection = document.getElementById('vip_image_section');
                    if (vipSection) {
                        vipSection.style.display = 'block';
                        loadVIPGallery();
                    }
                }
            } else { alert("DENIED."); }
        });
    }

    function logout() {
        CURRENT_USER = "";
        IS_GUEST = false;
        document.getElementById('ie_login').style.display = 'block';
        document.getElementById('ie_upload').style.display = 'none';
        document.getElementById('ie_user').value = '';
        document.getElementById('ie_pass').value = '';
        document.getElementById('admin_icon').style.display = 'none';
        document.getElementById('st_section').style.display = 'none';
        document.getElementById('vip_image_section').style.display = 'none';
        toggleWin('chat_win');
    }

    function openChat() { 
        if(CURRENT_USER && !IS_GUEST) { 
            toggleWin('chat_win'); 
            loadMessages(); 
            updateMemberList();
            document.getElementById('chat_input').disabled = false;
            document.getElementById('chat_input').placeholder = "Type your message...";
        } 
    }

    // PROFILE SYSTEM
    function loadProfile() {
        const saved = localStorage.getItem('f_profile_' + CURRENT_USER);
        if (saved) userProfile = { ...userProfile, ...JSON.parse(saved) };
        document.getElementById('user_status').value = userProfile.status || '';
        document.getElementById('user_bio').value = userProfile.bio || '';
        if (document.getElementById('user_mood')) document.getElementById('user_mood').value = userProfile.mood || '';
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.toggle('selected', el.dataset.color === userProfile.color));
        document.querySelectorAll('.theme-option').forEach(el => el.classList.toggle('selected', el.dataset.theme === userProfile.theme));
        applyChatTheme();
    }

    function saveProfile() {
        userProfile.status = document.getElementById('user_status').value;
        userProfile.bio = document.getElementById('user_bio').value;
        if (document.getElementById('user_mood')) userProfile.mood = document.getElementById('user_mood').value;
        localStorage.setItem('f_profile_' + CURRENT_USER, JSON.stringify(userProfile));
        updateMemberList();
    }

    function selectColor(el) {
        document.querySelectorAll('.color-swatch').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        userProfile.color = el.dataset.color;
        saveProfile();
    }

    function selectTheme(el) {
        document.querySelectorAll('.theme-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        userProfile.theme = el.dataset.theme;
        saveProfile();
        applyChatTheme();
    }

    function applyChatTheme() {
        const container = document.getElementById('chat_container');
        if (container) container.className = 'chat-container chat-theme-' + (userProfile.theme || 'default');
    }

    // PROFILE CARD
    function showProfileCard(username, event) {
        if (IS_GUEST) return;
        currentProfileUser = username;
        const card = document.getElementById('profile_card');
        const userData = userDatabase[username];
        const profile = JSON.parse(localStorage.getItem('f_profile_' + username) || '{}');
        document.getElementById('pc_avatar').textContent = 'ü¶á';
        document.getElementById('pc_name').textContent = username;
        document.getElementById('pc_name').className = 'profile-card-name ' + (userData?.style || '');
        document.getElementById('pc_title').textContent = userData?.fullRank || 'Member';
        
        let bioText = profile.bio || 'No bio set.';
        if (profile.mood) bioText = profile.mood + '<br><br>' + bioText;
        document.getElementById('pc_bio').innerHTML = bioText;
        
        card.style.display = 'block';
        card.style.left = Math.min(event.clientX, window.innerWidth - 280) + 'px';
        card.style.top = Math.min(event.clientY, window.innerHeight - 200) + 'px';
    }
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.profile-card') && !e.target.closest('.chat-username')) {
            document.getElementById('profile_card').style.display = 'none';
        }
    });

    // DM SYSTEM
    function openDM(username) {
        if (!username || username === CURRENT_USER || IS_GUEST) return;
        document.getElementById('profile_card').style.display = 'none';
        const dmId = 'dm_' + [CURRENT_USER, username].sort().join('_');
        let dmWin = document.getElementById(dmId);
        if (!dmWin) {
            dmWin = document.createElement('div');
            dmWin.className = 'window';
            dmWin.id = dmId;
            dmWin.style.cssText = 'left:' + (300 + Math.random()*100) + 'px; top:' + (100 + Math.random()*50) + 'px; width:320px; height:380px; display:block;';
            dmWin.innerHTML = '<div class="title-bar"><div class="title-bar-text">üí¨ ' + username + '</div><div class="title-bar-controls"><button aria-label="Close" onclick="document.getElementById(\'' + dmId + '\').style.display=\'none\'"></button></div></div><div class="window-body"><div class="dm-pinned" id="' + dmId + '_pin" style="display:none;"></div><div class="dm-logs" id="' + dmId + '_logs"></div><div style="padding:8px; background:#111;"><input type="text" class="ie-input" style="margin:0;" id="' + dmId + '_input" placeholder="Message..." onkeypress="if(event.key===\'Enter\')sendDM(\'' + dmId + '\',\'' + username + '\')"><div style="display:flex; gap:5px; margin-top:5px;"><button class="ie-btn" style="flex:1;" onclick="sendDM(\'' + dmId + '\',\'' + username + '\')">Send</button><button class="ie-btn" style="width:40px;" onclick="pinDM(\'' + dmId + '\')">üìå</button></div></div></div>';
            document.body.appendChild(dmWin);
            makeDraggable(dmId);
        } else { dmWin.style.display = 'block'; }
        loadDM(dmId);
    }
    function sendDM(dmId, toUser) {
        const input = document.getElementById(dmId + '_input');
        if (!input.value.trim()) return;
        const dms = JSON.parse(localStorage.getItem('f_dm_' + dmId) || '[]');
        const profile = JSON.parse(localStorage.getItem('f_profile_' + CURRENT_USER) || '{}');
        dms.push({ from: CURRENT_USER, text: input.value, avatar: profile.avatar || 'ü¶á', time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
        localStorage.setItem('f_dm_' + dmId, JSON.stringify(dms.slice(-100)));
        input.value = '';
        loadDM(dmId);
    }
    function loadDM(dmId) {
        const logs = document.getElementById(dmId + '_logs');
        const dms = JSON.parse(localStorage.getItem('f_dm_' + dmId) || '[]');
        logs.innerHTML = dms.map(m => '<div style="margin-bottom:6px;"><span style="font-size:12px;">' + (m.avatar||'ü¶á') + '</span> <span style="font-weight:bold; font-size:10px; color:#d40000;">' + m.from + '</span> <span style="color:#444; font-size:8px;">' + m.time + '</span><div style="color:#ccc; font-size:10px; padding-left:20px;">' + escapeHtml(m.text) + '</div></div>').join('');
        logs.scrollTop = logs.scrollHeight;
        const pinned = localStorage.getItem('f_dm_pin_' + dmId);
        const pinEl = document.getElementById(dmId + '_pin');
        if (pinned) { pinEl.style.display = 'block'; pinEl.innerHTML = 'üìå ' + escapeHtml(pinned); }
        else { pinEl.style.display = 'none'; }
    }
    function pinDM(dmId) {
        const msg = prompt('Pin message:');
        if (msg) { localStorage.setItem('f_dm_pin_' + dmId, msg); loadDM(dmId); }
    }

    // CHAT TABS
    function switchChatTab(tab, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('chat_main').style.display = tab === 'main' ? 'block' : 'none';
        document.getElementById('chat_settings').style.display = tab === 'settings' ? 'block' : 'none';
    }

    // TYPING INDICATOR
    function handleTyping() {
        if (IS_GUEST) return;
        localStorage.setItem('f_typing', JSON.stringify({ user: CURRENT_USER, time: Date.now() }));
    }

    function checkTyping() {
        const typing = JSON.parse(localStorage.getItem('f_typing') || '{}');
        const area = document.getElementById('typing_area');
        if (typing.user && typing.user !== CURRENT_USER && (Date.now() - typing.time) < 2000) {
            document.getElementById('typing_user').textContent = typing.user;
            area.style.display = 'block';
        } else {
            area.style.display = 'none';
        }
    }
    setInterval(checkTyping, 500);

    function handleChatKey(event) {
        if (event.key === 'Enter') sendChat();
    }

    // CHAT COMMANDS
    const chatCommands = {
        '/help': () => ({ type: 'system', text: 'Commands: /me, /shrug, /tableflip, /blood, /bat, /bite' }),
        '/me': (args) => ({ type: 'action', text: CURRENT_USER + ' ' + args }),
        '/shrug': () => ({ type: 'action', text: CURRENT_USER + ' ¬Ø\\_(„ÉÑ)_/¬Ø' }),
        '/tableflip': () => ({ type: 'action', text: CURRENT_USER + ' (‚ïØ¬∞‚ñ°¬∞)‚ïØÔ∏µ ‚îª‚îÅ‚îª' }),
        '/blood': () => ({ type: 'action', text: CURRENT_USER + ' ü©∏ü©∏ü©∏' }),
        '/bat': () => ({ type: 'action', text: CURRENT_USER + ' ü¶á *flaps away*' }),
        '/bite': (args) => ({ type: 'action', text: CURRENT_USER + ' üßõ *bites ' + (args || 'the air') + '*' }),
    };

    // BOT RESPONSES
    const botResponses = [
        { trigger: /hello|hi|hey/i, response: "Greetings, mortal. ü¶á" },
        { trigger: /vampire|vamp/i, response: "Did someone say vampire? *fangs glisten*" },
        { trigger: /blood/i, response: "The crimson elixir... ü©∏" },
        { trigger: /sun|daylight/i, response: "We don't speak of the burning orb. ‚òÄÔ∏èüö´" },
        { trigger: /garlic/i, response: "*hisses* Forbidden! üßÑ‚ùå" },
    ];

    function sendChat() {
        if (IS_GUEST) return;
        
        // Check for timeout (from Firebase bans)
        db.ref('bans/' + CURRENT_USER).once('value', (snapshot) => {
            const ban = snapshot.val();
            if (ban && (ban.expiry === 0 || ban.expiry > Date.now())) {
                if (ban.type === 'timeout') {
                    alert('You are timed out and cannot send messages.');
                    return;
                }
            }
            
            const input = document.getElementById('chat_input');
            const text = input.value.trim();
            if(!text) return;
            
            const u = userDatabase[CURRENT_USER];
            const profile = JSON.parse(localStorage.getItem('f_profile_' + CURRENT_USER) || '{}');
            
            // Check for commands
            const cmdMatch = text.match(/^(\/\w+)\s*(.*)?$/);
            if (cmdMatch && chatCommands[cmdMatch[1]]) {
                const result = chatCommands[cmdMatch[1]](cmdMatch[2] || '');
                if (result.type === 'system') {
                    input.value = '';
                    const logs = document.getElementById('chat_logs');
                    logs.innerHTML += '<div style="color:#666; font-size:9px; font-style:italic; padding:4px;">' + result.text + '</div>';
                    logs.scrollTop = logs.scrollHeight;
                    return;
                } else {
                    // Push action to Firebase
                    db.ref('chat').push({ 
                        user: CURRENT_USER, 
                        text: result.text, 
                        isAction: true, 
                        tag: u.rank, 
                        style: u.style, 
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            } else {
                // Push message to Firebase
                db.ref('chat').push({ 
                    user: CURRENT_USER, 
                    text: text, 
                    tag: u.rank, 
                    style: u.style, 
                    color: profile.color || null, 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Trigger bot response
                for (const br of botResponses) {
                    if (br.trigger.test(text)) {
                        setTimeout(() => {
                            db.ref('chat').push({ 
                                user: 'Eric Northman', 
                                text: br.response, 
                                tag: 'BOT', 
                                style: 'bot-style', 
                                isBot: true, 
                                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                        }, 1000 + Math.random() * 1000);
                        break;
                    }
                }
            }
            input.value = "";
        });
    }

    // ADMIN: BOT MESSAGE
    function sendBotMessage() {
        const text = document.getElementById('bot_message').value.trim();
        if (!text) return;
        db.ref('chat').push({ 
            user: 'Eric Northman', 
            text: text, 
            tag: 'BOT', 
            style: 'bot-style', 
            isBot: true, 
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        document.getElementById('bot_message').value = '';
    }

    // ADMIN: PIN MESSAGE
    function pinMessage() {
        const text = document.getElementById('pin_message').value.trim();
        if (!text) return;
        db.ref('pinned').set(text);
        document.getElementById('pin_message').value = '';
    }

    // IMAGE UPLOAD
    function uploadChatImage() {
        if (IS_GUEST) return;
        const file = document.getElementById('chat_image').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            db.ref('pending_images').push({ 
                data: e.target.result, 
                user: CURRENT_USER, 
                id: Date.now(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            alert('Image submitted for approval!');
        };
        reader.readAsDataURL(file);
        document.getElementById('chat_image').value = '';
    }

    function loadPendingImages() {
        const container = document.getElementById('pending_images');
        if (!container) return;
        
        db.ref('pending_images').once('value', (snapshot) => {
            const pending = [];
            snapshot.forEach((child) => {
                pending.push({ ...child.val(), key: child.key });
            });
            
            if (pending.length === 0) { 
                container.innerHTML = '<span style="color:#666; font-size:9px;">None</span>'; 
                return; 
            }
            container.innerHTML = pending.map(p => '<div class="approval-item"><img src="' + p.data + '"><div><div style="color:#d40000; font-size:10px;">' + p.user + '</div><button class="ie-btn" style="padding:2px 6px; font-size:9px; width:auto; margin:2px;" onclick="approveImage(\'' + p.key + '\',\'' + p.user + '\',\'' + p.data.substring(0,50) + '\')">‚úì</button><button class="ie-btn" style="padding:2px 6px; font-size:9px; width:auto; background:#333;" onclick="denyImage(\'' + p.key + '\')">‚úó</button></div></div>').join('');
        });
    }

    function approveImage(key, user, dataPreview) {
        // Get full image data from Firebase
        db.ref('pending_images/' + key).once('value', (snapshot) => {
            const img = snapshot.val();
            if (!img) return;
            
            const u = userDatabase[img.user] || { rank: 'M', style: 'member-style' };
            
            // Add to chat
            db.ref('chat').push({ 
                user: img.user, 
                text: '[Image]', 
                imageData: img.data, 
                tag: u.rank, 
                style: u.style, 
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Remove from pending
            db.ref('pending_images/' + key).remove();
            loadPendingImages();
        });
    }

    function denyImage(key) {
        db.ref('pending_images/' + key).remove();
        loadPendingImages();
    }

    function loadPendingApps() {
        const container = document.getElementById('pending_apps');
        if (!container) return;
        
        db.ref('applications').orderByChild('status').equalTo('pending').once('value', (snapshot) => {
            const apps = [];
            snapshot.forEach((child) => {
                apps.push(child.val());
            });
            
            if (apps.length === 0) { 
                container.innerHTML = '<span style="color:#666; font-size:9px;">No pending applications</span>'; 
                return; 
            }
            
            container.innerHTML = apps.map(a => `
                <div style="border:1px solid #400; padding:8px; margin-bottom:8px; background:#0a0000;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#d40000; font-weight:bold; font-size:11px;">${escapeHtml(a.username)}</span>
                        <span style="color:#555; font-size:8px;">${a.date}</span>
                    </div>
                    <div style="color:#888; font-size:9px; margin:5px 0;">
                        <strong>Referral:</strong> ${escapeHtml(a.referral || 'None')}<br>
                        <strong>Reason:</strong> ${escapeHtml(a.reason)}<br>
                        <strong>Offering:</strong> ${escapeHtml(a.offering || 'None')}
                    </div>
                    <div style="display:flex; gap:5px; margin-top:8px;">
                        <button class="ie-btn" style="padding:3px 12px; font-size:9px; width:auto; background:#050;" onclick="approveApp(${a.id})">‚úì Accept</button>
                        <button class="ie-btn" style="padding:3px 12px; font-size:9px; width:auto; background:#500;" onclick="denyApp(${a.id})">‚úó Deny</button>
                    </div>
                </div>
            `).join('');
        });
    }

    function approveApp(id) {
        db.ref('applications/' + id).update({ status: 'approved' });
        loadPendingApps();
    }

    function denyApp(id) {
        db.ref('applications/' + id).update({ status: 'denied' });
        loadPendingApps();
    }

    // ADMIN FUNCTIONS
    function clearPin() {
        db.ref('pinned').remove();
    }

    function clearChat() {
        if (confirm('Clear ALL chat messages? This cannot be undone.')) {
            db.ref('chat').remove();
        }
    }

    function exportChat() {
        db.ref('chat').orderByChild('timestamp').once('value', (snapshot) => {
            const msgs = [];
            snapshot.forEach((child) => msgs.push(child.val()));
            const text = msgs.map(m => `[${m.time}] ${m.user}: ${m.text}`).join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'fangtasia-chat-' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
        });
    }

    function loadAdminStats() {
        const stats = document.getElementById('admin_stats');
        if (!stats) return;
        
        const visitors = localStorage.getItem('f_visitors') || '0';
        
        // Get counts from Firebase
        Promise.all([
            db.ref('chat').once('value'),
            db.ref('applications').once('value'),
            db.ref('pending_images').once('value'),
            db.ref('members').once('value')
        ]).then(([chatSnap, appsSnap, pendingSnap, membersSnap]) => {
            let chatCount = 0, appCount = 0, pendingAppCount = 0, pendingImgCount = 0, memberCount = 0;
            
            chatSnap.forEach(() => chatCount++);
            appsSnap.forEach((child) => {
                appCount++;
                if (child.val().status === 'pending') pendingAppCount++;
            });
            pendingSnap.forEach(() => pendingImgCount++);
            membersSnap.forEach(() => memberCount++);
            
            stats.innerHTML = `
                Total Messages: ${chatCount}<br>
                Pending Images: ${pendingImgCount}<br>
                Applications: ${appCount} (${pendingAppCount} pending)<br>
                Registered Members: ${memberCount}<br>
                Total Visitors: ${visitors}
            `;
        });
        
        loadBannedUsers();
    }

    // APPLICATION STATUS CHECK
    function checkAppStatus() {
        const username = document.getElementById('app_username').value.trim();
        if (!username) { alert('Enter your username to check status.'); return; }
        
        const resultDiv = document.getElementById('app_result');
        document.getElementById('app_form').style.display = 'none';
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color:#888;">Checking...</div>';
        
        // Search Firebase for application
        db.ref('applications').orderByChild('username').equalTo(username).once('value', (snapshot) => {
            let app = null;
            snapshot.forEach((child) => {
                app = child.val();
            });
            
            if (!app) {
                // Try case-insensitive search
                db.ref('applications').once('value', (allSnap) => {
                    allSnap.forEach((child) => {
                        const a = child.val();
                        if (a.username.toLowerCase() === username.toLowerCase()) {
                            app = a;
                        }
                    });
                    renderAppStatus(app, resultDiv);
                });
            } else {
                renderAppStatus(app, resultDiv);
            }
        });
    }
    
    function renderAppStatus(app, resultDiv) {
        if (!app) {
            resultDiv.innerHTML = '<div class="app-status" style="border-color:#888; color:#888;">No application found for this username.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        } else if (app.status === 'pending') {
            resultDiv.innerHTML = '<div class="app-status app-pending">üïê Your application is pending review.<br><small>Check back soon!</small></div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        } else if (app.status === 'approved') {
            resultDiv.innerHTML = `
                <div class="app-status" style="border-color:#0f0; color:#0f0; margin-bottom:15px;">‚úì Application Approved!</div>
                <h3 style="color:#d40000; margin:0 0 10px 0; font-size:13px;">Complete Registration</h3>
                <input type="text" id="inline_reg_user" class="ie-input" value="${escapeHtml(app.username)}" readonly style="background:#111;">
                <input type="password" id="inline_reg_pass" class="ie-input" placeholder="Choose Password">
                <input type="password" id="inline_reg_pass2" class="ie-input" placeholder="Confirm Password">
                <div style="border:1px dashed #ffd700; padding:6px; margin:8px 0; background:rgba(255,215,0,0.05);">
                    <label style="color:#ffd700; font-size:8px;">üåü VIP Code (optional)</label>
                    <input type="text" id="inline_vip_code" class="ie-input" placeholder="Enter VIP invite code" style="margin:0;">
                </div>
                <button class="ie-btn" onclick="completeInlineRegistration(${app.id})">ü¶á Complete Registration</button>
                <div id="inline_reg_result" style="margin-top:8px;"></div>
            `;
        } else if (app.status === 'denied') {
            resultDiv.innerHTML = '<div class="app-status" style="border-color:#f00; color:#f00;">‚úó Your application was denied.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        } else if (app.status === 'registered') {
            resultDiv.innerHTML = '<div class="app-status" style="border-color:#0f0; color:#0f0;">‚úì Already registered! Please log in via Portal.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        }
    }

    function resetAppForm() {
        document.getElementById('app_form').style.display = 'block';
        document.getElementById('app_result').style.display = 'none';
    }

    function completeInlineRegistration(appId) {
        const username = document.getElementById('inline_reg_user').value.trim();
        const pass = document.getElementById('inline_reg_pass').value;
        const pass2 = document.getElementById('inline_reg_pass2').value;
        const vipCode = document.getElementById('inline_vip_code').value.trim();
        const resultEl = document.getElementById('inline_reg_result');
        
        if (!pass) { resultEl.innerHTML = '<span style="color:#f00;">Enter a password.</span>'; return; }
        if (pass !== pass2) { resultEl.innerHTML = '<span style="color:#f00;">Passwords do not match.</span>'; return; }
        if (pass.length < 6) { resultEl.innerHTML = '<span style="color:#f00;">Password must be 6+ characters.</span>'; return; }
        
        if (userDatabase[username]) {
            resultEl.innerHTML = '<span style="color:#f00;">Username already registered.</span>';
            return;
        }
        
        // Check VIP code if provided (from Firebase)
        if (vipCode) {
            db.ref('vip_codes').orderByChild('code').equalTo(vipCode).once('value', (snapshot) => {
                let codeData = null;
                let codeKey = null;
                snapshot.forEach((child) => {
                    if (!child.val().used) {
                        codeData = child.val();
                        codeKey = child.key;
                    }
                });
                
                if (codeData) {
                    // Mark code as used
                    db.ref('vip_codes/' + codeKey).update({ used: true, usedBy: username });
                    finishRegistration(username, pass, true, appId, resultEl);
                } else {
                    resultEl.innerHTML = '<span style="color:#f00;">Invalid or used VIP code.</span>';
                }
            });
        } else {
            finishRegistration(username, pass, false, appId, resultEl);
        }
    }
    
    function finishRegistration(username, pass, isVIP, appId, resultEl) {
        // Create member data
        let memberData;
        if (isVIP) {
            memberData = { pass: pass, rank: 'VIP', fullRank: 'VIP', style: 'vip-style', target: 'list_vip', isAdmin: false };
        } else {
            memberData = { pass: pass, rank: 'M', fullRank: 'Member', style: 'member-style', target: 'list_member', isAdmin: false };
        }
        
        // Save to Firebase
        db.ref('members/' + username).set(memberData);
        userDatabase[username] = memberData;
        
        // Update application status
        if (appId) {
            db.ref('applications/' + appId).update({ status: 'registered' });
        }
        
        const msg = isVIP ? 'üåü VIP Registration complete!' : '‚úì Registration complete!';
        resultEl.innerHTML = '<span style="color:#0f0;">' + msg + '</span>';
        setTimeout(() => { toggleWin('apply_window'); toggleWin('ie_window'); }, 1500);
    }

    function showRegistration(username) {
        document.getElementById('reg_username').value = username;
        toggleWin('apply_window');
        toggleWin('register_window');
    }

    function completeRegistration() {
        const username = document.getElementById('reg_username').value.trim();
        const pass = document.getElementById('reg_password').value;
        const pass2 = document.getElementById('reg_password2').value;
        const vipCode = document.getElementById('reg_vip_code').value.trim();
        
        if (!username || !pass) { document.getElementById('reg_result').innerHTML = '<span style="color:#f00;">Fill all fields.</span>'; return; }
        if (pass !== pass2) { document.getElementById('reg_result').innerHTML = '<span style="color:#f00;">Passwords do not match.</span>'; return; }
        if (pass.length < 6) { document.getElementById('reg_result').innerHTML = '<span style="color:#f00;">Password must be 6+ characters.</span>'; return; }
        
        // Check if username already exists
        if (userDatabase[username]) {
            document.getElementById('reg_result').innerHTML = '<span style="color:#f00;">Username already taken.</span>';
            return;
        }
        
        // Check VIP code if provided (from Firebase)
        if (vipCode) {
            db.ref('vip_codes').orderByChild('code').equalTo(vipCode).once('value', (snapshot) => {
                let codeData = null;
                let codeKey = null;
                snapshot.forEach((child) => {
                    if (!child.val().used) {
                        codeData = child.val();
                        codeKey = child.key;
                    }
                });
                
                if (codeData) {
                    db.ref('vip_codes/' + codeKey).update({ used: true, usedBy: username });
                    saveNewMember(username, pass, true);
                } else {
                    document.getElementById('reg_result').innerHTML = '<span style="color:#f00;">Invalid or already used VIP code.</span>';
                }
            });
        } else {
            saveNewMember(username, pass, false);
        }
    }
    
    function saveNewMember(username, pass, isVIP) {
        let memberData;
        if (isVIP) {
            memberData = { pass: pass, rank: 'VIP', fullRank: 'VIP', style: 'vip-style', target: 'list_vip', isAdmin: false };
        } else {
            memberData = { pass: pass, rank: 'M', fullRank: 'Member', style: 'member-style', target: 'list_member', isAdmin: false };
        }
        
        db.ref('members/' + username).set(memberData);
        userDatabase[username] = memberData;
        
        const rankMsg = isVIP ? 'üåü VIP Registration complete!' : 'Registration complete!';
        document.getElementById('reg_result').innerHTML = '<span style="color:#0f0;">' + rankMsg + ' You can now log in.</span>';
        setTimeout(() => { toggleWin('register_window'); toggleWin('ie_window'); }, 2000);
    }

    // MODERATION FUNCTIONS
    function executeModAction() {
        const username = document.getElementById('mod_username').value.trim();
        const action = document.getElementById('mod_action').value;
        const duration = parseInt(document.getElementById('mod_duration').value);
        const reason = document.getElementById('mod_reason').value;
        
        if (!username || !action) { document.getElementById('mod_result').innerHTML = '<span style="color:#f00;">Select user and action.</span>'; return; }
        
        // Don't allow moderation of core admins
        const protectedAdmins = ['losersyndicate', 'buttheadandbeav126', 'bloomhouse8483'];
        if (protectedAdmins.includes(username.toLowerCase())) {
            document.getElementById('mod_result').innerHTML = '<span style="color:#f00;">Cannot moderate core admins.</span>';
            return;
        }
        
        const now = Date.now();
        const expiry = duration === 0 ? 0 : now + (duration * 60 * 1000);
        
        if (action === 'kick') {
            document.getElementById('mod_result').innerHTML = '<span style="color:#0f0;">' + username + ' has been kicked.</span>';
        } else if (action === 'timeout') {
            db.ref('bans/' + username).set({ type: 'timeout', expiry: expiry, reason: reason, by: CURRENT_USER });
            document.getElementById('mod_result').innerHTML = '<span style="color:#ffd700;">' + username + ' timed out for ' + (duration === 0 ? 'permanently' : duration + ' mins') + '.</span>';
        } else if (action === 'softban') {
            db.ref('bans/' + username).set({ type: 'softban', expiry: expiry, reason: reason, by: CURRENT_USER });
            document.getElementById('mod_result').innerHTML = '<span style="color:#ff6600;">' + username + ' soft banned (suspended).</span>';
        } else if (action === 'hardban') {
            db.ref('bans/' + username).set({ type: 'hardban', expiry: 0, reason: reason, by: CURRENT_USER });
            db.ref('members/' + username).remove();
            delete userDatabase[username];
            document.getElementById('mod_result').innerHTML = '<span style="color:#f00;">' + username + ' HARD BANNED (account deleted).</span>';
        }
        
        loadBannedUsers();
    }

    function loadBannedUsers() {
        const container = document.getElementById('banned_users');
        if (!container) return;
        
        db.ref('bans').once('value', (snapshot) => {
            const bans = snapshot.val() || {};
            const now = Date.now();
            const activeBans = Object.entries(bans).filter(([u, b]) => b.expiry === 0 || b.expiry > now);
            
            if (activeBans.length === 0) { container.innerHTML = 'None'; return; }
            
            container.innerHTML = activeBans.map(([user, ban]) => {
                const exp = ban.expiry === 0 ? 'Permanent' : new Date(ban.expiry).toLocaleString();
                return '<div style="border-bottom:1px solid #333; padding:3px 0;"><strong>' + user + '</strong> [' + ban.type + '] - ' + exp + ' <button onclick="unbanUser(\'' + user + '\')" style="font-size:8px; padding:1px 4px;">Unban</button></div>';
            }).join('');
        });
    }

    function unbanUser(username) {
        db.ref('bans/' + username).remove();
        loadBannedUsers();
    }

    // Check if current user is banned/timed out
    function checkUserBan() {
        if (!CURRENT_USER) return false;
        const bans = JSON.parse(localStorage.getItem('f_bans') || '{}');
        const ban = bans[CURRENT_USER];
        if (!ban) return false;
        
        const now = Date.now();
        if (ban.expiry !== 0 && ban.expiry < now) {
            // Ban expired, remove it
            delete bans[CURRENT_USER];
            localStorage.setItem('f_bans', JSON.stringify(bans));
            return false;
        }
        
        if (ban.type === 'hardban' || ban.type === 'softban') {
            alert('Your account has been suspended. Reason: ' + (ban.reason || 'No reason given'));
            logout();
            return true;
        }
        
        if (ban.type === 'timeout') {
            return true; // Can view but not send
        }
        
        return false;
    }

    // ST-ONLY: ELEVATE USER
    function elevateUser() {
        if (!userDatabase[CURRENT_USER]?.isST) { alert('Access denied.'); return; }
        const username = document.getElementById('elevate_user').value.trim();
        const newRank = document.getElementById('elevate_rank').value;
        
        if (!username) { alert('Enter username.'); return; }
        if (!userDatabase[username]) { alert('User not found.'); return; }
        
        const rankConfig = {
            'member': { rank: 'M', fullRank: 'Member', style: 'member-style', target: 'list_member', isAdmin: false },
            'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style', target: 'list_vip', isAdmin: false },
            'mod': { rank: 'MOD', fullRank: 'Moderator', style: 'mod-style', target: 'list_mod', isAdmin: true },
            'admin': { rank: 'A', fullRank: 'Admin', style: 'a-style', target: 'list_admin', isAdmin: true }
        };
        
        // Update in Firebase
        db.ref('members/' + username).update(rankConfig[newRank]);
        userDatabase[username] = { ...userDatabase[username], ...rankConfig[newRank] };
        
        alert(username + ' elevated to ' + rankConfig[newRank].fullRank);
    }

    // ST-ONLY: GENERATE VIP CODE
    function generateVIPCode() {
        if (!userDatabase[CURRENT_USER]?.isST) { alert('Access denied.'); return; }
        const code = 'VIP-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        db.ref('vip_codes').push({ code: code, created: Date.now(), createdBy: CURRENT_USER, used: false });
        document.getElementById('vip_code_display').textContent = code;
        loadActiveCodes();
    }

    function loadActiveCodes() {
        const container = document.getElementById('active_codes');
        if (!container) return;
        
        db.ref('vip_codes').orderByChild('used').equalTo(false).once('value', (snapshot) => {
            const codes = [];
            snapshot.forEach((child) => codes.push(child.val().code));
            container.innerHTML = codes.length ? codes.join('<br>') : 'None';
        });
    }

    // VIP IMAGE HOSTING - VIP and Staff only
    function uploadVIPImage() {
        // Verify VIP or staff status
        const user = userDatabase[CURRENT_USER];
        if (!user) { alert('Not logged in.'); return; }
        const isVIPorStaff = user.rank === 'VIP' || user.isAdmin || user.isST;
        if (!isVIPorStaff) { 
            alert('VIP Image Hosting is exclusive to VIP members and staff.'); 
            return; 
        }
        
        const file = document.getElementById('vip_image_picker').files[0];
        if (!file) { alert('Select an image.'); return; }
        if (!file.type.startsWith('image/')) { alert('Images only.'); return; }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const images = JSON.parse(localStorage.getItem('f_vip_images_' + CURRENT_USER) || '[]');
            const id = Date.now().toString(36);
            const imgData = { id: id, data: e.target.result, name: file.name, date: new Date().toLocaleDateString() };
            images.push(imgData);
            localStorage.setItem('f_vip_images_' + CURRENT_USER, JSON.stringify(images.slice(-20))); // Keep last 20
            
            // Create embed link (simulated - in real app would be server URL)
            const embedLink = 'fangtasia.wtf/i/' + CURRENT_USER + '/' + id;
            document.getElementById('vip_image_result').innerHTML = '<div style="background:#111; padding:5px; margin-top:5px;"><span style="color:#0f0; font-size:9px;">Uploaded!</span><br><input type="text" value="' + embedLink + '" style="width:100%; font-size:9px; background:#000; border:1px solid #333; color:#ffd700; padding:2px;" onclick="this.select()"></div>';
            loadVIPGallery();
        };
        reader.readAsDataURL(file);
    }

    function loadVIPGallery() {
        const images = JSON.parse(localStorage.getItem('f_vip_images_' + CURRENT_USER) || '[]');
        const container = document.getElementById('vip_image_gallery');
        if (!container) return;
        container.innerHTML = images.slice(-6).reverse().map(img => '<img src="' + img.data + '" style="width:50px; height:50px; object-fit:cover; border:1px solid #333; margin:2px; cursor:pointer;" onclick="copyImageLink(\'' + img.id + '\')" title="Click to copy link">').join('');
    }

    function copyImageLink(id) {
        const link = 'fangtasia.wtf/i/' + CURRENT_USER + '/' + id;
        navigator.clipboard.writeText(link).then(() => alert('Link copied: ' + link));
    }

    // PREV PAGE FOR MEMORIES
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderMemories();
        }
    }

    // Setup real-time chat listener
    let chatListenerSet = false;
    function setupChatListener() {
        if (chatListenerSet) return;
        chatListenerSet = true;
        
        db.ref('chat').orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
            const logs = document.getElementById('chat_logs');
            if (!logs) return;
            
            const msgs = [];
            snapshot.forEach((child) => {
                msgs.push(child.val());
            });
            
            // Get pinned message
            db.ref('pinned').once('value', (pinSnap) => {
                const pinned = pinSnap.val();
                const pinnedContainer = document.getElementById('pinned_container');
                if (pinnedContainer) {
                    pinnedContainer.innerHTML = pinned ? '<div class="pinned-msg"><span style="color:#ffd700; font-size:8px;">üìå PINNED</span><br>' + escapeHtml(pinned) + '</div>' : '';
                }
            });
            
            logs.innerHTML = msgs.map(m => {
                if (m.isAction) {
                    return '<div class="chat-action" style="padding:4px 0; font-size:11px;">* ' + escapeHtml(m.text) + '</div>';
                }
                const botClass = m.isBot ? ' chat-bot' : '';
                const imgHtml = m.imageData ? '<img class="chat-image" src="' + m.imageData + '">' : '';
                return '<div class="chat-entry' + botClass + '"><div class="chat-header"><span class="rank-tag ' + m.style + '">' + m.tag + '</span><span class="chat-username ' + m.style + '" onclick="showProfileCard(\'' + m.user + '\', event)" style="' + (m.color ? 'color:' + m.color + ' !important;' : '') + '">' + m.user + '</span><span style="color:#444; font-size:8px; margin-left:auto;">' + (m.time || '') + '</span></div><div style="color:#ccc; font-size:11px; padding-left:30px;">' + escapeHtml(m.text) + imgHtml + '</div></div>';
            }).join('');
            logs.scrollTop = logs.scrollHeight;
        });
    }

    function loadMessages() {
        setupChatListener();
    }

    function updateMemberList() {
        document.getElementById('list_technician').innerHTML = "";
        document.getElementById('list_admin').innerHTML = "";
        document.getElementById('list_mod').innerHTML = "";
        document.getElementById('list_vip').innerHTML = "";
        document.getElementById('list_member').innerHTML = "";
        if(!CURRENT_USER || IS_GUEST) return;
        const u = userDatabase[CURRENT_USER];
        const profile = JSON.parse(localStorage.getItem('f_profile_' + CURRENT_USER) || '{}');
        document.getElementById(u.target).innerHTML = `
            <div class="member-item ${u.style}">
                <span style="font-size: 14px;">ü¶á</span> ${CURRENT_USER}
                ${profile.status ? `<div style="font-size:9px; color:#666; margin-left:20px;">${escapeHtml(profile.status)}</div>` : ''}
            </div>`;
    }

    async function processIEUpload() {
        const fileInput = document.getElementById('ie_file_picker');
        const name = document.getElementById('ie_filename').value || "Video";
        if(!fileInput.files[0]) return;
        document.getElementById('upload_status').innerText = "Syncing...";
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('upload_preset', UPLOAD_PRESET);
        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: 'POST', body: formData });
            const data = await res.json();
            if (res.ok) {
                // Save to Firebase
                db.ref('archive').push({ 
                    name, 
                    url: data.secure_url, 
                    uploader: CURRENT_USER,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                renderMemories();
                document.getElementById('upload_status').innerText = "Push to Cloud";
                document.getElementById('ie_filename').value = "";
                fileInput.value = "";
            }
        } catch (e) { alert("Error."); }
    }

    function renderMemories() {
        const grid = document.getElementById('memories_grid');
        grid.innerHTML = "";
        
        db.ref('archive').orderByChild('timestamp').once('value', (snapshot) => {
            const archive = [];
            snapshot.forEach((child) => archive.push(child.val()));
            
            const totalPages = Math.ceil(archive.length / itemsPerPage) || 1;
            
            // Update page indicator
            const indicator = document.getElementById('page_indicator');
            if (indicator) indicator.textContent = 'Page ' + currentPage + ' of ' + totalPages;
            
            if (archive.length === 0) {
                grid.innerHTML = '<p style="color: #555; text-align: center; grid-column: 1/-1; padding: 40px;">No memories archived yet...</p>';
                return;
            }
            
            const start = (currentPage - 1) * itemsPerPage;
            archive.slice(start, start + itemsPerPage).forEach(mem => {
                const div = document.createElement('div');
                div.className = "icon";
                div.innerHTML = `<div onclick="spawnVideoWindow('${escapeHtml(mem.name)}', '${mem.url}')">
                    <img class="video-icon" src="https://win98icons.alexmeub.com/icons/png/video_file-0.png">
                    <div style="font-size:10px;">${escapeHtml(mem.name)}</div>
                    <div style="font-size:8px; color:#666;">${escapeHtml(mem.uploader)}</div>
                </div>`;
                grid.appendChild(div);
            });
        });
    }

    function nextPage() {
        db.ref('archive').once('value', (snapshot) => {
            let count = 0;
            snapshot.forEach(() => count++);
            const totalPages = Math.ceil(count / itemsPerPage) || 1;
            if (currentPage < totalPages) {
                currentPage++;
                renderMemories();
            }
        });
    }

    function spawnVideoWindow(name, url) {
        const id = 'v_' + Date.now();
        const win = document.createElement('div');
        win.className = 'window'; win.id = id; win.style.display = 'block';
        win.style.left = (150 + Math.random() * 100) + 'px'; 
        win.style.top = (100 + Math.random() * 50) + 'px'; 
        win.style.width = '520px'; win.style.height = '420px';
        win.innerHTML = `<div class="title-bar"><div class="title-bar-text">‚ñ∂ ${name}</div><div class="title-bar-controls"><button aria-label="Close" onclick="document.getElementById('${id}').remove()"></button></div></div>
            <div class="window-body"><video src="${url}" controls autoplay style="width:100%; height:100%; background:#000;"></video></div>`;
        document.body.appendChild(win);
        makeDraggable(id);
    }

    function toggleWin(id) {
        let el = document.getElementById(id);
        if (!el) return;
        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        if(el.style.display === 'block') { 
            document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); 
            el.style.zIndex = "200"; 
        }
        if (id === 'admin_window') { loadPendingImages(); loadPendingApps(); loadAdminStats(); loadActiveCodes(); }
    }

    function makeDraggable(winId) {
        const win = document.getElementById(winId);
        const header = win.querySelector('.title-bar');
        header.onmousedown = (e) => {
            document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); 
            win.style.zIndex = "400";
            let oX = e.clientX - win.offsetLeft, oY = e.clientY - win.offsetTop;
            document.onmousemove = (e) => { 
                win.style.left = (e.clientX - oX) + 'px'; 
                win.style.top = (e.clientY - oY) + 'px'; 
            };
            document.onmouseup = () => document.onmousemove = null;
        };
    }

    ['ie_window', 'memories_folder', 'chat_win', 'about_window', 'games_window', 'apply_window', 'admin_window', 'register_window'].forEach(id => {
        const el = document.getElementById(id);
        if (el) makeDraggable(id);
    });
    
    function beginSession() { 
        document.getElementById('boot-screen').style.display = 'none'; 
        if(player) { player.unMute(); player.playVideo(); } 
    }
    
    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', { 
            videoId: 'Bi5kyehmeaY', 
            playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'Bi5kyehmeaY', 'controls': 0 }, 
            events: { 'onReady': (e) => e.target.mute() } 
        });
    }
    function pauseMusic() { if(player) player.pauseVideo(); }
    function playMusic() { if(player) player.playVideo(); }

    // Real-time refresh for admin panel
    function refreshAdminIfOpen() {
        const adminWin = document.getElementById('admin_window');
        if (adminWin && adminWin.style.display === 'block') {
            loadPendingApps();
            loadPendingImages();
            loadAdminStats();
        }
    }

    window.addEventListener('load', () => { 
        renderMemories(); 
        updateVisitorCount();
        initStakesGame();
        // Real-time chat refresh (every 1 second)
        setInterval(loadMessages, 1000);
        // Real-time admin panel refresh (every 2 seconds)
        setInterval(refreshAdminIfOpen, 2000);
    });
</script>
</body>
</html>
