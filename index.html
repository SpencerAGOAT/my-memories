<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>fangtasia.wtf</title>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/7.css">
    <style>
        :root { --vamp-red: #8b0000; --glass: rgba(15, 0, 0, 0.9); --neon-pink: #ff00ff; }
        .bat-cursor { position: fixed; width: 32px; height: 32px; pointer-events: none; z-index: 99999; transform: translate(-50%, -50%); }
        .bat-cursor svg { width: 100%; height: 100%; filter: drop-shadow(0 0 3px rgba(139, 0, 0, 0.8)); }
        .bat-cursor .wing-left, .bat-cursor .wing-right { transform-origin: center; animation: flapWings 0.15s ease-in-out infinite alternate; }
        .bat-cursor .wing-right { animation-delay: 0.075s; }
        @keyframes flapWings { 0% { transform: scaleX(1) rotate(0deg); } 100% { transform: scaleX(0.85) rotate(-8deg); } }
        * { cursor: none !important; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: black; overflow: hidden; }
        body { background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://cdn.discordapp.com/attachments/1459009893540434114/1463462838659186875/IMG_9667.jpg?ex=6971eb7a&is=697099fa&hm=be1f64186d5b932c2dc640bd86f5d9bea844d381648c55f880790a02a561f6f9&'); background-size: cover; background-position: center; font-family: "Segoe UI", Tahoma, sans-serif; }
        #boot-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #d40000; }
        .boot-title { font-size: 60px; animation: bloodPulse 2s ease-in-out infinite; text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); }
        @keyframes bloodPulse { 0%, 100% { text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); } 50% { text-shadow: 0 0 30px rgba(212, 0, 0, 0.8), 0 0 60px rgba(212, 0, 0, 0.5); } }
        .boot-subtitle { animation: flicker 3s infinite; margin-top: 20px; }
        @keyframes flicker { 0%, 100% { opacity: 1; } 93% { opacity: 0.3; } 94% { opacity: 1; } 96% { opacity: 0.5; } }
        @keyframes batFloat { 0%, 100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-15px) rotate(5deg); } }
        #desktop { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; padding: 25px; height: calc(100vh - 40px); gap: 20px; }
        .icon { width: 110px; text-align: center; color: white; text-shadow: 1px 1px 3px black; font-size: 11px; z-index: 5; margin-bottom: 15px; transition: transform 0.2s, filter 0.2s; }
        .icon:hover { transform: scale(1.1); filter: brightness(1.2); }
        .icon img.folder-icon { width: 44px; display: block; margin: 0 auto 6px; filter: grayscale(0.3) sepia(1) saturate(35) hue-rotate(320deg) brightness(0.55) contrast(1.5); }
        .window { position: absolute; background: #0d0d0d !important; border: 1px solid #700000 !important; box-shadow: 0 15px 40px rgba(0,0,0,1), 0 0 30px rgba(139, 0, 0, 0.2); display: none; z-index: 10; overflow: hidden; resize: both; }
        .title-bar { background: linear-gradient(to bottom, #8b0000, #2a0000) !important; }
        .window-body { height: calc(100% - 32px); padding: 0; background: black; overflow: auto; }
        .chat-container { display: flex; height: 420px; background: #050000; border-bottom: 1px solid #400; }
        #chat_logs { flex: 1; overflow-y: scroll; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        .chat-entry { display: flex; flex-direction: column; gap: 2px; }
        .chat-header { display: flex; align-items: center; gap: 8px; }
        .rank-tag { font-size: 9px; font-weight: bold; padding: 1px 4px; border-radius: 2px; border: 1px solid; text-transform: uppercase; min-width: 25px; text-align: center; }
        #member_list { width: 180px; border-left: 1px solid #400; padding: 12px; background: #0a0000; overflow-y: auto; }
        .member-category { color: #d40000; font-size: 14px; font-weight: bold; margin-top: 15px; border-bottom: 1px solid #400; text-transform: uppercase; padding-bottom: 4px; }
        .member-item { font-size: 14px; font-weight: bold; margin-top: 6px; cursor: pointer; padding: 3px 5px; border-radius: 3px; transition: all 0.2s; }
        .member-item:hover { background: rgba(139, 0, 0, 0.3); }
        .st-style { color: #ff00ff; border-color: #ff00ff; }
        .a-style { color: #ffffff; border-color: #ffffff; }
        .mod-style { color: #00ff00; border-color: #00ff00; }
        .guest-style { color: #888; border-color: #555; }
        .vip-style { color: #ffd700; border-color: #ffd700; }
        .member-style { color: #ff4444; border-color: #ff4444; }
        .bot-style { color: #d40000; border-color: #d40000; }
        #memories_grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; justify-items: center; }
        .pagination-bar { padding: 10px; background: #111; border-top: 1px solid #400; text-align: center; }
        .ie-content { padding: 15px; color: #d40000; }
        .ie-input { width: 100%; background: #111; color: #ff0000; border: 1px solid #700000; padding: 6px; margin-bottom: 12px; font-size: 11px; box-sizing: border-box; }
        .ie-input:focus { outline: none; border-color: #ff0000; }
        .ie-btn { background: #500; color: white; border: 1px solid #f00; padding: 8px; width: 100%; font-weight: bold; margin-bottom: 5px; transition: all 0.2s; }
        .ie-btn:hover { background: #700; }
        .lounge-entry-btn { background: linear-gradient(#222, #000); border: 1px solid #ff00ff; color: #ff00ff; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 20px; font-size: 11px; text-transform: uppercase; }
        .guest-section { border-top: 1px solid #400; margin-top: 20px; padding-top: 15px; }
        .guest-btn { background: linear-gradient(#1a1a1a, #0a0a0a); border: 1px solid #444; color: #888; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 8px; font-size: 11px; text-transform: uppercase; }
        .visitor-counter { background: #000; border: 1px solid #400; padding: 8px 15px; display: inline-block; font-family: 'Courier New', monospace; color: #0f0; font-size: 14px; }
        .color-picker-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .color-swatch { width: 24px; height: 24px; border: 2px solid #333; transition: all 0.2s; cursor: pointer; }
        .color-swatch:hover { transform: scale(1.2); border-color: #fff; }
        .color-swatch.selected { border-color: #fff; box-shadow: 0 0 8px currentColor; }
        .taskbar { position: fixed; bottom: 0; width: 100%; height: 40px; background: var(--glass); border-top: 1px solid rgba(255,0,0,0.3); display: flex; align-items: center; z-index: 100; }
        .music-ctrl { width: 22px; filter: invert(1) sepia(1) saturate(10) hue-rotate(330deg); opacity: 0.8; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #0a0000; }
        ::-webkit-scrollbar-thumb { background: #400; border: 1px solid #600; }
        #screensaver { position: fixed; inset: 0; background: black; z-index: 99998; display: none; overflow: hidden; }
        .screensaver-bat { position: absolute; font-size: 30px; }
        @keyframes flyAround { 0% { transform: translate(0, 0); } 25% { transform: translate(80vw, 20vh); } 50% { transform: translate(40vw, 80vh); } 75% { transform: translate(10vw, 50vh); } 100% { transform: translate(0, 0); } }
        .profile-card { position: fixed; width: 340px; max-height: 600px; background: linear-gradient(135deg, #1a0000, #0a0000); border: 2px solid #700; box-shadow: 0 10px 40px rgba(0,0,0,0.9); z-index: 9000; display: none; overflow-y: auto; }
        .profile-card-header { display: flex; align-items: center; gap: 12px; padding: 15px; background: linear-gradient(180deg, #200000, #100000); border-bottom: 1px solid #500; }
        .profile-card-avatar { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; font-size: 35px; border: 3px solid #700; flex-shrink: 0; }
        .profile-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-card-name { font-weight: bold; font-size: 16px; }
        .profile-card-title { font-size: 10px; color: #888; margin-top: 2px; }
        .profile-card-bio { font-size: 11px; color: #aaa; padding: 12px 15px; border-bottom: 1px solid #300; line-height: 1.5; }
        .profile-card-btn { background: #500; color: #fff; border: 1px solid #800; padding: 6px 12px; font-size: 10px; cursor: pointer; }
        .chat-action { color: #888; font-style: italic; }
        .chat-bot { background: rgba(139, 0, 0, 0.1); border-left: 2px solid #8b0000; padding: 6px; margin: 4px 0; }
        .pinned-msg { background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; padding: 6px; margin-bottom: 8px; font-size: 10px; }
        .chat-image { max-width: 150px; max-height: 100px; border: 1px solid #400; margin-top: 4px; }
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #400; }
        .tab { padding: 6px 12px; color: #666; font-size: 10px; border-right: 1px solid #333; cursor: pointer; }
        .tab.active { background: #0a0000; color: #d40000; }
        .admin-section { margin-bottom: 12px; }
        .admin-section h4 { color: #d40000; margin-bottom: 6px; font-size: 12px; }
        .typing-indicator { display: flex; gap: 4px; padding: 8px 12px; color: #666; font-size: 11px; font-style: italic; }
        .typing-dot { width: 6px; height: 6px; background: #d40000; border-radius: 50%; animation: typingBounce 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }
        .chat-username { cursor: pointer; transition: all 0.2s; }
        .chat-username:hover { text-decoration: underline; text-shadow: 0 0 8px currentColor; }
        .app-status { padding: 8px; margin-top: 8px; border: 1px solid; font-size: 10px; }
        .app-pending { border-color: #ffd700; color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .stakes-grid { display: grid; grid-template-columns: repeat(9, 26px); gap: 1px; justify-content: center; }
        .stakes-cell { width: 26px; height: 26px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .stakes-cell.revealed { background: #111; }
        .stakes-cell.stake { background: #500; }
        .game-status { text-align: center; margin: 8px 0; color: #d40000; font-size: 11px; }
        /* MOBILE */
        @media screen and (max-width: 900px) {
            * { cursor: auto !important; }
            .bat-cursor { display: none !important; }
            #desktop { padding: 10px; gap: 10px; flex-direction: row; flex-wrap: wrap; justify-content: center; }
            .icon { width: 70px; margin-bottom: 5px; }
            .icon img.folder-icon { width: 36px; }
            .window { left: 5px !important; top: 50px !important; width: calc(100vw - 10px) !important; height: calc(100vh - 100px) !important; resize: none !important; }
            .chat-container { flex-direction: column; height: auto !important; max-height: 50vh; }
            #chat_logs { height: 200px; min-height: 200px; }
            #member_list { width: 100% !important; border-left: none !important; border-top: 1px solid #400; max-height: 150px; }
            .profile-card { left: 10px !important; top: 60px !important; width: calc(100vw - 20px) !important; max-height: 70vh !important; }
            .boot-title { font-size: 36px; }
            #chat_avatar { padding: 10px !important; }
            #chat_avatar > div:first-child { flex-direction: column; align-items: center; }
            #chat_avatar div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
            .color-picker-row { justify-content: center; }
            .taskbar { height: 35px; }
            #memories_grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; padding: 10px !important; }
            .stakes-grid { grid-template-columns: repeat(9, 22px) !important; }
            .stakes-cell { width: 22px !important; height: 22px !important; font-size: 10px !important; }
            .ie-input { padding: 8px; font-size: 14px; }
            .ie-btn { padding: 10px; font-size: 12px; }
        }
        @media screen and (max-width: 500px) {
            .boot-title { font-size: 28px; }
            #memories_grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
<div class="bat-cursor" id="batCursor">
    <svg viewBox="0 0 32 32" fill="#8b0000">
        <g class="wing-left"><path d="M16 14 L8 8 L6 12 L10 14 L6 16 L4 14 L2 18 L8 18 L12 16 L16 16 Z"/></g>
        <g class="wing-right"><path d="M16 14 L24 8 L26 12 L22 14 L26 16 L28 14 L30 18 L24 18 L20 16 L16 16 Z"/></g>
        <ellipse cx="16" cy="16" rx="4" ry="5"/><circle cx="16" cy="11" r="3"/>
        <circle cx="15" cy="10" r="0.8" fill="#ff0000"/><circle cx="17" cy="10" r="0.8" fill="#ff0000"/>
    </svg>
</div>
<div id="screensaver"></div>
<div class="profile-card" id="profile_card">
    <div class="profile-card-header">
        <div class="profile-card-avatar" id="pc_avatar">ğŸ¦‡</div>
        <div style="flex:1;">
            <div class="profile-card-name" id="pc_name">Username</div>
            <div class="profile-card-title" id="pc_title">Member</div>
            <div id="pc_status" style="color:#888; font-size:10px; margin-top:4px;"></div>
            <div id="pc_mood" style="color:#666; font-size:9px; margin-top:2px;"></div>
        </div>
    </div>
    <div style="display:flex; padding:10px 15px; gap:20px; border-bottom:1px solid #300; background:#0a0000;">
        <div style="text-align:center; flex:1;"><div id="pc_rep" style="color:#ff4444; font-size:18px; font-weight:bold;">0</div><div style="color:#666; font-size:8px;">REPUTATION</div></div>
        <div style="text-align:center; flex:1;"><div id="pc_comment_count" style="color:#ff4444; font-size:18px; font-weight:bold;">0</div><div style="color:#666; font-size:8px;">COMMENTS</div></div>
    </div>
    <div class="profile-card-bio" id="pc_bio">No bio set.</div>
    <div id="pc_music_section" style="display:none; padding:10px 15px; border-bottom:1px solid #300;"><div style="color:#888; font-size:9px; margin-bottom:5px;">ğŸµ Profile Music</div><div id="pc_music_player"></div></div>
    <div id="pc_comments_list" style="padding:10px 15px; max-height:120px; overflow-y:auto; border-bottom:1px solid #300;"><div style="color:#555; font-size:10px;">No comments yet.</div></div>
    <div style="padding:10px 15px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="profile-card-btn" onclick="openDM(currentProfileUser)">ğŸ’¬ Message</button>
        <button class="profile-card-btn" id="btn_rep_pos" style="background:#030; border-color:#070; display:none;" onclick="giveRep(1)">ğŸ‘ +Rep</button>
        <button class="profile-card-btn" id="btn_rep_neg" style="background:#300; border-color:#700; display:none;" onclick="giveRep(-1)">ğŸ‘ -Rep</button>
    </div>
    <div style="padding:10px 15px; border-top:1px solid #300;">
        <input type="text" id="profile_comment_input" class="ie-input" placeholder="Leave a comment..." style="margin-bottom:5px; padding:6px; font-size:10px;">
        <button class="ie-btn" style="padding:6px; font-size:10px;" onclick="leaveProfileComment()">Post Comment</button>
    </div>
    <button class="profile-card-btn" style="margin:10px 15px; width:calc(100% - 30px);" onclick="closeProfileCard()">Close</button>
</div>
<div id="boot-screen" onclick="beginSession()">
    <div style="font-size: 80px; margin-bottom: 20px; animation: batFloat 3s ease-in-out infinite;">ğŸ¦‡</div>
    <h1 class="boot-title">fangtasia.wtf</h1>
    <p class="boot-subtitle">Click anywhere to enter the crypt...</p>
    <div style="margin-top: 30px;"><div class="visitor-counter">SOULS COLLECTED: <span id="visitor_count">000000</span></div></div>
    <div style="margin-top: 40px; color: #500; font-size: 10px; animation: flicker 3s infinite;">â–¼ CLICK TO INITIALIZE â–¼</div>
</div>
<div id="desktop">
    <div class="icon" onclick="toggleWin('memories_folder')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png"><div>Memories</div></div>
    <div class="icon" onclick="toggleWin('ie_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/msie1-2.png"><div>Portal</div></div>
    <div class="icon" onclick="toggleWin('games_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/joystick-2.png"><div>Games</div></div>
    <div class="icon" onclick="toggleWin('apply_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/keys-0.png"><div>Apply</div></div>
    <div class="icon" onclick="toggleWin('about_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/help_book_cool-4.png"><div>About</div></div>
    <div class="icon" id="admin_icon" style="display:none;" onclick="toggleWin('admin_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/lock-0.png"><div>Admin Panel</div></div>
</div>
<div class="window" id="about_window" style="left:200px; top:120px; width:350px; height:320px;">
    <div class="title-bar"><div class="title-bar-text">About fangtasia.wtf</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('about_window')"></button></div></div>
    <div class="window-body"><div class="ie-content" style="text-align: center;"><h2 style="font-size: 28px; margin-bottom: 5px;">fangtasia.wtf</h2><p style="color: #666; font-size: 10px;">Version 6.66</p><div style="border: 1px solid #400; padding: 15px; margin: 15px 0; text-align: left; background: #050000;"><p style="color: #999; font-size: 11px; line-height: 1.6;">Welcome to the digital crypt.<br><br>ğŸ¦‡ <span style="color:#d40000;">Memories</span> - Video archive<br>ğŸ¦‡ <span style="color:#d40000;">Portal</span> - Member access<br>ğŸ¦‡ <span style="color:#d40000;">Games</span> - Silver Stakes<br>ğŸ¦‡ <span style="color:#d40000;">The Lounge</span> - Members only</p></div></div></div>
</div>
<div class="window" id="games_window" style="left:180px; top:70px; width:320px; height:400px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ® Silver Stakes</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('games_window')"></button></div></div>
    <div class="window-body"><div style="padding: 10px;"><h3 style="color: #d40000; text-align: center; margin: 5px 0;">Silver Stakes</h3><p style="color: #666; font-size: 9px; text-align: center;">Avoid the stakes!</p><div class="game-status" id="game_status">ğŸ¦‡ Stakes: 10</div><div class="stakes-grid" id="stakes_grid"></div><div style="text-align: center; margin-top: 8px;"><button class="ie-btn" style="width: auto; padding: 4px 15px;" onclick="initStakesGame()">New Game</button></div></div></div>
</div>
<div class="window" id="apply_window" style="left:160px; top:90px; width:340px; height:440px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ”‘ Apply for Access</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('apply_window')"></button></div></div>
    <div class="window-body"><div class="ie-content"><h2 style="margin-top: 0; font-size: 18px;">Join the Coven</h2><div id="app_form"><input type="text" id="app_username" class="ie-input" placeholder="Desired Username" maxlength="20"><input type="text" id="app_referral" class="ie-input" placeholder="Who referred you?"><textarea id="app_reason" class="ie-input" placeholder="Why do you seek entry?" style="height: 60px; resize: none;"></textarea><button class="ie-btn" onclick="submitApplication()">ğŸ©¸ Submit Blood Pact</button><button class="ie-btn" style="background: #333; margin-top: 5px;" onclick="checkAppStatus()">Check Status</button></div><div id="app_result" style="display: none;"></div></div></div>
</div>
<div class="window" id="chat_win" style="left:400px; top:30px; width:820px; height:620px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ©¸ The Lounge</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('chat_win')"></button></div></div>
    <div class="window-body">
        <div class="tab-bar"><div class="tab active" onclick="switchChatTab('main', this)">ğŸ’¬ Lounge</div><div class="tab" onclick="switchChatTab('avatar', this)">ğŸ¦‡ My Profile</div></div>
        <div id="chat_main">
            <div id="pinned_container"></div>
            <div class="chat-container" id="chat_container">
                <div id="chat_logs"></div>
                <div id="member_list">
                    <div style="color:#0f0; font-size:10px; text-align:center; padding:5px; background:#001100; margin-bottom:10px;">â— ONLINE NOW</div>
                    <div id="online_users"></div>
                    <div style="border-top:1px solid #400; margin-top:15px; padding-top:10px;">
                        <div class="member-category">Site Technician</div><div id="list_technician"></div>
                        <div class="member-category">Admins</div><div id="list_admin"></div>
                        <div class="member-category">Moderators</div><div id="list_mod"></div>
                        <div class="member-category">VIP</div><div id="list_vip"></div>
                        <div class="member-category">Members</div><div id="list_member"></div>
                    </div>
                </div>
            </div>
            <div id="typing_area" style="padding: 5px 12px; background: #080000; display: none;"><div class="typing-indicator"><span id="typing_user"></span>&nbsp;is typing<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
            <div style="padding:10px; background:#111;">
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input type="text" id="chat_input" class="ie-input" style="margin:0; flex:1;" placeholder="/help for commands..." onkeypress="handleChatKey(event)" onkeyup="handleTyping()">
                    <label class="ie-btn" style="width: 35px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">ğŸ“·<input type="file" id="chat_image" accept="image/*" style="display:none;" onchange="uploadChatImage()"></label>
                </div>
                <button class="ie-btn" onclick="sendChat()">Send</button>
            </div>
        </div>
        <div id="chat_avatar" style="display: none; padding: 20px; overflow-y: auto; height: calc(100% - 40px);">
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="text-align:center;">
                    <div id="my_avatar_display" style="width:120px; height:120px; border-radius:50%; background:#111; border:3px solid #700; display:flex; align-items:center; justify-content:center; font-size:60px; overflow:hidden; margin:0 auto;">ğŸ¦‡</div>
                    <div id="my_username_display" style="color:#d40000; font-size:18px; font-weight:bold; margin-top:10px;"></div>
                    <div id="my_rank_display" style="color:#888; font-size:12px;"></div>
                </div>
                <div style="flex:1;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Edit Profile</h3>
                    <label style="color:#888; font-size:10px;">Profile Picture URL</label>
                    <input type="text" id="avatar_url" class="ie-input" placeholder="Paste image URL">
                    <label style="color:#888; font-size:10px;">Or Upload Image</label>
                    <input type="file" id="avatar_upload" class="ie-input" accept="image/*" style="border:none; padding:5px 0;">
                    <button class="ie-btn" style="padding:8px; margin-bottom:15px;" onclick="updateAvatar()">Update Avatar</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <label style="color:#888; font-size:10px;">Profile Music (SoundCloud/Spotify URL)</label>
                    <input type="text" id="profile_music" class="ie-input" placeholder="https://soundcloud.com/...">
                    <button class="ie-btn" style="padding:8px;" onclick="updateProfileMusic()">Set Music</button>
                    <label style="color:#888; font-size:10px; margin-top:15px; display:block;">Name Color</label>
                    <div class="color-picker-row">
                        <div class="color-swatch" style="background:#ff0000;" data-color="#ff0000" onclick="selectColor(this)"></div>
                        <div class="color-swatch" style="background:#ff00ff;" data-color="#ff00ff" onclick="selectColor(this)"></div>
                        <div class="color-swatch" style="background:#00ff00;" data-color="#00ff00" onclick="selectColor(this)"></div>
                        <div class="color-swatch" style="background:#00ffff;" data-color="#00ffff" onclick="selectColor(this)"></div>
                        <div class="color-swatch" style="background:#ffd700;" data-color="#ffd700" onclick="selectColor(this)"></div>
                        <div class="color-swatch" style="background:#ff6600;" data-color="#ff6600" onclick="selectColor(this)"></div>
                        <div class="color-swatch" style="background:#ff69b4;" data-color="#ff69b4" onclick="selectColor(this)"></div>
                        <div class="color-swatch" style="background:#ffffff;" data-color="#ffffff" onclick="selectColor(this)"></div>
                    </div>
                </div>
                <div>
                    <label style="color:#888; font-size:10px;">Mood Status</label>
                    <select id="user_mood" class="ie-input" onchange="saveProfile()">
                        <option value="">None</option><option value="ğŸ©¸ Thirsty">ğŸ©¸ Thirsty</option><option value="ğŸ˜´ Dormant">ğŸ˜´ Dormant</option><option value="ğŸŒ™ Hunting">ğŸŒ™ Hunting</option><option value="âš°ï¸ Resting">âš°ï¸ Resting</option><option value="ğŸ¦‡ Lurking">ğŸ¦‡ Lurking</option><option value="ğŸ”¥ Vibing">ğŸ”¥ Vibing</option><option value="ğŸ’€ Dead Inside">ğŸ’€ Dead Inside</option>
                    </select>
                    <label style="color:#888; font-size:10px;">Custom Status</label>
                    <input type="text" id="user_status" class="ie-input" placeholder="What's happening..." maxlength="30">
                    <label style="color:#888; font-size:10px;">Bio</label>
                    <textarea id="user_bio" class="ie-input" placeholder="Tell us about yourself..." maxlength="200" style="height:80px; resize:none;"></textarea>
                </div>
            </div>
            <button class="ie-btn" style="margin-top:20px; padding:12px; background:#700;" onclick="saveProfile()">ğŸ’¾ Save All Changes</button>
        </div>
    </div>
</div>
<div class="window" id="admin_window" style="left:300px; top:60px; width:480px; height:580px; display:none;">
    <div class="title-bar"><div class="title-bar-text">ğŸ‘‘ Admin Control Panel</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('admin_window')"></button></div></div>
    <div class="window-body" style="overflow-y: auto;"><div class="ie-content">
        <div class="admin-section"><h4>ğŸ–¼ï¸ Pending Images</h4><div id="pending_images">None</div></div>
        <div class="admin-section"><h4>ğŸ“ Applications</h4><div id="pending_apps">None</div></div>
        <div class="admin-section"><h4>âš ï¸ User Moderation</h4>
            <input type="text" id="mod_username" class="ie-input" placeholder="Username...">
            <select id="mod_action" class="ie-input"><option value="">Select Action...</option><option value="kick">Kick</option><option value="timeout">Timeout</option><option value="softban">Soft Ban</option><option value="hardban">Hard Ban</option></select>
            <select id="mod_duration" class="ie-input"><option value="5">5 minutes</option><option value="30">30 minutes</option><option value="60">1 hour</option><option value="1440">24 hours</option><option value="0">Permanent</option></select>
            <button class="ie-btn" style="background: #800;" onclick="executeModAction()">Execute</button>
            <div id="mod_result" style="margin-top: 5px; font-size: 10px;"></div>
        </div>
        <div class="admin-section"><h4>ğŸ“Œ Announcement</h4><input type="text" id="pin_message" class="ie-input" placeholder="Message to pin..."><button class="ie-btn" onclick="pinMessage()">Pin</button><button class="ie-btn" style="background: #333;" onclick="clearPin()">Clear</button></div>
        <div class="admin-section"><h4>ğŸ§› Eric Northman Bot</h4><input type="text" id="bot_message" class="ie-input" placeholder="Eric says..."><button class="ie-btn" onclick="sendBotMessage()">Send as Eric</button></div>
        <div class="admin-section"><h4>ğŸ—‘ï¸ Chat Management</h4><button class="ie-btn" style="background: #500;" onclick="clearChat()">Clear All Messages</button></div>
        <div class="admin-section" id="st_section" style="display:none; border: 1px solid #ff00ff; padding: 10px; margin-top: 10px;">
            <h4 style="color: #ff00ff;">ğŸ”® Site Technician Only</h4>
            <input type="text" id="elevate_user" class="ie-input" placeholder="Username">
            <select id="elevate_rank" class="ie-input"><option value="member">Member</option><option value="vip">VIP</option><option value="mod">Moderator</option><option value="admin">Admin</option></select>
            <button class="ie-btn" onclick="elevateUser()">Elevate</button>
        </div>
    </div></div>
</div>
<div class="window" id="memories_folder" style="left:50px; top:50px; width:550px; height:580px;">
    <div class="title-bar"><div class="title-bar-text">C:\Memories</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('memories_folder')"></button></div></div>
    <div class="window-body" style="display:flex; flex-direction:column; height:100%;">
        <div id="memories_grid" style="flex:1; overflow-y:auto;"></div>
        <div class="pagination-bar" style="display:flex; justify-content:center; gap:10px;">
            <button class="ie-btn" style="width:auto; padding: 4px 20px;" onclick="prevPage()">< Prev</button>
            <span id="page_indicator" style="color:#888; font-size:11px; line-height:28px;">Page 1</span>
            <button class="ie-btn" style="width:auto; padding: 4px 20px;" onclick="nextPage()">Next ></button>
        </div>
    </div>
</div>
<div class="window" id="ie_window" style="left:120px; top:80px; width:450px; height:680px;">
    <div class="title-bar"><div class="title-bar-text">fangtasia.wtf Portal</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('ie_window')"></button></div></div>
    <div class="window-body" style="overflow-y:auto;">
        <div class="ie-content" id="ie_login">
            <h2>Member Login</h2>
            <input type="text" id="ie_user" class="ie-input" placeholder="Username">
            <input type="password" id="ie_pass" class="ie-input" placeholder="Password">
            <button class="ie-btn" onclick="validateIE()">Authorize</button>
            <div class="guest-section">
                <p style="color: #666; font-size: 10px; text-align: center; margin-bottom: 10px;">â€” OR â€”</p>
                <button class="guest-btn" onclick="toggleWin('about_window')">â“ About This Place</button>
                <button class="guest-btn" onclick="enterGuestChat()">ğŸ‘ï¸ Lurk the Lounge (Read-Only)</button>
            </div>
        </div>
        <div class="ie-content" id="ie_upload" style="display:none;">
            <button class="lounge-entry-btn" onclick="openChat()">ğŸ©¸ Enter The Lounge</button>
            <p id="logged_in_as" style="font-size: 11px; color: #fff;"></p>
            <h3 style="color:#d40000; margin: 15px 0 5px 0; font-size: 13px;">ğŸ“¹ Upload Memory</h3>
            <input type="text" id="ie_filename" class="ie-input" placeholder="Memory Name">
            <input type="file" id="ie_file_picker" class="ie-input" style="border:none;" accept="video/*">
            <button class="ie-btn" id="upload_status" onclick="processIEUpload()">Push to Cloud</button>
            <div id="vip_image_section" style="display:none; margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                <h3 style="color:#ffd700; margin: 0 0 5px 0; font-size: 13px;">ğŸŒŸ VIP Image Hosting</h3>
                <input type="file" id="vip_image_picker" class="ie-input" style="border:none;" accept="image/*">
                <button class="ie-btn" style="background:#5a4a00;" onclick="uploadVIPImage()">Upload Image</button>
                <div id="vip_image_result" style="margin-top:8px;"></div>
            </div>
            <button class="ie-btn" style="background: #222; margin-top: 15px;" onclick="logout()">Logout</button>
        </div>
    </div>
</div>
<div class="taskbar">
    <div style="margin-left: 10px; display: flex; gap: 8px;">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="music-ctrl" onclick="playMusic()" title="Play" style="width:18px; height:18px; cursor:pointer; filter: invert(1) brightness(0.7);">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727240.png" class="music-ctrl" onclick="pauseMusic()" title="Pause" style="width:18px; height:18px; cursor:pointer; filter: invert(1) brightness(0.7);">
    </div>
    <div style="margin-left: auto; margin-right: 15px; color: #888; font-size: 11px;" id="taskbar_clock"></div>
</div>
<div id="player" style="position:absolute; top:-999px;"></div>
<script src="https://www.youtube.com/iframe_api">
function beginSession() {
    const boot = document.getElementById('boot-screen');
    if (!boot) return;

    boot.style.display = 'none';
    document.body.style.overflow = 'hidden';
    sessionStorage.setItem('fangtasia_session_started', 'true');
}

if (sessionStorage.getItem('fangtasia_session_started') === 'true') {
    const boot = document.getElementById('boot-screen');
    if (boot) boot.style.display = 'none';
}

</script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyB7GeyT9SY7zFBeT-lfCM6iHZ_ipFXvemU",
    authDomain: "fangtasia-14197.firebaseapp.com",
    databaseURL: "https://fangtasia-14197-default-rtdb.firebaseio.com",
    projectId: "fangtasia-14197",
    storageBucket: "fangtasia-14197.firebasestorage.app",
    messagingSenderId: "735588641679",
    appId: "1:735588641679:web:5e0b9c5c5c84166b2f79fa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const CLOUD_NAME = "fangtasia-14197";
const UPLOAD_PRESET = "fangtasia";

// USER DATABASE - Added "north" as Member
const coreAdmins = {
    "losersyndicate": { pass: "doubledutchie01", rank: "ST", fullRank: "Site Technician", style: "st-style", target: "list_technician", isAdmin: true, isST: true },
    "noseeyedear": { pass: "wtfomfgfangtasiafordabros21", rank: "A", fullRank: "Admin", style: "a-style", target: "list_admin", isAdmin: true },
    "oleg": { pass: "methybethy89!", rank: "A", fullRank: "Admin", style: "a-style", target: "list_admin", isAdmin: true },
    "north": { pass: "lmaolegacy12!$$", rank: "M", fullRank: "Member", style: "member-style", target: "list_member", isAdmin: false }
};
let userDatabase = { ...coreAdmins };
db.ref('members').on('value', (s) => { userDatabase = { ...coreAdmins, ...(s.val() || {}) }; });

let CURRENT_USER = "", IS_GUEST = false, currentPage = 1, itemsPerPage = 9;
let userProfile = { color: "#ff0000", status: "", bio: "", mood: "", avatar: "", music: "" };
let currentProfileUser = "", idleTime = 0, screensaverActive = false;

// REAL-TIME PROFILE CACHE - Sitewide updates
let profileCache = {};
db.ref('profiles').on('value', (s) => { profileCache = s.val() || {}; });
function getProfile(username) { return profileCache[username] || {}; }

// BAT CURSOR
document.addEventListener('mousemove', (e) => {
    const bat = document.getElementById('batCursor');
    if(bat) { bat.style.left = e.clientX + 'px'; bat.style.top = e.clientY + 'px'; }
    resetIdle();
});
document.addEventListener('keypress', resetIdle);
document.addEventListener('click', resetIdle);

function resetIdle() {
    idleTime = 0;
    if (screensaverActive) { document.getElementById('screensaver').style.display = 'none'; screensaverActive = false; }
}
function activateScreensaver() {
    screensaverActive = true;
    const ss = document.getElementById('screensaver');
    ss.innerHTML = '';
    ss.style.display = 'block';
    for (let i = 0; i < 12; i++) {
        const bat = document.createElement('div');
        bat.className = 'screensaver-bat';
        bat.textContent = 'ğŸ¦‡';
        bat.style.left = Math.random() * 90 + 'vw';
        bat.style.top = Math.random() * 90 + 'vh';
        bat.style.animation = `flyAround ${6 + Math.random() * 6}s linear infinite`;
        ss.appendChild(bat);
    }
}
setInterval(() => { idleTime++; if (idleTime > 90 && !screensaverActive && document.getElementById('boot-screen').style.display === 'none') activateScreensaver(); }, 1000);

function updateVisitorCount() {
    let count = parseInt(localStorage.getItem('f_visitors') || '0');
    if (!sessionStorage.getItem('counted')) { count++; localStorage.setItem('f_visitors', count); sessionStorage.setItem('counted', 'true'); }
    document.getElementById('visitor_count').textContent = count.toString().padStart(6, '0');
}
function updateClock() { const now = new Date(); document.getElementById('taskbar_clock').textContent = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0'); }
setInterval(updateClock, 1000);
function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

// SILVER STAKES GAME
let stakesBoard = [], stakesRevealed = [], stakesFlagged = [], gameOver = false;
function initStakesGame() {
    stakesBoard = Array(81).fill(0); stakesRevealed = Array(81).fill(false); stakesFlagged = Array(81).fill(false); gameOver = false;
    let placed = 0;
    while (placed < 10) { const pos = Math.floor(Math.random() * 81); if (stakesBoard[pos] !== -1) { stakesBoard[pos] = -1; placed++; } }
    for (let i = 0; i < 81; i++) {
        if (stakesBoard[i] === -1) continue;
        let count = 0; const row = Math.floor(i / 9), col = i % 9;
        for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && stakesBoard[nr * 9 + nc] === -1) count++; }
        stakesBoard[i] = count;
    }
    renderStakes();
    document.getElementById('game_status').textContent = 'ğŸ¦‡ Stakes: 10';
}
function renderStakes() {
    const grid = document.getElementById('stakes_grid'); grid.innerHTML = '';
    for (let i = 0; i < 81; i++) {
        const cell = document.createElement('div'); cell.className = 'stakes-cell';
        if (stakesRevealed[i]) { cell.classList.add('revealed'); if (stakesBoard[i] === -1) { cell.classList.add('stake'); cell.textContent = 'ğŸ—¡ï¸'; } else if (stakesBoard[i] > 0) { cell.textContent = stakesBoard[i]; cell.style.color = ['','#00f','#0a0','#f00','#008','#800','#088','#000','#888'][stakesBoard[i]]; } }
        else if (stakesFlagged[i]) { cell.textContent = 'ğŸš©'; }
        cell.onclick = () => revealCell(i);
        cell.oncontextmenu = (e) => { e.preventDefault(); if (!gameOver && !stakesRevealed[i]) { stakesFlagged[i] = !stakesFlagged[i]; renderStakes(); } };
        grid.appendChild(cell);
    }
}
function revealCell(i) {
    if (gameOver || stakesRevealed[i] || stakesFlagged[i]) return;
    stakesRevealed[i] = true;
    if (stakesBoard[i] === -1) { gameOver = true; stakesRevealed = stakesRevealed.map(() => true); document.getElementById('game_status').textContent = 'ğŸ’€ Staked! Game Over.'; }
    else if (stakesBoard[i] === 0) { const row = Math.floor(i / 9), col = i % 9; for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) revealCell(nr * 9 + nc); } }
    const unrevealed = stakesRevealed.filter((r, idx) => !r && stakesBoard[idx] !== -1).length;
    if (unrevealed === 0 && !gameOver) { gameOver = true; document.getElementById('game_status').textContent = 'ğŸ¦‡ You survived!'; }
    renderStakes();
}

// APPLICATION SYSTEM
function submitApplication() {
    const username = document.getElementById('app_username').value.trim();
    const reason = document.getElementById('app_reason').value.trim();
    if (!username || !reason) { alert('Fill required fields.'); return; }
    db.ref('applications/' + Date.now()).set({ username, referral: document.getElementById('app_referral').value, reason, date: new Date().toLocaleDateString(), status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP });
    document.getElementById('app_form').style.display = 'none';
    document.getElementById('app_result').innerHTML = '<div class="app-status app-pending"><strong>ğŸ©¸ Blood Pact Received</strong></div>';
    document.getElementById('app_result').style.display = 'block';
}
function checkAppStatus() {
    const username = document.getElementById('app_username').value.trim();
    if (!username) { alert('Enter username.'); return; }
    db.ref('applications').orderByChild('username').equalTo(username).once('value', (s) => {
        let app = null; s.forEach((c) => { app = c.val(); });
        const rd = document.getElementById('app_result');
        document.getElementById('app_form').style.display = 'none'; rd.style.display = 'block';
        if (!app) rd.innerHTML = '<div class="app-status" style="border-color:#888; color:#888;">No application found.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'pending') rd.innerHTML = '<div class="app-status app-pending">ğŸ• Pending review.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'approved') rd.innerHTML = '<div class="app-status" style="border-color:#0f0; color:#0f0;">âœ“ Approved!</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else rd.innerHTML = '<div class="app-status" style="border-color:#f00; color:#f00;">âœ— Denied.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
    });
}
function resetAppForm() { document.getElementById('app_form').style.display = 'block'; document.getElementById('app_result').style.display = 'none'; }
function enterGuestChat() { IS_GUEST = true; CURRENT_USER = "Guest_" + Math.floor(Math.random() * 9999); toggleWin('chat_win'); loadMessages(); document.getElementById('chat_input').placeholder = "Lurking (read-only)..."; document.getElementById('chat_input').disabled = true; }

// LOGIN SYSTEM
function validateIE() {
    const u = document.getElementById('ie_user').value.trim();
    const p = document.getElementById('ie_pass').value;
    if (!u || !p) { alert("Enter username and password."); return; }
    db.ref('bans/' + u).once('value', (s) => {
        const ban = s.val();
        if (ban && (ban.expiry === 0 || ban.expiry > Date.now())) { alert('Account banned/suspended.'); return; }
        if(userDatabase[u] && userDatabase[u].pass === p) {
            CURRENT_USER = u; IS_GUEST = false;
            document.getElementById('ie_login').style.display = 'none';
            document.getElementById('ie_upload').style.display = 'block';
            document.getElementById('logged_in_as').innerText = `IDENTIFIED: ${u} [${userDatabase[u].fullRank}]`;
            loadProfile();
            if (userDatabase[u].isAdmin) { document.getElementById('admin_icon').style.display = 'block'; }
            if (userDatabase[u].isST) { document.getElementById('st_section').style.display = 'block'; }
            if (userDatabase[u].rank === 'VIP' || userDatabase[u].isAdmin || userDatabase[u].isST) { document.getElementById('vip_image_section').style.display = 'block'; }
        } else { alert("DENIED."); }
    });
}
function logout() {
    if (CURRENT_USER) db.ref('online/' + CURRENT_USER).remove();
    CURRENT_USER = ""; IS_GUEST = false;
    document.getElementById('ie_login').style.display = 'block';
    document.getElementById('ie_upload').style.display = 'none';
    document.getElementById('ie_user').value = '';
    document.getElementById('ie_pass').value = '';
    document.getElementById('admin_icon').style.display = 'none';
    document.getElementById('st_section').style.display = 'none';
    document.getElementById('vip_image_section').style.display = 'none';
    toggleWin('chat_win');
}
function openChat() { if(CURRENT_USER && !IS_GUEST) { toggleWin('chat_win'); loadMessages(); setUserOnline(); document.getElementById('chat_input').disabled = false; document.getElementById('chat_input').placeholder = "/help for commands..."; } }
function setUserOnline() {
    if (!CURRENT_USER || IS_GUEST) return;
    const user = userDatabase[CURRENT_USER];
    db.ref('online/' + CURRENT_USER).set({ username: CURRENT_USER, rank: user ? user.rank : 'M', style: user ? user.style : 'member-style', fullRank: user ? user.fullRank : 'Member', lastSeen: firebase.database.ServerValue.TIMESTAMP });
    db.ref('online/' + CURRENT_USER).onDisconnect().remove();
}
function loadOnlineUsers() {
    db.ref('online').on('value', (s) => {
        const container = document.getElementById('online_users'); if (!container) return;
        const users = []; s.forEach(c => users.push(c.val()));
        if (users.length === 0) { container.innerHTML = '<div style="color:#555; font-size:10px; text-align:center;">No one online</div>'; return; }
        container.innerHTML = users.map(u => `<div class="member-item ${u.style}" onclick="showProfileCard('${escapeHtml(u.username)}', event)"><span style="color:#0f0; font-size:8px;">â—</span> ${escapeHtml(u.username)}</div>`).join('');
    });
}

// PROFILE SYSTEM - REAL-TIME
function loadProfile() {
    if (!CURRENT_USER) return;
    db.ref('profiles/' + CURRENT_USER).once('value', (s) => {
        const p = s.val() || {};
        userProfile = { color: p.color || "#ff0000", status: p.status || "", bio: p.bio || "", mood: p.mood || "", avatar: p.avatar || "", music: p.music || "" };
        const statusEl = document.getElementById('user_status');
        const bioEl = document.getElementById('user_bio');
        const moodEl = document.getElementById('user_mood');
        const avatarUrlEl = document.getElementById('avatar_url');
        const musicEl = document.getElementById('profile_music');
        if (statusEl) statusEl.value = userProfile.status;
        if (bioEl) bioEl.value = userProfile.bio;
        if (moodEl) moodEl.value = userProfile.mood;
        if (avatarUrlEl) avatarUrlEl.value = userProfile.avatar;
        if (musicEl) musicEl.value = userProfile.music;
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.toggle('selected', el.dataset.color === userProfile.color));
    });
}
function saveProfile() {
    if (!CURRENT_USER) return;
    const statusEl = document.getElementById('user_status');
    const bioEl = document.getElementById('user_bio');
    const moodEl = document.getElementById('user_mood');
    userProfile.status = statusEl ? statusEl.value : '';
    userProfile.bio = bioEl ? bioEl.value : '';
    userProfile.mood = moodEl ? moodEl.value : '';
    db.ref('profiles/' + CURRENT_USER).update({ status: userProfile.status, bio: userProfile.bio, mood: userProfile.mood, color: userProfile.color, avatar: userProfile.avatar, music: userProfile.music });
    alert('Profile saved!');
}
function selectColor(el) {
    document.querySelectorAll('.color-swatch').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
    userProfile.color = el.dataset.color;
    if (CURRENT_USER) db.ref('profiles/' + CURRENT_USER).update({ color: userProfile.color });
}
function updateAvatar() {
    const url = document.getElementById('avatar_url').value.trim();
    const fileInput = document.getElementById('avatar_upload');
    if (url) {
        userProfile.avatar = url;
        db.ref('profiles/' + CURRENT_USER).update({ avatar: url });
        document.getElementById('my_avatar_display').innerHTML = '<img src="' + url + '" style="width:100%; height:100%; object-fit:cover;">';
        alert('Avatar updated!');
    } else if (fileInput && fileInput.files[0]) {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('upload_preset', UPLOAD_PRESET);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData })
            .then(res => res.json()).then(data => {
                if (data.secure_url) {
                    userProfile.avatar = data.secure_url;
                    db.ref('profiles/' + CURRENT_USER).update({ avatar: data.secure_url });
                    document.getElementById('my_avatar_display').innerHTML = '<img src="' + data.secure_url + '" style="width:100%; height:100%; object-fit:cover;">';
                    document.getElementById('avatar_url').value = data.secure_url;
                    alert('Avatar uploaded!');
                }
            });
    } else { alert('Enter URL or select file.'); }
}
function updateProfileMusic() {
    const url = document.getElementById('profile_music').value.trim();
    userProfile.music = url;
    db.ref('profiles/' + CURRENT_USER).update({ music: url });
    alert('Profile music set!');
}

// PROFILE CARD - Click username to open
function showProfileCard(username, event) {
    if (event) { event.preventDefault(); event.stopPropagation(); }
    if (!username) return;
    currentProfileUser = username;
    const card = document.getElementById('profile_card');
    const userData = userDatabase[username] || { rank: 'M', fullRank: 'Member', style: 'member-style' };
    
    document.getElementById('pc_name').textContent = username;
    document.getElementById('pc_name').className = 'profile-card-name ' + (userData.style || 'member-style');
    document.getElementById('pc_title').textContent = userData.fullRank || 'Member';
    
    // Use real-time cached profile
    const profile = getProfile(username);
    document.getElementById('pc_status').textContent = profile.status || '';
    document.getElementById('pc_mood').textContent = profile.mood || '';
    document.getElementById('pc_bio').textContent = profile.bio || 'No bio set.';
    
    const avatarEl = document.getElementById('pc_avatar');
    if (profile.avatar) avatarEl.innerHTML = '<img src="' + escapeHtml(profile.avatar) + '" onerror="this.parentElement.innerHTML=\'ğŸ¦‡\'">';
    else avatarEl.innerHTML = 'ğŸ¦‡';
    
    // Load reputation
    db.ref('reputation/' + username).once('value', (s) => { const rep = s.val() || { score: 0 }; document.getElementById('pc_rep').textContent = rep.score || 0; });
    
    // Load comments
    db.ref('profile_comments/' + username).orderByChild('timestamp').limitToLast(10).once('value', (s) => {
        const comments = []; s.forEach(c => comments.push(c.val()));
        document.getElementById('pc_comment_count').textContent = comments.length;
        const cl = document.getElementById('pc_comments_list');
        if (comments.length === 0) cl.innerHTML = '<div style="color:#555; font-size:10px;">No comments yet.</div>';
        else cl.innerHTML = comments.reverse().map(c => `<div style="background:#0a0000; padding:6px; margin-bottom:4px; border-left:2px solid #500;"><span style="color:#d40000; font-weight:bold; font-size:10px;">${escapeHtml(c.from)}</span><span style="color:#444; font-size:8px;"> - ${c.date || ''}</span><div style="color:#999; font-size:10px; margin-top:2px;">${escapeHtml(c.text)}</div></div>`).join('');
    });
    
    // Music player
    const musicSection = document.getElementById('pc_music_section');
    const musicPlayer = document.getElementById('pc_music_player');
    if (profile.music) {
        musicSection.style.display = 'block';
        if (profile.music.includes('soundcloud.com')) musicPlayer.innerHTML = '<iframe width="100%" height="80" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=' + encodeURIComponent(profile.music) + '&color=%23ff0000&auto_play=true&hide_related=true&show_comments=false"></iframe>';
        else if (profile.music.includes('spotify.com')) { const m = profile.music.match(/track\/([a-zA-Z0-9]+)/); if (m) musicPlayer.innerHTML = '<iframe src="https://open.spotify.com/embed/track/' + m[1] + '" width="100%" height="80" frameborder="0"></iframe>'; }
        else musicPlayer.innerHTML = '';
    } else { musicSection.style.display = 'none'; musicPlayer.innerHTML = ''; }
    
    // Rep buttons
    const canRep = CURRENT_USER && !IS_GUEST && username !== CURRENT_USER;
    document.getElementById('btn_rep_pos').style.display = canRep ? 'inline-block' : 'none';
    document.getElementById('btn_rep_neg').style.display = canRep ? 'inline-block' : 'none';
    
    // Position card
    let posX = 200, posY = 100;
    if (event && event.clientX) { posX = Math.min(event.clientX + 10, window.innerWidth - 360); posY = Math.min(event.clientY + 10, window.innerHeight - 500); }
    if (window.innerWidth <= 900) { posX = 10; posY = 60; }
    card.style.left = posX + 'px'; card.style.top = posY + 'px'; card.style.display = 'block';
}
function closeProfileCard() { document.getElementById('profile_card').style.display = 'none'; document.getElementById('pc_music_player').innerHTML = ''; }
document.addEventListener('click', (e) => {
    const card = document.getElementById('profile_card');
    if (card.style.display === 'block' && !e.target.closest('.profile-card') && !e.target.closest('.chat-username') && !e.target.closest('.member-item')) closeProfileCard();
});
function giveRep(amount) {
    if (!CURRENT_USER || IS_GUEST || currentProfileUser === CURRENT_USER) return;
    db.ref('reputation/' + currentProfileUser).once('value', (s) => {
        const current = s.val() || { score: 0, givers: {} };
        if (current.givers && current.givers[CURRENT_USER]) { alert('Already gave rep!'); return; }
        current.score = (current.score || 0) + amount;
        current.givers = current.givers || {};
        current.givers[CURRENT_USER] = amount;
        db.ref('reputation/' + currentProfileUser).set(current);
        document.getElementById('pc_rep').textContent = current.score;
        alert(amount > 0 ? '+Rep given!' : '-Rep given!');
    });
}
function leaveProfileComment() {
    if (!CURRENT_USER || IS_GUEST) { alert('Must be logged in!'); return; }
    const text = document.getElementById('profile_comment_input').value.trim();
    if (!text) return;
    db.ref('profile_comments/' + currentProfileUser).push({ from: CURRENT_USER, text: text, date: new Date().toLocaleDateString(), timestamp: firebase.database.ServerValue.TIMESTAMP });
    document.getElementById('profile_comment_input').value = '';
    showProfileCard(currentProfileUser, null);
}
function openDM(username) {
    if (!username || username === CURRENT_USER || IS_GUEST) return;
    closeProfileCard();
    alert('DM feature coming soon! For now, mention @' + username + ' in chat.');
}

// CHAT SYSTEM
function switchChatTab(tab, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('chat_main').style.display = tab === 'main' ? 'block' : 'none';
    document.getElementById('chat_avatar').style.display = tab === 'avatar' ? 'block' : 'none';
    if (tab === 'avatar') loadAvatarTab();
}
function loadAvatarTab() {
    if (!CURRENT_USER) return;
    const user = userDatabase[CURRENT_USER];
    document.getElementById('my_username_display').textContent = CURRENT_USER;
    document.getElementById('my_rank_display').textContent = user ? user.fullRank : 'Member';
    const profile = getProfile(CURRENT_USER);
    const avatarDisplay = document.getElementById('my_avatar_display');
    if (profile.avatar) avatarDisplay.innerHTML = '<img src="' + profile.avatar + '" style="width:100%; height:100%; object-fit:cover;">';
    else avatarDisplay.innerHTML = 'ğŸ¦‡';
    document.getElementById('avatar_url').value = profile.avatar || '';
    document.getElementById('profile_music').value = profile.music || '';
    document.getElementById('user_status').value = profile.status || '';
    document.getElementById('user_bio').value = profile.bio || '';
    if (profile.mood) document.getElementById('user_mood').value = profile.mood;
}
function handleTyping() { if (IS_GUEST || !CURRENT_USER) return; db.ref('typing').set({ user: CURRENT_USER, time: Date.now() }); }
function checkTyping() {
    db.ref('typing').once('value', (s) => {
        const typing = s.val();
        const area = document.getElementById('typing_area');
        if (typing && typing.user && typing.user !== CURRENT_USER && (Date.now() - typing.time) < 2000) { document.getElementById('typing_user').textContent = typing.user; area.style.display = 'block'; }
        else area.style.display = 'none';
    });
}
setInterval(checkTyping, 500);
function handleChatKey(event) { if (event.key === 'Enter') sendChat(); }

const chatCommands = {
    '/help': () => ({ type: 'system', text: 'Commands: /me, /shrug, /tableflip, /blood, /bat, /bite' }),
    '/me': (args) => ({ type: 'action', text: CURRENT_USER + ' ' + args }),
    '/shrug': () => ({ type: 'action', text: CURRENT_USER + ' Â¯\\_(ãƒ„)_/Â¯' }),
    '/tableflip': () => ({ type: 'action', text: CURRENT_USER + ' (â•¯Â°â–¡Â°)â•¯ï¸µ â”»â”â”»' }),
    '/blood': () => ({ type: 'action', text: CURRENT_USER + ' ğŸ©¸ğŸ©¸ğŸ©¸' }),
    '/bat': () => ({ type: 'action', text: CURRENT_USER + ' ğŸ¦‡ *flaps away*' }),
    '/bite': (args) => ({ type: 'action', text: CURRENT_USER + ' ğŸ§› *bites ' + (args || 'the air') + '*' }),
};
const botResponses = [
    { trigger: /hello|hi|hey/i, response: "Greetings, mortal. ğŸ¦‡" },
    { trigger: /vampire|vamp/i, response: "Did someone say vampire? *fangs glisten*" },
    { trigger: /blood/i, response: "The crimson elixir... ğŸ©¸" },
    { trigger: /sun|daylight/i, response: "We don't speak of the burning orb. â˜€ï¸ğŸš«" },
    { trigger: /garlic/i, response: "*hisses* Forbidden! ğŸ§„âŒ" },
];

function sendChat() {
    if (IS_GUEST) return;
    const input = document.getElementById('chat_input');
    const text = input.value.trim();
    if(!text) return;
    const u = userDatabase[CURRENT_USER];
    const profile = getProfile(CURRENT_USER);
    
    const cmdMatch = text.match(/^(\/\w+)\s*(.*)?$/);
    if (cmdMatch && chatCommands[cmdMatch[1]]) {
        const result = chatCommands[cmdMatch[1]](cmdMatch[2] || '');
        if (result.type === 'system') { input.value = ''; const logs = document.getElementById('chat_logs'); logs.innerHTML += '<div style="color:#666; font-size:9px; font-style:italic; padding:4px;">' + result.text + '</div>'; logs.scrollTop = logs.scrollHeight; return; }
        else { db.ref('chat').push({ user: CURRENT_USER, text: result.text, isAction: true, tag: u.rank, style: u.style, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP }); }
    } else {
        db.ref('chat').push({ user: CURRENT_USER, text: text, tag: u.rank, style: u.style, color: profile.color || null, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP });
        for (const br of botResponses) {
            if (br.trigger.test(text)) {
                setTimeout(() => { db.ref('chat').push({ user: 'Eric Northman', text: br.response, tag: 'BOT', style: 'bot-style', isBot: true, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP }); }, 1000 + Math.random() * 1000);
                break;
            }
        }
    }
    input.value = "";
}

let chatListenerSet = false;
function setupChatListener() {
    if (chatListenerSet) return;
    chatListenerSet = true;
    db.ref('chat').orderByChild('timestamp').limitToLast(100).on('value', (s) => {
        const logs = document.getElementById('chat_logs'); if (!logs) return;
        const msgs = []; s.forEach((c) => msgs.push(c.val()));
        db.ref('pinned').once('value', (ps) => {
            const pinned = ps.val();
            const pc = document.getElementById('pinned_container');
            if (pc) pc.innerHTML = pinned ? '<div class="pinned-msg"><span style="color:#ffd700; font-size:8px;">ğŸ“Œ PINNED</span><br>' + escapeHtml(pinned) + '</div>' : '';
        });
        logs.innerHTML = msgs.map(m => {
            if (m.isAction) return '<div class="chat-action" style="padding:4px 0; font-size:11px;">* ' + escapeHtml(m.text) + '</div>';
            const botClass = m.isBot ? ' chat-bot' : '';
            const imgHtml = m.imageData ? '<img class="chat-image" src="' + m.imageData + '">' : '';
            const colorStyle = m.color ? 'color:' + m.color + ' !important;' : '';
            return `<div class="chat-entry${botClass}"><div class="chat-header"><span class="rank-tag ${m.style}">${m.tag}</span><span class="chat-username ${m.style}" style="${colorStyle}" onclick="showProfileCard('${escapeHtml(m.user)}', event)">${escapeHtml(m.user)}</span><span style="color:#444; font-size:8px; margin-left:auto;">${m.time || ''}</span></div><div style="color:#ccc; font-size:11px; padding-left:30px;">${escapeHtml(m.text)}${imgHtml}</div></div>`;
        }).join('');
        logs.scrollTop = logs.scrollHeight;
    });
}
function loadMessages() { setupChatListener(); }
function uploadChatImage() {
    if (IS_GUEST) return;
    const file = document.getElementById('chat_image').files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) { db.ref('pending_images').push({ data: e.target.result, user: CURRENT_USER, id: Date.now(), timestamp: firebase.database.ServerValue.TIMESTAMP }); alert('Image submitted for approval!'); };
    reader.readAsDataURL(file);
    document.getElementById('chat_image').value = '';
}

// ADMIN FUNCTIONS
function sendBotMessage() { const text = document.getElementById('bot_message').value.trim(); if (!text) return; db.ref('chat').push({ user: 'Eric Northman', text: text, tag: 'BOT', style: 'bot-style', isBot: true, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP }); document.getElementById('bot_message').value = ''; }
function pinMessage() { const text = document.getElementById('pin_message').value.trim(); if (!text) return; db.ref('pinned').set(text); document.getElementById('pin_message').value = ''; }
function clearPin() { db.ref('pinned').remove(); }
function clearChat() { if (confirm('Clear ALL chat?')) db.ref('chat').remove(); }
function loadPendingImages() {
    const container = document.getElementById('pending_images'); if (!container) return;
    db.ref('pending_images').once('value', (s) => {
        const pending = []; s.forEach((c) => pending.push({ ...c.val(), key: c.key }));
        if (pending.length === 0) { container.innerHTML = '<span style="color:#666; font-size:9px;">None</span>'; return; }
        container.innerHTML = pending.map(p => '<div style="border:1px solid #333; padding:8px; margin-bottom:6px;"><img src="' + p.data + '" style="max-width:60px; max-height:45px;"><div style="color:#d40000; font-size:10px;">' + p.user + '</div><button class="ie-btn" style="padding:2px 6px; font-size:9px; width:auto; margin:2px;" onclick="approveImage(\'' + p.key + '\')">âœ“</button><button class="ie-btn" style="padding:2px 6px; font-size:9px; width:auto; background:#333;" onclick="denyImage(\'' + p.key + '\')">âœ—</button></div>').join('');
    });
}
function approveImage(key) {
    db.ref('pending_images/' + key).once('value', (s) => {
        const img = s.val(); if (!img) return;
        const u = userDatabase[img.user] || { rank: 'M', style: 'member-style' };
        db.ref('chat').push({ user: img.user, text: '[Image]', imageData: img.data, tag: u.rank, style: u.style, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP });
        db.ref('pending_images/' + key).remove();
        loadPendingImages();
    });
}
function denyImage(key) { db.ref('pending_images/' + key).remove(); loadPendingImages(); }
function loadPendingApps() {
    const container = document.getElementById('pending_apps'); if (!container) return;
    db.ref('applications').orderByChild('status').equalTo('pending').once('value', (s) => {
        const apps = []; s.forEach((c) => apps.push(c.val()));
        if (apps.length === 0) { container.innerHTML = '<span style="color:#666; font-size:9px;">None</span>'; return; }
        container.innerHTML = apps.map(a => `<div style="border:1px solid #400; padding:8px; margin-bottom:8px;"><strong style="color:#d40000;">${escapeHtml(a.username)}</strong><div style="color:#888; font-size:9px;">${escapeHtml(a.reason)}</div><button class="ie-btn" style="padding:3px 12px; font-size:9px; width:auto; background:#050;" onclick="approveApp('${a.id || a.timestamp}')">âœ“</button><button class="ie-btn" style="padding:3px 12px; font-size:9px; width:auto; background:#500;" onclick="denyApp('${a.id || a.timestamp}')">âœ—</button></div>`).join('');
    });
}
function approveApp(id) { db.ref('applications').orderByChild('timestamp').once('value', (s) => { s.forEach(c => { if (c.val().timestamp == id || c.key == id) db.ref('applications/' + c.key).update({ status: 'approved' }); }); loadPendingApps(); }); }
function denyApp(id) { db.ref('applications').orderByChild('timestamp').once('value', (s) => { s.forEach(c => { if (c.val().timestamp == id || c.key == id) db.ref('applications/' + c.key).update({ status: 'denied' }); }); loadPendingApps(); }); }
function executeModAction() {
    const username = document.getElementById('mod_username').value.trim();
    const action = document.getElementById('mod_action').value;
    const duration = parseInt(document.getElementById('mod_duration').value);
    if (!username || !action) { document.getElementById('mod_result').innerHTML = '<span style="color:#f00;">Select user and action.</span>'; return; }
    const protectedAdmins = ['losersyndicate', 'noseeyedear', 'oleg'];
    if (protectedAdmins.includes(username.toLowerCase())) { document.getElementById('mod_result').innerHTML = '<span style="color:#f00;">Cannot moderate core admins.</span>'; return; }
    const expiry = duration === 0 ? 0 : Date.now() + (duration * 60 * 1000);
    if (action === 'kick') { document.getElementById('mod_result').innerHTML = '<span style="color:#0f0;">' + username + ' kicked.</span>'; }
    else { db.ref('bans/' + username).set({ type: action, expiry: expiry, by: CURRENT_USER }); if (action === 'hardban') { db.ref('members/' + username).remove(); delete userDatabase[username]; } document.getElementById('mod_result').innerHTML = '<span style="color:#0f0;">' + username + ' ' + action + '.</span>'; }
}
function elevateUser() {
    if (!userDatabase[CURRENT_USER]?.isST) { alert('Access denied.'); return; }
    const username = document.getElementById('elevate_user').value.trim();
    const newRank = document.getElementById('elevate_rank').value;
    if (!username || !userDatabase[username]) { alert('User not found.'); return; }
    const rankConfig = { 'member': { rank: 'M', fullRank: 'Member', style: 'member-style', target: 'list_member', isAdmin: false }, 'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style', target: 'list_vip', isAdmin: false }, 'mod': { rank: 'MOD', fullRank: 'Moderator', style: 'mod-style', target: 'list_mod', isAdmin: true }, 'admin': { rank: 'A', fullRank: 'Admin', style: 'a-style', target: 'list_admin', isAdmin: true } };
    db.ref('members/' + username).update(rankConfig[newRank]);
    userDatabase[username] = { ...userDatabase[username], ...rankConfig[newRank] };
    alert(username + ' elevated to ' + rankConfig[newRank].fullRank);
}
function uploadVIPImage() {
    const user = userDatabase[CURRENT_USER]; if (!user || !(user.rank === 'VIP' || user.isAdmin || user.isST)) { alert('VIP+ only.'); return; }
    const file = document.getElementById('vip_image_picker').files[0]; if (!file) { alert('Select image.'); return; }
    document.getElementById('vip_image_result').innerHTML = '<div style="color:#888; font-size:10px;">Uploading...</div>';
    const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', UPLOAD_PRESET);
    fetch('https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/image/upload', { method: 'POST', body: formData })
        .then(res => res.json()).then(data => {
            if (data.secure_url) { document.getElementById('vip_image_result').innerHTML = `<div style="background:#0a0a00; border:1px solid #ffd700; padding:10px;"><div style="color:#0f0; font-size:10px;">âœ“ Uploaded!</div><input type="text" value="${data.secure_url}" style="width:100%; font-size:10px; background:#000; border:1px solid #ffd700; color:#ffd700; padding:6px;" onclick="this.select();" readonly></div>`; }
            else document.getElementById('vip_image_result').innerHTML = '<div style="color:#f00; font-size:10px;">Failed.</div>';
        });
}

// MEMORIES / VIDEO ARCHIVE
function prevPage() { if (currentPage > 1) { currentPage--; renderMemories(); } }
function nextPage() { db.ref('archive').once('value', (s) => { let count = 0; s.forEach(() => count++); const totalPages = Math.ceil(count / itemsPerPage) || 1; if (currentPage < totalPages) { currentPage++; renderMemories(); } }); }
function renderMemories() {
    const grid = document.getElementById('memories_grid'); grid.innerHTML = "";
    db.ref('archive').orderByChild('timestamp').once('value', (s) => {
        const archive = []; s.forEach((c) => archive.push(c.val()));
        const totalPages = Math.ceil(archive.length / itemsPerPage) || 1;
        document.getElementById('page_indicator').textContent = 'Page ' + currentPage + ' of ' + totalPages;
        if (archive.length === 0) { grid.innerHTML = '<p style="color: #555; text-align: center; grid-column: 1/-1; padding: 40px;">No memories yet...</p>'; return; }
        const start = (currentPage - 1) * itemsPerPage;
        archive.slice(start, start + itemsPerPage).forEach(mem => {
            const div = document.createElement('div'); div.className = "icon";
            div.innerHTML = `<div onclick="spawnVideoWindow('${escapeHtml(mem.name)}', '${mem.url}')"><img style="width:40px; display:block; margin:0 auto 6px;" src="https://win98icons.alexmeub.com/icons/png/video_file-0.png"><div style="font-size:10px;">${escapeHtml(mem.name)}</div><div style="font-size:8px; color:#666;">${escapeHtml(mem.uploader)}</div></div>`;
            grid.appendChild(div);
        });
    });
}
function spawnVideoWindow(name, url) {
    const id = 'v_' + Date.now();
    const win = document.createElement('div');
    win.className = 'window'; win.id = id; win.style.display = 'block';
    win.style.left = (150 + Math.random() * 100) + 'px'; win.style.top = (100 + Math.random() * 50) + 'px'; win.style.width = '520px'; win.style.height = '420px';
    win.innerHTML = `<div class="title-bar"><div class="title-bar-text">â–¶ ${name}</div><div class="title-bar-controls"><button aria-label="Close" onclick="document.getElementById('${id}').remove()"></button></div></div><div class="window-body"><video src="${url}" controls autoplay style="width:100%; height:100%; background:#000;"></video></div>`;
    document.body.appendChild(win);
    makeDraggable(id);
}
async function processIEUpload() {
    const fileInput = document.getElementById('ie_file_picker');
    const name = document.getElementById('ie_filename').value || "Video";
    if(!fileInput.files[0]) return;
    document.getElementById('upload_status').innerText = "Syncing...";
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('upload_preset', UPLOAD_PRESET);
    try {
        const res = await fetch('https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/auto/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (res.ok) { db.ref('archive').push({ name, url: data.secure_url, uploader: CURRENT_USER, timestamp: firebase.database.ServerValue.TIMESTAMP }); renderMemories(); document.getElementById('upload_status').innerText = "Push to Cloud"; document.getElementById('ie_filename').value = ""; fileInput.value = ""; }
    } catch (e) { alert("Error."); }
}

// WINDOW MANAGEMENT
function toggleWin(id) {
    let el = document.getElementById(id); if (!el) return;
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
    if(el.style.display === 'block') { document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); el.style.zIndex = "200"; }
    if (id === 'admin_window') { loadPendingImages(); loadPendingApps(); }
}
function makeDraggable(winId) {
    const win = document.getElementById(winId); if (!win) return;
    const header = win.querySelector('.title-bar'); if (!header) return;
    header.onmousedown = (e) => {
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); win.style.zIndex = "400";
        let oX = e.clientX - win.offsetLeft, oY = e.clientY - win.offsetTop;
        document.onmousemove = (e) => { win.style.left = (e.clientX - oX) + 'px'; win.style.top = (e.clientY - oY) + 'px'; };
        document.onmouseup = () => document.onmousemove = null;
    };
    // Touch support for mobile
    header.ontouchstart = (e) => {
        const touch = e.touches[0];
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); win.style.zIndex = "400";
        let oX = touch.clientX - win.offsetLeft, oY = touch.clientY - win.offsetTop;
        document.ontouchmove = (e) => { const t = e.touches[0]; win.style.left = (t.clientX - oX) + 'px'; win.style.top = (t.clientY - oY) + 'px'; };
        document.ontouchend = () => document.ontouchmove = null;
    };
}

['ie_window', 'memories_folder', 'chat_win', 'about_window', 'games_window', 'apply_window', 'admin_window'].forEach(id => makeDraggable(id));

// *** CRITICAL FIX: beginSession must be globally accessible ***
window.beginSession = function() {
    document.getElementById('boot-screen').style.display = 'none';
    if(player) { player.unMute(); player.playVideo(); }
};

// YouTube Background Music
var player;
window.onYouTubeIframeAPIReady = function() {
    player = new YT.Player('player', {
        videoId: 'Bi5kyehmeaY',
        playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'Bi5kyehmeaY', 'controls': 0 },
        events: { 'onReady': (e) => e.target.mute() }
    });
};
function pauseMusic() { if(player) player.pauseVideo(); }
function playMusic() { if(player) player.playVideo(); }

// Initialize
window.addEventListener('load', () => {
    renderMemories();
    updateVisitorCount();
    updateClock();
    initStakesGame();
    loadOnlineUsers();
});
</script>
</body>
</html>
