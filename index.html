<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>fangtasia.wtf</title>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/bahram" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/7.css">
    <style>
        :root { --vamp-red: #8b0000; --glass: rgba(15, 0, 0, 0.9); --neon-pink: #ff00ff; }
        .bat-cursor { position: fixed; width: 32px; height: 32px; pointer-events: none; z-index: 99999; transform: translate(-50%, -50%); }
        .bat-cursor svg { width: 100%; height: 100%; filter: drop-shadow(0 0 3px rgba(139, 0, 0, 0.8)); }
        .bat-cursor .wing-left, .bat-cursor .wing-right { transform-origin: center; animation: flapWings 0.15s ease-in-out infinite alternate; }
        .bat-cursor .wing-right { animation-delay: 0.075s; }
        @keyframes flapWings { 0% { transform: scaleX(1) rotate(0deg); } 100% { transform: scaleX(0.85) rotate(-8deg); } }
        * { cursor: none !important; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: black; overflow: hidden; }
        body { background: radial-gradient(ellipse at center, #1a0a0a 0%, #0d0000 40%, #000000 100%); background-size: cover; background-position: center; font-family: "Segoe UI", Tahoma, sans-serif; }
        body::before { content: ''; position: fixed; inset: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="80" fill="rgba(139,0,0,0.03)">ğŸ¦‡</text></svg>') repeat; background-size: 80px; pointer-events: none; z-index: 0; }
        #boot-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #d40000; }
        .boot-title { font-size: 60px; animation: bloodPulse 2s ease-in-out infinite; text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); }
        @keyframes bloodPulse { 0%, 100% { text-shadow: 0 0 20px rgba(212, 0, 0, 0.5), 0 0 40px rgba(212, 0, 0, 0.3); } 50% { text-shadow: 0 0 30px rgba(212, 0, 0, 0.8), 0 0 60px rgba(212, 0, 0, 0.5); } }
        .boot-subtitle { animation: flicker 3s infinite; margin-top: 20px; }
        @keyframes flicker { 0%, 100% { opacity: 1; } 93% { opacity: 0.3; } 94% { opacity: 1; } 96% { opacity: 0.5; } }
        @keyframes batFloat { 0%, 100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-15px) rotate(5deg); } }
        #desktop { display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; padding: 25px; height: calc(100vh - 40px); gap: 20px; position: relative; z-index: 1; }
        .icon { width: 110px; text-align: center; color: white; text-shadow: 1px 1px 3px black; font-size: 11px; z-index: 5; margin-bottom: 15px; transition: transform 0.2s, filter 0.2s; }
        .icon:hover { transform: scale(1.1); filter: brightness(1.2); }
        .icon img.folder-icon { width: 44px; display: block; margin: 0 auto 6px; filter: grayscale(0.3) sepia(1) saturate(35) hue-rotate(320deg) brightness(0.55) contrast(1.5); }
        .window { position: fixed; background: #0d0d0d !important; border: 1px solid #700000 !important; box-shadow: 0 15px 40px rgba(0,0,0,1), 0 0 30px rgba(139, 0, 0, 0.2); display: none; z-index: 10; overflow: hidden; resize: both; min-width: 200px; min-height: 150px; }
        .title-bar { background: linear-gradient(to bottom, #8b0000, #2a0000) !important; user-select: none; }
        .window-body { height: calc(100% - 32px); padding: 0; background: black; overflow: auto; }
        .chat-container { display: flex; height: 420px; background: #050000; border-bottom: 1px solid #400; }
        #chat_logs { flex: 1; overflow-y: scroll; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        .chat-entry { display: flex; flex-direction: column; gap: 2px; }
        .chat-header { display: flex; align-items: center; gap: 8px; }
        .rank-tag { font-size: 9px; font-weight: bold; padding: 2px 6px; border-radius: 3px; border: 1px solid; text-transform: uppercase; min-width: 25px; text-align: center; display: inline-block; }
        #member_list { width: 200px; border-left: 1px solid #400; padding: 0; background: #0a0000; overflow-y: auto; }
        .member-category { color: #d40000; font-size: 11px; font-weight: bold; margin-top: 12px; border-bottom: 1px solid #400; text-transform: uppercase; padding-bottom: 4px; padding-left: 8px; }
        .member-category:first-child { margin-top: 0; }
        .member-item { font-size: 12px; font-weight: bold; margin-top: 4px; cursor: pointer; padding: 5px 8px; border-radius: 3px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .member-item:hover { background: rgba(139, 0, 0, 0.3); }
        .member-tag { font-size: 8px; padding: 2px 4px; border-radius: 2px; border: 1px solid; display: inline-block; }
        .st-style { color: #ff00ff; border-color: #ff00ff; background: rgba(255, 0, 255, 0.15); }
        .a-style { color: #ffffff; border-color: #ffffff; background: rgba(255, 255, 255, 0.1); }
        .mod-style { color: #00ff00; border-color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        .contrib-style { color: #1781ff; border-color: #1781ff; background: #001128; font-family: 'Bahram', sans-serif; box-shadow: 0 0 0 1px #000; }
        .oleg-style { color: #ff6b35; border-color: #ff6b35; background: rgba(255, 107, 53, 0.15); }
        .noseeyedear-style { color: #00ffcc; border-color: #00ffcc; background: rgba(0, 255, 204, 0.15); }
        .guest-style { color: #888; border-color: #555; background: rgba(85, 85, 85, 0.1); }
        .vip-style { color: #ffd700; border-color: #ffd700; background: rgba(255, 215, 0, 0.15); }
        .sb-style { color: #6a03b4; border-color: #6a03b4; background: rgba(106, 3, 180, 0.15); }
        .member-style { color: #ff4444; border-color: #ff4444; background: rgba(255, 68, 68, 0.1); }
        .bot-style { color: #d40000; border-color: #d40000; background: rgba(212, 0, 0, 0.2); }
        #memories_grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; justify-items: center; }
        .pagination-bar { padding: 15px; background: #111; border-top: 2px solid #500; text-align: center; }
        .ie-content { padding: 15px; color: #d40000; }
        .ie-input { width: 100%; background: #111; color: #ff0000; border: 1px solid #700000; padding: 6px; margin-bottom: 12px; font-size: 11px; box-sizing: border-box; }
        .ie-input:focus { outline: none; border-color: #ff0000; }
        .ie-btn { background: #500; color: white; border: 1px solid #f00; padding: 8px; width: 100%; font-weight: bold; margin-bottom: 5px; transition: all 0.2s; }
        .ie-btn:hover { background: #700; }
        .lounge-entry-btn { background: linear-gradient(#222, #000); border: 1px solid #ff00ff; color: #ff00ff; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 20px; font-size: 11px; text-transform: uppercase; }
        .guest-section { border-top: 1px solid #400; margin-top: 20px; padding-top: 15px; }
        .guest-btn { background: linear-gradient(#1a1a1a, #0a0a0a); border: 1px solid #444; color: #888; padding: 10px; width: 100%; font-weight: bold; margin-bottom: 8px; font-size: 11px; text-transform: uppercase; }
        .visitor-counter { background: #000; border: 1px solid #400; padding: 8px 15px; display: inline-block; font-family: 'Courier New', monospace; color: #0f0; font-size: 14px; }
        .taskbar { position: fixed; bottom: 0; width: 100%; height: 40px; background: var(--glass); border-top: 1px solid rgba(255,0,0,0.3); display: flex; align-items: center; z-index: 100; }
        .music-ctrl { width: 22px; filter: invert(1) sepia(1) saturate(10) hue-rotate(330deg); opacity: 0.8; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #0a0000; }
        ::-webkit-scrollbar-thumb { background: #400; border: 1px solid #600; }
        #screensaver { position: fixed; inset: 0; background: black; z-index: 99998; display: none; overflow: hidden; }
        .screensaver-bat { position: absolute; font-size: 30px; }
        @keyframes flyAround { 0% { transform: translate(0, 0); } 25% { transform: translate(80vw, 20vh); } 50% { transform: translate(40vw, 80vh); } 75% { transform: translate(10vw, 50vh); } 100% { transform: translate(0, 0); } }
        .profile-card { position: fixed; width: 340px; max-height: 650px; background: linear-gradient(135deg, #1a0000, #0a0000); border: 2px solid #700; box-shadow: 0 10px 40px rgba(0,0,0,0.9); z-index: 9000; display: none; overflow-y: auto; }
        .profile-card-header { display: flex; align-items: center; gap: 12px; padding: 15px; background: linear-gradient(180deg, #200000, #100000); border-bottom: 1px solid #500; }
        .profile-card-avatar { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; font-size: 35px; border: 3px solid #700; flex-shrink: 0; }
        .profile-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-card-name { font-weight: bold; font-size: 16px; }
        .profile-card-title { font-size: 10px; color: #888; margin-top: 2px; }
        .profile-card-bio { font-size: 11px; color: #aaa; padding: 12px 15px; border-bottom: 1px solid #300; line-height: 1.5; }
        .profile-card-btn { background: #500; color: #fff; border: 1px solid #800; padding: 6px 12px; font-size: 10px; cursor: pointer; }
        .chat-action { color: #888; font-style: italic; }
        .chat-bot { background: rgba(139, 0, 0, 0.1); border-left: 2px solid #8b0000; padding: 6px; margin: 4px 0; }
        .pinned-msg { background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; padding: 6px; margin-bottom: 8px; font-size: 10px; }
        .chat-image { max-width: 150px; max-height: 100px; border: 1px solid #400; margin-top: 4px; }
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #400; }
        .tab { padding: 6px 12px; color: #666; font-size: 10px; border-right: 1px solid #333; cursor: pointer; }
        .tab.active { background: #0a0000; color: #d40000; }
        .admin-section { margin-bottom: 15px; background: #0a0000; border: 1px solid #400; padding: 12px; }
        .admin-section h4 { color: #d40000; margin: 0 0 10px 0; font-size: 12px; border-bottom: 1px solid #400; padding-bottom: 5px; }
        .typing-indicator { display: flex; gap: 4px; padding: 8px 12px; color: #666; font-size: 11px; font-style: italic; }
        .typing-dot { width: 6px; height: 6px; background: #d40000; border-radius: 50%; animation: typingBounce 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }
        .chat-username { cursor: pointer; transition: all 0.2s; }
        .chat-username:hover { text-decoration: underline; text-shadow: 0 0 8px currentColor; }
        .app-status { padding: 8px; margin-top: 8px; border: 1px solid; font-size: 10px; }
        .app-pending { border-color: #ffd700; color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        /* Clubs & Messages Styles */
        .club-card { background: #0a0000; border: 1px solid #400; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        .club-card:hover { border-color: #700; }
        .club-name { color: #d40000; font-weight: bold; font-size: 14px; }
        .club-members { color: #888; font-size: 10px; margin-top: 5px; }
        .club-badge { display: inline-block; padding: 2px 6px; background: #200; border: 1px solid #500; color: #f88; font-size: 9px; border-radius: 3px; margin: 2px; }
        .dm-list { max-height: 400px; overflow-y: auto; }
        .dm-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #0a0000; border: 1px solid #300; margin-bottom: 5px; cursor: pointer; transition: all 0.2s; }
        .dm-item:hover { background: #150000; border-color: #500; }
        .dm-item.unread { border-left: 3px solid #d40000; }
        .dm-avatar { width: 40px; height: 40px; border-radius: 50%; background: #111; display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
        .dm-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dm-preview { flex: 1; overflow: hidden; }
        .dm-name { color: #d40000; font-weight: bold; font-size: 12px; }
        .dm-last { color: #666; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dm-time { color: #555; font-size: 9px; }
        .msg-bubble { max-width: 70%; padding: 8px 12px; margin: 5px; border-radius: 12px; font-size: 12px; }
        .msg-bubble.sent { background: #300; color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .msg-bubble.received { background: #111; color: #ddd; border-bottom-left-radius: 4px; }
        .friend-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: #0a0000; border: 1px solid #300; margin-bottom: 5px; }
        .friend-actions { margin-left: auto; display: flex; gap: 5px; }
        .stakes-grid { display: grid; grid-template-columns: repeat(9, 26px); gap: 1px; justify-content: center; }
        .stakes-cell { width: 26px; height: 26px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .stakes-cell.revealed { background: #111; }
        .stakes-cell.stake { background: #500; }
        .game-status { text-align: center; margin: 8px 0; color: #d40000; font-size: 11px; }
        .mgmt-sidebar { width: 160px; background: #0a0000; border-right: 1px solid #400; }
        .mgmt-sidebar-item { padding: 10px 12px; color: #888; font-size: 11px; cursor: pointer; border-bottom: 1px solid #300; transition: all 0.2s; }
        .mgmt-sidebar-item:hover { background: #150000; color: #d40000; }
        .mgmt-sidebar-item.active { background: #200000; color: #d40000; border-left: 3px solid #d40000; }
        .user-id-display { font-family: monospace; color: #555; font-size: 9px; background: #050000; padding: 8px; border-top: 1px solid #300; margin-top: 10px; }
        /* ANNOUNCEMENT STYLES */
        @keyframes announceIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .announce-type-info { border-color: #4488ff !important; }
        .announce-type-info #announce_icon { color: #4488ff; }
        .announce-type-info #announce_title { color: #4488ff; }
        .announce-type-update { border-color: #00cc66 !important; }
        .announce-type-update #announce_icon { color: #00cc66; }
        .announce-type-update #announce_title { color: #00cc66; }
        .announce-type-warning { border-color: #ffaa00 !important; }
        .announce-type-warning #announce_icon { color: #ffaa00; }
        .announce-type-warning #announce_title { color: #ffaa00; }
        .announce-type-event { border-color: #ff66ff !important; }
        .announce-type-event #announce_icon { color: #ff66ff; }
        .announce-type-event #announce_title { color: #ff66ff; }
        /* MOBILE */
        @media screen and (max-width: 900px) {
            * { cursor: auto !important; }
            .bat-cursor { display: none !important; }
            #desktop { padding: 10px; gap: 10px; flex-direction: row; flex-wrap: wrap; justify-content: center; }
            .icon { width: 70px; margin-bottom: 5px; }
            .icon img.folder-icon { width: 36px; }
            .window { left: 5px !important; top: 50px !important; width: calc(100vw - 10px) !important; height: calc(100vh - 100px) !important; resize: none !important; }
            .chat-container { flex-direction: column; height: auto !important; max-height: 50vh; }
            #chat_logs { height: 200px; min-height: 200px; }
            #member_list { width: 100% !important; border-left: none !important; border-top: 1px solid #400; max-height: 150px; }
            .profile-card { left: 10px !important; top: 60px !important; width: calc(100vw - 20px) !important; max-height: 70vh !important; }
            .boot-title { font-size: 36px; }
            #chat_avatar { padding: 10px !important; }
            #chat_avatar > div:first-child { flex-direction: column; align-items: center; }
            .taskbar { height: 35px; }
            #memories_grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; padding: 10px !important; }
            .stakes-grid { grid-template-columns: repeat(9, 22px) !important; }
            .stakes-cell { width: 22px !important; height: 22px !important; font-size: 10px !important; }
            .ie-input { padding: 8px; font-size: 14px; }
            .ie-btn { padding: 10px; font-size: 12px; }
            .mgmt-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #400; display: flex; flex-wrap: wrap; }
            .mgmt-sidebar-item { flex: 1; min-width: 80px; text-align: center; border-bottom: none; }
        }
        @media screen and (max-width: 500px) {
            .boot-title { font-size: 28px; }
            #memories_grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
<div class="bat-cursor" id="batCursor">
    <svg viewBox="0 0 32 32" fill="#8b0000">
        <g class="wing-left"><path d="M16 14 L8 8 L6 12 L10 14 L6 16 L4 14 L2 18 L8 18 L12 16 L16 16 Z"/></g>
        <g class="wing-right"><path d="M16 14 L24 8 L26 12 L22 14 L26 16 L28 14 L30 18 L24 18 L20 16 L16 16 Z"/></g>
        <ellipse cx="16" cy="16" rx="4" ry="5"/><circle cx="16" cy="11" r="3"/>
        <circle cx="15" cy="10" r="0.8" fill="#ff0000"/><circle cx="17" cy="10" r="0.8" fill="#ff0000"/>
    </svg>
</div>
<div id="screensaver"></div>
<!-- Profile Window -->
<div class="window" id="profile_window" style="left:250px; top:40px; width:480px; height:700px; display:none; z-index:9000;">
    <div class="title-bar"><div class="title-bar-text" id="pw_title">ğŸ‘¤ Profile</div><div class="title-bar-controls"><button aria-label="Close" onclick="closeProfileWindow()"></button></div></div>
    <div class="window-body" style="overflow-y:auto; padding:0; position:relative;">
        <div id="pw_bg_overlay" style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); pointer-events:none; z-index:0; display:none;"></div>
        <div style="position:relative; z-index:1;">
        <div style="background:linear-gradient(180deg, rgba(32,0,0,0.9), rgba(16,0,0,0.9)); padding:20px; text-align:center; border-bottom:2px solid #500;">
            <div id="pw_avatar" style="width:100px; height:100px; border-radius:50%; background:#111; border:4px solid #700; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:50px; overflow:hidden;">ğŸ¦‡</div>
            <div id="pw_name" style="font-size:22px; font-weight:bold; color:#d40000;"></div>
            <div id="pw_rank" style="font-size:12px; color:#888; margin-top:5px;"></div>
            <div id="pw_status" style="font-size:11px; color:#aaa; margin-top:8px; font-style:italic;"></div>
            <div id="pw_mood" style="font-size:10px; color:#666; margin-top:4px;"></div>
        </div>
        <div style="display:flex; background:rgba(10,0,0,0.9); border-bottom:1px solid #400;">
            <div style="flex:1; text-align:center; padding:15px; border-right:1px solid #400;">
                <div id="pw_rep" style="color:#ff4444; font-size:24px; font-weight:bold;">0</div>
                <div style="color:#666; font-size:9px; text-transform:uppercase;">Reputation</div>
            </div>
            <div style="flex:1; text-align:center; padding:15px;">
                <div id="pw_comments_count" style="color:#ff4444; font-size:24px; font-weight:bold;">0</div>
                <div style="color:#666; font-size:9px; text-transform:uppercase;">Comments</div>
            </div>
        </div>
        <div style="padding:15px; border-bottom:1px solid #400; background:rgba(5,0,0,0.85);">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:8px;">ğŸ“œ ABOUT</div>
            <div id="pw_bio" style="color:#aaa; font-size:12px; line-height:1.6;">No bio set.</div>
        </div>
        <div id="pw_clubs_section" style="padding:15px; border-bottom:1px solid #400; display:none; background:rgba(5,0,0,0.85);">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:10px;">ğŸ° CLUBS</div>
            <div id="pw_clubs_list" style="display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow-y:auto;"></div>
        </div>
        <div id="pw_music_section" style="padding:15px; border-bottom:1px solid #400; display:none; background:rgba(5,0,0,0.85);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div style="color:#d40000; font-size:11px; font-weight:bold;">PROFILE MUSIC</div>
                <button class="ie-btn" id="pw_mute_btn" style="width:auto; padding:4px 10px; font-size:10px; margin:0;" onclick="toggleProfileMusic()">ğŸ”‡ Mute</button>
            </div>
            <div id="pw_music_player"></div>
        </div>
        <div id="pw_badges_section" style="padding:15px; border-bottom:1px solid #400; display:none; background:rgba(5,0,0,0.85);">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:10px;">BADGES</div>
            <div id="pw_badges_list" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
        </div>
        <div style="padding:15px; display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid #400; background:rgba(5,0,0,0.85);">
            <button class="ie-btn" style="flex:1; min-width:100px; margin:0;" onclick="startDMFromProfile()">ğŸ’¬ Message</button>
            <button class="ie-btn" id="pw_btn_rep_pos" style="flex:1; min-width:80px; margin:0; background:#030; border-color:#0a0; display:none;" onclick="giveRep(1)">ğŸ‘ +Rep</button>
            <button class="ie-btn" id="pw_btn_rep_neg" style="flex:1; min-width:80px; margin:0; background:#500; border-color:#a00; display:none;" onclick="giveRep(-1)">ğŸ‘ -Rep</button>
        </div>
        <div style="padding:15px; background:rgba(5,0,0,0.85);">
            <div style="color:#d40000; font-size:11px; font-weight:bold; margin-bottom:10px;">PROFILE COMMENTS</div>
            <div id="pw_comments_list" style="max-height:200px; overflow-y:auto; margin-bottom:15px; padding:5px; background:rgba(5,0,0,0.9); border:1px solid #300; border-radius:4px;">
                <div style="color:#555; font-size:10px; padding:10px; text-align:center;">No comments yet.</div>
            </div>
            <div id="pw_comment_form" style="display:none;">
                <input type="text" id="pw_comment_input" class="ie-input" placeholder="Leave a comment..." style="margin-bottom:8px;">
                <button class="ie-btn" style="padding:8px;" onclick="leaveProfileComment()">Post Comment</button>
            </div>
        </div>
        <div style="padding:12px 15px; background:rgba(5,0,0,0.95); border-top:1px solid #400;">
            <div style="color:#444; font-size:9px; font-family:monospace;" id="pw_user_id">User ID: ...</div>
        </div>
        </div>
    </div>
</div>
<!-- SITE ANNOUNCEMENT OVERLAY -->
<div id="announcement_overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99999; display:none; justify-content:center; align-items:center;">
    <div id="announcement_box" style="background:linear-gradient(180deg, #1a0808, #0a0000); border:2px solid #d40000; border-radius:8px; padding:30px 40px; max-width:600px; width:90%; text-align:center; box-shadow:0 0 50px rgba(139,0,0,0.5); animation:announceIn 0.5s ease;">
        <div id="announce_icon" style="font-size:40px; margin-bottom:15px;">ğŸ“¢</div>
        <div id="announce_image" style="display:none; margin-bottom:15px;"></div>
        <div id="announce_title" style="color:#d40000; font-size:18px; font-weight:bold; margin-bottom:15px;"></div>
        <div id="announce_text" style="color:#ddd; font-size:14px; line-height:1.6; min-height:50px;"></div>
        <div id="announce_cursor" style="display:inline-block; width:2px; height:16px; background:#d40000; margin-left:2px; animation:blink 0.7s infinite;"></div>
        <div id="announce_music_indicator" style="display:none; margin-top:15px; color:#ffd700; font-size:11px;">ğŸµ Now Playing...</div>
        <div style="margin-top:20px; color:#666; font-size:10px;">Click anywhere to dismiss</div>
    </div>
</div>
<div id="boot-screen" onclick="beginSession()">
    <div style="font-size: 80px; margin-bottom: 20px; animation: batFloat 3s ease-in-out infinite;">ğŸ¦‡</div>
    <h1 class="boot-title">fangtasia.wtf</h1>
    <p class="boot-subtitle">Click anywhere to enter the crypt...</p>
    <div style="margin-top: 30px;"><div class="visitor-counter">SOULS COLLECTED: <span id="visitor_count">000000</span></div></div>
    <div style="margin-top: 40px; color: #500; font-size: 10px; animation: flicker 3s infinite;">â–¼ CLICK TO INITIALIZE â–¼</div>
</div>
<div id="desktop">
    <div class="icon" onclick="toggleWin('memories_folder')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png"><div>Memories</div></div>
    <div class="icon" onclick="toggleWin('ie_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/msie1-2.png"><div>Portal</div></div>
    <div class="icon" onclick="toggleWin('games_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/joystick-2.png"><div>Games</div></div>
    <div class="icon" onclick="toggleWin('apply_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/keys-0.png"><div>Apply</div></div>
    <div class="icon" onclick="toggleWin('about_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/help_book_cool-4.png"><div>About</div></div>
    <div class="icon" id="clubs_icon" style="display:none;" onclick="toggleWin('clubs_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/network_neighborhood-0.png"><div>Clubs</div></div>
    <div class="icon" id="messages_icon" style="display:none;" onclick="toggleWin('messages_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/mail_-5.png"><div>Messages</div></div>
    <div class="icon" id="watchparty_icon" style="display:none;" onclick="toggleWin('watchparty_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/mplayer-1.png"><div>Watch Party</div></div>
    <div class="icon" id="admin_icon" style="display:none;" onclick="toggleWin('admin_window')"><img class="folder-icon" src="https://win98icons.alexmeub.com/icons/png/lock-0.png"><div>Admin Panel</div></div>
</div>
<div class="window" id="about_window" style="left:200px; top:120px; width:350px; height:320px;">
    <div class="title-bar"><div class="title-bar-text">About fangtasia.wtf</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('about_window')"></button></div></div>
    <div class="window-body"><div class="ie-content" style="text-align: center;"><h2 style="font-size: 28px; margin-bottom: 5px;">fangtasia.wtf</h2><p style="color: #666; font-size: 10px;">Version 6.66</p><div style="border: 1px solid #400; padding: 15px; margin: 15px 0; text-align: left; background: #050000;"><p style="color: #999; font-size: 11px; line-height: 1.6;">Welcome to the digital crypt.<br><br>ğŸ¦‡ <span style="color:#d40000;">Memories</span> - Video archive<br>ğŸ¦‡ <span style="color:#d40000;">Portal</span> - Member access<br>ğŸ¦‡ <span style="color:#d40000;">Games</span> - Silver Stakes<br>ğŸ¦‡ <span style="color:#d40000;">The Lounge</span> - Members only</p></div></div></div>
</div>
<div class="window" id="games_window" style="left:180px; top:70px; width:320px; height:400px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ® Silver Stakes</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('games_window')"></button></div></div>
    <div class="window-body"><div style="padding: 10px;"><h3 style="color: #d40000; text-align: center; margin: 5px 0;">Silver Stakes</h3><p style="color: #666; font-size: 9px; text-align: center;">Avoid the stakes!</p><div class="game-status" id="game_status">ğŸ¦‡ Stakes: 10</div><div class="stakes-grid" id="stakes_grid"></div><div style="text-align: center; margin-top: 8px;"><button class="ie-btn" style="width: auto; padding: 4px 15px;" onclick="initStakesGame()">New Game</button></div></div></div>
</div>
<div class="window" id="apply_window" style="left:160px; top:90px; width:340px; height:440px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ”‘ Apply for Access</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('apply_window')"></button></div></div>
    <div class="window-body"><div class="ie-content"><h2 style="margin-top: 0; font-size: 18px;">Join the Coven</h2><div id="app_form"><input type="text" id="app_username" class="ie-input" placeholder="Desired Username" maxlength="20"><input type="text" id="app_referral" class="ie-input" placeholder="Who referred you?"><textarea id="app_reason" class="ie-input" placeholder="Why do you seek entry?" style="height: 60px; resize: none;"></textarea><button class="ie-btn" onclick="submitApplication()">ğŸ©¸ Submit Blood Pact</button><button class="ie-btn" style="background: #333; margin-top: 5px;" onclick="checkAppStatus()">Check Status</button></div><div id="app_result" style="display: none;"></div></div></div>
</div>
<div class="window" id="chat_win" style="left:400px; top:30px; width:820px; height:620px;">
    <div class="title-bar"><div class="title-bar-text">ğŸ©¸ The Lounge</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('chat_win')"></button></div></div>
    <div class="window-body">
        <div class="tab-bar"><div class="tab active" onclick="switchChatTab('main', this)">ğŸ’¬ Lounge</div><div class="tab" onclick="switchChatTab('avatar', this)">ğŸ¦‡ My Profile</div></div>
        <div id="chat_main">
            <div id="pinned_container"></div>
            <div class="chat-container" id="chat_container">
                <div id="chat_logs"></div>
                <div id="member_list">
                    <div id="online_member_list" style="padding:8px;"></div>
                </div>
            </div>
            <div id="typing_area" style="padding: 5px 12px; background: #080000; display: none;"><div class="typing-indicator"><span id="typing_user"></span>&nbsp;is typing<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
            <div id="reply_indicator" style="display:none; padding:8px 12px; background:#1a0a0a; border-left:3px solid #d40000;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="color:#888; font-size:10px;">Replying to <span id="reply_to_user" style="color:#d40000;"></span>: <span id="reply_to_text" style="color:#666;"></span></div>
                    <button onclick="cancelReply()" style="background:none; border:none; color:#f00; cursor:pointer; font-size:14px;">âœ•</button>
                </div>
            </div>
            <div style="padding:10px; background:#111;">
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <input type="text" id="chat_input" class="ie-input" style="margin:0; flex:1;" placeholder="/help for commands... @username to mention" onkeypress="handleChatKey(event)" onkeyup="handleTyping()">
                    <label class="ie-btn" style="width: 35px; margin: 0; display: flex; align-items: center; justify-content: center; padding: 0;">ğŸ“<input type="file" id="chat_file" accept="image/*,video/*,audio/*,.gif" style="display:none;" onchange="uploadChatFile()"></label>
                </div>
                <button class="ie-btn" onclick="sendChat()">Send</button>
            </div>
        </div>
        <div id="chat_avatar" style="display: none; padding: 20px; overflow-y: auto; height: calc(100% - 40px);">
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="text-align:center;">
                    <div id="my_avatar_display" style="width:120px; height:120px; border-radius:50%; background:#111; border:3px solid #700; display:flex; align-items:center; justify-content:center; font-size:60px; overflow:hidden; margin:0 auto;">ğŸ¦‡</div>
                    <div id="my_username_display" style="color:#d40000; font-size:18px; font-weight:bold; margin-top:10px;"></div>
                    <div id="my_rank_display" style="color:#888; font-size:12px;"></div>
                </div>
                <div style="flex:1;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Edit Profile</h3>
                    <label style="color:#888; font-size:10px;">Profile Picture URL</label>
                    <input type="text" id="avatar_url" class="ie-input" placeholder="Paste image URL">
                    <label style="color:#888; font-size:10px;">Or Upload Image</label>
                    <input type="file" id="avatar_upload" class="ie-input" accept="image/*" style="border:none; padding:5px 0;">
                    <button class="ie-btn" style="padding:8px; margin-bottom:15px;" onclick="updateAvatar()">Update Avatar</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr; gap:15px;">
                <div>
                    <label style="color:#888; font-size:10px;">Profile Music (SoundCloud/Spotify URL)</label>
                    <input type="text" id="profile_music" class="ie-input" placeholder="https://soundcloud.com/...">
                    <button class="ie-btn" style="padding:8px;" onclick="updateProfileMusic()">Set Music</button>
                </div>
                <div>
                    <label style="color:#888; font-size:10px;">Mood Status</label>
                    <select id="user_mood" class="ie-input" onchange="saveProfile()">
                        <option value="">None</option><option value="ğŸ©¸ Thirsty">ğŸ©¸ Thirsty</option><option value="ğŸ˜´ Dormant">ğŸ˜´ Dormant</option><option value="ğŸŒ™ Hunting">ğŸŒ™ Hunting</option><option value="âš°ï¸ Resting">âš°ï¸ Resting</option><option value="ğŸ¦‡ Lurking">ğŸ¦‡ Lurking</option><option value="ğŸ”¥ Vibing">ğŸ”¥ Vibing</option><option value="ğŸ’€ Dead Inside">ğŸ’€ Dead Inside</option>
                    </select>
                    <label style="color:#888; font-size:10px;">Custom Status</label>
                    <input type="text" id="user_status" class="ie-input" placeholder="What's happening..." maxlength="30">
                    <label style="color:#888; font-size:10px;">Bio</label>
                    <textarea id="user_bio" class="ie-input" placeholder="Tell us about yourself..." maxlength="200" style="height:80px; resize:none;"></textarea>
                    <div id="vip_bg_section" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid #400;">
                        <label style="color:#ffd700; font-size:10px;">âœ¨ VIP: Animated Profile Background</label>
                        <input type="text" id="profile_bg" class="ie-input" placeholder="GIF/Image URL or Tenor link">
                        <p style="color:#666; font-size:9px; margin:5px 0;">Supports: Direct image/GIF URLs, Tenor GIF links</p>
                    </div>
                </div>
            </div>
            <button class="ie-btn" style="margin-top:20px; padding:12px; background:#700;" onclick="saveProfile()">ğŸ’¾ Save All Changes</button>
        </div>
    </div>
</div>
<!-- CLUBS WINDOW -->
<div class="window" id="clubs_window" style="left:150px; top:80px; width:650px; height:500px; display:none;">
    <div class="title-bar"><div class="title-bar-text">ğŸ° Clubs</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('clubs_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:100%;">
        <div class="mgmt-sidebar">
            <div class="mgmt-sidebar-item active" onclick="switchClubTab('browse', this)">ğŸ” Browse</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('my', this)">ğŸ“‹ My Clubs</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('create', this)">âœ¨ Create</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('invites', this)">ğŸ“© Invites</div>
            <div class="mgmt-sidebar-item" onclick="switchClubTab('manage', this)" id="club_manage_tab" style="display:none;">âš™ï¸ Manage</div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:15px; overflow-y:auto;">
            <div id="club_tab_browse">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#d40000; margin:0;">Browse Clubs</h3>
                    <button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0;" onclick="loadAllClubs(); this.textContent='Loading...'; setTimeout(() => this.textContent='ğŸ”„ Refresh', 500);">ğŸ”„ Refresh</button>
                </div>
                <input type="text" id="club_search" class="ie-input" placeholder="Search clubs..." oninput="searchClubs()" style="margin-bottom:10px;">
                <div id="clubs_list" style="min-height:200px; max-height:350px; overflow-y:auto; border:1px solid #300; border-radius:4px; background:#050000; padding:10px;"></div>
            </div>
            <div id="club_tab_my" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">My Clubs <span style="color:#666; font-size:11px;">(Max 5)</span></h3>
                <div id="my_clubs_list"></div>
            </div>
            <div id="club_tab_create" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Create a Club</h3>
                <div id="create_club_form">
                    <input type="text" id="new_club_name" class="ie-input" placeholder="Club Name" maxlength="30">
                    <textarea id="new_club_desc" class="ie-input" placeholder="Club Description" maxlength="200" style="height:80px; resize:none;"></textarea>
                    <input type="text" id="new_club_color" class="ie-input" placeholder="Club Color (hex)" value="#d40000">
                    <button class="ie-btn" onclick="createClub()">ğŸ° Create Club</button>
                    <div id="create_club_result" style="margin-top:10px; font-size:11px;"></div>
                </div>
                <div id="already_owns_club" style="display:none; color:#888; text-align:center; padding:20px;">
                    <p>You already own a club!</p>
                    <p style="font-size:10px;">Each user can only create one club.</p>
                </div>
            </div>
            <div id="club_tab_invites" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Club Invites</h3>
                <div id="club_invites_list"></div>
            </div>
            <div id="club_tab_manage" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Manage Your Club</h3>
                <div id="manage_club_content"></div>
            </div>
        </div>
    </div>
</div>
<!-- MESSAGES WINDOW -->
<div class="window" id="messages_window" style="left:180px; top:60px; width:700px; height:520px; display:none;">
    <div class="title-bar"><div class="title-bar-text">ğŸ’¬ Messages</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('messages_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:100%;">
        <div class="mgmt-sidebar">
            <div class="mgmt-sidebar-item active" onclick="switchMsgTab('dms', this)">ğŸ“¨ DMs</div>
            <div class="mgmt-sidebar-item" onclick="switchMsgTab('groups', this)">ğŸ‘¥ Groups</div>
            <div class="mgmt-sidebar-item" onclick="switchMsgTab('friends', this)">ğŸ¤ Friends</div>
            <div class="mgmt-sidebar-item" onclick="switchMsgTab('requests', this)">ğŸ“© Requests <span id="friend_req_count" style="color:#f00;"></span></div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:0; overflow:hidden; display:flex; flex-direction:column;">
            <div id="msg_tab_dms" style="flex:1; display:flex; flex-direction:column;">
                <div id="dm_list_view" style="flex:1; overflow-y:auto; padding:15px;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Direct Messages</h3>
                    <div id="dm_conversations" class="dm-list"></div>
                </div>
                <div id="dm_chat_view" style="display:none; flex:1; flex-direction:column;">
                    <div style="padding:10px; background:#0a0000; border-bottom:1px solid #400; display:flex; align-items:center; gap:10px;">
                        <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="closeDMChat()">â† Back</button>
                        <div id="dm_chat_avatar" style="width:30px; height:30px; border-radius:50%; background:#111; border:2px solid #500; display:flex; align-items:center; justify-content:center; font-size:14px; overflow:hidden;">ğŸ¦‡</div>
                        <span id="dm_chat_name" style="color:#d40000; font-weight:bold;"></span>
                    </div>
                    <div id="dm_messages" style="flex:1; overflow-y:auto; padding:10px;"></div>
                    <div style="padding:10px; background:#111; border-top:1px solid #400;">
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="text" id="dm_input" class="ie-input" style="margin:0; flex:1;" placeholder="Type a message or paste image/gif URL..." onkeypress="if(event.key==='Enter')sendDM()">
                            <button class="ie-btn" style="width:auto; padding:8px 12px; font-size:11px;" onclick="showDMMediaInput()" title="Send Image/GIF/Video">ğŸ“</button>
                            <button class="ie-btn" style="width:auto; padding:8px 15px;" onclick="sendDM()">Send</button>
                        </div>
                        <div id="dm_media_preview" style="display:none; margin-top:8px; padding:8px; background:#0a0000; border:1px solid #400; border-radius:4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="color:#888; font-size:10px;">Media URL:</span>
                                <button onclick="document.getElementById('dm_media_preview').style.display='none'; document.getElementById('dm_media_url').value='';" style="background:none; border:none; color:#f00; cursor:pointer; font-size:12px;">âœ•</button>
                            </div>
                            <input type="text" id="dm_media_url" class="ie-input" style="margin:0; font-size:10px;" placeholder="Paste image/gif/mp4 URL here...">
                        </div>
                    </div>
                </div>
            </div>
            <div id="msg_tab_groups" style="display:none; flex:1; flex-direction:column;">
                <div id="group_list_view" style="flex:1; overflow-y:auto; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#d40000; margin:0;">Group Chats</h3>
                        <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="showCreateGroup()">+ New Group</button>
                    </div>
                    <div id="group_conversations" class="dm-list"></div>
                </div>
                <div id="group_chat_view" style="display:none; flex:1; flex-direction:column;">
                    <div style="padding:10px; background:#0a0000; border-bottom:1px solid #400; display:flex; align-items:center; gap:10px;">
                        <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="closeGroupChat()">â† Back</button>
                        <span id="group_chat_name" style="color:#d40000; font-weight:bold;"></span>
                        <button class="ie-btn" style="width:auto; padding:5px 10px; margin-left:auto;" onclick="showGroupMembers()">ğŸ‘¥</button>
                    </div>
                    <div id="group_messages" style="flex:1; overflow-y:auto; padding:10px;"></div>
                    <div style="padding:10px; background:#111; border-top:1px solid #400;">
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="text" id="group_input" class="ie-input" style="margin:0; flex:1;" placeholder="Type a message or paste image/gif URL..." onkeypress="if(event.key==='Enter')sendGroupMsg()">
                            <button class="ie-btn" style="width:auto; padding:8px 12px; font-size:11px;" onclick="showGroupMediaInput()" title="Send Image/GIF/Video">ğŸ“</button>
                            <button class="ie-btn" style="width:auto; padding:8px 15px;" onclick="sendGroupMsg()">Send</button>
                        </div>
                        <div id="group_media_preview" style="display:none; margin-top:8px; padding:8px; background:#0a0000; border:1px solid #400; border-radius:4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="color:#888; font-size:10px;">Media URL:</span>
                                <button onclick="document.getElementById('group_media_preview').style.display='none'; document.getElementById('group_media_url').value='';" style="background:none; border:none; color:#f00; cursor:pointer; font-size:12px;">âœ•</button>
                            </div>
                            <input type="text" id="group_media_url" class="ie-input" style="margin:0; font-size:10px;" placeholder="Paste image/gif/mp4 URL here...">
                        </div>
                    </div>
                </div>
                <div id="create_group_view" style="display:none; padding:15px;">
                    <h3 style="color:#d40000; margin:0 0 15px 0;">Create Group Chat</h3>
                    <input type="text" id="new_group_name" class="ie-input" placeholder="Group Name" maxlength="30">
                    <p style="color:#888; font-size:10px; margin:10px 0 5px 0;">Select friends to add:</p>
                    <div id="group_friend_select" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
                    <button class="ie-btn" onclick="createGroupChat()">Create Group</button>
                    <button class="ie-btn" style="background:#333;" onclick="cancelCreateGroup()">Cancel</button>
                </div>
            </div>
            <div id="msg_tab_friends" style="display:none; flex-direction:column; padding:20px; overflow-y:auto; flex:1;">
                <h3 style="color:#d40000; margin:0 0 15px 0; font-size:16px; flex-shrink:0;">ğŸ‘¥ Your Friends</h3>
                <div id="friends_list" style="flex:1; min-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid #400; border-radius:4px; background:#050000;"></div>
                <div style="background:#0a0000; padding:15px; border:1px solid #400; border-radius:6px; flex-shrink:0;">
                    <label style="color:#d40000; font-size:12px; display:block; margin-bottom:8px; font-weight:bold;">â• Add a Friend</label>
                    <input type="text" id="add_friend_input" class="ie-input" placeholder="Enter username..." style="margin-bottom:10px;">
                    <button class="ie-btn" style="width:100%;" onclick="sendFriendRequest()">Send Friend Request</button>
                </div>
            </div>
            <div id="msg_tab_requests" style="display:none; padding:20px; overflow-y:auto; flex:1;">
                <h3 style="color:#d40000; margin:0 0 15px 0; font-size:16px;">ğŸ“© Friend Requests</h3>
                <div id="friend_requests_list" style="min-height:100px;"></div>
            </div>
        </div>
    </div>
</div>
<!-- WATCH PARTY -->
<div class="window" id="watchparty_window" style="left:150px; top:30px; width:900px; height:650px; display:none;">
    <div class="title-bar"><div class="title-bar-text">ğŸ©¸ Watch Party</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('watchparty_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:calc(100% - 25px); background:#0a0000; overflow:hidden;">
        <div class="mgmt-sidebar" style="width:180px; background:#050000; border-right:1px solid #500; flex-shrink:0;">
            <div class="mgmt-sidebar-item active" onclick="switchWatchPartyTab('rooms', this)">ğŸ¬ Party Rooms</div>
            <div class="mgmt-sidebar-item" onclick="switchWatchPartyTab('create', this)">â• Create Room</div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:0; overflow:hidden; display:flex; flex-direction:column; background:#0a0000; min-height:0;">
            <div id="wp_tab_rooms" style="flex:1; overflow-y:auto; padding:15px;">
                <h3 style="color:#d40000; margin:0 0 15px 0; text-shadow:0 0 10px rgba(139,0,0,0.5);">ğŸ¬ Active Watch Parties</h3>
                <button class="ie-btn" style="width:auto; padding:5px 15px; margin-bottom:10px;" onclick="loadWatchPartyRooms()">ğŸ”„ Refresh</button>
                <div id="wp_room_list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
            <div id="wp_tab_create" style="display:none; padding:15px; overflow-y:auto;">
                <h3 style="color:#d40000; margin:0 0 15px 0; text-shadow:0 0 10px rgba(139,0,0,0.5);">â• Create Watch Party</h3>
                <input type="text" id="wp_room_name" class="ie-input" placeholder="Room name (e.g., Movie Night)">
                <input type="text" id="wp_video_url" class="ie-input" placeholder="YouTube URL (e.g., https://youtube.com/watch?v=...)">
                <select id="wp_room_type" class="ie-input">
                    <option value="public">ğŸŒ Public</option>
                    <option value="private">ğŸ”’ Private</option>
                </select>
                <button class="ie-btn" onclick="createWatchPartyRoom()">Create Room</button>
                <div id="wp_create_result" style="margin-top:10px; font-size:11px;"></div>
            </div>
            <div id="wp_tab_room" style="display:none; flex:1; flex-direction:column; min-height:0; overflow:hidden;">
                <div style="padding:8px 10px; background:linear-gradient(180deg, #1a0808, #0a0000); border-bottom:2px solid #500; display:flex; align-items:center; gap:10px; flex-shrink:0;">
                    <button class="ie-btn" style="width:auto; padding:5px 10px;" onclick="leaveWatchPartyRoom()">â† Leave</button>
                    <span id="wp_room_title" style="color:#d40000; font-weight:bold; text-shadow:0 0 5px rgba(139,0,0,0.5);"></span>
                    <span id="wp_host_badge" style="color:#ffd700; font-size:9px; background:#1a1a00; padding:2px 6px; border-radius:3px; display:none;">ğŸ‘‘ HOST</span>
                    <span id="wp_viewer_count" style="color:#888; font-size:10px; margin-left:auto;">ğŸ‘¥ 0 watching</span>
                </div>
                <div style="display:flex; flex:1; min-height:0; overflow:hidden;">
                    <div style="flex:1; display:flex; flex-direction:column; background:#000; min-height:0;">
                        <div id="wp_player_container" style="flex:1; display:flex; align-items:center; justify-content:center; background:#000; border:1px solid #300; position:relative; min-height:200px;">
                            <div id="wp_player" style="width:100%; height:100%;"></div>
                            <button id="wp_fullscreen_btn" onclick="wpToggleFullscreen()" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.7); border:1px solid #500; color:#888; padding:5px 10px; font-size:10px; cursor:pointer; border-radius:3px; z-index:10;">â›¶ Fullscreen</button>
                        </div>
                        <div id="wp_controls" style="padding:8px; background:linear-gradient(180deg, #0a0000, #050000); border-top:1px solid #500; display:flex; gap:8px; align-items:center; flex-shrink:0;">
                            <button class="ie-btn wp-host-only" style="width:auto; padding:4px 12px; font-size:11px;" onclick="wpTogglePlay()" id="wp_play_btn">â–¶ï¸</button>
                            <input type="range" id="wp_seek" min="0" max="100" value="0" style="flex:1; accent-color:#d40000;" class="wp-host-only">
                            <span id="wp_time" style="color:#666; font-size:9px; min-width:70px;">0:00 / 0:00</span>
                            <button class="ie-btn" style="width:auto; padding:4px 8px; font-size:10px;" onclick="wpSyncToHost()" title="Sync to host">ğŸ”„ Sync</button>
                        </div>
                    </div>
                    <div style="width:220px; display:flex; flex-direction:column; border-left:2px solid #500; background:#050000; min-height:0; flex-shrink:0;">
                        <div style="padding:6px 8px; background:#0a0000; border-bottom:1px solid #400; flex-shrink:0;">
                            <div style="color:#888; font-size:9px; margin-bottom:4px;">ğŸ‘¥ WATCHING</div>
                            <div id="wp_viewer_list" style="display:flex; flex-wrap:wrap; gap:4px; max-height:40px; overflow-y:auto; font-size:9px;"></div>
                        </div>
                        <div style="padding:8px; background:linear-gradient(180deg, #1a0808, #0a0000); border-bottom:1px solid #500; color:#d40000; font-size:10px; font-weight:bold; flex-shrink:0;">ğŸ’¬ Party Chat</div>
                        <div id="wp_chat_messages" style="flex:1; overflow-y:auto; padding:8px; font-size:10px; background:#030000; min-height:0;"></div>
                        <div style="padding:8px; background:#0a0000; border-top:1px solid #500; flex-shrink:0;">
                            <div style="display:flex; gap:4px;">
                                <input type="text" id="wp_chat_input" class="ie-input" style="margin:0; flex:1; font-size:9px; padding:5px;" placeholder="Chat..." onkeypress="if(event.key==='Enter')sendWPChat()">
                                <button class="ie-btn" style="width:auto; padding:4px 8px; font-size:9px;" onclick="sendWPChat()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ADMIN PANEL -->
<div class="window" id="admin_window" style="left:100px; top:40px; width:750px; height:550px; display:none;">
    <div class="title-bar"><div class="title-bar-text">ğŸ‘‘ Admin Control Panel</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('admin_window')"></button></div></div>
    <div class="window-body" style="display:flex; height:100%;">
        <div class="mgmt-sidebar">
            <div class="mgmt-sidebar-item active" id="admin_tab_apps_btn" onclick="switchAdminTab('apps', this)">ğŸ“ Applications</div>
            <div class="mgmt-sidebar-item" id="admin_tab_members_btn" onclick="switchAdminTab('members', this)">ğŸ‘¥ Members</div>
            <div class="mgmt-sidebar-item" id="admin_tab_moderation_btn" onclick="switchAdminTab('moderation', this)">âš ï¸ Moderation</div>
            <div class="mgmt-sidebar-item" id="admin_tab_announcements_btn" onclick="switchAdminTab('announcements', this)">ğŸ“Œ Announcements</div>
            <div class="mgmt-sidebar-item" id="admin_tab_bot_btn" onclick="switchAdminTab('bot', this)">ğŸ§› Eric Bot</div>
            <div class="mgmt-sidebar-item" id="admin_tab_videos_btn" onclick="switchAdminTab('videos', this)">ğŸ“¹ Videos</div>
            <div class="mgmt-sidebar-item" id="admin_tab_vip_btn" onclick="switchAdminTab('vip', this)">ğŸŒŸ VIP Codes</div>
            <div class="mgmt-sidebar-item" id="st_tab" style="display:none;" onclick="switchAdminTab('st', this)">ğŸ”® ST Tools</div>
        </div>
        <div class="mgmt-content" style="flex:1; padding:15px; overflow-y:auto;">
            <div id="admin_tab_apps"><h3 style="color:#d40000; margin:0 0 15px 0;">Membership Applications</h3><div style="display:flex; gap:10px; margin-bottom:15px;"><select id="app_filter" class="ie-input" style="width:150px; margin:0;" onchange="loadAllApplications()"><option value="all">All</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="denied">Denied</option></select><input type="text" id="app_search" class="ie-input" placeholder="Search username..." style="flex:1; margin:0;" oninput="loadAllApplications()"></div><div id="all_applications" style="max-height:380px; overflow-y:auto;"></div></div>
            <div id="admin_tab_members" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">All Members</h3><div id="all_members" style="max-height:420px; overflow-y:auto;"></div></div>
            <div id="admin_tab_moderation" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">User Moderation</h3><div class="admin-section"><h4>Take Action</h4><input type="text" id="mod_username" class="ie-input" placeholder="Username to moderate..."><select id="mod_action" class="ie-input"><option value="">Select Action...</option><option value="warn">âš ï¸ Warn</option><option value="mute">ğŸ”‡ Mute (can't chat)</option><option value="timeout">â±ï¸ Timeout (can't chat)</option><option value="kick">ğŸ‘¢ Kick (offline)</option><option value="softban">ğŸš« Soft Ban</option><option value="hardban">â›” Hard Ban</option><option value="unmute">ğŸ”Š Unmute</option></select><select id="mod_duration" class="ie-input"><option value="5">5 minutes</option><option value="15">15 minutes</option><option value="30">30 minutes</option><option value="60">1 hour</option><option value="360">6 hours</option><option value="1440">24 hours</option><option value="10080">7 days</option><option value="43200">30 days</option><option value="0">Permanent</option></select><input type="text" id="mod_reason" class="ie-input" placeholder="Reason (optional)"><button class="ie-btn" style="background: #700;" onclick="executeModAction()">Execute Action</button><div id="mod_result" style="margin-top: 5px; font-size: 10px;"></div></div><div class="admin-section"><h4>ğŸ—‘ï¸ Delete Message</h4><input type="text" id="delete_msg_id" class="ie-input" placeholder="Message ID (from chat 3-dot menu)"><button class="ie-btn" style="background:#700;" onclick="deleteMessageById()">Delete Message</button><div id="delete_msg_result" style="margin-top:5px; font-size:10px;"></div></div><div class="admin-section"><h4>ğŸ”‡ Muted Users</h4><button class="ie-btn" style="width:auto; padding:5px 10px; margin-bottom:5px;" onclick="loadMutedUsers()">ğŸ”„ Refresh</button><div id="muted_users" style="max-height:100px; overflow-y:auto; font-size:10px;">Click refresh to load...</div></div><div class="admin-section"><h4>ğŸš« Banned/Suspended Users</h4><div id="banned_users" style="max-height:150px; overflow-y:auto; font-size:10px;">None</div></div></div>
            <div id="admin_tab_announcements" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">Lounge Announcements</h3><div class="admin-section"><h4>Pin Message</h4><input type="text" id="pin_message" class="ie-input" placeholder="Message to pin in the lounge..."><div style="display:flex; gap:10px;"><button class="ie-btn" style="flex:1;" onclick="pinMessage()">ğŸ“Œ Pin Message</button><button class="ie-btn" style="flex:1; background:#333;" onclick="clearPin()">Clear Pin</button></div></div><div class="admin-section"><h4>Chat Management</h4><button class="ie-btn" style="background: #500;" onclick="clearChat()">ğŸ—‘ï¸ Clear All Messages</button><button class="ie-btn" style="background: #333; margin-top:5px;" onclick="exportChat()">ğŸ“¥ Export Chat Log</button></div></div>
            <div id="admin_tab_bot" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">Eric Northman Bot</h3><div class="admin-section"><h4>Send as Eric</h4><textarea id="bot_message" class="ie-input" placeholder="Eric says..." style="height:80px; resize:none;"></textarea><button class="ie-btn" onclick="sendBotMessage()">ğŸ§› Send Message</button></div></div>
            <div id="admin_tab_videos" style="display:none;">
                <h3 style="color:#d40000; margin:0 0 15px 0;">Video Archive Management</h3>
                <button class="ie-btn" style="margin-bottom:15px; width:auto; padding:8px 15px;" onclick="loadAllVideos()">ğŸ”„ Refresh Videos</button>
                <div id="all_videos" style="max-height:380px; overflow-y:auto;"></div>
            </div>
            <div id="admin_tab_vip" style="display:none;"><h3 style="color:#d40000; margin:0 0 15px 0;">VIP Invite Codes</h3><div class="admin-section"><h4>Generate New Code</h4><div style="display:flex; gap:5px; margin-bottom:10px;"><input type="number" id="vip_code_uses" class="ie-input" placeholder="Max uses" value="5" min="1" max="100" style="width:100px;"><button class="ie-btn" style="flex:1;" onclick="generateVIPCode()">ğŸŒŸ Generate New Code</button></div><div id="vip_code_display" style="color:#ffd700; font-family:monospace; font-size:16px;"></div></div><div class="admin-section"><h4>Active VIP Codes</h4><button class="ie-btn" style="width:auto; padding:5px 15px; margin-bottom:10px;" onclick="loadVIPCodeHistory()">ğŸ”„ Refresh</button><div id="vip_code_history" style="max-height:300px; overflow-y:auto; font-size:11px;"><div style="color:#666;">Click refresh to load codes...</div></div></div></div>
            <div id="admin_tab_st" style="display:none;">
                <h3 style="color:#ff00ff; margin:0 0 15px 0;">ğŸ”® Site Technician Tools</h3>
                
                <!-- SECTION: USER MANAGEMENT -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ğŸ‘¤ USER MANAGEMENT <span style="float:right; font-size:10px;">â–¼</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Change Username</h4>
                            <input type="text" id="st_old_username" class="ie-input" placeholder="Current username">
                            <input type="text" id="st_new_username" class="ie-input" placeholder="New username">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stChangeUsername()">Change Username</button>
                            <div id="st_username_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Create New User</h4>
                            <input type="text" id="st_create_username" class="ie-input" placeholder="Username">
                            <input type="text" id="st_create_password" class="ie-input" placeholder="Password">
                            <select id="st_create_rank" class="ie-input">
                                <option value="member">Member</option>
                                <option value="vip">VIP</option>
                                <option value="contrib">Contributor</option>
                                <option value="mod">Moderator</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stCreateUser()">Create User</button>
                            <div id="st_create_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">User Lookup</h4>
                            <input type="text" id="st_lookup_username" class="ie-input" placeholder="Username">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stLookupUser()">Lookup</button>
                            <div id="st_lookup_result" style="margin-top:5px; font-size:10px; max-height:150px; overflow-y:auto;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">User Data Management</h4>
                            <input type="text" id="st_data_username" class="ie-input" placeholder="Username">
                            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stWipeProfile()">Wipe Profile</button>
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stWipeMessages()">Wipe Messages</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stDeleteUser()">Delete User</button>
                            </div>
                            <div id="st_data_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: ROLES & PERMISSIONS -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ğŸ” ROLES & PERMISSIONS <span style="float:right; font-size:10px;">â–¼</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Change User Rank</h4>
                            <input type="text" id="elevate_user" class="ie-input" placeholder="Username">
                            <select id="elevate_rank" class="ie-input">
                                <option value="member">Member (M)</option>
                                <option value="vip">VIP</option>
                                <option value="contrib">Contributor (K)</option>
                                <option value="mod">Moderator (MOD)</option>
                                <option value="admin">Admin (A)</option>
                            </select>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="elevateUser()">Set Rank</button>
                            <div id="st_elevate_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Set User Permissions</h4>
                            <input type="text" id="perm_user" class="ie-input" placeholder="Username">
                            <select id="perm_preset" class="ie-input" onchange="applyPermissionPreset()">
                                <option value="">-- Select Preset --</option>
                                <option value="none">No Special Permissions</option>
                                <option value="vip_perks">VIP Perks Only</option>
                                <option value="moderator">Moderator Powers</option>
                                <option value="admin">Full Admin</option>
                                <option value="custom">Custom</option>
                            </select>
                            <div style="background:#050000; padding:10px; border:1px solid #400; border-radius:4px; margin:5px 0;">
                                <label style="color:#888; font-size:11px; display:flex; align-items:center; gap:8px; padding:5px 0;"><input type="checkbox" id="perm_mod"> Moderator Powers</label>
                                <label style="color:#888; font-size:11px; display:flex; align-items:center; gap:8px; padding:5px 0;"><input type="checkbox" id="perm_admin"> Admin Access</label>
                                <label style="color:#888; font-size:11px; display:flex; align-items:center; gap:8px; padding:5px 0;"><input type="checkbox" id="perm_vip_perks"> VIP Perks</label>
                            </div>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="setUserPermissions()">Set Permissions</button>
                            <div id="st_perm_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Reset Password</h4>
                            <input type="text" id="st_reset_username" class="ie-input" placeholder="Username">
                            <input type="text" id="st_new_password" class="ie-input" placeholder="New password">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stResetPassword()">Reset Password</button>
                            <div id="st_password_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: TAGS -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ğŸ·ï¸ TAGS <span style="float:right; font-size:10px;">â–¼</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Custom User Tags (Chat)</h4>
                            <input type="text" id="st_tag_username" class="ie-input" placeholder="Username">
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="st_tag_letter" class="ie-input" placeholder="Tag text" style="width:100px;">
                                <input type="text" id="st_tag_color" class="ie-input" placeholder="Color (hex)" style="flex:1;" value="#ff00ff">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stSetCustomTag()">Set Tag</button>
                                <button class="ie-btn" style="flex:1; background:#333; border-color:#ff00ff;" onclick="stRemoveCustomTag()">Remove Tag</button>
                            </div>
                            <div id="st_tag_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Club Chat Tags</h4>
                            <p style="color:#666; font-size:9px; margin-bottom:10px;">Tags shown in chat for club members</p>
                            <input type="text" id="st_clubtag_club" class="ie-input" placeholder="Club name">
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="st_clubtag_tag" class="ie-input" placeholder="Tag text" style="flex:1;">
                                <input type="text" id="st_clubtag_color" class="ie-input" placeholder="Color" value="#d40000" style="width:100px;">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stSetClubTag()">Set Tag</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stRemoveClubTag()">Remove</button>
                            </div>
                            <input type="text" id="st_clubtag_remove" class="ie-input" placeholder="Club name to remove" style="margin-top:5px;">
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin-top:5px;" onclick="loadClubTagsList()">ğŸ”„ Refresh List</button>
                            <div id="st_clubtags_list" style="max-height:100px; overflow-y:auto; font-size:10px; background:#050000; padding:8px; border:1px solid #400; border-radius:4px; margin-top:5px;"></div>
                            <div id="st_clubtag_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Memberlist Tags</h4>
                            <p style="color:#666; font-size:9px; margin-bottom:10px;">Tags shown in the chatroom memberlist (club-based)</p>
                            <input type="text" id="st_mltag_club" class="ie-input" placeholder="Club name">
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="st_mltag_tag" class="ie-input" placeholder="Tag text" style="flex:1;">
                                <input type="text" id="st_mltag_color" class="ie-input" placeholder="Color" value="#6a03b4" style="width:100px;">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stSetMemberlistTag()">Set Tag</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stRemoveMemberlistTag()">Remove</button>
                            </div>
                            <input type="text" id="st_mltag_remove" class="ie-input" placeholder="Club name to remove" style="margin-top:5px;">
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin-top:5px;" onclick="loadMemberlistTagsList()">ğŸ”„ Refresh List</button>
                            <div id="st_mltags_list" style="max-height:100px; overflow-y:auto; font-size:10px; background:#050000; padding:8px; border:1px solid #400; border-radius:4px; margin-top:5px;"></div>
                            <div id="st_mltag_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: BADGES -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ğŸ–ï¸ BADGES <span style="float:right; font-size:10px;">â–¼</span>
                    </div>
                    <div style="padding:15px; background:#0a000a;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Create New Badge</h4>
                            <input type="text" id="st_new_badge_id" class="ie-input" placeholder="Badge ID (no spaces, e.g. cool_guy)">
                            <input type="text" id="st_new_badge_name" class="ie-input" placeholder="Display Name (e.g. Cool Guy)">
                            <input type="text" id="st_new_badge_desc" class="ie-input" placeholder="Description (shown on hover)">
                            <div style="margin:8px 0;">
                                <label style="color:#888; font-size:10px; display:block; margin-bottom:5px;">Badge Image</label>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <input type="file" id="st_badge_upload" accept="image/*" style="flex:1; color:#888; font-size:10px;">
                                    <span style="color:#666; font-size:9px;">OR</span>
                                    <input type="text" id="st_badge_url" class="ie-input" placeholder="Image URL" style="flex:2; margin:0;">
                                </div>
                            </div>
                            <div id="st_badge_preview" style="display:none; text-align:center; padding:10px; background:#050000; border:1px solid #400; border-radius:4px; margin:8px 0;">
                                <img id="st_badge_preview_img" style="width:50px; height:50px; border-radius:4px; border:2px solid #500;">
                                <div style="color:#888; font-size:9px; margin-top:5px;">Preview</div>
                            </div>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stCreateBadge()">Create Badge</button>
                            <div id="st_create_badge_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Assign Badge to User</h4>
                            <input type="text" id="st_badge_username" class="ie-input" placeholder="Username">
                            <select id="st_badge_select" class="ie-input">
                                <option value="">-- Select Badge --</option>
                            </select>
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin:5px 0;" onclick="loadBadgeSelectOptions()">ğŸ”„ Refresh Badges</button>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="stAssignBadge()">Assign Badge</button>
                                <button class="ie-btn" style="flex:1; background:#700; border-color:#ff00ff;" onclick="stRemoveBadge()">Remove Badge</button>
                            </div>
                            <div id="st_badge_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Delete Badge</h4>
                            <select id="st_delete_badge_select" class="ie-input">
                                <option value="">-- Select Badge to Delete --</option>
                            </select>
                            <button class="ie-btn" style="background:#700; border-color:#ff00ff; margin-top:5px;" onclick="stDeleteBadge()">Delete Badge</button>
                            <div id="st_delete_badge_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Badge Library</h4>
                            <button class="ie-btn" style="width:auto; padding:5px 10px; margin-bottom:10px;" onclick="loadBadgeLibrary()">ğŸ”„ Refresh Library</button>
                            <div id="st_badge_library" style="display:flex; flex-wrap:wrap; gap:10px; background:#050000; padding:10px; border:1px solid #400; border-radius:4px; min-height:60px;">
                                <div style="color:#666; font-size:10px; width:100%; text-align:center;">Click refresh to load badges...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION: CLUBS -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ğŸ° CLUB MANAGEMENT <span style="float:right; font-size:10px;">â–¼</span>
                    </div>
                    <div style="padding:15px; background:#0a000a; display:none;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Create New Club</h4>
                            <input type="text" id="st_club_name" class="ie-input" placeholder="Club name">
                            <input type="text" id="st_club_owner" class="ie-input" placeholder="Owner username">
                            <input type="text" id="st_club_color" class="ie-input" placeholder="Color (hex)" value="#d40000">
                            <textarea id="st_club_desc" class="ie-input" placeholder="Description..." style="height:50px; resize:none;"></textarea>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stCreateClub()">Create Club</button>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Transfer Ownership</h4>
                            <input type="text" id="st_transfer_club" class="ie-input" placeholder="Club name">
                            <input type="text" id="st_transfer_to" class="ie-input" placeholder="New owner username">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stTransferClub()">Transfer</button>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Rename Club</h4>
                            <input type="text" id="st_rename_club_old" class="ie-input" placeholder="Current club name">
                            <input type="text" id="st_rename_club_new" class="ie-input" placeholder="New club name">
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stRenameClub()">Rename</button>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Delete Club</h4>
                            <input type="text" id="st_delete_club" class="ie-input" placeholder="Club name to delete">
                            <button class="ie-btn" style="background:#700; border-color:#ff00ff;" onclick="stDeleteClub()">Delete Club</button>
                        </div>
                        <div id="st_club_result" style="margin-top:5px; font-size:10px;"></div>
                    </div>
                </div>
                
                <!-- SECTION: ANNOUNCEMENTS & REPUTATION -->
                <div style="margin-bottom:20px; border:2px solid #600060; border-radius:8px; overflow:hidden;">
                    <div style="background:linear-gradient(90deg, #300030, #200020); padding:10px 15px; color:#ff00ff; font-weight:bold; font-size:12px; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        ğŸ“¢ ANNOUNCEMENTS & REP <span style="float:right; font-size:10px;">â–¼</span>
                    </div>
                    <div style="padding:15px; background:#0a000a; display:none;">
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Site-Wide Announcement</h4>
                            <input type="text" id="st_announce_title" class="ie-input" placeholder="Title (optional)">
                            <textarea id="st_announce_text" class="ie-input" placeholder="Message..." style="height:60px; resize:none;"></textarea>
                            <input type="text" id="st_announce_image" class="ie-input" placeholder="Image URL (optional)">
                            <input type="text" id="st_announce_music" class="ie-input" placeholder="YouTube/SoundCloud URL (optional)">
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <select id="st_announce_type" class="ie-input" style="flex:1;">
                                    <option value="info">â„¹ï¸ Info</option>
                                    <option value="update">ğŸ†• Update</option>
                                    <option value="warning">âš ï¸ Warning</option>
                                    <option value="event">ğŸ‰ Event</option>
                                </select>
                                <input type="number" id="st_announce_duration" class="ie-input" style="width:60px;" value="10" min="5" max="120">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="ie-btn" style="flex:1; background:#500050; border-color:#ff00ff;" onclick="sendSiteAnnouncement()">Send</button>
                                <button class="ie-btn" style="width:auto; background:#333; border-color:#ff00ff;" onclick="previewAnnouncement()">Preview</button>
                            </div>
                            <div id="st_announce_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff; margin-bottom:10px;">
                            <h4 style="color:#ff00ff;">Reputation Management</h4>
                            <input type="text" id="st_rep_username" class="ie-input" placeholder="Username">
                            <div style="display:flex; gap:5px;">
                                <input type="number" id="st_rep_amount" class="ie-input" placeholder="Amount" style="flex:1;">
                                <button class="ie-btn" style="width:auto; background:#030; border-color:#0f0;" onclick="stModifyRep(1)">+ Add</button>
                                <button class="ie-btn" style="width:auto; background:#300; border-color:#f00;" onclick="stModifyRep(-1)">- Sub</button>
                            </div>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff; margin-top:5px;" onclick="stSetRep()">Set Exact Rep</button>
                            <div id="st_rep_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                        <div class="admin-section" style="border-color:#ff00ff;">
                            <h4 style="color:#ff00ff;">Admin Comment</h4>
                            <input type="text" id="st_comment_username" class="ie-input" placeholder="Target username">
                            <textarea id="st_comment_text" class="ie-input" placeholder="Comment..." style="height:50px; resize:none;"></textarea>
                            <button class="ie-btn" style="background:#500050; border-color:#ff00ff;" onclick="stLeaveComment()">Post Comment</button>
                            <div id="st_comment_result" style="margin-top:5px; font-size:10px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="window" id="memories_folder" style="left:50px; top:50px; width:550px; height:580px;">
    <div class="title-bar"><div class="title-bar-text">C:\Memories</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('memories_folder')"></button></div></div>
    <div class="window-body" style="display:flex; flex-direction:column; height:calc(100% - 32px); overflow:hidden;">
        <div id="memories_grid" style="flex:1; overflow-y:auto; padding:15px; min-height:0;"></div>
        <div style="background:#111; border-top:2px solid #500; padding:15px; display:flex; justify-content:center; align-items:center; gap:20px; flex-shrink:0;">
            <button class="ie-btn" style="width:100px; padding:10px 15px; margin:0; font-size:12px;" onclick="prevPage()">â—€ Prev</button>
            <span id="page_indicator" style="color:#d40000; font-size:12px; font-weight:bold; min-width:100px; text-align:center;">Page 1</span>
            <button class="ie-btn" style="width:100px; padding:10px 15px; margin:0; font-size:12px;" onclick="nextPage()">Next â–¶</button>
        </div>
    </div>
</div>
<div class="window" id="ie_window" style="left:120px; top:80px; width:450px; height:680px;">
    <div class="title-bar"><div class="title-bar-text">fangtasia.wtf Portal</div><div class="title-bar-controls"><button aria-label="Close" onclick="toggleWin('ie_window')"></button></div></div>
    <div class="window-body" style="overflow-y:auto;">
        <div class="ie-content" id="ie_login">
            <h2>Member Login</h2>
            <input type="text" id="ie_user" class="ie-input" placeholder="Username">
            <input type="password" id="ie_pass" class="ie-input" placeholder="Password">
            <button class="ie-btn" onclick="validateIE()">Authorize</button>
            <div class="guest-section">
                <p style="color: #666; font-size: 10px; text-align: center; margin-bottom: 10px;">â€” OR â€”</p>
                <button class="guest-btn" onclick="toggleWin('about_window')">â“ About This Place</button>
                <button class="guest-btn" onclick="enterGuestChat()">ğŸ‘ï¸ Lurk the Lounge (Read-Only)</button>
            </div>
        </div>
        <div class="ie-content" id="ie_upload" style="display:none;">
            <button class="lounge-entry-btn" onclick="openChat()">ğŸ©¸ Enter The Lounge</button>
            <p id="logged_in_as" style="font-size: 11px; color: #fff;"></p>
            <h3 style="color:#d40000; margin: 15px 0 5px 0; font-size: 13px;">ğŸ“¹ Upload Memory</h3>
            <input type="text" id="ie_filename" class="ie-input" placeholder="Memory Name">
            <input type="file" id="ie_file_picker" class="ie-input" style="border:none;" accept="video/*">
            <button class="ie-btn" id="upload_status" onclick="processIEUpload()">Push to Cloud</button>
            <div id="vip_image_section" style="display:none; margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                <h3 style="color:#ffd700; margin: 0 0 5px 0; font-size: 13px;">ğŸŒŸ VIP Image Hosting</h3>
                <input type="file" id="vip_image_picker" class="ie-input" style="border:none;" accept="image/*">
                <button class="ie-btn" style="background:#5a4a00;" onclick="uploadVIPImage()">Upload Image</button>
                <div id="vip_image_result" style="margin-top:8px;"></div>
            </div>
            <div id="vip_upgrade_section" style="margin-top:15px; border-top:1px solid #400; padding-top:15px;">
                <h3 style="color:#ffd700; margin: 0 0 10px 0; font-size: 13px;">ğŸŒŸ Upgrade to VIP</h3>
                <p style="color:#888; font-size:10px; margin-bottom:10px;">Have a VIP code? Redeem it to upgrade your account!</p>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="vip_code_input" class="ie-input" placeholder="Enter VIP code..." style="flex:1; margin:0;">
                    <button class="ie-btn" style="width:auto; padding:10px 15px; margin:0; background:#5a4a00;" onclick="redeemVIPCode()">Redeem</button>
                </div>
                <div id="vip_code_result" style="margin-top:8px; font-size:10px; text-align:center;"></div>
            </div>
            <button class="ie-btn" style="background: #333; margin-top: 15px;" onclick="logout()">Logout</button>
        </div>
    </div>
</div>
<div class="taskbar">
    <div style="margin-left: 10px; display: flex; gap: 8px;">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="music-ctrl" onclick="playMusic()" title="Play" style="width:18px; height:18px; cursor:pointer;">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727240.png" class="music-ctrl" onclick="pauseMusic()" title="Pause" style="width:18px; height:18px; cursor:pointer;">
    </div>
    <div style="margin-left: auto; margin-right: 15px; color: #888; font-size: 11px;" id="taskbar_clock"></div>
</div>
<div id="player" style="position:absolute; top:-999px;"></div>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyB7GeyT9SY7zFBeT-lfCM6iHZ_ipFXvemU",
    authDomain: "fangtasia-14197.firebaseapp.com",
    databaseURL: "https://fangtasia-14197-default-rtdb.firebaseio.com",
    projectId: "fangtasia-14197",
    storageBucket: "fangtasia-14197.firebasestorage.app",
    messagingSenderId: "735588641679",
    appId: "1:735588641679:web:5e0b9c5c5c84166b2f79fa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const CLOUD_NAME = "fangtasia-14197";
const UPLOAD_PRESET = "fangtasia";

// USER DATABASE - ENCODED (use atob() to decode)
// To decrypt: Open browser console and type: atob("encodedString")
const _d = atob; // decoder
const _e = { // encoded credentials [username, password]
    a: [_d("bG9zZXJzeW5kaWNhdGU="), _d("ZG91YmxlZHV0Y2hpZTAx")],
    b: [_d("bm9zZWV5ZWRlYXI="), _d("d3Rmb21mZ2Zhbmd0YXNpYWZvcmRhYnJvczIx")],
    c: [_d("b2xlZw=="), _d("bWV0aHliZXRoeTg5IQ==")],
    d: [_d("bm9ydGg="), _d("bG1hb2xlZ2FjeTEyISQk")],
    e: [_d("anlyYW0="), _d("aWxvdmVDb29raWVzMTIzNC4=")],
    f: [_d("WXVza3k="), _d("U2tpbGxldDEyIQ==")],
    g: [_d("bm9hYm9ydGlvbnM="), _d("RGlvbjA3MTM=")],
    h: [_d("ZXBoZW1lcmFs"), _d("U2V4eVNvbGl0YWlyZTEyMw==")],
    i: [_d("Z3VhcmRlZHBhbg=="), _d("ZnJlZWhvb2tlcnMxMjM=")],
    k: [_d("ZWxl"), _d("Q09NR09ETE9SREJPU1NFWFRPUVRFUTI4MjcxISEhMQ==")],
    l: [_d("Y3lybw=="), _d("cGFzc2ZvcmN5cm8xOTI=")],
    m: [_d("Ym9sb2s="), _d("amlsbGFpc2FmYWc=")],
    n: [_d("cmtlbGx5ZmFuMTc="), _d("ZW5ueWVubnllbm55")],
    o: [_d("bGVhbg=="), _d("U3VubnlGZWV0VXdVNTYk")],
    p: [_d("aGVudGFp"), _d("cm9ibG94bWFueDVANjdAMTEyMUA2NzY3")],
    q: [_d("cmVk"), _d("ZGlja2dyYXlzb25idWRkeTIz")],
    r: [_d("c2x1dA=="), _d("b3NoYmFnb3NoMTc4Ng==")],
    s: [_d("cG9uY2hvc2hvb3Rlcg=="), _d("djhlZVA4b0xPeHBJaE8=")],
    // New users
    t: [_d("MA=="), _d("Z2ppMjMxOWpoaGo5ZXM=")],
    u: [_d("cGFyYXNpdGU="), _d("czZwZXJzYWl5YW50YWNvMw==")],
    v: [_d("aGVhcnRhY2hl"), _d("QWJieUFiYnkxMg==")],
    w: [_d("Z29k"), _d("VHVuM3h4WipmbCk=")],
    x: [_d("RlJFRVpFUkJVUk4="), _d("ZnJlZXphbWFuZTU2NA==")],
    y: [_d("bWFwbGUuc3lydXBw"), _d("d2lnZ2FwYXNzd29yZDEyMw==")],
    z: [_d("ZGlvbg=="), _d("JDEwMDM1NTg3")],
    aa: [_d("TGVtb25hZGU="), _d("QnV0dEJvb3R5TmFrZWQxMjM=")],
    ab: [_d("c3VwZXJuaWdnYXBlbmlzNjc="), _d("bmlnZ2FuaWdnYW5pZ2dh")],
    ac: [_d("aWNl"), _d("cHJveGlzY29vbDAwMDA2NjY2")],
    ad: [_d("Yml0ZQ=="), _d("aG9ybnlidWxsczExcw==")],
    ae: [_d("Z293"), _d("TW9ybw==")],
    af: [_d("bWFwbGU="), _d("bWFwbGVzeXJ1cHdpZ2dhMA==")]
};
const coreAdmins = {
    [_e.a[0]]: { pass: _e.a[1], rank: "ST", fullRank: "Site Technician", style: "st-style", isAdmin: true, isST: true },
    [_e.b[0]]: { pass: _e.b[1], rank: "A", fullRank: "Admin", style: "noseeyedear-style", isAdmin: true, customTag: "N" },
    [_e.c[0]]: { pass: _e.c[1], rank: "MOD", fullRank: "Moderator", style: "oleg-style", isAdmin: false, isMod: true, customTag: "O" },
    [_e.d[0]]: { pass: _e.d[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.e[0]]: { pass: _e.e[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.f[0]]: { pass: _e.f[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.g[0]]: { pass: _e.g[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.h[0]]: { pass: _e.h[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.i[0]]: { pass: _e.i[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.k[0]]: { pass: _e.k[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.l[0]]: { pass: _e.l[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.m[0]]: { pass: _e.m[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.n[0]]: { pass: _e.n[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.o[0]]: { pass: _e.o[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.p[0]]: { pass: _e.p[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.q[0]]: { pass: _e.q[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.r[0]]: { pass: _e.r[1], rank: "VIP", fullRank: "VIP", style: "vip-style", isAdmin: false },
    [_e.s[0]]: { pass: _e.s[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    // New users
    [_e.t[0]]: { pass: _e.t[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.u[0]]: { pass: _e.u[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.v[0]]: { pass: _e.v[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.w[0]]: { pass: _e.w[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.x[0]]: { pass: _e.x[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.y[0]]: { pass: _e.y[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.z[0]]: { pass: _e.z[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.aa[0]]: { pass: _e.aa[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ab[0]]: { pass: _e.ab[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ac[0]]: { pass: _e.ac[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ad[0]]: { pass: _e.ad[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.ae[0]]: { pass: _e.ae[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false },
    [_e.af[0]]: { pass: _e.af[1], rank: "M", fullRank: "Member", style: "member-style", isAdmin: false }
};
let userDatabase = { ...coreAdmins };

// Start online listener IMMEDIATELY so it's ready when members load
let onlineListenerStarted = false;
let onlineUsers = [];

function startOnlineListener() {
    if (onlineListenerStarted) return;
    onlineListenerStarted = true;
    
    db.ref('online').on('value', (snapshot) => {
        onlineUsers = [];
        snapshot.forEach(child => {
            const u = child.val();
            if (u && u.username) onlineUsers.push(u);
        });
        updateMemberList();
    });
}

// Start listening immediately
startOnlineListener();

// List of deleted/renamed accounts to filter out
const deletedAccounts = ['pink', 'nigger'];

// Clean up deleted accounts from Firebase
deletedAccounts.forEach(acc => {
    db.ref('members/' + acc).remove();
    db.ref('online/' + acc).remove();
    db.ref('profiles/' + acc).remove();
    db.ref('reputation/' + acc).remove();
});

db.ref('members').on('value', (s) => { 
    const firebaseMembers = s.val() || {};
    // Merge: start with Firebase data, then overlay coreAdmins to preserve customTags etc.
    userDatabase = { ...firebaseMembers };
    // Ensure coreAdmins properties always take precedence
    Object.keys(coreAdmins).forEach(user => {
        userDatabase[user] = { ...userDatabase[user], ...coreAdmins[user] };
    });
    // Remove deleted/renamed accounts from local database
    deletedAccounts.forEach(acc => { delete userDatabase[acc]; });
    updateMemberList();
});

let CURRENT_USER = "", IS_GUEST = false, currentPage = 1, itemsPerPage = 9;
let userProfile = { status: "", bio: "", mood: "", avatar: "", music: "" };
let currentProfileUser = "", idleTime = 0, screensaverActive = false;

// REAL-TIME PROFILE CACHE
let profileCache = {};
db.ref('profiles').on('value', (s) => { profileCache = s.val() || {}; });
function getProfile(username) { return profileCache[username] || {}; }

// REAL-TIME CLUBS CACHE
let clubsCache = {};
db.ref('clubs').on('value', (s) => { 
    clubsCache = s.val() || {}; 
    // Auto-refresh clubs list if window is open
    const clubsList = document.getElementById('clubs_list');
    if (clubsList && document.getElementById('clubs_window').style.display === 'block') {
        loadAllClubs();
    }
});

// Generate unique user ID from username
function generateUserId(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        const char = username.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'FNG-' + Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
}

// Get rank tag HTML - Custom tags for specific users
// Club tags - clubs that give special chat tags to members
const clubTags = {
    'evil jits': { tag: 'jitz', color: '#8B0000' },
    'intelcord': { tag: 'KEVIN', color: '#f2eded' },
    '##sb': { tag: '##SB', color: '#6a03b4' },
    'sb': { tag: '##SB', color: '#6a03b4' },
    '#sb': { tag: '##SB', color: '#6a03b4' },
    '##SB': { tag: '##SB', color: '#6a03b4' }
};

function getRankTag(rank, style, username, useCustomTag = true) {
    // Custom tags ALWAYS override in chat - check first (if useCustomTag is true)
    if (useCustomTag && username && userDatabase[username]?.customTag) {
        const user = userDatabase[username];
        // If custom color is set, use inline styles
        if (user.customTagColor) {
            return `<span class="rank-tag" style="color:${user.customTagColor}; border-color:${user.customTagColor}; background:${user.customTagColor}22;">${user.customTag}</span>`;
        }
        return `<span class="rank-tag ${user.style || style || 'member-style'}">${user.customTag}</span>`;
    }
    
    // Check for club tags - only if user doesn't have a custom tag
    if (useCustomTag && username && !userDatabase[username]?.customTag) {
        const clubTag = getUserClubTag(username);
        if (clubTag) {
            return `<span class="rank-tag" style="color:${clubTag.color}; border-color:${clubTag.color}; background:${clubTag.color}22;">${clubTag.tag}</span>`;
        }
    }
    
    // K badge for contributors (only if no custom tag or useCustomTag is false)
    if (rank === 'CONTRIB') {
        return '<span class="rank-tag contrib-style" style="font-family:\'Bahram\',sans-serif;">K</span>';
    }
    // Default rank tag
    return `<span class="rank-tag ${style || 'member-style'}">${rank || 'M'}</span>`;
}

// Check if user is in a club that has a special tag
function getUserClubTag(username) {
    // Check clubsCache for user membership
    for (const clubId in clubsCache) {
        const club = clubsCache[clubId];
        const clubName = (club.name || '').toLowerCase();
        
        // Check if this club has a special tag
        if (clubTags[clubName]) {
            // Check if user is owner or member
            if (club.owner === username || (club.members && club.members.includes(username))) {
                return clubTags[clubName];
            }
        }
    }
    return null;
}

// BAT CURSOR
document.addEventListener('mousemove', (e) => {
    const bat = document.getElementById('batCursor');
    if(bat) { bat.style.left = e.clientX + 'px'; bat.style.top = e.clientY + 'px'; }
    resetIdle();
});
document.addEventListener('keypress', resetIdle);
document.addEventListener('click', resetIdle);

function resetIdle() {
    idleTime = 0;
    if (screensaverActive) { document.getElementById('screensaver').style.display = 'none'; screensaverActive = false; }
}
function activateScreensaver() {
    screensaverActive = true;
    const ss = document.getElementById('screensaver');
    ss.innerHTML = '';
    ss.style.display = 'block';
    for (let i = 0; i < 12; i++) {
        const bat = document.createElement('div');
        bat.className = 'screensaver-bat';
        bat.textContent = 'ğŸ¦‡';
        bat.style.left = Math.random() * 90 + 'vw';
        bat.style.top = Math.random() * 90 + 'vh';
        bat.style.animation = `flyAround ${6 + Math.random() * 6}s linear infinite`;
        ss.appendChild(bat);
    }
}
setInterval(() => { idleTime++; if (idleTime > 90 && !screensaverActive && document.getElementById('boot-screen').style.display === 'none') activateScreensaver(); }, 1000);

function updateVisitorCount() {
    let count = parseInt(localStorage.getItem('f_visitors') || '0');
    if (!sessionStorage.getItem('counted')) { count++; localStorage.setItem('f_visitors', count); sessionStorage.setItem('counted', 'true'); }
    document.getElementById('visitor_count').textContent = count.toString().padStart(6, '0');
}
function updateClock() { const now = new Date(); document.getElementById('taskbar_clock').textContent = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0'); }
setInterval(updateClock, 1000);
function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

// SILVER STAKES GAME
let stakesBoard = [], stakesRevealed = [], stakesFlagged = [], gameOver = false;
function initStakesGame() {
    stakesBoard = Array(81).fill(0); stakesRevealed = Array(81).fill(false); stakesFlagged = Array(81).fill(false); gameOver = false;
    let placed = 0;
    while (placed < 10) { const pos = Math.floor(Math.random() * 81); if (stakesBoard[pos] !== -1) { stakesBoard[pos] = -1; placed++; } }
    for (let i = 0; i < 81; i++) {
        if (stakesBoard[i] === -1) continue;
        let count = 0; const row = Math.floor(i / 9), col = i % 9;
        for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9 && stakesBoard[nr * 9 + nc] === -1) count++; }
        stakesBoard[i] = count;
    }
    renderStakes();
    document.getElementById('game_status').textContent = 'ğŸ¦‡ Stakes: 10';
}
function renderStakes() {
    const grid = document.getElementById('stakes_grid'); grid.innerHTML = '';
    for (let i = 0; i < 81; i++) {
        const cell = document.createElement('div'); cell.className = 'stakes-cell';
        if (stakesRevealed[i]) { cell.classList.add('revealed'); if (stakesBoard[i] === -1) { cell.classList.add('stake'); cell.textContent = 'ğŸ—¡ï¸'; } else if (stakesBoard[i] > 0) { cell.textContent = stakesBoard[i]; cell.style.color = ['','#00f','#0a0','#f00','#008','#800','#088','#000','#888'][stakesBoard[i]]; } }
        else if (stakesFlagged[i]) { cell.textContent = 'ğŸš©'; }
        cell.onclick = () => revealCell(i);
        cell.oncontextmenu = (e) => { e.preventDefault(); if (!gameOver && !stakesRevealed[i]) { stakesFlagged[i] = !stakesFlagged[i]; renderStakes(); } };
        grid.appendChild(cell);
    }
}
function revealCell(i) {
    if (gameOver || stakesRevealed[i] || stakesFlagged[i]) return;
    stakesRevealed[i] = true;
    if (stakesBoard[i] === -1) { gameOver = true; stakesRevealed = stakesRevealed.map(() => true); document.getElementById('game_status').textContent = 'ğŸ’€ Staked! Game Over.'; }
    else if (stakesBoard[i] === 0) { const row = Math.floor(i / 9), col = i % 9; for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const nr = row + dr, nc = col + dc; if (nr >= 0 && nr < 9 && nc >= 0 && nc < 9) revealCell(nr * 9 + nc); } }
    const unrevealed = stakesRevealed.filter((r, idx) => !r && stakesBoard[idx] !== -1).length;
    if (unrevealed === 0 && !gameOver) { gameOver = true; document.getElementById('game_status').textContent = 'ğŸ¦‡ You survived!'; }
    renderStakes();
}

// APPLICATION SYSTEM
function submitApplication() {
    const username = document.getElementById('app_username').value.trim();
    const reason = document.getElementById('app_reason').value.trim();
    if (!username || !reason) { alert('Fill required fields.'); return; }
    db.ref('applications/' + Date.now()).set({ username, referral: document.getElementById('app_referral').value, reason, date: new Date().toLocaleDateString(), status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP });
    document.getElementById('app_form').style.display = 'none';
    document.getElementById('app_result').innerHTML = '<div class="app-status app-pending"><strong>ğŸ©¸ Blood Pact Received</strong></div>';
    document.getElementById('app_result').style.display = 'block';
}
function checkAppStatus() {
    const username = document.getElementById('app_username').value.trim();
    if (!username) { alert('Enter username.'); return; }
    db.ref('applications').orderByChild('username').equalTo(username).once('value', (s) => {
        let app = null; s.forEach((c) => { app = c.val(); });
        const rd = document.getElementById('app_result');
        document.getElementById('app_form').style.display = 'none'; rd.style.display = 'block';
        if (!app) rd.innerHTML = '<div class="app-status" style="border-color:#888; color:#888;">No application found.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'pending') rd.innerHTML = '<div class="app-status app-pending">ğŸ• Pending review.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else if (app.status === 'approved') rd.innerHTML = '<div class="app-status" style="border-color:#0f0; color:#0f0;">âœ“ Approved!</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
        else rd.innerHTML = '<div class="app-status" style="border-color:#f00; color:#f00;">âœ— Denied.</div><button class="ie-btn" style="margin-top:10px; background:#333;" onclick="resetAppForm()">Back</button>';
    });
}
function resetAppForm() { document.getElementById('app_form').style.display = 'block'; document.getElementById('app_result').style.display = 'none'; }
function enterGuestChat() { IS_GUEST = true; CURRENT_USER = "Guest_" + Math.floor(Math.random() * 9999); toggleWin('chat_win'); loadMessages(); startOnlineListener(); document.getElementById('chat_input').placeholder = "Lurking (read-only)..."; document.getElementById('chat_input').disabled = true; }

// LOGIN SYSTEM
function validateIE() {
    const u = document.getElementById('ie_user').value.trim();
    const p = document.getElementById('ie_pass').value;
    if (!u || !p) { alert("Enter username and password."); return; }
    db.ref('bans/' + u).once('value', (s) => {
        const ban = s.val();
        if (ban && (ban.expiry === 0 || ban.expiry > Date.now())) { alert('Account banned/suspended.'); return; }
        if(userDatabase[u] && userDatabase[u].pass === p) {
            CURRENT_USER = u; IS_GUEST = false;
            console.log('User logged in:', CURRENT_USER);
            document.getElementById('ie_login').style.display = 'none';
            document.getElementById('ie_upload').style.display = 'block';
            document.getElementById('logged_in_as').innerText = `IDENTIFIED: ${u} [${userDatabase[u].fullRank}]`;
            
            // Load profile data from Firebase
            loadProfile();
            
            if (userDatabase[u].isAdmin || userDatabase[u].isMod) { document.getElementById('admin_icon').style.display = 'block'; }
            if (userDatabase[u].isST) { document.getElementById('st_tab').style.display = 'block'; }
            // Show/hide admin tabs based on role
            setupAdminTabs(userDatabase[u]);
            // Show clubs, messages, and watch party for all logged in users
            document.getElementById('clubs_icon').style.display = 'block';
            document.getElementById('messages_icon').style.display = 'block';
            document.getElementById('watchparty_icon').style.display = 'block';
            const rank = userDatabase[u].rank;
            if (rank === 'VIP' || rank === 'CONTRIB' || userDatabase[u].isAdmin || userDatabase[u].isST) { 
                document.getElementById('vip_image_section').style.display = 'block';
                document.getElementById('vip_bg_section').style.display = 'block';
                // Hide upgrade section since they're already VIP+
                document.getElementById('vip_upgrade_section').style.display = 'none';
            } else {
                // Show upgrade section for regular members
                document.getElementById('vip_upgrade_section').style.display = 'block';
            }
        } else { alert("DENIED."); }
    });
}
function logout() {
    if (CURRENT_USER) db.ref('online/' + CURRENT_USER).remove();
    CURRENT_USER = ""; IS_GUEST = false;
    // Reset user profile
    userProfile = { status: "", bio: "", mood: "", avatar: "", music: "" };
    document.getElementById('ie_login').style.display = 'block';
    document.getElementById('ie_upload').style.display = 'none';
    document.getElementById('ie_user').value = '';
    document.getElementById('ie_pass').value = '';
    document.getElementById('admin_icon').style.display = 'none';
    document.getElementById('clubs_icon').style.display = 'none';
    document.getElementById('messages_icon').style.display = 'none';
    document.getElementById('watchparty_icon').style.display = 'none';
    document.getElementById('st_tab').style.display = 'none';
    document.getElementById('vip_image_section').style.display = 'none';
    toggleWin('chat_win');
}

// VIP Code Redemption System - for upgrading existing member accounts
function redeemVIPCode() {
    const codeInput = document.getElementById('vip_code_input');
    const resultDiv = document.getElementById('vip_code_result');
    const code = codeInput.value.trim().toUpperCase();
    
    if (!CURRENT_USER || IS_GUEST) {
        resultDiv.innerHTML = '<span style="color:#f00;">You must be logged in to redeem a code.</span>';
        return;
    }
    
    if (!code) {
        resultDiv.innerHTML = '<span style="color:#f00;">Please enter a code.</span>';
        return;
    }
    
    // Check if user is already VIP
    const currentUser = userDatabase[CURRENT_USER];
    if (currentUser && (currentUser.rank === 'VIP' || currentUser.isAdmin || currentUser.isST)) {
        resultDiv.innerHTML = '<span style="color:#ffd700;">You already have VIP or higher rank!</span>';
        return;
    }
    
    // Check if code exists in Firebase
    db.ref('vip_codes').orderByChild('code').equalTo(code).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultDiv.innerHTML = '<span style="color:#f00;">Invalid code.</span>';
            return;
        }
        
        let codeKey = null;
        let codeData = null;
        snapshot.forEach((child) => {
            codeKey = child.key;
            codeData = child.val();
        });
        
        if (!codeData) {
            resultDiv.innerHTML = '<span style="color:#f00;">Invalid code.</span>';
            return;
        }
        
        // Check if code has uses left
        const usedCount = codeData.usedBy ? Object.keys(codeData.usedBy).length : 0;
        const maxUses = codeData.maxUses || 1;
        
        if (usedCount >= maxUses) {
            resultDiv.innerHTML = '<span style="color:#f00;">This code has been fully redeemed.</span>';
            return;
        }
        
        // Check if user already used this code
        if (codeData.usedBy) {
            const usedByList = Object.values(codeData.usedBy);
            if (usedByList.includes(CURRENT_USER)) {
                resultDiv.innerHTML = '<span style="color:#f00;">You have already used this code.</span>';
                return;
            }
        }
        
        // Upgrade user to VIP
        upgradeToVIP(code, codeKey, resultDiv);
    });
}

function upgradeToVIP(code, codeKey, resultDiv) {
    // Update user in Firebase - VIP without ##SB tag (that's club-exclusive)
    const vipData = {
        rank: 'VIP',
        fullRank: 'VIP',
        style: 'vip-style',
        upgradedAt: Date.now(),
        upgradedBy: 'VIP_CODE:' + code
    };
    
    db.ref('members/' + CURRENT_USER).update(vipData).then(() => {
        // Mark code as used by this user
        db.ref('vip_codes/' + codeKey + '/usedBy').push(CURRENT_USER);
        
        // Update local database
        if (userDatabase[CURRENT_USER]) {
            userDatabase[CURRENT_USER].rank = 'VIP';
            userDatabase[CURRENT_USER].fullRank = 'VIP';
            userDatabase[CURRENT_USER].style = 'vip-style';
            // Remove any custom tag - VIP tag will show as gold "VIP"
            delete userDatabase[CURRENT_USER].customTag;
            delete userDatabase[CURRENT_USER].customTagColor;
        }
        
        // Show VIP image section
        document.getElementById('vip_image_section').style.display = 'block';
        
        // Hide upgrade section since they're now VIP
        document.getElementById('vip_upgrade_section').style.display = 'none';
        
        resultDiv.innerHTML = `
            <div style="color:#0f0; padding:10px; background:#0a1a0a; border:1px solid #0a0; border-radius:4px;">
                âœ… Account Upgraded to VIP!<br>
                <span style="color:#ffd700;">You now have VIP status!</span><br>
                <span style="color:#888; font-size:9px;">Refresh the page to see all VIP features.</span>
            </div>
        `;
        
        document.getElementById('vip_code_input').value = '';
    }).catch(err => {
        resultDiv.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function openChat() { 
    if(CURRENT_USER && !IS_GUEST) { 
        toggleWin('chat_win'); 
        loadMessages(); 
        setUserOnline();
        startOnlineListener();
        document.getElementById('chat_input').disabled = false; 
        document.getElementById('chat_input').placeholder = "/help for commands... @username to mention"; 
    } else {
        alert('Please log in first!');
    }
}
function setUserOnline() {
    if (!CURRENT_USER || IS_GUEST) return;
    const user = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style', fullRank: 'Member' };
    db.ref('online/' + CURRENT_USER).set({ 
        username: CURRENT_USER, 
        rank: user.rank || 'M', 
        style: user.style || 'member-style', 
        fullRank: user.fullRank || 'Member', 
        lastSeen: firebase.database.ServerValue.TIMESTAMP 
    });
    db.ref('online/' + CURRENT_USER).onDisconnect().remove();
}

function updateMemberList() {
    const container = document.getElementById('online_member_list');
    if (!container) return;
    
    let html = '';
    
    // ONLINE SECTION
    html += `<div style="color:#0f0; font-size:11px; text-align:center; padding:8px; background:#001100; border:1px solid #030; margin-bottom:10px;">â— ${onlineUsers.length} ONLINE</div>`;
    
    if (onlineUsers.length > 0) {
        onlineUsers.filter(u => !deletedAccounts.includes(u.username)).forEach(u => {
            const mlTag = getUserMemberlistTag(u.username);
            let rankTag;
            if (mlTag) {
                rankTag = `<span class="rank-tag" style="color:${mlTag.color}; border-color:${mlTag.color}; background:${mlTag.color}22;">${mlTag.tag}</span>`;
            } else {
                rankTag = getRankTag(u.rank, u.style, u.username, false);
            }
            html += `<div class="member-item" onclick="showProfileCard('${escapeHtml(u.username)}', event)">
                ${rankTag}
                <span style="color:#0f0; font-size:8px;">â—</span>
                <span class="${u.style || 'member-style'}">${escapeHtml(u.username)}</span>
            </div>`;
        });
    } else {
        html += '<div style="color:#555; font-size:10px; text-align:center; padding:10px;">No one online</div>';
    }
    
    // ALL MEMBERS SECTION
    html += '<div style="border-top:1px solid #400; margin-top:15px; padding-top:10px;">';
    html += '<div style="color:#d40000; font-size:10px; font-weight:bold; text-align:center; margin-bottom:10px;">ALL MEMBERS</div>';
    
    const allMembers = { 'ST': [], 'A': [], 'MOD': [], 'CONTRIB': [], 'VIP': [], 'M': [] };
    const rankNames = { 'ST': 'Site Technician', 'A': 'Admins', 'MOD': 'Moderators', 'CONTRIB': 'Contributors', 'VIP': 'VIP', 'M': 'Members' };
    
    Object.keys(userDatabase).filter(username => !deletedAccounts.includes(username)).forEach(username => {
        const user = userDatabase[username];
        const rank = user.rank || 'M';
        if (allMembers[rank]) {
            allMembers[rank].push({ username, ...user });
        } else {
            allMembers['M'].push({ username, ...user });
        }
    });
    
    Object.keys(allMembers).forEach(rank => {
        if (allMembers[rank].length > 0) {
            html += `<div class="member-category">${rankNames[rank]}</div>`;
            allMembers[rank].forEach(u => {
                const isOnline = onlineUsers.some(ou => ou.username === u.username);
                const mlTag = getUserMemberlistTag(u.username);
                let rankTag;
                if (mlTag) {
                    rankTag = `<span class="rank-tag" style="color:${mlTag.color}; border-color:${mlTag.color}; background:${mlTag.color}22;">${mlTag.tag}</span>`;
                } else {
                    rankTag = getRankTag(u.rank, u.style, u.username, false);
                }
                html += `<div class="member-item" onclick="showProfileCard('${escapeHtml(u.username)}', event)">
                    ${rankTag}
                    ${isOnline ? '<span style="color:#0f0; font-size:8px;">â—</span>' : '<span style="color:#555; font-size:8px;">â—‹</span>'}
                    <span class="${u.style || 'member-style'}">${escapeHtml(u.username)}</span>
                </div>`;
            });
        }
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// PROFILE SYSTEM - Robust save/load for all users
function loadProfile() {
    if (!CURRENT_USER) return;
    console.log('Loading profile for:', CURRENT_USER);
    
    db.ref('profiles/' + CURRENT_USER).once('value', (snapshot) => {
        const p = snapshot.val() || {};
        console.log('Loaded profile data:', p);
        
        // Update local profile object
        userProfile = { 
            status: p.status || "", 
            bio: p.bio || "", 
            mood: p.mood || "", 
            avatar: p.avatar || "", 
            music: p.music || "",
            background: p.background || ""
        };
        
        // Update form fields if they exist
        const statusEl = document.getElementById('user_status');
        const bioEl = document.getElementById('user_bio');
        const moodEl = document.getElementById('user_mood');
        const avatarUrlEl = document.getElementById('avatar_url');
        const musicEl = document.getElementById('profile_music');
        const bgEl = document.getElementById('profile_bg');
        const avatarDisplay = document.getElementById('my_avatar_display');
        
        if (statusEl) statusEl.value = userProfile.status;
        if (bioEl) bioEl.value = userProfile.bio;
        if (moodEl) moodEl.value = userProfile.mood;
        if (avatarUrlEl) avatarUrlEl.value = userProfile.avatar;
        if (musicEl) musicEl.value = userProfile.music;
        if (bgEl) bgEl.value = userProfile.background;
        if (musicEl) musicEl.value = userProfile.music;
        
        if (avatarDisplay) {
            if (userProfile.avatar) {
                avatarDisplay.innerHTML = '<img src="' + userProfile.avatar + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ğŸ¦‡\'">';
            } else {
                avatarDisplay.innerHTML = 'ğŸ¦‡';
            }
        }
        
        // Also update the profile cache
        profileCache[CURRENT_USER] = userProfile;
        
    }).catch(err => { console.error('Failed to load profile:', err); });
}

function saveProfile() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    
    // Get all values from form fields
    const statusEl = document.getElementById('user_status');
    const bioEl = document.getElementById('user_bio');
    const moodEl = document.getElementById('user_mood');
    const musicEl = document.getElementById('profile_music');
    const avatarUrlEl = document.getElementById('avatar_url');
    const bgEl = document.getElementById('profile_bg');
    
    const newStatus = statusEl ? statusEl.value.trim() : userProfile.status || '';
    const newBio = bioEl ? bioEl.value.trim() : userProfile.bio || '';
    const newMood = moodEl ? moodEl.value : userProfile.mood || '';
    const newMusic = musicEl ? musicEl.value.trim() : userProfile.music || '';
    const newAvatar = avatarUrlEl ? avatarUrlEl.value.trim() : userProfile.avatar || '';
    const newBg = bgEl ? bgEl.value.trim() : userProfile.background || '';
    
    // Update local profile object
    userProfile.status = newStatus;
    userProfile.bio = newBio;
    userProfile.mood = newMood;
    userProfile.music = newMusic;
    userProfile.avatar = newAvatar;
    userProfile.background = newBg;
    
    // Create complete profile data object (no ServerValue.TIMESTAMP - can cause issues)
    const profileData = { 
        status: newStatus, 
        bio: newBio, 
        mood: newMood, 
        music: newMusic, 
        avatar: newAvatar,
        background: newBg,
        lastUpdated: Date.now()
    };
    
    console.log('Saving profile for', CURRENT_USER, ':', profileData);
    
    // Use set() to create/overwrite entire profile
    db.ref('profiles/' + CURRENT_USER).set(profileData, (error) => {
        if (error) {
            console.error('Save failed:', error);
            alert('Failed to save profile: ' + error.message);
        } else {
            console.log('Profile saved successfully');
            profileCache[CURRENT_USER] = { ...userProfile };
            alert('Profile saved!');
        }
    });
}

function updateAvatar() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    
    const urlEl = document.getElementById('avatar_url');
    const fileInput = document.getElementById('avatar_upload');
    const avatarDisplay = document.getElementById('my_avatar_display');
    const url = urlEl ? urlEl.value.trim() : '';
    
    if (url) {
        // URL provided - save directly
        saveAvatarToFirebase(url, avatarDisplay, urlEl);
    } else if (fileInput && fileInput.files[0]) {
        // File upload to Cloudinary first
        alert('Uploading avatar...');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('upload_preset', UPLOAD_PRESET);
        
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.secure_url) {
                    saveAvatarToFirebase(data.secure_url, avatarDisplay, urlEl);
                } else {
                    alert('Upload failed: ' + (data.error?.message || 'Unknown error'));
                }
            })
            .catch((err) => { 
                console.error('Upload error:', err); 
                alert('Upload failed. Check your connection.'); 
            });
    } else {
        alert('Enter a URL or select a file to upload.');
    }
}

function saveAvatarToFirebase(avatarUrl, avatarDisplay, urlEl) {
    userProfile.avatar = avatarUrl;
    
    // Get current profile first, then merge with new avatar
    db.ref('profiles/' + CURRENT_USER).once('value', (snapshot) => {
        const currentProfile = snapshot.val() || {};
        const updatedProfile = {
            status: currentProfile.status || userProfile.status || '',
            bio: currentProfile.bio || userProfile.bio || '',
            mood: currentProfile.mood || userProfile.mood || '',
            music: currentProfile.music || userProfile.music || '',
            avatar: avatarUrl,
            lastUpdated: Date.now()
        };
        
        // Save complete profile
        db.ref('profiles/' + CURRENT_USER).set(updatedProfile, (error) => {
            if (error) {
                console.error('Avatar save failed:', error);
                alert('Failed to save avatar: ' + error.message);
            } else {
                console.log('Avatar saved:', avatarUrl);
                profileCache[CURRENT_USER] = { ...updatedProfile };
                userProfile = { ...updatedProfile };
                if (avatarDisplay) avatarDisplay.innerHTML = '<img src="' + avatarUrl + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ğŸ¦‡\'">';
                if (urlEl) urlEl.value = avatarUrl;
                alert('Avatar saved!');
            }
        });
    });
}

function updateProfileMusic() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    
    const musicEl = document.getElementById('profile_music');
    const url = musicEl ? musicEl.value.trim() : '';
    
    userProfile.music = url;
    
    // Get current profile first, then merge with new music
    db.ref('profiles/' + CURRENT_USER).once('value', (snapshot) => {
        const currentProfile = snapshot.val() || {};
        const updatedProfile = {
            status: currentProfile.status || userProfile.status || '',
            bio: currentProfile.bio || userProfile.bio || '',
            mood: currentProfile.mood || userProfile.mood || '',
            music: url,
            avatar: currentProfile.avatar || userProfile.avatar || '',
            lastUpdated: Date.now()
        };
        
        db.ref('profiles/' + CURRENT_USER).set(updatedProfile, (error) => {
            if (error) {
                console.error('Music save failed:', error);
                alert('Failed to save music: ' + error.message);
            } else {
                console.log('Profile music saved:', url);
                profileCache[CURRENT_USER] = { ...updatedProfile };
                userProfile = { ...updatedProfile };
                alert('Profile music saved!');
            }
        });
    });
}

// PROFILE WINDOW
function showProfileCard(username, event) {
    if (event) { event.preventDefault(); event.stopPropagation(); }
    if (!username) return;
    openProfileWindow(username);
}
function openProfileWindow(username) {
    if (!username) return;
    currentProfileUser = username;
    const win = document.getElementById('profile_window');
    if (!win) { console.error('Profile window not found'); return; }
    
    const userData = userDatabase[username] || { rank: 'M', fullRank: 'Member', style: 'member-style' };
    
    const pwTitle = document.getElementById('pw_title');
    const pwName = document.getElementById('pw_name');
    const pwRank = document.getElementById('pw_rank');
    const pwUserId = document.getElementById('pw_user_id');
    const pwStatus = document.getElementById('pw_status');
    const pwMood = document.getElementById('pw_mood');
    const pwBio = document.getElementById('pw_bio');
    const pwAvatar = document.getElementById('pw_avatar');
    const pwRep = document.getElementById('pw_rep');
    const pwCommentsCount = document.getElementById('pw_comments_count');
    const pwCommentsList = document.getElementById('pw_comments_list');
    const pwMusicSection = document.getElementById('pw_music_section');
    const pwMusicPlayer = document.getElementById('pw_music_player');
    const pwBtnRepPos = document.getElementById('pw_btn_rep_pos');
    const pwBtnRepNeg = document.getElementById('pw_btn_rep_neg');
    const pwCommentForm = document.getElementById('pw_comment_form');
    
    if (pwTitle) pwTitle.textContent = 'ğŸ‘¤ ' + username + "'s Profile";
    if (pwName) { 
        pwName.textContent = username; 
        pwName.className = userData.style || 'member-style'; 
        pwName.style.background = 'transparent'; 
        pwName.style.backgroundColor = 'transparent';
        pwName.style.border = 'none';
        pwName.style.padding = '0';
    }
    if (pwRank) pwRank.textContent = userData.fullRank || 'Member';
    if (pwUserId) pwUserId.textContent = 'User ID: ' + generateUserId(username);
    
    // Load FRESH profile data from Firebase
    db.ref('profiles/' + username).once('value', (snapshot) => {
        const profile = snapshot.val() || {};
        console.log('openProfileWindow - Loaded profile for', username, ':', profile);
        
        if (pwStatus) pwStatus.textContent = profile.status || '';
        if (pwMood) pwMood.textContent = profile.mood || '';
        if (pwBio) pwBio.textContent = profile.bio || 'No bio set.';
        if (pwAvatar) {
            if (profile.avatar) pwAvatar.innerHTML = '<img src="' + escapeHtml(profile.avatar) + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ğŸ¦‡\'">';
            else pwAvatar.innerHTML = 'ğŸ¦‡';
        }
        
        // Animated background for VIP users - lighter overlay for visibility
        const winBody = win.querySelector('.window-body');
        const bgOverlay = document.getElementById('pw_bg_overlay');
        if (winBody && profile.background) {
            let bgUrl = profile.background;
            // Handle Tenor links - extract direct GIF URL
            if (bgUrl.includes('tenor.com')) {
                // For tenor, add .gif if not present, or use media URL
                if (bgUrl.includes('/view/')) {
                    bgUrl = bgUrl.replace('/view/', '/').replace(/\?.*$/, '') + '.gif';
                }
            }
            winBody.style.backgroundImage = 'url(' + escapeHtml(bgUrl) + ')';
            winBody.style.backgroundSize = 'cover';
            winBody.style.backgroundPosition = 'center';
            winBody.style.backgroundRepeat = 'no-repeat';
            // Show lighter overlay so background is more visible
            if (bgOverlay) {
                bgOverlay.style.display = 'block';
                bgOverlay.style.background = 'rgba(0,0,0,0.5)'; // Lighter than before
            }
        } else if (winBody) {
            winBody.style.backgroundImage = 'none';
            if (bgOverlay) bgOverlay.style.display = 'none';
        }
        
        // Load badges
        const pwBadgesSection = document.getElementById('pw_badges_section');
        const pwBadgesList = document.getElementById('pw_badges_list');
        if (profile.badges && pwBadgesSection && pwBadgesList) {
            const badgeKeys = Object.keys(profile.badges);
            if (badgeKeys.length > 0) {
                pwBadgesSection.style.display = 'block';
                pwBadgesList.innerHTML = badgeKeys.map(badgeId => {
                    const badge = badgeDefinitions[badgeId];
                    if (!badge) return '';
                    return `<div class="profile-badge" style="text-align:center; cursor:pointer; position:relative;" title="${escapeHtml(badge.name)} - ${escapeHtml(badge.description)}">
                        <img src="${badge.image}" style="width:40px; height:40px; border-radius:4px; border:2px solid #500;" onerror="this.style.display='none'">
                        <div style="color:#888; font-size:8px; margin-top:3px; max-width:50px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(badge.name)}</div>
                    </div>`;
                }).join('');
            } else {
                pwBadgesSection.style.display = 'none';
            }
        } else if (pwBadgesSection) {
            pwBadgesSection.style.display = 'none';
        }
        
        // Music player - AUTOPLAY when profile opens
        if (pwMusicSection && pwMusicPlayer) {
            if (profile.music) {
                pwMusicSection.style.display = 'block';
                if (profile.music.includes('soundcloud.com')) pwMusicPlayer.innerHTML = '<iframe width="100%" height="100" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=' + encodeURIComponent(profile.music) + '&color=%23ff0000&auto_play=true&hide_related=true"></iframe>';
                else if (profile.music.includes('spotify.com')) { const m = profile.music.match(/track\/([a-zA-Z0-9]+)/); if (m) pwMusicPlayer.innerHTML = '<iframe src="https://open.spotify.com/embed/track/' + m[1] + '?autoplay=1" width="100%" height="80" frameborder="0" allow="autoplay; encrypted-media"></iframe>'; else pwMusicPlayer.innerHTML = ''; }
                else pwMusicPlayer.innerHTML = '';
            } else { pwMusicSection.style.display = 'none'; pwMusicPlayer.innerHTML = ''; }
        }
    }).catch(err => console.error('Profile load error:', err));
    
    // Load reputation
    db.ref('reputation/' + username).once('value', (s) => { 
        if (pwRep) pwRep.textContent = (s.val()?.score || 0); 
    }).catch(err => console.error('Rep load error:', err));
    
    // Load comments
    db.ref('profile_comments/' + username).orderByChild('timestamp').limitToLast(20).once('value', (s) => {
        const comments = []; s.forEach(c => { if (c.val()) comments.push(c.val()); });
        if (pwCommentsCount) pwCommentsCount.textContent = comments.length;
        if (pwCommentsList) {
            if (comments.length === 0) pwCommentsList.innerHTML = '<div style="color:#555; font-size:11px; text-align:center; padding:10px;">No comments yet.</div>';
            else pwCommentsList.innerHTML = comments.reverse().map(c => `<div style="background:#0a0000; padding:10px; margin-bottom:8px; border-left:3px solid #500; border-radius:0 4px 4px 0;"><div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:#d40000; font-weight:bold; font-size:11px;">${escapeHtml(c.from || 'Unknown')}</span><span style="color:#444; font-size:9px;">${c.date || ''}</span></div><div style="color:#aaa; font-size:11px; line-height:1.4;">${escapeHtml(c.text || '')}</div></div>`).join('');
        }
    }).catch(err => console.error('Comments load error:', err));
    
    // Rep buttons visibility
    const canRep = CURRENT_USER && !IS_GUEST && username !== CURRENT_USER;
    if (pwBtnRepPos) pwBtnRepPos.style.display = canRep ? 'block' : 'none';
    if (pwBtnRepNeg) pwBtnRepNeg.style.display = canRep ? 'block' : 'none';
    if (pwCommentForm) pwCommentForm.style.display = (CURRENT_USER && !IS_GUEST) ? 'block' : 'none';
    
    // Load clubs for this user
    const pwClubsSection = document.getElementById('pw_clubs_section');
    const pwClubsList = document.getElementById('pw_clubs_list');
    if (pwClubsSection && pwClubsList) {
        getUserClubs(username).then(clubs => {
            if (clubs.length > 0) {
                pwClubsSection.style.display = 'block';
                pwClubsList.innerHTML = clubs.map(c => 
                    `<span class="club-badge" style="border-color:${c.color || '#500'}; color:${c.color || '#f88'};">${escapeHtml(c.name)}${c.owner === username ? ' ğŸ‘‘' : ''}</span>`
                ).join('');
            } else {
                pwClubsSection.style.display = 'none';
            }
        });
    }
    
    win.style.display = 'block';
    document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10");
    win.style.zIndex = "500";
    makeDraggable('profile_window');
}
function closeProfileWindow() { 
    const win = document.getElementById('profile_window');
    const musicPlayer = document.getElementById('pw_music_player');
    if (win) win.style.display = 'none'; 
    if (musicPlayer) musicPlayer.innerHTML = ''; 
    profileMusicMuted = false;
}

let profileMusicMuted = false;
function toggleProfileMusic() {
    const player = document.getElementById('pw_music_player');
    const btn = document.getElementById('pw_mute_btn');
    if (!player) return;
    
    profileMusicMuted = !profileMusicMuted;
    
    if (profileMusicMuted) {
        // Store current content and clear
        player.dataset.content = player.innerHTML;
        player.innerHTML = '<div style="color:#666; font-size:11px; text-align:center; padding:10px;">ğŸ”‡ Music muted</div>';
        if (btn) btn.textContent = 'ğŸ”Š Unmute';
    } else {
        // Restore content
        if (player.dataset.content) {
            player.innerHTML = player.dataset.content;
        }
        if (btn) btn.textContent = 'ğŸ”‡ Mute';
    }
}

function giveRep(amount) {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in first.'); return; }
    if (!currentProfileUser || currentProfileUser === CURRENT_USER) return;
    db.ref('reputation/' + currentProfileUser).once('value', (s) => {
        const current = s.val() || { score: 0, givers: {} };
        if (current.givers && current.givers[CURRENT_USER]) { alert('Already gave rep to this user!'); return; }
        current.score = (current.score || 0) + amount;
        current.givers = current.givers || {};
        current.givers[CURRENT_USER] = amount;
        db.ref('reputation/' + currentProfileUser).set(current)
            .then(() => {
                const pwRep = document.getElementById('pw_rep');
                if (pwRep) pwRep.textContent = current.score;
                alert(amount > 0 ? '+1 Rep given!' : '-1 Rep given!');
            })
            .catch(err => { console.error('Rep error:', err); alert('Failed to give rep.'); });
    }).catch(err => { console.error('Rep load error:', err); alert('Failed to load rep.'); });
}
function leaveProfileComment() {
    if (!CURRENT_USER || IS_GUEST) { alert('Must be logged in!'); return; }
    if (!currentProfileUser) return;
    const inputEl = document.getElementById('pw_comment_input');
    const text = inputEl ? inputEl.value.trim() : '';
    if (!text) { alert('Please enter a comment.'); return; }
    db.ref('profile_comments/' + currentProfileUser).push({ 
        from: CURRENT_USER, 
        text: text, 
        date: new Date().toLocaleDateString(), 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    }).then(() => {
        if (inputEl) inputEl.value = '';
        openProfileWindow(currentProfileUser);
    }).catch(err => { console.error('Comment error:', err); alert('Failed to post comment.'); });
}
function openDM(username) {
    if (!username || username === CURRENT_USER || IS_GUEST) return;
    closeProfileWindow();
    alert('DM feature coming soon! Mention @' + username + ' in chat.');
}

// CHAT SYSTEM
function switchChatTab(tab, el) {
    document.querySelectorAll('#chat_win .tab').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    const chatMain = document.getElementById('chat_main');
    const chatAvatar = document.getElementById('chat_avatar');
    if (chatMain) chatMain.style.display = tab === 'main' ? 'block' : 'none';
    if (chatAvatar) chatAvatar.style.display = tab === 'avatar' ? 'block' : 'none';
    if (tab === 'avatar') loadAvatarTab();
}
function loadAvatarTab() {
    if (!CURRENT_USER) return;
    const user = userDatabase[CURRENT_USER] || { fullRank: 'Member' };
    const usernameDisplay = document.getElementById('my_username_display');
    const rankDisplay = document.getElementById('my_rank_display');
    const avatarDisplay = document.getElementById('my_avatar_display');
    const avatarUrlEl = document.getElementById('avatar_url');
    const musicEl = document.getElementById('profile_music');
    const statusEl = document.getElementById('user_status');
    const bioEl = document.getElementById('user_bio');
    const moodEl = document.getElementById('user_mood');
    
    if (usernameDisplay) usernameDisplay.textContent = CURRENT_USER;
    if (rankDisplay) rankDisplay.textContent = user.fullRank || 'Member';
    
    // Load FRESH profile data from Firebase (not cache)
    db.ref('profiles/' + CURRENT_USER).once('value', (snapshot) => {
        const profile = snapshot.val() || {};
        console.log('loadAvatarTab - Loaded profile:', profile);
        
        // Update local userProfile
        userProfile = {
            status: profile.status || '',
            bio: profile.bio || '',
            mood: profile.mood || '',
            avatar: profile.avatar || '',
            music: profile.music || ''
        };
        
        // Update form fields
        if (avatarDisplay) {
            if (profile.avatar) avatarDisplay.innerHTML = '<img src="' + profile.avatar + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML=\'ğŸ¦‡\'">';
            else avatarDisplay.innerHTML = 'ğŸ¦‡';
        }
        if (avatarUrlEl) avatarUrlEl.value = profile.avatar || '';
        if (musicEl) musicEl.value = profile.music || '';
        if (statusEl) statusEl.value = profile.status || '';
        if (bioEl) bioEl.value = profile.bio || '';
        if (moodEl) moodEl.value = profile.mood || '';
        
    }).catch(err => console.error('Failed to load profile in avatar tab:', err));
}
function handleTyping() { if (IS_GUEST || !CURRENT_USER) return; db.ref('typing').set({ user: CURRENT_USER, time: Date.now() }); }
function checkTyping() {
    db.ref('typing').once('value', (s) => {
        const typing = s.val();
        const area = document.getElementById('typing_area');
        if (typing && typing.user && typing.user !== CURRENT_USER && (Date.now() - typing.time) < 2000) { document.getElementById('typing_user').textContent = typing.user; area.style.display = 'block'; }
        else area.style.display = 'none';
    });
}
setInterval(checkTyping, 500);
function handleChatKey(event) { if (event.key === 'Enter') sendChat(); }

const chatCommands = {
    '/help': () => ({ type: 'system', text: 'Commands: /me, /shrug, /tableflip, /blood, /bat, /bite' }),
    '/me': (args) => ({ type: 'action', text: CURRENT_USER + ' ' + args }),
    '/shrug': () => ({ type: 'action', text: CURRENT_USER + ' Â¯\\_(ãƒ„)_/Â¯' }),
    '/tableflip': () => ({ type: 'action', text: CURRENT_USER + ' (â•¯Â°â–¡Â°)â•¯ï¸µ â”»â”â”»' }),
    '/blood': () => ({ type: 'action', text: CURRENT_USER + ' ğŸ©¸ğŸ©¸ğŸ©¸' }),
    '/bat': () => ({ type: 'action', text: CURRENT_USER + ' ğŸ¦‡ *flaps away*' }),
    '/bite': (args) => ({ type: 'action', text: CURRENT_USER + ' ğŸ§› *bites ' + (args || 'the air') + '*' }),
};
const botResponses = [
    { trigger: /vampire|vamp/i, response: "Did someone say vampire? *fangs glisten*" },
    { trigger: /blood/i, response: "The crimson elixir... ğŸ©¸" },
    { trigger: /sun|daylight/i, response: "We don't speak of the burning orb. â˜€ï¸ğŸš«" },
    { trigger: /garlic/i, response: "*hisses* Forbidden! ğŸ§„âŒ" },
];

// Reply tracking
let currentReplyTo = null;

function setReply(username, text, msgId) {
    currentReplyTo = { username, text: text.substring(0, 50), msgId };
    document.getElementById('reply_indicator').style.display = 'block';
    document.getElementById('reply_to_user').textContent = username;
    document.getElementById('reply_to_text').textContent = text.length > 50 ? text.substring(0, 50) + '...' : text;
    document.getElementById('chat_input').focus();
}

function cancelReply() {
    currentReplyTo = null;
    document.getElementById('reply_indicator').style.display = 'none';
}

function mentionUser(username) {
    const input = document.getElementById('chat_input');
    input.value = '@' + username + ' ' + input.value;
    input.focus();
}

async function sendChat() {
    if (IS_GUEST) { alert('Guests cannot send messages.'); return; }
    if (!CURRENT_USER) { alert('Please log in!'); return; }
    
    // Check if user is muted
    const isMuted = await isUserMuted(CURRENT_USER);
    if (isMuted) {
        alert('You are currently muted and cannot send messages.');
        return;
    }
    
    const input = document.getElementById('chat_input');
    const text = input.value.trim();
    if (!text) return;
    const u = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style' };
    const userRank = u.rank || 'M';
    const userStyle = u.style || 'member-style';
    const timeNow = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const cmdMatch = text.match(/^(\/\w+)\s*(.*)?$/);
    if (cmdMatch && chatCommands[cmdMatch[1]]) {
        const result = chatCommands[cmdMatch[1]](cmdMatch[2] || '');
        if (result.type === 'system') { input.value = ''; const logs = document.getElementById('chat_logs'); logs.innerHTML += '<div style="color:#666; font-size:9px; font-style:italic; padding:4px;">' + result.text + '</div>'; logs.scrollTop = logs.scrollHeight; return; }
        else { db.ref('chat').push({ user: CURRENT_USER, text: result.text, isAction: true, tag: userRank, style: userStyle, time: timeNow, timestamp: firebase.database.ServerValue.TIMESTAMP }); }
    } else {
        // Build message object
        const msgData = { 
            user: CURRENT_USER, 
            text: text, 
            tag: userRank, 
            style: userStyle, 
            time: timeNow, 
            timestamp: firebase.database.ServerValue.TIMESTAMP 
        };
        
        // Add reply data if replying
        if (currentReplyTo) {
            msgData.replyTo = currentReplyTo.username;
            msgData.replyText = currentReplyTo.text;
        }
        
        // Check for mentions
        const mentions = text.match(/@(\w+)/g);
        if (mentions) {
            msgData.mentions = mentions.map(m => m.substring(1));
        }
        
        db.ref('chat').push(msgData);
        
        // Bot responses - DISABLED (bot no longer auto-responds)
        // Admins can still manually send as Eric Northman via admin panel
        /*
        for (const br of botResponses) {
            if (br.trigger.test(text)) {
                setTimeout(() => { db.ref('chat').push({ user: 'Eric Northman', text: br.response, tag: 'BOT', style: 'bot-style', isBot: true, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP }); }, 1000 + Math.random() * 1000);
                break;
            }
        }
        */
    }
    input.value = "";
    cancelReply();
}

let chatListenerSet = false;
function setupChatListener() {
    if (chatListenerSet) return;
    chatListenerSet = true;
    db.ref('chat').orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
        const logs = document.getElementById('chat_logs');
        if (!logs) return;
        const msgs = []; snapshot.forEach(c => { if (c.val()) msgs.push({...c.val(), msgId: c.key}); });
        db.ref('pinned').once('value', (ps) => {
            const pinned = ps.val();
            const pc = document.getElementById('pinned_container');
            if (pc) pc.innerHTML = pinned ? '<div class="pinned-msg"><span style="color:#ffd700; font-size:8px;">ğŸ“Œ PINNED</span><br>' + escapeHtml(pinned) + '</div>' : '';
        });
        if (msgs.length === 0) { logs.innerHTML = '<div style="color:#555; text-align:center; padding:40px;">No messages yet.</div>'; return; }
        logs.innerHTML = msgs.map(m => {
            if (!m) return '';
            if (m.isAction) return '<div style="padding:6px 0; font-size:11px; color:#888; font-style:italic; border-bottom:1px solid #300;">* ' + escapeHtml(m.text || '') + '</div>';
            const msgUser = m.user || 'Unknown', msgText = m.text || '', msgTag = m.tag || 'M', msgStyle = m.style || 'member-style', msgTime = m.time || '';
            const botClass = m.isBot ? ' chat-bot' : '';
            let mediaHtml = '';
            if (m.imageData) mediaHtml = '<img src="' + m.imageData + '" style="max-width:200px; max-height:150px; border:1px solid #400; margin-top:6px; border-radius:4px;">';
            else if (m.mediaUrl) {
                if (m.mediaType === 'image') mediaHtml = '<img src="' + m.mediaUrl + '" style="max-width:250px; max-height:200px; border:1px solid #400; margin-top:6px; border-radius:4px; cursor:pointer;" onclick="window.open(\'' + m.mediaUrl + '\')">';
                else if (m.mediaType === 'video') mediaHtml = '<video src="' + m.mediaUrl + '" controls style="max-width:280px; max-height:200px; border:1px solid #400; margin-top:6px; border-radius:4px;"></video>';
                else if (m.mediaType === 'audio') mediaHtml = '<audio src="' + m.mediaUrl + '" controls style="width:250px; margin-top:6px;"></audio>';
            }
            const rankTag = getRankTag(msgTag, msgStyle, msgUser);
            
            // Reply indicator
            let replyHtml = '';
            if (m.replyTo) {
                replyHtml = `<div style="background:#1a0808; border-left:2px solid #500; padding:4px 8px; margin-bottom:6px; font-size:10px; color:#888;">â†©ï¸ Replying to <span style="color:#d40000;">${escapeHtml(m.replyTo)}</span>: ${escapeHtml(m.replyText || '')}</div>`;
            }
            
            // Format text with mentions highlighted - ONLY for valid users
            let formattedText = escapeHtml(msgText);
            formattedText = formattedText.replace(/@(\w+)/g, (match, username) => {
                // Only make clickable if user exists in database
                if (userDatabase[username]) {
                    return '<span style="background:#2a1a2a; color:#ff6666; padding:1px 4px; border-radius:3px; cursor:pointer;" onclick="showProfileCard(\'' + username + '\', event)">@' + username + '</span>';
                }
                return match; // Return unchanged if user doesn't exist
            });
            
            // Check if current user is mentioned
            const isMentioned = m.mentions && m.mentions.includes(CURRENT_USER);
            const mentionClass = isMentioned ? ' background:#1a1a0a; border-left:3px solid #ffd700;' : '';
            
            // Action buttons (reply & mention) + 3-dot menu
            const msgIdSafe = m.msgId || '';
            const actionBtns = m.isBot ? '' : `<div class="chat-actions" style="display:none; position:absolute; right:8px; top:8px; gap:4px; align-items:center;">
                <button onclick="setReply('${escapeHtml(msgUser)}', '${escapeHtml(msgText.replace(/'/g, "\\'").replace(/\n/g, ' '))}', '${msgIdSafe}')" style="background:#222; border:1px solid #400; color:#888; padding:2px 6px; font-size:9px; cursor:pointer; border-radius:3px;">â†©ï¸ Reply</button>
                <button onclick="mentionUser('${escapeHtml(msgUser)}')" style="background:#222; border:1px solid #400; color:#888; padding:2px 6px; font-size:9px; cursor:pointer; border-radius:3px;">@ Mention</button>
                <div class="msg-dropdown" style="position:relative;">
                    <button onclick="toggleMsgMenu(this)" style="background:#222; border:1px solid #400; color:#666; padding:2px 8px; font-size:11px; cursor:pointer; border-radius:3px;">â‹®</button>
                    <div class="msg-menu" style="display:none; position:absolute; right:0; top:100%; background:#1a0a0a; border:1px solid #400; border-radius:4px; min-width:120px; z-index:100; box-shadow:0 2px 8px rgba(0,0,0,0.5);">
                        <div onclick="copyMsgId('${msgIdSafe}')" style="padding:8px 12px; color:#888; font-size:10px; cursor:pointer; border-bottom:1px solid #300;" onmouseenter="this.style.background='#2a1a1a'" onmouseleave="this.style.background='transparent'">ğŸ“‹ Copy Message ID</div>
                        <div onclick="copyMsgText('${escapeHtml(msgText.replace(/'/g, "\\'").replace(/\n/g, ' '))}')" style="padding:8px 12px; color:#888; font-size:10px; cursor:pointer;" onmouseenter="this.style.background='#2a1a1a'" onmouseleave="this.style.background='transparent'">ğŸ“ Copy Text</div>
                    </div>
                </div>
            </div>`;
            
            return `<div class="chat-entry${botClass}" style="padding:10px 8px; border-bottom:1px solid #300; position:relative;${mentionClass}" onmouseenter="this.querySelector('.chat-actions')&&(this.querySelector('.chat-actions').style.display='flex')" onmouseleave="this.querySelector('.chat-actions')&&(this.querySelector('.chat-actions').style.display='none'); closeMsgMenus()">${actionBtns}<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">${rankTag}<span class="${msgStyle}" onclick="showProfileCard('${escapeHtml(msgUser)}', event)" style="font-weight:bold; cursor:pointer;">${escapeHtml(msgUser)}</span><span style="color:#444; font-size:9px; margin-left:auto;">${msgTime}</span></div>${replyHtml}<div style="color:#ddd; font-size:12px; padding-left:35px; line-height:1.5;">${formattedText}${mediaHtml}</div></div>`;
        }).join('');
        logs.scrollTop = logs.scrollHeight;
    });
}

function toggleMsgMenu(btn) {
    const menu = btn.nextElementSibling;
    const wasOpen = menu.style.display === 'block';
    closeMsgMenus();
    if (!wasOpen) menu.style.display = 'block';
}

function closeMsgMenus() {
    document.querySelectorAll('.msg-menu').forEach(m => m.style.display = 'none');
}

function copyMsgId(msgId) {
    navigator.clipboard.writeText(msgId).then(() => {
        alert('Message ID copied: ' + msgId);
    }).catch(() => {
        prompt('Copy this Message ID:', msgId);
    });
    closeMsgMenus();
}

function copyMsgText(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Message copied!');
    }).catch(() => {
        prompt('Copy this message:', text);
    });
    closeMsgMenus();
}

function loadMessages() { setupChatListener(); }
function uploadChatFile() {
    if (IS_GUEST || !CURRENT_USER) { alert('Must be logged in!'); return; }
    const file = document.getElementById('chat_file').files[0]; if (!file) return;
    const isImage = file.type.startsWith('image/'), isVideo = file.type.startsWith('video/'), isAudio = file.type.startsWith('audio/');
    alert('Uploading file...');
    const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', UPLOAD_PRESET);
    const resourceType = isVideo ? 'video' : isAudio ? 'video' : 'image';
    fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`, { method: 'POST', body: formData })
    .then(res => res.json()).then(data => {
        if (data.secure_url) {
            const u = userDatabase[CURRENT_USER] || { rank: 'M', style: 'member-style' };
            const timeNow = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            let mediaType = isVideo ? 'video' : isAudio ? 'audio' : 'image';
            db.ref('chat').push({ user: CURRENT_USER, text: '[' + mediaType.charAt(0).toUpperCase() + mediaType.slice(1) + ']', mediaUrl: data.secure_url, mediaType: mediaType, tag: u.rank || 'M', style: u.style || 'member-style', time: timeNow, timestamp: firebase.database.ServerValue.TIMESTAMP });
        } else { alert('Upload failed.'); }
    }).catch(() => { alert('Upload failed.'); });
    document.getElementById('chat_file').value = '';
}

// ADMIN PANEL
function switchAdminTab(tab, el) {
    document.querySelectorAll('.mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    ['apps', 'members', 'moderation', 'announcements', 'bot', 'videos', 'vip', 'st'].forEach(t => {
        const panel = document.getElementById('admin_tab_' + t);
        if (panel) panel.style.display = t === tab ? 'block' : 'none';
    });
    if (tab === 'apps') loadAllApplications();
    if (tab === 'members') loadAllMembers();
    if (tab === 'moderation') loadBannedUsers();
    if (tab === 'videos') loadAllVideos();
    if (tab === 'vip') loadAllVIPCodes();
}
function sendBotMessage() { const text = document.getElementById('bot_message').value.trim(); if (!text) return; db.ref('chat').push({ user: 'Eric Northman', text: text, tag: 'BOT', style: 'bot-style', isBot: true, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP }); document.getElementById('bot_message').value = ''; }
function pinMessage() { const text = document.getElementById('pin_message').value.trim(); if (!text) return; db.ref('pinned').set(text); document.getElementById('pin_message').value = ''; alert('Pinned!'); }
function clearPin() { db.ref('pinned').remove(); alert('Cleared!'); }
function clearChat() { if (confirm('Clear ALL chat?')) db.ref('chat').remove(); }

function deleteMessageById() {
    const msgId = document.getElementById('delete_msg_id').value.trim();
    const resultDiv = document.getElementById('delete_msg_result');
    
    if (!msgId) {
        resultDiv.innerHTML = '<span style="color:#f00;">Please enter a message ID.</span>';
        return;
    }
    
    // Check if message exists
    db.ref('chat/' + msgId).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultDiv.innerHTML = '<span style="color:#f00;">Message not found.</span>';
            return;
        }
        
        const msg = snapshot.val();
        if (confirm(`Delete message from ${msg.user}?\n\n"${msg.text?.substring(0, 50)}..."`)) {
            db.ref('chat/' + msgId).remove().then(() => {
                resultDiv.innerHTML = '<span style="color:#0f0;">âœ“ Message deleted successfully.</span>';
                document.getElementById('delete_msg_id').value = '';
            }).catch(err => {
                resultDiv.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
            });
        }
    });
}

function exportChat() {
    db.ref('chat').orderByChild('timestamp').once('value', (s) => {
        const msgs = []; s.forEach(c => msgs.push(c.val()));
        const text = msgs.map(m => '[' + (m.time || '') + '] ' + m.user + ': ' + m.text).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fangtasia-chat.txt'; a.click();
    });
}
function loadAllApplications() {
    const container = document.getElementById('all_applications'); if (!container) return;
    const filter = document.getElementById('app_filter')?.value || 'all';
    const search = document.getElementById('app_search')?.value.toLowerCase() || '';
    db.ref('applications').orderByChild('timestamp').once('value', (s) => {
        const apps = []; s.forEach(c => apps.push({ ...c.val(), key: c.key }));
        let filtered = apps.reverse();
        if (filter !== 'all') filtered = filtered.filter(a => a.status === filter);
        if (search) filtered = filtered.filter(a => a.username.toLowerCase().includes(search));
        if (filtered.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No applications found.</div>'; return; }
        container.innerHTML = filtered.map(a => {
            const statusColor = { pending: '#ffd700', approved: '#00ff00', denied: '#ff4444' }[a.status] || '#888';
            const pendingActions = a.status === 'pending' ? `
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid #300;">
                    <input type="text" id="pass_${a.key}" class="ie-input" placeholder="Set password for user..." style="margin-bottom:8px; font-size:11px;">
                    <div style="display:flex; gap:8px;">
                        <button class="ie-btn" style="padding:6px; font-size:10px; background:#030; flex:1;" onclick="approveAndCreateAccount('${a.key}', '${escapeHtml(a.username)}')">âœ“ Approve & Create Account</button>
                        <button class="ie-btn" style="padding:6px; font-size:10px; background:#300; flex:1;" onclick="denyApp('${a.key}')">âœ— Deny</button>
                    </div>
                </div>` : '';
            const createdInfo = a.status === 'approved' && a.accountCreated ? '<div style="color:#0f0; font-size:9px; margin-top:5px;">âœ“ Account created</div>' : '';
            return `<div style="background:#050000; border:1px solid #400; padding:12px; margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <strong style="color:#d40000;">${escapeHtml(a.username)}</strong>
                    <span style="color:${statusColor}; font-size:10px;">${a.status?.toUpperCase()}</span>
                </div>
                <div style="color:#888; font-size:10px;">
                    <div>Date: ${a.date}</div>
                    <div>Referral: ${escapeHtml(a.referral || 'None')}</div>
                    <div>Reason: ${escapeHtml(a.reason)}</div>
                </div>
                ${createdInfo}
                ${pendingActions}
            </div>`;
        }).join('');
    });
}

function approveAndCreateAccount(appKey, username) {
    const passInput = document.getElementById('pass_' + appKey);
    const password = passInput ? passInput.value.trim() : '';
    
    if (!password) {
        alert('Please set a password for the user!');
        return;
    }
    
    if (password.length < 6) {
        alert('Password must be at least 6 characters!');
        return;
    }
    
    // Check if username already exists
    if (userDatabase[username]) {
        alert('Username already exists!');
        return;
    }
    
    // Create the user account in Firebase
    const newUser = {
        pass: password,
        rank: 'M',
        fullRank: 'Member',
        style: 'member-style',
        isAdmin: false
    };
    
    db.ref('members/' + username).set(newUser).then(() => {
        // Add to local database
        userDatabase[username] = newUser;
        
        // Update application status
        db.ref('applications/' + appKey).update({ 
            status: 'approved',
            accountCreated: true,
            approvedBy: CURRENT_USER,
            approvedAt: Date.now()
        });
        
        alert('Account created for ' + username + '!\n\nPassword: ' + password + '\n\nMake sure to give this to the user!');
        loadAllApplications();
        loadAllMembers();
    }).catch(err => {
        alert('Error creating account: ' + err.message);
    });
}

function approveApp(key) { db.ref('applications/' + key).update({ status: 'approved' }); loadAllApplications(); }
function denyApp(key) { db.ref('applications/' + key).update({ status: 'denied' }); loadAllApplications(); }
function loadAllMembers() {
    const container = document.getElementById('all_members'); if (!container) return;
    const members = [];
    Object.keys(userDatabase).forEach(name => { if (!coreAdmins[name]) members.push({ username: name, ...userDatabase[name] }); });
    Object.keys(coreAdmins).forEach(name => members.push({ username: name, ...coreAdmins[name], isCore: true }));
    container.innerHTML = members.map(m => `<div style="background:#050000; border:1px solid #400; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div><span class="${m.style}" style="font-weight:bold;">${escapeHtml(m.username)}</span><span style="color:#666; font-size:10px;"> [${m.fullRank}]</span></div><span style="color:#555; font-size:9px;">ID: ${generateUserId(m.username)}</span></div>`).join('');
}
function loadBannedUsers() {
    const container = document.getElementById('banned_users'); if (!container) return;
    db.ref('bans').once('value', (s) => {
        const bans = s.val() || {}; const now = Date.now();
        const activeBans = Object.entries(bans).filter(([u, b]) => b.expiry === 0 || b.expiry > now);
        if (activeBans.length === 0) { container.innerHTML = 'None'; return; }
        container.innerHTML = activeBans.map(([user, ban]) => {
            const exp = ban.expiry === 0 ? 'Permanent' : new Date(ban.expiry).toLocaleString();
            return `<div style="border-bottom:1px solid #300; padding:5px 0;"><strong style="color:#ff4444;">${escapeHtml(user)}</strong> [${ban.type}] - ${exp} <button class="ie-btn" style="padding:2px 6px; font-size:8px; width:auto;" onclick="unbanUser('${user}')">Unban</button></div>`;
        }).join('');
    });
}
function unbanUser(username) { db.ref('bans/' + username).remove(); loadBannedUsers(); alert(username + ' unbanned.'); }
function executeModAction() {
    const username = document.getElementById('mod_username').value.trim();
    const action = document.getElementById('mod_action').value;
    const duration = parseInt(document.getElementById('mod_duration').value);
    const reason = document.getElementById('mod_reason').value;
    const resultEl = document.getElementById('mod_result');
    
    if (!username || !action) { 
        resultEl.innerHTML = '<span style="color:#f00;">Select user and action.</span>'; 
        return; 
    }
    
    // Check if trying to moderate core admins or ST
    const targetUser = userDatabase[username];
    if (targetUser && (targetUser.isST || ['losersyndicate', 'noseeyedear', 'oleg'].includes(username.toLowerCase()))) { 
        resultEl.innerHTML = '<span style="color:#f00;">Cannot moderate this user.</span>'; 
        return; 
    }
    
    // Mods can only use warn, mute, timeout, kick, unmute
    const currentUser = userDatabase[CURRENT_USER];
    const modActions = ['warn', 'mute', 'timeout', 'kick', 'unmute'];
    if (currentUser && currentUser.isMod && !currentUser.isAdmin && !modActions.includes(action)) {
        resultEl.innerHTML = '<span style="color:#f00;">Mods can only use: warn, mute, timeout, kick, unmute.</span>'; 
        return;
    }
    
    const expiry = duration === 0 ? 0 : Date.now() + (duration * 60 * 1000);
    
    if (action === 'warn') {
        // Send warning to chat visible only to user (or as system message)
        db.ref('chat').push({
            username: 'âš ï¸ WARNING',
            text: `${username}: ${reason || 'You have been warned by a moderator. Please follow the rules.'}`,
            timestamp: Date.now(),
            style: 'system-style',
            isSystem: true
        });
        resultEl.innerHTML = '<span style="color:#0f0;">âš ï¸ ' + username + ' has been warned.</span>';
    }
    else if (action === 'mute') {
        db.ref('muted/' + username).set({ 
            expiry: expiry, 
            reason: reason, 
            by: CURRENT_USER,
            timestamp: Date.now()
        });
        resultEl.innerHTML = '<span style="color:#0f0;">ğŸ”‡ ' + username + ' has been muted' + (duration === 0 ? ' permanently' : ' for ' + duration + ' minutes') + '.</span>';
        loadMutedUsers();
    }
    else if (action === 'timeout') {
        db.ref('muted/' + username).set({ 
            expiry: expiry, 
            reason: reason, 
            by: CURRENT_USER,
            timestamp: Date.now(),
            isTimeout: true
        });
        db.ref('online/' + username).remove(); // Also kick them
        resultEl.innerHTML = '<span style="color:#0f0;">â±ï¸ ' + username + ' has been timed out' + (duration === 0 ? ' permanently' : ' for ' + duration + ' minutes') + '.</span>';
        loadMutedUsers();
    }
    else if (action === 'kick') { 
        db.ref('online/' + username).remove(); 
        resultEl.innerHTML = '<span style="color:#0f0;">ğŸ‘¢ ' + username + ' has been kicked.</span>'; 
    }
    else if (action === 'unmute') {
        db.ref('muted/' + username).remove();
        resultEl.innerHTML = '<span style="color:#0f0;">ğŸ”Š ' + username + ' has been unmuted.</span>';
        loadMutedUsers();
    }
    else if (action === 'softban' || action === 'hardban') {
        db.ref('bans/' + username).set({ 
            type: action, 
            expiry: expiry, 
            reason: reason, 
            by: CURRENT_USER 
        }); 
        if (action === 'hardban') { 
            db.ref('members/' + username).remove(); 
        } 
        db.ref('online/' + username).remove();
        resultEl.innerHTML = '<span style="color:#0f0;">ğŸš« ' + username + ' has been ' + action + 'ned.</span>'; 
        loadBannedUsers();
    }
    
    document.getElementById('mod_username').value = '';
    document.getElementById('mod_reason').value = '';
}

function loadMutedUsers() {
    const container = document.getElementById('muted_users');
    if (!container) return;
    
    db.ref('muted').once('value', (snapshot) => {
        if (!snapshot.exists()) {
            container.innerHTML = '<span style="color:#555;">No muted users.</span>';
            return;
        }
        
        let html = '';
        const now = Date.now();
        snapshot.forEach((child) => {
            const data = child.val();
            const username = child.key;
            const isExpired = data.expiry !== 0 && data.expiry < now;
            
            if (isExpired) {
                // Auto-remove expired mutes
                db.ref('muted/' + username).remove();
                return;
            }
            
            const expiryText = data.expiry === 0 ? 'Permanent' : new Date(data.expiry).toLocaleString();
            html += `<div style="background:#1a0000; padding:5px; margin-bottom:3px; border:1px solid #400; display:flex; justify-content:space-between; align-items:center;">
                <span><span style="color:#d40000;">${escapeHtml(username)}</span> <span style="color:#666;">by ${data.by || 'Unknown'}</span></span>
                <button onclick="db.ref('muted/${username}').remove(); loadMutedUsers();" style="background:#333; border:1px solid #500; color:#888; padding:2px 6px; cursor:pointer; font-size:9px;">Unmute</button>
            </div>`;
        });
        
        container.innerHTML = html || '<span style="color:#555;">No muted users.</span>';
    });
}

// Check if user is muted before sending chat
function isUserMuted(username) {
    return new Promise((resolve) => {
        db.ref('muted/' + username).once('value', (snapshot) => {
            if (!snapshot.exists()) {
                resolve(false);
                return;
            }
            const data = snapshot.val();
            const now = Date.now();
            if (data.expiry !== 0 && data.expiry < now) {
                // Expired, remove and allow
                db.ref('muted/' + username).remove();
                resolve(false);
            } else {
                resolve(true);
            }
        });
    });
}

// Setup admin tabs based on user role
function setupAdminTabs(user) {
    const allTabs = ['apps', 'members', 'moderation', 'announcements', 'bot', 'videos', 'vip'];
    const modOnlyTabs = ['members', 'moderation', 'announcements']; // What mods can see
    
    if (user.isAdmin || user.isST) {
        // Admins and ST see everything
        allTabs.forEach(tab => {
            const btn = document.getElementById('admin_tab_' + tab + '_btn');
            if (btn) btn.style.display = 'block';
        });
    } else if (user.isMod) {
        // Mods only see limited tabs
        allTabs.forEach(tab => {
            const btn = document.getElementById('admin_tab_' + tab + '_btn');
            if (btn) {
                btn.style.display = modOnlyTabs.includes(tab) ? 'block' : 'none';
            }
        });
        // Set moderation as default tab for mods
        switchAdminTab('moderation', document.getElementById('admin_tab_moderation_btn'));
    }
}
function loadAllVideos() {
    const container = document.getElementById('all_videos'); if (!container) return;
    db.ref('archive').once('value', (s) => {
        const videos = []; s.forEach(c => videos.push({ ...c.val(), key: c.key }));
        if (videos.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center;">No videos.</div>'; return; }
        container.innerHTML = videos.reverse().map(v => `<div style="background:#050000; border:1px solid #400; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div><strong style="color:#d40000;">${escapeHtml(v.name)}</strong><span style="color:#666; font-size:10px;"> by ${escapeHtml(v.uploader || 'Unknown')}</span></div><div><button class="ie-btn" style="padding:4px 10px; font-size:10px; width:auto; margin-right:5px;" onclick="window.open('${v.url}')">View</button><button class="ie-btn" style="padding:4px 10px; font-size:10px; width:auto; background:#300;" onclick="deleteVideo('${v.key}')">Delete</button></div></div>`).join('');
    });
    // Also refresh memories view
    renderMemories();
}
function deleteVideo(key) { if (confirm('Delete?')) { db.ref('archive/' + key).remove(); loadAllVideos(); renderMemories(); } }
function generateVIPCode() { 
    const maxUses = parseInt(document.getElementById('vip_code_uses')?.value) || 5;
    const code = 'VIP-' + Math.random().toString(36).substring(2, 8).toUpperCase(); 
    db.ref('vip_codes').push({ 
        code: code, 
        maxUses: maxUses,
        created: Date.now(), 
        createdBy: CURRENT_USER, 
        usedBy: {}
    }).then(() => {
        document.getElementById('vip_code_display').innerHTML = `<div style="background:#1a1a00; border:1px solid #5a4a00; padding:10px; border-radius:4px;">âœ¨ Code: <strong>${code}</strong><br><span style="color:#888; font-size:10px;">Max uses: ${maxUses}</span></div>`; 
        loadVIPCodeHistory();
    });
}

function loadVIPCodeHistory() {
    const container = document.getElementById('vip_code_history');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888;">Loading...</div>';
    
    db.ref('vip_codes').orderByChild('created').once('value', (snapshot) => {
        if (!snapshot.exists()) {
            container.innerHTML = '<div style="color:#666;">No VIP codes generated yet.</div>';
            return;
        }
        
        const codes = [];
        snapshot.forEach((child) => {
            codes.push({ key: child.key, ...child.val() });
        });
        
        // Reverse to show newest first
        codes.reverse();
        
        container.innerHTML = codes.map(c => {
            const usedCount = c.usedBy ? Object.keys(c.usedBy).length : 0;
            const maxUses = c.maxUses || 1;
            const usedBy = c.usedBy ? Object.values(c.usedBy).join(', ') : 'None';
            const isExpired = usedCount >= maxUses;
            const date = new Date(c.created).toLocaleDateString();
            
            return `<div style="background:#0a0000; border:1px solid ${isExpired ? '#333' : '#5a4a00'}; padding:10px; margin-bottom:8px; border-radius:4px; ${isExpired ? 'opacity:0.6;' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#ffd700; font-family:monospace; font-weight:bold;">${c.code || 'Unknown'}</span>
                    <span style="color:${isExpired ? '#666' : '#0f0'}; font-size:10px;">${usedCount}/${maxUses} used</span>
                </div>
                <div style="color:#666; font-size:9px; margin-top:5px;">Created: ${date} by ${c.createdBy || 'Unknown'}</div>
                ${usedCount > 0 ? `<div style="color:#888; font-size:9px; margin-top:3px;">Used by: ${usedBy}</div>` : ''}
                <button onclick="deleteVIPCode('${c.key}')" style="background:#500; border:1px solid #700; color:#f88; padding:3px 8px; font-size:9px; cursor:pointer; margin-top:5px; border-radius:3px;">ğŸ—‘ï¸ Delete</button>
            </div>`;
        }).join('');
    });
}

function deleteVIPCode(codeKey) {
    if (!confirm('Delete this VIP code?')) return;
    db.ref('vip_codes/' + codeKey).remove().then(() => {
        loadVIPCodeHistory();
    });
}
function loadAllVIPCodes() {
    const container = document.getElementById('all_vip_codes'); if (!container) return;
    db.ref('vip_codes').once('value', (s) => {
        const codes = []; s.forEach(c => codes.push({ ...c.val(), key: c.key }));
        if (codes.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center;">No codes.</div>'; return; }
        container.innerHTML = codes.reverse().map(c => `<div style="background:#050000; border:1px solid ${c.used ? '#333' : '#ffd700'}; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><span style="color:${c.used ? '#666' : '#ffd700'}; font-family:monospace; font-size:14px;">${c.code}</span><span style="color:#555; font-size:9px;">${c.used ? 'Used by ' + c.usedBy : 'Available'}</span></div>`).join('');
    });
}
function elevateUser() {
    const resultEl = document.getElementById('st_elevate_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('elevate_user').value.trim(), newRank = document.getElementById('elevate_rank').value;
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const rankConfig = { 
        'member': { rank: 'M', fullRank: 'Member', style: 'member-style', isAdmin: false, isMod: false }, 
        'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style', isAdmin: false, isMod: false }, 
        'contrib': { rank: 'CONTRIB', fullRank: 'Contributor', style: 'contrib-style', isAdmin: false, isMod: false }, 
        'mod': { rank: 'MOD', fullRank: 'Moderator', style: 'mod-style', isAdmin: false, isMod: true }, 
        'admin': { rank: 'A', fullRank: 'Admin', style: 'a-style', isAdmin: true, isMod: true } 
    };
    
    const config = rankConfig[newRank];
    db.ref('members/' + username).update(config); 
    userDatabase[username] = { ...userDatabase[username], ...config }; 
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ ' + username + ' set to ' + config.fullRank + '</span>';
}

function applyPermissionPreset() {
    const preset = document.getElementById('perm_preset').value;
    const modCheck = document.getElementById('perm_mod');
    const adminCheck = document.getElementById('perm_admin');
    const vipCheck = document.getElementById('perm_vip_perks');
    
    switch(preset) {
        case 'none':
            modCheck.checked = false;
            adminCheck.checked = false;
            vipCheck.checked = false;
            break;
        case 'vip_perks':
            modCheck.checked = false;
            adminCheck.checked = false;
            vipCheck.checked = true;
            break;
        case 'moderator':
            modCheck.checked = true;
            adminCheck.checked = false;
            vipCheck.checked = true;
            break;
        case 'admin':
            modCheck.checked = true;
            adminCheck.checked = true;
            vipCheck.checked = true;
            break;
        case 'custom':
            // Don't change anything, let user set manually
            break;
    }
}

function setUserPermissions() {
    const resultEl = document.getElementById('st_perm_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('perm_user').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const isMod = document.getElementById('perm_mod').checked;
    const isAdmin = document.getElementById('perm_admin').checked;
    const hasVipPerks = document.getElementById('perm_vip_perks').checked;
    
    const updates = { isMod: isMod, isAdmin: isAdmin, hasVipPerks: hasVipPerks };
    db.ref('members/' + username).update(updates);
    userDatabase[username] = { ...userDatabase[username], ...updates };
    
    const perms = [];
    if (isMod) perms.push('Moderator');
    if (isAdmin) perms.push('Admin');
    if (hasVipPerks) perms.push('VIP Perks');
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ ' + username + ' permissions: ' + (perms.length > 0 ? perms.join(', ') : 'None') + '</span>';
}

// ST TOOLS - CHANGE USERNAME
function stChangeUsername() {
    const resultEl = document.getElementById('st_username_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const oldName = document.getElementById('st_old_username').value.trim();
    const newName = document.getElementById('st_new_username').value.trim();
    if (!oldName || !newName) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter both usernames.</span>'; return; }
    if (!userDatabase[oldName]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User "' + oldName + '" not found.</span>'; return; }
    if (userDatabase[newName]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username "' + newName + '" already taken.</span>'; return; }
    
    // Copy user data to new username
    const userData = { ...userDatabase[oldName] };
    userDatabase[newName] = userData;
    delete userDatabase[oldName];
    
    // Add old name to deleted accounts filter
    if (!deletedAccounts.includes(oldName)) {
        deletedAccounts.push(oldName);
    }
    
    // Update Firebase members
    db.ref('members/' + newName).set(userData);
    db.ref('members/' + oldName).remove();
    
    // Update profiles
    db.ref('profiles/' + oldName).once('value', (s) => {
        const profile = s.val();
        if (profile) {
            db.ref('profiles/' + newName).set(profile);
            db.ref('profiles/' + oldName).remove();
        }
    });
    
    // Update online status
    db.ref('online/' + oldName).once('value', (s) => {
        if (s.val()) {
            db.ref('online/' + newName).set(s.val());
            db.ref('online/' + oldName).remove();
        }
    });
    
    // Update reputation
    db.ref('reputation/' + oldName).once('value', (s) => {
        if (s.val()) {
            db.ref('reputation/' + newName).set(s.val());
            db.ref('reputation/' + oldName).remove();
        }
    });
    
    // Update profile comments
    db.ref('profile_comments/' + oldName).once('value', (s) => {
        if (s.val()) {
            db.ref('profile_comments/' + newName).set(s.val());
            db.ref('profile_comments/' + oldName).remove();
        }
    });
    
    // Update member list
    updateMemberList();
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Renamed "' + oldName + '" to "' + newName + '"</span>';
}

// ST TOOLS - CUSTOM TAGS
function stSetCustomTag() {
    const resultEl = document.getElementById('st_tag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_tag_username').value.trim();
    const tagText = document.getElementById('st_tag_letter').value.trim();
    const tagColor = document.getElementById('st_tag_color').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (!tagText) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter tag text.</span>'; return; }
    
    // Create unique style name for this user
    const styleName = username.toLowerCase().replace(/[^a-z0-9]/g, '') + '-custom-style';
    
    // Update user database
    userDatabase[username].customTag = tagText;
    userDatabase[username].customTagColor = tagColor;
    userDatabase[username].style = styleName;
    
    // Save to Firebase
    db.ref('members/' + username).update({ 
        customTag: tagText, 
        customTagColor: tagColor,
        style: styleName 
    });
    
    // Inject CSS for the custom style
    const existingStyle = document.getElementById('custom-style-' + username);
    if (existingStyle) existingStyle.remove();
    const styleEl = document.createElement('style');
    styleEl.id = 'custom-style-' + username;
    styleEl.textContent = '.' + styleName + ' { color: ' + tagColor + '; border-color: ' + tagColor + '; background: ' + tagColor + '22; }';
    document.head.appendChild(styleEl);
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Set tag "' + tagText + '" for ' + username + ' with color ' + tagColor + '</span>';
    loadAllMembers();
}

function stRemoveCustomTag() {
    const resultEl = document.getElementById('st_tag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_tag_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    // Get default style based on rank
    const rank = userDatabase[username].rank || 'M';
    const defaultStyles = { 'ST': 'st-style', 'A': 'a-style', 'MOD': 'mod-style', 'CONTRIB': 'contrib-style', 'VIP': 'vip-style', 'M': 'member-style' };
    const defaultStyle = defaultStyles[rank] || 'member-style';
    
    // Update user database
    delete userDatabase[username].customTag;
    delete userDatabase[username].customTagColor;
    userDatabase[username].style = defaultStyle;
    
    // Save to Firebase
    db.ref('members/' + username).update({ 
        customTag: null, 
        customTagColor: null,
        style: defaultStyle 
    });
    
    // Remove custom CSS
    const existingStyle = document.getElementById('custom-style-' + username);
    if (existingStyle) existingStyle.remove();
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Removed custom tag from ' + username + '</span>';
    loadAllMembers();
}

// ST TOOLS - RESET PASSWORD
function stResetPassword() {
    const resultEl = document.getElementById('st_password_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_reset_username').value.trim();
    const newPass = document.getElementById('st_new_password').value;
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (!newPass) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a new password.</span>'; return; }
    
    // Update local
    userDatabase[username].pass = newPass;
    
    // Save to Firebase
    db.ref('members/' + username).update({ pass: newPass });
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Password reset for ' + username + '</span>';
}

// ST TOOLS - DATA MANAGEMENT
function stWipeProfile() {
    const resultEl = document.getElementById('st_data_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_data_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!confirm('Wipe profile for ' + username + '? This removes avatar, bio, status, mood, and music.')) return;
    
    db.ref('profiles/' + username).remove();
    db.ref('reputation/' + username).remove();
    db.ref('profile_comments/' + username).remove();
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Profile wiped for ' + username + '</span>';
}

function stWipeMessages() {
    const resultEl = document.getElementById('st_data_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_data_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!confirm('Delete ALL messages from ' + username + '? This cannot be undone.')) return;
    
    db.ref('chat').orderByChild('user').equalTo(username).once('value', (s) => {
        const updates = {};
        s.forEach((child) => { updates[child.key] = null; });
        db.ref('chat').update(updates);
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Deleted all messages from ' + username + '</span>';
    });
}

function stDeleteUser() {
    const resultEl = document.getElementById('st_data_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_data_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (['losersyndicate', 'noseeyedear', 'oleg'].includes(username.toLowerCase())) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Cannot delete core admins.</span>'; return; 
    }
    if (!confirm('PERMANENTLY DELETE user ' + username + '? This removes their account, profile, messages, and all data. THIS CANNOT BE UNDONE.')) return;
    
    // Remove from local
    delete userDatabase[username];
    
    // Remove from Firebase
    db.ref('members/' + username).remove();
    db.ref('profiles/' + username).remove();
    db.ref('online/' + username).remove();
    db.ref('reputation/' + username).remove();
    db.ref('profile_comments/' + username).remove();
    db.ref('bans/' + username).remove();
    
    // Remove their messages
    db.ref('chat').orderByChild('user').equalTo(username).once('value', (s) => {
        const updates = {};
        s.forEach((child) => { updates[child.key] = null; });
        db.ref('chat').update(updates);
    });
    
    if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ User ' + username + ' permanently deleted</span>';
    loadAllMembers();
}

// ST TOOLS - USER LOOKUP
function stLookupUser() {
    const resultEl = document.getElementById('st_lookup_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    const username = document.getElementById('st_lookup_username').value.trim();
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    
    const user = userDatabase[username];
    if (!user) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    let html = '<div style="background:#0a0000; padding:8px; border:1px solid #ff00ff;">';
    html += '<div style="color:#ff00ff; font-weight:bold; margin-bottom:5px;">' + escapeHtml(username) + '</div>';
    html += '<div>Rank: <span style="color:#fff;">' + (user.fullRank || user.rank || 'Unknown') + '</span></div>';
    html += '<div>Style: <span style="color:#fff;">' + (user.style || 'None') + '</span></div>';
    html += '<div>Custom Tag: <span style="color:#fff;">' + (user.customTag || 'None') + '</span></div>';
    html += '<div>Is Admin: <span style="color:#fff;">' + (user.isAdmin ? 'Yes' : 'No') + '</span></div>';
    html += '<div>Is ST: <span style="color:#fff;">' + (user.isST ? 'Yes' : 'No') + '</span></div>';
    html += '<div>Is Core: <span style="color:#fff;">' + (coreAdmins[username] ? 'Yes' : 'No') + '</span></div>';
    
    // Check online status
    db.ref('online/' + username).once('value', (onlineSnap) => {
        html += '<div>Online: <span style="color:#fff;">' + (onlineSnap.val() ? 'Yes' : 'No') + '</span></div>';
        
        // Check profile
        db.ref('profiles/' + username).once('value', (profileSnap) => {
            const profile = profileSnap.val() || {};
            html += '<div style="margin-top:5px; border-top:1px solid #400; padding-top:5px;">';
            html += '<div>Status: <span style="color:#fff;">' + escapeHtml(profile.status || 'None') + '</span></div>';
            html += '<div>Mood: <span style="color:#fff;">' + escapeHtml(profile.mood || 'None') + '</span></div>';
            html += '<div>Bio: <span style="color:#fff;">' + escapeHtml((profile.bio || 'None').substring(0, 50)) + '</span></div>';
            html += '<div>Avatar: <span style="color:#fff;">' + (profile.avatar ? 'Set' : 'None') + '</span></div>';
            html += '<div>Music: <span style="color:#fff;">' + (profile.music ? 'Set' : 'None') + '</span></div>';
            html += '</div></div>';
            if (resultEl) resultEl.innerHTML = html;
        });
    });
}

// ST CREATE USER - Creates new account in Firebase
function stCreateUser() {
    const resultEl = document.getElementById('st_create_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const username = document.getElementById('st_create_username').value.trim();
    const password = document.getElementById('st_create_password').value;
    const rankSelect = document.getElementById('st_create_rank').value;
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!password || password.length < 4) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Password must be at least 4 characters.</span>'; return; }
    if (userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Username already exists!</span>'; return; }
    
    const rankConfig = {
        'member': { rank: 'M', fullRank: 'Member', style: 'member-style', isAdmin: false },
        'vip': { rank: 'VIP', fullRank: 'VIP', style: 'vip-style', isAdmin: false },
        'contrib': { rank: 'CONTRIB', fullRank: 'Contributor', style: 'contrib-style', isAdmin: false },
        'mod': { rank: 'MOD', fullRank: 'Moderator', style: 'mod-style', isAdmin: false, isMod: true },
        'admin': { rank: 'A', fullRank: 'Admin', style: 'admin-style', isAdmin: true }
    };
    
    const newUser = { pass: password, ...rankConfig[rankSelect] };
    
    db.ref('members/' + username).set(newUser).then(() => {
        userDatabase[username] = newUser;
        updateMemberList();
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ User "' + escapeHtml(username) + '" created!</span><br><span style="color:#888; font-size:9px;">Login: ' + escapeHtml(username) + ' / ' + escapeHtml(password) + '</span>';
        document.getElementById('st_create_username').value = '';
        document.getElementById('st_create_password').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// ST MODIFY REPUTATION
function stModifyRep(direction) {
    const resultEl = document.getElementById('st_rep_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const username = document.getElementById('st_rep_username').value.trim();
    const amount = parseInt(document.getElementById('st_rep_amount').value) || 1;
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    db.ref('reputation/' + username).once('value', (s) => {
        const current = s.val() || { score: 0, givers: {} };
        const change = direction > 0 ? amount : -amount;
        current.score = (current.score || 0) + change;
        
        db.ref('reputation/' + username).set(current).then(() => {
            if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ ' + escapeHtml(username) + ' rep: ' + current.score + ' (' + (change > 0 ? '+' : '') + change + ')</span>';
        });
    });
}

function stSetRep() {
    const resultEl = document.getElementById('st_rep_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const username = document.getElementById('st_rep_username').value.trim();
    const amount = parseInt(document.getElementById('st_rep_amount').value);
    
    if (!username) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (isNaN(amount)) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a valid number.</span>'; return; }
    if (!userDatabase[username]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    db.ref('reputation/' + username).set({ score: amount, givers: {} }).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ ' + escapeHtml(username) + ' rep set to: ' + amount + '</span>';
    });
}

// ST LEAVE COMMENT
function stLeaveComment() {
    const resultEl = document.getElementById('st_comment_result');
    if (!userDatabase[CURRENT_USER]?.isST) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; return; }
    
    const targetUser = document.getElementById('st_comment_username').value.trim();
    const commentText = document.getElementById('st_comment_text').value.trim();
    
    if (!targetUser) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter a target username.</span>'; return; }
    if (!commentText) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter comment text.</span>'; return; }
    if (!userDatabase[targetUser]) { if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const comment = {
        from: CURRENT_USER,
        text: commentText,
        timestamp: Date.now(),
        isAdmin: true
    };
    
    db.ref('profile_comments/' + targetUser).push(comment).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Comment posted on ' + escapeHtml(targetUser) + '\'s profile</span>';
        document.getElementById('st_comment_text').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// SITE-WIDE ANNOUNCEMENT SYSTEM
let announcementTypingTimeout = null;
const announceIcons = {
    'info': 'â„¹ï¸',
    'update': 'ğŸ†•',
    'warning': 'âš ï¸',
    'event': 'ğŸ‰'
};

function sendSiteAnnouncement() {
    const resultEl = document.getElementById('st_announce_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const title = document.getElementById('st_announce_title').value.trim();
    const text = document.getElementById('st_announce_text').value.trim();
    const type = document.getElementById('st_announce_type').value;
    const duration = parseInt(document.getElementById('st_announce_duration').value) || 10;
    const imageUrl = document.getElementById('st_announce_image').value.trim();
    const musicUrl = document.getElementById('st_announce_music').value.trim();
    
    if (!text) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Enter announcement text.</span>'; 
        return; 
    }
    
    // Save to Firebase so all users see it
    const announcement = {
        title: title,
        text: text,
        type: type,
        duration: duration,
        imageUrl: imageUrl || null,
        musicUrl: musicUrl || null,
        timestamp: Date.now(),
        sentBy: CURRENT_USER
    };
    
    db.ref('site_announcement').set(announcement).then(() => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Announcement sent to all users!</span>';
        document.getElementById('st_announce_title').value = '';
        document.getElementById('st_announce_text').value = '';
        document.getElementById('st_announce_image').value = '';
        document.getElementById('st_announce_music').value = '';
    }).catch(err => {
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function previewAnnouncement() {
    const title = document.getElementById('st_announce_title').value.trim();
    const text = document.getElementById('st_announce_text').value.trim() || 'Preview announcement text...';
    const type = document.getElementById('st_announce_type').value;
    const duration = parseInt(document.getElementById('st_announce_duration').value) || 10;
    const imageUrl = document.getElementById('st_announce_image').value.trim();
    const musicUrl = document.getElementById('st_announce_music').value.trim();
    
    showAnnouncement({ title, text, type, duration, imageUrl, musicUrl });
}

let announcementMusicPlayer = null;
let announcementVideoPlayer = null;

function showAnnouncement(data) {
    const overlay = document.getElementById('announcement_overlay');
    const box = document.getElementById('announcement_box');
    const titleEl = document.getElementById('announce_title');
    const textEl = document.getElementById('announce_text');
    const iconEl = document.getElementById('announce_icon');
    const cursorEl = document.getElementById('announce_cursor');
    const imageEl = document.getElementById('announce_image');
    const musicIndicator = document.getElementById('announce_music_indicator');
    
    // Reset
    titleEl.textContent = '';
    textEl.textContent = '';
    cursorEl.style.display = 'inline-block';
    imageEl.style.display = 'none';
    imageEl.innerHTML = '';
    musicIndicator.style.display = 'none';
    
    // Set type styling
    box.className = '';
    box.classList.add('announce-type-' + (data.type || 'info'));
    
    // Set icon
    iconEl.textContent = announceIcons[data.type] || 'ğŸ“¢';
    
    // Show image if provided
    if (data.imageUrl) {
        imageEl.innerHTML = `<img src="${data.imageUrl}" style="max-width:100%; max-height:200px; border-radius:8px; border:1px solid #400;">`;
        imageEl.style.display = 'block';
    }
    
    // Play music if provided (YouTube URL, SoundCloud URL, or legacy video ID)
    if (data.musicUrl || data.musicId) {
        const musicSource = data.musicUrl || data.musicId;
        playAnnouncementMusic(musicSource);
        musicIndicator.style.display = 'block';
    }
    
    // Show overlay
    overlay.style.display = 'flex';
    
    // Typewriter effect for title
    let titleIndex = 0;
    let textIndex = 0;
    const titleStr = data.title || '';
    const textStr = data.text || '';
    const typeSpeed = 30; // ms per character
    
    function typeTitle() {
        if (titleIndex < titleStr.length) {
            titleEl.textContent += titleStr.charAt(titleIndex);
            titleIndex++;
            announcementTypingTimeout = setTimeout(typeTitle, typeSpeed);
        } else {
            // Start typing text after title
            setTimeout(typeText, 200);
        }
    }
    
    function typeText() {
        if (textIndex < textStr.length) {
            textEl.textContent += textStr.charAt(textIndex);
            textIndex++;
            announcementTypingTimeout = setTimeout(typeText, typeSpeed);
        } else {
            // Typing complete - hide cursor
            cursorEl.style.display = 'none';
            
            // Auto-dismiss after duration (but keep video playing)
            setTimeout(() => {
                dismissAnnouncement(false); // Don't stop video
            }, (data.duration || 10) * 1000);
        }
    }
    
    // Start typing
    if (titleStr) {
        typeTitle();
    } else {
        typeText();
    }
    
    // Click to dismiss
    overlay.onclick = () => dismissAnnouncement(false);
}

function playAnnouncementMusic(source) {
    // Stop any existing announcement music
    stopAnnouncementMusic();
    
    // Check if it's a SoundCloud URL
    if (source.includes('soundcloud.com')) {
        // SoundCloud embed - show in corner with close button
        const container = document.createElement('div');
        container.id = 'announcement_video_container';
        container.style.cssText = 'position:fixed; bottom:20px; right:20px; width:320px; height:120px; z-index:99998; border:2px solid #ff5500; border-radius:8px; overflow:hidden; box-shadow:0 0 20px rgba(255,85,0,0.3); background:#000;';
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = 'position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.8); border:1px solid #ff5500; color:#fff; width:24px; height:24px; border-radius:50%; cursor:pointer; z-index:10; font-size:12px;';
        closeBtn.onclick = (e) => { e.stopPropagation(); stopAnnouncementMusic(); };
        
        const iframe = document.createElement('iframe');
        iframe.id = 'announcement_music_player';
        iframe.style.cssText = 'width:100%; height:100%; border:none;';
        iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(source)}&auto_play=true&color=%23ff5500&buying=false&sharing=false`;
        iframe.allow = 'autoplay';
        
        container.appendChild(closeBtn);
        container.appendChild(iframe);
        document.body.appendChild(container);
        announcementVideoPlayer = container;
        announcementMusicPlayer = iframe;
        return;
    }
    
    // Extract YouTube video ID from URL or use as-is
    let videoId = source;
    const ytMatch = source.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\s]+)/);
    if (ytMatch) videoId = ytMatch[1];
    
    // Always show YouTube video player in bottom right corner
    const container = document.createElement('div');
    container.id = 'announcement_video_container';
    container.style.cssText = 'position:fixed; bottom:20px; right:20px; width:320px; height:200px; z-index:99998; border:2px solid #d40000; border-radius:8px; overflow:hidden; box-shadow:0 0 20px rgba(139,0,0,0.5); background:#000;';
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = 'âœ•';
    closeBtn.style.cssText = 'position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.8); border:1px solid #500; color:#fff; width:24px; height:24px; border-radius:50%; cursor:pointer; z-index:10; font-size:12px;';
    closeBtn.onclick = (e) => { e.stopPropagation(); stopAnnouncementMusic(); };
    
    const iframe = document.createElement('iframe');
    iframe.id = 'announcement_music_player';
    iframe.style.cssText = 'width:100%; height:100%; border:none;';
    iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1`;
    iframe.allow = 'autoplay; encrypted-media';
    
    container.appendChild(closeBtn);
    container.appendChild(iframe);
    document.body.appendChild(container);
    announcementVideoPlayer = container;
    announcementMusicPlayer = iframe;
}

function stopAnnouncementMusic() {
    if (announcementMusicPlayer) {
        announcementMusicPlayer.remove();
        announcementMusicPlayer = null;
    }
    if (announcementVideoPlayer) {
        announcementVideoPlayer.remove();
        announcementVideoPlayer = null;
    }
    const existingPlayer = document.getElementById('announcement_music_player');
    if (existingPlayer) existingPlayer.remove();
    const existingContainer = document.getElementById('announcement_video_container');
    if (existingContainer) existingContainer.remove();
}

function dismissAnnouncement(stopMusic = true) {
    const overlay = document.getElementById('announcement_overlay');
    overlay.style.display = 'none';
    if (announcementTypingTimeout) {
        clearTimeout(announcementTypingTimeout);
        announcementTypingTimeout = null;
    }
    // Only stop music if explicitly requested (video can keep playing)
    if (stopMusic) {
        stopAnnouncementMusic();
    }
}

// Listen for site announcements
function startAnnouncementListener() {
    db.ref('site_announcement').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.timestamp) {
            // Only show if announcement is recent (within last 60 seconds)
            const age = Date.now() - data.timestamp;
            if (age < 60000) {
                // Check if we already showed this announcement
                const lastShown = sessionStorage.getItem('lastAnnouncement');
                if (lastShown !== data.timestamp.toString()) {
                    sessionStorage.setItem('lastAnnouncement', data.timestamp.toString());
                    showAnnouncement(data);
                }
            }
        }
    });
}

// Start listener when page loads
setTimeout(startAnnouncementListener, 2000);

// ST CLUB MANAGEMENT FUNCTIONS
function stCreateClub() {
    const resultEl = document.getElementById('st_club_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const name = document.getElementById('st_club_name').value.trim();
    const owner = document.getElementById('st_club_owner').value.trim();
    const color = document.getElementById('st_club_color').value.trim() || '#d40000';
    const description = document.getElementById('st_club_desc').value.trim();
    
    if (!name) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!owner) { resultEl.innerHTML = '<span style="color:#f00;">Enter owner username.</span>'; return; }
    if (!userDatabase[owner]) { resultEl.innerHTML = '<span style="color:#f00;">Owner user not found.</span>'; return; }
    
    // Check if club name already exists
    db.ref('clubs').orderByChild('name').equalTo(name).once('value', (snapshot) => {
        if (snapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">Club name already exists.</span>';
            return;
        }
        
        const clubData = {
            name: name,
            owner: owner,
            color: color,
            description: description || 'A club created by ST.',
            members: { [owner]: true },
            privacy: 'public',
            createdAt: Date.now(),
            createdBy: CURRENT_USER + ' (ST)'
        };
        
        db.ref('clubs').push(clubData).then(() => {
            resultEl.innerHTML = `<span style="color:#0f0;">âœ“ Club "${name}" created with owner ${owner}!</span>`;
            document.getElementById('st_club_name').value = '';
            document.getElementById('st_club_owner').value = '';
            document.getElementById('st_club_desc').value = '';
            // Refresh clubs cache
            loadAllClubs();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

function stTransferClub() {
    const resultEl = document.getElementById('st_club_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_transfer_club').value.trim();
    const newOwner = document.getElementById('st_transfer_to').value.trim();
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!newOwner) { resultEl.innerHTML = '<span style="color:#f00;">Enter new owner username.</span>'; return; }
    if (!userDatabase[newOwner]) { resultEl.innerHTML = '<span style="color:#f00;">New owner user not found.</span>'; return; }
    
    // Find the club
    db.ref('clubs').orderByChild('name').equalTo(clubName).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">Club not found.</span>';
            return;
        }
        
        let clubKey = null;
        let clubData = null;
        snapshot.forEach((child) => {
            clubKey = child.key;
            clubData = child.val();
        });
        
        const oldOwner = clubData.owner;
        
        // Update owner and ensure new owner is a member
        const updates = {
            owner: newOwner,
            [`members/${newOwner}`]: true
        };
        
        db.ref('clubs/' + clubKey).update(updates).then(() => {
            resultEl.innerHTML = `<span style="color:#0f0;">âœ“ Club "${clubName}" transferred from ${oldOwner} to ${newOwner}!</span>`;
            document.getElementById('st_transfer_club').value = '';
            document.getElementById('st_transfer_to').value = '';
            loadAllClubs();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

function stRenameClub() {
    const resultEl = document.getElementById('st_club_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const oldName = document.getElementById('st_rename_club_old').value.trim();
    const newName = document.getElementById('st_rename_club_new').value.trim();
    
    if (!oldName) { resultEl.innerHTML = '<span style="color:#f00;">Enter current club name.</span>'; return; }
    if (!newName) { resultEl.innerHTML = '<span style="color:#f00;">Enter new club name.</span>'; return; }
    
    // Check if new name already exists
    db.ref('clubs').orderByChild('name').equalTo(newName).once('value', (newSnapshot) => {
        if (newSnapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">New club name already exists.</span>';
            return;
        }
        
        // Find the club to rename
        db.ref('clubs').orderByChild('name').equalTo(oldName).once('value', (snapshot) => {
            if (!snapshot.exists()) {
                resultEl.innerHTML = '<span style="color:#f00;">Club not found.</span>';
                return;
            }
            
            let clubKey = null;
            snapshot.forEach((child) => {
                clubKey = child.key;
            });
            
            db.ref('clubs/' + clubKey).update({ name: newName }).then(() => {
                resultEl.innerHTML = `<span style="color:#0f0;">âœ“ Club renamed from "${oldName}" to "${newName}"!</span>`;
                document.getElementById('st_rename_club_old').value = '';
                document.getElementById('st_rename_club_new').value = '';
                loadAllClubs();
            }).catch(err => {
                resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
            });
        });
    });
}

function stDeleteClub() {
    const resultEl = document.getElementById('st_club_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_delete_club').value.trim();
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name to delete.</span>'; return; }
    
    if (!confirm(`Are you sure you want to DELETE the club "${clubName}"?\n\nThis cannot be undone!`)) {
        return;
    }
    
    // Find the club
    db.ref('clubs').orderByChild('name').equalTo(clubName).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            resultEl.innerHTML = '<span style="color:#f00;">Club not found.</span>';
            return;
        }
        
        let clubKey = null;
        snapshot.forEach((child) => {
            clubKey = child.key;
        });
        
        db.ref('clubs/' + clubKey).remove().then(() => {
            resultEl.innerHTML = `<span style="color:#0f0;">âœ“ Club "${clubName}" deleted!</span>`;
            document.getElementById('st_delete_club').value = '';
            loadAllClubs();
        }).catch(err => {
            resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
        });
    });
}

// CLUB TAG MANAGEMENT
function stSetClubTag() {
    const resultEl = document.getElementById('st_clubtag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_clubtag_club').value.trim().toLowerCase();
    const tagText = document.getElementById('st_clubtag_tag').value.trim();
    const tagColor = document.getElementById('st_clubtag_color').value.trim() || '#d40000';
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!tagText) { resultEl.innerHTML = '<span style="color:#f00;">Enter tag text.</span>'; return; }
    
    // Update local clubTags object
    clubTags[clubName] = { tag: tagText, color: tagColor };
    
    // Save to Firebase for persistence
    db.ref('club_tags/' + clubName.replace(/[.#$/\[\]]/g, '_')).set({
        clubName: clubName,
        tag: tagText,
        color: tagColor,
        setBy: CURRENT_USER,
        setAt: Date.now()
    }).then(() => {
        resultEl.innerHTML = `<span style="color:#0f0;">âœ“ Club tag set: "${clubName}" â†’ <span style="color:${tagColor};">[${tagText}]</span></span>`;
        document.getElementById('st_clubtag_club').value = '';
        document.getElementById('st_clubtag_tag').value = '';
        loadClubTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stRemoveClubTag() {
    const resultEl = document.getElementById('st_clubtag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_clubtag_remove').value.trim().toLowerCase();
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    
    // Remove from local clubTags
    delete clubTags[clubName];
    
    // Remove from Firebase
    db.ref('club_tags/' + clubName.replace(/[.#$/\[\]]/g, '_')).remove().then(() => {
        resultEl.innerHTML = `<span style="color:#0f0;">âœ“ Club tag removed for "${clubName}"</span>`;
        document.getElementById('st_clubtag_remove').value = '';
        loadClubTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadClubTagsList() {
    const container = document.getElementById('st_clubtags_list');
    if (!container) return;
    
    // Show local clubTags first
    let html = '<div style="color:#888; margin-bottom:5px;">Local (hardcoded):</div>';
    for (const [club, data] of Object.entries(clubTags)) {
        html += `<div style="padding:3px 0;"><span style="color:#888;">${club}</span> â†’ <span style="color:${data.color}; border:1px solid ${data.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${data.tag}</span></div>`;
    }
    
    // Load from Firebase
    db.ref('club_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            html += '<div style="color:#888; margin:10px 0 5px 0; border-top:1px solid #300; padding-top:5px;">From Database:</div>';
            snapshot.forEach((child) => {
                const data = child.val();
                html += `<div style="padding:3px 0;"><span style="color:#888;">${data.clubName}</span> â†’ <span style="color:${data.color}; border:1px solid ${data.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${data.tag}</span></div>`;
                // Also update local clubTags
                clubTags[data.clubName] = { tag: data.tag, color: data.color };
            });
        }
        container.innerHTML = html || '<div style="color:#666;">No club tags configured.</div>';
    });
}

// Load club tags from Firebase on startup
function loadClubTagsFromDB() {
    db.ref('club_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const data = child.val();
                clubTags[data.clubName] = { tag: data.tag, color: data.color };
            });
        }
    });
}
setTimeout(loadClubTagsFromDB, 1500);

// MEMBERLIST TAGS - Similar to clubTags but for memberlist display
let memberlistTags = {
    '##sb': { tag: '##SB', color: '#6a03b4' },
    'sb': { tag: '##SB', color: '#6a03b4' },
    '#sb': { tag: '##SB', color: '#6a03b4' },
    '##SB': { tag: '##SB', color: '#6a03b4' }
};

function stSetMemberlistTag() {
    const resultEl = document.getElementById('st_mltag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_mltag_club').value.trim().toLowerCase();
    const tagText = document.getElementById('st_mltag_tag').value.trim();
    const tagColor = document.getElementById('st_mltag_color').value.trim() || '#6a03b4';
    
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    if (!tagText) { resultEl.innerHTML = '<span style="color:#f00;">Enter tag text.</span>'; return; }
    
    // Save to Firebase
    const tagKey = clubName.replace(/[.#$/\[\]]/g, '_');
    db.ref('memberlist_tags/' + tagKey).set({
        clubName: clubName,
        tag: tagText,
        color: tagColor
    }).then(() => {
        memberlistTags[clubName] = { tag: tagText, color: tagColor };
        resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Memberlist tag set for "' + clubName + '"!</span>';
        document.getElementById('st_mltag_club').value = '';
        document.getElementById('st_mltag_tag').value = '';
        loadMemberlistTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stRemoveMemberlistTag() {
    const resultEl = document.getElementById('st_mltag_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const clubName = document.getElementById('st_mltag_remove').value.trim().toLowerCase();
    if (!clubName) { resultEl.innerHTML = '<span style="color:#f00;">Enter club name.</span>'; return; }
    
    const tagKey = clubName.replace(/[.#$/\[\]]/g, '_');
    db.ref('memberlist_tags/' + tagKey).remove().then(() => {
        delete memberlistTags[clubName];
        resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Memberlist tag removed for "' + clubName + '"!</span>';
        document.getElementById('st_mltag_remove').value = '';
        loadMemberlistTagsList();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadMemberlistTagsList() {
    const container = document.getElementById('st_mltags_list');
    if (!container) return;
    
    let html = '<div style="color:#888; margin-bottom:5px;">Local tags:</div>';
    Object.keys(memberlistTags).forEach(club => {
        const t = memberlistTags[club];
        html += `<div style="padding:3px 0;"><span style="color:${t.color}; border:1px solid ${t.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${t.tag}</span> â†’ ${club}</div>`;
    });
    
    html += '<div style="color:#888; margin-top:10px; margin-bottom:5px; border-top:1px solid #400; padding-top:5px;">Database tags:</div>';
    
    db.ref('memberlist_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const t = child.val();
                html += `<div style="padding:3px 0;"><span style="color:${t.color}; border:1px solid ${t.color}; padding:1px 4px; border-radius:3px; font-size:9px;">${t.tag}</span> â†’ ${t.clubName}</div>`;
            });
        } else {
            html += '<div style="color:#555;">No database tags.</div>';
        }
        container.innerHTML = html;
    });
}

function loadMemberlistTagsFromDB() {
    db.ref('memberlist_tags').once('value', (snapshot) => {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const data = child.val();
                memberlistTags[data.clubName] = { tag: data.tag, color: data.color };
            });
        }
    });
}
setTimeout(loadMemberlistTagsFromDB, 1500);

// Store user club cache for memberlist display
let userClubsCache = {};

function getUserMemberlistTag(username) {
    // Check if user is in any club that has a memberlist tag
    // Returns { tag, color } or null
    if (userClubsCache[username]) {
        for (const club of userClubsCache[username]) {
            const clubNameLower = club.name.toLowerCase();
            if (memberlistTags[clubNameLower]) {
                return memberlistTags[clubNameLower];
            }
        }
    }
    return null;
}

// Cache user clubs for memberlist tags
function cacheAllUserClubs() {
    db.ref('clubs').once('value', (snapshot) => {
        userClubsCache = {};
        snapshot.forEach((clubSnap) => {
            const club = { id: clubSnap.key, ...clubSnap.val() };
            const clubNameLower = (club.name || '').toLowerCase();
            
            // Add owner
            if (club.owner) {
                if (!userClubsCache[club.owner]) userClubsCache[club.owner] = [];
                userClubsCache[club.owner].push({ ...club, name: club.name });
            }
            // Add members
            if (club.members) {
                club.members.forEach(member => {
                    if (!userClubsCache[member]) userClubsCache[member] = [];
                    userClubsCache[member].push({ ...club, name: club.name });
                });
            }
        });
        // Refresh memberlist after clubs are cached
        updateMemberList();
    });
}
setTimeout(cacheAllUserClubs, 2000);

// BADGE SYSTEM - Dynamic from Firebase
// Default badges (will be merged with Firebase badges)
let badgeDefinitions = {
    'happy_merchant': {
        name: 'Happy Merchant',
        image: 'https://cdn.discordapp.com/attachments/1453234114789638175/1466420403478990868/HappyMerchant.png',
        description: 'Was found very irritatable and annoying by the Staff Team'
    },
    'mossad_agent': {
        name: 'Mossad Agent',
        image: 'https://cdn.discordapp.com/attachments/1453234114789638175/1466213238294315131/ISRAELSSAD.png',
        description: 'Proven to be very helpful for the Sites Staff Team'
    },
    'israeli_citizen': {
        name: 'Israeli Citizen',
        image: 'https://cdn.discordapp.com/attachments/1453234114789638175/1466211242267115707/MOSSAAD.png',
        description: 'Alpha Badge'
    },
    'nazi_party': {
        name: 'Nazi Party',
        image: 'https://cdn.discordapp.com/attachments/1453234114789638175/1466215113915760753/SWASTIKA.png',
        description: 'Evil and Mean Members of the Site are Granted this Badge'
    }
};

// Load badges from Firebase and merge with defaults
function loadBadgesFromFirebase() {
    db.ref('badge_definitions').once('value', (snapshot) => {
        const fbBadges = snapshot.val() || {};
        badgeDefinitions = { ...badgeDefinitions, ...fbBadges };
    });
}
setTimeout(loadBadgesFromFirebase, 1500);

// Badge upload preview
document.addEventListener('DOMContentLoaded', () => {
    const uploadEl = document.getElementById('st_badge_upload');
    const urlEl = document.getElementById('st_badge_url');
    if (uploadEl) {
        uploadEl.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const preview = document.getElementById('st_badge_preview');
                    const previewImg = document.getElementById('st_badge_preview_img');
                    if (preview && previewImg) {
                        previewImg.src = ev.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    if (urlEl) {
        urlEl.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url) {
                const preview = document.getElementById('st_badge_preview');
                const previewImg = document.getElementById('st_badge_preview_img');
                if (preview && previewImg) {
                    previewImg.src = url;
                    preview.style.display = 'block';
                }
            }
        });
    }
});

function stCreateBadge() {
    const resultEl = document.getElementById('st_create_badge_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const badgeId = document.getElementById('st_new_badge_id').value.trim().toLowerCase().replace(/\s+/g, '_');
    const badgeName = document.getElementById('st_new_badge_name').value.trim();
    const badgeDesc = document.getElementById('st_new_badge_desc').value.trim();
    const uploadEl = document.getElementById('st_badge_upload');
    const urlEl = document.getElementById('st_badge_url');
    
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Enter badge ID.</span>'; return; }
    if (!badgeName) { resultEl.innerHTML = '<span style="color:#f00;">Enter display name.</span>'; return; }
    if (!badgeDesc) { resultEl.innerHTML = '<span style="color:#f00;">Enter description.</span>'; return; }
    
    // Get image - either from upload or URL
    const urlValue = urlEl ? urlEl.value.trim() : '';
    const fileValue = uploadEl && uploadEl.files[0];
    
    if (fileValue) {
        // Upload file as base64
        const reader = new FileReader();
        reader.onload = (e) => {
            saveBadgeToFirebase(badgeId, badgeName, badgeDesc, e.target.result, resultEl);
        };
        reader.readAsDataURL(fileValue);
    } else if (urlValue) {
        // Use URL directly
        saveBadgeToFirebase(badgeId, badgeName, badgeDesc, urlValue, resultEl);
    } else {
        resultEl.innerHTML = '<span style="color:#f00;">Upload an image or provide a URL.</span>';
    }
}

function saveBadgeToFirebase(id, name, description, image, resultEl) {
    const badgeData = {
        name: name,
        description: description,
        image: image,
        createdBy: CURRENT_USER,
        createdAt: Date.now()
    };
    
    db.ref('badge_definitions/' + id).set(badgeData).then(() => {
        // Update local cache
        badgeDefinitions[id] = badgeData;
        resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Badge "' + name + '" created!</span>';
        // Clear form
        document.getElementById('st_new_badge_id').value = '';
        document.getElementById('st_new_badge_name').value = '';
        document.getElementById('st_new_badge_desc').value = '';
        document.getElementById('st_badge_url').value = '';
        document.getElementById('st_badge_upload').value = '';
        document.getElementById('st_badge_preview').style.display = 'none';
        // Refresh library
        loadBadgeLibrary();
        loadBadgeSelectOptions();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function loadBadgeSelectOptions() {
    db.ref('badge_definitions').once('value', (snapshot) => {
        const fbBadges = snapshot.val() || {};
        const allBadges = { ...badgeDefinitions, ...fbBadges };
        
        const selectEl = document.getElementById('st_badge_select');
        const deleteSelectEl = document.getElementById('st_delete_badge_select');
        
        if (selectEl) {
            selectEl.innerHTML = '<option value="">-- Select Badge --</option>' +
                Object.keys(allBadges).map(id => 
                    `<option value="${escapeHtml(id)}">${escapeHtml(allBadges[id].name)}</option>`
                ).join('');
        }
        
        if (deleteSelectEl) {
            deleteSelectEl.innerHTML = '<option value="">-- Select Badge to Delete --</option>' +
                Object.keys(allBadges).map(id => 
                    `<option value="${escapeHtml(id)}">${escapeHtml(allBadges[id].name)}</option>`
                ).join('');
        }
        
        // Update local cache
        badgeDefinitions = allBadges;
    });
}

function loadBadgeLibrary() {
    db.ref('badge_definitions').once('value', (snapshot) => {
        const fbBadges = snapshot.val() || {};
        const allBadges = { ...badgeDefinitions, ...fbBadges };
        
        const libraryEl = document.getElementById('st_badge_library');
        if (!libraryEl) return;
        
        if (Object.keys(allBadges).length === 0) {
            libraryEl.innerHTML = '<div style="color:#666; font-size:10px; width:100%; text-align:center;">No badges found.</div>';
            return;
        }
        
        libraryEl.innerHTML = Object.keys(allBadges).map(id => {
            const badge = allBadges[id];
            return `<div style="text-align:center; width:70px;" title="${escapeHtml(badge.name)} - ${escapeHtml(badge.description)}">
                <img src="${escapeHtml(badge.image)}" style="width:40px; height:40px; border-radius:4px; border:1px solid #500;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect fill=%22%23333%22 width=%2240%22 height=%2240%22/><text x=%2250%%22 y=%2255%%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2212%22>?</text></svg>'">
                <div style="color:#888; font-size:8px; margin-top:3px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(badge.name)}</div>
                <div style="color:#555; font-size:7px;">${escapeHtml(id)}</div>
            </div>`;
        }).join('');
        
        // Update local cache
        badgeDefinitions = allBadges;
    });
}

function stDeleteBadge() {
    const resultEl = document.getElementById('st_delete_badge_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const badgeId = document.getElementById('st_delete_badge_select').value;
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    
    if (!confirm('Are you sure you want to delete this badge? Users who have it will lose it.')) return;
    
    db.ref('badge_definitions/' + badgeId).remove().then(() => {
        delete badgeDefinitions[badgeId];
        resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Badge deleted!</span>';
        loadBadgeLibrary();
        loadBadgeSelectOptions();
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stAssignBadge() {
    const resultEl = document.getElementById('st_badge_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('st_badge_username').value.trim();
    const badgeId = document.getElementById('st_badge_select').value;
    
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    if (!userDatabase[username]) { resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    
    const badgeName = badgeDefinitions[badgeId]?.name || badgeId;
    
    db.ref('profiles/' + username + '/badges/' + badgeId).set({
        id: badgeId,
        assignedBy: CURRENT_USER,
        assignedAt: Date.now()
    }).then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Badge "' + badgeName + '" assigned to ' + username + '!</span>';
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

function stRemoveBadge() {
    const resultEl = document.getElementById('st_badge_result');
    if (!userDatabase[CURRENT_USER]?.isST) { 
        if (resultEl) resultEl.innerHTML = '<span style="color:#f00;">Access denied. ST only.</span>'; 
        return; 
    }
    
    const username = document.getElementById('st_badge_username').value.trim();
    const badgeId = document.getElementById('st_badge_select').value;
    
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter username.</span>'; return; }
    if (!badgeId) { resultEl.innerHTML = '<span style="color:#f00;">Select a badge.</span>'; return; }
    
    db.ref('profiles/' + username + '/badges/' + badgeId).remove().then(() => {
        resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Badge removed from ' + username + '!</span>';
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

// WATCH PARTY SYSTEM
let currentWatchPartyRoom = null;
let wpPlayerReady = false;
let wpPlayer = null;
let wpChatListener = null;
let wpSyncInterval = null;

function switchWatchPartyTab(tab, el) {
    document.querySelectorAll('#watchparty_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('wp_tab_rooms').style.display = tab === 'rooms' ? 'block' : 'none';
    document.getElementById('wp_tab_create').style.display = tab === 'create' ? 'block' : 'none';
    document.getElementById('wp_tab_room').style.display = tab === 'room' ? 'flex' : 'none';
    
    if (tab === 'rooms') loadWatchPartyRooms();
}

function loadWatchPartyRooms() {
    const container = document.getElementById('wp_room_list');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">Loading...</div>';
    
    db.ref('watch_parties').orderByChild('createdAt').once('value', (snapshot) => {
        if (!snapshot.exists()) {
            container.innerHTML = '<div style="color:#555; text-align:center; padding:40px; background:#050000; border:1px dashed #300; border-radius:4px;"><div style="font-size:30px; margin-bottom:10px;">ğŸ¬</div>No active watch parties.<br><span style="color:#666; font-size:10px;">Create one to get started!</span></div>';
            return;
        }
        
        const rooms = [];
        snapshot.forEach((child) => {
            rooms.push({ key: child.key, ...child.val() });
        });
        
        rooms.reverse();
        
        container.innerHTML = rooms.map(room => {
            const viewerCount = room.viewers ? Object.keys(room.viewers).length : 0;
            const isPrivate = room.type === 'private';
            const isHost = room.host === CURRENT_USER;
            
            return `<div style="background:linear-gradient(180deg, #0a0000, #050000); border:1px solid #500; padding:15px; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.3);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="color:#d40000; font-weight:bold; text-shadow:0 0 5px rgba(139,0,0,0.3);">${isPrivate ? 'ğŸ”’ ' : 'ğŸ¬ '}${escapeHtml(room.name)}</span>
                    <span style="color:#888; font-size:10px; background:#1a0808; padding:3px 8px; border-radius:10px;">ğŸ‘¥ ${viewerCount}</span>
                </div>
                <div style="color:#666; font-size:10px; margin-bottom:10px;">Host: <span style="color:#888;">${escapeHtml(room.host)}</span></div>
                <div style="display:flex; gap:8px;">
                    <button class="ie-btn" style="flex:1; padding:8px 15px;" onclick="joinWatchPartyRoom('${room.key}')">Join</button>
                    ${isHost ? `<button class="ie-btn" style="width:auto; padding:8px 12px; background:#500;" onclick="deleteWatchPartyRoom('${room.key}')">ğŸ—‘ï¸</button>` : ''}
                </div>
            </div>`;
        }).join('');
    });
}

function createWatchPartyRoom() {
    const resultEl = document.getElementById('wp_create_result');
    const name = document.getElementById('wp_room_name').value.trim();
    const videoUrl = document.getElementById('wp_video_url').value.trim();
    const type = document.getElementById('wp_room_type').value;
    
    if (!CURRENT_USER || IS_GUEST) {
        resultEl.innerHTML = '<span style="color:#f00;">Must be logged in!</span>';
        return;
    }
    
    if (!name) { resultEl.innerHTML = '<span style="color:#f00;">Enter room name.</span>'; return; }
    if (!videoUrl) { resultEl.innerHTML = '<span style="color:#f00;">Enter YouTube URL.</span>'; return; }
    
    // Extract video ID from URL
    let videoId = videoUrl;
    const ytMatch = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\s]+)/);
    if (ytMatch) videoId = ytMatch[1];
    
    const roomData = {
        name: name,
        videoId: videoId,
        host: CURRENT_USER,
        type: type,
        createdAt: Date.now(),
        currentTime: 0,
        isPlaying: false,
        viewers: { [CURRENT_USER]: true }
    };
    
    db.ref('watch_parties').push(roomData).then((ref) => {
        resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Room created!</span>';
        document.getElementById('wp_room_name').value = '';
        document.getElementById('wp_video_url').value = '';
        joinWatchPartyRoom(ref.key);
    }).catch(err => {
        resultEl.innerHTML = '<span style="color:#f00;">Error: ' + err.message + '</span>';
    });
}

let wpCurrentHost = null;
let wpKeepAwakeInterval = null;

function joinWatchPartyRoom(roomKey) {
    currentWatchPartyRoom = roomKey;
    
    // Add self to viewers
    db.ref('watch_parties/' + roomKey + '/viewers/' + CURRENT_USER).set({
        username: CURRENT_USER,
        joinedAt: Date.now()
    });
    
    // Remove on disconnect
    db.ref('watch_parties/' + roomKey + '/viewers/' + CURRENT_USER).onDisconnect().remove();
    
    // Load room data
    db.ref('watch_parties/' + roomKey).once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) {
            alert('Room not found!');
            return;
        }
        
        wpCurrentHost = room.host;
        document.getElementById('wp_room_title').textContent = room.name;
        
        // Show host badge if user is host
        const hostBadge = document.getElementById('wp_host_badge');
        if (hostBadge) {
            hostBadge.style.display = (CURRENT_USER === room.host) ? 'inline' : 'none';
        }
        
        // Enable/disable host-only controls
        updateWPHostControls(room.host);
        
        // Switch to room view
        switchWatchPartyTab('room', null);
        
        // Initialize YouTube player
        const videoId = room.videoId || room.mediaSource;
        initWPPlayer(videoId, room.currentTime, room.isPlaying);
        
        // Start chat listener
        startWPChatListener(roomKey);
        
        // Start sync listener
        startWPSyncListener(roomKey, room.host);
        
        // Update viewer count and list
        updateWPViewerCount(roomKey);
        
        // Prevent screen from going idle
        startWPKeepAwake();
    });
}

function updateWPHostControls(host) {
    const isHost = CURRENT_USER === host;
    
    // Disable controls for non-hosts
    document.querySelectorAll('.wp-host-only').forEach(el => {
        el.disabled = !isHost;
        el.style.opacity = isHost ? '1' : '0.5';
        el.style.cursor = isHost ? 'pointer' : 'not-allowed';
    });
}

function startWPKeepAwake() {
    // Clear any existing interval
    if (wpKeepAwakeInterval) clearInterval(wpKeepAwakeInterval);
    
    // Prevent screen idle by simulating activity every 30 seconds
    wpKeepAwakeInterval = setInterval(() => {
        if (currentWatchPartyRoom) {
            // Request wake lock if available
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }
        }
    }, 30000);
}

function stopWPKeepAwake() {
    if (wpKeepAwakeInterval) {
        clearInterval(wpKeepAwakeInterval);
        wpKeepAwakeInterval = null;
    }
}

function initWPPlayer(videoId, startTime, autoplay) {
    const container = document.getElementById('wp_player');
    container.innerHTML = '';
    
    // YouTube player
    const iframe = document.createElement('iframe');
    iframe.id = 'wp_yt_player';
    iframe.width = '100%';
    iframe.height = '100%';
    iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&start=${Math.floor(startTime || 0)}&autoplay=${autoplay ? 1 : 0}`;
    iframe.frameBorder = '0';
    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
    iframe.allowFullscreen = true;
    container.appendChild(iframe);
    
    document.getElementById('wp_play_btn').textContent = autoplay ? 'â¸ï¸' : 'â–¶ï¸';
}

function wpTogglePlay() {
    if (!currentWatchPartyRoom) return;
    
    // Only host can control playback
    if (CURRENT_USER !== wpCurrentHost) {
        alert('Only the host can control playback. Click Sync to match the host.');
        return;
    }
    
    db.ref('watch_parties/' + currentWatchPartyRoom).once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;
        
        const newState = !room.isPlaying;
        db.ref('watch_parties/' + currentWatchPartyRoom).update({
            isPlaying: newState,
            lastUpdate: Date.now()
        });
        
        document.getElementById('wp_play_btn').textContent = newState ? 'â¸ï¸' : 'â–¶ï¸';
    });
}

function wpSeek(value) {
    if (!currentWatchPartyRoom) return;
    // This would require more complex YouTube API integration
    // For now, just update the time in Firebase
}

function wpSyncToHost() {
    if (!currentWatchPartyRoom) return;
    
    db.ref('watch_parties/' + currentWatchPartyRoom).once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;
        
        const videoId = room.videoId || room.mediaSource;
        initWPPlayer(videoId, room.currentTime, room.isPlaying);
    });
}

function startWPSyncListener(roomKey, host) {
    // Listen for host's playback state changes
    db.ref('watch_parties/' + roomKey).on('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) return;
        
        // Update viewer count
        const viewerCount = room.viewers ? Object.keys(room.viewers).length : 0;
        document.getElementById('wp_viewer_count').textContent = `ğŸ‘¥ ${viewerCount} watching`;
        
        // Update play button
        document.getElementById('wp_play_btn').textContent = room.isPlaying ? 'â¸ï¸ Pause' : 'â–¶ï¸ Play';
    });
}

function updateWPViewerCount(roomKey) {
    db.ref('watch_parties/' + roomKey + '/viewers').on('value', (snapshot) => {
        const viewers = snapshot.val();
        const viewerNames = viewers ? Object.keys(viewers) : [];
        const count = viewerNames.length;
        
        const countEl = document.getElementById('wp_viewer_count');
        if (countEl) countEl.textContent = `ğŸ‘¥ ${count} watching`;
        
        // Update viewer list
        const listEl = document.getElementById('wp_viewer_list');
        if (listEl) {
            listEl.innerHTML = viewerNames.map(name => {
                const isHost = name === wpCurrentHost;
                return `<span style="background:${isHost ? '#2a2a00' : '#1a0a0a'}; color:${isHost ? '#ffd700' : '#888'}; padding:2px 6px; border-radius:3px; border:1px solid ${isHost ? '#5a5a00' : '#300'};">${isHost ? 'ğŸ‘‘ ' : ''}${escapeHtml(name)}</span>`;
            }).join('');
        }
    });
}

function startWPChatListener(roomKey) {
    if (wpChatListener) db.ref('watch_party_chat/' + wpChatListener).off();
    wpChatListener = roomKey;
    
    const messagesEl = document.getElementById('wp_chat_messages');
    
    db.ref('watch_party_chat/' + roomKey).orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
        const msgs = [];
        snapshot.forEach((child) => {
            msgs.push(child.val());
        });
        
        messagesEl.innerHTML = msgs.map(m => 
            `<div style="padding:4px 0; border-bottom:1px solid #200;">
                <span style="color:#d40000; font-weight:bold;">${escapeHtml(m.user)}</span>
                <span style="color:#ddd;">${escapeHtml(m.text)}</span>
            </div>`
        ).join('');
        
        messagesEl.scrollTop = messagesEl.scrollHeight;
    });
}

function sendWPChat() {
    if (!currentWatchPartyRoom || !CURRENT_USER || IS_GUEST) return;
    
    const input = document.getElementById('wp_chat_input');
    const text = input.value.trim();
    if (!text) return;
    
    db.ref('watch_party_chat/' + currentWatchPartyRoom).push({
        user: CURRENT_USER,
        text: text,
        timestamp: Date.now()
    });
    
    input.value = '';
}

function leaveWatchPartyRoom() {
    if (currentWatchPartyRoom) {
        // Remove from viewers
        db.ref('watch_parties/' + currentWatchPartyRoom + '/viewers/' + CURRENT_USER).remove();
        
        // Stop keep-awake
        stopWPKeepAwake();
        
        // Check if room is now empty and auto-delete if so
        db.ref('watch_parties/' + currentWatchPartyRoom + '/viewers').once('value', (snapshot) => {
            const viewers = snapshot.val();
            if (!viewers || Object.keys(viewers).length === 0) {
                // Room is empty, delete it
                db.ref('watch_parties/' + currentWatchPartyRoom).remove();
                db.ref('watch_party_chat/' + currentWatchPartyRoom).remove();
            }
        });
        
        // Stop listeners
        if (wpChatListener) {
            db.ref('watch_party_chat/' + wpChatListener).off();
            wpChatListener = null;
        }
        db.ref('watch_parties/' + currentWatchPartyRoom).off();
        
        currentWatchPartyRoom = null;
    }
    
    switchWatchPartyTab('rooms', document.querySelector('#watchparty_window .mgmt-sidebar-item'));
}

function deleteWatchPartyRoom(roomKey) {
    // Check if user is the host
    db.ref('watch_parties/' + roomKey).once('value', (snapshot) => {
        const room = snapshot.val();
        if (!room) {
            alert('Room not found.');
            loadWatchPartyRooms();
            return;
        }
        
        if (room.host !== CURRENT_USER) {
            alert('Only the room creator can delete this room.');
            return;
        }
        
        if (!confirm('Delete this watch party?')) return;
        
        db.ref('watch_parties/' + roomKey).remove();
        db.ref('watch_party_chat/' + roomKey).remove();
        
        if (currentWatchPartyRoom === roomKey) {
            leaveWatchPartyRoom();
        } else {
            loadWatchPartyRooms();
        }
    });
}

function wpToggleFullscreen() {
    const container = document.getElementById('wp_player_container');
    const iframe = container.querySelector('iframe');
    
    if (!document.fullscreenElement) {
        // Enter fullscreen
        if (iframe) {
            if (iframe.requestFullscreen) {
                iframe.requestFullscreen();
            } else if (iframe.webkitRequestFullscreen) {
                iframe.webkitRequestFullscreen();
            } else if (iframe.msRequestFullscreen) {
                iframe.msRequestFullscreen();
            }
        } else if (container.requestFullscreen) {
            container.requestFullscreen();
        }
    } else {
        // Exit fullscreen
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
}

function uploadVIPImage() {
    const user = userDatabase[CURRENT_USER]; if (!user || !(user.rank === 'VIP' || user.rank === 'CONTRIB' || user.isAdmin || user.isST)) { alert('VIP+ only.'); return; }
    const file = document.getElementById('vip_image_picker').files[0]; if (!file) { alert('Select image.'); return; }
    document.getElementById('vip_image_result').innerHTML = '<div style="color:#888; font-size:10px;">Uploading...</div>';
    const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', UPLOAD_PRESET);
    fetch('https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/image/upload', { method: 'POST', body: formData })
        .then(res => res.json()).then(data => {
            if (data.secure_url) { document.getElementById('vip_image_result').innerHTML = `<div style="background:#0a0000; border:1px solid #ffd700; padding:10px;"><div style="color:#0f0; font-size:10px;">âœ“ Uploaded!</div><input type="text" value="${data.secure_url}" style="width:100%; font-size:10px; background:#000; border:1px solid #ffd700; color:#ffd700; padding:6px;" onclick="this.select();" readonly></div>`; }
            else document.getElementById('vip_image_result').innerHTML = '<div style="color:#f00; font-size:10px;">Failed.</div>';
        });
}

// ==================== CLUBS SYSTEM ====================
let userClubs = [];
let ownedClub = null;

function switchClubTab(tab, el) {
    document.querySelectorAll('#clubs_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    ['browse', 'my', 'create', 'invites', 'manage'].forEach(t => {
        const panel = document.getElementById('club_tab_' + t);
        if (panel) panel.style.display = t === tab ? 'block' : 'none';
    });
    if (tab === 'browse') loadAllClubs();
    if (tab === 'my') loadMyClubs();
    if (tab === 'invites') loadClubInvites();
    if (tab === 'create') checkCanCreateClub();
    if (tab === 'manage') loadManageClub();
}

function loadAllClubs() {
    const container = document.getElementById('clubs_list');
    if (!container) { console.error('clubs_list container not found'); return; }
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading clubs...</div>';
    
    // Use get() method for more reliable fetching
    db.ref('clubs').get().then((snapshot) => {
        console.log('Clubs snapshot exists:', snapshot.exists());
        
        if (!snapshot.exists()) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No clubs yet. Be the first to create one!</div>';
            return;
        }
        
        const clubs = [];
        snapshot.forEach((childSnapshot) => {
            const clubData = childSnapshot.val();
            clubs.push({ 
                id: childSnapshot.key, 
                ...clubData 
            });
        });
        
        // Update cache
        clubsCache = snapshot.val() || {};
        
        console.log('Loaded clubs count:', clubs.length, clubs);
        
        if (clubs.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No clubs yet. Be the first to create one!</div>';
            return;
        }
        
        // Sort by created date (newest first)
        clubs.sort((a, b) => (b.created || 0) - (a.created || 0));
        
        let html = '';
        clubs.forEach(club => {
            const isMember = club.members && Array.isArray(club.members) && club.members.includes(CURRENT_USER);
            const isOwner = club.owner === CURRENT_USER;
            const memberCount = (Array.isArray(club.members) ? club.members.length : 0) + 1;
            const clubColor = club.color || '#d40000';
            const clubName = club.name || 'Unnamed Club';
            const clubDesc = club.description || '';
            const clubOwner = club.owner || 'Unknown';
            
            html += `<div class="club-card" style="border-color:${clubColor}; margin-bottom:10px; padding:12px; background:#0a0000; border:1px solid ${clubColor}; border-radius:4px;">
                <div class="club-name" style="color:${clubColor}; font-weight:bold; font-size:14px;">${escapeHtml(clubName)}</div>
                <div style="color:#888; font-size:11px; margin:5px 0;">${escapeHtml(clubDesc)}</div>
                <div class="club-members" style="color:#666; font-size:10px;">ğŸ‘¥ ${memberCount} members â€¢ Owner: ${escapeHtml(clubOwner)}</div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0; background:#222;" onclick="viewClubMembers('${club.id}', '${escapeHtml(clubName).replace(/'/g, "\\'")}', '${escapeHtml(clubOwner).replace(/'/g, "\\'")}')">ğŸ‘¥ View</button>
                    ${isOwner ? '<span style="color:#ffd700; font-size:10px;">ğŸ‘‘ Owner</span>' : 
                      isMember ? '<span style="color:#0f0; font-size:10px;">âœ“ Member</span>' : 
                      `<button class="ie-btn" style="width:auto; padding:5px 12px; font-size:10px; margin:0;" onclick="requestJoinClub('${club.id}')">Join</button>`}
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    }).catch(err => {
        console.error('Error loading clubs:', err);
        container.innerHTML = '<div style="color:#f00; text-align:center; padding:20px;">Error loading clubs: ' + err.message + '</div>';
    });
}

function viewClubMembers(clubId, clubName, owner) {
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) { alert('Club not found.'); return; }
        const club = s.val();
        const members = club.members || [];
        let memberList = 'ğŸ‘‘ ' + owner + ' (Owner)\n';
        members.forEach(m => { memberList += 'â€¢ ' + m + '\n'; });
        alert('Members of ' + clubName + ':\n\n' + memberList);
    });
}

function searchClubs() {
    const query = document.getElementById('club_search').value.toLowerCase();
    const cards = document.querySelectorAll('#clubs_list .club-card');
    cards.forEach(card => {
        const name = card.querySelector('.club-name').textContent.toLowerCase();
        card.style.display = name.includes(query) ? 'block' : 'none';
    });
}

function loadMyClubs() {
    const container = document.getElementById('my_clubs_list');
    if (!container) return;
    db.ref('clubs').once('value', (s) => {
        const myClubs = [];
        s.forEach(c => {
            const club = { id: c.key, ...c.val() };
            if (club.owner === CURRENT_USER || (club.members && club.members.includes(CURRENT_USER))) {
                myClubs.push(club);
            }
        });
        userClubs = myClubs;
        if (myClubs.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">You haven\'t joined any clubs yet.</div>';
            return;
        }
        container.innerHTML = myClubs.map(club => {
            const isOwner = club.owner === CURRENT_USER;
            return `<div class="club-card" style="border-color:${club.color || '#400'};">
                <div class="club-name" style="color:${club.color || '#d40000'};">${escapeHtml(club.name)} ${isOwner ? 'ğŸ‘‘' : ''}</div>
                <div class="club-members">ğŸ‘¥ ${(club.members || []).length + 1} members</div>
                ${!isOwner ? `<button class="ie-btn" style="width:auto; padding:5px 10px; margin-top:8px; font-size:10px; background:#333;" onclick="leaveClub('${club.id}')">Leave Club</button>` : ''}
            </div>`;
        }).join('');
    });
}

function checkCanCreateClub() {
    db.ref('clubs').orderByChild('owner').equalTo(CURRENT_USER).once('value', (s) => {
        if (s.exists()) {
            document.getElementById('create_club_form').style.display = 'none';
            document.getElementById('already_owns_club').style.display = 'block';
            document.getElementById('club_manage_tab').style.display = 'block';
            s.forEach(c => { ownedClub = { id: c.key, ...c.val() }; });
        } else {
            document.getElementById('create_club_form').style.display = 'block';
            document.getElementById('already_owns_club').style.display = 'none';
            document.getElementById('club_manage_tab').style.display = 'none';
            ownedClub = null;
        }
    });
}

function createClub() {
    if (!CURRENT_USER || IS_GUEST) { alert('Please log in!'); return; }
    const name = document.getElementById('new_club_name').value.trim();
    const desc = document.getElementById('new_club_desc').value.trim();
    const color = document.getElementById('new_club_color').value.trim() || '#d40000';
    const resultEl = document.getElementById('create_club_result');
    if (!name) { resultEl.innerHTML = '<span style="color:#f00;">Enter a club name.</span>'; return; }
    if (name.length < 3) { resultEl.innerHTML = '<span style="color:#f00;">Name must be at least 3 characters.</span>'; return; }
    
    db.ref('clubs').orderByChild('owner').equalTo(CURRENT_USER).once('value', (s) => {
        if (s.exists()) { resultEl.innerHTML = '<span style="color:#f00;">You already own a club!</span>'; return; }
        const clubId = 'club_' + Date.now();
        db.ref('clubs/' + clubId).set({
            name: name,
            description: desc,
            color: color,
            owner: CURRENT_USER,
            members: [],
            created: Date.now()
        }, (err) => {
            if (err) { resultEl.innerHTML = '<span style="color:#f00;">Failed to create club.</span>'; }
            else {
                resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Club created!</span>';
                document.getElementById('new_club_name').value = '';
                document.getElementById('new_club_desc').value = '';
                checkCanCreateClub();
                loadAllClubs(); // Refresh browse clubs
                loadMyClubs(); // Refresh my clubs
            }
        });
    });
}

function loadClubInvites() {
    const container = document.getElementById('club_invites_list');
    if (!container) return;
    db.ref('club_invites/' + CURRENT_USER).once('value', (s) => {
        const invites = [];
        s.forEach(c => invites.push({ id: c.key, ...c.val() }));
        if (invites.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No pending invites.</div>';
            return;
        }
        container.innerHTML = invites.map(inv => `
            <div class="club-card">
                <div class="club-name">${escapeHtml(inv.clubName)}</div>
                <div style="color:#888; font-size:10px;">Invited by ${escapeHtml(inv.invitedBy)}</div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="ie-btn" style="flex:1; padding:5px; font-size:10px;" onclick="acceptClubInvite('${inv.id}', '${inv.clubId}')">Accept</button>
                    <button class="ie-btn" style="flex:1; padding:5px; font-size:10px; background:#333;" onclick="declineClubInvite('${inv.id}')">Decline</button>
                </div>
            </div>
        `).join('');
    });
}

function acceptClubInvite(inviteId, clubId) {
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) { alert('Club no longer exists.'); return; }
        const club = s.val();
        const members = club.members || [];
        if (userClubs.length >= 5) { alert('You can only join up to 5 clubs!'); return; }
        if (!members.includes(CURRENT_USER)) {
            members.push(CURRENT_USER);
            db.ref('clubs/' + clubId + '/members').set(members);
        }
        db.ref('club_invites/' + CURRENT_USER + '/' + inviteId).remove();
        loadClubInvites();
        alert('You joined the club!');
    });
}

function declineClubInvite(inviteId) {
    db.ref('club_invites/' + CURRENT_USER + '/' + inviteId).remove();
    loadClubInvites();
}

function requestJoinClub(clubId) {
    if (userClubs.length >= 5) { alert('You can only join up to 5 clubs!'); return; }
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) return;
        const club = s.val();
        db.ref('club_requests/' + clubId + '/' + CURRENT_USER).set({
            username: CURRENT_USER,
            timestamp: Date.now()
        });
        alert('Request sent to club owner!');
    });
}

function leaveClub(clubId) {
    if (!confirm('Leave this club?')) return;
    db.ref('clubs/' + clubId).once('value', (s) => {
        if (!s.exists()) return;
        const club = s.val();
        const members = (club.members || []).filter(m => m !== CURRENT_USER);
        db.ref('clubs/' + clubId + '/members').set(members);
        loadMyClubs();
    });
}

function loadManageClub() {
    const container = document.getElementById('manage_club_content');
    if (!container || !ownedClub) return;
    
    db.ref('club_requests/' + ownedClub.id).once('value', (reqSnap) => {
        const requests = [];
        reqSnap.forEach(r => requests.push({ id: r.key, ...r.val() }));
        
        let html = `<div class="admin-section">
            <h4 style="color:#d40000;">Club: ${escapeHtml(ownedClub.name)}</h4>
            <p style="color:#888; font-size:10px;">Members: ${(ownedClub.members || []).length + 1}</p>
        </div>`;
        
        html += `<div class="admin-section">
            <h4>Invite Member</h4>
            <input type="text" id="invite_member_name" class="ie-input" placeholder="Username to invite">
            <button class="ie-btn" onclick="inviteToClub()">Send Invite</button>
            <div id="invite_result" style="margin-top:5px; font-size:10px;"></div>
        </div>`;
        
        if (requests.length > 0) {
            html += `<div class="admin-section">
                <h4>Join Requests (${requests.length})</h4>
                ${requests.map(r => `
                    <div class="friend-item">
                        <span style="color:#d40000;">${escapeHtml(r.username)}</span>
                        <div class="friend-actions">
                            <button class="ie-btn" style="width:auto; padding:3px 8px; font-size:9px;" onclick="approveJoinRequest('${r.id}')">âœ“</button>
                            <button class="ie-btn" style="width:auto; padding:3px 8px; font-size:9px; background:#333;" onclick="denyJoinRequest('${r.id}')">âœ—</button>
                        </div>
                    </div>
                `).join('')}
            </div>`;
        }
        
        html += `<div class="admin-section">
            <h4>Members</h4>
            <div style="color:#ffd700; font-size:11px; margin-bottom:5px;">ğŸ‘‘ ${escapeHtml(ownedClub.owner)} (Owner)</div>
            ${(ownedClub.members || []).map(m => `
                <div class="friend-item">
                    <span style="color:#888;">${escapeHtml(m)}</span>
                    <button class="ie-btn" style="width:auto; padding:3px 8px; font-size:9px; background:#500;" onclick="kickFromClub('${m}')">Kick</button>
                </div>
            `).join('') || '<div style="color:#666; font-size:10px;">No members yet.</div>'}
        </div>`;
        
        html += `<button class="ie-btn" style="background:#500; margin-top:10px;" onclick="deleteClub()">ğŸ—‘ï¸ Delete Club</button>`;
        
        container.innerHTML = html;
    });
}

function inviteToClub() {
    const username = document.getElementById('invite_member_name').value.trim();
    const resultEl = document.getElementById('invite_result');
    if (!username) { resultEl.innerHTML = '<span style="color:#f00;">Enter a username.</span>'; return; }
    if (!userDatabase[username]) { resultEl.innerHTML = '<span style="color:#f00;">User not found.</span>'; return; }
    if (username === CURRENT_USER) { resultEl.innerHTML = '<span style="color:#f00;">You can\'t invite yourself.</span>'; return; }
    
    db.ref('club_invites/' + username).push({
        clubId: ownedClub.id,
        clubName: ownedClub.name,
        invitedBy: CURRENT_USER,
        timestamp: Date.now()
    });
    resultEl.innerHTML = '<span style="color:#0f0;">âœ“ Invite sent!</span>';
    document.getElementById('invite_member_name').value = '';
}

function approveJoinRequest(username) {
    if (!ownedClub) return;
    db.ref('clubs/' + ownedClub.id).once('value', (s) => {
        const club = s.val();
        const members = club.members || [];
        if (!members.includes(username)) {
            members.push(username);
            db.ref('clubs/' + ownedClub.id + '/members').set(members);
        }
        db.ref('club_requests/' + ownedClub.id + '/' + username).remove();
        ownedClub.members = members;
        loadManageClub();
    });
}

function denyJoinRequest(username) {
    if (!ownedClub) return;
    db.ref('club_requests/' + ownedClub.id + '/' + username).remove();
    loadManageClub();
}

function kickFromClub(username) {
    if (!ownedClub || !confirm('Kick ' + username + ' from the club?')) return;
    const members = (ownedClub.members || []).filter(m => m !== username);
    db.ref('clubs/' + ownedClub.id + '/members').set(members);
    ownedClub.members = members;
    loadManageClub();
}

function deleteClub() {
    if (!ownedClub || !confirm('DELETE your club? This cannot be undone!')) return;
    db.ref('clubs/' + ownedClub.id).remove();
    db.ref('club_requests/' + ownedClub.id).remove();
    ownedClub = null;
    document.getElementById('club_manage_tab').style.display = 'none';
    switchClubTab('browse', document.querySelector('#clubs_window .mgmt-sidebar-item'));
    alert('Club deleted.');
}

function getUserClubs(username) {
    return new Promise((resolve) => {
        db.ref('clubs').once('value', (s) => {
            const clubs = [];
            s.forEach(c => {
                const club = { id: c.key, ...c.val() };
                if (club.owner === username || (club.members && club.members.includes(username))) {
                    clubs.push(club);
                }
            });
            resolve(clubs);
        });
    });
}

// ==================== FRIENDS & MESSAGING SYSTEM ====================
let currentDMUser = null;
let currentGroupId = null;
let dmListener = null;
let groupListener = null;

function switchMsgTab(tab, el) {
    document.querySelectorAll('#messages_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    ['dms', 'groups', 'friends', 'requests'].forEach(t => {
        const panel = document.getElementById('msg_tab_' + t);
        if (panel) {
            if (t === tab) {
                panel.style.display = 'flex';
            } else {
                panel.style.display = 'none';
            }
        }
    });
    if (tab === 'dms') loadDMList();
    if (tab === 'groups') loadGroupList();
    if (tab === 'friends') loadFriendsList();
    if (tab === 'requests') loadFriendRequests();
}

function loadFriendsList() {
    const container = document.getElementById('friends_list');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading friends...</div>';
    
    db.ref('friends/' + CURRENT_USER).once('value', (s) => {
        const friends = s.val() || {};
        const friendList = Object.keys(friends);
        if (friendList.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:40px;">No friends yet.<br><span style="font-size:11px;">Add someone using the form below!</span></div>';
            return;
        }
        container.innerHTML = friendList.map(f => `
            <div style="display:flex; align-items:center; gap:12px; padding:12px 15px; background:#0a0000; border-bottom:1px solid #300;">
                <div style="width:36px; height:36px; border-radius:50%; background:#111; border:2px solid #500; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0;">ğŸ¦‡</div>
                <span style="color:#d40000; font-weight:bold; font-size:13px; flex:1;">${escapeHtml(f)}</span>
                <div style="display:flex; gap:8px;">
                    <button class="ie-btn" style="width:auto; padding:6px 12px; font-size:10px; margin:0;" onclick="startDM('${f}')">ğŸ’¬ DM</button>
                    <button class="ie-btn" style="width:auto; padding:6px 12px; font-size:10px; margin:0; background:#500;" onclick="removeFriend('${f}')">âœ—</button>
                </div>
            </div>
        `).join('');
    });
}

function sendFriendRequest() {
    const username = document.getElementById('add_friend_input').value.trim();
    if (!username) { alert('Enter a username.'); return; }
    if (!userDatabase[username]) { alert('User not found.'); return; }
    if (username === CURRENT_USER) { alert('You can\'t add yourself.'); return; }
    
    db.ref('friends/' + CURRENT_USER + '/' + username).once('value', (s) => {
        if (s.exists()) { alert('Already friends!'); return; }
        db.ref('friend_requests/' + username + '/' + CURRENT_USER).set({
            from: CURRENT_USER,
            timestamp: Date.now()
        });
        alert('Friend request sent!');
        document.getElementById('add_friend_input').value = '';
    });
}

function loadFriendRequests() {
    const container = document.getElementById('friend_requests_list');
    if (!container) return;
    db.ref('friend_requests/' + CURRENT_USER).once('value', (s) => {
        const requests = [];
        s.forEach(r => requests.push({ id: r.key, ...r.val() }));
        
        const countEl = document.getElementById('friend_req_count');
        if (countEl) countEl.textContent = requests.length > 0 ? `(${requests.length})` : '';
        
        if (requests.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:25px; background:#050000; border:1px dashed #300; border-radius:6px;">No pending friend requests.</div>';
            return;
        }
        container.innerHTML = requests.map(r => `
            <div style="display:flex; align-items:center; gap:12px; padding:12px 15px; background:#0a0000; border:1px solid #400; margin-bottom:8px; border-radius:6px;">
                <div style="width:40px; height:40px; border-radius:50%; background:#111; border:2px solid #ffd700; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;">ğŸ¦‡</div>
                <div style="flex:1;">
                    <span style="color:#d40000; font-weight:bold; font-size:13px;">${escapeHtml(r.from)}</span>
                    <div style="color:#666; font-size:10px;">wants to be friends</div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="ie-btn" style="width:auto; padding:6px 15px; font-size:10px; margin:0; background:#040;" onclick="acceptFriend('${r.from}')">âœ“ Accept</button>
                    <button class="ie-btn" style="width:auto; padding:6px 15px; font-size:10px; margin:0; background:#400;" onclick="declineFriend('${r.from}')">âœ— Decline</button>
                </div>
            </div>
        `).join('');
    });
}

function acceptFriend(username) {
    db.ref('friends/' + CURRENT_USER + '/' + username).set(true);
    db.ref('friends/' + username + '/' + CURRENT_USER).set(true);
    db.ref('friend_requests/' + CURRENT_USER + '/' + username).remove();
    loadFriendRequests();
    loadFriendsList();
}

function declineFriend(username) {
    db.ref('friend_requests/' + CURRENT_USER + '/' + username).remove();
    loadFriendRequests();
}

function removeFriend(username) {
    if (!confirm('Remove ' + username + ' from friends?')) return;
    db.ref('friends/' + CURRENT_USER + '/' + username).remove();
    db.ref('friends/' + username + '/' + CURRENT_USER).remove();
    loadFriendsList();
}

function loadDMList() {
    const container = document.getElementById('dm_conversations');
    if (!container) return;
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading conversations...</div>';
    
    db.ref('dms').orderByChild('participants/' + CURRENT_USER).equalTo(true).once('value', (s) => {
        const convos = [];
        s.forEach(c => convos.push({ id: c.key, ...c.val() }));
        
        console.log('Loaded DM conversations:', convos.length);
        
        if (convos.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No conversations yet.<br><span style="font-size:11px;">Message a friend to start chatting!</span></div>';
            return;
        }
        
        // Build HTML and then fetch avatars
        let html = '';
        const usernames = [];
        convos.forEach(c => {
            const otherUser = Object.keys(c.participants || {}).find(p => p !== CURRENT_USER) || 'Unknown';
            usernames.push(otherUser);
            html += `<div class="dm-item" onclick="openDM('${c.id}', '${otherUser}')" style="cursor:pointer;">
                <div class="dm-avatar" id="dm_avatar_${otherUser}">ğŸ¦‡</div>
                <div class="dm-preview">
                    <div class="dm-name">${escapeHtml(otherUser)}</div>
                    <div class="dm-last">${escapeHtml(c.lastMessage || 'No messages yet')}</div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
        
        // Fetch avatars for each user
        usernames.forEach(username => {
            db.ref('profiles/' + username + '/avatar').once('value', (avatarSnap) => {
                const avatarEl = document.getElementById('dm_avatar_' + username);
                if (avatarEl && avatarSnap.val()) {
                    avatarEl.innerHTML = `<img src="${escapeHtml(avatarSnap.val())}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" onerror="this.parentElement.innerHTML='ğŸ¦‡'">`;
                }
            });
        });
    }).catch(err => {
        console.error('Error loading DMs:', err);
        container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No conversations yet.</div>';
    });
}

function startDM(username) {
    db.ref('friends/' + CURRENT_USER + '/' + username).once('value', (s) => {
        if (!s.exists()) { alert('You must be friends to DM!'); return; }
        const convoId = [CURRENT_USER, username].sort().join('_');
        db.ref('dms/' + convoId).once('value', (cs) => {
            if (!cs.exists()) {
                const participants = {};
                participants[CURRENT_USER] = true;
                participants[username] = true;
                db.ref('dms/' + convoId).set({ participants: participants, created: Date.now() });
            }
            // Open messages window if not already open
            const msgWin = document.getElementById('messages_window');
            if (msgWin.style.display !== 'block') {
                msgWin.style.display = 'block';
                document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10");
                msgWin.style.zIndex = "200";
            }
            // Switch to DMs tab
            document.querySelectorAll('#messages_window .mgmt-sidebar-item').forEach(i => i.classList.remove('active'));
            document.querySelector('#messages_window .mgmt-sidebar-item').classList.add('active');
            ['dms', 'groups', 'friends', 'requests'].forEach(t => {
                const panel = document.getElementById('msg_tab_' + t);
                if (panel) panel.style.display = t === 'dms' ? 'flex' : 'none';
            });
            openDM(convoId, username);
        });
    });
}

function openDM(convoId, username) {
    currentDMUser = username;
    document.getElementById('dm_list_view').style.display = 'none';
    document.getElementById('dm_chat_view').style.display = 'flex';
    document.getElementById('dm_chat_name').textContent = username;
    
    // Load profile picture for chat header
    const avatarEl = document.getElementById('dm_chat_avatar');
    if (avatarEl) {
        avatarEl.innerHTML = 'ğŸ¦‡';
        db.ref('profiles/' + username + '/avatar').once('value', (s) => {
            if (s.val()) {
                avatarEl.innerHTML = `<img src="${escapeHtml(s.val())}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" onerror="this.innerHTML='ğŸ¦‡'">`;
            }
        });
    }
    
    if (dmListener) db.ref('dms/' + dmListener).off();
    dmListener = convoId;
    
    db.ref('dms/' + convoId + '/messages').orderByChild('timestamp').on('value', (s) => {
        const msgs = [];
        s.forEach(m => msgs.push(m.val()));
        const container = document.getElementById('dm_messages');
        container.innerHTML = msgs.map(m => `
            <div class="msg-bubble ${m.sender === CURRENT_USER ? 'sent' : 'received'}">
                ${m.sender !== CURRENT_USER ? `<div style="font-size:9px; color:#888; margin-bottom:3px;">${escapeHtml(m.sender)}</div>` : ''}
                ${renderMessageContent(m.text, m.media)}
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
    });
}

function closeDMChat() {
    if (dmListener) { db.ref('dms/' + dmListener + '/messages').off(); dmListener = null; }
    currentDMUser = null;
    document.getElementById('dm_chat_view').style.display = 'none';
    document.getElementById('dm_list_view').style.display = 'block';
    document.getElementById('dm_media_preview').style.display = 'none';
    loadDMList();
}

// Helper to render message content with media support
function renderMessageContent(text, mediaUrl) {
    let content = '';
    
    // Check if text itself is a media URL
    const combinedUrl = mediaUrl || text;
    if (combinedUrl && isMediaUrl(combinedUrl)) {
        content += renderMedia(combinedUrl);
        if (mediaUrl && text && text !== mediaUrl) {
            content += `<div style="margin-top:5px;">${escapeHtml(text)}</div>`;
        }
    } else if (text) {
        // Check for URLs in text and render them
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const parts = text.split(urlRegex);
        parts.forEach(part => {
            if (urlRegex.test(part)) {
                urlRegex.lastIndex = 0; // Reset regex
                if (isMediaUrl(part)) {
                    content += renderMedia(part);
                } else {
                    content += `<a href="${escapeHtml(part)}" target="_blank" style="color:#ff6666;">${escapeHtml(part)}</a>`;
                }
            } else {
                content += escapeHtml(part);
            }
        });
    }
    
    return content || escapeHtml(text || '');
}

function isMediaUrl(url) {
    if (!url) return false;
    const lower = url.toLowerCase();
    return lower.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|mov)(\?|$)/i) ||
           lower.includes('tenor.com') ||
           lower.includes('giphy.com') ||
           lower.includes('imgur.com');
}

function renderMedia(url) {
    const lower = url.toLowerCase();
    if (lower.match(/\.(mp4|webm|mov)(\?|$)/i)) {
        return `<video src="${escapeHtml(url)}" controls style="max-width:200px; max-height:200px; border-radius:4px; margin:5px 0;" onerror="this.outerHTML='<span style=color:#888>[Video failed to load]</span>'"></video>`;
    } else {
        return `<img src="${escapeHtml(url)}" style="max-width:200px; max-height:200px; border-radius:4px; margin:5px 0; cursor:pointer;" onclick="window.open('${escapeHtml(url)}', '_blank')" onerror="this.outerHTML='<span style=color:#888>[Image failed to load]</span>'">`;
    }
}

function showDMMediaInput() {
    const preview = document.getElementById('dm_media_preview');
    preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
}

function showGroupMediaInput() {
    const preview = document.getElementById('group_media_preview');
    preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
}

function sendDM() {
    const input = document.getElementById('dm_input');
    const mediaInput = document.getElementById('dm_media_url');
    const text = input.value.trim();
    const mediaUrl = mediaInput ? mediaInput.value.trim() : '';
    
    if ((!text && !mediaUrl) || !dmListener) return;
    
    const message = {
        sender: CURRENT_USER,
        text: text || (mediaUrl ? '' : ''),
        timestamp: Date.now()
    };
    
    if (mediaUrl) {
        message.media = mediaUrl;
    }
    
    db.ref('dms/' + dmListener + '/messages').push(message);
    db.ref('dms/' + dmListener + '/lastMessage').set(mediaUrl ? (text || 'ğŸ“· Media') : text);
    input.value = '';
    if (mediaInput) mediaInput.value = '';
    document.getElementById('dm_media_preview').style.display = 'none';
}

function loadGroupList() {
    const container = document.getElementById('group_conversations');
    if (!container) return;
    document.getElementById('group_list_view').style.display = 'block';
    document.getElementById('group_chat_view').style.display = 'none';
    document.getElementById('create_group_view').style.display = 'none';
    
    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Loading groups...</div>';
    
    db.ref('groupchats').orderByChild('members/' + CURRENT_USER).equalTo(true).once('value', (s) => {
        const groups = [];
        s.forEach(g => groups.push({ id: g.key, ...g.val() }));
        
        console.log('Loaded group chats:', groups.length);
        
        if (groups.length === 0) {
            container.innerHTML = '<div style="color:#666; text-align:center; padding:30px;">No group chats yet.<br><span style="font-size:11px;">Create one using the button above!</span></div>';
            return;
        }
        container.innerHTML = groups.map(g => `
            <div class="dm-item" onclick="openGroupChat('${g.id}')" style="cursor:pointer;">
                <div class="dm-avatar">ğŸ‘¥</div>
                <div class="dm-preview">
                    <div class="dm-name">${escapeHtml(g.name)}</div>
                    <div class="dm-last">${Object.keys(g.members || {}).length} members</div>
                </div>
            </div>
        `).join('');
    }).catch(err => {
        console.error('Error loading groups:', err);
        container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No group chats yet.</div>';
    });
}

function showCreateGroup() {
    document.getElementById('group_list_view').style.display = 'none';
    document.getElementById('create_group_view').style.display = 'block';
    
    db.ref('friends/' + CURRENT_USER).once('value', (s) => {
        const friends = Object.keys(s.val() || {});
        const container = document.getElementById('group_friend_select');
        if (friends.length === 0) {
            container.innerHTML = '<div style="color:#666;">You need friends to create a group chat!</div>';
            return;
        }
        container.innerHTML = friends.map(f => `
            <div class="group-friend-row" onclick="toggleGroupFriend(this, '${f}')" style="display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer; background:#0a0000; border:1px solid #300; margin-bottom:5px; border-radius:3px; transition:all 0.2s;">
                <input type="checkbox" value="${f}" class="group-friend-check" style="width:18px; height:18px; cursor:pointer; pointer-events:none;">
                <span style="color:#d40000; flex:1; font-size:13px;">${escapeHtml(f)}</span>
                <span class="check-indicator" style="color:#0f0; display:none;">âœ“</span>
            </div>
        `).join('');
    });
}

function toggleGroupFriend(row, username) {
    const checkbox = row.querySelector('input[type="checkbox"]');
    const indicator = row.querySelector('.check-indicator');
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        row.style.background = '#1a0a1a';
        row.style.borderColor = '#6a03b4';
        if (indicator) indicator.style.display = 'block';
    } else {
        row.style.background = '#0a0000';
        row.style.borderColor = '#300';
        if (indicator) indicator.style.display = 'none';
    }
}

function cancelCreateGroup() {
    document.getElementById('create_group_view').style.display = 'none';
    document.getElementById('group_list_view').style.display = 'block';
}

function createGroupChat() {
    const name = document.getElementById('new_group_name').value.trim();
    if (!name) { alert('Enter a group name.'); return; }
    
    const selected = Array.from(document.querySelectorAll('.group-friend-check:checked')).map(c => c.value);
    if (selected.length === 0) { alert('Select at least one friend.'); return; }
    
    const members = {};
    members[CURRENT_USER] = true;
    selected.forEach(u => { members[u] = true; });
    
    const groupId = 'group_' + Date.now();
    db.ref('groupchats/' + groupId).set({
        name: name,
        members: members,
        owner: CURRENT_USER,
        created: Date.now()
    });
    
    document.getElementById('new_group_name').value = '';
    cancelCreateGroup();
    loadGroupList();
}

function openGroupChat(groupId) {
    currentGroupId = groupId;
    document.getElementById('group_list_view').style.display = 'none';
    document.getElementById('group_chat_view').style.display = 'flex';
    
    db.ref('groupchats/' + groupId + '/name').once('value', (s) => {
        document.getElementById('group_chat_name').textContent = s.val() || 'Group';
    });
    
    if (groupListener) db.ref('groupchats/' + groupListener + '/messages').off();
    groupListener = groupId;
    
    db.ref('groupchats/' + groupId + '/messages').orderByChild('timestamp').on('value', (s) => {
        const msgs = [];
        s.forEach(m => msgs.push(m.val()));
        const container = document.getElementById('group_messages');
        container.innerHTML = msgs.map(m => `
            <div class="msg-bubble ${m.sender === CURRENT_USER ? 'sent' : 'received'}">
                ${m.sender !== CURRENT_USER ? `<div style="font-size:9px; color:#888; margin-bottom:3px;">${escapeHtml(m.sender)}</div>` : ''}
                ${renderMessageContent(m.text, m.media)}
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
    });
}

function closeGroupChat() {
    if (groupListener) { db.ref('groupchats/' + groupListener + '/messages').off(); groupListener = null; }
    currentGroupId = null;
    document.getElementById('group_chat_view').style.display = 'none';
    document.getElementById('group_media_preview').style.display = 'none';
    loadGroupList();
}

function sendGroupMsg() {
    const input = document.getElementById('group_input');
    const mediaInput = document.getElementById('group_media_url');
    const text = input.value.trim();
    const mediaUrl = mediaInput ? mediaInput.value.trim() : '';
    
    if ((!text && !mediaUrl) || !currentGroupId) return;
    
    const message = {
        sender: CURRENT_USER,
        text: text || (mediaUrl ? '' : ''),
        timestamp: Date.now()
    };
    
    if (mediaUrl) {
        message.media = mediaUrl;
    }
    
    db.ref('groupchats/' + currentGroupId + '/messages').push(message);
    input.value = '';
    if (mediaInput) mediaInput.value = '';
    document.getElementById('group_media_preview').style.display = 'none';
}

function showGroupMembers() {
    if (!currentGroupId) return;
    db.ref('groupchats/' + currentGroupId).once('value', (s) => {
        const group = s.val();
        const members = Object.keys(group.members || {});
        alert('Group Members:\n' + members.join('\n'));
    });
}

function startDMFromProfile() {
    if (!currentProfileUser || !CURRENT_USER || IS_GUEST) { alert('Please log in!'); return; }
    if (currentProfileUser === CURRENT_USER) { alert('You can\'t message yourself!'); return; }
    startDM(currentProfileUser);
    toggleWin('messages_window');
}

// MEMORIES
function prevPage() { if (currentPage > 1) { currentPage--; renderMemories(); } }
function nextPage() { db.ref('archive').once('value', (s) => { let count = 0; s.forEach(() => count++); const totalPages = Math.ceil(count / itemsPerPage) || 1; if (currentPage < totalPages) { currentPage++; renderMemories(); } }); }
function renderMemories() {
    const grid = document.getElementById('memories_grid'); if (!grid) return;
    grid.innerHTML = ""; grid.style.display = 'grid'; grid.style.gridTemplateColumns = 'repeat(3, 1fr)'; grid.style.gap = '20px'; grid.style.justifyItems = 'center';
    db.ref('archive').orderByChild('timestamp').once('value', (s) => {
        const archive = []; s.forEach((c) => archive.push(c.val()));
        const totalPages = Math.ceil(archive.length / itemsPerPage) || 1;
        document.getElementById('page_indicator').textContent = 'Page ' + currentPage + ' of ' + totalPages;
        if (archive.length === 0) { grid.innerHTML = '<p style="color: #555; text-align: center; grid-column: 1/-1; padding: 40px;">No memories yet...</p>'; return; }
        const start = (currentPage - 1) * itemsPerPage;
        archive.slice(start, start + itemsPerPage).forEach(mem => {
            const div = document.createElement('div');
            div.style.cssText = 'width:120px; text-align:center; cursor:pointer; padding:10px; border-radius:5px; transition:all 0.2s;';
            div.onmouseover = function() { this.style.background = 'rgba(139,0,0,0.2)'; };
            div.onmouseout = function() { this.style.background = 'transparent'; };
            div.onclick = function() { spawnVideoWindow(mem.name, mem.url); };
            div.innerHTML = `<div style="width:60px; height:60px; margin:0 auto 8px; background:#200000; border:2px solid #500; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:28px;">ğŸ¬</div><div style="font-size:11px; color:#d40000; font-weight:bold; word-break:break-word;">${escapeHtml(mem.name)}</div><div style="font-size:9px; color:#666; margin-top:2px;">${escapeHtml(mem.uploader || 'Unknown')}</div>`;
            grid.appendChild(div);
        });
    });
}
function spawnVideoWindow(name, url) {
    const id = 'v_' + Date.now();
    const win = document.createElement('div');
    win.className = 'window'; win.id = id; win.style.display = 'block';
    win.style.left = (150 + Math.random() * 100) + 'px'; win.style.top = (100 + Math.random() * 50) + 'px'; win.style.width = '520px'; win.style.height = '420px'; win.style.zIndex = '500';
    const isAudio = url.match(/\.(mp3|wav|ogg|m4a)(\?|$)/i);
    let mediaHtml = isAudio ? `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; background:#050000;"><div style="font-size:60px; margin-bottom:20px;">ğŸµ</div><audio src="${url}" controls autoplay style="width:90%;"></audio></div>` : `<video src="${url}" controls autoplay style="width:100%; height:100%; background:#000;"></video>`;
    win.innerHTML = `<div class="title-bar"><div class="title-bar-text">â–¶ ${escapeHtml(name)}</div><div class="title-bar-controls"><button aria-label="Close" onclick="document.getElementById('${id}').remove()"></button></div></div><div class="window-body" style="height:calc(100% - 32px); overflow:hidden;">${mediaHtml}</div>`;
    document.body.appendChild(win); makeDraggable(id);
}
async function processIEUpload() {
    const fileInput = document.getElementById('ie_file_picker');
    const name = document.getElementById('ie_filename').value.trim() || "Video_" + Date.now();
    if(!fileInput.files[0]) { alert('Select a file.'); return; }
    if(!CURRENT_USER) { alert('Log in first.'); return; }
    
    // Check if user is VIP+ (VIP, CONTRIB, Admin, ST, or has VIP perks)
    const user = userDatabase[CURRENT_USER];
    const canUpload = user && (user.rank === 'VIP' || user.rank === 'CONTRIB' || user.isAdmin || user.isST || user.hasVipPerks);
    if (!canUpload) { alert('VIP+ members only can upload to Memories.'); return; }
    
    document.getElementById('upload_status').innerText = "Uploading..."; document.getElementById('upload_status').disabled = true;
    const formData = new FormData(); formData.append('file', fileInput.files[0]); formData.append('upload_preset', UPLOAD_PRESET);
    try {
        const res = await fetch('https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/auto/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (res.ok && data.secure_url) { await db.ref('archive').push({ name: name, url: data.secure_url, uploader: CURRENT_USER, timestamp: firebase.database.ServerValue.TIMESTAMP }); renderMemories(); document.getElementById('upload_status').innerText = "Push to Cloud"; document.getElementById('ie_filename').value = ""; fileInput.value = ""; alert('Uploaded!'); }
        else { alert('Failed: ' + (data.error?.message || 'Unknown')); document.getElementById('upload_status').innerText = "Push to Cloud"; }
    } catch (e) { alert("Error."); document.getElementById('upload_status').innerText = "Push to Cloud"; }
    document.getElementById('upload_status').disabled = false;
}

// WINDOW MANAGEMENT
function toggleWin(id) {
    let el = document.getElementById(id); if (!el) return;
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
    if(el.style.display === 'block') { document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); el.style.zIndex = "200"; }
    if (id === 'admin_window') { loadAllApplications(); }
    if (id === 'clubs_window') { loadAllClubs(); loadMyClubs(); }
    if (id === 'messages_window') { loadDMList(); loadFriendRequests(); loadFriendsList(); loadGroupList(); }
}
function makeDraggable(winId) {
    const win = document.getElementById(winId); if (!win) return;
    const header = win.querySelector('.title-bar'); if (!header) return;
    header.onmousedown = (e) => {
        e.preventDefault();
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); win.style.zIndex = "400";
        let startX = e.clientX, startY = e.clientY, startLeft = win.offsetLeft, startTop = win.offsetTop;
        document.onmousemove = (e) => { win.style.left = (startLeft + e.clientX - startX) + 'px'; win.style.top = (startTop + e.clientY - startY) + 'px'; };
        document.onmouseup = () => { document.onmousemove = null; document.onmouseup = null; };
    };
    header.ontouchstart = (e) => {
        const touch = e.touches[0];
        document.querySelectorAll('.window').forEach(w => w.style.zIndex = "10"); win.style.zIndex = "400";
        let startX = touch.clientX, startY = touch.clientY, startLeft = win.offsetLeft, startTop = win.offsetTop;
        document.ontouchmove = (e) => { const t = e.touches[0]; win.style.left = (startLeft + t.clientX - startX) + 'px'; win.style.top = (startTop + t.clientY - startY) + 'px'; };
        document.ontouchend = () => { document.ontouchmove = null; document.ontouchend = null; };
    };
}
['ie_window', 'memories_folder', 'chat_win', 'about_window', 'games_window', 'apply_window', 'admin_window', 'profile_window', 'clubs_window', 'messages_window'].forEach(id => makeDraggable(id));

window.beginSession = function() {
    document.getElementById('boot-screen').style.display = 'none';
    if(player) { player.unMute(); player.playVideo(); }
};

var player;
window.onYouTubeIframeAPIReady = function() {
    player = new YT.Player('player', {
        videoId: 'Bi5kyehmeaY',
        playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'Bi5kyehmeaY', 'controls': 0 },
        events: { 'onReady': (e) => e.target.mute() }
    });
};
function pauseMusic() { if(player) player.pauseVideo(); }
function playMusic() { if(player) player.playVideo(); }

window.addEventListener('load', () => {
    renderMemories();
    updateVisitorCount();
    updateClock();
    initStakesGame();
    startOnlineListener();
});
</script>
</body>
</html>
